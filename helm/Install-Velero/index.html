<!doctype html><html lang=en class=no-js> <head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="Compile cloud native operation and maintenance related operation  and maintenance experience documents"><meta name=author content="Freeman Kevin"><link href=https://github.com/freemankevin/cloudops-handbook/helm/Install-Velero/ rel=canonical><link href=../Install-Openelb/ rel=prev><link href=../Install-Consul/ rel=next><link rel=icon href=../../assets/favicon.png><meta name=generator content="mkdocs-1.5.3, mkdocs-material-9.5.11"><title>Install Velero - CloudOps Handbook</title><link rel=stylesheet href=../../assets/stylesheets/main.7e359304.min.css><link rel=stylesheet href=../../assets/stylesheets/palette.06af60db.min.css><link rel=preconnect href=https://fonts.gstatic.com crossorigin><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback"><style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style><script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script><link rel=stylesheet href=../../assets/stylesheets/custom.00c04c01.min.css></head> <body dir=ltr data-md-color-scheme=default data-md-color-primary=indigo data-md-color-accent=indigo> <input class=md-toggle data-md-toggle=drawer type=checkbox id=__drawer autocomplete=off> <input class=md-toggle data-md-toggle=search type=checkbox id=__search autocomplete=off> <label class=md-overlay for=__drawer></label> <div data-md-component=skip> <a href=#1 class=md-skip> Skip to content </a> </div> <div data-md-component=announce> <aside class=md-banner> <div class="md-banner__inner md-grid md-typeset"> <button class="md-banner__button md-icon" aria-label="Don't show this again"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg> </button> For updates follow <strong>@freemankevin</strong> on <a rel=me href=https://mastodon.social/@freemankevin> <span class="twemoji mastodon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 448 512"><!-- Font Awesome Free 6.5.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M433 179.11c0-97.2-63.71-125.7-63.71-125.7-62.52-28.7-228.56-28.4-290.48 0 0 0-63.72 28.5-63.72 125.7 0 115.7-6.6 259.4 105.63 289.1 40.51 10.7 75.32 13 103.33 11.4 50.81-2.8 79.32-18.1 79.32-18.1l-1.7-36.9s-36.31 11.4-77.12 10.1c-40.41-1.4-83-4.4-89.63-54a102.54 102.54 0 0 1-.9-13.9c85.63 20.9 158.65 9.1 178.75 6.7 56.12-6.7 105-41.3 111.23-72.9 9.8-49.8 9-121.5 9-121.5zm-75.12 125.2h-46.63v-114.2c0-49.7-64-51.6-64 6.9v62.5h-46.33V197c0-58.5-64-56.6-64-6.9v114.2H90.19c0-122.1-5.2-147.9 18.41-175 25.9-28.9 79.82-30.8 103.83 6.1l11.6 19.5 11.6-19.5c24.11-37.1 78.12-34.8 103.83-6.1 23.71 27.3 18.4 53 18.4 175z"/></svg> </span> <strong>Mastodon</strong> </a> and <a href=https://github.com/freemankevin> <span class="twemoji github"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 496 512"><!-- Font Awesome Free 6.5.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z"/></svg> </span> <strong>github</strong> </a> </div> <script>var content,el=document.querySelector("[data-md-component=announce]");el&&(content=el.querySelector(".md-typeset"),__md_hash(content.innerHTML)===__md_get("__announce")&&(el.hidden=!0))</script> </aside> </div> <header class=md-header data-md-component=header> <nav class="md-header__inner md-grid" aria-label=Header> <a href=../.. title="CloudOps Handbook" class="md-header__button md-logo" aria-label="CloudOps Handbook" data-md-component=logo> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 89 89"> <path d=M3.136,17.387l0,42.932l42.932,21.467l-42.932,-64.399Z /> <path d=M21.91,8l42.933,64.398l-18.775,9.388l-42.932,-64.399l18.774,-9.387Z style="fill-opacity: 0.5"/> <path d=M67.535,17.387l-27.262,18.156l21.878,32.818l5.384,2.691l0,-53.665Z /> <path d=M67.535,17.387l0,53.666l18.774,-9.388l0,-53.665l-18.774,9.387Z style="fill-opacity: 0.25"/> </svg> </a> <label class="md-header__button md-icon" for=__drawer> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg> </label> <div class=md-header__title data-md-component=header-title> <div class=md-header__ellipsis> <div class=md-header__topic> <span class=md-ellipsis> CloudOps Handbook </span> </div> <div class=md-header__topic data-md-component=header-topic> <span class=md-ellipsis> Install Velero </span> </div> </div> </div> <form class=md-header__option data-md-component=palette> <input class=md-option data-md-color-media=(prefers-color-scheme) data-md-color-scheme=default data-md-color-primary=indigo data-md-color-accent=indigo aria-label="Switch to light mode" type=radio name=__palette id=__palette_0> <label class="md-header__button md-icon" title="Switch to light mode" for=__palette_1 hidden> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7a5 5 0 0 0-5 5 5 5 0 0 0 5 5h4v-1.9H7c-1.71 0-3.1-1.39-3.1-3.1M8 13h8v-2H8v2m9-6h-4v1.9h4c1.71 0 3.1 1.39 3.1 3.1 0 1.71-1.39 3.1-3.1 3.1h-4V17h4a5 5 0 0 0 5-5 5 5 0 0 0-5-5Z"/></svg> </label> <input class=md-option data-md-color-media="(prefers-color-scheme: light)" data-md-color-scheme=default data-md-color-primary=indigo data-md-color-accent=indigo aria-label="Switch to dark mode" type=radio name=__palette id=__palette_1> <label class="md-header__button md-icon" title="Switch to dark mode" for=__palette_2 hidden> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M17 7H7a5 5 0 0 0-5 5 5 5 0 0 0 5 5h10a5 5 0 0 0 5-5 5 5 0 0 0-5-5m0 8a3 3 0 0 1-3-3 3 3 0 0 1 3-3 3 3 0 0 1 3 3 3 3 0 0 1-3 3Z"/></svg> </label> <input class=md-option data-md-color-media="(prefers-color-scheme: dark)" data-md-color-scheme=slate data-md-color-primary=black data-md-color-accent=indigo aria-label="Switch to system preference" type=radio name=__palette id=__palette_2> <label class="md-header__button md-icon" title="Switch to system preference" for=__palette_0 hidden> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M17 7H7a5 5 0 0 0-5 5 5 5 0 0 0 5 5h10a5 5 0 0 0 5-5 5 5 0 0 0-5-5M7 15a3 3 0 0 1-3-3 3 3 0 0 1 3-3 3 3 0 0 1 3 3 3 3 0 0 1-3 3Z"/></svg> </label> </form> <script>var media,input,key,value,palette=__md_get("__palette");if(palette&&palette.color){"(prefers-color-scheme)"===palette.color.media&&(media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']"),palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent"));for([key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script> <label class="md-header__button md-icon" for=__search> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg> </label> <div class=md-search data-md-component=search role=dialog> <label class=md-search__overlay for=__search></label> <div class=md-search__inner role=search> <form class=md-search__form name=search> <input type=text class=md-search__input name=query aria-label=Search placeholder=Search autocapitalize=off autocorrect=off autocomplete=off spellcheck=false data-md-component=search-query required> <label class="md-search__icon md-icon" for=__search> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg> </label> <nav class=md-search__options aria-label=Search> <a href=javascript:void(0) class="md-search__icon md-icon" title=Share aria-label=Share data-clipboard data-clipboard-text data-md-component=search-share tabindex=-1> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M18 16.08c-.76 0-1.44.3-1.96.77L8.91 12.7c.05-.23.09-.46.09-.7 0-.24-.04-.47-.09-.7l7.05-4.11c.54.5 1.25.81 2.04.81a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3c0 .24.04.47.09.7L8.04 9.81C7.5 9.31 6.79 9 6 9a3 3 0 0 0-3 3 3 3 0 0 0 3 3c.79 0 1.5-.31 2.04-.81l7.12 4.15c-.05.21-.08.43-.08.66 0 1.61 1.31 2.91 2.92 2.91 1.61 0 2.92-1.3 2.92-2.91A2.92 2.92 0 0 0 18 16.08Z"/></svg> </a> <button type=reset class="md-search__icon md-icon" title=Clear aria-label=Clear tabindex=-1> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg> </button> </nav> <div class=md-search__suggest data-md-component=search-suggest></div> </form> <div class=md-search__output> <div class=md-search__scrollwrap data-md-scrollfix> <div class=md-search-result data-md-component=search-result> <div class=md-search-result__meta> Initializing search </div> <ol class=md-search-result__list role=presentation></ol> </div> </div> </div> </div> </div> <div class=md-header__source> <a href=https://github.com/freemankevin/CloudOps-Handbook title="Go to repository" class=md-source data-md-component=source> <div class="md-source__icon md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 448 512"><!-- Font Awesome Free 6.5.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg> </div> <div class=md-source__repository> GitHub </div> </a> </div> </nav> </header> <div class=md-container data-md-component=container> <nav class=md-tabs aria-label=Tabs data-md-component=tabs> <div class=md-grid> <ul class=md-tabs__list> <li class=md-tabs__item> <a href=../.. class=md-tabs__link> Home </a> </li> <li class=md-tabs__item> <a href=../../kubernetes/Init-Node/ class=md-tabs__link> Kubernetes </a> </li> <li class="md-tabs__item md-tabs__item--active"> <a href=../Install-TLS-Traefik/ class=md-tabs__link> Helm </a> </li> <li class=md-tabs__item> <a href=../../docker/Docker/ class=md-tabs__link> Docker </a> </li> <li class=md-tabs__item> <a href=../../linux/RPM/ class=md-tabs__link> Linux </a> </li> <li class=md-tabs__item> <a href=../../cicd/Jenkins-Pipeline/ class=md-tabs__link> CICD </a> </li> </ul> </div> </nav> <main class=md-main data-md-component=main> <div class="md-main__inner md-grid"> <div class="md-sidebar md-sidebar--primary" data-md-component=sidebar data-md-type=navigation> <div class=md-sidebar__scrollwrap> <div class=md-sidebar__inner> <nav class="md-nav md-nav--primary md-nav--lifted" aria-label=Navigation data-md-level=0> <label class=md-nav__title for=__drawer> <a href=../.. title="CloudOps Handbook" class="md-nav__button md-logo" aria-label="CloudOps Handbook" data-md-component=logo> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 89 89"> <path d=M3.136,17.387l0,42.932l42.932,21.467l-42.932,-64.399Z /> <path d=M21.91,8l42.933,64.398l-18.775,9.388l-42.932,-64.399l18.774,-9.387Z style="fill-opacity: 0.5"/> <path d=M67.535,17.387l-27.262,18.156l21.878,32.818l5.384,2.691l0,-53.665Z /> <path d=M67.535,17.387l0,53.666l18.774,-9.388l0,-53.665l-18.774,9.387Z style="fill-opacity: 0.25"/> </svg> </a> CloudOps Handbook </label> <div class=md-nav__source> <a href=https://github.com/freemankevin/CloudOps-Handbook title="Go to repository" class=md-source data-md-component=source> <div class="md-source__icon md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 448 512"><!-- Font Awesome Free 6.5.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg> </div> <div class=md-source__repository> GitHub </div> </a> </div> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../.. class=md-nav__link> <span class=md-ellipsis> Home </span> </a> </li> <li class="md-nav__item md-nav__item--pruned md-nav__item--nested"> <a href=../../kubernetes/Init-Node/ class=md-nav__link> <span class=md-ellipsis> Kubernetes </span> <span class="md-nav__icon md-icon"></span> </a> </li> <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_3 checked> <label class=md-nav__link for=__nav_3 id=__nav_3_label tabindex> <span class=md-ellipsis> Helm </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=1 aria-labelledby=__nav_3_label aria-expanded=true> <label class=md-nav__title for=__nav_3> <span class="md-nav__icon md-icon"></span> Helm </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../Install-TLS-Traefik/ class=md-nav__link> <span class=md-ellipsis> Install TLS Traefik </span> </a> </li> <li class=md-nav__item> <a href=../Install-TLS-ArgoCD/ class=md-nav__link> <span class=md-ellipsis> Install TLS ArgoCD </span> </a> </li> <li class=md-nav__item> <a href=../Install-KubeSphere/ class=md-nav__link> <span class=md-ellipsis> Install KubeSphere </span> </a> </li> <li class=md-nav__item> <a href=../Install-Grafana/ class=md-nav__link> <span class=md-ellipsis> Install Grafana </span> </a> </li> <li class=md-nav__item> <a href=../Install-INGRESS-NGINX/ class=md-nav__link> <span class=md-ellipsis> Install INGRESS NGINX </span> </a> </li> <li class=md-nav__item> <a href=../Install-Runner-IN-Kubernetes/ class=md-nav__link> <span class=md-ellipsis> Install Runner IN Kubernetes </span> </a> </li> <li class=md-nav__item> <a href=../Install-Nebula/ class=md-nav__link> <span class=md-ellipsis> Install Nebula </span> </a> </li> <li class=md-nav__item> <a href=../Install-Openelb/ class=md-nav__link> <span class=md-ellipsis> Install Openelb </span> </a> </li> <li class="md-nav__item md-nav__item--active"> <input class="md-nav__toggle md-toggle" type=checkbox id=__toc> <label class="md-nav__link md-nav__link--active" for=__toc> <span class=md-ellipsis> Install Velero </span> <span class="md-nav__icon md-icon"></span> </label> <a href=./ class="md-nav__link md-nav__link--active"> <span class=md-ellipsis> Install Velero </span> </a> <nav class="md-nav md-nav--secondary" aria-label="Table of contents"> <label class=md-nav__title for=__toc> <span class="md-nav__icon md-icon"></span> Table of contents </label> <ul class=md-nav__list data-md-component=toc data-md-scrollfix> <li class=md-nav__item> <a href=#1 class=md-nav__link> <span class=md-ellipsis> 1 安装客户端 </span> </a> </li> <li class=md-nav__item> <a href=#2 class=md-nav__link> <span class=md-ellipsis> 2 安装服务端 </span> </a> <nav class=md-nav aria-label="2 安装服务端"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#21 class=md-nav__link> <span class=md-ellipsis> 2.1 插件兼容性 </span> </a> </li> <li class=md-nav__item> <a href=#22 class=md-nav__link> <span class=md-ellipsis> 2.2 部署服务端 </span> </a> </li> <li class=md-nav__item> <a href=#23 class=md-nav__link> <span class=md-ellipsis> 2.3 创建备份 </span> </a> </li> <li class=md-nav__item> <a href=#24 class=md-nav__link> <span class=md-ellipsis> 2.4 查看备份 </span> </a> </li> <li class=md-nav__item> <a href=#25 class=md-nav__link> <span class=md-ellipsis> 2.5 备份恢复 </span> </a> </li> <li class=md-nav__item> <a href=#26 class=md-nav__link> <span class=md-ellipsis> 2.6 清理备份 </span> </a> </li> <li class=md-nav__item> <a href=#27 class=md-nav__link> <span class=md-ellipsis> 2.7 完全卸载 </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#3 class=md-nav__link> <span class=md-ellipsis> 3 备份原理 </span> </a> <nav class=md-nav aria-label="3 备份原理"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#31 class=md-nav__link> <span class=md-ellipsis> 3.1 对象存储同步 </span> </a> </li> <li class=md-nav__item> <a href=#32 class=md-nav__link> <span class=md-ellipsis> 3.2 设置备份过期 </span> </a> </li> <li class=md-nav__item> <a href=#33-api class=md-nav__link> <span class=md-ellipsis> 3.3 集群API版本 </span> </a> </li> <li class=md-nav__item> <a href=#34 class=md-nav__link> <span class=md-ellipsis> 3.4 恢复工作流程 </span> </a> </li> <li class=md-nav__item> <a href=#35 class=md-nav__link> <span class=md-ellipsis> 3.5 备份工作流程 </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#4 class=md-nav__link> <span class=md-ellipsis> 4 备份方式 </span> </a> <nav class=md-nav aria-label="4 备份方式"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#41 class=md-nav__link> <span class=md-ellipsis> 4.1 按需备份 </span> </a> <nav class=md-nav aria-label="4.1 按需备份"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#411 class=md-nav__link> <span class=md-ellipsis> 4.1.1 指定特定种类资源的备份顺序 </span> </a> </li> <li class=md-nav__item> <a href=#412 class=md-nav__link> <span class=md-ellipsis> 4.1.2 从备份中排除特定项目 </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#42 class=md-nav__link> <span class=md-ellipsis> 4.2 计划备份 </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#5 class=md-nav__link> <span class=md-ellipsis> 5 查看日志 </span> </a> </li> <li class=md-nav__item> <a href=#6 class=md-nav__link> <span class=md-ellipsis> 6 调优 </span> </a> <nav class=md-nav aria-label="6 调优"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#61 class=md-nav__link> <span class=md-ellipsis> 6.1 修改日志级别 </span> </a> </li> <li class=md-nav__item> <a href=#62 class=md-nav__link> <span class=md-ellipsis> 6.2 命令自动补全 </span> </a> </li> <li class=md-nav__item> <a href=#63 class=md-nav__link> <span class=md-ellipsis> 6.3 时区问题调整 </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#7 class=md-nav__link> <span class=md-ellipsis> 7 安装选项 </span> </a> <nav class=md-nav aria-label="7 安装选项"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#71 class=md-nav__link> <span class=md-ellipsis> 7.1 指定命名空间 </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#8 class=md-nav__link> <span class=md-ellipsis> 8 备份选项 </span> </a> <nav class=md-nav aria-label="8 备份选项"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#81 class=md-nav__link> <span class=md-ellipsis> 8.1 启用文件系统备份 </span> </a> </li> <li class=md-nav__item> <a href=#82 class=md-nav__link> <span class=md-ellipsis> 8.2 开源备份工具局限性 </span> </a> </li> </ul> </nav> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=../Install-Consul/ class=md-nav__link> <span class=md-ellipsis> Install Consul </span> </a> </li> <li class=md-nav__item> <a href=../Install-Prometheus/ class=md-nav__link> <span class=md-ellipsis> Install Prometheus </span> </a> </li> <li class=md-nav__item> <a href=../Install-Rabbitmq-Cluster/ class=md-nav__link> <span class=md-ellipsis> Install Rabbitmq Cluster </span> </a> </li> <li class=md-nav__item> <a href=../Install-Dashboard/ class=md-nav__link> <span class=md-ellipsis> Install Dashboard </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--pruned md-nav__item--nested"> <a href=../../docker/Docker/ class=md-nav__link> <span class=md-ellipsis> Docker </span> <span class="md-nav__icon md-icon"></span> </a> </li> <li class="md-nav__item md-nav__item--pruned md-nav__item--nested"> <a href=../../linux/RPM/ class=md-nav__link> <span class=md-ellipsis> Linux </span> <span class="md-nav__icon md-icon"></span> </a> </li> <li class="md-nav__item md-nav__item--pruned md-nav__item--nested"> <a href=../../cicd/Jenkins-Pipeline/ class=md-nav__link> <span class=md-ellipsis> CICD </span> <span class="md-nav__icon md-icon"></span> </a> </li> </ul> </nav> </div> </div> </div> <div class="md-sidebar md-sidebar--secondary" data-md-component=sidebar data-md-type=toc> <div class=md-sidebar__scrollwrap> <div class=md-sidebar__inner> <nav class="md-nav md-nav--secondary" aria-label="Table of contents"> <label class=md-nav__title for=__toc> <span class="md-nav__icon md-icon"></span> Table of contents </label> <ul class=md-nav__list data-md-component=toc data-md-scrollfix> <li class=md-nav__item> <a href=#1 class=md-nav__link> <span class=md-ellipsis> 1 安装客户端 </span> </a> </li> <li class=md-nav__item> <a href=#2 class=md-nav__link> <span class=md-ellipsis> 2 安装服务端 </span> </a> <nav class=md-nav aria-label="2 安装服务端"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#21 class=md-nav__link> <span class=md-ellipsis> 2.1 插件兼容性 </span> </a> </li> <li class=md-nav__item> <a href=#22 class=md-nav__link> <span class=md-ellipsis> 2.2 部署服务端 </span> </a> </li> <li class=md-nav__item> <a href=#23 class=md-nav__link> <span class=md-ellipsis> 2.3 创建备份 </span> </a> </li> <li class=md-nav__item> <a href=#24 class=md-nav__link> <span class=md-ellipsis> 2.4 查看备份 </span> </a> </li> <li class=md-nav__item> <a href=#25 class=md-nav__link> <span class=md-ellipsis> 2.5 备份恢复 </span> </a> </li> <li class=md-nav__item> <a href=#26 class=md-nav__link> <span class=md-ellipsis> 2.6 清理备份 </span> </a> </li> <li class=md-nav__item> <a href=#27 class=md-nav__link> <span class=md-ellipsis> 2.7 完全卸载 </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#3 class=md-nav__link> <span class=md-ellipsis> 3 备份原理 </span> </a> <nav class=md-nav aria-label="3 备份原理"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#31 class=md-nav__link> <span class=md-ellipsis> 3.1 对象存储同步 </span> </a> </li> <li class=md-nav__item> <a href=#32 class=md-nav__link> <span class=md-ellipsis> 3.2 设置备份过期 </span> </a> </li> <li class=md-nav__item> <a href=#33-api class=md-nav__link> <span class=md-ellipsis> 3.3 集群API版本 </span> </a> </li> <li class=md-nav__item> <a href=#34 class=md-nav__link> <span class=md-ellipsis> 3.4 恢复工作流程 </span> </a> </li> <li class=md-nav__item> <a href=#35 class=md-nav__link> <span class=md-ellipsis> 3.5 备份工作流程 </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#4 class=md-nav__link> <span class=md-ellipsis> 4 备份方式 </span> </a> <nav class=md-nav aria-label="4 备份方式"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#41 class=md-nav__link> <span class=md-ellipsis> 4.1 按需备份 </span> </a> <nav class=md-nav aria-label="4.1 按需备份"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#411 class=md-nav__link> <span class=md-ellipsis> 4.1.1 指定特定种类资源的备份顺序 </span> </a> </li> <li class=md-nav__item> <a href=#412 class=md-nav__link> <span class=md-ellipsis> 4.1.2 从备份中排除特定项目 </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#42 class=md-nav__link> <span class=md-ellipsis> 4.2 计划备份 </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#5 class=md-nav__link> <span class=md-ellipsis> 5 查看日志 </span> </a> </li> <li class=md-nav__item> <a href=#6 class=md-nav__link> <span class=md-ellipsis> 6 调优 </span> </a> <nav class=md-nav aria-label="6 调优"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#61 class=md-nav__link> <span class=md-ellipsis> 6.1 修改日志级别 </span> </a> </li> <li class=md-nav__item> <a href=#62 class=md-nav__link> <span class=md-ellipsis> 6.2 命令自动补全 </span> </a> </li> <li class=md-nav__item> <a href=#63 class=md-nav__link> <span class=md-ellipsis> 6.3 时区问题调整 </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#7 class=md-nav__link> <span class=md-ellipsis> 7 安装选项 </span> </a> <nav class=md-nav aria-label="7 安装选项"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#71 class=md-nav__link> <span class=md-ellipsis> 7.1 指定命名空间 </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#8 class=md-nav__link> <span class=md-ellipsis> 8 备份选项 </span> </a> <nav class=md-nav aria-label="8 备份选项"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#81 class=md-nav__link> <span class=md-ellipsis> 8.1 启用文件系统备份 </span> </a> </li> <li class=md-nav__item> <a href=#82 class=md-nav__link> <span class=md-ellipsis> 8.2 开源备份工具局限性 </span> </a> </li> </ul> </nav> </li> </ul> </nav> </div> </div> </div> <div class=md-content data-md-component=content> <article class="md-content__inner md-typeset"> <a href=https://github.com/freemankevin/CloudOps-Handbook/edit/master/docs/helm/Install-Velero.md title="Edit this page" class="md-content__button md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M10 20H6V4h7v5h5v3.1l2-2V8l-6-6H6c-1.1 0-2 .9-2 2v16c0 1.1.9 2 2 2h4v-2m10.2-7c.1 0 .3.1.4.2l1.3 1.3c.2.2.2.6 0 .8l-1 1-2.1-2.1 1-1c.1-.1.2-.2.4-.2m0 3.9L14.1 23H12v-2.1l6.1-6.1 2.1 2.1Z"/></svg> </a> <a href=https://github.com/freemankevin/CloudOps-Handbook/raw/master/docs/helm/Install-Velero.md title="View source of this page" class="md-content__button md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M17 18c.56 0 1 .44 1 1s-.44 1-1 1-1-.44-1-1 .44-1 1-1m0-3c-2.73 0-5.06 1.66-6 4 .94 2.34 3.27 4 6 4s5.06-1.66 6-4c-.94-2.34-3.27-4-6-4m0 6.5a2.5 2.5 0 0 1-2.5-2.5 2.5 2.5 0 0 1 2.5-2.5 2.5 2.5 0 0 1 2.5 2.5 2.5 2.5 0 0 1-2.5 2.5M9.27 20H6V4h7v5h5v4.07c.7.08 1.36.25 2 .49V8l-6-6H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h4.5a8.15 8.15 0 0 1-1.23-2Z"/></svg> </a> <h1>Install Velero</h1> <p><a href=https://velero.io/docs/v1.10/customize-installation/ >Velero官方文档</a></p> <h2 id=1>1 安装客户端<a class=headerlink href=#1 title="Permanent link">&para;</a></h2> <p><a href=https://github.com/vmware-tanzu/velero/releases>客户端下载地址</a></p> <div class=codehilite><pre><span></span><code><span class=c1># 下载</span>
wget<span class=w> </span>https://github.com/vmware-tanzu/velero/releases/download/v1.10.2/velero-v1.10.2-linux-amd64.tar.gz

<span class=c1># 安装客户端</span>
tar<span class=w> </span>xf<span class=w> </span>velero-v1.10.2-linux-amd64.tar.gz
cp<span class=w> </span>velero-v1.10.2-linux-amd64/velero<span class=w> </span>/usr/bin/

<span class=c1># 查看版本</span>
velero<span class=w> </span>version
</code></pre></div> <h2 id=2>2 安装服务端<a class=headerlink href=#2 title="Permanent link">&para;</a></h2> <blockquote> <p>这里选用本地<code>Minio</code> 作为备份存储</p> </blockquote> <h3 id=21>2.1 插件兼容性<a class=headerlink href=#21 title="Permanent link">&para;</a></h3> <p><a href=https://github.com/vmware-tanzu/velero-plugin-for-aws#compatibility><code>s3</code> 插件与<code>velero</code> 版本兼容性的官方说明</a></p> <table> <thead> <tr> <th>Plugin Version</th> <th>Velero Version</th> </tr> </thead> <tbody> <tr> <td>v1.6.x</td> <td>v1.10.x</td> </tr> <tr> <td>v1.5.x</td> <td>v1.9.x</td> </tr> <tr> <td>v1.4.x</td> <td>v1.8.x</td> </tr> <tr> <td>v1.3.x</td> <td>v1.7.x</td> </tr> <tr> <td>v1.2.x</td> <td>v1.6.x</td> </tr> <tr> <td>v1.1.x</td> <td>v1.5.x</td> </tr> <tr> <td>v1.1.x</td> <td>v1.4.x</td> </tr> <tr> <td>v1.0.x</td> <td>v1.3.x</td> </tr> <tr> <td>v1.0.x</td> <td>v1.2.0</td> </tr> </tbody> </table> <h3 id=22>2.2 部署服务端<a class=headerlink href=#22 title="Permanent link">&para;</a></h3> <p><a href=https://velero.io/docs/v1.10/contributions/minio/ >官方操作说明</a></p> <div class=codehilite><pre><span></span><code><span class=c1># 创建minio 桶，过程略</span>
fish-velero


<span class=c1># 创建minio 认证文件</span>
$<span class=w> </span><span class=nb>cd</span><span class=w> </span>velero-v1.10.2-linux-amd64

<span class=s2>&quot;</span>
<span class=s2>cat &lt;&lt;EOF | sudo tee credentials-velero</span>
<span class=s2>[default]</span>
<span class=s2>aws_access_key_id = &quot;</span>admin<span class=s2>&quot;</span>
<span class=s2>aws_secret_access_key = &quot;</span>admin@123<span class=s2>&quot;</span>
<span class=s2>EOF</span>
<span class=s2>&quot;</span>

<span class=c1># 使用客户端安装服务端</span>
<span class=c1># 前提： 当前节点能有集群认证权限，可以通过kubectl 进行部署</span>
<span class=c1># 自定义minio 桶名：fish-velero</span>
<span class=c1># 本地minio 服务器地址: http://10.3.1.250:9000</span>
<span class=c1># plugins 对应插件镜像名，这里用的是本地镜像</span>
$<span class=w> </span>velero<span class=w> </span>install<span class=w> </span><span class=se>\</span>
<span class=w>    </span>--provider<span class=w> </span>aws<span class=w> </span><span class=se>\</span>
<span class=w>    </span>--plugins<span class=w> </span>harbor.dockerregistry.com/gitops/velero/velero-plugin-for-aws:v1.6.0<span class=w> </span><span class=se>\</span>
<span class=w>    </span>--bucket<span class=w> </span>fish-velero<span class=w> </span><span class=se>\</span>
<span class=w>    </span>--secret-file<span class=w> </span>./credentials-velero<span class=w> </span><span class=se>\</span>
<span class=w>    </span>--use-volume-snapshots<span class=o>=</span><span class=nb>false</span><span class=w> </span><span class=se>\</span>
<span class=w>    </span>--backup-location-config<span class=w> </span><span class=nv>region</span><span class=o>=</span>minio,s3ForcePathStyle<span class=o>=</span><span class=s2>&quot;true&quot;</span>,s3Url<span class=o>=</span>http://10.1.1.1:9000


<span class=c1># 部署示例应用</span>
$<span class=w> </span>kubectl<span class=w> </span>apply<span class=w> </span>-f<span class=w> </span>examples/nginx-app/base.yaml

<span class=c1># 检查是否已成功创建 Velero 和 nginx 部署</span>
$<span class=w> </span>kubectl<span class=w> </span>get<span class=w> </span>deployments<span class=w> </span>-l<span class=w> </span><span class=nv>component</span><span class=o>=</span>velero<span class=w> </span>--namespace<span class=o>=</span>velero
$<span class=w> </span>kubectl<span class=w> </span>get<span class=w> </span>deployments<span class=w> </span>--namespace<span class=o>=</span>nginx-example
</code></pre></div> <h3 id=23>2.3 创建备份<a class=headerlink href=#23 title="Permanent link">&para;</a></h3> <p><a href=https://velero.io/docs/v1.10/contributions/minio/ >官方文档</a></p> <div class=codehilite><pre><span></span><code><span class=c1># 为与标签选择器匹配的任何对象创建备份app=nginx</span>
$<span class=w> </span>velero<span class=w> </span>backup<span class=w> </span>create<span class=w> </span>nginx-backup<span class=w> </span>--selector<span class=w> </span><span class=nv>app</span><span class=o>=</span>nginx


<span class=c1># 删除资源</span>
kubectl<span class=w> </span>delete<span class=w> </span>namespace<span class=w> </span>nginx-example
<span class=c1># 检查资源</span>
kubectl<span class=w> </span>get<span class=w> </span>deployments<span class=w> </span>--namespace<span class=o>=</span>nginx-example
kubectl<span class=w> </span>get<span class=w> </span>services<span class=w> </span>--namespace<span class=o>=</span>nginx-example
kubectl<span class=w> </span>get<span class=w> </span>namespace/nginx-example
</code></pre></div> <h3 id=24>2.4 查看备份<a class=headerlink href=#24 title="Permanent link">&para;</a></h3> <div class=codehilite><pre><span></span><code>$<span class=w> </span>velero<span class=w> </span>backup<span class=w> </span>get
</code></pre></div> <h3 id=25>2.5 备份恢复<a class=headerlink href=#25 title="Permanent link">&para;</a></h3> <p><a href=https://velero.io/docs/v1.10/contributions/minio/ >官方文档</a></p> <div class=codehilite><pre><span></span><code><span class=c1># 使用备份进行恢复</span>
$<span class=w> </span>velero<span class=w> </span>restore<span class=w> </span>create<span class=w> </span>--from-backup<span class=w> </span>nginx-backup

<span class=c1># 查看恢复记录</span>
$<span class=w> </span>velero<span class=w> </span>restore<span class=w> </span>get
<span class=c1># 查看恢复详细信息</span>
$<span class=w> </span>velero<span class=w> </span>restore<span class=w> </span>describe<span class=w> </span><span class=nv>$RESTORE_NAME</span>
</code></pre></div> <h3 id=26>2.6 清理备份<a class=headerlink href=#26 title="Permanent link">&para;</a></h3> <div class=codehilite><pre><span></span><code><span class=c1>#Examples:</span>
<span class=w>  </span><span class=c1># Delete a backup named &quot;backup-1&quot;.</span>
<span class=w>  </span>velero<span class=w> </span>backup<span class=w> </span>delete<span class=w> </span>backup-1

<span class=w>  </span><span class=c1># Delete a backup named &quot;backup-1&quot; without prompting for confirmation.</span>
<span class=w>  </span>velero<span class=w> </span>backup<span class=w> </span>delete<span class=w> </span>backup-1<span class=w> </span>--confirm

<span class=w>  </span><span class=c1># Delete backups named &quot;backup-1&quot; and &quot;backup-2&quot;.</span>
<span class=w>  </span>velero<span class=w> </span>backup<span class=w> </span>delete<span class=w> </span>backup-1<span class=w> </span>backup-2

<span class=w>  </span><span class=c1># Delete all backups triggered by schedule &quot;schedule-1&quot;.</span>
<span class=w>  </span>velero<span class=w> </span>backup<span class=w> </span>delete<span class=w> </span>--selector<span class=w> </span>velero.io/schedule-name<span class=o>=</span>schedule-1

<span class=w>  </span><span class=c1># Delete all backups.</span>
<span class=w>  </span>velero<span class=w> </span>backup<span class=w> </span>delete<span class=w> </span>--all
</code></pre></div> <p><a href=https://velero.io/docs/v1.10/contributions/minio/ >官方文档</a></p> <div class=codehilite><pre><span></span><code><span class=c1># 清理备份</span>
velero<span class=w> </span>backup<span class=w> </span>delete<span class=w> </span><span class=nv>$BACKUP_NAME</span>

<span class=c1># 查看备份</span>
velero<span class=w> </span>backup<span class=w> </span>get<span class=w> </span><span class=nv>$BACKUP_NAME</span>
</code></pre></div> <h3 id=27>2.7 完全卸载<a class=headerlink href=#27 title="Permanent link">&para;</a></h3> <p><a href=https://velero.io/docs/v1.10/contributions/minio/ >官方文档</a></p> <div class=codehilite><pre><span></span><code><span class=c1># 清理velero 服务端</span>
kubectl<span class=w> </span>delete<span class=w> </span>namespace/velero<span class=w> </span>clusterrolebinding/velero
kubectl<span class=w> </span>delete<span class=w> </span>crds<span class=w> </span>-l<span class=w> </span><span class=nv>component</span><span class=o>=</span>velero

<span class=c1># 清理示例应用</span>
kubectl<span class=w> </span>delete<span class=w> </span>-f<span class=w> </span>examples/nginx-app/base.yaml
</code></pre></div> <h2 id=3>3 备份原理<a class=headerlink href=#3 title="Permanent link">&para;</a></h2> <p><a href=https://velero.io/docs/v1.10/how-velero-works/ >官方文档</a></p> <h3 id=31>3.1 对象存储同步<a class=headerlink href=#31 title="Permanent link">&para;</a></h3> <blockquote> <p>如果存储桶中有格式正确的备份文件，但 <code>Kubernetes API</code> 中没有对应的备份资源，<code>Velero</code> 会将对象存储的信息同步到 <code>Kubernetes</code>。这允许还原功能在集群迁移场景中工作，其中原始备份对象不存在于新集群中。</p> <p>如果<code>Completed</code>备份对象存在于 <code>Kubernetes</code> 但不在对象存储中，它将从 <code>Kubernetes</code> 中删除，因为备份 <code>tarball</code> 不再存在。 <code>Failed</code>或<code>PartiallyFailed</code>备份不会被对象存储同步删除。</p> </blockquote> <h3 id=32>3.2 设置备份过期<a class=headerlink href=#32 title="Permanent link">&para;</a></h3> <blockquote> <p>创建备份时，可以通过添加标志来指定 <code>TTL</code>（生存时间）<code>--ttl &lt;DURATION&gt;</code>。如果 <code>Velero</code> 发现现有备份资源已过期，它会删除:</p> </blockquote> <ul> <li>备份资源</li> <li>来自云对象存储的备份文件</li> <li>所有 <code>PersistentVolume</code> 快照</li> <li>所有关联的恢复</li> </ul> <blockquote> <p><code>TTL</code> 标志允许用户以小时、分钟和秒的形式指定备份保留期<code>--ttl 24h0m0s</code>。如果未指定，将应用默认的 <code>TTL</code> 值 <code>30</code> 天。</p> <p>如果备份删除失败，<code>velero.io/gc-failure=&lt;Reason&gt;</code>则会在备份自定义资源上添加标签。 您可以使用此标签来筛选和选择未能删除的备份。失败可能的原因是：</p> </blockquote> <ul> <li><code>BSLNotFound</code>：找不到备份存储位置</li> <li><code>BSLCannotGet</code>：由于未找到以外的原因，无法从 API 服务器检索备份存储位置</li> <li><code>BSLReadOnly</code>：备份存储位置是只读的</li> </ul> <h3 id=33-api>3.3 集群<code>API</code>版本<a class=headerlink href=#33-api title="Permanent link">&para;</a></h3> <blockquote> <p><code>Velero</code> 使用 <code>the Kubernetes API server’s preferred version</code> 为每个组/资源备份资源。 <code>When restoring a resource, this same API group/version must exist in the target cluster in order for the restore to be successful.</code> 简言之，当初建立备份的 <code>k8s</code> 集群版本与要还原到的 <code>k8s</code>集群版本需要尽可能一致，否则会因为 <code>API</code>版本差异导致恢复异常。</p> </blockquote> <h3 id=34>3.4 恢复工作流程<a class=headerlink href=#34 title="Permanent link">&para;</a></h3> <blockquote> <p>When you run <code>velero restore create</code> :</p> </blockquote> <ul> <li> <p><code>The Velero client makes a call to the Kubernetes API server to create a Restore object.</code> 客户端会请求<code>k8s api</code> 去创建恢复的资源对象</p> </li> <li> <p><code>The RestoreController notices the new Restore object and performs validation.</code> 恢复控制器会通知备份服务端将需要创建一个恢复对象，然后准备开始执行验证</p> </li> <li> <p><code>The RestoreController fetches the backup information from the object storage service. It then runs some preprocessing on the backed up resources to make sure the resources will work on the new cluster. For example, using the backed-up API versions to verify that the restore resource will work on the target cluster</code>. <br> 恢复控制器会获取备份资源对象，进行预处理来确保要恢复的资源将可以在新的恢复位置上可以进行正常恢复。</p> </li> <li> <p><code>The RestoreController starts the restore process, restoring each eligible resource one at a time.</code> 恢复控制器会执行恢复工作，一次性执行可以用来恢复的合格资源进行恢复。</p> </li> </ul> <h3 id=35>3.5 备份工作流程<a class=headerlink href=#35 title="Permanent link">&para;</a></h3> <blockquote> <p>When you run <code>velero backup create test-backup</code> :</p> </blockquote> <ol> <li> <p><code>The Velero client makes a call to the Kubernetes API server to create a Backup object.</code></p> </li> <li> <p><code>The BackupController notices the new Backup object and performs validation.</code></p> </li> <li> <p><code>The BackupController begins the backup process. It collects the data to back up by querying the API server for resources.</code></p> </li> <li> <p><code>The BackupController makes a call to the object storage service – for example, AWS S3 – to upload the backup file.</code></p> </li> </ol> <p><code>By default, velero backup create makes disk snapshots of any persistent volumes. You can adjust the snapshots by specifying additional flags. Run velero backup create --help to see available flags. Snapshots can be disabled with the option --snapshot-volumes=false.</code></p> <p>![[Pasted image 20230330144306.png]]</p> <h2 id=4>4 备份方式<a class=headerlink href=#4 title="Permanent link">&para;</a></h2> <p><a href=https://velero.io/docs/v1.10/how-velero-works/ >官方文档</a></p> <h3 id=41>4.1 按需备份<a class=headerlink href=#41 title="Permanent link">&para;</a></h3> <h4 id=411>4.1.1 指定特定种类资源的备份顺序<a class=headerlink href=#411 title="Permanent link">&para;</a></h4> <blockquote> <p>要以特定顺序备份特定 <code>Kind</code> 的资源，请使用选项 <code>--ordered-resources</code> 指定映射 <code>Kinds</code> 到该 <code>Kind</code> 特定资源的有序列表。资源名称以逗号分隔，其名称格式为“名称空间/资源名称”。对于集群范围资源，只需使用资源名称。映射中的键值对以分号分隔。种类名称是复数形式。</p> </blockquote> <div class=codehilite><pre><span></span><code><span class=c1># --include-cluster-resources=true  默认就是备份整个集群资源</span>
<span class=c1># --ordered-resources 备份顺序列表清单</span>
<span class=c1># --include-namespaces 指定命名空间</span>
<span class=c1># pod/sts 是命名空间级别资源</span>
<span class=c1># pv 是集群级资源</span>
velero<span class=w> </span>backup<span class=w> </span>create<span class=w> </span>backupName<span class=w> </span>--include-cluster-resources<span class=o>=</span><span class=nb>true</span><span class=w> </span>--ordered-resources<span class=w> </span><span class=s1>&#39;pods=ns1/pod1,ns1/pod2;persistentvolumes=pv4,pv8&#39;</span><span class=w> </span>--include-namespaces<span class=o>=</span>ns1
velero<span class=w> </span>backup<span class=w> </span>create<span class=w> </span>backupName<span class=w> </span>--ordered-resources<span class=w> </span><span class=s1>&#39;statefulsets=ns1/sts1,ns1/sts0&#39;</span><span class=w> </span>--include-namespaces<span class=o>=</span>ns1
</code></pre></div> <h4 id=412>4.1.2 从备份中排除特定项目<a class=headerlink href=#412 title="Permanent link">&para;</a></h4> <div class=codehilite><pre><span></span><code><span class=c1># velero.io/exclude-from-backup=true 就是给资源打的标签</span>
kubectl<span class=w> </span>label<span class=w> </span>-n<span class=w> </span>&lt;ITEM_NAMESPACE&gt;<span class=w> </span>&lt;RESOURCE&gt;/&lt;NAME&gt;<span class=w> </span>velero.io/exclude-from-backup<span class=o>=</span><span class=nb>true</span>
</code></pre></div> <h3 id=42>4.2 计划备份<a class=headerlink href=#42 title="Permanent link">&para;</a></h3> <blockquote> <p>时间间隔由 <a href=https://en.wikipedia.org/wiki/Cron><code>Cron</code> 表达式</a> 指定，<code>Velero</code> 使用名称保存根据计划创建的备份<code>&lt;SCHEDULE NAME&gt;-&lt;TIMESTAMP&gt;</code>，其中<code>&lt;TIMESTAMP&gt;</code>格式为<code>YYYYMMDDhhmmss</code></p> <p><code>Cron</code> 计划使用以下格式：</p> </blockquote> <div class=codehilite><pre><span></span><code><span class=c1># ┌───────────── minute (0 - 59)</span>
<span class=c1># │ ┌───────────── hour (0 - 23)</span>
<span class=c1># │ │ ┌───────────── day of the month (1 - 31)</span>
<span class=c1># │ │ │ ┌───────────── month (1 - 12)</span>
<span class=c1># │ │ │ │ ┌───────────── day of the week (0 - 6) (Sunday to Saturday;</span>
<span class=c1># │ │ │ │ │                                   7 is also Sunday on some systems)</span>
<span class=c1># │ │ │ │ │</span>
<span class=c1># │ │ │ │ │</span>
<span class=c1># * * * * *</span>
</code></pre></div> <blockquote> <p>语法格式：</p> </blockquote> <div class=codehilite><pre><span></span><code><span class=c1># 创建备份计划</span>
velero<span class=w> </span>schedule<span class=w> </span>create<span class=w> </span><span class=si>${</span><span class=nv>BACKUP</span><span class=p>-SCHEDULE-NAME</span><span class=si>}</span><span class=w> </span>--schedule<span class=o>=</span><span class=s2>&quot;* * * * *&quot;</span><span class=w> </span><span class=o>[</span>flags<span class=o>]</span>

<span class=c1># 清理备份计划</span>
velero<span class=w> </span>schedule<span class=w> </span>delete<span class=w> </span><span class=si>${</span><span class=nv>BACKUP</span><span class=p>-SCHEDULE-NAME</span><span class=si>}</span>

<span class=c1># 立即触发备份计划</span>
velero<span class=w> </span>backup<span class=w> </span>create<span class=w> </span>--from-schedule<span class=w> </span><span class=si>${</span><span class=nv>BACKUP</span><span class=p>-SCHEDULE-NAME</span><span class=si>}</span>
</code></pre></div> <blockquote> <p>示例1，每天凌晨3点开始备份：</p> </blockquote> <div class=codehilite><pre><span></span><code><span class=c1># 备份计划中指定备份周期，备份对象</span>
velero<span class=w> </span>schedule<span class=w> </span>create<span class=w> </span>example-schedule<span class=w> </span>--schedule<span class=o>=</span><span class=s2>&quot;0 3 * * *&quot;</span><span class=w>  </span>--selector<span class=w> </span><span class=nv>app</span><span class=o>=</span>nginx<span class=w> </span>--include-namespaces<span class=w> </span>nginx-example
<span class=c1># 备份计划中指定命名空间，默认备份所有命名空间</span>
velero<span class=w> </span>schedule<span class=w> </span>create<span class=w> </span>example-schedule2<span class=w> </span>--schedule<span class=o>=</span><span class=s2>&quot;0 3 * * *&quot;</span><span class=w> </span>--include-namespaces<span class=w> </span>nginx-example<span class=w> </span>
<span class=c1># 备份计划中，设置备份过期时间</span>
velero<span class=w> </span>schedule<span class=w> </span>create<span class=w> </span>example-schedule3<span class=w> </span>--schedule<span class=o>=</span><span class=s2>&quot;40 9 * * *&quot;</span><span class=w> </span>--include-namespaces<span class=o>=</span><span class=s2>&quot;nginx-example&quot;</span><span class=w> </span>--ttl<span class=o>=</span><span class=s2>&quot;72h&quot;</span>

<span class=c1># 立即触发</span>
velero<span class=w> </span>backup<span class=w> </span>create<span class=w> </span>--from-schedule<span class=w> </span>example-schedule3

<span class=c1># 查看备份</span>
$<span class=w> </span>velero<span class=w> </span>backup<span class=w> </span>get
NAME<span class=w>                               </span>STATUS<span class=w>      </span>ERRORS<span class=w>   </span>WARNINGS<span class=w>   </span>CREATED<span class=w>                         </span>EXPIRES<span class=w>   </span>STORAGE<span class=w> </span>LOCATION<span class=w>   </span>SELECTOR
example-schedule3-20230330083511<span class=w>   </span>Completed<span class=w>   </span><span class=m>0</span><span class=w>        </span><span class=m>0</span><span class=w>          </span><span class=m>2023</span>-03-30<span class=w> </span><span class=m>16</span>:35:11<span class=w> </span>+0800<span class=w> </span>CST<span class=w>   </span>2d<span class=w>        </span>default<span class=w>            </span>&lt;none&gt;
nginx-backup<span class=w>                       </span>Completed<span class=w>   </span><span class=m>0</span><span class=w>        </span><span class=m>0</span><span class=w>          </span><span class=m>2023</span>-03-30<span class=w> </span><span class=m>10</span>:29:56<span class=w> </span>+0800<span class=w> </span>CST<span class=w>   </span>29d<span class=w>       </span>default<span class=w>            </span><span class=nv>app</span><span class=o>=</span>nginx
</code></pre></div> <h2 id=5>5 查看日志<a class=headerlink href=#5 title="Permanent link">&para;</a></h2> <div class=codehilite><pre><span></span><code><span class=c1># 查看deploy 日志</span>
$<span class=w> </span>kubectl<span class=w> </span>logs<span class=w> </span>-f<span class=w> </span>--tail<span class=w> </span><span class=m>1000</span><span class=w>  </span>deployment/velero<span class=w> </span>-n<span class=w> </span>velero


<span class=c1># 检查备份存储位置的状态，显示备份存储位置的当前状态以及可能存在的任何错误</span>
$<span class=w> </span>velero<span class=w> </span>backup-location<span class=w> </span>get<span class=w> </span>-n<span class=w> </span>velero
</code></pre></div> <h2 id=6>6 调优<a class=headerlink href=#6 title="Permanent link">&para;</a></h2> <h3 id=61>6.1 修改日志级别<a class=headerlink href=#61 title="Permanent link">&para;</a></h3> <blockquote> <p>默认<code>info</code></p> </blockquote> <div class=codehilite><pre><span></span><code><span class=nn>...</span>
<span class=w>      </span><span class=nt>containers</span><span class=p>:</span>
<span class=w>        </span><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">velero</span>
<span class=w>          </span><span class=nt>image</span><span class=p>:</span><span class=w> </span><span class=s>&#39;harbor.dockerregistry.com/gitops/velero/velero:v1.10.2&#39;</span>
<span class=w>          </span><span class=nt>command</span><span class=p>:</span>
<span class=w>            </span><span class="p p-Indicator">-</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">/velero</span>
<span class=w>          </span><span class=nt>args</span><span class=p>:</span>
<span class=w>            </span><span class="p p-Indicator">-</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">server</span>
<span class=w>            </span><span class="p p-Indicator">-</span><span class=w> </span><span class=s>&#39;--features=&#39;</span>
<span class=w>            </span><span class="p p-Indicator">-</span><span class=w> </span><span class=s>&#39;--uploader-type=restic&#39;</span>
<span class=w>            </span><span class="p p-Indicator">-</span><span class=w> </span><span class=s>&#39;--log-level=debug&#39;</span><span class=w>  </span><span class=c1>## 加在这里</span>
</code></pre></div> <h3 id=62>6.2 命令自动补全<a class=headerlink href=#62 title="Permanent link">&para;</a></h3> <blockquote> <p>先实现 <code>kubectl</code> 命令自动补全</p> </blockquote> <div class=codehilite><pre><span></span><code>yum<span class=w> </span>install<span class=w> </span>-y<span class=w> </span>bash-completion
<span class=nb>source</span><span class=w> </span>/usr/share/bash-completion/bash_completion
<span class=nb>source</span><span class=w> </span>&lt;<span class=o>(</span>kubectl<span class=w> </span>completion<span class=w> </span>bash<span class=o>)</span>
<span class=nb>echo</span><span class=w> </span><span class=s2>&quot;source &lt;(kubectl completion bash)&quot;</span><span class=w> </span>&gt;&gt;<span class=w> </span>~/.bashrc
<span class=nb>source</span><span class=w> </span>~/.bashrc
</code></pre></div> <blockquote> <p>再实现<code>velero</code> 命令自动补全</p> </blockquote> <div class=codehilite><pre><span></span><code><span class=nb>source</span><span class=w> </span>/usr/share/bash-completion/bash_completion
<span class=nb>echo</span><span class=w> </span><span class=s1>&#39;source &lt;(velero completion bash)&#39;</span><span class=w> </span>&gt;&gt;~/.bashrc
velero<span class=w> </span>completion<span class=w> </span>bash<span class=w> </span>&gt;/etc/bash_completion.d/velero
<span class=nb>echo</span><span class=w> </span><span class=s1>&#39;alias v=velero&#39;</span><span class=w> </span>&gt;&gt;~/.bashrc
<span class=nb>echo</span><span class=w> </span><span class=s1>&#39;complete -F __start_velero v&#39;</span><span class=w> </span>&gt;&gt;~/.bashrc
<span class=nb>source</span><span class=w> </span>~/.bashrc
</code></pre></div> <h3 id=63>6.3 时区问题调整<a class=headerlink href=#63 title="Permanent link">&para;</a></h3> <blockquote> <p>默认使用的是<code>UTC</code> 时间</p> </blockquote> <div class=codehilite><pre><span></span><code><span class=n>kind</span><span class=p>:</span><span class=w> </span><span class=n>Deployment</span>
<span class=n>apiVersion</span><span class=p>:</span><span class=w> </span><span class=n>apps</span><span class=o>/</span><span class=n>v1</span>
<span class=n>metadata</span><span class=p>:</span>
<span class=w>  </span><span class=n>name</span><span class=p>:</span><span class=w> </span><span class=n>velero</span>
<span class=w>  </span><span class=n>namespace</span><span class=p>:</span><span class=w> </span><span class=n>velero</span>
<span class=w>  </span><span class=n>labels</span><span class=p>:</span>
<span class=w>    </span><span class=n>component</span><span class=p>:</span><span class=w> </span><span class=n>velero</span>
<span class=w>  </span><span class=n>annotations</span><span class=p>:</span>
<span class=w>    </span><span class=n>deployment</span><span class=o>.</span><span class=n>kubernetes</span><span class=o>.</span><span class=n>io</span><span class=o>/</span><span class=n>revision</span><span class=p>:</span><span class=w> </span><span class=s1>&#39;6&#39;</span>
<span class=n>spec</span><span class=p>:</span>
<span class=w>  </span><span class=n>replicas</span><span class=p>:</span><span class=w> </span><span class=mi>1</span>
<span class=w>  </span><span class=n>selector</span><span class=p>:</span>
<span class=w>    </span><span class=n>matchLabels</span><span class=p>:</span>
<span class=w>      </span><span class=n>deploy</span><span class=p>:</span><span class=w> </span><span class=n>velero</span>
<span class=w>  </span><span class=n>template</span><span class=p>:</span>
<span class=w>    </span><span class=n>metadata</span><span class=p>:</span>
<span class=w>      </span><span class=n>creationTimestamp</span><span class=p>:</span><span class=w> </span><span class="nb nb-Type">null</span>
<span class=w>      </span><span class=n>labels</span><span class=p>:</span>
<span class=w>        </span><span class=n>component</span><span class=p>:</span><span class=w> </span><span class=n>velero</span>
<span class=w>        </span><span class=n>deploy</span><span class=p>:</span><span class=w> </span><span class=n>velero</span>
<span class=w>      </span><span class=n>annotations</span><span class=p>:</span>
<span class=w>        </span><span class=n>prometheus</span><span class=o>.</span><span class=n>io</span><span class=o>/</span><span class=n>path</span><span class=p>:</span><span class=w> </span><span class=o>/</span><span class=n>metrics</span>
<span class=w>        </span><span class=n>prometheus</span><span class=o>.</span><span class=n>io</span><span class=o>/</span><span class=n>port</span><span class=p>:</span><span class=w> </span><span class=s1>&#39;8085&#39;</span>
<span class=w>        </span><span class=n>prometheus</span><span class=o>.</span><span class=n>io</span><span class=o>/</span><span class=n>scrape</span><span class=p>:</span><span class=w> </span><span class=s1>&#39;true&#39;</span>
<span class=w>    </span><span class=n>spec</span><span class=p>:</span>
<span class=w>      </span><span class=n>volumes</span><span class=p>:</span>
<span class=w>        </span><span class=o>-</span><span class=w> </span><span class=n>name</span><span class=p>:</span><span class=w> </span><span class=n>plugins</span>
<span class=w>          </span><span class=n>emptyDir</span><span class=p>:</span><span class=w> </span><span class=p>{}</span>
<span class=w>        </span><span class=o>-</span><span class=w> </span><span class=n>name</span><span class=p>:</span><span class=w> </span><span class=n>scratch</span>
<span class=w>          </span><span class=n>emptyDir</span><span class=p>:</span><span class=w> </span><span class=p>{}</span>
<span class=w>        </span><span class=o>-</span><span class=w> </span><span class=n>name</span><span class=p>:</span><span class=w> </span><span class=n>cloud</span><span class=o>-</span><span class=n>credentials</span>
<span class=w>          </span><span class=n>secret</span><span class=p>:</span>
<span class=w>            </span><span class=n>secretName</span><span class=p>:</span><span class=w> </span><span class=n>cloud</span><span class=o>-</span><span class=n>credentials</span>
<span class=w>            </span><span class=n>defaultMode</span><span class=p>:</span><span class=w> </span><span class=mi>420</span>
<span class=w>        </span><span class=o>-</span><span class=w> </span><span class=n>name</span><span class=p>:</span><span class=w> </span><span class=n>host</span><span class=o>-</span><span class=n>time</span><span class=w>             </span><span class=c1>######################### 这里，同步主机时间</span>
<span class=w>          </span><span class=n>hostPath</span><span class=p>:</span>
<span class=w>            </span><span class=n>path</span><span class=p>:</span><span class=w> </span><span class=o>/</span><span class=n>etc</span><span class=o>/</span><span class=n>localtime</span>
<span class=w>            </span><span class=n>type</span><span class=p>:</span><span class=w> </span><span class=s1>&#39;&#39;</span>
<span class=w>      </span><span class=n>initContainers</span><span class=p>:</span>
<span class=w>        </span><span class=o>-</span><span class=w> </span><span class=n>name</span><span class=p>:</span><span class=w> </span><span class=n>gitops</span><span class=o>-</span><span class=n>velero</span><span class=o>-</span><span class=n>velero</span><span class=o>-</span><span class=n>plugin</span><span class=o>-</span><span class=k>for</span><span class=o>-</span><span class=n>aws</span>
<span class=w>          </span><span class=n>image</span><span class=p>:</span><span class=w> </span><span class=s1>&#39;harbor.dockerregistry.com/gitops/velero/velero-plugin-for-aws:v1.6.0&#39;</span>
<span class=w>          </span><span class=n>resources</span><span class=p>:</span><span class=w> </span><span class=p>{}</span>
<span class=w>          </span><span class=n>volumeMounts</span><span class=p>:</span>
<span class=w>            </span><span class=o>-</span><span class=w> </span><span class=n>name</span><span class=p>:</span><span class=w> </span><span class=n>plugins</span>
<span class=w>              </span><span class=n>mountPath</span><span class=p>:</span><span class=w> </span><span class=o>/</span><span class=n>target</span>
<span class=w>          </span><span class=n>terminationMessagePath</span><span class=p>:</span><span class=w> </span><span class=o>/</span><span class=n>dev</span><span class=o>/</span><span class=n>termination</span><span class=o>-</span><span class=nb>log</span>
<span class=w>          </span><span class=n>terminationMessagePolicy</span><span class=p>:</span><span class=w> </span><span class=n>File</span>
<span class=w>          </span><span class=n>imagePullPolicy</span><span class=p>:</span><span class=w> </span><span class=n>IfNotPresent</span>
<span class=w>      </span><span class=n>containers</span><span class=p>:</span>
<span class=w>        </span><span class=o>-</span><span class=w> </span><span class=n>name</span><span class=p>:</span><span class=w> </span><span class=n>velero</span>
<span class=w>          </span><span class=n>image</span><span class=p>:</span><span class=w> </span><span class=s1>&#39;harbor.dockerregistry.com/gitops/velero/velero:v1.10.2&#39;</span>
<span class=w>          </span><span class=n>command</span><span class=p>:</span>
<span class=w>            </span><span class=o>-</span><span class=w> </span><span class=o>/</span><span class=n>velero</span>
<span class=w>          </span><span class=n>args</span><span class=p>:</span>
<span class=w>            </span><span class=o>-</span><span class=w> </span><span class=n>server</span>
<span class=w>            </span><span class=o>-</span><span class=w> </span><span class=s1>&#39;--features=&#39;</span>
<span class=w>            </span><span class=o>-</span><span class=w> </span><span class=s1>&#39;--uploader-type=restic&#39;</span>
<span class=w>            </span><span class=o>-</span><span class=w> </span><span class=s1>&#39;--log-level=debug&#39;</span>
<span class=w>          </span><span class=n>ports</span><span class=p>:</span>
<span class=w>            </span><span class=o>-</span><span class=w> </span><span class=n>name</span><span class=p>:</span><span class=w> </span><span class=n>metrics</span>
<span class=w>              </span><span class=n>containerPort</span><span class=p>:</span><span class=w> </span><span class=mi>8085</span>
<span class=w>              </span><span class=n>protocol</span><span class=p>:</span><span class=w> </span><span class=n>TCP</span>
<span class=w>          </span><span class=n>env</span><span class=p>:</span>
<span class=w>            </span><span class=o>-</span><span class=w> </span><span class=n>name</span><span class=p>:</span><span class=w> </span><span class=n>VELERO_SCRATCH_DIR</span>
<span class=w>              </span><span class=n>value</span><span class=p>:</span><span class=w> </span><span class=o>/</span><span class=n>scratch</span>
<span class=w>            </span><span class=o>-</span><span class=w> </span><span class=n>name</span><span class=p>:</span><span class=w> </span><span class=n>VELERO_NAMESPACE</span>
<span class=w>              </span><span class=n>valueFrom</span><span class=p>:</span>
<span class=w>                </span><span class=n>fieldRef</span><span class=p>:</span>
<span class=w>                  </span><span class=n>apiVersion</span><span class=p>:</span><span class=w> </span><span class=n>v1</span>
<span class=w>                  </span><span class=n>fieldPath</span><span class=p>:</span><span class=w> </span><span class=n>metadata</span><span class=o>.</span><span class=n>namespace</span>
<span class=w>            </span><span class=o>-</span><span class=w> </span><span class=n>name</span><span class=p>:</span><span class=w> </span><span class=n>LD_LIBRARY_PATH</span>
<span class=w>              </span><span class=n>value</span><span class=p>:</span><span class=w> </span><span class=o>/</span><span class=n>plugins</span>
<span class=w>            </span><span class=o>-</span><span class=w> </span><span class=n>name</span><span class=p>:</span><span class=w> </span><span class=n>GOOGLE_APPLICATION_CREDENTIALS</span>
<span class=w>              </span><span class=n>value</span><span class=p>:</span><span class=w> </span><span class=o>/</span><span class=n>credentials</span><span class=o>/</span><span class=n>cloud</span>
<span class=w>            </span><span class=o>-</span><span class=w> </span><span class=n>name</span><span class=p>:</span><span class=w> </span><span class=n>AWS_SHARED_CREDENTIALS_FILE</span>
<span class=w>              </span><span class=n>value</span><span class=p>:</span><span class=w> </span><span class=o>/</span><span class=n>credentials</span><span class=o>/</span><span class=n>cloud</span>
<span class=w>            </span><span class=o>-</span><span class=w> </span><span class=n>name</span><span class=p>:</span><span class=w> </span><span class=n>AZURE_CREDENTIALS_FILE</span>
<span class=w>              </span><span class=n>value</span><span class=p>:</span><span class=w> </span><span class=o>/</span><span class=n>credentials</span><span class=o>/</span><span class=n>cloud</span>
<span class=w>            </span><span class=o>-</span><span class=w> </span><span class=n>name</span><span class=p>:</span><span class=w> </span><span class=n>ALIBABA_CLOUD_CREDENTIALS_FILE</span>
<span class=w>              </span><span class=n>value</span><span class=p>:</span><span class=w> </span><span class=o>/</span><span class=n>credentials</span><span class=o>/</span><span class=n>cloud</span>
<span class=w>          </span><span class=n>resources</span><span class=p>:</span>
<span class=w>            </span><span class=n>limits</span><span class=p>:</span>
<span class=w>              </span><span class=n>cpu</span><span class=p>:</span><span class=w> </span><span class=s1>&#39;1&#39;</span>
<span class=w>              </span><span class=n>memory</span><span class=p>:</span><span class=w> </span><span class=mi>512</span><span class=n>Mi</span>
<span class=w>            </span><span class=n>requests</span><span class=p>:</span>
<span class=w>              </span><span class=n>cpu</span><span class=p>:</span><span class=w> </span><span class=mi>500</span><span class=n>m</span>
<span class=w>              </span><span class=n>memory</span><span class=p>:</span><span class=w> </span><span class=mi>128</span><span class=n>Mi</span>
<span class=w>          </span><span class=n>volumeMounts</span><span class=p>:</span>
<span class=w>            </span><span class=o>-</span><span class=w> </span><span class=n>name</span><span class=p>:</span><span class=w> </span><span class=n>plugins</span>
<span class=w>              </span><span class=n>mountPath</span><span class=p>:</span><span class=w> </span><span class=o>/</span><span class=n>plugins</span>
<span class=w>            </span><span class=o>-</span><span class=w> </span><span class=n>name</span><span class=p>:</span><span class=w> </span><span class=n>scratch</span>
<span class=w>              </span><span class=n>mountPath</span><span class=p>:</span><span class=w> </span><span class=o>/</span><span class=n>scratch</span>
<span class=w>            </span><span class=o>-</span><span class=w> </span><span class=n>name</span><span class=p>:</span><span class=w> </span><span class=n>cloud</span><span class=o>-</span><span class=n>credentials</span>
<span class=w>              </span><span class=n>mountPath</span><span class=p>:</span><span class=w> </span><span class=o>/</span><span class=n>credentials</span>
<span class=w>            </span><span class=o>-</span><span class=w> </span><span class=n>name</span><span class=p>:</span><span class=w> </span><span class=n>host</span><span class=o>-</span><span class=n>time</span><span class=w>               </span><span class=c1>######################### 这里，同步主机时间</span>
<span class=w>              </span><span class=n>readOnly</span><span class=p>:</span><span class=w> </span><span class=bp>true</span>
<span class=w>              </span><span class=n>mountPath</span><span class=p>:</span><span class=w> </span><span class=o>/</span><span class=n>etc</span><span class=o>/</span><span class=n>localtime</span>
<span class=w>          </span><span class=n>terminationMessagePath</span><span class=p>:</span><span class=w> </span><span class=o>/</span><span class=n>dev</span><span class=o>/</span><span class=n>termination</span><span class=o>-</span><span class=nb>log</span>
<span class=w>          </span><span class=n>terminationMessagePolicy</span><span class=p>:</span><span class=w> </span><span class=n>File</span>
<span class=w>          </span><span class=n>imagePullPolicy</span><span class=p>:</span><span class=w> </span><span class=n>IfNotPresent</span>
<span class=w>      </span><span class=n>restartPolicy</span><span class=p>:</span><span class=w> </span><span class=n>Always</span>
<span class=w>      </span><span class=n>terminationGracePeriodSeconds</span><span class=p>:</span><span class=w> </span><span class=mi>30</span>
<span class=w>      </span><span class=n>dnsPolicy</span><span class=p>:</span><span class=w> </span><span class=n>ClusterFirst</span>
<span class=w>      </span><span class=n>serviceAccountName</span><span class=p>:</span><span class=w> </span><span class=n>velero</span>
<span class=w>      </span><span class=n>serviceAccount</span><span class=p>:</span><span class=w> </span><span class=n>velero</span>
<span class=w>      </span><span class=n>securityContext</span><span class=p>:</span><span class=w> </span><span class=p>{}</span>
<span class=w>      </span><span class=n>schedulerName</span><span class=p>:</span><span class=w> </span><span class=n>default</span><span class=o>-</span><span class=n>scheduler</span>
<span class=w>  </span><span class=n>strategy</span><span class=p>:</span>
<span class=w>    </span><span class=n>type</span><span class=p>:</span><span class=w> </span><span class=n>RollingUpdate</span>
<span class=w>    </span><span class=n>rollingUpdate</span><span class=p>:</span>
<span class=w>      </span><span class=n>maxUnavailable</span><span class=p>:</span><span class=w> </span><span class=mi>25</span><span class=o>%</span>
<span class=w>      </span><span class=n>maxSurge</span><span class=p>:</span><span class=w> </span><span class=mi>25</span><span class=o>%</span>
<span class=w>  </span><span class=n>revisionHistoryLimit</span><span class=p>:</span><span class=w> </span><span class=mi>10</span>
<span class=w>  </span><span class=n>progressDeadlineSeconds</span><span class=p>:</span><span class=w> </span><span class=mi>600</span>
</code></pre></div> <h2 id=7>7 安装选项<a class=headerlink href=#7 title="Permanent link">&para;</a></h2> <p>[官方文档](https://velero.io/docs/main/customize-installation/#plugins</p> <div class=codehilite><pre><span></span><code><span class=c1># minio 做外部备份存储的备份服务端安装方式</span>
$<span class=w> </span>velero<span class=w> </span>install<span class=w> </span><span class=se>\</span>
<span class=w>    </span>--provider<span class=w> </span>aws<span class=w> </span><span class=se>\</span>
<span class=w>    </span>--plugins<span class=w> </span>harbor.dockerregistry.com/gitops/velero/velero-plugin-for-aws:v1.6.0<span class=w> </span><span class=se>\</span>
<span class=w>    </span>--bucket<span class=w> </span>fish-velero<span class=w> </span><span class=se>\</span>
<span class=w>    </span>--secret-file<span class=w> </span>./credentials-velero<span class=w> </span><span class=se>\</span>
<span class=w>    </span>--use-volume-snapshots<span class=o>=</span><span class=nb>false</span><span class=w> </span><span class=se>\</span>
<span class=w>    </span>--backup-location-config<span class=w> </span><span class=nv>region</span><span class=o>=</span>minio,s3ForcePathStyle<span class=o>=</span><span class=s2>&quot;true&quot;</span>,s3Url<span class=o>=</span>http://10.1.1.1:9000
</code></pre></div> <h3 id=71>7.1 指定命名空间<a class=headerlink href=#71 title="Permanent link">&para;</a></h3> <blockquote> <p>默认服务端和客户端都是找的命名空间 <code>velero</code></p> </blockquote> <div class=codehilite><pre><span></span><code><span class=c1>## 部署服务端时指定</span>
<span class=c1># velero install [flags]</span>
velero<span class=w> </span>install<span class=w> </span><span class=se>\</span>
--namespace<span class=w> </span>xxx

<span class=c1>## 客户端需要配置为一致</span>
<span class=c1># velero client config set KEY=VALUE [KEY=VALUE]... [flags]</span>
velero<span class=w> </span>client<span class=w> </span>config<span class=w> </span><span class=nb>set</span><span class=w> </span><span class=nv>namespace</span><span class=o>=</span><span class=nv>$NAMESPACE_VALUE</span>
</code></pre></div> <h2 id=8>8 备份选项<a class=headerlink href=#8 title="Permanent link">&para;</a></h2> <h3 id=81>8.1 启用文件系统备份<a class=headerlink href=#81 title="Permanent link">&para;</a></h3> <div class=codehilite><pre><span></span><code><span class=c1>## 部署服务端时指定</span>
<span class=c1># velero install [flags]</span>
velero<span class=w> </span>install<span class=w> </span><span class=se>\</span>
--use-node-agent
</code></pre></div> <h3 id=82>8.2 开源备份工具局限性<a class=headerlink href=#82 title="Permanent link">&para;</a></h3> <blockquote> <p>综合评估，建议在使用开源备份工具 <code>restic</code> 、 <code>kopia</code> 时，使用独立或更高配置的服务器做为客户端，建议至少可用配置在<code>4C、4G</code> ，方便客户端再执行备份工作时有的资源可用，同时，<code>kopia</code> 相较来说更满足大部分场景需求。这里是<a href=https://velero.io/docs/main/performance-guidance/ >官方测评报告</a></p> </blockquote> <aside class=md-source-file> <span class=md-source-file__fact> <span class=md-icon title="Last update"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M21 13.1c-.1 0-.3.1-.4.2l-1 1 2.1 2.1 1-1c.2-.2.2-.6 0-.8l-1.3-1.3c-.1-.1-.2-.2-.4-.2m-1.9 1.8-6.1 6V23h2.1l6.1-6.1-2.1-2M12.5 7v5.2l4 2.4-1 1L11 13V7h1.5M11 21.9c-5.1-.5-9-4.8-9-9.9C2 6.5 6.5 2 12 2c5.3 0 9.6 4.1 10 9.3-.3-.1-.6-.2-1-.2s-.7.1-1 .2C19.6 7.2 16.2 4 12 4c-4.4 0-8 3.6-8 8 0 4.1 3.1 7.5 7.1 7.9l-.1.2v1.8Z"/></svg> </span> <span class="git-revision-date-localized-plugin git-revision-date-localized-plugin-date">February 26, 2024</span> </span> <span class=md-source-file__fact> <span class=md-icon title=Created> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M14.47 15.08 11 13V7h1.5v5.25l3.08 1.83c-.41.28-.79.62-1.11 1m-1.39 4.84c-.36.05-.71.08-1.08.08-4.42 0-8-3.58-8-8s3.58-8 8-8 8 3.58 8 8c0 .37-.03.72-.08 1.08.69.1 1.33.32 1.92.64.1-.56.16-1.13.16-1.72 0-5.5-4.5-10-10-10S2 6.5 2 12s4.47 10 10 10c.59 0 1.16-.06 1.72-.16-.32-.59-.54-1.23-.64-1.92M18 15v3h-3v2h3v3h2v-3h3v-2h-3v-3h-2Z"/></svg> </span> <span class="git-revision-date-localized-plugin git-revision-date-localized-plugin-date">February 26, 2024</span> </span> <span class=md-source-file__fact> <span class=md-icon title=Contributors> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M12 4a4 4 0 0 1 4 4 4 4 0 0 1-4 4 4 4 0 0 1-4-4 4 4 0 0 1 4-4m0 10c4.42 0 8 1.79 8 4v2H4v-2c0-2.21 3.58-4 8-4Z"/></svg> </span> <nav> <a href=mailto:freemankevin2017@gmail.com>freemankevin</a> </nav> </span> </aside> </article> </div> <script>var tabs=__md_get("__tabs");if(Array.isArray(tabs))e:for(var set of document.querySelectorAll(".tabbed-set")){var tab,labels=set.querySelector(".tabbed-labels");for(tab of tabs)for(var label of labels.getElementsByTagName("label"))if(label.innerText.trim()===tab){var input=document.getElementById(label.htmlFor);input.checked=!0;continue e}}</script> <script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script> </div> <button type=button class="md-top md-icon" data-md-component=top hidden> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8v12Z"/></svg> Back to top </button> </main> <footer class=md-footer> <nav class="md-footer__inner md-grid" aria-label=Footer> <a href=../Install-Openelb/ class="md-footer__link md-footer__link--prev" aria-label="Previous: Install Openelb"> <div class="md-footer__button md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg> </div> <div class=md-footer__title> <span class=md-footer__direction> Previous </span> <div class=md-ellipsis> Install Openelb </div> </div> </a> <a href=../Install-Consul/ class="md-footer__link md-footer__link--next" aria-label="Next: Install Consul"> <div class=md-footer__title> <span class=md-footer__direction> Next </span> <div class=md-ellipsis> Install Consul </div> </div> <div class="md-footer__button md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11H4Z"/></svg> </div> </a> </nav> <div class="md-footer-meta md-typeset"> <div class="md-footer-meta__inner md-grid"> <div class=md-copyright> <div class=md-copyright__highlight> Copyright &copy; 2020 - 2024 Freeman Kevin </div> Made with <a href=https://squidfunk.github.io/mkdocs-material/ target=_blank rel=noopener> Material for MkDocs </a> </div> <div class=md-social> <a href=https://github.com/freemankevin target=_blank rel=noopener title=github.com class=md-social__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 496 512"><!-- Font Awesome Free 6.5.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z"/></svg> </a> <a href=https://mastodon.social/@freemankevin target=_blank rel="noopener me" title=mastodon.social class=md-social__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 448 512"><!-- Font Awesome Free 6.5.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M433 179.11c0-97.2-63.71-125.7-63.71-125.7-62.52-28.7-228.56-28.4-290.48 0 0 0-63.72 28.5-63.72 125.7 0 115.7-6.6 259.4 105.63 289.1 40.51 10.7 75.32 13 103.33 11.4 50.81-2.8 79.32-18.1 79.32-18.1l-1.7-36.9s-36.31 11.4-77.12 10.1c-40.41-1.4-83-4.4-89.63-54a102.54 102.54 0 0 1-.9-13.9c85.63 20.9 158.65 9.1 178.75 6.7 56.12-6.7 105-41.3 111.23-72.9 9.8-49.8 9-121.5 9-121.5zm-75.12 125.2h-46.63v-114.2c0-49.7-64-51.6-64 6.9v62.5h-46.33V197c0-58.5-64-56.6-64-6.9v114.2H90.19c0-122.1-5.2-147.9 18.41-175 25.9-28.9 79.82-30.8 103.83 6.1l11.6 19.5 11.6-19.5c24.11-37.1 78.12-34.8 103.83-6.1 23.71 27.3 18.4 53 18.4 175z"/></svg> </a> <a href=mailto:freemankevin2017@gmail.com target=_blank rel=noopener title class=md-social__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 512 512"><!-- Font Awesome Free 6.5.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M48 64C21.5 64 0 85.5 0 112c0 15.1 7.1 29.3 19.2 38.4l217.6 163.2c11.4 8.5 27 8.5 38.4 0l217.6-163.2c12.1-9.1 19.2-23.3 19.2-38.4 0-26.5-21.5-48-48-48H48zM0 176v208c0 35.3 28.7 64 64 64h384c35.3 0 64-28.7 64-64V176L294.4 339.2a63.9 63.9 0 0 1-76.8 0L0 176z"/></svg> </a> </div> </div> </div> </footer> </div> <div class=md-dialog data-md-component=dialog> <div class="md-dialog__inner md-typeset"></div> </div> <div class=md-progress data-md-component=progress role=progressbar></div> <script id=__config type=application/json>{"base": "../..", "features": ["announce.dismiss", "content.action.edit", "content.action.view", "content.code.annotate", "content.code.copy", "content.code.select", "content.tabs.link", "content.tooltips", "navigation.footer", "navigation.indexes", "navigation.instant", "navigation.instant.prefetch", "navigation.instant.progress", "navigation.prune", "navigation.sections", "navigation.tabs", "navigation.top", "navigation.tracking", "search.highlight", "search.share", "search.suggest", "toc.follow"], "search": "../../assets/javascripts/workers/search.b8dbb3d2.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}}</script> <script src=../../assets/javascripts/bundle.8fd75fb4.min.js></script> <script src=../../assets/javascripts/custom.054acff4.min.js></script> </body> </html>