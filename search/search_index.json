{"config":{"lang":["en"],"separator":"[\\s\\u200b\\-_,:!=\\[\\]()\"`/]+|\\.(?!\\d)|&[lg]t;|(?!\\b)(?=[A-Z][a-z])","pipeline":["stopWordFilter"]},"docs":[{"location":"","title":"CloudOps Handbook","text":"<p>Welcome to CloudOps Handbook.</p>"},{"location":"blog/","title":"Blog","text":""},{"location":"cicd/Gitlab-Pipeline/","title":"Gitlab","text":""},{"location":"cicd/Gitlab-Pipeline/#1-gitlab","title":"1 <code>Gitlab</code>\u6dfb\u52a0\u5185\u7f51\u4fe1\u4efb","text":"<p>\u76ee\u7684\uff1a</p> <ol> <li>\u5185\u7f51\u57df\u540d\u6216\u5730\u5740\u9ed8\u8ba4\u88ab\u9650\u5236\u7684\u3002</li> </ol> <p>\u64cd\u4f5c\u8fc7\u7a0b\uff1a</p> <ol> <li> <p>\u8fdb\u5165\u7ba1\u7406\u5458\u9875\u9762\u3002</p> </li> <li> <p>\u8fdb\u5165\u8bbe\u7f6e\u3002</p> </li> <li> <p>\u8fdb\u5165\u7f51\u7edc\u3002</p> </li> <li> <p>\u8fdb\u5165\u51fa\u7ad9\u8bf7\u6c42\u3002</p> </li> <li> <p>\u52fe\u9009\u9009\u9879\uff1a</p> </li> </ol> <p>\u2611\ufe0f\u5141\u8bb8\u6765\u81ea <code>webhooks</code>\u548c\u96c6\u6210\u5bf9\u672c\u5730\u7f51\u7edc\u7684\u8bf7\u6c42</p> <p>\u2611\ufe0f\u5141\u8bb8\u7cfb\u7edf\u94a9\u5b50\u5411\u672c\u5730\u7f51\u7edc\u53d1\u9001\u8bf7\u6c42</p> <ol> <li> <p>\u5728\u7a7a\u767d\u6846\u4e2d\uff0c\u7c98\u8d34\u9700\u8981\u8c03\u7528\u7684\u5185\u7f51IP\u3001\u57df\u540d\u3002</p> </li> <li> <p>\u767b\u5f55<code>Gitlab</code> \u670d\u52a1\u5668\uff0c\u6dfb\u52a0HOSTS \u81ea\u5b9a\u4e49\u57df\u540d\u6620\u5c04\u3002</p> </li> </ol> <pre><code>192.168.1.120 traefik.k8scluster.com\n192.168.1.120 harbor.dockerregistry.com\n192.168.1.120 argocd.k8scluster.com\n192.168.1.120 grpc.argocd.k8scluster.com\n</code></pre>"},{"location":"cicd/Gitlab-Pipeline/#2-gitlab-argocd","title":"2 <code>Gitlab</code>\u96c6\u6210 <code>Argocd</code>","text":"<p>\u76ee\u7684\uff1a</p> <ol> <li>\u65b9\u4fbf\u6d41\u6c34\u7ebf\u4e2d\u9690\u85cf<code>Argocd</code>\u771f\u5b9e\u670d\u52a1\u5668\u4fe1\u606f\u540c\u65f6\u53ef\u4ee5\u64cd\u4f5c\u5e94\u7528\u3002</li> </ol> <p>\u64cd\u4f5c\u8fc7\u7a0b\uff1a</p> <ol> <li> <p>\u8fdb\u5165\u9879\u76ee\u7ec4\u9875\u9762\u3002</p> </li> <li> <p>\u8fdb\u5165\u8bbe\u7f6e\u3002</p> </li> <li> <p>\u8fdb\u5165CICD\u3002</p> </li> <li> <p>\u8fdb\u5165\u53d8\u91cf\u3002</p> </li> <li> <p>\u6dfb\u52a0\u53d8\u91cf\uff1a</p> </li> </ol> Type Key Value Options Environments Variable ARGOCD_USERNAME \u81ea\u5b9a\u4e49 Masked All (default) Variable ARGOCD_SERVER \u81ea\u5b9a\u4e49 Masked All (default) Variable ARGOCD_PASSWORD \u81ea\u5b9a\u4e49 Masked All (default)"},{"location":"cicd/Gitlab-Pipeline/#3-gitlab-minio","title":"3 <code>Gitlab</code>\u96c6\u6210 <code>Minio</code>","text":"<p>\u76ee\u7684\uff1a</p> <ol> <li>\u5c06\u5236\u54c1\u4e0a\u4f20\u5230<code>Minio</code>\u4e2d\uff0c\u51cf\u8f7b<code>Gitlab</code>\u670d\u52a1\u5668\u7ef4\u62a4\u538b\u529b\u3002</li> </ol> <p>\u64cd\u4f5c\u8fc7\u7a0b\uff1a</p> <ol> <li>\u4fee\u6539 <code>Gitlab</code>\u670d\u52a1\u5668\u914d\u7f6e</li> </ol> <pre><code># \u4fee\u6539\u914d\u7f6e\nsudo vim /etc/gitlab/gitlab.rb\ngitlab_rails['artifacts_enabled'] = true\ngitlab_rails['artifacts_object_store_enabled'] = true\ngitlab_rails['artifacts_object_store_remote_directory'] = 'gitlab-artifacts'\ngitlab_rails['artifacts_object_store_connection'] = {\n'provider' =&gt; 'AWS',\n'region' =&gt; 'us-east-1',\n'aws_access_key_id' =&gt; '08JbSVpoWEYc1fc8xFnf',\n'aws_secret_access_key' =&gt; 'JECzRcjqXTa5DVk6ZsdOFWBcfZv32HFYV4arNUD4',\n'endpoint' =&gt; 'http://192.168.1.120:9000',\n'path_style' =&gt; true\n}\n\n# \u91cd\u8f7d\u914d\u7f6e\nsudo gitlab-ctl reconfigure\n</code></pre>"},{"location":"cicd/Gitlab-Pipeline/#4-gitlab-harbor","title":"4 <code>Gitlab</code>\u96c6\u6210 <code>Harbor</code>","text":"<p>\u76ee\u7684\uff1a</p> <ol> <li>\u5c06\u955c\u50cf\u6587\u4ef6\u5236\u4f5c\u5b8c\u6210\u540e\u76f4\u63a5\u63a8\u9001\u5230Harbor \uff0c\u4e0d\u518d\u9700\u8981\u91cd\u590d\u914d\u7f6e\u3002</li> </ol> <p>\u64cd\u4f5c\u8fc7\u7a0b\uff1a</p> <ol> <li> <p>\u8fdb\u5165\u7ba1\u7406\u5458\uff0c\u6216\u8005\u9879\u76ee\u7ec4\u7ba1\u7406\u754c\u9762\u3002</p> </li> <li> <p>\u8fdb\u5165\u8bbe\u7f6e\u3002</p> </li> <li> <p>\u8fdb\u5165\u96c6\u6210\u3002</p> </li> <li> <p>\u6dfb\u52a0Harbor \u96c6\u6210\u3002</p> </li> <li> <p>\u8f93\u5165\uff08\u7528\u6237\u4fe1\u606f\u5efa\u8bae\u4f7f\u7528\u673a\u5668\u4eba\u540d\u79f0\u548c\u5bc6\u7801\uff09\uff1a</p> </li> <li> <p>\u57df\u540d</p> </li> <li>\u9879\u76ee\u540d\u79f0</li> <li>\u7528\u6237</li> <li>\u7528\u6237\u5bc6\u7801</li> </ol>"},{"location":"cicd/Gitlab-Pipeline/#5-gitlab","title":"5 <code>Gitlab</code> \u6587\u4ef6\u5927\u5c0f\u9650\u5236","text":"<p>\u76ee\u7684\uff1a</p> <ol> <li>\u6d41\u6c34\u7ebf\u4efb\u52a1\u4e2d\uff0c\u4e0a\u4f20\u5236\u54c1\u5230 <code>Minio</code> \u6216\u8005\u6682\u5b58<code>Gitlab</code>\u65f6\u9ed8\u8ba4\u88ab\u9650\u5236\u4e3a 100m \u6216\u8005 200m, \u800c\u5b9e\u9645\u8fdc\u5927\u4e8e\u8fd9\u4e9b\uff0c\u9700\u8981\u8c03\u9ad8\u9650\u5236\u4ee5\u6ee1\u8db3\u5b9e\u9645\u9700\u8981\u3002</li> </ol> <p>\u64cd\u4f5c\u8fc7\u7a0b\uff1a</p> <ol> <li>\u8fdb\u5165\u7ba1\u7406\u5458\u6216\u8005\u9879\u76ee\u7ec4\u6216\u8005\u9879\u76ee\u9875\u9762\uff08\u5177\u4f53\u6839\u636e\u81ea\u5df1\u7684\u6743\u9650\u6765\u5b9a\uff09\u3002</li> <li>\u8fdb\u5165\u8bbe\u7f6e\u3002</li> <li>\u8fdb\u5165CICD\u3002</li> <li>\u8fdb\u5165\u6d41\u6c34\u7ebf\u901a\u7528\u8bbe\u7f6e\u3002</li> <li>\u4fee\u6539\u6700\u5927\u5de5\u4ef6\u5927\u5c0f\uff0c\u5177\u4f53\u6309\u81ea\u5df1\u9700\u8981\u4fee\u6539\u3002</li> <li>\u82e5\u4fee\u6539\u4e86\u4e0a\u9762\u914d\u7f6e\u8fd8\u662f\u4e0d\u884c\uff0c\u53ef\u4ee5\u68c0\u67e5\u4e0b <code>Gitlab</code>\u670d\u52a1\u5668\u914d\u7f6e\uff0c\u53ef\u80fd\u9700\u8981\u540c\u6b65\u66f4\u65b0\u4e0b\u3002</li> </ol> <pre><code># \u4fee\u6539\u914d\u7f6e\nsudo vim /etc/gitlab/gitlab.rb\nnginx['client_max_body_size'] = '200m'\n\n# \u91cd\u8f7d\u914d\u7f6e\nsudo gitlab-ctl reconfigure\n</code></pre>"},{"location":"cicd/Gitlab-Pipeline/#6-gitlab-cicd","title":"6 <code>Gitlab</code> \u96c6\u6210 CICD","text":"<p>\u76ee\u7684\uff1a</p> <ol> <li>\u8ba9\u673a\u5668\u4eba\u6709\u6743\u9650\u81ea\u52a8\u66f4\u65b0\u6307\u5b9a\u90e8\u5206\u7684\u4ee3\u7801\u3002</li> </ol> <p>\u64cd\u4f5c\u8fc7\u7a0b\uff1a</p> <ol> <li>\u8fdb\u5165\u9879\u76ee\u9875\u9762\u3002</li> <li>\u8fdb\u5165\u8bbe\u7f6e\u3002</li> <li> <p>\u8fdb\u5165\u8bbf\u95ee\u4ee4\u724c\uff0c\u521b\u5efa\u4e00\u4e2a\u957f\u671f\u6709\u6548\u7684\u5f00\u53d1\u8005\u8eab\u4efd\u7684\u4ee4\u724c\u3002</p> </li> <li> <p>\u8fdb\u5165CICD\u3002</p> </li> <li>\u8fdb\u5165\u53d8\u91cf\uff0c\u521b\u5efa\u4e00\u4e2a\u53d8\u91cf\uff0c\u5177\u4f53\u5982\uff1a</li> </ol> Type Key(Click to sort descending) Value Options Environments Variable GITLAB_CI_TOKEN \u81ea\u5b9a\u4e49 Masked All (default)"},{"location":"cicd/Gitlab-Pipeline/#7-pipelinebackend","title":"7 Pipeline(backend)","text":"<pre><code>image: $HARBOR_HOST/kubernetes/maven:3.8.6-openjdk-8-slim\n# image: maven:3.8.6-openjdk-8-slim\n\nvariables:\n  AUTOMATIC_TRIGGER: \"off\"\n  MAVEN_CLI_OPTS: \"-B -U -s conf/settings.xml\"\n  BUILD_GOAL: \"clean package\"\n  DEPLOY_ONLY: \"false\"\n  DEST_ENVIRONMENT: \"dev\"\n  REPO_URL: http://gitlab-ci-token:${GITLAB_CI_TOKEN}@${CI_SERVER_HOST}/${CI_PROJECT_PATH}.git # Access Tokens &amp; write_repository &amp; CI/CD Variables\n\nstages:\n  - package\n  - build\n  - deploy\n\npackage:\n  stage: package\n  script:\n    - mvn $MAVEN_CLI_OPTS $BUILD_GOAL\n  cache:\n    key: \"${CI_COMMIT_REF_SLUG}\"\n    paths:\n      - .m2/repository\n  artifacts:\n    paths:\n      - target/*.jar\n  tags:\n    - kubernetes\n  rules:\n    - if: $AUTOMATIC_TRIGGER == \"off\"\n      when: manual \n\n    - if: '$DEPLOY_ONLY != \"true\"' \n\nbuild:\n  image:\n    name: $HARBOR_HOST/kubernetes/kaniko-project/executor:v1.14.0-debug\n    # name: gcr.io/kaniko-project/executor:v1.14.0-debug\n    entrypoint: [\"\"]\n  stage: build\n  before_script:\n    - echo \"Logging in to Docker registry $HARBOR_HOST\"\n    - mkdir -p /kaniko/.docker\n    - echo \"{\\\"auths\\\":{\\\"$HARBOR_HOST\\\":{\\\"username\\\":\\\"$HARBOR_USERNAME\\\",\\\"password\\\":\\\"$HARBOR_PASSWORD\\\"}}}\" &gt; /kaniko/.docker/config.json\n  script:\n    - echo \"Building and pushing Docker image\"\n    - &gt;-\n      /kaniko/executor\n      --context \"${CI_PROJECT_DIR}\"\n      --dockerfile \"${CI_PROJECT_DIR}/Dockerfile\"\n      --destination \"$HARBOR_HOST/$HARBOR_PROJECT/$CI_PROJECT_NAME:$CI_COMMIT_SHORT_SHA\"\n      --cache=true\n      --cache-ttl=24h\n      --skip-tls-verify\n      --build-arg HARBOR_HOST=${HARBOR_HOST}\n  needs: [\"package\"]\n  tags:\n    - kubernetes\n  rules:\n    - if: $AUTOMATIC_TRIGGER == \"off\"\n      when: manual\n    - if: '$DEPLOY_ONLY != \"true\"' \n\nupdate_config:\n  image:\n    name: $HARBOR_HOST/kubernetes/argocli-git:v2.7.14\n  stage: deploy\n  script:\n    - echo \"Updating Kustomize configs in Git with the latest commit SHA\"\n    - &gt;-\n      git checkout main &amp;&amp;\n      cd k8s/overlays/$DEST_ENVIRONMENT/ &amp;&amp;\n      sed \"s/\\${CI_COMMIT_SHORT_SHA}/\\\"${CI_COMMIT_SHORT_SHA}\\\"/g\" kustomization.yaml.template &gt; kustomization.yaml &amp;&amp;\n      git add kustomization.yaml &amp;&amp;\n      git commit -m \"Update the image tag to ${CI_COMMIT_SHORT_SHA} [skip ci]\" &amp;&amp;\n      git push $REPO_URL\n  needs: [\"build\"]\n  tags:\n    - kubernetes\n  # rules:\n  #   - if: $AUTOMATIC_TRIGGER == \"off\"\n  #     when: manual\n\nsync_application:\n  image:\n    name: $HARBOR_HOST/kubernetes/argocli-git:v2.7.14\n  stage: deploy\n  script:\n    - echo \"Logging in to ArgoCD\" \n    - &gt;-\n      export APP_NAME=\"$CI_PROJECT_NAME\" &amp;&amp;\n      echo y | argocd login $ARGOCD_SERVER --password \"$ARGOCD_PASSWORD\" --username $ARGOCD_USERNAME\n    - echo \"Syncing application with ArgoCD\"\n    - &gt;- \n      if argocd app list | grep -q $APP_NAME; then\n        echo \"Application $APP_NAME exists. Syncing...\"\n        argocd app sync $APP_NAME --prune\n      else\n        echo \"Application $APP_NAME does not exist. Creating...\"\n        argocd app create $APP_NAME \\\n        --repo $REPO_URL \\\n        --path k8s/overlays/$DEST_ENVIRONMENT \\\n        --dest-server https://kubernetes.default.svc \\\n        --sync-policy automated\n      fi\n  needs: [\"update_config\"]\n  environment:\n    name: $CI_COMMIT_REF_NAME\n    url: https://myargocd.mydomain.com:32271/kubernetes/cluster/namespaces/$NAMESPACE_NAME\n  tags:\n    - kubernetes\n  rules:\n    - if: $AUTOMATIC_TRIGGER == \"off\"\n      when: manual\n</code></pre>"},{"location":"cicd/Gitlab-Pipeline/#8-pipelinefrontend","title":"8 Pipeline(frontend)","text":"<pre><code>image: $HARBOR_HOST/kubernetes/node:16.20.2\n\nvariables:\n  DEPLOY_ONLY: \"false\"\n  DEST_ENVIRONMENT: \"prod\"\n  REPO_URL: http://gitlab-ci-token:${GITLAB_CI_TOKEN}@${CI_SERVER_HOST}/${CI_PROJECT_PATH}.git\n\nstages:\n  - check\n  - package\n  - build\n  - deploy\n\ncheck:\n  stage: check\n  script:\n    - echo \"Checking Node.js version...\"\n    - node --version\n    - echo \"Checking npm version...\"\n    - npm --version\n    - echo \"Checking Yarn version...\"\n    - yarn --version\n  tags:\n    - kubernetes\n  rules:\n    - if: '$DEPLOY_ONLY != \"true\"'\n\npackage:\n  stage: package\n  script:\n    - if grep -q node-sass package.json; then yarn remove node-sass &amp;&amp; yarn add sass; fi\n    - npm install --force --registry=https://registry.npm.taobao.org --loglevel info\n    - npm run build\n  artifacts:\n    paths:\n      - dist/\n  cache:\n    key: \"$CI_COMMIT_REF_NAME\"\n    paths:\n      - node_modules/\n  tags:\n    - kubernetes\n  rules:\n    - if: '$DEPLOY_ONLY != \"true\"'\n\nbuild:\n  image:\n    name: $HARBOR_HOST/kubernetes/kaniko-project/executor:v1.14.0-debug\n    entrypoint: [\"\"]\n  stage: build\n  before_script:\n    - echo \"Logging in to Docker registry $HARBOR_HOST\"\n    - mkdir -p /kaniko/.docker\n    - echo \"{\\\"auths\\\":{\\\"$HARBOR_HOST\\\":{\\\"username\\\":\\\"$HARBOR_USERNAME\\\",\\\"password\\\":\\\"$HARBOR_PASSWORD\\\"}}}\" &gt; /kaniko/.docker/config.json\n  script:\n    - echo \"Building and pushing Docker image\"\n    - &gt;-\n      /kaniko/executor\n      --context \"${CI_PROJECT_DIR}\"\n      --dockerfile \"${CI_PROJECT_DIR}/Dockerfile\"\n      --destination \"$HARBOR_HOST/$HARBOR_PROJECT/$CI_PROJECT_NAME:$CI_COMMIT_SHORT_SHA\"\n      --cache=true\n      --cache-ttl=24h\n      --skip-tls-verify\n      --build-arg HARBOR_HOST=${HARBOR_HOST}\n  needs: [\"package\"]\n  tags:\n    - kubernetes\n  rules:\n    - if: '$DEPLOY_ONLY != \"true\"'\n\nupdate_config:\n  image:\n    name: $HARBOR_HOST/kubernetes/argocli-git:v2.7.14\n  stage: deploy\n  script:\n    - echo \"Updating Kustomize configs in Git with the latest commit SHA\"\n    - &gt;-\n      git checkout main &amp;&amp;\n      cd k8s/overlays/$DEST_ENVIRONMENT/ &amp;&amp;\n      sed \"s/\\${CI_COMMIT_SHORT_SHA}/\\\"${CI_COMMIT_SHORT_SHA}\\\"/g\" kustomization.yaml.template &gt; kustomization.yaml &amp;&amp;\n      git add kustomization.yaml &amp;&amp;\n      git commit -m \"Update the image tag to ${CI_COMMIT_SHORT_SHA} [skip ci]\" &amp;&amp;\n      git push $REPO_URL\n  needs: [\"build\"]\n  tags:\n    - kubernetes\n\nsync_application:\n  image:\n    name: $HARBOR_HOST/kubernetes/argocli-git:v2.7.14\n  stage: deploy\n  script:\n    - echo \"Logging in to ArgoCD\" \n    - &gt;-\n      export APP_NAME=\"$CI_PROJECT_NAME\" &amp;&amp;\n      echo y | argocd login $ARGOCD_SERVER --password $ARGOCD_PASSWORD --username $ARGOCD_USERNAME\n    - echo \"Syncing application with ArgoCD\"\n    - &gt;- \n      if argocd app list | grep -q $APP_NAME; then\n        echo \"Application $APP_NAME exists. Syncing...\"\n        argocd app sync $APP_NAME --prune\n      else\n        echo \"Application $APP_NAME does not exist. Creating...\"\n        argocd app create $APP_NAME \\\n        --repo $REPO_URL \\\n        --path k8s/overlays/$DEST_ENVIRONMENT \\\n        --dest-server https://kubernetes.default.svc \\\n        --sync-policy automated\n      fi\n  needs: [\"update_config\"]\n  environment:\n    name: $CI_COMMIT_REF_NAME\n    url: https://$ARGOCD_SERVER/kubernetes/cluster/namespaces/$NAMESPACE_NAME\n  tags:\n    - kubernetes\n  rules:\n    - if: $AUTOMATIC_TRIGGER == \"off\"\n      when: manual\n</code></pre>"},{"location":"cicd/Gitlab-Pipeline/#9-pipeline-templatebackend","title":"9 Pipeline + template(Backend)","text":"<pre><code>include: '.gitlab-ci-template.yml'\n\nimage: $HARBOR_HOST/kubernetes/maven:3.6.3-openjdk-8-slim\n\nvariables:\n  DEST_ENVIRONMENT: 'dev'\n  HARBOR_PROJECT: 'papd-bom'\n  APP1_NAME: 'cloud-gateway'\n  APP2_NAME: 'cloud-auth'\n  APP3_NAME: 'cloud-system'\n  APP1_NAME_PATH: 'cloud-services/cloud-gateway'\n  APP2_NAME_PATH: 'cloud-services/cloud-auth'\n  APP3_NAME_PATH: 'cloud-services/cloud-system'\n  APP1_JAR_NAME: 'sys-gateway-1.1.0.jar'\n  APP2_JAR_NAME: 'sys-auth-1.1.0.jar'\n  APP3_JAR_NAME: 'sys-system-1.1.0.jar'\n\nstages:\n  - install\n  - package\n  - build\n  - update\n  - deploy\n\n################################################# local installing ################################\nmaven-install:\n  extends: .install_template\n\n\n################################################# local packaging #################################\npackage-cloud-gateway:\n  extends: .package_template\n  variables:\n    MODULE_PATH: $APP1_NAME_PATH\n    ARTIFACT_NAME: $APP1_JAR_NAME\n\npackage-cloud-auth:\n  extends: .package_template\n  variables:\n    MODULE_PATH: $APP2_NAME_PATH\n    ARTIFACT_NAME: $APP2_JAR_NAME\n\npackage-cloud-system:\n  extends: .package_template\n  variables:\n    MODULE_PATH: $APP3_NAME_PATH\n    ARTIFACT_NAME: $APP3_JAR_NAME\n\n################################################# image creation ##############################\nbuild-cloud-gateway:\n  extends: .build_template\n  variables:\n    CI_PROJECT_NAME: $APP1_NAME\n    CONTEXT_PATH: $APP1_NAME_PATH\n  needs: [\"package-cloud-gateway\"]\n\nbuild-cloud-auth:\n  extends: .build_template\n  variables:\n    CI_PROJECT_NAME: $APP2_NAME\n    CONTEXT_PATH: $APP2_NAME_PATH\n  needs: [\"package-cloud-auth\"]\n\nbuild-cloud-system:\n  extends: .build_template\n  variables:\n    CI_PROJECT_NAME: $APP3_NAME\n    CONTEXT_PATH: $APP3_NAME_PATH\n  needs: [\"package-cloud-system\"]\n\n################################################# update label #############################\n\nupdate-label-cloud-gateway:\n  extends: .update_template\n  variables:\n    CONTEXT_PATH: $APP1_NAME_PATH\n  needs: [\"build-cloud-gateway\"]\n\n\nupdate-label-cloud-auth:\n  extends: .update_template\n  variables:\n    CONTEXT_PATH: $APP2_NAME_PATH\n  needs: [\"build-cloud-auth\"]\n\n\nupdate-label-cloud-system:\n  extends: .update_template\n  variables:\n    CONTEXT_PATH: $APP3_NAME_PATH\n  needs: [\"build-cloud-system\"]\n\n################################################# app sync #########################\n\ndeploy-cloud-gateway:\n  extends: .sync_application_template\n  variables:\n    CI_PROJECT_NAME: $APP1_NAME\n    CONTEXT_PATH: $APP1_NAME_PATH\n  needs: [\"update-label-cloud-gateway\"]\n\ndeploy-cloud-auth:\n  extends: .sync_application_template\n  variables:\n    CI_PROJECT_NAME: $APP2_NAME\n    CONTEXT_PATH: $APP2_NAME_PATH\n  needs: [\"update-label-cloud-auth\"]\n\ndeploy-cloud-system:\n  extends: .sync_application_template\n  variables:\n    CI_PROJECT_NAME: $APP3_NAME\n    CONTEXT_PATH: $APP3_NAME_PATH\n  needs: [\"update-label-cloud-system\"]\n</code></pre> <p>.gitlab-ci-template.yml</p> <pre><code>variables:\n  AUTOMATIC_TRIGGER: \"off\"\n  MAVEN_CLI_OPTS: \"-B -U -s $CI_PROJECT_DIR/conf/settings.xml\"\n  INSTALL_GOAL: \"clean install -DskipTests\"\n  BUILD_GOAL: \"clean package -DskipTests\"\n  DEPLOY_ONLY: \"false\"\n  REPO_URL: http://gitlab-ci-token:${GITLAB_CI_TOKEN}@${CI_SERVER_HOST}/${CI_PROJECT_PATH}.git # Access Tokens &amp; write_repository &amp; CI/CD Variables\n\n.install_template: # Define local packaging template\n  stage: install\n  script:\n    - mvn $MAVEN_CLI_OPTS $INSTALL_GOAL\n  cache:\n    key: \"${CI_COMMIT_REF_SLUG}\"\n    paths:\n      - $CI_PROJECT_DIR/.m2/repository\n    #  artifacts:\n    #    expire_in: 1 day\n    #    paths:\n    #      - $CI_PROJECT_DIR/$GATEWAY_PATH/target/sys-gateway-5.1.0.jar\n    #      - $CI_PROJECT_DIR/$AUTH_PATH/target/sys-auth-5.1.0.jar\n    #      - $CI_PROJECT_DIR/$SYSTEM_PATH/target/sys-system-5.1.0.jar\n  tags:\n    - kubernetes\n  rules:\n    - if: $AUTOMATIC_TRIGGER == \"off\"\n      when: manual\n    - if: '$DEPLOY_ONLY != \"true\"'\n\n################################################# local packaging #################################################\n\n.package_template: # Define local packaging template\n  stage: package\n  script:\n    - cd $CI_PROJECT_DIR/${MODULE_PATH}\n    - mvn $MAVEN_CLI_OPTS $BUILD_GOAL\n  cache:\n    key: \"${CI_COMMIT_REF_SLUG}\"\n    paths:\n      - $CI_PROJECT_DIR/.m2/repository\n  artifacts:\n    expire_in: 1 day\n    paths:\n      - $CI_PROJECT_DIR/${MODULE_PATH}/target/${ARTIFACT_NAME}\n  tags:\n    - kubernetes\n  needs: [\"maven-install\"]\n  rules:\n    - if: $AUTOMATIC_TRIGGER == \"off\"\n      when: manual\n#    - if: '$DEPLOY_ONLY != \"true\"'\n\n################################################# image creation #################################################\n\n.build_template: # Define image creation template\n  image:\n    name: $HARBOR_HOST/kubernetes/kaniko-project/executor:v1.14.0-debug\n    entrypoint: [\"\"]\n  stage: build\n  before_script:\n    - echo \"Logging in to Docker registry $HARBOR_HOST\"\n    - mkdir -p /kaniko/.docker\n    - echo \"{\\\"auths\\\":{\\\"$HARBOR_HOST\\\":{\\\"username\\\":\\\"$HARBOR_USERNAME\\\",\\\"password\\\":\\\"$HARBOR_PASSWORD\\\"}}}\" &gt; /kaniko/.docker/config.json\n  script:\n    - echo \"Building and pushing Docker image\"\n    - &gt;-\n      /kaniko/executor\n      --context \"$CI_PROJECT_DIR/${CONTEXT_PATH}\"\n      --dockerfile \"$CI_PROJECT_DIR/${CONTEXT_PATH}/Dockerfile\"\n      --destination \"$HARBOR_HOST/$HARBOR_PROJECT/$DEST_ENVIRONMENT/${CI_PROJECT_NAME}:${CI_COMMIT_SHORT_SHA}\"\n      --cache=true\n      --cache-ttl=24h\n      --skip-tls-verify\n      --build-arg HARBOR_HOST=${HARBOR_HOST}\n  tags:\n    - kubernetes\n  rules:\n    - if: $AUTOMATIC_TRIGGER == \"off\"\n      # when: manual\n#    - if: '$DEPLOY_ONLY != \"true\"'\n\n################################################# update label #################################################\n.update_template: # Define update label template\n  image:\n    name: $HARBOR_HOST/kubernetes/argocli-git:v2.7.14\n  stage: update\n  script:\n    - printenv\n    - echo \"Updating Kustomize configs in Git with the latest commit SHA\"\n    - echo \"The current branch is $CI_COMMIT_REF_NAME\"\n    - echo \"The latest commit is $CI_COMMIT_SHA\"\n    - git fetch origin $CI_COMMIT_REF_NAME\n    - git reset --hard FETCH_HEAD\n    - |\n      cd $CI_PROJECT_DIR/${CONTEXT_PATH}/k8s/overlays/$DEST_ENVIRONMENT/\n      sed \"s/\\${CI_COMMIT_SHORT_SHA}/\\\"${CI_COMMIT_SHORT_SHA}\\\"/g\" kustomization.yaml.template &gt; kustomization.yaml\n      git add kustomization.yaml\n      git commit -m \"Update the image tag to ${CI_COMMIT_SHORT_SHA} [skip ci]\" || echo \"No changes to commit\"\n    - |\n      attempt=0\n      max_attempts=3\n      until git push $REPO_URL HEAD:$CI_COMMIT_REF_NAME; do\n        attempt=$((attempt+1))\n        if [ \"$attempt\" -gt \"$max_attempts\" ]; then\n          echo \"Maximum push attempts reached. No more attempts left.\"\n          exit 1\n        fi\n        echo \"Push attempt $attempt failed. Attempting to pull and resolve conflicts...\"\n        git pull --rebase $REPO_URL $CI_COMMIT_REF_NAME\n        echo \"Retrying push. Attempt $attempt of $max_attempts.\"\n        sleep 5\n      done\n  tags:\n    - kubernetes\n  rules:\n    - if: $AUTOMATIC_TRIGGER == \"off\"\n      # when: manual\n#    - if: '$DEPLOY_ONLY != \"true\"'\n\n################################################# app sync #################################################\n.sync_application_template: # Define app sync templates\n  image:\n    name: $HARBOR_HOST/kubernetes/argocli-git:v2.7.14\n  stage: deploy\n  script:\n    - echo \"Logging in to ArgoCD\"\n    - &gt;-\n      export APP_NAME=\"${CI_PROJECT_NAME}-${HARBOR_PROJECT}-${DEST_ENVIRONMENT}\" &amp;&amp;\n      echo y | argocd login $ARGOCD_SERVER --password \"$ARGOCD_PASSWORD\" --username $ARGOCD_USERNAME\n    - echo \"Syncing application with ArgoCD\"\n    - &gt;-\n      if argocd app list | grep -q $APP_NAME; then\n        echo \"Application $APP_NAME exists. Syncing...\"\n        argocd app sync $APP_NAME --prune\n      else\n        echo \"Application $APP_NAME does not exist. Creating...\"\n        argocd app create $APP_NAME \\\n        --repo $REPO_URL \\\n        --revision $CI_COMMIT_REF_NAME \\\n        --path $CONTEXT_PATH/k8s/overlays/$DEST_ENVIRONMENT \\\n        --dest-server https://kubernetes.default.svc \\\n        --sync-policy automated \\\n        --loglevel debug\n      fi\n  tags:\n    - kubernetes\n  rules:\n    - if: $AUTOMATIC_TRIGGER == \"off\"\n      when: manual\n  environment:\n    name: $DEST_ENVIRONMENT\n    url: https://$ARGOCD_SERVER/kubernetes/cluster/namespaces/$NAMESPACE_NAME\n</code></pre>"},{"location":"cicd/Gitlab-Pipeline/#10-pipeline-templatefrontend","title":"10 Pipeline + template(frontend)","text":"<pre><code>include: '.gitlab-ci-template.yml'\n\nimage: $HARBOR_HOST/kubernetes/nodejs:v4\n\nvariables:\n  DEST_ENVIRONMENT: 'prod'\n  CI_PROJECT_NAME: 'frame-ui'\n  HARBOR_PROJECT: 'papd-bom'\n\nstages:\n  - check\n  - package\n  - build\n  - update\n  - deploy\n\n######################################################### check env #########################################################\ncheck:\n  extends: .check_template\n\n######################################################### packaged  #########################################################\npackage:\n  extends: .package_template\n  script:\n    # Replace node-sass with sass if it exists in package.json\n    - if grep -q node-sass package.json; then pnpm remove node-sass &amp;&amp; pnpm add sass; fi\n    # Use taobao repository\n    - pnpm install --force --registry=https://registry.npmmirror.com/ --loglevel info\n    # Pull subproject\n    - git submodule update --init -- src/projects/system\n    - git submodule update --remote -- src/projects/system\n    # Build the project\n    - pnpm run build:system\n  artifacts:\n    paths:\n      - sys/\n\n######################################################### build images #########################################################\nbuild:\n  extends: .build_template\n\n##################################################### update labels #########################################################\nupdate-label:\n  extends: .update_template\n\n#################################################### deploy app #########################################################\ndeploy-app:\n  extends: .sync_application_template\n</code></pre> <p>.gitlab-ci-template.yml</p> <pre><code>variables:\n  DEPLOY_ONLY: 'false'\n  REPO_URL: http://gitlab-ci-token:${GITLAB_CI_TOKEN}@${CI_SERVER_HOST}/${CI_PROJECT_PATH}.git\n\n# _template\n######################################################### check env #########################################################\n.check_template: # Define template for local environment checks\n  stage: check\n  script:\n    - echo \"Checking Node.js version...\"\n    - node --version\n    - echo \"Checking npm version...\"\n    - npm --version\n    - echo \"Checking Yarn version...\"\n    - yarn --version\n    - echo \"Checking pnpm version...\"\n    - pnpm --version\n  tags:\n    - kubernetes\n  rules:\n    - if: '$DEPLOY_ONLY != \"true\"'\n    # - when: manual\n    #   allow_failure: false\n\n######################################################### packaged #########################################################\n\n.package_template: # Define packaged template\n  stage: package\n  script:\n    # Replace node-sass with sass if it exists in package.json\n    - if grep -q node-sass package.json; then pnpm remove node-sass &amp;&amp; pnpm add sass; fi\n    # Use taobao repository\n    - pnpm install --force --registry=https://registry.npmmirror.com/ --loglevel info\n    # Pull subproject\n    # - pnpm run pullGit system\n    - git submodule update --init -- src/projects/system\n    - git submodule update --remote -- src/projects/system\n    # Build the project\n    - pnpm run build:system\n  artifacts:\n    paths:\n      - sys/\n    expire_in: 1 day\n  cache:\n    key: '$CI_COMMIT_REF_NAME'\n    paths:\n      - node_modules/\n  needs: ['check']\n  tags:\n    - kubernetes\n  rules:\n    - when: manual\n      allow_failure: false\n\n################################################ build images #########################################################\n.build_template: # Define the template for making images\n  image:\n    name: $HARBOR_HOST/kubernetes/kaniko-project/executor:v1.14.0-debug\n    entrypoint: ['']\n  stage: build\n  before_script:\n    - echo \"Logging in to Docker registry $HARBOR_HOST\"\n    - mkdir -p /kaniko/.docker\n    - echo \"{\\\"auths\\\":{\\\"$HARBOR_HOST\\\":{\\\"username\\\":\\\"$HARBOR_USERNAME\\\",\\\"password\\\":\\\"$HARBOR_PASSWORD\\\"}}}\" &gt; /kaniko/.docker/config.json\n  script:\n    - echo \"Building and pushing Docker image\"\n    - &gt;-\n      /kaniko/executor\n      --context \"${CI_PROJECT_DIR}\"\n      --dockerfile \"${CI_PROJECT_DIR}/Dockerfile\"\n      --destination \"$HARBOR_HOST/$HARBOR_PROJECT/$DEST_ENVIRONMENT/$CI_PROJECT_NAME:$CI_COMMIT_SHORT_SHA\"\n      --cache=true\n      --cache-ttl=24h\n      --skip-tls-verify\n      --build-arg HARBOR_HOST=${HARBOR_HOST}\n  needs: ['package']\n  tags:\n    - kubernetes\n  # rules:\n  #   - when: manual\n  #     allow_failure: true\n\n#################################################### update labels #########################################################\n.update_template: # Define template for update tags\n  image:\n    name: $HARBOR_HOST/kubernetes/argocli-git:v2.7.14\n  stage: update\n  script:\n    - echo \"Updating Kustomize configs in Git with the latest commit SHA\"\n    - &gt;-\n      cd k8s/overlays/$DEST_ENVIRONMENT/ &amp;&amp;\n      sed \"s/\\${CI_COMMIT_SHORT_SHA}/\\\"${CI_COMMIT_SHORT_SHA}\\\"/g\" kustomization.yaml.template &gt; kustomization.yaml &amp;&amp;\n      git add kustomization.yaml &amp;&amp;\n      git commit -m \"build: update the image tag to ${CI_COMMIT_SHORT_SHA} [skip ci]\" &amp;&amp;\n      git push $REPO_URL HEAD:$CI_COMMIT_REF_NAME\n  needs: ['build']\n  tags:\n    - kubernetes\n\n######################################################### deploy app #########################################################\n.sync_application_template: # Define app sync template\n  image:\n    name: $HARBOR_HOST/kubernetes/argocli-git:v2.7.14\n  stage: deploy\n  script:\n    - echo \"Logging in to ArgoCD\"\n    - &gt;-\n      export APP_NAME=\"${CI_PROJECT_NAME}-${HARBOR_PROJECT}-${DEST_ENVIRONMENT}\" &amp;&amp;\n      echo y | argocd login $ARGOCD_SERVER --password $ARGOCD_PASSWORD --username $ARGOCD_USERNAME\n    - echo \"Syncing application with ArgoCD\"\n    - echo \"The branch being used is $CI_COMMIT_REF_NAME \"\n    - export ARGOCD_GIT_MODULES_ENABLED=false\n    - &gt;-\n      if argocd app list | grep -q $APP_NAME; then\n        echo \"Application $APP_NAME exists. Syncing...\"\n        argocd app sync $APP_NAME --prune\n      else\n        echo \"Application $APP_NAME does not exist. Creating...\"\n        argocd app create $APP_NAME \\\n        --repo $REPO_URL \\\n        --revision $CI_COMMIT_REF_NAME \\\n        --path k8s/overlays/$DEST_ENVIRONMENT \\\n        --dest-server https://kubernetes.default.svc \\\n        --sync-policy automated \\\n        --loglevel debug \n      fi\n  needs: ['update-label']\n  environment:\n    name: $DEST_ENVIRONMENT\n    url: https://$ARGOCD_SERVER/kubernetes/cluster/namespaces/$NAMESPACE_NAME\n  tags:\n    - kubernetes\n  when: manual\n  allow_failure: false\n</code></pre>"},{"location":"cicd/Jenkins-Pipeline/","title":"Jenkins","text":""},{"location":"cicd/Jenkins-Pipeline/#1","title":"1 \u5e38\u8b58","text":""},{"location":"cicd/Jenkins-Pipeline/#11","title":"1.1 \u7248\u672c\u652f\u6301","text":"<p>https://pkg.origin.jenkins.io/redhat-stable/</p>"},{"location":"cicd/Jenkins-Pipeline/#2","title":"2 \u4f7f\u7528","text":""},{"location":"cicd/Jenkins-Pipeline/#21-1","title":"2.1 \u6307\u5b9a\u7bc0\u9ede-1","text":"<pre><code>pipeline {\n    agent any\n    // agent{\n    //     node {\n    //       label 'slave01'\n    //     }\n    // }\n//     agent {\n//         docker { image 'harbor.dockerregistry.com/kubesphere/builder-nodejs:v3.2.0-1' }\n//     }\n...\n</code></pre>"},{"location":"cicd/Jenkins-Pipeline/#21-2","title":"2.1 \u6307\u5b9a\u7bc0\u9ede-2","text":"<pre><code>node(\"slave01\"){\n  ...\n}\n</code></pre>"},{"location":"cicd/Jenkins-Pipeline/#22","title":"2.2 \u5b9a\u6642\u69cb\u5efa","text":"<p>JAVA \u5b9a\u6642\u8a9e\u6cd5</p> <p>https://www.cnblogs.com/zhongyehai/p/10577168.html</p> <pre><code>## \u8a9e\u6cd5\uff1a\n* * * * *\n# \u7b2c\u4e00\u4e2a* \u8868\u793a\u5206\u949f\uff0c\u53d6\u503c0~59\n# \u7b2c\u4e8c\u4e2a* \u8868\u793a\u5c0f\u65f6\uff0c\u53d6\u503c0~23  \n# \u7b2c\u4e09\u4e2a* \u8868\u793a\u4e00\u4e2a\u6708\u7684\u7b2c\u51e0\u5929\uff0c\u53d6\u503c1~31\n# \u7b2c\u56db\u4e2a* \u8868\u793a\u7b2c\u51e0\u6708\uff0c\u53d6\u503c1~12  \n# \u7b2c\u4e94\u4e2a* \u8868\u793a\u4e00\u5468\u4e2d\u7684\u7b2c\u51e0\u5929\uff0c\u53d6\u503c0~7\uff0c\u5176\u4e2d0\u548c7\u4ee3\u8868\u7684\u90fd\u662f\u5468\u65e5\n\n\n## \u5e38\u7528\n# \u6bcf\u96945\u5206\u949f\u6784\u5efa\u4e00\u6b21\nH/5 * * * *\n# \u6bcf\u4e24\u5c0f\u65f6\u6784\u5efa\u4e00\u6b21\nH H/2 * * *\n# \u6bcf\u5929\u4e2d\u5348\u4e0b\u73ed\u524d\u5b9a\u65f6\u6784\u5efa\u4e00\u6b21\nH 12 * * *\n# \u6bcf\u5929\u4e0b\u5348\u4e0b\u73ed\u524d\u5b9a\u65f6\u6784\u5efa\u4e00\u6b21\nH 18 * * *\n# \u6bcf30\u5206\u949f\u6784\u5efa\u4e00\u6b21\nH/30 * * * *\n# \u6bcf2\u4e2a\u5c0f\u65f6\u6784\u5efa\u4e00\u6b21\nH H/2 * * *\n# \u6bcf\u5929\u65e9\u4e0a8\u70b9\u6784\u5efa\u4e00\u6b21\nH 8 * * *\n# \u6bcf\u5929\u76848\u70b9\uff0c12\u70b9\uff0c22\u70b9\uff0c\u4e00\u5929\u6784\u5efa3\u6b21\nH 8,12,22 * * *\n</code></pre>"},{"location":"cicd/Jenkins-Pipeline/#23-k8s","title":"2.3 \u6307\u5b9ak8s \u74b0\u5883","text":"<pre><code>stage('Deploy') {\n        echo \"5. Deploy Stage\"\n        def userInput = input(\n            id: 'userInput',\n            message: 'Choose a deploy environment',\n            parameters: [\n                [\n                    $class: 'ChoiceParameterDefinition',\n                    choices: \"Dev\\nQA\\nProd\",\n                    name: 'Env'\n                ]\n            ]\n        )\n        echo \"This is a deploy step to ${userInput}\"\n        sh \"sed -i 's/&lt;BUILD_TAG&gt;/${build_tag}/' k8s.yaml\"\n        if (userInput == \"Dev\") {\n            // deploy dev stuff\n        } else if (userInput == \"QA\"){\n            // deploy qa stuff\n        } else {\n            // deploy prod stuff\n        }\n        sh \"kubectl apply -f k8s.yaml\"\n    }\n</code></pre>"},{"location":"cicd/Jenkins-Pipeline/#24-git","title":"2.4 Git \u5b50\u6a21\u584a\u8a8d\u8b49","text":"<p>https://segmentfault.com/a/1190000005018530</p>"},{"location":"cicd/Jenkins-Pipeline/#25-git-push","title":"2.5 git push \u89f8\u767c\u69cb\u5efa","text":"<p>https://blog.csdn.net/qq_31519989/article/details/108143299</p>"},{"location":"cicd/Jenkins-Pipeline/#26","title":"2.6 \u4ee3\u78bc\u6383\u63cf","text":"<pre><code>   stage('\u4ee3\u7801\u626b\u63cf') {\n       sh \"mvn -f portal-biz/${project_name} -Dsonar.projectKey=${project_name} -Dsonar.sources=./src/ sonar:sonar -Dsonar.host.url=http://10.0.1.185:8000 -Dsonar.login=45f767ffa483beeb1bda9f7f177f7e07702bea2e\"\n       sh \"echo \u4ee3\u7801\u626b\u63cf\u7ed3\u675f\"\n   }\n</code></pre>"},{"location":"cicd/Jenkins-Pipeline/#27","title":"2.7 \u901a\u904e\u811a\u672c\u6279\u91cf\u62f7\u8c9d\u5de5\u7a0b","text":"<p><code>Script Console</code></p> <pre><code>// \u62f7\u8d1d\u4ee5\u201cA-\u57fa\u7840\u8fd0\u7ef4\u201d\u89c6\u56fe\u4e2d\u7684\u201cblade\u201d\u5f00\u5934\u7684\u6d41\u6c34\u7ebf\u5230\u65b0\u89c6\u56fe\u7684\u201cF-\u57fa\u7840\u4fe1\u606f\u5e73\u53f0\u6d4b\u8bd5\u73af\u5883\u201d\u4e2d\uff0c\u7136\u540e\u91cd\u547d\u540d\u4e3a\u4ee5\u201ctest-blade\u201d\u5f00\u5934\u7684\u89c6\u56fe\nimport hudson.model.*\n        //\u6e90view\n        def str_view = \"A-\u57fa\u7840\u8fd0\u7ef4\"\n        //\u76ee\u6807view\n        def str_new_view = \"F-\u57fa\u7840\u4fe1\u606f\u5e73\u53f0\u6d4b\u8bd5\u73af\u5883\"\n        //\u6e90job\u540d\u79f0(\u6a21\u7cca\u5339\u914d)\n        def str_search = \"blade\"\n        //\u76ee\u6807job\u540d\u79f0(\u6a21\u7cca\u5339\u914d\u540e\u66ff\u6362)\n        def str_replace = \"test-blade\"\n        def view = Hudson.instance.getView(str_view)\n        //copy all projects of a view\n        for(item in view.getItems())\n        {\n          //create the new project name\n          newName = item.getName().replace(str_search, str_replace)\n          // copy the job, disable and save it\n          def job\n          try {\n                //\u56e0\u4e3a\u7b2c\u4e00\u6b21\u5bfc\u5165\u540e\u62a5\u9519\uff0c\u6240\u4ee5\u6dfb\u52a0\u4e86try-catch \u8df3\u8fc7\u5df2\u5b58\u5728\u7684job\n                job = Hudson.instance.copy(item, newName)\n          } catch(IllegalArgumentException e) {\n             println(e.toString())\n             println(\"$newName job is exists\")\n             continue\n          } catch(Exception e) {\n            println(e.toString())\n            continue\n          }\n      //\u662f\u5426\u7981\u7528\u4efb\u52a1\uff0cfalse\u4e0d\u7981\u7528\uff0ctrue\u7981\u7528\n          job.disabled = false\n          job.save() \n          Hudson.instance.getView(str_new_view).add(job)\n          println(\" $item.name copied as $newName\")\n        }\n</code></pre>"},{"location":"cicd/Jenkins-Pipeline/#28","title":"2.8 \u5408\u5e76\u5206\u652f","text":"<pre><code>node {\n\n   stage('\u5408\u5e76\u5206\u652f') {\n       sshagent (credentials: ['cicd']) {\n         sh \"\"\"\n           git clone ${git_URL}\n           cd gd-portal-agg \n           git checkout ${branch}\n           git pull \n           git config --global merge.ours.driver true\n           echo 'LauncherConstant.java  merge=ours' &gt;&gt; .gitattributes\n           echo 'Dockerfile  merge=ours' &gt;&gt; .gitattributes\n           echo 'pom.xml merge=ours' &gt;&gt; .gitattributes\n           git add .gitattributes\n           git commit -m '\u5408\u5e76\u65f6\u5ffd\u7565'\n           git push\n           git merge origin/${branch_target}\n           git push\n         \"\"\"\n       }\n   }\n</code></pre>"},{"location":"cicd/Jenkins-Pipeline/#29","title":"2.9 \u4f7f\u7528\u6d41\u6c34\u7dab","text":"<p>\u65b0\u5efa\u8996\u5716-&gt;\u5217\u8868\u8996\u5716-&gt;\u65b0\u5efa\u5de5\u7a0b-&gt;\u6d41\u6c34\u7dab</p>"},{"location":"cicd/Jenkins-Pipeline/#210","title":"2.10 \u89f8\u767c\u69cb\u5efa\u74b0\u5883\u642d\u5efa","text":"<p>\u63d2\u4ef6\u5217\u8868\uff1a</p> <p>Git plugin GitLab Plugin Gitlab Hook Plugin Build Authorization Token Root Plugin</p> <p>\u5173\u95ed\u8de8\u7ad9\u8bf7\u6c42\u4f2a\u9020\u4fdd\u62a4\uff08CSRF\uff09</p> <pre><code>vim /etc/sysconfig/jenkins\nJENKINS_JAVA_OPTIONS=\"-server -Xms512m -Xmx1024m -XX:PermSize=256M -XX:MaxPermSize=512m -Djava.awt.headless=true -Dhudson.security.csrf.GlobalCrumbIssuerConfiguration.DISABLE_CSRF_PROTECTION=true\"\n</code></pre> <p>\u521b\u5efatoken,\u7d66\u5de5\u7a0b\u505a\u89f8\u767c\u4f7f\u7528</p> <p></p> <p>\u521b\u5efa\u51ed\u8bc1\uff0c\u7d66Jenkins\u93c8\u63a5GITLAB</p> <p></p> <p>\u4fee\u6539\u7cfb\u7edf\u914d\u7f6e,\u6dfb\u52a0Gitlab\u914d\u7f6e\u4fe1\u606f\uff0c\u6dfb\u52a0\u4e0a\u9762\u7684\u6191\u8b49</p> <p></p> <p>\u7372\u53d6Jenkins\u7684webhook\u5730\u5740\uff0c\u914d\u7f6e\u5230GITLAB</p> <p></p> <p>\u5c07Jenkins \u670d\u52d9\u5668\u7684\u516c\u9470\u6dfb\u52a0\u5230GITLAB\u7684\u9805\u76ee\u6216\u7528\u6236\u914d\u7f6e\u7684SSH KEYS  \u4e2d</p> <p>\u5728Gitlab\u9805\u76ee\u4e2d\u6dfb\u52a0webhook</p> <p></p>"},{"location":"cicd/Jenkins-Pipeline/#211","title":"2.11 \u6b0a\u9650\u4e0b\u653e","text":"<ol> <li>\u5b89\u88dd\u6240\u9700\u63d2\u4ef6\uff1a<code>role-strategy</code></li> <li>\u4fee\u6539\u5168\u5c40\u5b89\u5168\u914d\u7f6e\u2192\u6388\u6b0a\u7b56\u7565\uff1a<code>Role-Based Strategy</code></li> <li>\u65b0\u5efa\u7528\u6237, \u4f9d\u636e\u9700\u8981\u65b0\u5efa\u5373\u53ef</li> </ol>"},{"location":"cicd/Jenkins-Pipeline/#3","title":"3 \u7dad\u8b77\u64cd\u4f5c","text":""},{"location":"cicd/Jenkins-Pipeline/#31-java","title":"3.1 Java \u74b0\u5883","text":"<pre><code>Failed to start LSB: Jenkins Automation Server. jenkins\n</code></pre> <pre><code>vi /etc/rc.d/init.d/jenkins\n\n...\ncandidates=\"\n/etc/alternatives/java\n/usr/lib/jvm/java-1.8.0/bin/java\n/usr/lib/jvm/jre-1.8.0/bin/java\n/usr/lib/jvm/java-1.7.0/bin/java\n/usr/lib/jvm/jre-1.7.0/bin/java\n/usr/lib/jvm/java-11.0/bin/java\n/usr/lib/jvm/jre-11.0/bin/java\n/usr/lib/jvm/java-11-openjdk-amd64\n/usr/bin/java\n#/alldev/jdk1.8.0_261/bin/java  \u6ce8\u91ca\u8fd9\u91cc\n</code></pre>"},{"location":"cicd/Jenkins-Pipeline/#32","title":"3.2 \u66f4\u63db\u6e90","text":"<p>\u63d2\u4ef6\u7ba1\u7406</p> <pre><code># \u66ff\u6362\u65e7\u914d\u7f6e\n# https://updates.jenkins.io/update-center.json \nhttps://mirrors.tuna.tsinghua.edu.cn/jenkins/updates/update-center.json\n</code></pre>"},{"location":"cicd/Jenkins-Pipeline/#33","title":"3.3 \u5fd8\u8a18\u5bc6\u78bc","text":"<p>https://jenkins-zh.cn/tutorial/management/auth/lost-password/</p> <p>\u627e\u56de\u5bc6\u7801</p> <p>\u5982\u679c\u5fd8\u8bb0\u4e86 Jenkins \u7684\u7ba1\u7406\u5458\u5bc6\u7801\u7684\u8bdd\uff0c\u4e5f\u4e0d\u7528\u62c5\u5fc3\uff0c\u53ea\u8981\u4f60\u6709\u6743\u9650\u8bbf\u95ee Jenkins \u7684\u6839\u76ee\u5f55\uff0c\u5c31\u53ef\u4ee5\u8f7b\u677e\u5730\u91cd\u7f6e\u5bc6\u7801\u3002</p> <p>\u901a\u5e38\u60c5\u51b5</p> <p>Jenkins \u7684\u6839\u76ee\u5f55\uff0c\u9ed8\u8ba4\u662f\u5728\u5f53\u524d\u7528\u6237\uff08\u542f\u52a8 Jenkins \u7684\u64cd\u4f5c\u7cfb\u7edf\u7528\u6237\uff09\u76ee\u5f55\u7684 <code>.jenkins</code> \u4e2d\u3002\u5bf9\u4e8e unix \u7cfb\u7edf\u800c\u8a00\uff0c\u4e5f\u5c31\u662f <code>~/.jenkins</code>\u3002 \u6211\u4eec\u6253\u5f00\u914d\u7f6e\u6587\u4ef6 <code>vim ~/.jenkins/config.xml</code> \u540e\uff0c\u628a\u5b57\u6bb5 <code>useSecurity</code> \u7684\u503c\u8bbe\u7f6e\u4e3a <code>false</code>\uff0c\u7136\u540e\u91cd\u65b0\u542f\u52a8 Jenkins\u3002\u4f60\u5c31\u4f1a\u53d1\u73b0\u4e0d\u9700\u8981\u767b\u9646\u4e5f\u80fd\u8fdb\u5165\u7ba1\u7406\u9875\u9762\u3002 \u8fdb\u5165\u9875\u9762**\u7cfb\u7edf\u7ba1\u7406-&gt;\u5168\u5c40\u5b89\u5168\u914d\u7f6e**\u4e2d\uff0c\u9009\u62e9**\u542f\u7528\u5b89\u5168**\uff0c\u7136\u540e\u5728**\u6388\u6743\u7b56\u7565**\u4e2d\u52fe\u9009**\u4efb\u4f55\u7528\u6237\u53ef\u4ee5\u505a\u4efb\u4f55\u4e8b(\u6ca1\u6709\u4efb\u4f55\u9650\u5236)**\u3002\u4fdd\u5b58\u540e\uff0c\u627e\u5230\u4f60\u5e0c\u671b\u91cd\u7f6e\u5bc6\u7801\u7684\u7528\u6237\uff0c\u8f93\u5165\u65b0\u7684\u5bc6\u7801\u5373\u53ef\u3002</p> <p>\u5176\u4ed6\u60c5\u6cc1</p> <p>\u5982\u679c Jenkins \u7684\u6839\u76ee\u5f55\u5728\u5f53\u524d\u7528\u6237\u76ee\u5f55\u4e0b\u8bdd\uff0c\u53ef\u4ee5\u901a\u8fc7\u67e5\u627e\u5bf9\u5e94\u8fdb\u7a0b\u7684\u65b9\u5f0f\u6765\u786e\u8ba4\uff0c\u4e0b\u9762\u4ee5 Linux \u7cfb\u7edf\u4e3a\u4f8b\u8bf4\u660e\uff1a <pre><code>$ ps -ef | grep jenkins\nroot     26386 26359  0 Jul23 pts/0    00:24:04 java -Duser.home=/var/jenkins_home -Djenkins.model.Jenkins.slaveAgentPort=50000 -jar /usr/share/jenkins/jenkins.war\n\n# \u5206\u6790\u4e0a\u9762\u7684\u8f93\u51fa\uff0c\u53ef\u4ee5\u5f97\u51fa\uff0c\u8be5 Jenkins \u7684\u6839\u76ee\u5f55\u4e3a\uff1a`/var/jenkins_home`\n</code></pre></p> <p><code>JENKINS_HOME</code></p> <p>\u5982\u679c\u4f60\u7684\u73af\u5883\u53d8\u91cf\u91cc\u8bbe\u7f6e\u4e86 <code>JENKINS_HOME</code> \u7684\u8bdd\uff0c\u90a3\u4e48\uff0c Jenkins \u7684\u6839\u76ee\u5f55\u5c31\u53ef\u80fd\u662f <code>JENKINS_HOME</code> \u6307\u5411\u7684\u76ee\u5f55\u3002</p>"},{"location":"cicd/Jenkins-Pipeline/#34","title":"3.4 \u901a\u904e\u63d2\u4ef6\u5099\u4efd\u5de5\u7a0b","text":"<p>http://www.mydlq.club/article/60/http://www.mydlq.club/article/60/</p> <p><code>ThinBackup</code></p> <p></p>"},{"location":"cicd/Jenkins-Pipeline/#35","title":"3.5 \u670d\u52d9\u7ba1\u7406","text":"<pre><code># \u4e3b\u914d\u7f6e\u6587\u4ef6\n/etc/sysconfig/jenkins\n\n# \u7cfb\u7edf\u81ea\u542f\u52a8\u670d\u52a1\n/etc/rc.d/init.d/jenkins\n\n# \u65e5\u5fd7/war\u8def\u5f84 \u914d\u7f6e\n/etc/init.d/jenkins\nPARAMS=\"--logfile=/data/jenkins/var/log/jenkins/jenkins.log --webroot=/data/jenkins/var/cache/jenkins/war --daemon\"\n\n# \u4fee\u6539\u914d\u7f6e\n# \u505c\u670d,\u8f6c\u79fb\u6570\u636e,\u91cd\u542f\u670d\u52a1\nsystemctl stop jenkins\nrsync -av /var/cache/jenkins/war/* /data/jenkins/var/cache/jenkins/war/\nrsync -av /var/log/jenkins/jenkins.log  /data/jenkins/var/log/jenkins/\nsystemctl daemon-reload\nsystemctl start jenkins\n\n# \u5f00\u673a\u81ea\u542f\u52a8\n/sbin/chkconfig jenkins on\n</code></pre>"},{"location":"cicd/Jenkins-Pipeline/#36","title":"3.6 \u5728\u670d\u52d9\u5668\u96e2\u7dab\u5099\u4efd\u5de5\u7a0b\u6587\u4ef6","text":"<p>\u8fd9\u79cd\u65b9\u6cd5\u9002\u5408\u8de8Jenkins\u590d\u5236\uff0cJenkins\u7684job\u90fd\u5728$JENKINS_HOME/jobs\u76ee\u5f55\uff08\u4e00\u822c\u662f/var/lib/jenkins/jobs\uff09\u4e0b\uff0c\u6bcf\u4e2ajob\u4e00\u4e2a\u76ee\u5f55</p> <pre><code># \u590d\u5236\u5168\u90e8job\ncd /var/lib/jenkins\n# \u5728\u6e90Jenkins\u4e0a\u538b\u7f29jobs\u76ee\u5f55\ntar -czvf jobs.tar.gz jobs\n# \u5728\u76ee\u6807Jenkins\u4e0a\u89e3\u538bjobs\u76ee\u5f55\ntar -zxvf jobs.tar.gz\n\n# \u590d\u5236\u67d0\u4e2ajob\ncd /var/lib/jenkins/jobs\n# \u5728\u6e90Jenkins\u4e0a\u538b\u7f29\u6307\u5b9a\u7684job\u76ee\u5f55\ntar -czvf myjob.tar.gz myjob\n# \u5728\u76ee\u6807Jenkins\u4e0a\u89e3\u538b\u6307\u5b9a\u7684job\u76ee\u5f55\ntar -zxvf myjob.tar.gz\n\n## \u5728\u76ee\u6807Jenkins\u4e0a\uff0c\u6253\u5f00Manage Jenkins\uff0c\u9009\u62e9Reload Configuration from Disk,\u4e0d\u9700\u8981\u91cd\u542f\u76ee\u6807Jenkins\u3002\n</code></pre>"},{"location":"cicd/Jenkins-Pipeline/#37","title":"3.7 \u914d\u7f6e\u512a\u5316","text":"<p>\u5185\u5b58\u9650\u5236</p> <p>\u8fd9\u91cc\u7684\u51e0\u4e2a JVM \u53c2\u6570\u542b\u4e49\u5982\u4e0b\uff1a - -Xms: \u4f7f\u7528\u7684\u6700\u5c0f\u5806\u5185\u5b58\u5927\u5c0f - -Xmx: \u4f7f\u7528\u7684\u6700\u5927\u5806\u5185\u5b58\u5927\u5c0f - -XX:PermSize: \u5185\u5b58\u7684\u6c38\u4e45\u4fdd\u5b58\u533a\u57df\u5927\u5c0f - -XX:MaxPermSize: \u6700\u5927\u5185\u5b58\u7684\u6c38\u4e45\u4fdd\u5b58\u533a\u57df\u5927\u5c0f</p> <p>\u8fd9\u51e0\u4e2a\u53c2\u6570\u4e5f\u4e0d\u662f\u914d\u7f6e\u8d8a\u5927\u8d8a\u597d\uff0c\u5177\u4f53\u8981\u6839\u636e\u6240\u5728\u673a\u5668\u5b9e\u9645\u5185\u5b58\u548c\u4f7f\u7528\u5927\u5c0f\u914d\u7f6e\u3002</p> <pre><code>$ vim /etc/sysconfig/jenkins\nJENKINS_JAVA_OPTIONS=\"-server -Xms512m -Xmx1024m -XX:PermSize=256M -XX:MaxPermSize=512m -Djava.awt.headless=true\"\n\nsystemctl restart jenkins.service\n</code></pre> <p>\u9ad8\u7248\u672cJenkins\u5173\u95ed\u8de8\u7ad9\u8bf7\u6c42\u4f2a\u9020\u4fdd\u62a4\uff08CSRF\uff09</p> <pre><code>$ vim /etc/sysconfig/jenkins\nJENKINS_JAVA_OPTIONS=\"-server -Xms512m -Xmx1024m -XX:PermSize=256M -XX:MaxPermSize=512m -Djava.awt.headless=true -Dhudson.security.csrf.GlobalCrumbIssuerConfiguration.DISABLE_CSRF_PROTECTION=true\"\n</code></pre>"},{"location":"cicd/Jenkins-Pipeline/#38","title":"3.8 \u6578\u64da\u9077\u79fb","text":"<p>https://zhuanlan.zhihu.com/p/164827268</p> <pre><code>### 1\u3001\u627e\u5230\u4e3b\u76ee\u5f55\n/var/lib/jenkins ## \u9ed8\u8a8d\u662f\u9019\u500b\n\n### 2\u3001\u8fc1\u79fb\u5173\u952e\u7684\u56db\u4e2a\u6587\u4ef6\u6216\u6587\u4ef6\u5939\nconfig.xml\u6587\u4ef6\u3001jobs\u6587\u4ef6\u5939\u3001users\u6587\u4ef6\u5939\u548cplugins\n\njobs       //\u5b58\u653e\u7684job\u4fe1\u606f\nconfig.xml //\u6743\u9650\uff0c\u5206\u7ec4\uff0c\u9879\u76ee\uff0c\u7ed3\u6784\u7b49\u914d\u7f6e\u4fe1\u606f\nplugins    //\u63d2\u4ef6\u6587\u4ef6\nusers      //\u7528\u6237\u6587\u4ef6\n\n\n## 3 \u6578\u64da\u5099\u4efd\nlsblk\ndf -Th /data/\ncd /data/\nmkdir -p jenkins jenkins.old\ncd jenkins.old\n# \u5173\u952e\u6570\u636e\u5168\u91cf\u5907\u4efd\ntar  -czvf jenkins-old.data-`date +%Y%m%d`.tar.gz  /var/lib/jenkins/users  /var/lib/jenkins/jobs /var/lib/jenkins/plugins /var/lib/jenkins/config.xml\n# \u6570\u636e\u76ee\u5f55\u5168\u91cf\u5907\u4efd\ntar  -czvf jenkins-old.`date +%Y%m%d`.tar.gz /var/lib/jenkins\n\n## 4 \u4fee\u6539\u914d\u7f6e\nll /data/jenkins\nvi +10 /etc/sysconfig/jenkins\n# \u6539\u6210\u65b0\u8def\u5f84\nJENKINS_HOME=\"/data/jenkins\"\n# \u6539\u6210root,\u4e4b\u524d\u662fJenkins\nJENKINS_USER=\"root\"\n\n## 5 \u6578\u64da\u9077\u79fb\uff0c\u76ee\u9304\u6b0a\u9650\u4fee\u6539\nmv var/lib/jenkins/* /data/jenkins/\nsystemctl restart jenkins\nsystemctl status jenkins.service\n\nll /data/jenkins\nrm /data/jenkins/jenkins-old.data-20201127.tar.gz -f\nvi  /etc/sysconfig/jenkins\n# \u8fd9\u4e2a\u53ef\u4ee5\u7ed9\u7528\u6237\u6539\u56de\u53bb\uff0c\u8fd8\u4f7f\u7528jenkins\nJENKINS_USER=\"jenkins\"\nchown -R   jenkins.jenkins /data/jenkins/\nchown -R   jenkins.jenkins /var/log/jenkins/\nchown -R   jenkins.jenkins /var/cache/jenkins/\nchown -R   jenkins.jenkins /usr/lib/jenkins/jenkins.war\nchown -R   jenkins.jenkins /etc/sysconfig/jenkins\n\n# \u53ef\u80fd\u5b58\u5728\u4e1f\u6578\u64da\u7684\u60c5\u6cc1\n##### 1\u3001gitlab\u7684\u4ee3\u7801\u62c9\u53d6\u7684\u5bc6\u94a5\u5f97\u91cd\u505a\n##### 2\u3001ssh \u5230\u8fdc\u7a0b\u4e3b\u673a\u7684\u79c1\u94a5\u53ca\u5176\u4ed6\u914d\u7f6e\u5f97\u91cd\u65b0\u914d\u7f6e\n</code></pre>"},{"location":"cicd/Jenkins-Pipeline/#39","title":"3.9 \u5b50\u7bc0\u9ede\u914d\u7f6e","text":"<p>https://blog.csdn.net/lusyoe/article/details/54880836</p> <p></p> <p></p>"},{"location":"cicd/Jenkins-Pipeline/#310","title":"3.10 \u6dfb\u52a0\u9060\u7a0b\u4e3b\u6a5f","text":"<p>\u514d\u5bc6\u767b\u5f55</p> <p>\u7b2c\u4e00\u6b65\uff0cjenkins\u673a\u5668\u7684\u79c1\u94a5\u653e\u5230KEY\u91cc\u53bb</p> <p></p> <p>\u7b2c\u4e8c\u6b65\uff0c\u5c06jenkins\u673a\u5668\u7684\u516c\u94a5\u5206\u522b\u4f20\u7ed9\u8981\u8fdc\u7a0b\u8fde\u63a5\u7684\u673a\u5668</p> <pre><code>ssh-copy-id HOST-NAME\n</code></pre> <p>\u6e2c\u8a66</p> <p></p>"},{"location":"cicd/Jenkins-Pipeline/#311","title":"3.11 \u6e05\u7406\u7f13\u5b58","text":"<pre><code>node {\n    // This step utilizes the Workspace Cleanup Plugin: https://wiki.jenkins.io/display/JENKINS/Workspace+Cleanup+Plugin\n    step([$class: 'WsCleanup'])  \n}\n</code></pre>"},{"location":"cicd/Jenkins-Pipeline/#4","title":"4 \u90e8\u7f72","text":""},{"location":"cicd/Jenkins-Pipeline/#41-yum","title":"4.1 yum \u65b9\u5f0f","text":"<pre><code>#!/bin/bash\n\n\n# 1.\u4fee\u6539\u955c\u50cf\u6e90\ncd /etc/yum.repos.d &amp;&amp; \\\nrm * -rf  &amp;&amp; \\\ncat &gt;epel-7.repo&lt;&lt;EOF\n[epel]\nname=Extra Packages for Enterprise Linux 7 - $basearch\nbaseurl=http://mirrors.aliyun.com/epel/7/$basearch\nfailovermethod=priority\nenabled=1\ngpgcheck=0\ngpgkey=file:///etc/pki/rpm-gpg/RPM-GPG-KEY-EPEL-7\n\n[epel-debuginfo]\nname=Extra Packages for Enterprise Linux 7 - $basearch - Debug\nbaseurl=http://mirrors.aliyun.com/epel/7/$basearch/debug\nfailovermethod=priority\nenabled=0\ngpgkey=file:///etc/pki/rpm-gpg/RPM-GPG-KEY-EPEL-7\ngpgcheck=0\n\n[epel-source]\nname=Extra Packages for Enterprise Linux 7 - $basearch - Source\nbaseurl=http://mirrors.aliyun.com/epel/7/SRPMS\nfailovermethod=priority\nenabled=0\ngpgkey=file:///etc/pki/rpm-gpg/RPM-GPG-KEY-EPEL-7\ngpgcheck=0\nEOF \n\ncat &gt;Centos-7.repo&lt;&lt;EOF\n# CentOS-Base.repo\n#\n# The mirror system uses the connecting IP address of the client and the\n# update status of each mirror to pick mirrors that are updated to and\n# geographically close to the client.  You should use this for CentOS updates\n# unless you are manually picking other mirrors.\n#\n# If the mirrorlist= does not work for you, as a fall back you can try the\n# remarked out baseurl= line instead.\n#\n#\n\n[base]\nname=CentOS-$releasever - Base - mirrors.aliyun.com\nfailovermethod=priority\nbaseurl=http://mirrors.aliyun.com/centos/$releasever/os/$basearch/\n        http://mirrors.aliyuncs.com/centos/$releasever/os/$basearch/\n        http://mirrors.cloud.aliyuncs.com/centos/$releasever/os/$basearch/\ngpgcheck=1\ngpgkey=http://mirrors.aliyun.com/centos/RPM-GPG-KEY-CentOS-7\n\n#released updates\n[updates]\nname=CentOS-$releasever - Updates - mirrors.aliyun.com\nfailovermethod=priority\nbaseurl=http://mirrors.aliyun.com/centos/$releasever/updates/$basearch/\n        http://mirrors.aliyuncs.com/centos/$releasever/updates/$basearch/\n        http://mirrors.cloud.aliyuncs.com/centos/$releasever/updates/$basearch/\ngpgcheck=1\ngpgkey=http://mirrors.aliyun.com/centos/RPM-GPG-KEY-CentOS-7\n\n#additional packages that may be useful\n[extras]\nname=CentOS-$releasever - Extras - mirrors.aliyun.com\nfailovermethod=priority\nbaseurl=http://mirrors.aliyun.com/centos/$releasever/extras/$basearch/\n        http://mirrors.aliyuncs.com/centos/$releasever/extras/$basearch/\n        http://mirrors.cloud.aliyuncs.com/centos/$releasever/extras/$basearch/\ngpgcheck=1\ngpgkey=http://mirrors.aliyun.com/centos/RPM-GPG-KEY-CentOS-7\n\n#additional packages that extend functionality of existing packages\n[centosplus]\nname=CentOS-$releasever - Plus - mirrors.aliyun.com\nfailovermethod=priority\nbaseurl=http://mirrors.aliyun.com/centos/$releasever/centosplus/$basearch/\n        http://mirrors.aliyuncs.com/centos/$releasever/centosplus/$basearch/\n        http://mirrors.cloud.aliyuncs.com/centos/$releasever/centosplus/$basearch/\ngpgcheck=1\nenabled=0\ngpgkey=http://mirrors.aliyun.com/centos/RPM-GPG-KEY-CentOS-7\n\n#contrib - packages by Centos Users\n[contrib]\nname=CentOS-$releasever - Contrib - mirrors.aliyun.com\nfailovermethod=priority\nbaseurl=http://mirrors.aliyun.com/centos/$releasever/contrib/$basearch/\n        http://mirrors.aliyuncs.com/centos/$releasever/contrib/$basearch/\n        http://mirrors.cloud.aliyuncs.com/centos/$releasever/contrib/$basearch/\ngpgcheck=1\nenabled=0\ngpgkey=http://mirrors.aliyun.com/centos/RPM-GPG-KEY-CentOS-7\nEOF \n\n# 2.\u5b89\u88c5\u57fa\u672c\u5de5\u5177\u5305\nmkdir -p /root/software/ &amp;&amp; \\\nyum -y install git vim telnet net-tools patch tree wget curl lrzsz &amp;&amp; \\\n\n\n# 3.\u5b89\u88c5java\u73af\u5883\nyum -y install java-1.8.0-openjdk &amp;&amp; \\\n\n# 4.\u914d\u7f6ejenkins\u955c\u50cf\u6e90\ncd /etc/yum.repos.d  &amp;&amp; \\\ncat &gt;jenkins.repo&lt;&lt;EOF\n[jenkins]\nname=Jenkins\nbaseurl=http://pkg.jenkins.io/redhat\ngpgcheck=1\nEOF\n\n# 5.\u5b89\u88c5jenkins\n# \u63d0\u524d\u4e0b\u8f7d\u5e76\u4e0a\u4f20\u81f3/root/software\nyum -y install jenkins-2.93-1.1.noarch.rpm &amp;&amp; \\\n\n# 6.\u4fee\u6539jenkins\u7684\u542f\u52a8\u7528\u6237\nsed -i '29s/JENKINS_USER=\"jenkins\"/JENKINS_USER=\"root\"/' /etc/sysconfig/jenkins &amp;&amp; \\\n\n# 7.\u53ef\u4ee5\u9009\u62e9\u4fee\u6539\u9ed8\u8ba4\u76848080\u7aef\u53e3\u4e3a9090\nsed -i '56s/8080/9090/' /etc/sysconfig/jenkins &amp;&amp; \\\n\n# 8.\u4fee\u6539\u9ed8\u8ba4\u7684\u6570\u636e\u76ee\u5f55\nsed -i '10s#/var/lib/jenkins#/root/jenkins-data#' /etc/sysconfig/jenkins &amp;&amp; \\ \n\n# 9.\u521b\u5efa\u65e5\u5fd7\u76ee\u5f55\uff0c\u6570\u636e\u76ee\u5f55\nln -s /var/lib/jenkins jenkins-data &amp;&amp; \\\nln -s /var/log/jenkins jenkins-logs &amp;&amp; \\\n\n# 10.\u8bbe\u7f6e\u5f00\u673a\u542f\u52a2\nchkconfig jenkins on &amp;&amp; \\ \nchkconfig --list jenkins &amp;&amp; \\\n\n# 11.\u521b\u5efa\u670d\u52a1\u7ba1\u7406\u811a\u672c\ncat &gt;start-jenkins.sh&lt;&lt;EOF\n#!/bin/bash\n/etc/init.d/jenkins start\nEOF\ncat &gt;restart-jenkins.sh&lt;&lt;EOF\n#!/bin/bash\n/etc/init.d/jenkins restart\nEOF\ncat &gt;stop-jenkins.sh&lt;&lt;EOF\n#!/bin/bash\n/etc/init.d/jenkins stop\nEOF\n\n# 12.\u5f00\u542f\u6216\u5173\u95ed\u9632\u706b\u5899 \nsudo firewall-cmd --zone=public --add-port=9090/tcp --permanent &amp;&amp; \\\nsudo firewall-cmd --reload &amp;&amp; \\\nsudo firewall-cmd --list-all &amp;&amp; \\\nsystemctl stop firewalld &amp;&amp; \\\nsystemctl disable firewalld &amp;&amp; \\\n\nsed -i '7s/enforcing/disabled/' /etc/selinux/config &amp;&amp; \\\nsetenforce 0 &amp;&amp; \\\ngetenforce  &amp;&amp; \\\n\n# 12.\u8bbf\u95eejenkins\u7ba1\u7406\u754c\u9762\n# http://192.168.216.108:9090/ \n# \u521d\u59cb\u5bc6\u7801\uff1acat /var/lib/jenkins/secrets/initialAdminPassword\n\n\n# 13.\u66f4\u65b0\u63d2\u4ef6\u5305\ncd &amp;&amp; \\  \ncd jenkins-data &amp;&amp; \\ \nmv plugins/ plugins.bak &amp;&amp; \\ \ntar -xzvf /root/software/plugins.tar.gz &amp;&amp; \\\nchown -R jenkins.jenkins ./* &amp;&amp; \\\ncd &amp;&amp; \\ \n./restart-jenkins.sh \n\n\n## 14 \u81ea\u884c\u90e8\u7f72java \u3001maven\u3001 python \u3001node/npm/yarn \u4ee3\u78bc\u7de8\u8b6f\u69cb\u5efa\u7684\u74b0\u5883\uff0c\u4e26\u5c07\u74b0\u5883\u8b8a\u91cf\u8207\u8def\u5f91\u540c\u6b65\u5728Jenkins \u914d\u7f6e\u4e2d\n</code></pre>"},{"location":"cicd/Jenkins-Pipeline/#5","title":"5 \u63a8\u8350\u535a\u5ba2","text":"<p>\u4e8c\u4e2b\u8bb2\u68b5</p>"},{"location":"cicd/Jenkins-Pipeline/#6-jenkinsfilebackend","title":"6 Jenkinsfile(backend)","text":"<pre><code>pipeline {\n//     agent any\n    agent{\n        node {\n          label 'slave01'\n        }\n    }\n//     agent {\n//         docker { image 'harbor.dockerregistry.com/kubesphere/builder-nodejs:v3.2.0-1' }\n//     }\n    environment {\n        //git\u51ed\u8bc1ID\n        GITLAB_CREDENTIAL_ID = 'xxxxxxxxxxxx'\n        //\u4ee3\u7801\u5730\u5740\n        GIT_REGISTRY = 'xxxxxxxxxxxx'\n        //\u5206\u652f\u540d\u79f0\n        BRANCH_NAME = 'xxxxx'\n        //\u5e94\u7528\u540d\u79f0\n        APP_NAME = 'xxxxxx'\n        //Harbor\u5730\u5740\n        HARBOR_HOST = 'xxxxxx'\n        //Harbor\u767b\u5f55\u7528\u6237\n        HABOR_USERNAME = 'xxxx'\n        //Harbor\u767b\u5f55\u5bc6\u7801\n        HARBOR_PASSWORD = 'xxxxxx'\n        //Harbor\u4ed3\u5e93\u540d\u79f0\n        HARBOR_PROJECT = 'xxxxx'\n        //Harbor\u51ed\u8bc1\n        HARBOR_CREDENTIAL_ID = 'xxxx'\n        //\u5bb9\u5668\u955c\u50cf\u540d\u79f0\n        CONTAINER_IMAGE = \"$HARBOR_HOST/$HARBOR_PROJECT/$APP_NAME\"\n        //k8s\u96c6\u7fa4\u540d\u79f0\n        K8S_NAMESPACE = 'xxxx'\n        //\u5bb9\u5668\u7aef\u53e3\n        CONTAINER_PORT = \"xxxxx\"\n        //GIT_COMMIT_ID\u524d\u4e03\u4f4d\u6570\u5b57\n        CI_COMMIT_SHORT_SHA = sh(script: \"git rev-parse --short HEAD\", returnStdout: true).trim()\n    }\n\n    stages {\n        stage('ENV Test') {\n            steps {\n                sh 'echo \"\u5f00\u59cb\u68c0\u67e5\u73af\u5883\"'\n                sh 'echo \"GIT_COMMIT_ID\u524d\u4e03\u4f4d\u6570\u5b57: $CI_COMMIT_SHORT_SHA\"'\n                sh 'docker --version'\n//              sh 'node --version'\n//              sh 'npm --version'\n//              sh 'yarn --version'\n            }\n        }\n\n        stage('Code Pull') {\n          steps {\n            git(branch: \"$BRANCH_NAME\", url: \"$GIT_REGISTRY\", credentialsId: \"$GITLAB_CREDENTIAL_ID\", changelog: true, poll: false)\n          }\n        }\n        stage('Maven Install') {\n            steps {\n                sh 'echo \"\u5b89\u88c5maven\u4f9d\u8d56\"'\n                sh '''\n                    mvn -Dmaven.test.skip=true clean install -U\n                '''\n            }\n        }\n        stage('Maven Package') {\n            steps {\n                sh 'echo \"\u5f00\u59cbmaven\u6253\u5305\"'\n                sh '''\n                    mvn -f  $APP_NAME -Dmaven.test.skip=true clean package\n                '''\n            }\n        }\n        // stage('Maven Deploy') {\n        //     steps {\n        //         sh 'echo \"\u5f00\u59cb\u63a8\u9001\u79c1\u5e93\"'\n        //         sh '''\n        //             mvn -f $APP_NAME -Dmaven.test.skip=true clean deploy\n        //         '''\n        //     }\n        // }\n        stage('Docker Build') {\n            steps {\n                sh 'echo \"\u5f00\u59cbDocker\u6784\u5efa\"'\n                sh '''\n                    cd $APP_NAME\n                    docker build                                     \\\n                      --cache-from $CONTAINER_IMAGE                  \\\n                      --tag  $CONTAINER_IMAGE:latest                 \\\n                      --tag  $CONTAINER_IMAGE:$CI_COMMIT_SHORT_SHA   \\\n                      --file Dockerfile                              \\\n                      \".\"\n                '''\n            }\n        }\n        stage('Docker Push') {\n            steps {\n                sh 'echo \"\u5f00\u59cb\u63a8\u9001Docker\u955c\u50cf\"'\n                sh '''\n                    docker login -u $HABOR_USERNAME -p $HARBOR_PASSWORD $HARBOR_HOST\n                    docker push $CONTAINER_IMAGE:latest\n                    docker push $CONTAINER_IMAGE:$CI_COMMIT_SHORT_SHA\n                '''\n            }\n        }\n        stage('Update Yaml') {\n            steps {\n                sh 'echo \"\u5f00\u59cb\u66f4\u65b0\u90e8\u7f72YAML\u6587\u4ef6\u4e2d\u7684\u955c\u50cf\u6807\u7b7e\"'\n                sh '''\n                    cd $APP_NAME\n                    sed -ri s@latest@$CI_COMMIT_SHORT_SHA@ deploy/deploy.yaml\n                    grep 'image:' deploy/deploy.yaml\n                '''\n            }\n        }\n        stage('Deploy To K8') {\n            steps {\n                sh 'echo \"\u5f00\u59cb\u90e8\u7f72\u5e94\u7528$APP_NAME \u5230K8\u547d\u540d\u7a7a\u95f4 $K8S_NAMESPACE\"'\n                sh '''\n                    cd $APP_NAME\n                    kubectl apply -f deploy --kubeconfig=/root/.kube/kubeconfig\n                '''\n            }\n        }\n    }\n\n//     post {\n//         always {\n//             echo 'This will always run'\n//         }\n//         success {\n//             echo 'This will run only if successful'\n//         }\n//         failure {\n//             echo 'This will run only if failed'\n//         }\n//         unstable {\n//             echo 'This will run only if the run was marked as unstable'\n//         }\n//         changed {\n//             echo 'This will run only if the state of the Pipeline has changed'\n//             echo 'For example, if the Pipeline was previously failing but is now successful'\n//         }\n//     }\n    post {\n        cleanup {\n            /* clean up our workspace */\n            deleteDir()\n            /* clean up tmp directory */\n            dir(\"${workspace}@tmp\") {\n                deleteDir()\n            }\n            /* clean up script directory */\n            dir(\"${workspace}@script\") {\n                deleteDir()\n            }\n        }\n    }\n}\n</code></pre>"},{"location":"cicd/Jenkins-Pipeline/#7-jenkinsfilefrontend","title":"7 Jenkinsfile(frontend)","text":"<pre><code>pipeline {\n//     agent any\n    agent{\n        node {\n          label 'slave03'\n        }\n    }\n\n    environment {\n        //git\u51ed\u8bc1ID\n        GITLAB_CREDENTIAL_ID = 'xxxxxxxxxxxxxxxx'\n        //\u4ee3\u7801\u5730\u5740\n        GIT_REGISTRY = 'xxxxxxxxxxxxxx'\n        //\u5206\u652f\u540d\u79f0\n        BRANCH_NAME = 'xxxxxxxxxxxxxx'\n        //\u5e94\u7528\u540d\u79f0\n        APP_NAME = 'xxxxxxxxxxx'\n        //Harbor\u5730\u5740\n        HARBOR_HOST = 'xxxxxxxxxxxxx'\n        //Harbor\u767b\u5f55\u7528\u6237\n        HABOR_USERNAME = 'xxxx'\n        //Harbor\u767b\u5f55\u5bc6\u7801\n        HARBOR_PASSWORD = 'xxxxxx'\n        //Harbor\u4ed3\u5e93\u540d\u79f0\n        HARBOR_PROJECT = 'xxxxxx'\n        //Harbor\u51ed\u8bc1\n        HARBOR_CREDENTIAL_ID = 'xxxxx'\n        //\u5bb9\u5668\u955c\u50cf\u540d\u79f0\n        CONTAINER_IMAGE = \"$HARBOR_HOST/$HARBOR_PROJECT/$APP_NAME\"\n        //k8s\u96c6\u7fa4\u540d\u79f0\n        K8S_NAMESPACE = 'xxxxx'\n        //\u5bb9\u5668\u7aef\u53e3\n        CONTAINER_PORT = \"xxxxxxx\"\n        //GIT_COMMIT_ID\u524d\u4e03\u4f4d\u6570\u5b57\n        CI_COMMIT_SHORT_SHA = sh(script: \"git rev-parse --short HEAD\", returnStdout: true).trim()\n    }\n\n    stages {\n        stage('ENV Test') {\n            steps {\n                sh 'echo \"\u5f00\u59cb\u68c0\u67e5\u73af\u5883\"'\n                sh 'echo \"GIT_COMMIT_ID\u524d\u4e03\u4f4d\u6570\u5b57: $CI_COMMIT_SHORT_SHA\"'\n                // sh 'docker --version'\n                sh 'node --version'\n                sh 'npm --version'\n                sh 'yarn --version'\n            }\n        }\n\n        stage('Code Pull') {\n          steps {\n            git(branch: \"$BRANCH_NAME\", url: \"$GIT_REGISTRY\", credentialsId: \"$GITLAB_CREDENTIAL_ID\", changelog: true, poll: false)\n          }\n        }\n        stage('Code Build') {\n            steps {\n                sh 'echo \"\u5f00\u59cb\u4ee3\u7801\u6784\u5efa\"'\n                sh '''\n                    npm install --registry=https://registry.npm.taobao.org\n                    yarn run build\n                '''\n            }\n        }\n        stage('Docker Build') {\n            steps {\n                sh 'echo \"\u5f00\u59cbDocker\u6784\u5efa\"'\n                sh '''\n                    docker build                                     \\\n                      --cache-from $CONTAINER_IMAGE                  \\\n                      --tag  $CONTAINER_IMAGE:latest                 \\\n                      --tag  $CONTAINER_IMAGE:$CI_COMMIT_SHORT_SHA   \\\n                      --file Dockerfile                              \\\n                      \".\"\n                '''\n            }\n        }\n        stage('Docker Push') {\n            steps {\n                sh 'echo \"\u5f00\u59cb\u63a8\u9001Docker\u955c\u50cf\"'\n                sh '''\n                    docker login -u $HABOR_USERNAME -p $HARBOR_PASSWORD $HARBOR_HOST\n                    docker push $CONTAINER_IMAGE:latest\n                    docker push $CONTAINER_IMAGE:$CI_COMMIT_SHORT_SHA\n                '''\n            }\n        }\n        stage('Update Yaml') {\n            steps {\n                sh 'echo \"\u5f00\u59cb\u66f4\u65b0\u90e8\u7f72YAML\u6587\u4ef6\u4e2d\u7684\u955c\u50cf\u6807\u7b7e\"'\n                sh '''\n                    sed -ri s@latest@$CI_COMMIT_SHORT_SHA@ deploy/deploy.yaml\n                    grep 'image:' deploy/deploy.yaml\n                '''\n            }\n        }\n        stage('Deploy To K8') {\n            steps {\n                sh 'echo \"\u5f00\u59cb\u90e8\u7f72\u5e94\u7528$APP_NAME \u5230K8\u547d\u540d\u7a7a\u95f4 $K8S_NAMESPACE\"'\n                sh '''\n                    kubectl apply -f deploy    --kubeconfig=/root/.kube/kubeconfig\n                '''\n            }\n        }\n    }\n\n//     post {\n//         always {\n//             echo 'This will always run'\n//         }\n//         success {\n//             echo 'This will run only if successful'\n//         }\n//         failure {\n//             echo 'This will run only if failed'\n//         }\n//         unstable {\n//             echo 'This will run only if the run was marked as unstable'\n//         }\n//         changed {\n//             echo 'This will run only if the state of the Pipeline has changed'\n//             echo 'For example, if the Pipeline was previously failing but is now successful'\n//         }\n//     }\n    post {\n        cleanup {\n            /* clean up our workspace */\n            deleteDir()\n            /* clean up tmp directory */\n            dir(\"${workspace}@tmp\") {\n                deleteDir()\n            }\n            /* clean up script directory */\n            dir(\"${workspace}@script\") {\n                deleteDir()\n            }\n        }\n    }\n}\n</code></pre>"},{"location":"docker/Docker/","title":"Docker","text":""},{"location":"docker/Docker/#deamonjson","title":"Deamon.json","text":"<p>https://docs.docker.com/engine/reference/commandline/dockerd/#daemon</p> <pre><code>{\n  \"registry-mirrors\": [\"https://ustc-edu-cn.mirror.aliyuncs.com\"],\n  \"debug\": false,\n  \"insecure-registries\": [\n    \"0.0.0.0/0\"\n  ],\n  \"ip-forward\": true,\n  \"ipv6\": false,\n  \"live-restore\": true,\n  \"log-driver\": \"json-file\",\n  \"log-level\": \"warn\",\n  \"log-opts\": {\n    \"max-size\": \"100m\",\n    \"max-file\": \"2\"\n  },\n  \"selinux-enabled\": false,\n  \"experimental\" : true,\n  \"storage-driver\": \"overlay2\",\n  \"metrics-addr\" : \"0.0.0.0:9323\",\n  \"data-root\": \"/data/docker\",\n  \"default-ulimits\": {\n    \"nofile\": {\n      \"Name\": \"nofile\",\n      \"Hard\": 65536,\n      \"Soft\": 65536\n    }\n  },\n  \"exec-opts\": [\"native.cgroupdriver=systemd\"]\n}\n</code></pre>"},{"location":"docker/Docker/#configjson","title":"config.json","text":"<pre><code>// /root/.docker/config.json\n// base64\u52a0\u5bc6\n{\n        \"auths\": {\n                \"harbor.dockerregistry.com\": {\n                        \"auth\": \"YWRtaW46SGFyYm9yMTIzNDU=\"\n                }\n        }\n}\n</code></pre>"},{"location":"docker/Docker/#dockefile","title":"Dockefile","text":"<p>Clean up the mirror environment</p>"},{"location":"docker/Docker/#ubuntu","title":"ubuntu","text":"<pre><code>RUN apt-get update &amp;&amp; \\\n    apt-get install -y --no-install-recommends git &amp;&amp; \\\n    rm -rf /tmp/* &amp;&amp; \\\n    rm -rf /var/lib/apt/lists/*\n</code></pre>"},{"location":"docker/Docker/#alpine","title":"alpine","text":"<pre><code>RUN apk -U --no-cache add git\n# \u6216\u8005\nRUN apk -U add git &amp;&amp; \\\n    rm -rf /var/cache/apk/*\n</code></pre>"},{"location":"docker/Docker/#backend","title":"Backend","text":"<pre><code># Define arguments for host, JDK version\nARG HARBOR_HOST\nARG JDK_VERSION=8-latest\n\n# Use arguments in the FROM statement for the JDK version\nFROM ${HARBOR_HOST}/library/azul/zulu-openjdk-alpine:${JDK_VERSION}\n\n# Define arguments for application version, port, and jar name\nARG APP_VERSION=5.1.0\nARG APP_PORT=8510\nARG JAR_NAME=sys-gateway\n\nWORKDIR /home\n\n# Copy the jar file using the argument for the version and jar name\nCOPY ./target/${JAR_NAME}-${APP_VERSION}.jar ./app.jar\n\n# Expose the port using the argument\nEXPOSE ${APP_PORT}\n\n# Set environment variable for port, this could be used at runtime if the application reads from this environment variable\nENV HTTPS_PORT=${APP_PORT}\nENV HTTP_PORT=${APP_PORT}\n\n# Set the CMD or ENTRYPOINT using the environment variables\nCMD java -Djava.security.egd=file:/dev/./urandom -jar app.jar \\\n    --server.port=${HTTPS_PORT} \\\n    --http.port=${HTTP_PORT} \\\n    --spring.profiles.active=$SPRING_PROFILES_ACTIVE \\\n    --spring.cloud.nacos.discovery.server-addr=$SPRING_CLOUD_NACOS_DISCOVERY_SERVER_ADDR \\\n    --spring.cloud.nacos.config.server-addr=$SPRING_CLOUD_NACOS_CONFIG_SERVER_ADDR \\\n    --spring.cloud.nacos.username=$SPRING_CLOUD_NACOS_USERNAME \\\n    --spring.cloud.nacos.password=$SPRING_CLOUD_NACOS_PASSWORD \\\n    --spring.cloud.nacos.config.namespace=$SPRING_CLOUD_NACOS_CONFIG_NAMESPACE \\\n    --spring.cloud.nacos.discovery.namespace=$SPRING_CLOUD_NACOS_DISCOVERY_NAMESPACE\n</code></pre>"},{"location":"docker/Docker/#frontend","title":"Frontend","text":"<pre><code>ARG HARBOR_HOST\nARG NG_VERSION=stable-alpine3.17\nFROM ${HARBOR_HOST}/library/nginx:${NG_VERSION}\n#RUN  mkdir -p /usr/share/nginx/html/dir\nCOPY dist /usr/share/nginx/html/\nEXPOSE 80\nCMD [\"nginx\", \"-g\", \"daemon off;\"]\n</code></pre>"},{"location":"docker/Install-Consul/","title":"Install Consul","text":""},{"location":"docker/Install-Consul/#compose-file","title":"Compose file","text":"<pre><code>version: '3.8'\nservices:\n  console:\n    image: harbor.dockerregistry.com/app/console:latest\n    container_name: console\n    ports:\n     - '8000:8000'\n    volumes:\n      - './local_config.yaml:/opt/console/server/local_config.yaml'\n    restart: always\n</code></pre>"},{"location":"docker/Install-Elastic-Cluster/","title":"Install Elastic Cluster","text":""},{"location":"docker/Install-Elastic-Cluster/#compose-file","title":"Compose file","text":"<pre><code>version: '3'\nservices:\n  elasticsearch:\n    image: harbor.dockerregistry.com/app/elasticsearch:7.17.1\n    container_name: elasticsearch\n    environment:\n      - node.name=elasticsearch\n      - cluster.name=docker-cluster\n      - bootstrap.memory_lock=true\n      - http.cors.enabled=true\n      - http.cors.allow-origin=*\n      - \"ES_JAVA_OPTS=-Xms512m -Xmx512m\"\n      - xpack.security.enabled=false\n      - discovery.seed_hosts=elasticsearch2,elasticsearch3\n      - cluster.initial_master_nodes=elasticsearch,elasticsearch2,elasticsearch3\n    ulimits:\n      memlock:\n        soft: -1\n        hard: -1\n    volumes:\n      - /data/es/data01:/usr/share/elasticsearch/data\n    ports:\n      - 19200:9200\n    networks:\n      - esnet\n    restart: always\n  elasticsearch2:\n    image: harbor.dockerregistry.com/app/elasticsearch:7.17.1\n    container_name: elasticsearch2\n    environment:\n      - node.name=elasticsearch2\n      - cluster.name=docker-cluster\n      - bootstrap.memory_lock=true\n      - http.cors.enabled=true\n      - http.cors.allow-origin=*\n      - \"ES_JAVA_OPTS=-Xms512m -Xmx512m\"\n      - xpack.security.enabled=false\n      - discovery.seed_hosts=elasticsearch,elasticsearch3\n      - cluster.initial_master_nodes=elasticsearch,elasticsearch2,elasticsearch3\n    ulimits:\n      memlock:\n        soft: -1\n        hard: -1\n    volumes:\n      - /data/es/data02:/usr/share/elasticsearch/data\n    networks:\n      - esnet\n    restart: always\n  elasticsearch3:\n    image: harbor.dockerregistry.com/app/elasticsearch:7.17.1\n    container_name: elasticsearch3\n    environment:\n      - node.name=elasticsearch3\n      - cluster.name=docker-cluster\n      - bootstrap.memory_lock=true\n      - http.cors.enabled=true\n      - http.cors.allow-origin=*\n      - \"ES_JAVA_OPTS=-Xms512m -Xmx512m\"\n      - xpack.security.enabled=false\n      - discovery.seed_hosts=elasticsearch,elasticsearch2\n      - cluster.initial_master_nodes=elasticsearch,elasticsearch2,elasticsearch3\n    ulimits:\n      memlock:\n        soft: -1\n        hard: -1\n    volumes:\n      - /data/es/data03:/usr/share/elasticsearch/data\n    networks:\n      - esnet\n    restart: always\n\nvolumes:\n  data01:\n  data02:\n  data03:\n\nnetworks:\n  esnet:\n</code></pre>"},{"location":"docker/Install-Elasticsearch/","title":"Install Elasticsearch","text":""},{"location":"docker/Install-Elasticsearch/#compose-file","title":"Compose file","text":"<pre><code>version: '3'\nservices:\n  elasticsearch:\n    image: harbor.dockerregistry.com/app-arm/elasticsearch:6.5.4\n    container_name: elasticsearch\n    volumes:\n      - /etc/localtime:/etc/localtime:ro\n      - ./elastic/elasticsearch.yml:/usr/share/elasticsearch/config/elasticsearch.yml\n      - /data/middleware/es/plugins:/usr/share/elasticsearch/plugins\n      - /data/middleware/es/data:/usr/share/elasticsearch/data\n    ports:\n        - \"9200:9200\"\n        - \"9300:9300\"\n    environment:\n        - discovery.type=single-node\n    restart: always\n</code></pre>"},{"location":"docker/Install-Elasticsearch/#elasticsearchyml","title":"elasticsearch.yml","text":"<pre><code>bootstrap.memory_lock: true\ncluster.name: \"es-server\"\nnode.name: single-node\nnode.master: true\nnode.data: true\nnetwork.host: 0.0.0.0\nhttp.port: 9200\npath.logs: /usr/share/elasticsearch/logs\nhttp.cors.enabled: true\nhttp.cors.allow-origin: \"*\"\nxpack.security.audit.enabled: false\nxpack.ml.enabled: false\n</code></pre>"},{"location":"docker/Install-Export/","title":"Install Export","text":""},{"location":"docker/Install-Export/#node_exporter","title":"Node_Exporter","text":"<p>\u7269\u7406\u65b9\u5f0f\uff0c<code>debian</code> \u7cfb\u7edf</p> <pre><code>\\cp -rvf  node_exporter-1.7.0.linux-amd64/node_exporter /usr/bin/node_exporter \nchmod +x /usr/bin/node_exporter\n\nsudo tee /lib/systemd/system/node_exporter.service &lt;&lt;-'EOF'\n[Unit]\nDescription=node_exporter Monitoring System\nAfter=network.target\n\n[Service]\nExecStart=/usr/bin/node_exporter --web.listen-address=:19100\n\n[Install]\nWantedBy=multi-user.target\nEOF\n\nsudo systemctl daemon-reload\nsudo systemctl start node_exporter\nsudo systemctl enable node_exporter\n</code></pre> <p>Compose \u65b9\u5f0f</p> <pre><code>version: '3.8'\nservices:\n  linux_exporter:\n    image: harbor.dockerregistry.com/app/linux_exporter:latest\n    container_name: linux_exporter\n    ports:\n      - \"9100:9100\"\n    command:\n      - '--path.rootfs=/host'\n    pid: host\n    volumes:\n      - '/:/host:ro,rslave'\n    deploy:\n      resources:\n        limits:\n          cpus: '0.50'\n          memory: 100M\n    restart: always\n    privileged: true\n</code></pre>"},{"location":"docker/Install-Export/#docker_exporter","title":"Docker_Exporter","text":"<pre><code>version: '3.8'\nservices:\n  docker_exporter:\n    image: harbor.dockerregistry.com/app/docker_exporter:latest\n    container_name: docker_exporter\n    ports:\n        - \"19104:8080\"\n    volumes:\n      - '/:/rootfs:ro'\n      - '/sys:/sys:ro'\n      - '/var/run:/var/run:ro'\n      - '/dev/disk/:/dev/disk:ro'\n      - '/var/lib/docker/:/var/lib/docker:ro'\n    devices:\n      - '/dev/kmsg:/dev/kmsg'\n    deploy:\n      resources:\n        limits:\n          cpus: '0.50'\n          memory: 100M\n    restart: always\n    privileged: true\n</code></pre>"},{"location":"docker/Install-Export/#postgres_exporter","title":"Postgres_Exporter","text":"<pre><code>version: '3.8'\nservices:\n  postgres_exporter:\n    image: harbor.dockerregistry.com/app/postgres_exporter:latest\n    container_name: postgres_exporter\n    ports:\n      - \"9187:9187\"\n    environment:\n      DATA_SOURCE_NAME: postgresql://postgres:postgres@10.1.6.239:5432/postgres?sslmode=disable\n    deploy:\n      resources:\n        limits:\n          cpus: '0.50'\n          memory: 100M\n    restart: always\n</code></pre>"},{"location":"docker/Install-Export/#redis-exporter","title":"Redis-Exporter","text":"<pre><code>version: '3.8'\nservices:\n  redis-exporter:\n    image: harbor.dockerregistry.com/app/quay.io/oliver006/redis_exporter\n    container_name: redis-exporter\n    ports:\n      - \"9121:9121\"\n    environment:\n      redis.password: sso123456\n    restart: always\n    privileged: true\n</code></pre>"},{"location":"docker/Install-Export/#oracledb-exporter","title":"Oracledb-Exporter","text":"<pre><code>version: '3.8'\nservices:\n  oracledb-exporter:\n    image: harbor.dockerregistry.com/app/iamseth/oracledb_exporter\n    container_name: oracledb-exporter\n    ports:\n      - \"9161:9161\"\n    environment:\n      DATA_SOURCE_NAME: system/123456@10.0.1.186:1521/ORCL\n    restart: always\n    privileged: true\n</code></pre>"},{"location":"docker/Install-Export/#gpu-exporter","title":"Gpu-Exporter","text":"<pre><code>version: '3.8'\nservices:\n  gpu-exporter:\n    image: harbor.dockerregistry.com/app/utkuozdemir/nvidia_gpu_exporter:0.3.0\n    container_name: gpu-exporter\n    ports:\n      - \"9835:9835\"\n    volumes:\n      - '/usr/lib/x86_64-linux-gnu/libnvidia-ml.so:/usr/lib/x86_64-linux-gnu/libnvidia-ml.so'\n      - '/usr/lib/x86_64-linux-gnu/libnvidia-ml.so.1:/usr/lib/x86_64-linux-gnu/libnvidia-ml.so.1'\n      - '/usr/bin/nvidia-smi:/usr/bin/nvidia-smi'\n    devices:\n      - '/dev/nvidiactl:/dev/nvidiactl'\n      - '/dev/nvidia0:/dev/nvidia0'\n    restart: always\n    privileged: true\n</code></pre>"},{"location":"docker/Install-Gitlab/","title":"Install Gitlab","text":""},{"location":"docker/Install-Gitlab/#compose-file","title":"Compose file","text":"<p>\u53c2\u8003\u535a\u5ba2\uff1ahttps://soulteary.com/2021/07/14/gitlab-14-lightweight-operation-solution.html</p> <p>\u5e94\u8be5\u9700\u8981root \u7528\u6237\u542f\u52a8\u624d\u884c\uff0c\u5185\u7f6e\u6570\u636e\u5e93\u76ee\u524d\u6743\u9650\u5728\u63d0\u6743\u7528\u6237\u4e0b\u6709\u70b9\u95ee\u9898\u3002</p> <pre><code>version: \"3\"\n\n\nservices:\n  gitlab:\n    restart: always\n    image: gitlab/gitlab-ce:15.11.13-ce.0\n    container_name: gitlab\n    hostname: gitlab.localhost.com\n    ports:\n      - \"80:80\"\n      - '443:443' \n      - \"22:22\"\n    volumes:\n      - ./config:/etc/gitlab\n      - ./data:/var/opt/gitlab\n    environment:\n      TZ: Asia/Shanghai\n      GITLAB_OMNIBUS_CONFIG: |\n        external_url 'http://gitlab.localhost.com'\n        gitlab_rails['time_zone'] = 'Asia/Shanghai'\n\n        # \u5173\u95ed\u7535\u5b50\u90ae\u4ef6\u76f8\u5173\u529f\u80fd\n        gitlab_rails['smtp_enable'] = false\n        gitlab_rails['gitlab_email_enabled'] = false\n        gitlab_rails['incoming_email_enabled'] = false\n\n        # Terraform\n        gitlab_rails['terraform_state_enabled'] = false\n\n        # Usage Statistics\n        gitlab_rails['usage_ping_enabled'] = false\n        gitlab_rails['sentry_enabled'] = false\n        grafana['reporting_enabled'] = false\n\n        # \u5173\u95ed\u5bb9\u5668\u4ed3\u5e93\u529f\u80fd\n        gitlab_rails['gitlab_default_projects_features_container_registry'] = false\n        gitlab_rails['registry_enabled'] = false\n        registry['enable'] = false\n        registry_nginx['enable'] = false\n\n        # \u5305\u4ed3\u5e93\n        gitlab_rails['packages_enabled'] = false\n        gitlab_rails['dependency_proxy_enabled'] = false\n\n        # GitLab KAS\n        gitlab_kas['enable'] = false\n        gitlab_rails['gitlab_kas_enabled'] = false\n\n        # Mattermost\n        mattermost['enable'] = false\n        mattermost_nginx['enable'] = false\n\n        # Kerberos\n        gitlab_rails['kerberos_enabled'] = false\n        sentinel['enable'] = false\n\n        # GitLab Pages\n        gitlab_pages['enable'] = false\n        pages_nginx['enable'] = false\n\n        # \u7981\u7528 PUMA \u96c6\u7fa4\u6a21\u5f0f\n        puma['worker_processes'] = 0\n        puma['min_threads'] = 1\n        puma['max_threads'] = 2\n\n        # \u964d\u4f4e\u540e\u53f0\u5b88\u62a4\u8fdb\u7a0b\u5e76\u53d1\u6570\n        sidekiq['max_concurrency'] = 5\n\n        gitlab_ci['gitlab_ci_all_broken_builds'] = false\n        gitlab_ci['gitlab_ci_add_pusher'] = false\n\n        # \u5173\u95ed\u76d1\u63a7\n        prometheus_monitoring['enable'] = false\n        alertmanager['enable'] = false\n        node_exporter['enable'] = false\n        redis_exporter['enable'] = false\n        postgres_exporter['enable'] = false\n        pgbouncer_exporter['enable'] = false\n        gitlab_exporter['enable'] = false\n        grafana['enable'] = false\n        sidekiq['metrics_enabled'] = false \n</code></pre> <pre><code>docker-compose up -d\nchmod 0600 conf/ssh_host_ed25519_key\ndocker-compose down\ndocker-compose up -d \n</code></pre>"},{"location":"docker/Install-Gitlab/#password-acquisition","title":"Password acquisition","text":"<pre><code># root\ndocker exec -it gitlab-ce grep 'Password:' /etc/gitlab/initial_root_password\n\n# or\ndocker exec -it gitlab-ce grep 'admin_password' /etc/gitlab/gitlab-secrets.json\n</code></pre>"},{"location":"docker/Install-Harbor/","title":"Install Harbor","text":""},{"location":"docker/Install-Harbor/#1-harbor-for-tls","title":"1 Harbor For TLS","text":"<p>Harbor\u5b98\u65b9\u6587\u6863</p>"},{"location":"docker/Install-Harbor/#11","title":"1.1 \u8bc1\u4e66\u914d\u7f6e","text":"<pre><code>$ grep myharbor ~/harbor/harbor.yml \nhostname: myharbor.mydomain.com\n  certificate: /data/harbor/ssl/myharbor.mydomain.com.crt\n  private_key: /data/harbor/ssl/myharbor.mydomain.com.key\n</code></pre>"},{"location":"docker/Install-Harbor/#12","title":"1.2 \u8bc1\u4e66\u5236\u4f5c","text":"<pre><code>openssl genrsa -out ca.key 4096\nopenssl req -x509 -new -nodes -sha512 -days 3650 \\\n -subj \"/C=CN/ST=Beijing/L=Beijing/O=example/OU=Personal/CN=myharbor.mydomain.com\" \\\n -key ca.key \\\n -out ca.crt\n\nopenssl genrsa -out myharbor.mydomain.com.key 4096\nopenssl req -sha512 -new \\\n    -subj \"/C=CN/ST=Beijing/L=Beijing/O=example/OU=Personal/CN=myharbor.mydomain.com\" \\\n    -key myharbor.mydomain.com.key \\\n    -out myharbor.mydomain.com.csr\n\ncat &gt; v3.ext &lt;&lt;-EOF\nauthorityKeyIdentifier=keyid,issuer\nbasicConstraints=CA:FALSE\nkeyUsage = digitalSignature, nonRepudiation, keyEncipherment, dataEncipherment\nextendedKeyUsage = serverAuth\nsubjectAltName = @alt_names\n\n[alt_names]\nDNS.1=myharbor.mydomain.com\nEOF\n\n\n\nopenssl x509 -req -sha512 -days 3650 \\\n    -extfile v3.ext \\\n    -CA ca.crt -CAkey ca.key -CAcreateserial \\\n    -in myharbor.mydomain.com.csr \\\n    -out myharbor.mydomain.com.crt\n\nopenssl x509 -inform PEM -in myharbor.mydomain.com.crt -out myharbor.mydomain.com.cert\n</code></pre>"},{"location":"docker/Install-Harbor/#13","title":"1.3 \u8bc1\u4e66\u62f7\u8d1d","text":"<pre><code>mkdir -p /etc/docker/certs.d/myharbor.mydomain.com/\ncp ca.crt /etc/docker/certs.d/myharbor.mydomain.com/\ncp myharbor.mydomain.com.cert  /etc/docker/certs.d/myharbor.mydomain.com/\ncp myharbor.mydomain.com.key   /etc/docker/certs.d/myharbor.mydomain.com/\n</code></pre>"},{"location":"docker/Install-Harbor/#14","title":"1.4 \u66f4\u65b0\u7cfb\u7edf\u8bc1\u4e66","text":"<pre><code>\\cp -rvf myharbor.mydomain.com.crt /usr/local/share/ca-certificates/myharbor.mydomain.com.crt \nupdate-ca-certificates\n</code></pre>"},{"location":"docker/Install-Harbor/#15","title":"1.5 \u8bc1\u4e66\u53d1\u9001\u5230\u5ba2\u6237\u7aef","text":"<pre><code>scp -r /etc/docker/certs.d 192.168.171.130:/etc/docker\nscp -r /etc/docker/certs.d 192.168.171.132:/etc/docker\nscp -r /etc/docker/certs.d 192.168.171.133:/etc/docker\nscp -r myharbor.mydomain.com.crt 192.168.171.133:/usr/local/share/ca-certificates/\n</code></pre>"},{"location":"docker/Install-Harbor/#16-docker","title":"1.6 Docker \u914d\u7f6e","text":"<pre><code>cat &gt; /etc/docker/daemon.json &lt;&lt;-EOF\n{\n  \"registry-mirrors\": [\"https://ustc-edu-cn.mirror.aliyuncs.com\"],\n  \"debug\": false,\n  \"ip-forward\": true,\n  \"ipv6\": false,\n  \"live-restore\": true,\n  \"log-driver\": \"json-file\",\n  \"log-level\": \"warn\",\n  \"log-opts\": {\n    \"max-size\": \"100m\",\n    \"max-file\": \"2\"\n  },\n  \"selinux-enabled\": false,\n  \"experimental\" : true,\n  \"storage-driver\": \"overlay2\",\n  \"metrics-addr\" : \"0.0.0.0:9323\",\n  \"data-root\": \"/data/docker\",\n  \"exec-opts\": [\"native.cgroupdriver=systemd\"]\n}\nEOF\n</code></pre>"},{"location":"docker/Install-Harbor/#17-docker","title":"1.7 \u91cd\u542fdocker","text":"<pre><code>systemctl restart docker\nupdate-ca-certificates\n</code></pre>"},{"location":"docker/Install-Harbor/#18","title":"1.8 \u767b\u5f55\u8ba4\u8bc1","text":"<pre><code>$ docker login -u admin -p Harbor12345 myharbor.mydomain.com\nWARNING! Using --password via the CLI is insecure. Use --password-stdin.\nWARNING! Your password will be stored unencrypted in /root/.docker/config.json.\nConfigure a credential helper to remove this warning. See\nhttps://docs.docker.com/engine/reference/commandline/login/#credentials-store\n\nLogin Succeeded\n</code></pre>"},{"location":"docker/Install-Jar-Services/","title":"Install Jar Services","text":""},{"location":"docker/Install-Jar-Services/#compose-file","title":"Compose file","text":"<pre><code>version: '3'\nx-service-template: &amp;x-service-template\n  restart: always\n  extra_hosts:\n    - \"nacos-dev:192.168.1.12\"\n  environment:\n    SPRING_PROFILES_ACTIVE: dev\n    SPRING_CLOUD_NACOS_DISCOVERY_SERVER_ADDR: nacos-dev:8848\n    SPRING_CLOUD_NACOS_CONFIG_SERVER_ADDR: nacos-dev:8848\n    SPRING_CLOUD_NACOS_USERNAME: nacos\n    SPRING_CLOUD_NACOS_PASSWORD: nacos\n  volumes:\n    - /etc/localtime:/etc/localtime:ro\n  networks:\n  - app\n\nservices:\n  onemap:\n    &lt;&lt;: *x-service-template\n    build: ./onemap\n    container_name: onemap\n    ports:\n      - 8080:8080\n\nnetworks:\n  app:\n    external: false\n</code></pre>"},{"location":"docker/Install-Jar-Services/#dir-tree","title":"Dir tree","text":"<pre><code>$ ls  -lh\ntotal 182M\n-rw-r--r-- 1 PC 197121  619 Dec  8 10:47 docker-compose.yaml\n-rw-r--r-- 1 PC 197121 182M Dec  8 10:32 jdk.tar\ndrwxr-xr-x 1 PC 197121    0 Dec  8 10:44 onemap/\n\n\n$ ls  -lh onemap/\ntotal 1.0K\n-rw-r--r-- 1 PC 197121 615 Dec  8 10:37 Dockerfile\ndrwxr-xr-x 1 PC 197121   0 Dec  8 10:44 target/\n\n\n$ ls  -lh onemap/target/\ntotal 1.0K\n-rw-r--r-- 1 PC 197121 240 Dec  8 10:43 onemap.jar\n</code></pre>"},{"location":"docker/Install-Jar-Services/#dockerfile","title":"Dockerfile","text":"<pre><code>FROM harbor.dockerregistry.com/app/adoptopenjdk/openjdk8-openj9:alpine-slim-local2\n\nWORKDIR /home\nADD ./target/*.jar ./app.jar\n\n#RUN useradd -ms /bin/bash appuser\n#USER appuser\n\nCMD java -Djava.security.egd=file:/dev/./urandom -jar app.jar \\\n    --spring.profiles.active=$SPRING_PROFILES_ACTIVE \\\n    --spring.cloud.nacos.discovery.server-addr=$SPRING_CLOUD_NACOS_DISCOVERY_SERVER_ADDR \\\n    --spring.cloud.nacos.config.server-addr=$SPRING_CLOUD_NACOS_CONFIG_SERVER_ADDR \\\n    --spring.cloud.nacos.username=$SPRING_CLOUD_NACOS_USERNAME \\\n    --spring.cloud.nacos.password=$SPRING_CLOUD_NACOS_PASSWORD\n</code></pre>"},{"location":"docker/Install-Jar-Services/#start-service","title":"Start Service","text":"<pre><code>export COMPOSE_DOCKER_CLI_BUILD=0\nexport DOCKER_BUILDKIT=0\n\ndocker-compose up # \u6d4b\u8bd5\ndocker-compose down  # \u6e05\u7406\ndocker-compose up -d # \u542f\u52a8\n\ndocker login -u guest -p Guest@123.com harbor.dockerregistry.com\ndocker logout harbor.dockerregistry.com # /root/.docker/config.json\n</code></pre>"},{"location":"docker/Install-KubeSphere-Proxy/","title":"Install KubeSphere Proxy","text":""},{"location":"docker/Install-KubeSphere-Proxy/#proxy","title":"Proxy","text":"<pre><code># https://ask.kubesphere.io/forum/d/1075-kubersphere/4\n\n\n# Add deploy files.\nroot@harbor:~# mkdir -p /data/nginx/ &amp;&amp; cd /data/nginx/\n# upload files \n\nroot@harbor:/data/nginx# tree ks-console\nks-console\n\u251c\u2500\u2500 docker-compose.yaml\n\u2514\u2500\u2500 nginx\n    \u251c\u2500\u2500 conf.d\n    \u2502   \u2514\u2500\u2500 ks-console.conf\n    \u251c\u2500\u2500 nginx.conf\n    \u2514\u2500\u2500 ssl\n        \u251c\u2500\u2500 kubesphere.k8scluster.com.crt\n        \u2514\u2500\u2500 kubesphere.k8scluster.com.key\n\n3 directories, 5 files\n\n\n# Start svc\nroot@harbor:/data/nginx# cd ks-console/\n                                                                                                                                                                                               0.1s \nroot@harbor:/data/nginx/ks-console# docker-compose up -d \n[+] Running 2/2\n \u2714 Network ks-console_default  Created                                                                                                                                                                                                0.0s \n \u2714 Container ks-console-proxy  Started \n\n\n# Stop svc (if need.)\nroot@harbor:/data/nginx/ks-console# docker-compose down \n[+] Running 2/2\n \u2714 Container ks-console-proxy  Removed                                                                                                                                                                                                0.2s \n \u2714 Network ks-console_default  Removed \n\n\n# Status svc\nroot@harbor:/data/nginx/ks-console# docker-compose ps -a \nNAME               IMAGE                                                   COMMAND                  SERVICE   CREATED              STATUS                        PORTS\nks-console-proxy   harbor.dockerregistry.com/library/nginx:1.21.6-alpine   \"/docker-entrypoint.\u2026\"   web       About a minute ago   Up About a minute (healthy)   0.0.0.0:8080-&gt;8080/tcp, :::8080-&gt;8080/tcp, 80/tcp, 0.0.0.0:8443-&gt;8443/tcp, :::8443-&gt;8443/tcp\nroot@harbor:/data/nginx/ks-console# \n</code></pre>"},{"location":"docker/Install-KubeSphere-Proxy/#logs-rotate","title":"logs rotate","text":"<pre><code>tee /etc/logrotate.d/nginx &lt;&lt;-eof\n/data/nginx/logs/access.log /data/nginx/logs/error.log {\n    daily\n    rotate 7\n    missingok\n    dateext\n    compress\n    notifempty\n    create 0644 root root\n    sharedscripts\n    postrotate\n        /usr/bin/docker-compose -f /data/nginx/ks-console/docker-compose.yaml exec -T web nginx -s reload\n    endscript\n}\neof\n\nroot@harbor:~/ks-console# cat /etc/logrotate.d/nginx \n/data/nginx/logs/access.log /data/nginx/logs/error.log {\n    daily\n    rotate 7\n    missingok\n    dateext\n    compress\n    notifempty\n    create 0644 root root\n    sharedscripts\n    postrotate\n        /usr/bin/docker-compose -f /data/nginx/ks-console/docker-compose.yaml exec -T web nginx -s reload\n    endscript\n}\n\n\n# test logrotate\nroot@harbor:/data/nginx/ks-console# /usr/sbin/logrotate -d /etc/logrotate.d/nginx\nWARNING: logrotate in debug mode does nothing except printing debug messages!  Consider using verbose mode (-v) instead if this is not what you want.\n\nreading config file /etc/logrotate.d/nginx\nReading state from file: /var/lib/logrotate/status\nAllocating hash table for state file, size 64 entries\nCreating new state\nCreating new state\nCreating new state\nCreating new state\nCreating new state\nCreating new state\nCreating new state\nCreating new state\nCreating new state\nCreating new state\nCreating new state\nCreating new state\nCreating new state\nCreating new state\nCreating new state\nCreating new state\nCreating new state\nCreating new state\nCreating new state\nCreating new state\nCreating new state\nCreating new state\nCreating new state\nCreating new state\nCreating new state\nCreating new state\n\nHandling 1 logs\n\nrotating pattern: /data/nginx/logs/access.log /data/nginx/logs/error.log  after 1 days (7 rotations)\nempty log files are not rotated, old logs are removed\nconsidering log /data/nginx/logs/access.log\n  Now: 2023-12-06 10:06\n  Last rotated at 2023-12-06 10:00\n  log does not need rotating (log has already been rotated)\nconsidering log /data/nginx/logs/error.log\n  Now: 2023-12-06 10:06\n  Last rotated at 2023-12-06 10:00\n  log does not need rotating (log has already been rotated)\nnot running postrotate script, since no logs were rotated\n</code></pre>"},{"location":"docker/Install-KubeSphere-Proxy/#cron","title":"cron","text":"<pre><code>root@harbor:~/ks-console# crontab -e\ncrontab: installing new crontab\n\nroot@harbor:~/ks-console# crontab -l\n0 2 * * * /usr/sbin/logrotate /etc/logrotate.d/nginx\n</code></pre>"},{"location":"docker/Install-KubeSphere-Proxy/#ks-consoleconf","title":"ks-console.conf","text":"<pre><code>upstream backend {\n    server 10.0.0.1:30880 max_fails=3 fail_timeout=30s;\n    server 10.0.0.2:30880 max_fails=3 fail_timeout=30s;\n    server 10.0.0.3:30880 max_fails=3 fail_timeout=30s;\n}\n\n# HTTP server\nserver {\n    listen 80;\n\n    server_name kubesphere.k8scluster.com;\n\n    location / {\n        return 301 https://$host:443$request_uri;\n    }\n}\n\n# HTTPS server\nserver {\n    listen 443 ssl;\n\n    server_name kubesphere.k8scluster.com;\n\n    #include ssl-conf/ssl-full.loadttl.com.conf;\n\n    access_log /var/log/nginx/ks-console-access.log main;\n    error_log  /var/log/nginx/ks-console-error.log;\n\n    index index.html index.htm;\n\n    ssl_certificate     /etc/nginx/ssl/ks-console/kubesphere.k8scluster.com.crt;\n    ssl_certificate_key /etc/nginx/ssl/ks-console/kubesphere.k8scluster.com.key;\n\n    ssl_protocols TLSv1.2 TLSv1.3;\n    ssl_prefer_server_ciphers on;\n    ssl_ciphers \"EECDH+AESGCM:EDH+AESGCM:AES256+EECDH:AES256+EDH\";\n    ssl_ecdh_curve secp384r1;\n    ssl_session_cache shared:SSL:10m;\n    ssl_session_tickets off;\n    #ssl_stapling on;\n    #ssl_stapling_verify on;\n    add_header Strict-Transport-Security \"max-age=63072000; includeSubDomains\";\n    add_header X-Frame-Options DENY;\n    add_header X-Content-Type-Options nosniff;\n\n    index index.html index.htm;\n    if ($ssl_protocol = \"\") { return 301 https://$host$request_uri; }\n\n    # Define global proxy settings\n    proxy_http_version 1.1;\n    proxy_set_header    Host $host:$server_port;\n    proxy_set_header    X-Real-IP $remote_addr;\n    proxy_set_header    X-Forwarded-For $proxy_add_x_forwarded_for;\n    proxy_connect_timeout  3600s;\n    proxy_read_timeout  3600s;\n    proxy_send_timeout  3600s;\n    send_timeout  3600s;\n\n    location / {\n        proxy_pass http://backend;\n        proxy_redirect off;\n    }\n\n    location /api/ {\n        proxy_redirect off;\n        proxy_pass http://backend;\n        proxy_set_header    Upgrade $http_upgrade;\n        proxy_set_header    X-Forwarded-Proto $scheme;\n        proxy_set_header    Connection \"upgrade\";\n    }\n\n    location ~ /apis/monitoring.coreos.com/|/api/v1/|/apis/storage.k8s.io|/apis/apps/v1/namespaces/|/kapis/resources.kubesphere.io/v1alpha2/namespaces|/kapis/resources.kubesphere.io/|/apis/devops.kubesphere.io/|/apis/apps/v1/|/apis/|/api/v1/watch/namespaces|/kapis/terminal.kubesphere.io/ {\n        proxy_pass http://backend;\n        proxy_redirect off;\n    }\n}\n</code></pre>"},{"location":"docker/Install-Minio-Cluster/","title":"Install Minio Cluster","text":""},{"location":"docker/Install-Minio-Cluster/#minio","title":"\u90e8\u7f72Minio\u96c6\u7fa4","text":"<p> \u8fd9\u91cc\u90e8\u7f72\u548c\u7ef4\u62a4\u90fd\u662f\u5728/root \u76ee\u5f55\u4e0b\uff0c\u64cd\u4f5c\u90fd\u662f\u4f7f\u7528<code>root</code>\u7528\u6237\uff0c\u8bf7\u7559\u610f\u3002</p> <p> \u5982\u679c\u6761\u4ef6\u5141\u8bb8\uff0c\u5efa\u8bae\u5404\u4e2a\u96c6\u7fa4\u90fd\u80fd\u72ec\u81ea\u4f7f\u7528\u81ea\u5df1\u7684\u670d\u52a1\u5668\u8d44\u6e90\uff0c\u800c\u975e\u4e0e\u5176\u4ed6\u96c6\u7fa4\u5171\u4eab\uff0c\u4ee5\u514d\u9ad8\u8d1f\u8f7d\u65f6\u5b58\u5728\u8d44\u6e90\u4e89\u62a2\u5bfc\u81f4\u6545\u969c\u7684\u95ee\u9898\u3002</p> <p>\u96c6\u7fa4\u6a21\u5f0f\uff1a\u591a\u5b9e\u4f8b\u5206\u5e03\u5f0f\u96c6\u7fa4</p> <p>\u8fd9\u91cc\u7684\u65b9\u6848\u662f\u4e00\u4e2a\u5206\u5e03\u5f0f\u7684 MinIO \u5bf9\u8c61\u5b58\u50a8\u96c6\u7fa4\uff0c\u91c7\u7528\u4e86\u591a\u5b9e\u4f8b\u90e8\u7f72\u6a21\u5f0f\u3002\u8fd9\u79cd\u90e8\u7f72\u6a21\u5f0f\u6709\u4ee5\u4e0b\u4eae\u70b9\u4f18\u52bf\uff1a</p> <ol> <li> <p>\u9ad8\u53ef\u7528\u6027\uff1a\u901a\u8fc7\u90e8\u7f72\u591a\u4e2a MinIO \u5b9e\u4f8b\uff0c\u53ef\u4ee5\u5b9e\u73b0\u9ad8\u53ef\u7528\u6027\u3002\u5982\u679c\u4e00\u4e2a\u5b9e\u4f8b\u51fa\u73b0\u6545\u969c\uff0c\u5176\u4ed6\u5b9e\u4f8b\u4ecd\u7136\u53ef\u4ee5\u7ee7\u7eed\u63d0\u4f9b\u670d\u52a1\uff0c\u786e\u4fdd\u7cfb\u7edf\u7684\u7a33\u5b9a\u6027\u548c\u53ef\u7528\u6027\u3002</p> </li> <li> <p>\u8d1f\u8f7d\u5747\u8861\uff1a\u4f7f\u7528 Nginx \u53cd\u5411\u4ee3\u7406\u5b9e\u73b0\u8d1f\u8f7d\u5747\u8861\uff0c\u5c06\u5ba2\u6237\u7aef\u8bf7\u6c42\u5206\u53d1\u5230\u591a\u4e2a MinIO \u5b9e\u4f8b\u4e0a\u3002\u8fd9\u6709\u52a9\u4e8e\u63d0\u9ad8\u6027\u80fd\u5e76\u907f\u514d\u5355\u70b9\u6545\u969c\u3002</p> </li> <li> <p>\u6570\u636e\u5197\u4f59\uff1a\u901a\u8fc7\u5c06\u6570\u636e\u5b58\u50a8\u5728\u591a\u4e2a\u6570\u636e\u5377\u4e0a\uff0c\u5b9e\u73b0\u4e86\u6570\u636e\u5197\u4f59\u548c\u5bb9\u9519\u6027\u3002\u5373\u4f7f\u67d0\u4e2a\u6570\u636e\u5377\u51fa\u73b0\u95ee\u9898\uff0c\u6570\u636e\u4ecd\u7136\u53ef\u4ee5\u4ece\u5176\u4ed6\u6570\u636e\u5377\u4e2d\u6062\u590d\u3002</p> </li> <li> <p>\u53ef\u6269\u5c55\u6027\uff1a\u91c7\u7528\u4e86\u5bb9\u5668\u5316\u90e8\u7f72\uff0c\u53ef\u4ee5\u76f8\u5bf9\u5bb9\u6613\u5730\u6269\u5c55\u96c6\u7fa4\u89c4\u6a21\uff0c\u4ee5\u6ee1\u8db3\u4e0d\u65ad\u589e\u957f\u7684\u5b58\u50a8\u9700\u6c42\u3002</p> </li> </ol> <p>\u603b\u7684\u6765\u8bf4\uff0c\u8fd9\u79cd\u90e8\u7f72\u6a21\u5f0f\u80fd\u591f\u63d0\u4f9b\u9ad8\u53ef\u7528\u6027\u3001\u8d1f\u8f7d\u5747\u8861\u3001\u6570\u636e\u5197\u4f59\u548c\u53ef\u6269\u5c55\u6027\uff0c\u9002\u7528\u4e8e\u9700\u8981\u5927\u89c4\u6a21\u5b58\u50a8\u548c\u9ad8\u6027\u80fd\u7684\u5e94\u7528\u573a\u666f\uff0c\u540c\u65f6\u4e5f\u80fd\u591f\u5e94\u5bf9\u786c\u4ef6\u6545\u969c\u548c\u6570\u636e\u4e22\u5931\u7684\u98ce\u9669\u3002</p>"},{"location":"docker/Install-Minio-Cluster/#11","title":"1.1 \u4f7f\u7528\u65b9\u5f0f","text":"<pre><code># \u4e0a\u4f20\u9644\u4ef6\u76ee\u5f55\uff1aminio-cluster \u5230/root\n\n# \u67e5\u770b\u6587\u4ef6\nroot@deepin-1:~/minio-cluster# ls -lha\ntotal 67M\ndrwxr-xr-x 2 root root 4.0K Jan 19 12:01 .\ndrwx------ 6 root root 4.0K Jan 19 12:01 ..\n-rw-r--r-- 1 root root 1.5K Jan 19 11:59 docker-compose.yaml\n-rw-r--r-- 1 root root  183 Jan 18 09:35 .env.example\n-rw-r--r-- 1 root root  50M Jan 19 10:59 minio.tar.gz\n-rw-r--r-- 1 root root 3.0K Jan 19 10:56 nginx.conf\n-rw-r--r-- 1 root root  17M Jan 19 11:03 nginx.tar.gz\n\ndocker load -i minio.tar.gz \ncp .env.example .env\nvim .env # \u8bf7\u7ed3\u5408\u81ea\u5df1\u7684\u60c5\u51b5\u4fee\u6539\u914d\u7f6e\u540e\u518d\u542f\u52a8\ndocker-compose up -d\n</code></pre> <p>\u542f\u52a8\u5b8c\u6210</p> <pre><code>root@deepin-1:~/minio-cluster# docker-compose ps -a\nNAME                     IMAGE                                              COMMAND                  SERVICE   CREATED         STATUS                   PORTS\nminio-cluster-minio1-1   quay.io/minio/minio:RELEASE.2024-01-16T16-07-38Z   \"/usr/bin/docker-ent\u2026\"   minio1    6 minutes ago   Up 6 minutes (healthy)   9000-9001/tcp\nminio-cluster-minio2-1   quay.io/minio/minio:RELEASE.2024-01-16T16-07-38Z   \"/usr/bin/docker-ent\u2026\"   minio2    6 minutes ago   Up 6 minutes (healthy)   9000-9001/tcp\nminio-cluster-minio3-1   quay.io/minio/minio:RELEASE.2024-01-16T16-07-38Z   \"/usr/bin/docker-ent\u2026\"   minio3    6 minutes ago   Up 6 minutes (healthy)   9000-9001/tcp\nminio-cluster-minio4-1   quay.io/minio/minio:RELEASE.2024-01-16T16-07-38Z   \"/usr/bin/docker-ent\u2026\"   minio4    6 minutes ago   Up 6 minutes (healthy)   9000-9001/tcp\nminio-cluster-nginx-1    nginx:1.25.3-alpine                                \"/docker-entrypoint.\u2026\"   nginx     6 minutes ago   Up 6 minutes             80/tcp, 0.0.0.0:9000-9001-&gt;9000-9001/tcp\n</code></pre>"},{"location":"docker/Install-Minio-Cluster/#12","title":"1.2 \u90e8\u7f72\u6a21\u677f","text":"<p>\u8fd9\u91cc\u56e0\u4e3a\u672c\u5730\u7cfb\u7edf\u7684\u78c1\u76d8\u6570\u91cf\u4e0d\u540c\uff0c\u800c\u6709\u4e0d\u540c\u7684\u90e8\u7f72\u65b9\u5f0f\uff0c\u53c2\u8003\u8fd9\u91cc\u6a21\u677f\u4fee\u6539\u4e3a\u4f60\u81ea\u5df1\u7b26\u5408\u81ea\u5df1\u5b9e\u9645\u9700\u8981\u7684\u5373\u53ef\u3002</p> <p>  \u751f\u4ea7\u73af\u5883\u5efa\u8bae\u81f3\u5c112\u5757\u78c1\u76d8\uff0c\u5bf9\u6027\u80fd\u5982\u679c\u6709\u8981\u6c42\uff0c\u8bf7\u81f3\u5c11\u4f7f\u7528SSD\u78c1\u76d8, \u66f4\u9ad8\u8981\u6c42\u53ef\u4ee5\u4f7f\u7528NVMe SSD\u3002</p> <p>\u5982\u4f55\u67e5\u770b\u78c1\u76d8\uff1f</p> <pre><code># \u5982\u8fd9\u91ccsda \u662f\u7cfb\u7edf\u76d8,sdb\u662f\u6570\u636e\u76d8\n# \u4f60\u6240\u9700\u8981\u7684\u5c31\u662f\u8981\u786e\u4fdd\u81ea\u5df1\u7cfb\u7edf\u6709\u591a\u5757sdb\u8fd9\u6837\u7684\u6570\u636e\u76d8\uff0c\u8fd9\u91cc\u662f\u505a\u4e86LVM \u65b9\u4fbf\u540e\u671f\u6269\u5c55\u78c1\u76d8\u7684\u3002\nroot@debian:~# lsblk \nNAME                MAJ:MIN RM  SIZE RO TYPE MOUNTPOINT\nsda                   8:0    0  100G  0 disk   \n\u251c\u2500sda1                8:1    0 74.5G  0 part /\n\u251c\u2500sda2                8:2    0    1K  0 part \n\u251c\u2500sda5                8:5    0  9.3G  0 part /var\n\u251c\u2500sda6                8:6    0  9.3G  0 part /tmp\n\u2514\u2500sda7                8:7    0  6.9G  0 part /boot\nsdb                   8:16   0  300G  0 disk \n\u2514\u2500sdb1                8:17   0  300G  0 part \n  \u2514\u2500data_vg-data_lv 254:0    0  300G  0 lvm  /data\n\n\n# \u8fd9\u91cc\u662f\u5355\u7eaf\u5212\u76d8\uff0c\u65e0\u903b\u8f91\u6269\u5c55\u80fd\u529b\u7684\u88f8\u6570\u636e\u76d8\u3002\nroot@debian:~# lsblk \nNAME   MAJ:MIN RM  SIZE RO TYPE MOUNTPOINT\nsda      8:0    0  100G  0 disk \n\u251c\u2500sda1   8:1    0 74.5G  0 part /\n\u251c\u2500sda2   8:2    0    1K  0 part \n\u251c\u2500sda5   8:5    0  9.3G  0 part /var\n\u251c\u2500sda6   8:6    0  9.3G  0 part /tmp\n\u2514\u2500sda7   8:7    0  6.9G  0 part /boot\nsdb      8:16   0  200G  0 disk \n\u2514\u2500sdb1   8:17   0  200G  0 part /data\n\n# \u65e0\u8bba\u54ea\u4e00\u79cd\uff0c\u8bf7\u6839\u636e\u81ea\u5df1\u7684\u60c5\u51b5\u4f7f\u7528\u5373\u53ef\u3002\n</code></pre> <p>\u7b2c\u4e00\u79cd\uff1a\u4e00\u5757\u78c1\u76d8</p> <p>\u5982\u679c\u53ea\u6709\u4e00\u5757\u78c1\u76d8\uff0c\u5e76\u4e14\u60a8\u5e0c\u671b\u6240\u6709\u7684 MinIO \u5b9e\u4f8b\u90fd\u4f7f\u7528\u8fd9\u5757\u78c1\u76d8\uff0c\u90a3\u4e48\u60a8\u53ef\u4ee5\u4e3a\u6bcf\u4e2a\u5b9e\u4f8b\u521b\u5efa\u4e00\u4e2a\u76ee\u5f55\u6765\u6a21\u62df\u591a\u4e2a\u78c1\u76d8\u3002\u8fd9\u91cc\u662f\u5982\u4f55\u5728 <code>docker-compose.yaml</code> \u6587\u4ef6\u4e2d\u914d\u7f6e\u5355\u78c1\u76d8\u60c5\u51b5\u7684\u793a\u4f8b</p> <pre><code>services:\n  minio1:\n    &lt;&lt;: *minio-common\n    hostname: minio1\n    volumes:\n      - /mnt/disk1/minio1/data1:/data1\n      - /mnt/disk1/minio1/data2:/data2\n\n  minio2:\n    &lt;&lt;: *minio-common\n    hostname: minio2\n    volumes:\n      - /mnt/disk1/minio2/data1:/data1\n      - /mnt/disk1/minio2/data2:/data2\n\n  minio3:\n    &lt;&lt;: *minio-common\n    hostname: minio3\n    volumes:\n      - /mnt/disk1/minio3/data1:/data1\n      - /mnt/disk1/minio3/data2:/data2\n\n  minio4:\n    &lt;&lt;: *minio-common\n    hostname: minio4\n    volumes:\n      - /mnt/disk1/minio4/data1:/data1\n      - /mnt/disk1/minio4/data2:/data2\n</code></pre> <p>\u7b2c\u4e8c\u79cd\uff1a\u4e24\u5757\u78c1\u76d8</p> <p>\u6240\u6709 MinIO \u5b9e\u4f8b\u90fd\u5171\u4eab\u8fd9\u4e24\u4e2a\u78c1\u76d8\uff0c\u6bcf\u4e2a\u5b9e\u4f8b\u4f7f\u7528\u78c1\u76d8\u7684\u4e0d\u540c\u76ee\u5f55\u3002</p> <pre><code>services:\n  minio1:\n    &lt;&lt;: *minio-common\n    hostname: minio1\n    volumes:\n      - /mnt/disk1/part1:/data1\n      - /mnt/disk2/part1:/data2\n\n  minio2:\n    &lt;&lt;: *minio-common\n    hostname: minio2\n    volumes:\n      - /mnt/disk1/part2:/data1\n      - /mnt/disk2/part2:/data2\n\n  minio3:\n    &lt;&lt;: *minio-common\n    hostname: minio3\n    volumes:\n      - /mnt/disk1/part3:/data1\n      - /mnt/disk2/part3:/data2\n\n  minio4:\n    &lt;&lt;: *minio-common\n    hostname: minio4\n    volumes:\n      - /mnt/disk1/part4:/data1\n      - /mnt/disk2/part4:/data2\n</code></pre> <p>\u7b2c\u4e09\u79cd\uff1a\u56db\u5757\u78c1\u76d8</p> <p>\u6bcf\u4e24\u4e2a MinIO \u5b9e\u4f8b\u5171\u4eab\u4e00\u4e2a\u78c1\u76d8\uff0c\u6bcf\u4e2a\u5b9e\u4f8b\u4f7f\u7528\u78c1\u76d8\u7684\u4e0d\u540c\u76ee\u5f55\u3002</p> <pre><code>services:\n  minio1:\n    &lt;&lt;: *minio-common\n    hostname: minio1\n    volumes:\n      - /mnt/disk1/part1:/data1\n      - /mnt/disk2/part1:/data2\n\n  minio2:\n    &lt;&lt;: *minio-common\n    hostname: minio2\n    volumes:\n      - /mnt/disk1/part2:/data1\n      - /mnt/disk2/part2:/data2\n\n  minio3:\n    &lt;&lt;: *minio-common\n    hostname: minio3\n    volumes:\n      - /mnt/disk3/part1:/data1\n      - /mnt/disk4/part1:/data2\n\n  minio4:\n    &lt;&lt;: *minio-common\n    hostname: minio4\n    volumes:\n      - /mnt/disk3/part2:/data1\n      - /mnt/disk4/part2:/data2\n</code></pre> <p>\u7b2c\u56db\u79cd\uff1a\u516b\u5757\u78c1\u76d8</p> <p>\u6bcf\u4e2a MinIO \u5b9e\u4f8b\u5c06\u76f4\u63a5\u6620\u5c04\u5230\u4e24\u4e2a\u78c1\u76d8\u7684\u8def\u5f84\u3002</p> <pre><code>services:\n  minio1:\n    &lt;&lt;: *minio-common\n    hostname: minio1\n    volumes:\n      - /mnt/disk1:/data1\n      - /mnt/disk2:/data2\n\n  minio2:\n    &lt;&lt;: *minio-common\n    hostname: minio2\n    volumes:\n      - /mnt/disk3:/data1\n      - /mnt/disk4:/data2\n\n  minio3:\n    &lt;&lt;: *minio-common\n    hostname: minio3\n    volumes:\n      - /mnt/disk5:/data1\n      - /mnt/disk6:/data2\n\n  minio4:\n    &lt;&lt;: *minio-common\n    hostname: minio4\n    volumes:\n      - /mnt/disk7:/data1\n      - /mnt/disk8:/data2\n</code></pre>"},{"location":"docker/Install-Minio-Cluster/#13","title":"1.3 \u67e5\u770b\u6570\u636e","text":"<pre><code># \u56e0\u4e3a\u6211\u8fd9\u91cc\u53ea\u6709\u4e00\u5757\u78c1\u76d8\uff0c\u6240\u4ee5\u770b\u5230\u6570\u636e\u7684\u90fd\u5728\u540c\u4e2a\u6570\u636e\u76d8\u91cc\nroot@deepin-1:~/minio-cluster# ls -lha /data/minio*/*/*\n/data/minio1/data2/demo:\ntotal 12K\ndrwxr-xr-x 3 root root 4.0K Jan 19 12:04 .\ndrwxr-xr-x 4 root root 4.0K Jan 19 12:03 ..\ndrwxr-xr-x 2 root root 4.0K Jan 19 12:04 nginx.conf\n\n/data/minio2/data1/demo:\ntotal 12K\ndrwxr-xr-x 3 root root 4.0K Jan 19 12:04 .\ndrwxr-xr-x 4 root root 4.0K Jan 19 12:03 ..\ndrwxr-xr-x 2 root root 4.0K Jan 19 12:04 nginx.conf\n\n/data/minio2/data2/demo:\ntotal 12K\ndrwxr-xr-x 3 root root 4.0K Jan 19 12:04 .\ndrwxr-xr-x 4 root root 4.0K Jan 19 12:03 ..\ndrwxr-xr-x 2 root root 4.0K Jan 19 12:04 nginx.conf\n\n/data/minio3/data1/demo:\ntotal 12K\ndrwxr-xr-x 3 root root 4.0K Jan 19 12:04 .\ndrwxr-xr-x 4 root root 4.0K Jan 19 12:03 ..\ndrwxr-xr-x 2 root root 4.0K Jan 19 12:04 nginx.conf\n\n/data/minio3/data2/demo:\ntotal 12K\ndrwxr-xr-x 3 root root 4.0K Jan 19 12:04 .\ndrwxr-xr-x 4 root root 4.0K Jan 19 12:03 ..\ndrwxr-xr-x 2 root root 4.0K Jan 19 12:04 nginx.conf\n\n/data/minio4/data1/demo:\ntotal 12K\ndrwxr-xr-x 3 root root 4.0K Jan 19 12:04 .\ndrwxr-xr-x 4 root root 4.0K Jan 19 12:03 ..\ndrwxr-xr-x 2 root root 4.0K Jan 19 12:04 nginx.conf\n\n/data/minio4/data2/demo:\ntotal 12K\ndrwxr-xr-x 3 root root 4.0K Jan 19 12:04 .\ndrwxr-xr-x 4 root root 4.0K Jan 19 12:03 ..\ndrwxr-xr-x 2 root root 4.0K Jan 19 12:04 nginx.conf\n</code></pre>"},{"location":"docker/Install-Minio/","title":"Install Minio","text":""},{"location":"docker/Install-Minio/#compose-file","title":"Compose file","text":"<pre><code>version: '3'\nservices:\n  minio:\n    image: harbor.dockerregistry.com/app/minio:latest\n    container_name: minio\n    ports:\n      - 9000:9000\n      - 9091:9091\n    command: server /data --console-address \":9091\"\n    environment:\n      MINIO_ROOT_USER: admin\n      MINIO_ROOT_PASSWORD: admin@123\n    volumes:\n      - /etc/localtime:/etc/localtime:ro\n      - /data/middleware/minio/data:/data\n</code></pre>"},{"location":"docker/Install-Minio/#physical-deployment","title":"Physical deployment","text":""},{"location":"docker/Install-Minio/#1-install-minio","title":"1 Install Minio","text":"<pre><code># https://min.io/docs/minio/linux/index.html\n\n# wget https://dl.min.io/server/minio/release/linux-amd64/archive/minio_20231120224007.0.0_amd64.deb -O minio.deb\n# upload files\nroot@harbor:~# ls -lh minio_20231120224007.0.0_amd64.deb \n-rw-r--r-- 1 root root 35M Dec  6 10:33 minio_20231120224007.0.0_amd64.deb\n\nroot@harbor:~# dpkg -i minio_20231120224007.0.0_amd64.deb \nSelecting previously unselected package minio.\n(Reading database ... 40297 files and directories currently installed.)\nPreparing to unpack minio_20231120224007.0.0_amd64.deb ...\nUnpacking minio (20231120224007.0.0) ...\nSetting up minio (20231120224007.0.0) ...\n</code></pre>"},{"location":"docker/Install-Minio/#2-install-client-optional","title":"2 Install Client (Optional)","text":"<pre><code># wget https://dl.min.io/client/mc/release/linux-amd64/mc\n# upload file.\nroot@harbor:~# ls mc \nmc\n\n\n\nroot@harbor:~# chmod +x mc\nroot@harbor:~# mv mc /usr/local/bin/mc\nroot@harbor:~# mc -v \nmc version RELEASE.2023-12-02T02-03-28Z (commit-id=f5f7147b9ec4cf78eb67f1cdc91b63d191852e6a)\nRuntime: go1.21.4 linux/amd64\nCopyright (c) 2015-2023 MinIO, Inc.\nLicense GNU AGPLv3 &lt;https://www.gnu.org/licenses/agpl-3.0.html&gt;\n</code></pre>"},{"location":"docker/Install-Minio/#3-create-ca","title":"3 Create ca","text":"<pre><code># https://min.io/docs/minio/linux/operations/install-deploy-manage/upgrade-minio-deployment.html#minio-upgrade-systemctl\n# mkdir /data/minio\n# minio server /data/minio --console-address :9090\n\n# rootCA.key\uff1aCA\uff08\u8bc1\u4e66\u9881\u53d1\u673a\u6784\uff09\u7684\u79c1\u94a5\n# rootCA.crt\uff1a\u81ea\u7b7e\u540d\u7684\u6839\u8bc1\u4e66\n# server.key\uff1a\u670d\u52a1\u5668\u7684\u79c1\u94a5\n# server.csr\uff1a\u670d\u52a1\u5668\u8bc1\u4e66\u7b7e\u540d\u8bf7\u6c42\n# server.crt\uff1a\u670d\u52a1\u5668\u8bc1\u4e66\n\nmkdir -p /etc/minio/ssl/certs &amp;&amp; cd /etc/minio/ssl/certs\n\n\n# change here ip addr to yourself\ntee openssl-ca.cnf &lt;&lt;-eof\n[req]\ndistinguished_name = req_distinguished_name\nx509_extensions = v3_ca\ndefault_days = 3650\ndefault_md = sha256\nprompt = no\n\n[req_distinguished_name]\nCN = My Root CA\n\n[v3_ca]\nsubjectKeyIdentifier=hash\nauthorityKeyIdentifier=keyid:always,issuer\nbasicConstraints = critical, CA:true\neof\n\ntee openssl-server.cnf &lt;&lt;-eof\n[req]\ndistinguished_name = req_distinguished_name\nx509_extensions = v3_req\nprompt = no\ndefault_days = 3650\ndefault_md = sha256\n\n[req_distinguished_name]\nCN = minio.objectstorage.com\n\n[v3_req]\nkeyUsage = digitalSignature, keyEncipherment\nextendedKeyUsage = serverAuth\nsubjectAltName = @alt_names\n\n[alt_names]\nDNS.1 = minio.objectstorage.com\nIP.1 = 192.0.2.1\neof\n\n# \u5236\u4f5c\u8bc1\u4e66\nopenssl genrsa -out rootCA.key 2048 # \u521b\u5efaCA\u7684\u79c1\u94a5\nopenssl req -x509 -new -nodes -key rootCA.key -sha256 -days 3650 -out rootCA.crt -config openssl-ca.cnf # \u521b\u5efa\u5e76\u81ea\u7b7e\u540d\u6839\u8bc1\u4e66(CA)\n\nopenssl genrsa -out server.key 2048 # \u521b\u5efa\u670d\u52a1\u5668\u7684\u79c1\u94a5\nopenssl req -new -key server.key -out server.csr -config openssl-server.cnf # \u521b\u5efa\u670d\u52a1\u5668\u8bc1\u4e66\u7b7e\u540d\u8bf7\u6c42(CSR)\nopenssl x509 -req -in server.csr -CA rootCA.crt -CAkey rootCA.key -CAcreateserial -out server.crt -days 3650 -sha256 -extensions v3_req -extfile openssl-server.cnf\n\n\nmv server.key private.key\nmv server.crt public.crt\n</code></pre>"},{"location":"docker/Install-Minio/#4-create-config","title":"4 Create config","text":"<pre><code>mkdir -p /data/minio\ntee /etc/default/minio &lt;&lt;-eof\n# templates/minio.j2\nMINIO_ROOT_USER=admin\nMINIO_ROOT_PASSWORD=admin@123\nMINIO_VOLUMES=\"/data/minio\"\n#MINIO_SERVER_URL=\"http://minio.objectstorage.com:9000\"\n#MINIO_OPTS=\"--address :9000 --console-address :9001\"\nMINIO_SERVER_URL=\"https://minio.objectstorage.com:9000\"\nMINIO_OPTS=\"--address :9000 --certs-dir /etc/minio/ssl/certs --console-address :9001\"\neof\n\nuseradd -r minio-user -s /sbin/nologin\nchown -R minio-user:minio-user /data/minio\nchown -R minio-user.minio-user /etc/minio \n</code></pre>"},{"location":"docker/Install-Minio/#5-start-service","title":"5 Start service","text":"<pre><code>systemctl start minio\nsystemctl enable minio\n</code></pre>"},{"location":"docker/Install-Minio/#6-install-proxy","title":"6 Install proxy","text":"<pre><code># https://github.com/minio/minio/blob/master/docs/orchestration/docker-compose/nginx.conf\n\n# openssl req -x509 -newkey rsa:2048 -sha256 -nodes \\\n#     -keyout minio.objectstorage.com.key \\\n#     -days 3650 \\\n#     -subj \"/C=CN/ST=Guangdong/L=Guangzhou/O=My Organization/OU=My Unit/CN=minio.objectstorage.com\" \\\n#     -out minio.objectstorage.com.crt \\\n#     -extensions SAN \\\n#     -config &lt;(echo \"[req]\"; \n#               echo distinguished_name=req; \n#               echo \"[SAN]\"; \n#               echo subjectAltName=DNS:minio.objectstorage.com)\n\n\n# upload files.\nroot@harbor:/data/nginx/web# tree .\n.\n\u251c\u2500\u2500 docker-compose.yaml\n\u2514\u2500\u2500 nginx\n    \u251c\u2500\u2500 conf.d\n    \u2502   \u2514\u2500\u2500 minio.conf\n    \u251c\u2500\u2500 nginx.conf\n    \u2514\u2500\u2500 ssl\n        \u2514\u2500\u2500 minio\n            \u251c\u2500\u2500 minio.objectstorage.com.crt\n            \u2514\u2500\u2500 minio.objectstorage.com.key\n\n5 directories, 8 files\n\n\n# svc up\nroot@harbor:/data/nginx/web# docker-compose up -d \n[+] Running 1/0\n \u2714 Container proxy  Running   \n\n\n# svc status\nroot@harbor:/data/nginx/web# docker-compose ps -a \nNAME      IMAGE                                                   COMMAND                  SERVICE   CREATED         STATUS                   PORTS\nproxy     harbor.dockerregistry.com/library/nginx:1.21.6-alpine   \"/docker-entrypoint.\u2026\"   web       4 minutes ago   Up 4 minutes (healthy)   0.0.0.0:9090-&gt;9090/tcp, :::9090-&gt;9090/tcp, 0.0.0.0:9443-&gt;9443/tcp, :::9443-&gt;9443/tcp, 0.0.0.0:8080-&gt;80/tcp, :::8080-&gt;80/tcp, 0.0.0.0:8443-&gt;443/tcp, :::8443-&gt;443/tcp\n\n\n\n# logs dir\nroot@harbor:/data/nginx/web# ls -lh /data/nginx/logs/\ntotal 20K\n-rw-r--r-- 1 root root    0 Dec  6 15:49 access.log\n-rw-r--r-- 1 root root    0 Dec  6 15:49 error.log\n-rw-r--r-- 1 root root 9.1K Dec  6 15:53 ks-console-access.log\n-rw-r--r-- 1 root root    0 Dec  6 15:49 ks-console-error.log\n-rw-r--r-- 1 root root 5.7K Dec  6 15:53 minio-access.log\n-rw-r--r-- 1 root root    0 Dec  6 15:49 minio-error.logs\n</code></pre>"},{"location":"docker/Install-Minio/#7-compose-file","title":"7 Compose file","text":"<pre><code>version: '3.8'\nservices:\n  web:\n    image: harbor.dockerregistry.com/library/nginx:1.21.6-alpine\n    extra_hosts:\n      - \"minio.objectstorage.com:192.168.1.120\"\n    container_name: proxy\n    networks:\n      - web\n    ports:\n      - \"8080:80\"\n      - \"9090:9090\"\n      - \"8443:443\"\n      - \"9443:9443\"\n    volumes:\n      - '/etc/localtime:/etc/localtime:ro'\n      - './nginx/ssl:/etc/nginx/ssl'\n      - './nginx/nginx.conf:/etc/nginx/nginx.conf'\n      - './nginx/conf.d/ks-console.conf:/etc/nginx/conf.d/default.conf'\n      - './nginx/conf.d/minio.conf:/etc/nginx/conf.d/minio.conf'\n      - '/data/nginx/logs:/var/log/nginx'\n    restart: always\n    healthcheck:\n      test: [\"CMD-SHELL\", \"curl --silent --fail --insecure https://localhost:8443 || curl --silent --fail --insecure https://localhost:9443 || exit 1\"]\n      interval: 1m30s\n      timeout: 10s\n      retries: 3\n      start_period: 3s\n\nnetworks:\n  web:\n    external: false\n</code></pre>"},{"location":"docker/Install-Minio/#8-nginxconf","title":"8 Nginx.conf","text":"<pre><code>user  nginx;\nworker_processes  auto;\n\n#error_log  /var/log/nginx/error.log notice;\npid        /var/run/nginx.pid;\n\n\nevents {\n    worker_connections  1024;\n}\n\n\nhttp {\n    include       /etc/nginx/mime.types;\n    default_type  application/octet-stream;\n\n    log_format  main  '$remote_addr - $remote_user [$time_local] \"$request\" '\n                      '$status $body_bytes_sent \"$http_referer\" '\n                      '\"$http_user_agent\" \"$http_x_forwarded_for\"';\n\n    #access_log  /var/log/nginx/access.log  main;\n\n    sendfile        on;\n    #tcp_nopush     on;\n\n    keepalive_timeout  65;\n\n    #gzip  on;\n\n    include /etc/nginx/conf.d/*.conf;\n}\n</code></pre>"},{"location":"docker/Install-Minio/#9-minioconf","title":"9 Minio.conf","text":"<pre><code>upstream minio {\n    server minio.objectstorage.com:9000;\n}\n\nupstream console {\n    ip_hash;\n    server minio.objectstorage.com:9001;\n}\n\nserver {\n    listen       9090 ssl;\n    listen  [::]:9090 ssl;\n    server_name  minio.objectstorage.com;\n\n    access_log /var/log/nginx/minio-access.log main;\n    error_log  /var/log/nginx/minio-error.log;\n\n    ssl_certificate     /etc/nginx/ssl/minio/minio.objectstorage.com.crt;\n    ssl_certificate_key /etc/nginx/ssl/minio/minio.objectstorage.com.key;\n\n    ssl_protocols TLSv1.2 TLSv1.3;\n    ssl_prefer_server_ciphers on;\n    ssl_ciphers \"EECDH+AESGCM:EDH+AESGCM:AES256+EECDH:AES256+EDH\";\n    ssl_ecdh_curve secp384r1;\n    ssl_session_cache shared:SSL:10m;\n    ssl_session_tickets off;\n    #ssl_stapling on;\n    #ssl_stapling_verify on;\n    add_header Strict-Transport-Security \"max-age=63072000; includeSubDomains\";\n    add_header X-Frame-Options DENY;\n    add_header X-Content-Type-Options nosniff;\n\n    # To allow special characters in headers\n    ignore_invalid_headers off;\n    # Allow any size file to be uploaded.\n    # Set to a value such as 1000m; to restrict file size to a specific value\n    client_max_body_size 0;\n    # To disable buffering\n    proxy_buffering off;\n    proxy_request_buffering off;\n\n    location / {\n        proxy_set_header Host $http_host;\n        proxy_set_header X-Real-IP $remote_addr;\n        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;\n        proxy_set_header X-Forwarded-Proto $scheme;\n\n        proxy_connect_timeout 300;\n        # Default is HTTP/1, keepalive is only enabled in HTTP/1.1\n        proxy_http_version 1.1;\n        proxy_set_header Connection \"\";\n        chunked_transfer_encoding off;\n\n        proxy_pass https://minio;\n    }\n}\n\nserver {\n    listen       9443 ssl;\n    listen  [::]:9443 ssl;\n    server_name  minio.objectstorage.com;\n\n    access_log /var/log/nginx/minio-access.log main;\n    error_log  /var/log/nginx/minio-error.log;\n\n    ssl_certificate     /etc/nginx/ssl/minio/minio.objectstorage.com.crt;\n    ssl_certificate_key /etc/nginx/ssl/minio/minio.objectstorage.com.key;\n\n    ssl_protocols TLSv1.2 TLSv1.3;\n    ssl_prefer_server_ciphers on;\n    ssl_ciphers \"EECDH+AESGCM:EDH+AESGCM:AES256+EECDH:AES256+EDH\";\n    ssl_ecdh_curve secp384r1;\n    ssl_session_cache shared:SSL:10m;\n    ssl_session_tickets off;\n    #ssl_stapling on;\n    #ssl_stapling_verify on;\n    add_header Strict-Transport-Security \"max-age=63072000; includeSubDomains\";\n    add_header X-Frame-Options DENY;\n    add_header X-Content-Type-Options nosniff;\n\n    # To allow special characters in headers\n    ignore_invalid_headers off;\n    # Allow any size file to be uploaded.\n    # Set to a value such as 1000m; to restrict file size to a specific value\n    client_max_body_size 0;\n    # To disable buffering\n    proxy_buffering off;\n    proxy_request_buffering off;\n\n    location / {\n        proxy_set_header Host $http_host;\n        proxy_set_header X-Real-IP $remote_addr;\n        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;\n        proxy_set_header X-Forwarded-Proto $scheme;\n        proxy_set_header X-NginX-Proxy true;\n\n        # This is necessary to pass the correct IP to be hashed\n        real_ip_header X-Real-IP;\n\n        proxy_connect_timeout 300;\n\n        # To support websocket\n        proxy_http_version 1.1;\n        proxy_set_header Upgrade $http_upgrade;\n        proxy_set_header Connection \"upgrade\";\n\n        chunked_transfer_encoding off;\n\n        proxy_pass https://console;\n    }\n}\n</code></pre>"},{"location":"docker/Install-Nacos-Cluster/","title":"Install Nacos Cluster","text":""},{"location":"docker/Install-Nacos-Cluster/#nacos","title":"\u90e8\u7f72Nacos \u96c6\u7fa4","text":"<p> \u8fd9\u91cc\u90e8\u7f72\u548c\u7ef4\u62a4\u90fd\u662f\u5728/root \u76ee\u5f55\u4e0b\uff0c\u64cd\u4f5c\u90fd\u662f\u4f7f\u7528<code>root</code>\u7528\u6237\uff0c\u8bf7\u7559\u610f\u3002</p> <p> \u5982\u679c\u6761\u4ef6\u5141\u8bb8\uff0c\u5efa\u8bae\u5404\u4e2a\u96c6\u7fa4\u90fd\u80fd\u72ec\u81ea\u4f7f\u7528\u81ea\u5df1\u7684\u670d\u52a1\u5668\u8d44\u6e90\uff0c\u800c\u975e\u4e0e\u5176\u4ed6\u96c6\u7fa4\u5171\u4eab\uff0c\u4ee5\u514d\u9ad8\u8d1f\u8f7d\u65f6\u5b58\u5728\u8d44\u6e90\u4e89\u62a2\u5bfc\u81f4\u6545\u969c\u7684\u95ee\u9898\u3002</p>"},{"location":"docker/Install-Nacos-Cluster/#11","title":"1.1 \u4f7f\u7528\u65b9\u5f0f","text":"<p> \u96c6\u7fa4\u6a21\u5f0f\u5fc5\u987b\u4f7f\u7528\u5916\u7f6e\u6570\u636e\u5e93\u505a\u6570\u636e\u5b58\u50a8\uff0c\u5185\u7f6e\u6570\u636e\u5e93\u65e0\u6cd5\u652f\u6301\u96c6\u7fa4\u6a21\u5f0f\uff0c\u76ee\u524d\u5b98\u65b9\u4ecd\u7136\u9ed8\u8ba4\u652f\u6301MYSQL,\u5982\u679c\u73b0\u573a\u7b49\u4fdd\u9047\u5230\u5b89\u5168\u6f0f\u6d1e\u95ee\u9898\uff0c\u4ecd\u7136\u9700\u8981\u540c\u6b65\u5904\u7406\u3002</p> <pre><code># \u4e0a\u4f20\u9644\u4ef6\u76ee\u5f55\uff1anacos-cluster \u5230/root\n\n# \u67e5\u770b\u6587\u4ef6\nroot@deepin-1:~# cd nacos-cluster\nroot@deepin-1:~/nacos-cluster# ls -lha \ntotal 390M\ndrwxr-xr-x 4 root root 4.0K Jan 22 16:10 .\ndrwx------ 8 root root 4.0K Jan 22 15:57 ..\ndrwxr-xr-x 2 root root 4.0K Jan 22 15:36 conf\n-rw-r--r-- 1 root root 2.1K Jan 22 14:41 docker-compose.yaml\ndrwxr-xr-x 2 root root 4.0K Jan 22 15:42 env\n-rw-r--r-- 1 root root   26 Jan 22 14:45 .env\n-rw-r--r-- 1 root root   26 Jan 22 14:46 .env.example\n-rw-r--r-- 1 root root 150M Jan 22 11:07 mysql.tar.gz\n-rw-r--r-- 1 root root 224M Jan 22 11:07 nacos.tar.gz\n-rw-r--r-- 1 root root  17M Jan 22 11:54 nginx.tar.gz\n\ndocker load -i nacos.tar.gz\ndocker load -i mysql.tar.gz\ndocker load -i nginx.tar.gz\ncp .env.example .env\nvim .env # \u8bf7\u7ed3\u5408\u81ea\u5df1\u7684\u60c5\u51b5\u4fee\u6539\u914d\u7f6e\u540e\u518d\u542f\u52a8\ndocker-compose up -d\n</code></pre> <p>\u542f\u52a8\u5b8c\u6210</p> <pre><code>root@deepin-1:~/nacos-cluster/nacos-mysql# docker-compose ps -a \nNAME          IMAGE                            COMMAND                  SERVICE   CREATED          STATUS                    PORTS\nmysql         freemankevin/nacos-mysql:v8      \"docker-entrypoint.s\u2026\"   mysql     44 minutes ago   Up 44 minutes (healthy)   0.0.0.0:3306-&gt;3306/tcp, 33060/tcp\nnacos1        nacos/nacos-server:v2.3.0-slim   \"bin/docker-startup.\u2026\"   nacos1    44 minutes ago   Up 44 minutes (healthy)   0.0.0.0:7848-&gt;7848/tcp, 0.0.0.0:8848-&gt;8848/tcp, 0.0.0.0:9868-&gt;9848/tcp, 0.0.0.0:9850-&gt;9849/tcp\nnacos2        nacos/nacos-server:v2.3.0-slim   \"bin/docker-startup.\u2026\"   nacos2    44 minutes ago   Up 44 minutes (healthy)   0.0.0.0:7849-&gt;7848/tcp, 0.0.0.0:8849-&gt;8848/tcp, 0.0.0.0:9869-&gt;9848/tcp, 0.0.0.0:9851-&gt;9849/tcp\nnacos3        nacos/nacos-server:v2.3.0-slim   \"bin/docker-startup.\u2026\"   nacos3    44 minutes ago   Up 44 minutes (healthy)   0.0.0.0:7850-&gt;7848/tcp, 0.0.0.0:8850-&gt;8848/tcp, 0.0.0.0:9870-&gt;9848/tcp, 0.0.0.0:9852-&gt;9849/tcp\nnginx-nacos   nginx:1.25.3-alpine              \"/docker-entrypoint.\u2026\"   nginx     44 minutes ago   Up 44 minutes (healthy)   80/tcp, 0.0.0.0:38848-&gt;8848/tcp\n</code></pre>"},{"location":"docker/Install-Nacos-Cluster/#12","title":"1.2 \u63a5\u53e3\u8bf7\u6c42","text":"<pre><code># Service registration example\ncurl -X POST 'http://192.168.171.153:38848/nacos/v1/ns/instance?serviceName=nacos.naming.serviceName&amp;ip=20.18.7.10&amp;port=8080&amp;username=nacos&amp;accessToken=eyJhbGciOiJIUzM4NCJ9.eyJzdWIiOiJuYWNvcyIsImV4cCI6MTcwNTkyMzkyNX0.9h7naJVDIyimqC873DbXONa9-BPvk6POUvvMuYbtIIw44Ukq83czbtpOj_2KzvSn'\n\n# Service discovery example\ncurl -X GET 'http://192.168.171.153:38848/nacos/v1/ns/instance/list?serviceName=nacos.naming.serviceName&amp;username=nacos&amp;accessToken=eyJhbGciOiJIUzM4NCJ9.eyJzdWIiOiJuYWNvcyIsImV4cCI6MTcwNTkyMzkyNX0.9h7naJVDIyimqC873DbXONa9-BPvk6POUvvMuYbtIIw44Ukq83czbtpOj_2KzvSn'\n\n# Push configuration example\ncurl -X POST 'http://192.168.171.153:38848/nacos/v1/cs/configs?dataId=nacos.cfg.dataId&amp;group=test&amp;content=helloWorld&amp;username=nacos&amp;accessToken=eyJhbGciOiJIUzM4NCJ9.eyJzdWIiOiJuYWNvcyIsImV4cCI6MTcwNTkyMzkyNX0.9h7naJVDIyimqC873DbXONa9-BPvk6POUvvMuYbtIIw44Ukq83czbtpOj_2KzvSn'\n\n\n# Get configuration examples\ncurl -X GET 'http://192.168.171.153:38848/nacos/v1/cs/configs?dataId=nacos.cfg.dataId&amp;group=test&amp;username=nacos&amp;accessToken=eyJhbGciOiJIUzM4NCJ9.eyJzdWIiOiJuYWNvcyIsImV4cCI6MTcwNTkyMzkyNX0.9h7naJVDIyimqC873DbXONa9-BPvk6POUvvMuYbtIIw44Ukq83czbtpOj_2KzvSn'\n</code></pre>"},{"location":"docker/Install-Nacos/","title":"Install Nacos","text":""},{"location":"docker/Install-Nacos/#compose-file","title":"Compose file","text":"<pre><code>version: '3'\nservices:\n  nacos:\n    image: harbor.dockerregistry.com/app/nacos/nacos-server:v2.2.3\n    networks:\n      - middleware\n    container_name: nacos\n    ports:\n      - \"8858:8848\"\n      - \"9848:9848\"\n      - \"9849:9849\"\n      - \"7848:7848\"\n    environment:\n      NACOS_AUTH_ENABLE: 'true'\n    env_file:\n      - ./nacos/env/nacos-standlone-mysql.env\n    volumes:\n      - /etc/localtime:/etc/localtime:ro\n      - ./nacos/init.d/application.properties:/home/nacos/conf/application.properties\n      - /data/middleware/nacos/standalone-logs/:/home/nacos/logs\n    depends_on:\n      mysql:\n        condition: service_healthy\n    restart: always\n\n  mysql:\n    image: harbor.dockerregistry.com/app/mysql:8.0.30\n    networks:\n      - middleware\n    build:\n      context: .\n      dockerfile: ./build/Dockerfile\n    container_name: mysql\n    ports:\n      - \"3306:3306\"\n    env_file:\n      - ./nacos/env/mysql.env\n    volumes:\n      - /etc/localtime:/etc/localtime:ro\n      - /data/middleware/mysql:/var/lib/mysql\n    healthcheck:\n      test: [ \"CMD\", \"mysqladmin\" ,\"ping\", \"-h\", \"localhost\" ]\n      interval: 5s\n      timeout: 10s\n      retries: 10\n    restart: always\n\n\nnetworks:\n  middleware:\n    driver: bridge\n</code></pre>"},{"location":"docker/Install-Nacos/#applicationproperties","title":"application.properties","text":"<pre><code>#\n# Copyright 1999-2021 Alibaba Group Holding Ltd.\n#\n# Licensed under the Apache License, Version 2.0 (the \"License\");\n# you may not use this file except in compliance with the License.\n# You may obtain a copy of the License at\n#\n#      http://www.apache.org/licenses/LICENSE-2.0\n#\n# Unless required by applicable law or agreed to in writing, software\n# distributed under the License is distributed on an \"AS IS\" BASIS,\n# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n# See the License for the specific language governing permissions and\n# limitations under the License.\n#\n#*************** Spring Boot Related Configurations ***************#\n### Default web context path:\nserver.servlet.contextPath=/nacos\n### Include message field\nserver.error.include-message=ALWAYS\n### Default web server port:\nserver.port=8848\n#*************** Network Related Configurations ***************#\n### If prefer hostname over ip for Nacos server addresses in cluster.conf:\n# nacos.inetutils.prefer-hostname-over-ip=false\n### Specify local server's IP:\n# nacos.inetutils.ip-address=\n#*************** Config Module Related Configurations ***************#\n### Deprecated configuration property, it is recommended to use `spring.sql.init.platform` replaced.\n#spring.datasource.platform=${SPRING_DATASOURCE_PLATFORM:}\nspring.sql.init.platform=${SPRING_DATASOURCE_PLATFORM:}\n# nacos.plugin.datasource.log.enabled=true\n### Count of DB:\ndb.num=1\n### Connect URL of DB:\ndb.url.0=jdbc:mysql://mysql:3306/nacos_devtest?characterEncoding=utf8&amp;connectTimeout=1000&amp;socketTimeout=3000&amp;autoReconnect=true&amp;useUnicode=true&amp;useSSL=false&amp;serverTimezone=UTC&amp;useSSL=false&amp;allowPublicKeyRetrieval=true\ndb.user.0=nacos\ndb.password.0=nacos\n### Connection pool configuration: hikariCP\ndb.pool.config.connectionTimeout=30000\ndb.pool.config.validationTimeout=10000\ndb.pool.config.maximumPoolSize=20\ndb.pool.config.minimumIdle=2\n#*************** Naming Module Related Configurations ***************#\n### Data dispatch task execution period in milliseconds:\n### If enable data warmup. If set to false, the server would accept request without local data preparation:\n# nacos.naming.data.warmup=true\n### If enable the instance auto expiration, kind like of health check of instance:\n# nacos.naming.expireInstance=true\n### will be removed and replaced by `nacos.naming.clean` properties\nnacos.naming.empty-service.auto-clean=true\nnacos.naming.empty-service.clean.initial-delay-ms=50000\nnacos.naming.empty-service.clean.period-time-ms=30000\n### Add in 2.0.0\n### The interval to clean empty service, unit: milliseconds.\n# nacos.naming.clean.empty-service.interval=60000\n### The expired time to clean empty service, unit: milliseconds.\n# nacos.naming.clean.empty-service.expired-time=60000\n### The interval to clean expired metadata, unit: milliseconds.\n# nacos.naming.clean.expired-metadata.interval=5000\n### The expired time to clean metadata, unit: milliseconds.\n# nacos.naming.clean.expired-metadata.expired-time=60000\n### The delay time before push task to execute from service changed, unit: milliseconds.\n# nacos.naming.push.pushTaskDelay=500\n### The timeout for push task execute, unit: milliseconds.\n# nacos.naming.push.pushTaskTimeout=5000\n### The delay time for retrying failed push task, unit: milliseconds.\n# nacos.naming.push.pushTaskRetryDelay=1000\n### Since 2.0.3\n### The expired time for inactive client, unit: milliseconds.\n# nacos.naming.client.expired.time=180000\n#*************** CMDB Module Related Configurations ***************#\n### The interval to dump external CMDB in seconds:\n# nacos.cmdb.dumpTaskInterval=3600\n### The interval of polling data change event in seconds:\n# nacos.cmdb.eventTaskInterval=10\n### The interval of loading labels in seconds:\n# nacos.cmdb.labelTaskInterval=300\n### If turn on data loading task:\n# nacos.cmdb.loadDataAtStart=false\n#*************** Metrics Related Configurations ***************#\n### Metrics for prometheus\n#management.endpoints.web.exposure.include=*\n### Metrics for elastic search\nmanagement.metrics.export.elastic.enabled=false\n#management.metrics.export.elastic.host=http://localhost:9200\n### Metrics for influx\nmanagement.metrics.export.influx.enabled=false\n#management.metrics.export.influx.db=springboot\n#management.metrics.export.influx.uri=http://localhost:8086\n#management.metrics.export.influx.auto-create-db=true\n#management.metrics.export.influx.consistency=one\n#management.metrics.export.influx.compressed=true\n#*************** Access Log Related Configurations ***************#\n### If turn on the access log:\nserver.tomcat.accesslog.enabled=true\n### accesslog automatic cleaning time\nserver.tomcat.accesslog.max-days=30\n### The access log pattern:\nserver.tomcat.accesslog.pattern=%h %l %u %t \"%r\" %s %b %D %{User-Agent}i %{Request-Source}i\n### The directory of access log:\nserver.tomcat.basedir=file:.\n#*************** Access Control Related Configurations ***************#\n### If enable spring security, this option is deprecated in 1.2.0:\n#spring.security.enabled=false\n### The ignore urls of auth, is deprecated in 1.2.0:\nnacos.security.ignore.urls=/,/error,/**/*.css,/**/*.js,/**/*.html,/**/*.map,/**/*.svg,/**/*.png,/**/*.ico,/console-ui/public/**,/v1/auth/**,/v1/console/health/**,/actuator/**,/v1/console/server/**\n### The auth system to use, currently only 'nacos' and 'ldap' is supported:\nnacos.core.auth.system.type=nacos\n### If turn on auth system:\nnacos.core.auth.enabled=false\n### Turn on/off caching of auth information. By turning on this switch, the update of auth information would have a 15 seconds delay.\nnacos.core.auth.caching.enabled=true\n### Since 1.4.1, Turn on/off white auth for user-agent: nacos-server, only for upgrade from old version.\nnacos.core.auth.enable.userAgentAuthWhite=false\n### Since 1.4.1, worked when nacos.core.auth.enabled=true and nacos.core.auth.enable.userAgentAuthWhite=false.\n### The two properties is the white list for auth and used by identity the request from other server.\nnacos.core.auth.server.identity.key=serverIdentity\nnacos.core.auth.server.identity.value=security\n### worked when nacos.core.auth.system.type=nacos\n### The token expiration in seconds:\nnacos.core.auth.plugin.nacos.token.expire.seconds=18000\n### The default token (Base64 string):\nnacos.core.auth.plugin.nacos.token.secret.key=SecretKey012345678901234567890123456789012345678901234567890123456789\n### worked when nacos.core.auth.system.type=ldap?{0} is Placeholder,replace login username\n#nacos.core.auth.ldap.url=ldap://localhost:389\n#nacos.core.auth.ldap.basedc=dc=example,dc=org\n#nacos.core.auth.ldap.userDn=cn=admin,${nacos.core.auth.ldap.basedc}\n#nacos.core.auth.ldap.password=admin\n#nacos.core.auth.ldap.userdn=cn={0},dc=example,dc=org\n#nacos.core.auth.ldap.filter.prefix=uid\n#nacos.core.auth.ldap.case.sensitive=true\n#*************** Istio Related Configurations ***************#\n### If turn on the MCP server:\nnacos.istio.mcp.server.enabled=false\n###*************** Add from 1.3.0 ***************###\n#*************** Core Related Configurations ***************#\n### set the WorkerID manually\n# nacos.core.snowflake.worker-id=\n### Member-MetaData\n# nacos.core.member.meta.site=\n# nacos.core.member.meta.adweight=\n# nacos.core.member.meta.weight=\n### MemberLookup\n### Addressing pattern category, If set, the priority is highest\n# nacos.core.member.lookup.type=[file,address-server]\n## Set the cluster list with a configuration file or command-line argument\n# nacos.member.list=192.168.16.101:8847?raft_port=8807,192.168.16.101?raft_port=8808,192.168.16.101:8849?raft_port=8809\n## for AddressServerMemberLookup\n# Maximum number of retries to query the address server upon initialization\n# nacos.core.address-server.retry=5\n## Server domain name address of [address-server] mode\n# address.server.domain=jmenv.tbsite.net\n## Server port of [address-server] mode\n# address.server.port=8080\n## Request address of [address-server] mode\n# address.server.url=/nacos/serverlist\n#*************** JRaft Related Configurations ***************#\n### Sets the Raft cluster election timeout, default value is 5 second\n# nacos.core.protocol.raft.data.election_timeout_ms=5000\n### Sets the amount of time the Raft snapshot will execute periodically, default is 30 minute\n# nacos.core.protocol.raft.data.snapshot_interval_secs=30\n### raft internal worker threads\n# nacos.core.protocol.raft.data.core_thread_num=8\n### Number of threads required for raft business request processing\n# nacos.core.protocol.raft.data.cli_service_thread_num=4\n### raft linear read strategy. Safe linear reads are used by default, that is, the Leader tenure is confirmed by heartbeat\n# nacos.core.protocol.raft.data.read_index_type=ReadOnlySafe\n### rpc request timeout, default 5 seconds\n# nacos.core.protocol.raft.data.rpc_request_timeout_ms=5000\n#*************** Distro Related Configurations ***************#\n### Distro data sync delay time, when sync task delayed, task will be merged for same data key. Default 1 second.\n# nacos.core.protocol.distro.data.sync.delayMs=1000\n### Distro data sync timeout for one sync data, default 3 seconds.\n# nacos.core.protocol.distro.data.sync.timeoutMs=3000\n### Distro data sync retry delay time when sync data failed or timeout, same behavior with delayMs, default 3 seconds.\n# nacos.core.protocol.distro.data.sync.retryDelayMs=3000\n### Distro data verify interval time, verify synced data whether expired for a interval. Default 5 seconds.\n# nacos.core.protocol.distro.data.verify.intervalMs=5000\n### Distro data verify timeout for one verify, default 3 seconds.\n# nacos.core.protocol.distro.data.verify.timeoutMs=3000\n### Distro data load retry delay when load snapshot data failed, default 30 seconds.\n# nacos.core.protocol.distro.data.load.retryDelayMs=30000\n### enable to support prometheus service discovery\n#nacos.prometheus.metrics.enabled=true\n</code></pre>"},{"location":"docker/Install-Nacos/#dockerfile","title":"Dockerfile","text":"<pre><code>FROM mysql:8.0.31\n#ADD https://raw.githubusercontent.com/alibaba/nacos/develop/distribution/conf/mysql-schema.sql /docker-entrypoint-initdb.d/nacos-mysql.sql\nADD ./mysql-schema.sql /docker-entrypoint-initdb.d/nacos-mysql.sql\nRUN chown -R mysql:mysql /docker-entrypoint-initdb.d/nacos-mysql.sql\nEXPOSE 3306\nCMD [\"mysqld\", \"--character-set-server=utf8mb4\", \"--collation-server=utf8mb4_unicode_ci\"]\n</code></pre>"},{"location":"docker/Install-Nacos/#mysql-schemasql","title":"mysql-schema.sql","text":"<pre><code>/*\n * Copyright 1999-2018 Alibaba Group Holding Ltd.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\n/******************************************/\n/*   \u8868\u540d\u79f0 = config_info                  */\n/******************************************/\nCREATE TABLE `config_info` (\n  `id` bigint(20) NOT NULL AUTO_INCREMENT COMMENT 'id',\n  `data_id` varchar(255) NOT NULL COMMENT 'data_id',\n  `group_id` varchar(128) DEFAULT NULL,\n  `content` longtext NOT NULL COMMENT 'content',\n  `md5` varchar(32) DEFAULT NULL COMMENT 'md5',\n  `gmt_create` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '\u521b\u5efa\u65f6\u95f4',\n  `gmt_modified` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '\u4fee\u6539\u65f6\u95f4',\n  `src_user` text COMMENT 'source user',\n  `src_ip` varchar(50) DEFAULT NULL COMMENT 'source ip',\n  `app_name` varchar(128) DEFAULT NULL,\n  `tenant_id` varchar(128) DEFAULT '' COMMENT '\u79df\u6237\u5b57\u6bb5',\n  `c_desc` varchar(256) DEFAULT NULL,\n  `c_use` varchar(64) DEFAULT NULL,\n  `effect` varchar(64) DEFAULT NULL,\n  `type` varchar(64) DEFAULT NULL,\n  `c_schema` text,\n  `encrypted_data_key` text NOT NULL COMMENT '\u5bc6\u94a5',\n  PRIMARY KEY (`id`),\n  UNIQUE KEY `uk_configinfo_datagrouptenant` (`data_id`,`group_id`,`tenant_id`)\n) ENGINE=InnoDB DEFAULT CHARSET=utf8 COLLATE=utf8_bin COMMENT='config_info';\n\n/******************************************/\n/*   \u8868\u540d\u79f0 = config_info_aggr             */\n/******************************************/\nCREATE TABLE `config_info_aggr` (\n  `id` bigint(20) NOT NULL AUTO_INCREMENT COMMENT 'id',\n  `data_id` varchar(255) NOT NULL COMMENT 'data_id',\n  `group_id` varchar(128) NOT NULL COMMENT 'group_id',\n  `datum_id` varchar(255) NOT NULL COMMENT 'datum_id',\n  `content` longtext NOT NULL COMMENT '\u5185\u5bb9',\n  `gmt_modified` datetime NOT NULL COMMENT '\u4fee\u6539\u65f6\u95f4',\n  `app_name` varchar(128) DEFAULT NULL,\n  `tenant_id` varchar(128) DEFAULT '' COMMENT '\u79df\u6237\u5b57\u6bb5',\n  PRIMARY KEY (`id`),\n  UNIQUE KEY `uk_configinfoaggr_datagrouptenantdatum` (`data_id`,`group_id`,`tenant_id`,`datum_id`)\n) ENGINE=InnoDB DEFAULT CHARSET=utf8 COLLATE=utf8_bin COMMENT='\u589e\u52a0\u79df\u6237\u5b57\u6bb5';\n\n\n/******************************************/\n/*   \u8868\u540d\u79f0 = config_info_beta             */\n/******************************************/\nCREATE TABLE `config_info_beta` (\n  `id` bigint(20) NOT NULL AUTO_INCREMENT COMMENT 'id',\n  `data_id` varchar(255) NOT NULL COMMENT 'data_id',\n  `group_id` varchar(128) NOT NULL COMMENT 'group_id',\n  `app_name` varchar(128) DEFAULT NULL COMMENT 'app_name',\n  `content` longtext NOT NULL COMMENT 'content',\n  `beta_ips` varchar(1024) DEFAULT NULL COMMENT 'betaIps',\n  `md5` varchar(32) DEFAULT NULL COMMENT 'md5',\n  `gmt_create` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '\u521b\u5efa\u65f6\u95f4',\n  `gmt_modified` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '\u4fee\u6539\u65f6\u95f4',\n  `src_user` text COMMENT 'source user',\n  `src_ip` varchar(50) DEFAULT NULL COMMENT 'source ip',\n  `tenant_id` varchar(128) DEFAULT '' COMMENT '\u79df\u6237\u5b57\u6bb5',\n  `encrypted_data_key` text NOT NULL COMMENT '\u5bc6\u94a5',\n  PRIMARY KEY (`id`),\n  UNIQUE KEY `uk_configinfobeta_datagrouptenant` (`data_id`,`group_id`,`tenant_id`)\n) ENGINE=InnoDB DEFAULT CHARSET=utf8 COLLATE=utf8_bin COMMENT='config_info_beta';\n\n/******************************************/\n/*   \u8868\u540d\u79f0 = config_info_tag              */\n/******************************************/\nCREATE TABLE `config_info_tag` (\n  `id` bigint(20) NOT NULL AUTO_INCREMENT COMMENT 'id',\n  `data_id` varchar(255) NOT NULL COMMENT 'data_id',\n  `group_id` varchar(128) NOT NULL COMMENT 'group_id',\n  `tenant_id` varchar(128) DEFAULT '' COMMENT 'tenant_id',\n  `tag_id` varchar(128) NOT NULL COMMENT 'tag_id',\n  `app_name` varchar(128) DEFAULT NULL COMMENT 'app_name',\n  `content` longtext NOT NULL COMMENT 'content',\n  `md5` varchar(32) DEFAULT NULL COMMENT 'md5',\n  `gmt_create` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '\u521b\u5efa\u65f6\u95f4',\n  `gmt_modified` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '\u4fee\u6539\u65f6\u95f4',\n  `src_user` text COMMENT 'source user',\n  `src_ip` varchar(50) DEFAULT NULL COMMENT 'source ip',\n  PRIMARY KEY (`id`),\n  UNIQUE KEY `uk_configinfotag_datagrouptenanttag` (`data_id`,`group_id`,`tenant_id`,`tag_id`)\n) ENGINE=InnoDB DEFAULT CHARSET=utf8 COLLATE=utf8_bin COMMENT='config_info_tag';\n\n/******************************************/\n/*   \u8868\u540d\u79f0 = config_tags_relation         */\n/******************************************/\nCREATE TABLE `config_tags_relation` (\n  `id` bigint(20) NOT NULL COMMENT 'id',\n  `tag_name` varchar(128) NOT NULL COMMENT 'tag_name',\n  `tag_type` varchar(64) DEFAULT NULL COMMENT 'tag_type',\n  `data_id` varchar(255) NOT NULL COMMENT 'data_id',\n  `group_id` varchar(128) NOT NULL COMMENT 'group_id',\n  `tenant_id` varchar(128) DEFAULT '' COMMENT 'tenant_id',\n  `nid` bigint(20) NOT NULL AUTO_INCREMENT,\n  PRIMARY KEY (`nid`),\n  UNIQUE KEY `uk_configtagrelation_configidtag` (`id`,`tag_name`,`tag_type`),\n  KEY `idx_tenant_id` (`tenant_id`)\n) ENGINE=InnoDB DEFAULT CHARSET=utf8 COLLATE=utf8_bin COMMENT='config_tag_relation';\n\n/******************************************/\n/*   \u8868\u540d\u79f0 = group_capacity               */\n/******************************************/\nCREATE TABLE `group_capacity` (\n  `id` bigint(20) unsigned NOT NULL AUTO_INCREMENT COMMENT '\u4e3b\u952eID',\n  `group_id` varchar(128) NOT NULL DEFAULT '' COMMENT 'Group ID\uff0c\u7a7a\u5b57\u7b26\u8868\u793a\u6574\u4e2a\u96c6\u7fa4',\n  `quota` int(10) unsigned NOT NULL DEFAULT '0' COMMENT '\u914d\u989d\uff0c0\u8868\u793a\u4f7f\u7528\u9ed8\u8ba4\u503c',\n  `usage` int(10) unsigned NOT NULL DEFAULT '0' COMMENT '\u4f7f\u7528\u91cf',\n  `max_size` int(10) unsigned NOT NULL DEFAULT '0' COMMENT '\u5355\u4e2a\u914d\u7f6e\u5927\u5c0f\u4e0a\u9650\uff0c\u5355\u4f4d\u4e3a\u5b57\u8282\uff0c0\u8868\u793a\u4f7f\u7528\u9ed8\u8ba4\u503c',\n  `max_aggr_count` int(10) unsigned NOT NULL DEFAULT '0' COMMENT '\u805a\u5408\u5b50\u914d\u7f6e\u6700\u5927\u4e2a\u6570\uff0c\uff0c0\u8868\u793a\u4f7f\u7528\u9ed8\u8ba4\u503c',\n  `max_aggr_size` int(10) unsigned NOT NULL DEFAULT '0' COMMENT '\u5355\u4e2a\u805a\u5408\u6570\u636e\u7684\u5b50\u914d\u7f6e\u5927\u5c0f\u4e0a\u9650\uff0c\u5355\u4f4d\u4e3a\u5b57\u8282\uff0c0\u8868\u793a\u4f7f\u7528\u9ed8\u8ba4\u503c',\n  `max_history_count` int(10) unsigned NOT NULL DEFAULT '0' COMMENT '\u6700\u5927\u53d8\u66f4\u5386\u53f2\u6570\u91cf',\n  `gmt_create` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '\u521b\u5efa\u65f6\u95f4',\n  `gmt_modified` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '\u4fee\u6539\u65f6\u95f4',\n  PRIMARY KEY (`id`),\n  UNIQUE KEY `uk_group_id` (`group_id`)\n) ENGINE=InnoDB DEFAULT CHARSET=utf8 COLLATE=utf8_bin COMMENT='\u96c6\u7fa4\u3001\u5404Group\u5bb9\u91cf\u4fe1\u606f\u8868';\n\n/******************************************/\n/*   \u8868\u540d\u79f0 = his_config_info              */\n/******************************************/\nCREATE TABLE `his_config_info` (\n  `id` bigint(20) unsigned NOT NULL,\n  `nid` bigint(20) unsigned NOT NULL AUTO_INCREMENT,\n  `data_id` varchar(255) NOT NULL,\n  `group_id` varchar(128) NOT NULL,\n  `app_name` varchar(128) DEFAULT NULL COMMENT 'app_name',\n  `content` longtext NOT NULL,\n  `md5` varchar(32) DEFAULT NULL,\n  `gmt_create` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP,\n  `gmt_modified` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP,\n  `src_user` text,\n  `src_ip` varchar(50) DEFAULT NULL,\n  `op_type` char(10) DEFAULT NULL,\n  `tenant_id` varchar(128) DEFAULT '' COMMENT '\u79df\u6237\u5b57\u6bb5',\n  `encrypted_data_key` text NOT NULL COMMENT '\u5bc6\u94a5',\n  PRIMARY KEY (`nid`),\n  KEY `idx_gmt_create` (`gmt_create`),\n  KEY `idx_gmt_modified` (`gmt_modified`),\n  KEY `idx_did` (`data_id`)\n) ENGINE=InnoDB DEFAULT CHARSET=utf8 COLLATE=utf8_bin COMMENT='\u591a\u79df\u6237\u6539\u9020';\n\n\n/******************************************/\n/*   \u8868\u540d\u79f0 = tenant_capacity              */\n/******************************************/\nCREATE TABLE `tenant_capacity` (\n  `id` bigint(20) unsigned NOT NULL AUTO_INCREMENT COMMENT '\u4e3b\u952eID',\n  `tenant_id` varchar(128) NOT NULL DEFAULT '' COMMENT 'Tenant ID',\n  `quota` int(10) unsigned NOT NULL DEFAULT '0' COMMENT '\u914d\u989d\uff0c0\u8868\u793a\u4f7f\u7528\u9ed8\u8ba4\u503c',\n  `usage` int(10) unsigned NOT NULL DEFAULT '0' COMMENT '\u4f7f\u7528\u91cf',\n  `max_size` int(10) unsigned NOT NULL DEFAULT '0' COMMENT '\u5355\u4e2a\u914d\u7f6e\u5927\u5c0f\u4e0a\u9650\uff0c\u5355\u4f4d\u4e3a\u5b57\u8282\uff0c0\u8868\u793a\u4f7f\u7528\u9ed8\u8ba4\u503c',\n  `max_aggr_count` int(10) unsigned NOT NULL DEFAULT '0' COMMENT '\u805a\u5408\u5b50\u914d\u7f6e\u6700\u5927\u4e2a\u6570',\n  `max_aggr_size` int(10) unsigned NOT NULL DEFAULT '0' COMMENT '\u5355\u4e2a\u805a\u5408\u6570\u636e\u7684\u5b50\u914d\u7f6e\u5927\u5c0f\u4e0a\u9650\uff0c\u5355\u4f4d\u4e3a\u5b57\u8282\uff0c0\u8868\u793a\u4f7f\u7528\u9ed8\u8ba4\u503c',\n  `max_history_count` int(10) unsigned NOT NULL DEFAULT '0' COMMENT '\u6700\u5927\u53d8\u66f4\u5386\u53f2\u6570\u91cf',\n  `gmt_create` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '\u521b\u5efa\u65f6\u95f4',\n  `gmt_modified` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '\u4fee\u6539\u65f6\u95f4',\n  PRIMARY KEY (`id`),\n  UNIQUE KEY `uk_tenant_id` (`tenant_id`)\n) ENGINE=InnoDB DEFAULT CHARSET=utf8 COLLATE=utf8_bin COMMENT='\u79df\u6237\u5bb9\u91cf\u4fe1\u606f\u8868';\n\n\nCREATE TABLE `tenant_info` (\n  `id` bigint(20) NOT NULL AUTO_INCREMENT COMMENT 'id',\n  `kp` varchar(128) NOT NULL COMMENT 'kp',\n  `tenant_id` varchar(128) default '' COMMENT 'tenant_id',\n  `tenant_name` varchar(128) default '' COMMENT 'tenant_name',\n  `tenant_desc` varchar(256) DEFAULT NULL COMMENT 'tenant_desc',\n  `create_source` varchar(32) DEFAULT NULL COMMENT 'create_source',\n  `gmt_create` bigint(20) NOT NULL COMMENT '\u521b\u5efa\u65f6\u95f4',\n  `gmt_modified` bigint(20) NOT NULL COMMENT '\u4fee\u6539\u65f6\u95f4',\n  PRIMARY KEY (`id`),\n  UNIQUE KEY `uk_tenant_info_kptenantid` (`kp`,`tenant_id`),\n  KEY `idx_tenant_id` (`tenant_id`)\n) ENGINE=InnoDB DEFAULT CHARSET=utf8 COLLATE=utf8_bin COMMENT='tenant_info';\n\nCREATE TABLE `users` (\n    `username` varchar(50) NOT NULL PRIMARY KEY,\n    `password` varchar(500) NOT NULL,\n    `enabled` boolean NOT NULL\n);\n\nCREATE TABLE `roles` (\n    `username` varchar(50) NOT NULL,\n    `role` varchar(50) NOT NULL,\n    UNIQUE INDEX `idx_user_role` (`username` ASC, `role` ASC) USING BTREE\n);\n\nCREATE TABLE `permissions` (\n    `role` varchar(50) NOT NULL,\n    `resource` varchar(255) NOT NULL,\n    `action` varchar(8) NOT NULL,\n    UNIQUE INDEX `uk_role_permission` (`role`,`resource`,`action`) USING BTREE\n);\n\nINSERT INTO users (username, password, enabled) VALUES ('nacos', '$2a$10$EuWPZHzz32dJN7jexM34MOeYirDdFAZm2kuWj7VEOJhhZkDrxfvUu', TRUE);\n\nINSERT INTO roles (username, role) VALUES ('nacos', 'ROLE_ADMIN');\n</code></pre>"},{"location":"docker/Install-Nacos/#nacos-standlone-mysqlenv","title":"nacos-standlone-mysql.env","text":"<pre><code>PREFER_HOST_MODE=hostname\nMODE=standalone\nSPRING_DATASOURCE_PLATFORM=mysql\nMYSQL_SERVICE_HOST=mysql\nMYSQL_SERVICE_DB_NAME=nacos_devtest\nMYSQL_SERVICE_PORT=3306\nMYSQL_SERVICE_USER=nacos\nMYSQL_SERVICE_PASSWORD=nacos\nMYSQL_SERVICE_DB_PARAM=characterEncoding=utf8&amp;connectTimeout=1000&amp;socketTimeout=3000&amp;autoReconnect=true&amp;useSSL=false&amp;allowPublicKeyRetrieval=true\nNACOS_AUTH_IDENTITY_KEY=2222\nNACOS_AUTH_IDENTITY_VALUE=2xxx\nNACOS_AUTH_TOKEN=SecretKey012345678901234567890123456789012345678901234567890123456789\n</code></pre>"},{"location":"docker/Install-Nacos/#mysqlenv","title":"mysql.env","text":"<pre><code>MYSQL_ROOT_PASSWORD=root\nMYSQL_DATABASE=nacos_devtest\nMYSQL_USER=nacos\nMYSQL_PASSWORD=nacos\nLANG=C.UTF-8\n</code></pre>"},{"location":"docker/Install-Nacos/#_1","title":"\u5f00\u542f\u9274\u6743","text":""},{"location":"docker/Install-Nacos/#11","title":"1.1 \u670d\u52a1\u7aef\u66f4\u65b0","text":"<p>\u6839\u636e\u81ea\u5df1\u7684\u90e8\u7f72\u6a21\u5f0f\u6765\u8fdb\u884c\u8c03\u6574\u5373\u53ef\u3002</p>"},{"location":"docker/Install-Nacos/#111-compose","title":"1.1.1 Compose","text":"<p>\u9ed8\u8ba4\u914d\u7f6e\u8def\u5f84\uff1a<code>init.d/application.properties</code> \u76f8\u5173\u9ed8\u8ba4\u914d\u7f6e\uff1a</p> <pre><code>nacos.core.auth.system.type=nacos // nacos \u5185\u7f6e\u9274\u6743\u63d2\u4ef6\nnacos.core.auth.enabled=false     // \u4e0d\u9274\u6743\nnacos.core.auth.caching.enabled=true // \u5f00\u542f\u9274\u6743\u7f13\u5b58\nnacos.core.auth.enable.userAgentAuthWhite=false // \u4e0d\u5f00\u767d\u540d\u5355\nnacos.core.auth.server.identity.key=serverIdentity // \u5185\u7f6enacos \u96c6\u7fa4\u8282\u70b9\u95f4\u9274\u6743key\u503c\nnacos.core.auth.server.identity.value=security     // \u5185\u7f6enacos \u96c6\u7fa4\u8282\u70b9\u95f4\u9274\u6743value\u503c\nnacos.core.auth.plugin.nacos.token.expire.seconds=18000 // token \u9ed8\u8ba4\u8d85\u65f65h\nnacos.core.auth.plugin.nacos.token.secret.key=SecretKey012345678901234567890123456789012345678901234567890123456789 // \u9ed8\u8ba4token\n</code></pre> <p>\u76f8\u5173\u65b0\u7684\u914d\u7f6e\uff1a</p> <pre><code>nacos.core.auth.plugin.nacos.token.secret.key=${NACOS_AUTH_TOKEN:lXi@SD5j#7uYuFCbQuzQ4cjLvoNGiDWFqK!xo1YcZHlYy7qMSfZN0ZJcRWI%}\nnacos.core.auth.enabled=${NACOS_AUTH_ENABLE:false}\nnacos.core.auth.server.identity.key=${NACOS_AUTH_IDENTITY_KEY:1}\nnacos.core.auth.server.identity.value=${NACOS_AUTH_IDENTITY_VALUE:1}\n</code></pre> <p>\u66f4\u65b0Compose \u90e8\u7f72\u6587\u4ef6\u4e2dNacos \u73af\u5883\u53d8\u91cf\uff1a</p> <pre><code>version: '3'\nservices:\n  nacos:\n    image: harbor.dockerregistry.com/app/nacos/nacos-server:v2.2.3\n    networks:\n      - middleware\n    container_name: nacos\n    ports:\n      - \"8848:8848\"\n      - \"9848:9848\"\n    environment:\n      NACOS_AUTH_ENABLE: 'true'\n    env_file:\n      - ./env/nacos-standlone-mysql.env\n...\n</code></pre> <p>\u91cd\u542fNacos \u670d\u52a1\u5373\u53ef\u3002 \u5982\u679c\u4fee\u6539Nacos \u9ed8\u8ba4\u5bc6\u7801\uff0c\u9700\u8981\u540c\u6b65\u4fee\u6539\u540e\u7aef\u670d\u52a1\u542f\u52a8\u65f6\u7684\u73af\u5883\u53d8\u91cf\uff0c\u5f53\u7136\u524d\u63d0\u662f\u4ee3\u7801\u91cc\u5df2\u5185\u7f6e\u8fc7Nacos\u7528\u6237\u5bc6\u7801\u7684\u914d\u7f6e\u652f\u6301\uff0c\u5177\u4f53\u7ec6\u8282\u53ef\u4ee5\u53c2\u8003\u540e\u9762\u90e8\u7f72\u90e8\u5206\u3002</p>"},{"location":"docker/Install-Nacos/#112-k8s","title":"1.1.2 K8S","text":"<p>\u6682\u65e0</p>"},{"location":"docker/Install-Nacos/#12","title":"1.2 \u5ba2\u6237\u7aef\u66f4\u65b0","text":""},{"location":"docker/Install-Nacos/#121","title":"1.2.1 \u4ee3\u7801","text":""},{"location":"docker/Install-Nacos/#1211","title":"1.2.1.1  \u670d\u52a1\u6ce8\u518c","text":"<p>JAVA \u540e\u7aefSDK\uff0c\u5185\u7f6enacos\u9ed8\u8ba4\u7528\u6237\u5bc6\u7801\u96c6\u6210\uff1a</p> <pre><code>...\n       Properties props = System.getProperties();\n        // \u901a\u7528\u6ce8\u518c\n        props.setProperty(\"spring.cloud.nacos.discovery.server-addr\", LauncherConstant.nacosAddr(profile));\n        props.setProperty(\"spring.cloud.nacos.config.server-addr\", LauncherConstant.nacosAddr(profile));\n        props.setProperty(\"spring.cloud.nacos.config.shared-dataids\", LauncherConstant.sharedDataIds(profile));\n        props.setProperty(\"spring.cloud.nacos.config.refreshable-dataids\", LauncherConstant.sharedDataIds(profile));\n        props.setProperty(\"spring.cloud.nacos.username\", \"nacos\");\n        props.setProperty(\"spring.cloud.nacos.password\", \"nacos\");\n        builder.properties(props);\n...\n</code></pre>"},{"location":"docker/Install-Nacos/#1212-dockerfile","title":"1.2.1.2 Dockerfile","text":"<p>JAVA \u540e\u7aef\uff0cDockerfile\u9ed8\u8ba4\u542f\u52a8\u53c2\u6570\u96c6\u6210\uff1a \u9632\u6b62\u540e\u671fNacos \u670d\u52a1\u7aef\u5185\u7f6e\u5bc6\u7801\u4fee\u6539\u540e\uff0cJAVA\u4fa7\u5185\u7f6e\u5bc6\u7801\u5931\u6548\u65e0\u6cd5\u6b63\u5e38\u6ce8\u518c</p> <pre><code>FROM harbor.dockerregistry.com/app/adoptopenjdk/openjdk8-openj9:alpine-slim-local\n\nWORKDIR /home\n\nADD ./target/*.jar ./app.jar\n\n\nENTRYPOINT [ \\\n    \"java\", \\\n    \"-Djava.security.egd=file:/dev/./urandom\", \\\n    \"-Xshareclasses\", \\\n    \"-Xquickstart\", \\\n    \"-jar\", \\\n    \"app.jar\", \\\n    \"--spring.profiles.active=dev\", \\\n    \"--spring.cloud.nacos.discovery.server-addr=nacos-server:8848\", \\\n    \"--spring.cloud.nacos.config.server-addr=nacos-server:8848\" , \\\n    \"--spring.cloud.nacos.discovery.username=nacos\", \\\n    \"--spring.cloud.nacos.discovery.password=nacos\", \\\n    \"--spring.cloud.nacos.config.namespace=mynamespace\", \\\n    \"--spring.cloud.nacos.discovery.namespace=mynamespace\" \\\n    ]\n</code></pre>"},{"location":"docker/Install-Nacos/#122","title":"1.2.2 \u90e8\u7f72","text":"<p>\u6839\u636e\u81ea\u5df1\u7684\u90e8\u7f72\u6a21\u5f0f\u6765\u8fdb\u884c\u8c03\u6574\u5373\u53ef\u3002</p>"},{"location":"docker/Install-Nacos/#1221-compose","title":"1.2.2.1 Compose","text":"<p>Docker-compose \u542f\u52a8\u7684JAVA \u540e\u7aef\u670d\u52a1\uff0c\u73af\u5883\u53d8\u91cf\u4fee\u6539\uff1a \u65e7\u7684\u670d\u52a1\u914d\u7f6e\uff1a</p> <pre><code>version: '3'\nx-service-template: &amp;x-service-template\n  restart: always\n  extra_hosts:\n    - \"nacos-sysplat:10.3.2.36\"\n  environment:\n    - SPRING_PROFILES_ACTIVE=dev\n  volumes:\n    - /etc/localtime:/etc/localtime:ro\n  networks:\n    - app\n\nservices:\n  sys-gateway:\n    &lt;&lt;: *x-service-template\n    image: harbor.dockerregistry.com/gd-sysplat-base-dev/sys-gateway:9d4c146\n    container_name: sys-gateway\n    ports:\n      - 80:80\n      #- 443:443\n  sys-system:\n    &lt;&lt;: *x-service-template\n    image: harbor.dockerregistry.com/gd-sysplat-base-dev/sys-system:9d4c146\n    container_name: sys-system\n    ports:\n      - 8106:8106\n...\n</code></pre> <p>\u65b0\u7684\u670d\u52a1\u914d\u7f6e\uff1a</p> <pre><code>version: '3'\nx-service-template: &amp;x-service-template\n  restart: always\n  extra_hosts:\n    - \"nacos-sysplat:10.3.2.36\"\n  environment:\n    - SPRING_PROFILES_ACTIVE=dev\n    - SPRING_CLOUD_NACOS_USERNAME=new_username\n    - SPRING_CLOUD_NACOS_PASSWORD=new_password\n  volumes:\n    - /etc/localtime:/etc/localtime:ro\n  networks:\n    - app\n\nservices:\n  sys-gateway:\n    &lt;&lt;: *x-service-template\n    image: harbor.dockerregistry.com/gd-sysplat-base-dev/sys-gateway:9d4c146\n    container_name: sys-gateway\n    ports:\n      - 80:80\n      #- 443:443\n  sys-system:\n    &lt;&lt;: *x-service-template\n    image: harbor.dockerregistry.com/gd-sysplat-base-dev/sys-system:9d4c146\n    container_name: sys-system\n    ports:\n      - 8106:8106\n...\n</code></pre>"},{"location":"docker/Install-Nacos/#1222-k8s","title":"1.2.2.2 K8S","text":"<p>K8S \u7ba1\u7406\u7684JAVA \u540e\u7aef\u670d\u52a1\uff0c\u73af\u5883\u53d8\u91cf\u4fee\u6539\uff1a \u65e7\u7684\u8d44\u6e90\u914d\u7f6e\uff1a</p> <pre><code>spec:\n  replicas: 1\n  selector:\n    matchLabels:\n      app: service-model\n  template:\n    metadata:\n      creationTimestamp: null\n      labels:\n        app: service-model\n    spec:\n      volumes:\n        - name: host-time\n          hostPath:\n            path: /etc/localtime\n            type: ''\n      containers:\n        - name: service-model\n          image: 'harbor.dockerregistry.com/gd-sysplat-base-dev/service-model:62c306d'\n          ports:\n            - name: tcp-8040\n              containerPort: 8040\n              protocol: TCP\n          resources: {}\n          volumeMounts:\n            - name: host-time\n              readOnly: true\n              mountPath: /etc/localtime\n          terminationMessagePath: /dev/termination-log\n          terminationMessagePolicy: File\n          imagePullPolicy: Always\n</code></pre> <p>\u65b0\u7684\u8d44\u6e90\u914d\u7f6e\uff1a</p> <pre><code>spec:\n  replicas: 1\n  selector:\n    matchLabels:\n      app: service-model\n  template:\n    metadata:\n      creationTimestamp: null\n      labels:\n        app: service-model\n    spec:\n      volumes:\n        - name: host-time\n          hostPath:\n            path: /etc/localtime\n            type: ''\n      containers:\n        - name: service-model\n          image: 'harbor.dockerregistry.com/gd-sysplat-base-dev/service-model:62c306d'\n          env:\n            - name: SPRING_CLOUD_NACOS_USERNAME\n              value: new_username\n            - name: SPRING_CLOUD_NACOS_PASSWORD\n              value: new_password\n          ports:\n            - name: tcp-8040\n              containerPort: 8040\n              protocol: TCP\n          resources: {}\n          volumeMounts:\n            - name: host-time\n              readOnly: true\n              mountPath: /etc/localtime\n          terminationMessagePath: /dev/termination-log\n          terminationMessagePolicy: File\n          imagePullPolicy: Always\n</code></pre>"},{"location":"docker/Install-Nacos/#1223-docker","title":"1.2.2.3 Docker","text":"<p>Docker RUN \u76f4\u63a5\u7ba1\u7406\u7684JAVA \u540e\u7aef\u5bb9\u5668\u670d\u52a1\uff0c\u76f8\u5e94\u547d\u4ee4\u884c\u53c2\u6570\u6dfb\u52a0\uff1a \u65e7\u7684\u547d\u4ee4\uff1a</p> <pre><code>        docker run -d  --name=$project_name      \\\n        --memory-swap -1   --restart=always      \\\n        -v /etc/localtime:/etc/localtime:ro      \\\n        -v /original:/original                   \\\n        -v /temporary:/temporary                 \\\n        -v /management:/management               \\\n        -v /achievement:/achievement             \\\n        -v /usr/share/fonts:/usr/share/fonts     \\\n        --add-host=server157.esri.com:10.0.1.157 \\\n        --add-host=server156.esri.com:10.0.1.156 \\\n        --add-host=gjptgis.arcgis.cn:10.1.6.115  \\\n        --add-host=$nacos_env:$nacos_ip          \\\n        --net=host                               \\\n        -e \"SPRING_PROFILES_ACTIVE=$service_env\" \\\n        harbor.dockerregistry.com/gd-land-dev/$project_name:$image_tag\n</code></pre> <p>\u65b0\u7684\u547d\u4ee4\uff1a</p> <pre><code>docker run -d  --name=$project_name      \\\n--memory-swap -1   --restart=always      \\\n-v /etc/localtime:/etc/localtime:ro      \\\n-v /original:/original                   \\\n-v /temporary:/temporary                 \\\n-v /management:/management               \\\n-v /achievement:/achievement             \\\n-v /usr/share/fonts:/usr/share/fonts     \\\n--add-host=server157.esri.com:10.0.1.157 \\\n--add-host=server156.esri.com:10.0.1.156 \\\n--add-host=gjptgis.arcgis.cn:10.1.6.115  \\\n--add-host=$nacos_env:$nacos_ip          \\\n--net=host                               \\\n-e \"SPRING_PROFILES_ACTIVE=$service_env\" \\\n-e \"SPRING_CLOUD_NACOS_USERNAME=new_username\" \\\n-e \"SPRING_CLOUD_NACOS_PASSWORD=new_password\" \\\nharbor.dockerregistry.com/gd-land-dev/$project_name:$image_tag\n</code></pre>"},{"location":"docker/Install-Nacos/#1224-jar","title":"1.2.2.4 JAR","text":"<p>Java -jar \u76f4\u63a5\u4f7f\u7528JAVA \u73af\u5883\uff0c\u8fd0\u884cJVM\u865a\u62df\u673a\u547d\u4ee4\u4fee\u6539\uff1a \u65e7\u7684\u547d\u4ee4\uff1a</p> <pre><code>java -jar app.jar \\\n--spring.profiles.active=dev  \\\n--spring.cloud.nacos.discovery.server-addr=nacos-server:8848 \\\n--spring.cloud.nacos.config.server-addr=nacos-server:8848    \\\n--spring.cloud.nacos.config.namespace=mynamespace            \\\n--spring.cloud.nacos.discovery.namespace=mynamespace\n</code></pre> <p>\u65b0\u7684\u547d\u4ee4\uff1a</p> <pre><code>java -jar app.jar \\\n--spring.profiles.active=dev  \\\n--spring.cloud.nacos.username=nacos \\\n--spring.cloud.nacos.password=nacos \\\n--spring.cloud.nacos.discovery.server-addr=nacos-server:8848 \\\n--spring.cloud.nacos.config.server-addr=nacos-server:8848    \\\n--spring.cloud.nacos.config.namespace=mynamespace            \\\n--spring.cloud.nacos.discovery.namespace=mynamespace\n</code></pre>"},{"location":"docker/Install-Nacos/#compose-fileonly-nacos","title":"Compose file(only nacos)","text":"<pre><code>version: '3'\nservices:\n  nacos:\n    image: harbor.dockerregistry.com/app-arm/nacos/nacos-server:v2.2.3-slim\n    container_name: nacos\n    ports:\n      - \"8848:8848\"\n      - \"9848:9848\"\n      - \"9849:9849\"\n      - \"7848:7848\"\n    environment:\n      NACOS_AUTH_ENABLE: 'true'\n    env_file:\n      - ./nacos-local/env/nacos-standlone-mysql.env\n    volumes:\n      - /etc/localtime:/etc/localtime:ro\n      - ./nacos-local/init.d/application.properties:/home/nacos/conf/application.properties\n      - /data/middleware/nacos/standalone-logs/:/home/nacos/logs\n      - /data/middleware/nacos/standalone-data/:/home/nacos/data\n    restart: always\n</code></pre>"},{"location":"docker/Install-Nexus/","title":"Install Nexus","text":""},{"location":"docker/Install-Nexus/#1-compose","title":"1 Compose \u90e8\u7f72","text":"<p>\u521b\u5efa\u6570\u636e\u76ee\u5f55</p> <pre><code>mkdir -p /data/nexus\nchmod -R 775 /data/nexus\n</code></pre> <pre><code>version: '3.6'\nservices:\n  nexus:\n    image: myharbor.mydomain.com/app/sonatype/nexus3:latest\n    container_name: nexus\n    networks:\n      - nexus\n    restart: always\n    environment:\n      - TZ=Asia/Shanghai\n    ports:\n      - '8081:8081'\n    cpus: '1.0'\n    mem_limit: 2g\n    volumes:\n      - /data/nexus:/nexus-data\n\nnetworks:\n  nexus:\n    external: false\n</code></pre> <p>\u67e5\u770b\u521d\u59cb\u5bc6\u7801</p> <pre><code>cat /data/nexus/admin.password  \n</code></pre>"},{"location":"docker/Install-Nexus/#2","title":"2 \u516c\u6709\u4e91\u52a0\u901f","text":""},{"location":"docker/Install-Nexus/#21","title":"2.1 \u534e\u4e3a\u4e91","text":"<p>\u5b98\u65b9\u5730\u5740</p> <pre><code>&lt;mirror&gt;\n    &lt;id&gt;huaweicloud&lt;/id&gt;\n    &lt;mirrorOf&gt;*&lt;/mirrorOf&gt;\n        &lt;url&gt;https://repo.huaweicloud.com/repository/maven/&lt;/url&gt;\n&lt;/mirror&gt;\n</code></pre>"},{"location":"docker/Install-Nexus/#22","title":"2.2 \u963f\u91cc\u4e91","text":"<p>\u5b98\u65b9\u5730\u5740</p> <pre><code>&lt;mirror&gt;\n  &lt;id&gt;aliyunmaven&lt;/id&gt;\n  &lt;mirrorOf&gt;*&lt;/mirrorOf&gt;\n  &lt;url&gt;https://maven.aliyun.com/repository/public&lt;/url&gt;\n&lt;/mirror&gt;\n</code></pre>"},{"location":"docker/Install-Nexus/#3","title":"3 \u89d2\u8272\u7ba1\u7406","text":""},{"location":"docker/Install-Nexus/#31","title":"3.1 \u5f00\u53d1\u8005\u89d2\u8272","text":"<pre><code>nx-component-upload\n#nx-repository-admin---read\nnx-repository-view-*-*-*\nnx-repository-view-*-*-add\n#nx-reposltory-vlew-*-*-delete\nnx-reposltory-view-*-*-read\nnx-repository-view-*-*-edit\n</code></pre>"},{"location":"docker/Install-Nexus/#4-jar","title":"4 \u672c\u5730Jar \u6587\u4ef6\u53ca\u76ee\u5f55\u6811\u6279\u91cf\u4e0a\u4f20","text":"<pre><code>#!/bin/bash\n# copy and run this script to the root of the repository directory containing files\n# this script attempts to exclude uploading itself explicitly so the script name is important\n# Get command line params\nwhile getopts \":r:u:p:\" opt; do\n    case $opt in\n        r) REPO_URL=\"$OPTARG\"\n        ;;\n        u) USERNAME=\"$OPTARG\"\n        ;;\n        p) PASSWORD=\"$OPTARG\"\n        ;;\n    esac\ndone\n\nfind . -type f -not -path './mavenimport\\.sh*' -not -path '*/\\.*' -not -path '*/\\^archetype\\-catalog\\.xml*' -not -path '*/\\^maven\\-metadata\\-local*\\.xml' -not -path '*/\\^maven\\-metadata\\-deployment*\\.xml' | sed \"s|^\\./||\" | xargs -I '{}' curl -u \"$USERNAME:$PASSWORD\" -X PUT -v -T {} ${REPO_URL}/{} ;\n</code></pre> <p>\u8fdb\u5165\u4ed3\u5e93\u76ee\u5f55\uff0c\u6267\u884c\u4e0a\u4f20\u5230 <code>Nexus</code> \u8fdc\u7a0b\u4ed3\u5e93\u76ee\u5f55\uff0c\u5fc5\u987b\u662f <code>Hosted</code> \u7c7b\u578b</p> <pre><code>[root@localhost repository]# pwd\n/data/Maven/repository\n[root@localhost repository]# ./mavenimport.sh -u developer -p Developer@123 -r http://10.3.2.40:8081/repository/maven-releases\n</code></pre> <p>\u6216\u8005\u53ef\u4ee5\u901a\u8fc7\u963f\u91cc\u4e91\u4e91\u6548\u7684Jar\u5305\u5de5\u5177\u5b9e\u73b0\uff0c\u6587\u6863\u53c2\u6570\u5730\u5740\uff1a</p> <p>https://help.aliyun.com/document_detail/131463.html</p>"},{"location":"docker/Install-Nginx-Cluster/","title":"Install Nginx Cluster","text":""},{"location":"docker/Install-Nginx-Cluster/#nginx","title":"\u90e8\u7f72Nginx \u96c6\u7fa4","text":"<p> \u8fd9\u91cc\u90e8\u7f72\u548c\u7ef4\u62a4\u90fd\u662f\u5728/root \u76ee\u5f55\u4e0b\uff0c\u64cd\u4f5c\u90fd\u662f\u4f7f\u7528<code>root</code>\u7528\u6237\uff0c\u8bf7\u7559\u610f\u3002</p> <p> \u5982\u679c\u6761\u4ef6\u5141\u8bb8\uff0c\u5efa\u8bae\u5404\u4e2a\u96c6\u7fa4\u90fd\u80fd\u72ec\u81ea\u4f7f\u7528\u81ea\u5df1\u7684\u670d\u52a1\u5668\u8d44\u6e90\uff0c\u800c\u975e\u4e0e\u5176\u4ed6\u96c6\u7fa4\u5171\u4eab\uff0c\u4ee5\u514d\u9ad8\u8d1f\u8f7d\u65f6\u5b58\u5728\u8d44\u6e90\u4e89\u62a2\u5bfc\u81f4\u6545\u969c\u7684\u95ee\u9898\u3002</p> <p>\u96c6\u7fa4\u6a21\u5f0f\uff1a\u8d1f\u8f7d\u5747\u8861\u96c6\u7fa4</p> <p>\u5f53\u524d HAProxy \u52a0\u4e0a\u53cc Nginx \u7684\u96c6\u7fa4\u67b6\u6784\u7684\u4f18\u52bf\u548c\u7279\u70b9\uff0c\u53ef\u4ee5\u7528\u4ee5\u4e0b\u7b80\u5355\u6613\u61c2\u7684\u65b9\u5f0f\u6765\u8868\u8fbe\uff1a</p> <p>\u7f51\u7edc\u6d41\u91cf\u7684\u667a\u80fd\u5206\u914d\uff08\u667a\u80fd\u5bfc\u822a\uff09</p> <p>\u60f3\u8c61\u4e00\u4e0b\uff0c\u60a8\u6709\u4e00\u4e2a\u5fd9\u788c\u7684\u5546\u5e97\uff0c\u800c\u4e14\u987e\u5ba2\u7edc\u7ece\u4e0d\u7edd\u3002HAProxy \u50cf\u662f\u4e00\u4e2a\u8d85\u7ea7\u667a\u80fd\u7684\u8fce\u5bbe\uff0c\u5b83\u53ef\u4ee5\u8fc5\u901f\u5224\u65ad\u54ea\u4e2a\u552e\u8d27\u5458\uff08\u5728\u8fd9\u91cc\u662f Nginx \u670d\u52a1\u5668\uff09\u5f53\u524d\u6bd4\u8f83\u7a7a\u95f2\uff0c\u5e76\u8fc5\u901f\u5c06\u65b0\u987e\u5ba2\u5f15\u5bfc\u8fc7\u53bb\u3002\u8fd9\u6837\uff0c\u5c31\u786e\u4fdd\u4e86\u6bcf\u4e2a\u987e\u5ba2\u90fd\u80fd\u5c3d\u5feb\u5f97\u5230\u670d\u52a1\uff0c\u6ca1\u6709\u4e00\u4e2a\u552e\u8d27\u5458\u4f1a\u8fc7\u4e8e\u7e41\u5fd9\u800c\u53e6\u5916\u4e00\u4e9b\u5219\u95f2\u7740\u3002</p> <p>\u670d\u52a1\u7684\u53ef\u9760\u6027\u548c\u6301\u7eed\u6027\uff08\u4e0d\u6253\u70ca\u7684\u5546\u5e97\uff09</p> <p>\u5982\u679c\u5176\u4e2d\u4e00\u4e2a\u552e\u8d27\u5458\u9700\u8981\u4f11\u606f\uff08\u6bd4\u5982\u4e00\u4e2a Nginx \u670d\u52a1\u5668\u51fa\u73b0\u95ee\u9898\uff09\uff0cHAProxy \u8fd9\u4e2a\u8fce\u5bbe\u4f1a\u7acb\u5373\u6ce8\u610f\u5230\uff0c\u5e76\u4e14\u505c\u6b62\u5c06\u987e\u5ba2\u5f15\u5bfc\u5230\u4ed6\u90a3\u91cc\u3002\u76f8\u53cd\uff0c\u5b83\u4f1a\u5c06\u987e\u5ba2\u5f15\u5bfc\u5230\u5176\u4ed6\u80fd\u591f\u63d0\u4f9b\u670d\u52a1\u7684\u552e\u8d27\u5458\u90a3\u91cc\u3002\u8fd9\u5c31\u786e\u4fdd\u4e86\u5546\u5e97\uff08\u60a8\u7684\u7f51\u7ad9\u6216\u5e94\u7528\uff09\u6c38\u8fdc\u90fd\u662f\u5f00\u7740\u7684\uff0c\u603b\u6709\u4eba\u5728\u670d\u52a1\u987e\u5ba2\uff0c\u5373\u4f7f\u67d0\u4e2a\u552e\u8d27\u5458\u9700\u8981\u4e34\u65f6\u79bb\u5f00\u3002</p> <p>\u8f7b\u677e\u5904\u7406\u9ad8\u5cf0\u65f6\u6bb5\uff08\u7e41\u5fd9\u65f6\u5206\u4e5f\u4e0d\u6015\uff09</p> <p>\u5728\u4fc3\u9500\u6d3b\u52a8\u6216\u8005\u8282\u5047\u65e5\u671f\u95f4\uff0c\u5ba2\u6237\u7684\u6570\u91cf\u53ef\u80fd\u4f1a\u6fc0\u589e\u3002\u8fd9\u4e2a\u65f6\u5019\uff0c\u6709\u4e86 HAProxy \u548c\u4e24\u4e2a Nginx \u670d\u52a1\u5668\uff0c\u8fd9\u4e2a\u7cfb\u7edf\u5c31\u50cf\u662f\u62e5\u6709\u4e86\u66f4\u591a\u7684\u552e\u8d27\u5458\u548c\u4e00\u4e2a\u80fd\u5feb\u901f\u4f5c\u51fa\u51b3\u7b56\u7684\u8fce\u5bbe\uff0c\u53ef\u4ee5\u786e\u4fdd\u6bcf\u4e2a\u987e\u5ba2\u5373\u4f7f\u5728\u6700\u7e41\u5fd9\u7684\u65f6\u5019\u4e5f\u80fd\u5f97\u5230\u670d\u52a1\uff0c\u800c\u6ca1\u6709\u4eba\u9700\u8981\u6392\u957f\u961f\u7b49\u5f85\u3002</p> <p>\u5b89\u5168\u4fdd\u969c\uff08\u50cf\u4fdd\u9556\u4e00\u6837\u7684\u5b89\u5168\uff09</p> <p>Nginx \u4e0d\u4ec5\u4ec5\u662f\u552e\u8d27\u5458\u90a3\u4e48\u7b80\u5355\uff0c\u5b83\u8fd8\u50cf\u662f\u5546\u5e97\u7684\u4fdd\u5b89\uff0c\u80fd\u591f\u68c0\u67e5\u6bcf\u4e2a\u8fdb\u6765\u7684\u987e\u5ba2\uff08\u7f51\u7edc\u8bf7\u6c42\uff09\uff0c\u786e\u4fdd\u5b83\u4eec\u662f\u5b89\u5168\u7684\uff0c\u6ca1\u6709\u4eba\u662f\u6765\u6363\u4e71\u7684\u3002\u5982\u679c\u6709\u4efb\u4f55\u53ef\u7591\u7684\u884c\u4e3a\uff0cNginx \u4f1a\u963b\u6b62\u5b83\u4eec\u8fdb\u5165\uff0c\u4fdd\u62a4\u60a8\u7684\u5546\u5e97\uff08\u7f51\u7ad9\u6216\u5e94\u7528\uff09\u4e0d\u53d7\u6076\u610f\u653b\u51fb\u3002</p> <p>\u7075\u6d3b\u6027\u548c\u6269\u5c55\u6027\uff08\u968f\u65f6\u968f\u5730\u6269\u5927\u5546\u5e97\uff09</p> <p>\u968f\u7740\u60a8\u7684\u751f\u610f\u8d8a\u505a\u8d8a\u5927\uff0c\u60a8\u53ef\u80fd\u9700\u8981\u66f4\u591a\u7684\u552e\u8d27\u5458\u548c\u66f4\u5927\u7684\u5546\u5e97\u7a7a\u95f4\u3002\u8fd9\u4e2a\u67b6\u6784\u5c31\u5141\u8bb8\u60a8\u65b9\u4fbf\u5730\u589e\u52a0\u66f4\u591a\u7684 Nginx \u670d\u52a1\u5668\uff08\u552e\u8d27\u5458\uff09\u6765\u5904\u7406\u66f4\u591a\u7684\u6d41\u91cf\uff0c\u6216\u8005\u5347\u7ea7\u73b0\u6709\u7684\u670d\u52a1\u5668\u4ee5\u63d0\u4f9b\u66f4\u5feb\u7684\u670d\u52a1\u3002\u800c\u4e14\u6240\u6709\u8fd9\u4e9b\u90fd\u53ef\u4ee5\u5728\u4e0d\u6253\u6270\u6b63\u5728\u5546\u5e97\u8d2d\u7269\u7684\u987e\u5ba2\u7684\u60c5\u51b5\u4e0b\u5b8c\u6210\u3002</p> <p>\u7b80\u5355\u7684\u7ef4\u62a4\u548c\u7ba1\u7406\uff08\u6613\u4e8e\u6253\u7406\u7684\u5546\u5e97\uff09</p> <p>\u4f7f\u7528 Docker \u548c Docker Compose\uff0c\u6574\u4e2a\u5546\u5e97\u7684\u7ba1\u7406\u53d8\u5f97\u6781\u5176\u7b80\u5355\u3002\u60a8\u53ef\u4ee5\u5f88\u5bb9\u6613\u5730\u5bf9\u552e\u8d27\u5458\u8fdb\u884c\u57f9\u8bad\uff08\u66f4\u65b0\u670d\u52a1\uff09\uff0c\u91cd\u65b0\u5e03\u7f6e\u5546\u5e97\uff08\u4fee\u6539\u914d\u7f6e\uff09\uff0c\u6216\u8005\u5728\u5fc5\u8981\u65f6\u91cd\u65b0\u5f00\u5f20\uff08\u91cd\u542f\u670d\u52a1\uff09\u3002\u6240\u6709\u8fd9\u4e9b\u90fd\u53ef\u4ee5\u901a\u8fc7\u7b80\u5355\u7684\u547d\u4ee4\u5b9e\u73b0\uff0c\u4e0d\u9700\u8981\u590d\u6742\u7684\u6280\u672f\u77e5\u8bc6\u3002</p> <p>\u603b\u800c\u8a00\u4e4b\uff0cHAProxy \u52a0\u4e0a\u53cc Nginx \u7684\u96c6\u7fa4\u5c31\u50cf\u662f\u4e00\u4e2a\u9ad8\u6548\u8fd0\u8f6c\u3001\u6c38\u4e0d\u4f11\u606f\u3001\u5b89\u5168\u53ef\u9760\uff0c\u5e76\u4e14\u968f\u65f6\u51c6\u5907\u6269\u5f20\u7684\u73b0\u4ee3\u5316\u5546\u5e97\uff0c\u5b83\u80fd\u591f\u786e\u4fdd\u6bcf\u4e00\u4f4d\u987e\u5ba2\u90fd\u5f97\u5230\u5feb\u901f\u3001\u5b89\u5168\u7684\u670d\u52a1\uff0c\u540c\u65f6\u4e5f\u4e3a\u5e97\u4e3b\uff08\u5373\u60a8\u7684\u4e1a\u52a1\uff09\u63d0\u4f9b\u4e86\u8f7b\u677e\u7ba1\u7406\u548c\u7ef4\u62a4\u7684\u4fbf\u5229\u3002</p>"},{"location":"docker/Install-Nginx-Cluster/#11","title":"1.1 \u4f7f\u7528\u65b9\u5f0f","text":"<pre><code># \u4e0a\u4f20\u9644\u4ef6\u76ee\u5f55\uff1anginx-cluster \u5230/root\n\n# \u67e5\u770b\u6587\u4ef6\nroot@deepin-1:~# cd nginx-cluster\nroot@deepin-1:~/nginx-cluster# ls -lha \ntotal 31M\ndrwxr-xr-x 5 root root 4.0K Jan 19 17:55 .\ndrwx------ 7 root root 4.0K Jan 19 17:55 ..\ndrwxr-xr-x 2 root root 4.0K Jan 19 16:50 certs\ndrwxr-xr-x 2 root root 4.0K Jan 19 17:39 conf\n-rw-r--r-- 1 root root 1.9K Jan 19 17:33 docker-compose.yaml\n-rw-r--r-- 1 root root   63 Jan 19 14:42 .env.example\n-rw-r--r-- 1 root root  14M Jan 19 14:28 haproxy.tar.gz\ndrwxr-xr-x 2 root root 4.0K Jan 19 15:02 html\n-rw-r--r-- 1 root root  17M Jan 19 11:03 nginx.tar.gz\n\n# html \u662f\u4f60\u672c\u5730\u8d44\u6e90\u76ee\u5f55\uff0c\u9700\u8981\u4e0a\u4f20\u4f60\u81ea\u5df1\u7684\u9759\u6001\u8d44\u6e90\n# conf/nginx.conf \u662f\u4f60\u7684\u4e1a\u52a1nginx \u914d\u7f6e\uff0c\u9700\u8981\u4f60\u81ea\u5df1\u5b9a\u4e49\n\ndocker load -i haproxy.tar.gz \ndocker load -i nginx.tar.gz \ncp .env.example .env\nvim .env # \u8bf7\u7ed3\u5408\u81ea\u5df1\u7684\u60c5\u51b5\u4fee\u6539\u914d\u7f6e\u540e\u518d\u542f\u52a8\ndocker-compose up -d\n</code></pre> <p>\u542f\u52a8\u5b8c\u6210</p> <pre><code>root@deepin-1:~/nginx-cluster# docker-compose ps -a\nNAME                      IMAGE                 COMMAND                  SERVICE   CREATED         STATUS                   PORTS\nnginx-cluster-haproxy-1   haproxy:alpine3.19    \"docker-entrypoint.s\u2026\"   haproxy   3 minutes ago   Up 3 minutes (healthy)   0.0.0.0:8443-&gt;8443/tcp\nnginx-cluster-nginx1-1    nginx:1.25.3-alpine   \"/docker-entrypoint.\u2026\"   nginx1    3 minutes ago   Up 3 minutes (healthy)   80/tcp\nnginx-cluster-nginx2-1    nginx:1.25.3-alpine   \"/docker-entrypoint.\u2026\"   nginx2    3 minutes ago   Up 3 minutes (healthy)   80/tcp\n</code></pre>"},{"location":"docker/Install-Nginx-Cluster/#12","title":"1.2 \u5236\u4f5c\u4efb\u610f\u57df\u540d\u8bc1\u4e66","text":"<p>\u9700\u8981\u4ec0\u4e48\u6837\u57df\u540d\u7684\u8bc1\u4e66\uff0c\u81ea\u5df1\u901a\u8fc7\u4fee\u6539\u8fd9\u91cc\u7684\u57df\u540d\u53ca\u6587\u4ef6\u540d\u79f0\u5373\u53ef</p> <p>\u4ee5\u8981\u4e3a\u57df\u540d<code>localserver.com</code>\u521b\u5efa\u81ea\u7b7e\u540d\u7684SSL\u8bc1\u4e66\u4e3e\u4f8b\uff0c\u53ef\u4ee5\u4f7f\u7528<code>openssl</code>\u547d\u4ee4\u3002\u4ee5\u4e0b\u662f\u4e00\u4e2a\u547d\u4ee4\u884c\u793a\u4f8b\uff0c\u5b83\u5c06\u751f\u6210\u81ea\u7b7e\u540d\u7684SSL\u8bc1\u4e66\u548c\u79c1\u94a5\uff1a</p> <pre><code>openssl req -x509 -nodes -days 3650 -newkey rsa:2048 -keyout localserver.com.key -out localserver.com.crt -subj \"/C=US/ST=State/L=City/O=Organization/CN=localserver.com\"\n</code></pre> <p>\u5408\u5e76\u8bc1\u4e66\u548c\u79c1\u94a5</p> <pre><code>cat localserver.com.crt localserver.com.key &gt; localserver.com.pem\n</code></pre> <p>\u8fd9\u6761\u547d\u4ee4\u6267\u884c\u4e86\u4ee5\u4e0b\u64cd\u4f5c\uff1a</p> <ul> <li><code>req</code>\uff1a\u8fd9\u662f\u5bf9 OpenSSL \u7684\u8bf7\u6c42\uff0c\u542f\u52a8\u8bc1\u4e66\u7b7e\u540d\u8bf7\u6c42 (CSR) \u7ba1\u7406\u3002</li> <li><code>-x509</code>\uff1a\u8fd9\u4f1a\u751f\u6210\u4e00\u4e2a\u81ea\u7b7e\u540d\u7684\u8bc1\u4e66\u800c\u975e\u4ec5\u4ec5\u662f\u4e00\u4e2a CSR\u3002</li> <li><code>-nodes</code>\uff1a\u8fd9\u8868\u793a\u8df3\u8fc7\u4fdd\u62a4\u79c1\u94a5\u6587\u4ef6\u7684\u5bc6\u7801\u3002</li> <li><code>-days 365</code>\uff1a\u8fd9\u4e2a\u8bc1\u4e66\u5c06\u88ab\u8bbe\u7f6e\u4e3a\u4e00\u5e74\u540e\u8fc7\u671f\u3002\u4f60\u53ef\u4ee5\u6839\u636e\u9700\u8981\u6539\u53d8\u8fd9\u4e2a\u503c\u3002</li> <li><code>-newkey rsa:2048</code>\uff1a\u8fd9\u4f1a\u540c\u65f6\u751f\u6210\u65b0\u7684\u8bc1\u4e66\u8bf7\u6c42\u548c 2048 \u4f4d RSA \u5bc6\u94a5\u3002</li> <li><code>-keyout</code>\uff1a\u8fd9\u6307\u5b9a\u4e86\u79c1\u94a5\u6587\u4ef6\u7684\u540d\u79f0\u3002</li> <li><code>-out</code>\uff1a\u8fd9\u6307\u5b9a\u4e86\u8bc1\u4e66\u6587\u4ef6\u7684\u540d\u79f0\u3002</li> <li><code>-subj</code>\uff1a\u8fd9\u5141\u8bb8\u4f60\u4e3a\u4f60\u7684\u8bc1\u4e66\u6307\u5b9a\u6240\u9700\u7684\u4e3b\u9898\u5b57\u6bb5\uff0c\u907f\u514d\u4e86\u624b\u52a8\u8f93\u5165\u3002</li> </ul> <p>\u5728\u4e0a\u9762\u7684\u547d\u4ee4\u4e2d\uff0c\u66ff\u6362 <code>/C=US/ST=State/L=City/O=Organization/CN=localserver.com</code> \u4e2d\u7684\u503c\uff0c\u4ee5\u53cd\u6620\u4f60\u7684\u7ec4\u7ec7\u548c\u4f4d\u7f6e\u7684\u6b63\u786e\u4fe1\u606f\u3002</p> <p>\u6267\u884c\u8fd9\u4e2a\u547d\u4ee4\u540e\uff0c\u4f60\u5c06\u4f1a\u5f97\u5230\u4e24\u4e2a\u6587\u4ef6\uff1a<code>localserver.com.key</code>\uff08\u4f60\u7684\u79c1\u94a5\uff09\u548c<code>localserver.com.crt</code>\uff08\u4f60\u7684\u516c\u5f00\u8bc1\u4e66\uff09\u3002\u8fd9\u4e9b\u6587\u4ef6\u53ef\u4ee5\u5728\u4f60\u7684 HAProxy \u548c Nginx \u914d\u7f6e\u4e2d\u4f7f\u7528\uff0c\u4ee5\u542f\u7528 HTTPS\u3002</p>"},{"location":"docker/Install-Nginx-Cluster/#13","title":"1.3 \u67e5\u770b\u65e5\u5fd7","text":"<p>\u6253\u5f00\u4e00\u4e2a\u8fdc\u7a0b\u7a97\u53e3\uff0c\u67e5\u770bnginx1\u65e5\u5fd7\u3002</p> <pre><code>root@deepin-1:~/nginx-cluster# tail -100f /data/logs/nginx1/access.log \n192.168.128.2 - - [19/Jan/2024:17:41:00 +0800] \"HEAD / HTTP/1.0\" 200 0 \"-\" \"-\"\n192.168.128.2 - - [19/Jan/2024:17:41:07 +0800] \"GET / HTTP/1.1\" 200 755 \"-\" \"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36\"\n192.168.128.2 - - [19/Jan/2024:17:41:10 +0800] \"HEAD / HTTP/1.0\" 200 0 \"-\" \"-\"\n192.168.128.2 - - [19/Jan/2024:17:41:15 +0800] \"GET / HTTP/1.1\" 200 755 \"-\" \"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36\"\n192.168.128.2 - - [19/Jan/2024:17:41:15 +0800] \"GET / HTTP/1.1\" 200 755 \"-\" \"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36\"\n192.168.128.2 - - [19/Jan/2024:17:41:15 +0800] \"GET / HTTP/1.1\" 200 755 \"-\" \"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36\"\n192.168.128.2 - - [19/Jan/2024:17:41:20 +0800] \"HEAD / HTTP/1.0\" 200 0 \"-\" \"-\"\n</code></pre> <p>\u6253\u5f00\u53e6\u5916\u4e00\u4e2a\u8fdc\u7a0b\u7a97\u53e3\uff0c\u67e5\u770bnginx2\u65e5\u5fd7\u3002</p> <pre><code>root@deepin-1:~# tail -100f /data/logs/nginx2/access.log \n192.168.128.2 - - [19/Jan/2024:17:40:54 +0800] \"HEAD / HTTP/1.0\" 200 0 \"-\" \"-\"\n192.168.128.2 - - [19/Jan/2024:17:40:57 +0800] \"GET / HTTP/1.1\" 200 755 \"-\" \"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36\"\n192.168.128.2 - - [19/Jan/2024:17:41:04 +0800] \"HEAD / HTTP/1.0\" 200 0 \"-\" \"-\"\n192.168.128.2 - - [19/Jan/2024:17:41:14 +0800] \"HEAD / HTTP/1.0\" 200 0 \"-\" \"-\"\n192.168.128.2 - - [19/Jan/2024:17:41:14 +0800] \"GET / HTTP/1.1\" 200 755 \"-\" \"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36\"\n192.168.128.2 - - [19/Jan/2024:17:41:15 +0800] \"GET / HTTP/1.1\" 200 755 \"-\" \"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36\"\n192.168.128.2 - - [19/Jan/2024:17:41:15 +0800] \"GET / HTTP/1.1\" 200 755 \"-\" \"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36\"\n192.168.128.2 - - [19/Jan/2024:17:41:24 +0800] \"HEAD / HTTP/1.0\" 200 0 \"-\" \"-\"\n</code></pre> <p>\u5728\u6d4f\u89c8\u5668\u4e2d\u5237\u65b0\u9875\u9762\uff0c\u80fd\u53d1\u73b0nginx1 \u4e0enginx2 \u5904\u7406\u7684\u8bf7\u6c42\u662f\u5747\u7b49\u7684\u3002</p> <p>\u4e5f\u80fd\u901a\u8fc7haproxy \u65e5\u5fd7\u67e5\u770b\u5230</p> <pre><code>root@deepin-1:~/nginx-cluster# docker logs -f --tail 1000 nginx-cluster-haproxy-1\n[NOTICE]   (1) : New worker (7) forked\n[NOTICE]   (1) : Loading success.\n192.168.171.1:2667 [19/Jan/2024:09:48:25.386] https_in/1: SSL handshake failure (error:0A000416:SSL routines::sslv3 alert certificate unknown)\n192.168.171.1:2668 [19/Jan/2024:09:48:25.391] https_in~ http_servers/nginx1 0/0/5/0/5 200 1057 - - ---- 1/1/0/0/0 0/0 \"GET https://192.168.171.153/ HTTP/2.0\"\n192.168.171.1:2668 [19/Jan/2024:09:48:25.415] https_in~ http_servers/nginx2 0/0/7/0/7 404 671 - - ---- 1/1/0/0/0 0/0 \"GET https://192.168.171.153/favicon.ico HTTP/2.0\"\n192.168.171.1:2668 [19/Jan/2024:09:48:27.306] https_in~ http_servers/nginx1 0/0/0/0/0 200 1057 - - ---- 1/1/0/0/0 0/0 \"GET https://192.168.171.153/ HTTP/2.0\"\n192.168.171.1:2668 [19/Jan/2024:09:48:27.632] https_in~ http_servers/nginx2 0/0/0/1/1 200 1057 - - ---- 1/1/0/0/0 0/0 \"GET https://192.168.171.153/ HTTP/2.0\"\n192.168.171.1:2668 [19/Jan/2024:09:48:27.809] https_in~ http_servers/nginx1 0/0/0/0/0 200 1057 - - ---- 1/1/0/0/0 0/0 \"GET https://192.168.171.153/ HTTP/2.0\"\n</code></pre>"},{"location":"docker/Install-Openresty/","title":"Install Openresty","text":""},{"location":"docker/Install-Openresty/#compose-file","title":"Compose file","text":"<pre><code>version: '3'\nservices:\n  openresty:\n    image: harbor.dockerregistry.com/app/openresty:1.21.4.1-3-alpine\n    container_name: openresty\n    ports:\n      - 8868:8868\n    volumes:\n      - /etc/localtime:/etc/localtime:ro\n      - ./routerRebuild.lua:/usr/local/openresty/nginx/luapackage/routerRebuild.lua\n      - ./nginx.conf:/usr/local/openresty/nginx/conf/nginx.conf\n    restart: always\n</code></pre>"},{"location":"docker/Install-Openresty/#nginxconf","title":"nginx.conf","text":"<pre><code>worker_processes  auto;\nerror_log  logs/error.log  info;\nevents {\n    worker_connections  4096;\n}\nhttp {\n    default_type  application/octet-stream;\n    access_log  logs/access.log;\n    keepalive_requests 8192;\n    keepalive_timeout 180;\n    client_body_buffer_size 2000m;\n    client_max_body_size 2000m;\n    log_format  proxy   '$remote_addr - $remote_user [$time_local] \"$request\" - $http_host '\n    'status:$status $body_bytes_sent \"$http_referer\" '\n    '\"$http_user_agent\" \"$http_x_forwarded_for\"';\n    lua_package_path '/usr/local/openresty/nginx/luapackage/?.lua;;';\n    server {\n        listen       8868;\n        server_name  openrestry.com;\n        default_type text/html;\n        client_header_buffer_size 1024k;\n        large_client_header_buffers 4 1024k;\n        fastcgi_buffers             6 512k;\n        fastcgi_busy_buffers_size   512k;\n        fastcgi_temp_file_write_size        512k;\n        fastcgi_intercept_errors    on;\n        charset utf-8;\n        location = /favicon.ico {\n            client_body_buffer_size 100m;\n            log_not_found off;\n            access_log off;\n        }\n\n        location / {\n            resolver 1.1.1.1;\n            set $target '';\n            access_by_lua '\n                    -- ngx.say(\"&lt;p&gt;hello, world&lt;/p&gt;\")\n                    local routerUtil = require (\"routerRebuild\")\n                    ngx.var.target = routerUtil.buildURL()\n            ';\n            proxy_pass $target;\n            proxy_set_header Host  $proxy_host;\n            proxy_http_version 1.1;\n            proxy_set_header X-Real-IP $remote_addr;\n            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;\n            add_header 'Access-Control-Allow-Origin' '*';\n            add_header 'Access-Control-Allow-Credentials' 'true';\n            add_header 'Access-Control-Allow-Methods' 'GET,POST,OPTIONS';\n            add_header 'Access-Control-Allow-Headers' 'Origin, X-Requested-With, Content-Type, Accept, Connection, User-Agent, Cookie';\n            proxy_connect_timeout 3000;\n            proxy_set_header Connection keep-alive;\n            proxy_send_timeout 3000;\n            proxy_read_timeout 6000;\n        }\n    }\n}\n</code></pre>"},{"location":"docker/Install-Postgresql-Cluster/","title":"Install Postgresql Cluster","text":""},{"location":"docker/Install-Postgresql-Cluster/#postgresql","title":"\u90e8\u7f72Postgresql \u96c6\u7fa4","text":"<p> \u8fd9\u91cc\u90e8\u7f72\u548c\u7ef4\u62a4\u90fd\u662f\u5728/root \u76ee\u5f55\u4e0b\uff0c\u64cd\u4f5c\u90fd\u662f\u4f7f\u7528<code>root</code>\u7528\u6237\uff0c\u8bf7\u7559\u610f\u3002</p> <p> \u5982\u679c\u6761\u4ef6\u5141\u8bb8\uff0c\u5efa\u8bae\u5404\u4e2a\u96c6\u7fa4\u90fd\u80fd\u72ec\u81ea\u4f7f\u7528\u81ea\u5df1\u7684\u670d\u52a1\u5668\u8d44\u6e90\uff0c\u800c\u975e\u4e0e\u5176\u4ed6\u96c6\u7fa4\u5171\u4eab\uff0c\u4ee5\u514d\u9ad8\u8d1f\u8f7d\u65f6\u5b58\u5728\u8d44\u6e90\u4e89\u62a2\u5bfc\u81f4\u6545\u969c\u7684\u95ee\u9898\u3002</p>"},{"location":"docker/Install-Postgresql-Cluster/#11","title":"1.1 \u4f7f\u7528\u65b9\u5f0f","text":"<pre><code># \u4e0a\u4f20\u90e8\u7f72\u6587\u4ef6\npostgresql-cluster\n\n# \u5bfc\u5165\u955c\u50cf\ncd postgresql-cluster\ndocker load -i postgresql-repmgr.tar\n\n# \u521b\u5efa\u76ee\u5f55\u5e76\u6388\u6743\nmkdir -p /data/postgres/{master,standby1,standby2,witness}\nchown -R 1001:1001 /data/postgres/\nchmod -R 700       /data/postgres/\n\n# \u81ea\u5b9a\u4e49\u914d\u7f6e\ncp .env.example .env\nvim .env # \u8bf7\u7ed3\u5408\u81ea\u5df1\u7684\u60c5\u51b5\u4fee\u6539\u914d\u7f6e\u540e\u518d\u542f\u52a8\n\n# \u542f\u52a8\ndocker-compose up -d\n</code></pre> <p>\u5b8c\u6210\u542f\u52a8\u540e\uff1a</p> <pre><code>root@DEVOPS:~/postgresql-cluster# docker-compose ps -a \nNAME                         IMAGE                                    COMMAND                  SERVICE   CREATED          STATUS          PORTS\npostgresql-cluster-pg-0-1    docker.io/bitnami/postgresql-repmgr:16   \"/opt/bitnami/script\u2026\"   pg-0      10 minutes ago   Up 10 minutes   0.0.0.0:5433-&gt;5432/tcp, :::5433-&gt;5432/tcp\npostgresql-cluster-pg-1-1    docker.io/bitnami/postgresql-repmgr:16   \"/opt/bitnami/script\u2026\"   pg-1      10 minutes ago   Up 10 minutes   0.0.0.0:5434-&gt;5432/tcp, :::5434-&gt;5432/tcp\npostgresql-cluster-pg-2-1    docker.io/bitnami/postgresql-repmgr:16   \"/opt/bitnami/script\u2026\"   pg-2      10 minutes ago   Up 10 minutes   0.0.0.0:5455-&gt;5432/tcp, :::5455-&gt;5432/tcp\npostgresql-cluster-pgw-0-1   docker.io/bitnami/postgresql-repmgr:16   \"/opt/bitnami/script\u2026\"   pgw-0     10 minutes ago   Up 10 minutes   0.0.0.0:5456-&gt;5432/tcp, :::5456-&gt;5432/tcp\n</code></pre> <p>\u8fd9\u91cc\u7684<code>postgresql-cluster-pg-0-1</code> \u5373\u4e3a\u9ed8\u8ba4\u7684\u4e3b\u6570\u636e\u5e93\u3002\u5ba2\u6237\u7aef\u8fde\u63a5\u6570\u636e\u5e93\u65f6\u4f7f\u7528<code>\u4e3b\u673aIP + \u4e3b\u6570\u636e\u5e93\u7684\u7aef\u53e3 + \u81ea\u5b9a\u4e49\u7684\u5bc6\u7801</code>\u6765\u8fde\u63a5\u5373\u53ef\u3002</p>"},{"location":"docker/Install-Postgresql-Cluster/#12","title":"1.2 \u9a8c\u8bc1\u65b9\u5f0f","text":""},{"location":"docker/Install-Postgresql-Cluster/#121-shell","title":"1.2.1 \u6267\u884cSHELL","text":"<pre><code>root@DEVOPS:~/postgresql-cluster# docker-compose exec -it pg-1 bash\nI have no name!@b35644d432db:/$ /opt/bitnami/scripts/postgresql-repmgr/entrypoint.sh repmgr -f /opt/bitnami/repmgr/conf/repmgr.conf cluster show\nsql-repmgr 16:08:48.21postgresql-repmgr 03:27:29.99 INFO  ==&gt; \npostgresql-repmgr 03:27:29.99 INFO  ==&gt; Welcome to the Bitnami postgresql-repmgr container\npostgresql-repmgr 03:27:29.99 INFO  ==&gt; Subscribe to project updates by watching https://github.com/bitnami/containers\npostgresql-repmgr 03:27:29.99 INFO  ==&gt; Submit issues and feature requests at https://github.com/bitnami/containers/issues\npostgresql-repmgr 03:27:29.99 INFO  ==&gt;\n\n ID   | Name  | Role    | Status    | Upstream | Location | Priority | Timeline | Connection string\n------+-------+---------+-----------+----------+----------+----------+----------+------------------------------------------------------------------------------------------\n 1000 | pg-0  | primary | * running |          | default  | 100      | 1        | user=repmgr password=repmgrpassword host=pg-0 dbname=repmgr port=5432 connect_timeout=5\n 1001 | pg-1  | standby |   running | pg-0     | default  | 100      | 1        | user=repmgr password=repmgrpassword host=pg-1 dbname=repmgr port=5432 connect_timeout=5\n 1002 | pg-2  | standby |   running | pg-0     | default  | 100      | 1        | user=repmgr password=repmgrpassword host=pg-2 dbname=repmgr port=5432 connect_timeout=5\n 2000 | pgw-0 | witness | * running | pg-0     | default  | 0        | n/a      | user=repmgr password=repmgrpassword host=pgw-0 dbname=repmgr port=5432 connect_timeout=5\nI have no name!@b35644d432db:/$\n</code></pre>"},{"location":"docker/Install-Postgresql-Cluster/#122-sql","title":"1.2.2 \u6267\u884cSQL","text":"<pre><code>SELECT * FROM pg_replication_slots;\n\nSELECT * FROM pg_stat_replication;\n\n\nSELECT\n  application_name,\n  state,\n  sync_priority,\n  sync_state,\n  pg_wal_lsn_diff(pg_current_wal_lsn(), replay_lsn) AS replication_lag\nFROM\n  pg_stat_replication;\n\n\nSELECT pg_last_wal_receive_lsn() = pg_last_wal_replay_lsn() AS is_synced;\n</code></pre>"},{"location":"docker/Install-Postgresql-Cluster/#123","title":"1.2.3 \u6545\u969c\u8f6c\u79fb","text":"<p>\u624b\u52a8\u5173\u95ed\u4e3b\u6570\u636e\u5e93\uff0c\u9759\u5f8530s~60s\u5de6\u53f3\uff0c\u7b49\u96c6\u7fa4\u68c0\u67e5\u4e3b\u6570\u636e\u5e93\u5b8c\u5168\u8fde\u63a5\u91cd\u8bd5\u8d85\u65f6\u540e\uff0c\u518d\u67e5\u4e3b\u4ece\u5173\u7cfb\uff0c\u5373\u53ef\u53d1\u73b0\u4e3b\u6570\u636e\u5e93\u7684\u89d2\u8272\u5df2\u7ecf\u7531\u539f\u6765\u7684\u4ece\u5e93\u81ea\u52a8\u7ee7\u627f\u5e76\u5207\u6362\u4e86\u3002</p> <pre><code>root@DEVOPS:~/postgresql-cluster# docker stop postgresql-cluster-pg-0-1 \nroot@DEVOPS:~/postgresql-cluster# docker-compose exec -it pg-1 bash\nI have no name!@e78ebc8e36de:/$ /opt/bitnami/scripts/postgresql-repmgr/entrypoint.sh repmgr -f /opt/bitnami/repmgr/conf/repmgr.conf cluster show\npostgresql-repmgr 06:35:14.77 INFO  ==&gt; \npostgresql-repmgr 06:35:14.77 INFO  ==&gt; Welcome to the Bitnami postgresql-repmgr container\npostgresql-repmgr 06:35:14.77 INFO  ==&gt; Subscribe to project updates by watching https://github.com/bitnami/containers\npostgresql-repmgr 06:35:14.77 INFO  ==&gt; Submit issues and feature requests at https://github.com/bitnami/containers/issues\npostgresql-repmgr 06:35:14.78 INFO  ==&gt;\n\n\n ID   | Name  | Role    | Status    | Upstream | Location | Priority | Timeline | Connection string\n------+-------+---------+-----------+----------+----------+----------+----------+------------------------------------------------------------------------------------------\n 1000 | pg-0  | primary | - failed  | ?        | default  | 100      |          | user=repmgr password=repmgrpassword host=pg-0 dbname=repmgr port=5432 connect_timeout=5\n 1001 | pg-1  | primary | * running |          | default  | 100      | 2        | user=repmgr password=repmgrpassword host=pg-1 dbname=repmgr port=5432 connect_timeout=5\n 1002 | pg-2  | standby |   running | pg-1     | default  | 100      | 1        | user=repmgr password=repmgrpassword host=pg-2 dbname=repmgr port=5432 connect_timeout=5\n 2000 | pgw-0 | witness | * running | pg-1     | default  | 0        | n/a      | user=repmgr password=repmgrpassword host=pgw-0 dbname=repmgr port=5432 connect_timeout=5\n\nWARNING: following issues were detected\n  - unable to connect to node \"pg-0\" (ID: 1000)\n\nHINT: execute with --verbose option to see connection error messages\n</code></pre> <p>\u518d\u624b\u52a8\u6062\u590d\u4e4b\u524d\u6545\u969c\u7684\u4e3b\u6570\u636e\u5e93\uff0c\u80fd\u53d1\u73b0\u65b0\u7684\u4e3b\u4ece\u5173\u7cfb\u5e76\u672a\u53d1\u751f\u53d8\u66f4\uff0c\u800c\u662f\u65e7\u7684\u4e3b\u6570\u636e\u5e93\u81ea\u52a8\u6ce8\u518c\u6210\u4ece\u6570\u636e\u5e93\u3002</p> <pre><code>root@DEVOPS:~/postgresql-cluster# docker-compose ps -a \nNAME                         IMAGE                                    COMMAND                  SERVICE   CREATED         STATUS                     PORTS\npostgresql-cluster-pg-0-1    docker.io/bitnami/postgresql-repmgr:16   \"/opt/bitnami/script\u2026\"   pg-0      8 minutes ago   Exited (0) 7 minutes ago\npostgresql-cluster-pg-1-1    docker.io/bitnami/postgresql-repmgr:16   \"/opt/bitnami/script\u2026\"   pg-1      8 minutes ago   Up 8 minutes               0.0.0.0:5434-&gt;5432/tcp, :::5434-&gt;5432/tcp\npostgresql-cluster-pg-2-1    docker.io/bitnami/postgresql-repmgr:16   \"/opt/bitnami/script\u2026\"   pg-2      8 minutes ago   Up 8 minutes               0.0.0.0:5455-&gt;5432/tcp, :::5455-&gt;5432/tcp\npostgresql-cluster-pgw-0-1   docker.io/bitnami/postgresql-repmgr:16   \"/opt/bitnami/script\u2026\"   pgw-0     8 minutes ago   Up 8 minutes               0.0.0.0:5456-&gt;5432/tcp, :::5456-&gt;5432/tcp\nroot@DEVOPS:~/postgresql-cluster# docker start postgresql-cluster-pg-0-1\npostgresql-cluster-pg-0-1\nroot@DEVOPS:~/postgresql-cluster# docker-compose ps -a\nNAME                         IMAGE                                    COMMAND                  SERVICE   CREATED         STATUS         PORTS\npostgresql-cluster-pg-0-1    docker.io/bitnami/postgresql-repmgr:16   \"/opt/bitnami/script\u2026\"   pg-0      9 minutes ago   Up 1 second    0.0.0.0:5433-&gt;5432/tcp, :::5433-&gt;5432/tcp\npostgresql-cluster-pg-1-1    docker.io/bitnami/postgresql-repmgr:16   \"/opt/bitnami/script\u2026\"   pg-1      9 minutes ago   Up 9 minutes   0.0.0.0:5434-&gt;5432/tcp, :::5434-&gt;5432/tcp\npostgresql-cluster-pg-2-1    docker.io/bitnami/postgresql-repmgr:16   \"/opt/bitnami/script\u2026\"   pg-2      9 minutes ago   Up 9 minutes   0.0.0.0:5455-&gt;5432/tcp, :::5455-&gt;5432/tcp\npostgresql-cluster-pgw-0-1   docker.io/bitnami/postgresql-repmgr:16   \"/opt/bitnami/script\u2026\"   pgw-0     9 minutes ago   Up 9 minutes   0.0.0.0:5456-&gt;5432/tcp, :::5456-&gt;5432/tcp\n\nroot@DEVOPS:~/postgresql-cluster# docker-compose exec -it pg-1 bash\nI have no name!@e78ebc8e36de:/$ \nI have no name!@e78ebc8e36de:/$ /opt/bitnami/scripts/postgresql-repmgr/entrypoint.sh repmgr -f /opt/bitnami/repmgr/conf/repmgr.conf cluster show\npostgresql-repmgr 06:41:48.43 INFO  ==&gt; \npostgresql-repmgr 06:41:48.43 INFO  ==&gt; Welcome to the Bitnami postgresql-repmgr container\npostgresql-repmgr 06:41:48.43 INFO  ==&gt; Subscribe to project updates by watching https://github.com/bitnami/containers\npostgresql-repmgr 06:41:48.43 INFO  ==&gt; Submit issues and feature requests at https://github.com/bitnami/containers/issues\npostgresql-repmgr 06:41:48.43 INFO  ==&gt;\n\n ID   | Name  | Role    | Status    | Upstream | Location | Priority | Timeline | Connection string\n------+-------+---------+-----------+----------+----------+----------+----------+------------------------------------------------------------------------------------------\n 1000 | pg-0  | standby |   running | pg-1     | default  | 100      | 2        | user=repmgr password=repmgrpassword host=pg-0 dbname=repmgr port=5432 connect_timeout=5\n 1001 | pg-1  | primary | * running |          | default  | 100      | 2        | user=repmgr password=repmgrpassword host=pg-1 dbname=repmgr port=5432 connect_timeout=5\n 1002 | pg-2  | standby |   running | pg-1     | default  | 100      | 2        | user=repmgr password=repmgrpassword host=pg-2 dbname=repmgr port=5432 connect_timeout=5\n 2000 | pgw-0 | witness | * running | pg-1     | default  | 0        | n/a      | user=repmgr password=repmgrpassword host=pgw-0 dbname=repmgr port=5432 connect_timeout=5\n</code></pre> <p>\u6d4b\u8bd5\u5b8c\u6210\u540e\uff0c\u6e05\u7406\u96c6\u7fa4\uff0c\u6e05\u7406\u6570\u636e\u76ee\u5f55\uff0c\u7136\u540e\u8fd8\u539f\u90e8\u7f72</p> <pre><code>I have no name!@e78ebc8e36de:/$ \nexit\nroot@DEVOPS:~/postgresql-cluster# docker-compose down \n[+] Running 5/5\n \u2714 Container postgresql-cluster-pg-1-1   Removed                                                                                                                                                                                     1.3s \n \u2714 Container postgresql-cluster-pg-2-1   Removed                                                                                                                                                                                     0.9s \n \u2714 Container postgresql-cluster-pgw-0-1  Removed                                                                                                                                                                                     1.5s \n \u2714 Container postgresql-cluster-pg-0-1   Removed                                                                                                                                                                                     1.4s \n \u2714 Network postgresql-cluster_default    Removed                                                                                                                                                                                     0.7s \nroot@DEVOPS:~/postgresql-cluster# rm /data/postgres/ -rf \n\nroot@DEVOPS:~/postgresql-cluster# mkdir -p /data/postgres/{master,standby1,standby2,witness}\nroot@DEVOPS:~/postgresql-cluster# chown -R 1001:1001 /data/postgres/\nroot@DEVOPS:~/postgresql-cluster# chmod -R 700       /data/postgres/\nroot@DEVOPS:~/postgresql-cluster# docker-compose up -d \n[+] Running 5/5\n \u2714 Network postgresql-cluster_default    Created                                                                                                                                                                                     0.2s \n \u2714 Container postgresql-cluster-pgw-0-1  Started                                                                                                                                                                                     0.0s \n \u2714 Container postgresql-cluster-pg-1-1   Started                                                                                                                                                                                     0.0s \n \u2714 Container postgresql-cluster-pg-0-1   Started                                                                                                                                                                                     0.0s \n \u2714 Container postgresql-cluster-pg-2-1   Started                                                                                                                                                                                     0.0s \nroot@DEVOPS:~/postgresql-cluster# docker-compose ps -a \nNAME                         IMAGE                                    COMMAND                  SERVICE   CREATED         STATUS         PORTS\npostgresql-cluster-pg-0-1    docker.io/bitnami/postgresql-repmgr:16   \"/opt/bitnami/script\u2026\"   pg-0      5 seconds ago   Up 4 seconds   0.0.0.0:5433-&gt;5432/tcp, :::5433-&gt;5432/tcp\npostgresql-cluster-pg-1-1    docker.io/bitnami/postgresql-repmgr:16   \"/opt/bitnami/script\u2026\"   pg-1      5 seconds ago   Up 4 seconds   0.0.0.0:5434-&gt;5432/tcp, :::5434-&gt;5432/tcp\npostgresql-cluster-pg-2-1    docker.io/bitnami/postgresql-repmgr:16   \"/opt/bitnami/script\u2026\"   pg-2      5 seconds ago   Up 5 seconds   0.0.0.0:5455-&gt;5432/tcp, :::5455-&gt;5432/tcp\npostgresql-cluster-pgw-0-1   docker.io/bitnami/postgresql-repmgr:16   \"/opt/bitnami/script\u2026\"   pgw-0     5 seconds ago   Up 4 seconds   0.0.0.0:5456-&gt;5432/tcp, :::5456-&gt;5432/tcp\n</code></pre>"},{"location":"docker/Install-Postgresql-Cluster/#124","title":"1.2.4 \u6570\u636e\u5907\u4efd","text":"<pre><code># \u624b\u52a8\u6267\u884c\u7269\u7406\u5907\u4efd\ndeepin-1:~/postgresql-cluster# ./pg_basebackup.sh \npostgresql-repmgr 02:56:17.79 INFO  ==&gt; \npostgresql-repmgr 02:56:17.80 INFO  ==&gt; Welcome to the Bitnami postgresql-repmgr container\npostgresql-repmgr 02:56:17.80 INFO  ==&gt; Subscribe to project updates by watching https://github.com/bitnami/containers\npostgresql-repmgr 02:56:17.80 INFO  ==&gt; Submit issues and feature requests at https://github.com/bitnami/containers/issues\npostgresql-repmgr 02:56:17.80 INFO  ==&gt; \n\n ID   | Name  | Role    | Status    | Upstream | Location | Priority | Timeline | Connection string                                                                       \n------+-------+---------+-----------+----------+----------+----------+----------+------------------------------------------------------------------------------------------\n 1000 | pg-0  | standby |   running | pg-1     | default  | 100      | 2        | user=repmgr password=repmgrpassword host=pg-0 dbname=repmgr port=5432 connect_timeout=5 \n 1001 | pg-1  | primary | * running |          | default  | 100      | 2        | user=repmgr password=repmgrpassword host=pg-1 dbname=repmgr port=5432 connect_timeout=5 \n 1002 | pg-2  | standby |   running | pg-1     | default  | 100      | 2        | user=repmgr password=repmgrpassword host=pg-2 dbname=repmgr port=5432 connect_timeout=5 \n 2000 | pgw-0 | witness | * running | pg-1     | default  | 0        | n/a      | user=repmgr password=repmgrpassword host=pgw-0 dbname=repmgr port=5432 connect_timeout=5\nBackup was successful on the primary node (pg-1).\n\n# \u5907\u4efd\u65e5\u5fd7\u4f4d\u7f6e\ndeepin-1:~/postgresql-cluster# ll /data/postgresql_backup/\ntotal 44\n-rw-r--r-- 1 root root    80 Feb  4 18:02 2024-02-04_backup.log\n-rw-r--r-- 1 root root 33256 Feb  5 10:56 2024-02-05_backup.log\n\n# \u9ed8\u8ba4\u5f00\u542f\u5f52\u6863\u3002\ndeepin-1:~/postgresql-cluster# ll /data/postgres/standby1/data/pg_wal/\ntotal 180236\n-rw------- 1 1001 root 16777216 Feb  4 11:52 000000010000000000000007\n-rw------- 1 1001 root 16777216 Feb  4 17:19 000000010000000000000008\n-rw------- 1 1001 root 16777216 Feb  4 17:19 000000010000000000000009\n-rw------- 1 1001 root 16777216 Feb  4 17:24 00000001000000000000000A.partial\n-rw------- 1 1001 root 16777216 Feb  4 17:47 00000002000000000000000A\n-rw------- 1 1001 root 16777216 Feb  4 17:47 00000002000000000000000B\n-rw------- 1 1001 root 16777216 Feb  5 10:22 00000002000000000000000C\n-rw------- 1 1001 root 16777216 Feb  5 10:22 00000002000000000000000D\n-rw------- 1 1001 root 16777216 Feb  5 10:56 00000002000000000000000E\n-rw------- 1 1001 root 16777216 Feb  5 10:56 00000002000000000000000F\n-rw------- 1 1001 root      338 Feb  5 10:56 00000002000000000000000F.00000028.backup\n-rw------- 1 1001 root 16777216 Feb  5 10:56 000000020000000000000010\n-rw------- 1 1001 root       41 Feb  4 17:47 00000002.history\ndrwx------ 2 1001 root     4096 Feb  5 10:56 archive_status\n\n# \u662f\u5426\u9700\u8981\u6267\u884c\u5b9a\u65f6\u7269\u7406\u5907\u4efd\uff0c\u53d6\u51b3\u4e8e\u81ea\u5df1\u7684\u9879\u76ee\uff0c\u4e0d\u518d\u8d58\u8ff0\u3002\n</code></pre>"},{"location":"docker/Install-Postgresql-Cluster/#13","title":"1.3 \u9ad8\u53ef\u7528\u96c6\u7fa4\u6a21\u5f0f","text":""},{"location":"docker/Install-Postgresql-Cluster/#131","title":"1.3.1 \u9700\u6c42\u80cc\u666f","text":"<p>\u5728\u4e0a\u9762\u4e3b\u4ece\u96c6\u7fa4\u4e0a\u9762\uff0c\u867d\u7136\u80fd\u591f\u505a\u5230\u6545\u969c\u81ea\u52a8\u8f6c\u79fb\uff0c\u4f46\u662f\u56e0\u4e3a\u5e94\u7528\u7a0b\u5e8f\u662f\u8fde\u63a5\u7684\u4e3b\u6570\u636e\u5e93\uff0c\u6240\u4ee5\u4e3b\u4ece\u5173\u7cfb\u53d8\u4e86\uff0c\u914d\u7f6e\u5c31\u9700\u8981\u540c\u6b65\u66f4\u65b0+\u91cd\u542f\u6240\u6709\u5e94\u7528\u7a0b\u5e8f\u4ee5\u751f\u6548\u65b0\u7684\u4e3b\u6570\u636e\u5e93\u3002\u8fd9\u6837\u4e00\u6765\u5c31\u5b58\u5728\u4e00\u5b9a\u591a\u4f59\u7684\u4eba\u5de5\u6210\u672c\uff0c\u56e0\u6b64\u9700\u8981\u5bf9\u5e94\u7528\u5c4f\u853d\u8fd9\u5c42\u590d\u6742\u6027\uff0c\u8ba9\u5e94\u7528\u5bf9\u6545\u969c\u8f6c\u79fb\u8fc7\u7a0b\u4e2d\u7684\u4e3b\u4ece\u5173\u7cfb\u53d8\u66f4\u5b8c\u5168\u65e0\u611f\u77e5\u3002</p>"},{"location":"docker/Install-Postgresql-Cluster/#132","title":"1.3.2 \u903b\u8f91\u67b6\u6784","text":"<p>\u5177\u4f53\u5b9e\u73b0\u65b9\u6848\u5373\u901a\u8fc7<code>VIP + Keepalived + Haproxy</code> \u65b9\u6848\u5b9e\u73b0\u5185\u7f51\u7684LB \u8d1f\u8f7d\u540c\u65f6\u9690\u85cf\u540e\u7aef\u771f\u5b9e\u4e3b\u4ece\u5173\u7cfb\u3002</p> <p>\u4e4b\u524d\u7528\u6237\u7684\u5e94\u7528\u662f\u901a\u8fc7\u4e3b\u6570\u636e\u5e93\u7684IP\u548c\u7aef\u53e3\u8fde\u63a5\uff0c\u73b0\u5728\u5373\u4e3a<code>VIP+\u7aef\u53e3</code> \u6765\u914d\u7f6e\u4f7f\u7528\u5373\u53ef\u3002</p> <p>\u903b\u8f91\u67b6\u6784\u5982\u4e0b\u56fe\uff1a</p> <pre><code>graph TB\n    VIP(VIP) ---|Keepalived| keep1(Keepalived Node 1)\n    VIP ---|Keepalived| keep2(Keepalived Node 2)\n    keep1 --- haproxy1(HAProxy Node 1)\n    keep2 --- haproxy2(HAProxy Node 2)\n    haproxy1 --- master((pg-repmgr - Master))\n    haproxy2 --- master\n    master --- slave1[pg-repmgr - Slave 1]\n    master --- slave2[pg-repmgr - Slave 2]\n    master --- witness[pg-repmgr - Witness]</code></pre> <p>\u4f18\u70b9\uff1a</p> <ol> <li>\u4e0d\u7528\u518d\u62c5\u5fc3\u96c6\u7fa4\u53d1\u751f\u6545\u969c\u8f6c\u79fb\u540e\u9700\u8981\u66f4\u65b0\u914d\u7f6e\u4e0e\u91cd\u542f\u5e94\u7528\u3002</li> <li>\u771f\u6b63\u610f\u4e49\u4e0a\u7684\u9ad8\u53ef\u7528\uff08\u5982\u679c\u5ffd\u7565\u4e0a\u9762\u6570\u636e\u5e93\u96c6\u7fa4\u662f\u90e8\u7f72\u5728\u5355\u4e2aDocker\u4e3b\u673a\u4e0a\u9762\u7684\u8bdd\uff09\u3002</li> </ol> <p>\u7f3a\u70b9\uff1a</p> <ol> <li>\u9700\u8981\u589e\u52a0\u4e24\u53f0\u4f4e\u914d\u7f6e\u7684\u670d\u52a1\u5668\u6765\u505aLB \u8282\u70b9\u3002</li> <li>\u9700\u8981\u5728\u4e24\u53f0LB \u8282\u70b9\u5206\u522b\u90e8\u7f72<code>Keepalived + Haproxy</code> \u3002</li> <li>\u9700\u8981\u4e1a\u4e3b\u63d0\u4f9b\u4e00\u4e2a\u5185\u7f51\u672a\u88ab\u4f7f\u7528\u7684IP\u5730\u5740\uff0c\u4e14\u4ee5\u540e\u4e5f\u4e0d\u53ef\u4ee5\u88ab\u5360\u7528\u6216\u4f7f\u7528\uff0c\u7528\u6765\u505aVIP \u4f7f\u7528\u3002</li> </ol> <p>\u7efc\u4e0a\uff0c\u8bf7\u7ed3\u5408\u81ea\u5df1\u9879\u76ee\u7684\u5b9e\u9645\u60c5\u51b5\uff0c\u6765\u8003\u8651\u662f\u5426\u9700\u8981\u5728\u539f\u4e3b\u4ece\u96c6\u7fa4\u57fa\u7840\u4e0a\u62d3\u5c55\u4e3a\u9ad8\u53ef\u7528\u96c6\u7fa4\u3002</p>"},{"location":"docker/Install-Postgresql-Cluster/#133","title":"1.3.3 \u4f7f\u7528\u65b9\u5f0f","text":"<p>\u5982\u524d\u9762\u6240\u8a00\uff0c\u51c6\u5907\u4e24\u4e2a\u65b0\u7684LB \u8282\u70b9 + VIP\u3002</p> <p>\u56e0\u4e3a\u9700\u8981\u8d70\u7269\u7406\u7f51\u7edc\uff0c\u6240\u4ee5\u8fd9\u91cc\u9700\u8981\u901a\u8fc7\u79bb\u7ebf\u5b89\u88c5\u5305\u6765\u90e8\u7f72\u3002</p> <pre><code># \u5b89\u88c5 keepalived haproxy\n## \u80fd\u8054\u7f51\u673a\u5668\u7684\u4e0a\u9762\nsudo apt-get update\nrm /var/cache/apt/archives/* -rf \nsudo apt-get install --download-only keepalived haproxy\n\ncd \nmkdir -p debian-offline-packages\ncd debian-offline-packages\ncp /var/cache/apt/archives/*.deb /root/debian-offline-packages\ndpkg-scanpackages . /dev/null | gzip -9c &gt; Packages.gz\n\n## \u4e0d\u80fd\u8054\u7f51\u673a\u5668\u7684\u4e0a\u9762\nmkdir -p /opt/repo\ncp -r /root/debian-offline-packages/* /opt/repo\necho 'deb [trusted=yes] file:///path/to/local/repo ./' | sudo tee /etc/apt/sources.list.d/local-offline-repo.list\nsudo apt-get update\nsudo apt-get install keepalived haproxy\n</code></pre> <p>LB1 \u4e0a\u9762\uff1a</p> <pre><code># \u4e0a\u4f20\u6587\u4ef6\uff1alb1\n\n\n# \u66f4\u65b0\u914d\u7f6e\u6587\u4ef6\ncd lb1\nvim haproxy.cfg     # \u66f4\u65b0\u914d\u7f6e\u6587\u4ef6\u91cc\u9762\u7684PG \u6570\u636e\u5e93\u96c6\u7fa4\u7684IP\u548c\u7aef\u53e3\nvim keepalived.conf # \u66f4\u65b0\u914d\u7f6e\u6587\u4ef6\u91cc\u9762\u7684\u7269\u7406IP\uff0cVIP\uff0c\u7269\u7406\u7f51\u5361\u540d\u79f0\n\n\\cp -rvf haproxy.cfg     /etc/haproxy/haproxy.cfg\n\\cp -rvf keepalived.conf /etc/haproxy/keepalived.conf\n\nhaproxy -c -f /etc/haproxy/haproxy.cfg\nsystemctl start  haproxy.service\nsystemctl enable  haproxy.service\nsystemctl status haproxy.service -l --no-pager\n\nsystemctl start  keepalived.service \nsystemctl enable keepalived.service \nsystemctl status keepalived.service  -l --no-pager\n</code></pre> <p>LB2 \u4e0a\u9762\uff1a</p> <pre><code># \u4e0a\u4f20\u6587\u4ef6\uff1alb2\n\n\n# \u66f4\u65b0\u914d\u7f6e\u6587\u4ef6\ncd lb2\nvim haproxy.cfg     # \u66f4\u65b0\u914d\u7f6e\u6587\u4ef6\u91cc\u9762\u7684PG \u6570\u636e\u5e93\u96c6\u7fa4\u7684IP\u548c\u7aef\u53e3\nvim keepalived.conf # \u66f4\u65b0\u914d\u7f6e\u6587\u4ef6\u91cc\u9762\u7684\u7269\u7406IP\uff0cVIP\uff0c\u7269\u7406\u7f51\u5361\u540d\u79f0\n\n\\cp -rvf haproxy.cfg     /etc/haproxy/haproxy.cfg\n\\cp -rvf keepalived.conf /etc/haproxy/keepalived.conf\n\nhaproxy -c -f /etc/haproxy/haproxy.cfg\nsystemctl start  haproxy.service\nsystemctl enable  haproxy.service\nsystemctl status haproxy.service -l --no-pager\n\nsystemctl start  keepalived.service \nsystemctl enable keepalived.service \nsystemctl status keepalived.service  -l --no-pager\n</code></pre>"},{"location":"docker/Install-Postgresql/","title":"Install Postgresql","text":""},{"location":"docker/Install-Postgresql/#compose-file","title":"Compose file","text":"<pre><code>version: '3'\nservices:\n  db:\n    image: harbor.dockerregistry.com/app/kartoza/postgis:15-3.3\n    ports:\n      - \"5432:5432\"\n    networks:\n      - middleware\n    volumes:\n      - /data/middleware/postgres/data:/var/lib/postgresql\n      - /data/middleware/postgres/dbbackups:/backups\n    environment:\n      - TZ=Asia/Shanghai\n      # If you need to create multiple database you can add coma separated databases eg gis,sys\n      - POSTGRES_DB=gis,sys,onemap\n      - POSTGRES_USER=postgres\n      - POSTGRES_PASS=postgres@123!@#\n      - ALLOW_IP_RANGE=0.0.0.0/0\n      # Add extensions you need to be enabled by default in the DB. Default are the five specified below\n      - POSTGRES_MULTIPLE_EXTENSIONS=postgis,hstore,postgis_topology,postgis_raster,pgrouting\n      - RUN_AS_ROOT=true\n    restart: on-failure\n    healthcheck:\n      test: \"PGPASSWORD=postgres pg_isready -h 127.0.0.1 -U postgres -d gis\"\n\n  dbbackups:\n    image: harbor.dockerregistry.com/app/kartoza/pg-backup:15-3.3\n    hostname: pg-backups\n    networks:\n      - middleware\n    volumes:\n      - /data/middleware/postgres/dbbackups:/backups\n    environment:\n      - TZ=Asia/Shanghai\n      - DUMPPREFIX=PG_db\n      - POSTGRES_USER=postgres\n      - POSTGRES_PASS=postgres@123!@#\n      - POSTGRES_PORT=5432\n      - POSTGRES_HOST=db\n    restart: on-failure\n    depends_on:\n      db:\n        condition: service_healthy\n\nnetworks:\n  middleware:\n    driver: bridge\n</code></pre>"},{"location":"docker/Install-Prometheus/","title":"Install Prometheus","text":""},{"location":"docker/Install-Prometheus/#compose-file","title":"Compose file","text":"<pre><code>version: '3'\nservices:\n  grafana:\n    image: harbor.dockerregistry.com/app/grafana:latest\n    container_name: grafana\n    user: \"${UID}:${GID}\"\n    ports:\n      - \"3000:3000\"\n    restart: always\n    volumes:\n      - './grafana.ini:/etc/grafana/grafana.ini'\n      - '/data/grafana:/var/lib/grafana'\n\n  grafana-image-renderer:\n    image: harbor.dockerregistry.com/app/grafana/grafana-image-renderer:latest\n    container_name: grafana-image-renderer\n    #user: \"${UID}:${GID}\"\n    ports:\n      - \"8081:8081\"\n    restart: always\n    environment:\n      - BROWSER_TZ=Asia/Shanghai\n\n  prometheus:\n    image: harbor.dockerregistry.com/app/prometheus:v2.34.0\n    container_name: prometheus\n    command:\n      - '--config.file=/opt/prometheus/prometheus.yml'\n      - '--web.enable-lifecycle'\n    ports:\n        - \"9090:9090\"\n    volumes:\n      - ./prometheus:/opt/prometheus\n      - ./rules:/etc/prometheus/rules\n      - /data/prometheus:/prometheus\n    restart: always\n    #privileged: true\n\n  alertmanager:\n    image: harbor.dockerregistry.com/app/prom/alertmanager:latest\n    container_name: alertmanager\n    hostname: alertmanager\n    ports:\n      - \"9093:9093\"\n    restart: always\n    privileged: true\n    volumes:\n      - /etc/localtime:/etc/localtime\n      #- ./alertmanager:/etc/alertmanager\n      - ./alertmanager/alertmanager.yml:/etc/alertmanager/alertmanager.yml\n      - /data/alertmanager:/data/alertmanager\n    command:\n        - '--config.file=/etc/alertmanager/alertmanager.yml'\n        - '--storage.path=/data/alertmanager'\n\n  prometheus-webhook-dingtalk:\n    image: harbor.dockerregistry.com/app/timonwong/prometheus-webhook-dingtalk:latest\n    container_name: prometheus-webhook-dingtalk\n    hostname: prometheus-webhook-dingtalk\n    restart: always\n    volumes:\n      - '/etc/localtime:/etc/localtime'\n      - './dingtalk/config.yml:/etc/prometheus-webhook-dingtalk/config.yml'\n    ports:\n      - \"8060:8060\"\n    command:\n      - '--config.file=/etc/prometheus-webhook-dingtalk/config.yml'\n      - '--web.enable-ui'\n      - '--web.enable-lifecycle'\n    entrypoint: '/bin/prometheus-webhook-dingtalk'\n</code></pre>"},{"location":"docker/Install-Prometheus/#grafanaini","title":"grafana.ini","text":"<pre><code>##################### Grafana Configuration Example #####################\n#\n# Everything has defaults so you only need to uncomment things you want to\n# change\n\n# possible values : production, development\n;app_mode = production\n\n# instance name, defaults to HOSTNAME environment variable value or hostname if HOSTNAME var is empty\n;instance_name = ${HOSTNAME}\n\n#################################### Paths ####################################\n[paths]\n# Path to where grafana can store temp files, sessions, and the sqlite3 db (if that is used)\n;data = /var/lib/grafana\n\n# Temporary files in `data` directory older than given duration will be removed\n;temp_data_lifetime = 24h\n\n# Directory where grafana can store logs\n;logs = /var/log/grafana\n\n# Directory where grafana will automatically scan and look for plugins\n;plugins = /var/lib/grafana/plugins\n\n# folder that contains provisioning config files that grafana will apply on startup and while running.\n;provisioning = conf/provisioning\n\n#################################### Server ####################################\n[server]\n# Protocol (http, https, h2, socket)\n;protocol = http\n\n# The ip address to bind to, empty will bind to all interfaces\n;http_addr =\n\n# The http port  to use\n;http_port = 3000\n\n# The public facing domain name used to access grafana from a browser\n;domain = localhost\n\n# Redirect to correct domain if host header does not match domain\n# Prevents DNS rebinding attacks\n;enforce_domain = false\n\n# The full public facing url you use in browser, used for redirects and emails\n# If you use reverse proxy and sub path specify full url (with sub path)\n;root_url = %(protocol)s://%(domain)s:%(http_port)s/\n\n# Serve Grafana from subpath specified in `root_url` setting. By default it is set to `false` for compatibility reasons.\n;serve_from_sub_path = false\n\n# Log web requests\n;router_logging = false\n\n# the path relative working path\n;static_root_path = public\n\n# enable gzip\n;enable_gzip = false\n\n# https certs &amp; key file\n;cert_file =\n;cert_key =\n\n# Unix socket path\n;socket =\n\n# CDN Url\n;cdn_url =\n\n# Sets the maximum time using a duration format (5s/5m/5ms) before timing out read of an incoming request and closing idle connections.\n# `0` means there is no timeout for reading the request.\n;read_timeout = 0\n\n#################################### Database ####################################\n[database]\n# You can configure the database connection by specifying type, host, name, user and password\n# as separate properties or as on string using the url properties.\n\n# Either \"mysql\", \"postgres\" or \"sqlite3\", it's your choice\ntype = postgres\nhost = 10.1.1.1:5432\nname = grafana\nuser = grafana\n# If the password contains # or ; you have to wrap it with triple quotes. Ex \"\"\"#password;\"\"\"\npassword = grafana\n\n# Use either URL or the previous fields to configure the database\n# Example: mysql://user:secret@host:port/database\n;url =\n\n# For \"postgres\" only, either \"disable\", \"require\" or \"verify-full\"\nssl_mode = disable\n\n# Database drivers may support different transaction isolation levels.\n# Currently, only \"mysql\" driver supports isolation levels.\n# If the value is empty - driver's default isolation level is applied.\n# For \"mysql\" use \"READ-UNCOMMITTED\", \"READ-COMMITTED\", \"REPEATABLE-READ\" or \"SERIALIZABLE\".\n;isolation_level =\n\n;ca_cert_path =\n;client_key_path =\n;client_cert_path =\n;server_cert_name =\n\n# For \"sqlite3\" only, path relative to data_path setting\npath = grafana.db\n\n# Max idle conn setting default is 2\n;max_idle_conn = 2\n\n# Max conn setting default is 0 (mean not set)\n;max_open_conn =\n\n# Connection Max Lifetime default is 14400 (means 14400 seconds or 4 hours)\n;conn_max_lifetime = 14400\n\n# Set to true to log the sql calls and execution times.\n;log_queries =\n\n# For \"sqlite3\" only. cache mode setting used for connecting to the database. (private, shared)\n;cache_mode = private\n\n################################### Data sources #########################\n[datasources]\n# Upper limit of data sources that Grafana will return. This limit is a temporary configuration and it will be deprecated when pagination will be introduced on the list data sources API.\n;datasource_limit = 5000\n\n#################################### Cache server #############################\n[remote_cache]\n# Either \"redis\", \"memcached\" or \"database\" default is \"database\"\n;type = database\n\n# cache connectionstring options\n# database: will use Grafana primary database.\n# redis: config like redis server e.g. `addr=127.0.0.1:6379,pool_size=100,db=0,ssl=false`. Only addr is required. ssl may be 'true', 'false', or 'insecure'.\n# memcache: 127.0.0.1:11211\n;connstr =\n\n#################################### Data proxy ###########################\n[dataproxy]\n\n# This enables data proxy logging, default is false\n;logging = false\n\n# How long the data proxy waits to read the headers of the response before timing out, default is 30 seconds.\n# This setting also applies to core backend HTTP data sources where query requests use an HTTP client with timeout set.\n;timeout = 30\n\n# How long the data proxy waits to establish a TCP connection before timing out, default is 10 seconds.\n;dialTimeout = 10\n\n# How many seconds the data proxy waits before sending a keepalive probe request.\n;keep_alive_seconds = 30\n\n# How many seconds the data proxy waits for a successful TLS Handshake before timing out.\n;tls_handshake_timeout_seconds = 10\n\n# How many seconds the data proxy will wait for a server's first response headers after\n# fully writing the request headers if the request has an \"Expect: 100-continue\"\n# header. A value of 0 will result in the body being sent immediately, without\n# waiting for the server to approve.\n;expect_continue_timeout_seconds = 1\n\n# Optionally limits the total number of connections per host, including connections in the dialing,\n# active, and idle states. On limit violation, dials will block.\n# A value of zero (0) means no limit.\n;max_conns_per_host = 0\n\n# The maximum number of idle connections that Grafana will keep alive.\n;max_idle_connections = 100\n\n# The maximum number of idle connections per host that Grafana will keep alive.\n;max_idle_connections_per_host = 2\n\n# How many seconds the data proxy keeps an idle connection open before timing out.\n;idle_conn_timeout_seconds = 90\n\n# If enabled and user is not anonymous, data proxy will add X-Grafana-User header with username into the request, default is false.\n;send_user_header = false\n\n#################################### Analytics ####################################\n[analytics]\n# Server reporting, sends usage counters to stats.grafana.org every 24 hours.\n# No ip addresses are being tracked, only simple counters to track\n# running instances, dashboard and error counts. It is very helpful to us.\n# Change this option to false to disable reporting.\n;reporting_enabled = true\n\n# The name of the distributor of the Grafana instance. Ex hosted-grafana, grafana-labs\n;reporting_distributor = grafana-labs\n\n# Set to false to disable all checks to https://grafana.net\n# for new versions (grafana itself and plugins), check is used\n# in some UI views to notify that grafana or plugin update exists\n# This option does not cause any auto updates, nor send any information\n# only a GET request to http://grafana.com to get latest versions\n;check_for_updates = true\n\n# Google Analytics universal tracking code, only enabled if you specify an id here\n;google_analytics_ua_id =\n\n# Google Tag Manager ID, only enabled if you specify an id here\n;google_tag_manager_id =\n\n#################################### Security ####################################\n[security]\n# disable creation of admin user on first start of grafana\n;disable_initial_admin_creation = false\n\n# default admin user, created on startup\n;admin_user = admin\n\n# default admin password, can be changed before first start of grafana,  or in profile settings\n;admin_password = admin\n\n# used for signing\n;secret_key = SW2YcwTIb9zpOOhoPsMm\n\n# disable gravatar profile images\n;disable_gravatar = false\n\n# data source proxy whitelist (ip_or_domain:port separated by spaces)\n;data_source_proxy_whitelist =\n\n# disable protection against brute force login attempts\n;disable_brute_force_login_protection = false\n\n# set to true if you host Grafana behind HTTPS. default is false.\n;cookie_secure = false\n\n# set cookie SameSite attribute. defaults to `lax`. can be set to \"lax\", \"strict\", \"none\" and \"disabled\"\n;cookie_samesite = lax\n\n# set to true if you want to allow browsers to render Grafana in a &lt;frame&gt;, &lt;iframe&gt;, &lt;embed&gt; or &lt;object&gt;. default is false.\nallow_embedding = true\n\n# Set to true if you want to enable http strict transport security (HSTS) response header.\n# This is only sent when HTTPS is enabled in this configuration.\n# HSTS tells browsers that the site should only be accessed using HTTPS.\n;strict_transport_security = false\n\n# Sets how long a browser should cache HSTS. Only applied if strict_transport_security is enabled.\n;strict_transport_security_max_age_seconds = 86400\n\n# Set to true if to enable HSTS preloading option. Only applied if strict_transport_security is enabled.\n;strict_transport_security_preload = false\n\n# Set to true if to enable the HSTS includeSubDomains option. Only applied if strict_transport_security is enabled.\n;strict_transport_security_subdomains = false\n\n# Set to true to enable the X-Content-Type-Options response header.\n# The X-Content-Type-Options response HTTP header is a marker used by the server to indicate that the MIME types advertised\n# in the Content-Type headers should not be changed and be followed.\n;x_content_type_options = true\n\n# Set to true to enable the X-XSS-Protection header, which tells browsers to stop pages from loading\n# when they detect reflected cross-site scripting (XSS) attacks.\n;x_xss_protection = true\n\n# Enable adding the Content-Security-Policy header to your requests.\n# CSP allows to control resources the user agent is allowed to load and helps prevent XSS attacks.\n;content_security_policy = false\n\n# Set Content Security Policy template used when adding the Content-Security-Policy header to your requests.\n# $NONCE in the template includes a random nonce.\n# $ROOT_PATH is server.root_url without the protocol.\n;content_security_policy_template = \"\"\"script-src 'self' 'unsafe-eval' 'unsafe-inline' 'strict-dynamic' $NONCE;object-src 'none';font-src 'self';style-src 'self' 'unsafe-inline' blob:;img-src * data:;base-uri 'self';connect-src 'self' grafana.com ws://$ROOT_PATH wss://$ROOT_PATH;manifest-src 'self';media-src 'none';form-action 'self';\"\"\"\n\n#################################### Snapshots ###########################\n[snapshots]\n# snapshot sharing options\n;external_enabled = true\n;external_snapshot_url = https://snapshots-origin.raintank.io\n;external_snapshot_name = Publish to snapshot.raintank.io\n\n# Set to true to enable this Grafana instance act as an external snapshot server and allow unauthenticated requests for\n# creating and deleting snapshots.\n;public_mode = false\n\n# remove expired snapshot\n;snapshot_remove_expired = true\n\n#################################### Dashboards History ##################\n[dashboards]\n# Number dashboard versions to keep (per dashboard). Default: 20, Minimum: 1\n;versions_to_keep = 20\n\n# Minimum dashboard refresh interval. When set, this will restrict users to set the refresh interval of a dashboard lower than given interval. Per default this is 5 seconds.\n# The interval string is a possibly signed sequence of decimal numbers, followed by a unit suffix (ms, s, m, h, d), e.g. 30s or 1m.\n;min_refresh_interval = 5s\n\n# Path to the default home dashboard. If this value is empty, then Grafana uses StaticRootPath + \"dashboards/home.json\"\n;default_home_dashboard_path =\n\n#################################### Users ###############################\n[users]\n# disable user signup / registration\n;allow_sign_up = true\n\n# Allow non admin users to create organizations\n;allow_org_create = true\n\n# Set to true to automatically assign new users to the default organization (id 1)\n;auto_assign_org = true\n\n# Set this value to automatically add new users to the provided organization (if auto_assign_org above is set to true)\n;auto_assign_org_id = 1\n\n# Default role new users will be automatically assigned (if disabled above is set to true)\n;auto_assign_org_role = Viewer\n\n# Require email validation before sign up completes\n;verify_email_enabled = false\n\n# Background text for the user field on the login page\n;login_hint = email or username\n;password_hint = password\n\n# Default UI theme (\"dark\" or \"light\")\n;default_theme = dark\n\n# Path to a custom home page. Users are only redirected to this if the default home dashboard is used. It should match a frontend route and contain a leading slash.\n; home_page =\n\n# External user management, these options affect the organization users view\n;external_manage_link_url =\n;external_manage_link_name =\n;external_manage_info =\n\n# Viewers can edit/inspect dashboard settings in the browser. But not save the dashboard.\n;viewers_can_edit = false\n\n# Editors can administrate dashboard, folders and teams they create\n;editors_can_admin = false\n\n# The duration in time a user invitation remains valid before expiring. This setting should be expressed as a duration. Examples: 6h (hours), 2d (days), 1w (week). Default is 24h (24 hours). The minimum supported duration is 15m (15 minutes).\n;user_invite_max_lifetime_duration = 24h\n\n# Enter a comma-separated list of users login to hide them in the Grafana UI. These users are shown to Grafana admins and themselves.\n; hidden_users =\n\n[auth]\n# Login cookie name\n;login_cookie_name = grafana_session\n\n# The maximum lifetime (duration) an authenticated user can be inactive before being required to login at next visit. Default is 7 days (7d). This setting should be expressed as a duration, e.g. 5m (minutes), 6h (hours), 10d (days), 2w (weeks), 1M (month). The lifetime resets at each successful token rotation.\n;login_maximum_inactive_lifetime_duration =\n\n# The maximum lifetime (duration) an authenticated user can be logged in since login time before being required to login. Default is 30 days (30d). This setting should be expressed as a duration, e.g. 5m (minutes), 6h (hours), 10d (days), 2w (weeks), 1M (month).\n;login_maximum_lifetime_duration =\n\n# How often should auth tokens be rotated for authenticated users when being active. The default is each 10 minutes.\n;token_rotation_interval_minutes = 10\n\n# Set to true to disable (hide) the login form, useful if you use OAuth, defaults to false\n;disable_login_form = false\n\n# Set to true to disable the sign out link in the side menu. Useful if you use auth.proxy or auth.jwt, defaults to false\n;disable_signout_menu = false\n\n# URL to redirect the user to after sign out\n;signout_redirect_url =\n\n# Set to true to attempt login with OAuth automatically, skipping the login screen.\n# This setting is ignored if multiple OAuth providers are configured.\n;oauth_auto_login = false\n\n# OAuth state max age cookie duration in seconds. Defaults to 600 seconds.\n;oauth_state_cookie_max_age = 600\n\n# limit of api_key seconds to live before expiration\n;api_key_max_seconds_to_live = -1\n\n# Set to true to enable SigV4 authentication option for HTTP-based datasources.\n;sigv4_auth_enabled = false\n\n#################################### Anonymous Auth ######################\n[auth.anonymous]\n# enable anonymous access\nenabled = true\n\n# specify organization name that should be used for unauthenticated users\n;org_name = Main Org.\n\n# specify role for unauthenticated users\n;org_role = Viewer\n\n# mask the Grafana version number for unauthenticated users\n;hide_version = false\n\n#################################### GitHub Auth ##########################\n[auth.github]\n;enabled = false\n;allow_sign_up = true\n;client_id = some_id\n;client_secret = some_secret\n;scopes = user:email,read:org\n;auth_url = https://github.com/login/oauth/authorize\n;token_url = https://github.com/login/oauth/access_token\n;api_url = https://api.github.com/user\n;allowed_domains =\n;team_ids =\n;allowed_organizations =\n\n#################################### GitLab Auth #########################\n[auth.gitlab]\n;enabled = false\n;allow_sign_up = true\n;client_id = some_id\n;client_secret = some_secret\n;scopes = api\n;auth_url = https://gitlab.com/oauth/authorize\n;token_url = https://gitlab.com/oauth/token\n;api_url = https://gitlab.com/api/v4\n;allowed_domains =\n;allowed_groups =\n\n#################################### Google Auth ##########################\n[auth.google]\n;enabled = false\n;allow_sign_up = true\n;client_id = some_client_id\n;client_secret = some_client_secret\n;scopes = https://www.googleapis.com/auth/userinfo.profile https://www.googleapis.com/auth/userinfo.email\n;auth_url = https://accounts.google.com/o/oauth2/auth\n;token_url = https://accounts.google.com/o/oauth2/token\n;api_url = https://www.googleapis.com/oauth2/v1/userinfo\n;allowed_domains =\n;hosted_domain =\n\n#################################### Grafana.com Auth ####################\n[auth.grafana_com]\n;enabled = false\n;allow_sign_up = true\n;client_id = some_id\n;client_secret = some_secret\n;scopes = user:email\n;allowed_organizations =\n\n#################################### Azure AD OAuth #######################\n[auth.azuread]\n;name = Azure AD\n;enabled = false\n;allow_sign_up = true\n;client_id = some_client_id\n;client_secret = some_client_secret\n;scopes = openid email profile\n;auth_url = https://login.microsoftonline.com/&lt;tenant-id&gt;/oauth2/v2.0/authorize\n;token_url = https://login.microsoftonline.com/&lt;tenant-id&gt;/oauth2/v2.0/token\n;allowed_domains =\n;allowed_groups =\n\n#################################### Okta OAuth #######################\n[auth.okta]\n;name = Okta\n;enabled = false\n;allow_sign_up = true\n;client_id = some_id\n;client_secret = some_secret\n;scopes = openid profile email groups\n;auth_url = https://&lt;tenant-id&gt;.okta.com/oauth2/v1/authorize\n;token_url = https://&lt;tenant-id&gt;.okta.com/oauth2/v1/token\n;api_url = https://&lt;tenant-id&gt;.okta.com/oauth2/v1/userinfo\n;allowed_domains =\n;allowed_groups =\n;role_attribute_path =\n;role_attribute_strict = false\n\n#################################### Generic OAuth ##########################\n[auth.generic_oauth]\n;enabled = false\n;name = OAuth\n;allow_sign_up = true\n;client_id = some_id\n;client_secret = some_secret\n;scopes = user:email,read:org\n;empty_scopes = false\n;email_attribute_name = email:primary\n;email_attribute_path =\n;login_attribute_path =\n;name_attribute_path =\n;id_token_attribute_name =\n;auth_url = https://foo.bar/login/oauth/authorize\n;token_url = https://foo.bar/login/oauth/access_token\n;api_url = https://foo.bar/user\n;allowed_domains =\n;team_ids =\n;allowed_organizations =\n;role_attribute_path =\n;role_attribute_strict = false\n;tls_skip_verify_insecure = false\n;tls_client_cert =\n;tls_client_key =\n;tls_client_ca =\n\n#################################### Basic Auth ##########################\n[auth.basic]\n;enabled = true\n\n#################################### Auth Proxy ##########################\n[auth.proxy]\n;enabled = false\n;header_name = X-WEBAUTH-USER\n;header_property = username\n;auto_sign_up = true\n;sync_ttl = 60\n;whitelist = 192.168.1.1, 192.168.2.1\n;headers = Email:X-User-Email, Name:X-User-Name\n# Read the auth proxy docs for details on what the setting below enables\n;enable_login_token = false\n\n#################################### Auth JWT ##########################\n[auth.jwt]\n;enabled = true\n;header_name = X-JWT-Assertion\n;email_claim = sub\n;username_claim = sub\n;jwk_set_url = https://foo.bar/.well-known/jwks.json\n;jwk_set_file = /path/to/jwks.json\n;cache_ttl = 60m\n;expected_claims = {\"aud\": [\"foo\", \"bar\"]}\n;key_file = /path/to/key/file\n\n#################################### Auth LDAP ##########################\n[auth.ldap]\n;enabled = false\n;config_file = /etc/grafana/ldap.toml\n;allow_sign_up = true\n\n# LDAP background sync (Enterprise only)\n# At 1 am every day\n;sync_cron = \"0 0 1 * * *\"\n;active_sync_enabled = true\n\n#################################### AWS ###########################\n[aws]\n# Enter a comma-separated list of allowed AWS authentication providers.\n# Options are: default (AWS SDK Default), keys (Access &amp;&amp; secret key), credentials (Credentials field), ec2_iam_role (EC2 IAM Role)\n; allowed_auth_providers = default,keys,credentials\n\n# Allow AWS users to assume a role using temporary security credentials.\n# If true, assume role will be enabled for all AWS authentication providers that are specified in aws_auth_providers\n; assume_role_enabled = true\n\n#################################### Azure ###############################\n[azure]\n# Azure cloud environment where Grafana is hosted\n# Possible values are AzureCloud, AzureChinaCloud, AzureUSGovernment and AzureGermanCloud\n# Default value is AzureCloud (i.e. public cloud)\n;cloud = AzureCloud\n\n# Specifies whether Grafana hosted in Azure service with Managed Identity configured (e.g. Azure Virtual Machines instance)\n# If enabled, the managed identity can be used for authentication of Grafana in Azure services\n# Disabled by default, needs to be explicitly enabled\n;managed_identity_enabled = false\n\n# Client ID to use for user-assigned managed identity\n# Should be set for user-assigned identity and should be empty for system-assigned identity\n;managed_identity_client_id =\n\n#################################### SMTP / Emailing ##########################\n[smtp]\n;enabled = false\n;host = localhost:25\n;user =\n# If the password contains # or ; you have to wrap it with triple quotes. Ex \"\"\"#password;\"\"\"\n;password =\n;cert_file =\n;key_file =\n;skip_verify = false\n;from_address = admin@grafana.localhost\n;from_name = Grafana\n# EHLO identity in SMTP dialog (defaults to instance_name)\n;ehlo_identity = dashboard.example.com\n# SMTP startTLS policy (defaults to 'OpportunisticStartTLS')\n;startTLS_policy = NoStartTLS\n\n[emails]\n;welcome_email_on_sign_up = false\n;templates_pattern = emails/*.html\n\n#################################### Logging ##########################\n[log]\n# Either \"console\", \"file\", \"syslog\". Default is console and  file\n# Use space to separate multiple modes, e.g. \"console file\"\n;mode = console file\n\n# Either \"debug\", \"info\", \"warn\", \"error\", \"critical\", default is \"info\"\n;level = info\n\n# optional settings to set different levels for specific loggers. Ex filters = sqlstore:debug\n;filters =\n\n# For \"console\" mode only\n[log.console]\n;level =\n\n# log line format, valid options are text, console and json\n;format = console\n\n# For \"file\" mode only\n[log.file]\n;level =\n\n# log line format, valid options are text, console and json\n;format = text\n\n# This enables automated log rotate(switch of following options), default is true\n;log_rotate = true\n\n# Max line number of single file, default is 1000000\n;max_lines = 1000000\n\n# Max size shift of single file, default is 28 means 1 &lt;&lt; 28, 256MB\n;max_size_shift = 28\n\n# Segment log daily, default is true\n;daily_rotate = true\n\n# Expired days of log file(delete after max days), default is 7\n;max_days = 7\n\n[log.syslog]\n;level =\n\n# log line format, valid options are text, console and json\n;format = text\n\n# Syslog network type and address. This can be udp, tcp, or unix. If left blank, the default unix endpoints will be used.\n;network =\n;address =\n\n# Syslog facility. user, daemon and local0 through local7 are valid.\n;facility =\n\n# Syslog tag. By default, the process' argv[0] is used.\n;tag =\n\n[log.frontend]\n# Should Sentry javascript agent be initialized\n;enabled = false\n\n# Sentry DSN if you want to send events to Sentry.\n;sentry_dsn =\n\n# Custom HTTP endpoint to send events captured by the Sentry agent to. Default will log the events to stdout.\n;custom_endpoint = /log\n\n# Rate of events to be reported between 0 (none) and 1 (all), float\n;sample_rate = 1.0\n\n# Requests per second limit enforced an extended period, for Grafana backend log ingestion endpoint (/log).\n;log_endpoint_requests_per_second_limit = 3\n\n# Max requests accepted per short interval of time for Grafana backend log ingestion endpoint (/log).\n;log_endpoint_burst_limit = 15\n\n#################################### Usage Quotas ########################\n[quota]\n; enabled = false\n\n#### set quotas to -1 to make unlimited. ####\n# limit number of users per Org.\n; org_user = 10\n\n# limit number of dashboards per Org.\n; org_dashboard = 100\n\n# limit number of data_sources per Org.\n; org_data_source = 10\n\n# limit number of api_keys per Org.\n; org_api_key = 10\n\n# limit number of alerts per Org.\n;org_alert_rule = 100\n\n# limit number of orgs a user can create.\n; user_org = 10\n\n# Global limit of users.\n; global_user = -1\n\n# global limit of orgs.\n; global_org = -1\n\n# global limit of dashboards\n; global_dashboard = -1\n\n# global limit of api_keys\n; global_api_key = -1\n\n# global limit on number of logged in users.\n; global_session = -1\n\n# global limit of alerts\n;global_alert_rule = -1\n\n#################################### Alerting ############################\n[alerting]\n# Disable alerting engine &amp; UI features\n;enabled = true\n# Makes it possible to turn off alert rule execution but alerting UI is visible\n;execute_alerts = true\n\n# Default setting for new alert rules. Defaults to categorize error and timeouts as alerting. (alerting, keep_state)\n;error_or_timeout = alerting\n\n# Default setting for how Grafana handles nodata or null values in alerting. (alerting, no_data, keep_state, ok)\n;nodata_or_nullvalues = no_data\n\n# Alert notifications can include images, but rendering many images at the same time can overload the server\n# This limit will protect the server from render overloading and make sure notifications are sent out quickly\n;concurrent_render_limit = 5\n\n\n# Default setting for alert calculation timeout. Default value is 30\n;evaluation_timeout_seconds = 30\n\n# Default setting for alert notification timeout. Default value is 30\n;notification_timeout_seconds = 30\n\n# Default setting for max attempts to sending alert notifications. Default value is 3\n;max_attempts = 3\n\n# Makes it possible to enforce a minimal interval between evaluations, to reduce load on the backend\n;min_interval_seconds = 1\n\n# Configures for how long alert annotations are stored. Default is 0, which keeps them forever.\n# This setting should be expressed as a duration. Examples: 6h (hours), 10d (days), 2w (weeks), 1M (month).\n;max_annotation_age =\n\n# Configures max number of alert annotations that Grafana stores. Default value is 0, which keeps all alert annotations.\n;max_annotations_to_keep =\n\n#################################### Annotations #########################\n[annotations]\n# Configures the batch size for the annotation clean-up job. This setting is used for dashboard, API, and alert annotations.\n;cleanupjob_batchsize = 100\n\n[annotations.dashboard]\n# Dashboard annotations means that annotations are associated with the dashboard they are created on.\n\n# Configures how long dashboard annotations are stored. Default is 0, which keeps them forever.\n# This setting should be expressed as a duration. Examples: 6h (hours), 10d (days), 2w (weeks), 1M (month).\n;max_age =\n\n# Configures max number of dashboard annotations that Grafana stores. Default value is 0, which keeps all dashboard annotations.\n;max_annotations_to_keep =\n\n[annotations.api]\n# API annotations means that the annotations have been created using the API without any\n# association with a dashboard.\n\n# Configures how long Grafana stores API annotations. Default is 0, which keeps them forever.\n# This setting should be expressed as a duration. Examples: 6h (hours), 10d (days), 2w (weeks), 1M (month).\n;max_age =\n\n# Configures max number of API annotations that Grafana keeps. Default value is 0, which keeps all API annotations.\n;max_annotations_to_keep =\n\n#################################### Explore #############################\n[explore]\n# Enable the Explore section\n;enabled = true\n\n#################################### Internal Grafana Metrics ##########################\n# Metrics available at HTTP API Url /metrics\n[metrics]\n# Disable / Enable internal metrics\n;enabled           = true\n# Graphite Publish interval\n;interval_seconds  = 10\n# Disable total stats (stat_totals_*) metrics to be generated\n;disable_total_stats = false\n\n#If both are set, basic auth will be required for the metrics endpoint.\n; basic_auth_username =\n; basic_auth_password =\n\n# Metrics environment info adds dimensions to the `grafana_environment_info` metric, which\n# can expose more information about the Grafana instance.\n[metrics.environment_info]\n#exampleLabel1 = exampleValue1\n#exampleLabel2 = exampleValue2\n\n# Send internal metrics to Graphite\n[metrics.graphite]\n# Enable by setting the address setting (ex localhost:2003)\n;address =\n;prefix = prod.grafana.%(instance_name)s.\n\n#################################### Grafana.com integration  ##########################\n# Url used to import dashboards directly from Grafana.com\n[grafana_com]\n;url = https://grafana.com\n\n#################################### Distributed tracing ############\n[tracing.jaeger]\n# Enable by setting the address sending traces to jaeger (ex localhost:6831)\n;address = localhost:6831\n# Tag that will always be included in when creating new spans. ex (tag1:value1,tag2:value2)\n;always_included_tag = tag1:value1\n# Type specifies the type of the sampler: const, probabilistic, rateLimiting, or remote\n;sampler_type = const\n# jaeger samplerconfig param\n# for \"const\" sampler, 0 or 1 for always false/true respectively\n# for \"probabilistic\" sampler, a probability between 0 and 1\n# for \"rateLimiting\" sampler, the number of spans per second\n# for \"remote\" sampler, param is the same as for \"probabilistic\"\n# and indicates the initial sampling rate before the actual one\n# is received from the mothership\n;sampler_param = 1\n# sampling_server_url is the URL of a sampling manager providing a sampling strategy.\n;sampling_server_url =\n# Whether or not to use Zipkin propagation (x-b3- HTTP headers).\n;zipkin_propagation = false\n# Setting this to true disables shared RPC spans.\n# Not disabling is the most common setting when using Zipkin elsewhere in your infrastructure.\n;disable_shared_zipkin_spans = false\n\n#################################### External image storage ##########################\n[external_image_storage]\n# Used for uploading images to public servers so they can be included in slack/email messages.\n# you can choose between (s3, webdav, gcs, azure_blob, local)\n;provider =\nprovider = local\n\n[external_image_storage.s3]\n;endpoint =\n;path_style_access =\n;bucket =\n;region =\n;path =\n;access_key =\n;secret_key =\n\n[external_image_storage.webdav]\n;url =\n;public_url =\n;username =\n;password =\n\n[external_image_storage.gcs]\n;key_file =\n;bucket =\n;path =\n\n[external_image_storage.azure_blob]\n;account_name =\n;account_key =\n;container_name =\n\n[external_image_storage.local]\n# does not require any configuration\n\n[rendering]\n# Options to configure a remote HTTP image rendering service, e.g. using https://github.com/grafana/grafana-image-renderer.\n# URL to a remote HTTP image renderer service, e.g. http://localhost:8081/render, will enable Grafana to render panels and dashboards to PNG-images using HTTP requests to an external service.\n;server_url =\nserver_url = http://10.3.1.161:8081/render\n# If the remote HTTP image renderer service runs on a different server than the Grafana server you may have to configure this to a URL where Grafana is reachable, e.g. http://grafana.domain/.\n;callback_url =\ncallback_url = http://10.3.1.161:3000/\n# Concurrent render request limit affects when the /render HTTP endpoint is used. Rendering many images at the same time can overload the server,\n# which this setting can help protect against by only allowing a certain amount of concurrent requests.\n;concurrent_render_request_limit = 30\n\n[panels]\n# If set to true Grafana will allow script tags in text panels. Not recommended as it enable XSS vulnerabilities.\n;disable_sanitize_html = false\n\n[plugins]\n;enable_alpha = false\n;app_tls_skip_verify_insecure = false\n# Enter a comma-separated list of plugin identifiers to identify plugins to load even if they are unsigned. Plugins with modified signatures are never loaded.\n;allow_loading_unsigned_plugins =\n# Enable or disable installing plugins directly from within Grafana.\n;plugin_admin_enabled = false\n;plugin_admin_external_manage_enabled = false\n;plugin_catalog_url = https://grafana.com/grafana/plugins/\n\n#################################### Grafana Live ##########################################\n[live]\n# max_connections to Grafana Live WebSocket endpoint per Grafana server instance. See Grafana Live docs\n# if you are planning to make it higher than default 100 since this can require some OS and infrastructure\n# tuning. 0 disables Live, -1 means unlimited connections.\n;max_connections = 100\n\n# allowed_origins is a comma-separated list of origins that can establish connection with Grafana Live.\n# If not set then origin will be matched over root_url. Supports wildcard symbol \"*\".\n;allowed_origins =\n\n#################################### Grafana Image Renderer Plugin ##########################\n[plugin.grafana-image-renderer]\n# Instruct headless browser instance to use a default timezone when not provided by Grafana, e.g. when rendering panel image of alert.\n# See ICU\u2019s metaZones.txt (https://cs.chromium.org/chromium/src/third_party/icu/source/data/misc/metaZones.txt) for a list of supported\n# timezone IDs. Fallbacks to TZ environment variable if not set.\n;rendering_timezone =\nrendering_timezone = Asia/Shanghai\n\n# Instruct headless browser instance to use a default language when not provided by Grafana, e.g. when rendering panel image of alert.\n# Please refer to the HTTP header Accept-Language to understand how to format this value, e.g. 'fr-CH, fr;q=0.9, en;q=0.8, de;q=0.7, *;q=0.5'.\n;rendering_language =\nrendering_language = zh-CN,zh;q=0.9\n\n# Instruct headless browser instance to use a default device scale factor when not provided by Grafana, e.g. when rendering panel image of alert.\n# Default is 1. Using a higher value will produce more detailed images (higher DPI), but will require more disk space to store an image.\n;rendering_viewport_device_scale_factor =\n\n# Instruct headless browser instance whether to ignore HTTPS errors during navigation. Per default HTTPS errors are not ignored. Due to\n# the security risk it's not recommended to ignore HTTPS errors.\n;rendering_ignore_https_errors =\n\n# Instruct headless browser instance whether to capture and log verbose information when rendering an image. Default is false and will\n# only capture and log error messages. When enabled, debug messages are captured and logged as well.\n# For the verbose information to be included in the Grafana server log you have to adjust the rendering log level to debug, configure\n# [log].filter = rendering:debug.\n;rendering_verbose_logging =\n\n# Instruct headless browser instance whether to output its debug and error messages into running process of remote rendering service.\n# Default is false. This can be useful to enable (true) when troubleshooting.\n;rendering_dumpio =\n\n# Additional arguments to pass to the headless browser instance. Default is --no-sandbox. The list of Chromium flags can be found\n# here (https://peter.sh/experiments/chromium-command-line-switches/). Multiple arguments is separated with comma-character.\n;rendering_args =\n\n# You can configure the plugin to use a different browser binary instead of the pre-packaged version of Chromium.\n# Please note that this is not recommended, since you may encounter problems if the installed version of Chrome/Chromium is not\n# compatible with the plugin.\n;rendering_chrome_bin =\n\n# Instruct how headless browser instances are created. Default is 'default' and will create a new browser instance on each request.\n# Mode 'clustered' will make sure that only a maximum of browsers/incognito pages can execute concurrently.\n# Mode 'reusable' will have one browser instance and will create a new incognito page on each request.\n;rendering_mode =\n\n# When rendering_mode = clustered you can instruct how many browsers or incognito pages can execute concurrently. Default is 'browser'\n# and will cluster using browser instances.\n# Mode 'context' will cluster using incognito pages.\n;rendering_clustering_mode =\n# When rendering_mode = clustered you can define maximum number of browser instances/incognito pages that can execute concurrently..\n;rendering_clustering_max_concurrency =\n\n# Limit the maximum viewport width, height and device scale factor that can be requested.\n;rendering_viewport_max_width =\n;rendering_viewport_max_height =\n;rendering_viewport_max_device_scale_factor =\n\n# Change the listening host and port of the gRPC server. Default host is 127.0.0.1 and default port is 0 and will automatically assign\n# a port not in use.\n;grpc_host =\n;grpc_port =\n\n[enterprise]\n# Path to a valid Grafana Enterprise license.jwt file\n;license_path =\n\n[feature_toggles]\n# enable features, separated by spaces\n;enable =\n\n[date_formats]\n# For information on what formatting patterns that are supported https://momentjs.com/docs/#/displaying/\n\n# Default system date format used in time range picker and other places where full time is displayed\n;full_date = YYYY-MM-DD HH:mm:ss\n\n# Used by graph and other places where we only show small intervals\n;interval_second = HH:mm:ss\n;interval_minute = HH:mm\n;interval_hour = MM/DD HH:mm\n;interval_day = MM/DD\n;interval_month = YYYY-MM\n;interval_year = YYYY\n\n# Experimental feature\n;use_browser_locale = false\n\n# Default timezone for user preferences. Options are 'browser' for the browser local timezone or a timezone name from IANA Time Zone database, e.g. 'UTC' or 'Europe/Amsterdam' etc.\n;default_timezone = browser\n\n[expressions]\n# Enable or disable the expressions functionality.\n;enabled = true\n</code></pre>"},{"location":"docker/Install-Prometheus/#rules","title":"Rules","text":""},{"location":"docker/Install-Prometheus/#cpu_usageyaml","title":"cpu_usage.yaml","text":"<pre><code>groups:\n- name: CPU\u544a\u8b66\u89c4\u5219\n  rules:\n  - alert: CPU\u4f7f\u7528\u7387\n    expr: 100 - (avg by (instance)(irate(node_cpu_seconds_total{mode=\"idle\"}[1m]) )) * 100 &gt; 90\n    for: 2m\n    labels:\n      user: prometheus\n      severity: warning\n    annotations:\n      description: \"\u670d\u52a1\u5668CPU\u4f7f\u7528\u7387\u8d85\u8fc790% (\u5f53\u524d:{{ $value }}%)\"\n</code></pre>"},{"location":"docker/Install-Prometheus/#disk_usageyaml","title":"disk_usage.yaml","text":"<pre><code>groups:\n- name: \u78c1\u76d8\u544a\u8b66\u89c4\u5219\n  rules:\n  - alert: \u78c1\u76d8\u4f7f\u7528\u7387\n    expr: (node_filesystem_size_bytes - node_filesystem_avail_bytes) / node_filesystem_size_bytes * 100 &gt; 90\n    for: 1m\n    labels:\n      user: prometheus\n      severity: warning\n    annotations:\n      description: \"\u78c1\u76d8\u5206\u533a{{ $labels.mountpoint }}\u7a7a\u95f4\u4f7f\u7528\u7387\u8d85\u8fc790% (\u5f53\u524d: {{ $value }}%)\"\n</code></pre>"},{"location":"docker/Install-Prometheus/#memory_usageyaml","title":"memory_usage.yaml","text":"<pre><code>groups:\n- name: \u5185\u5b58\u544a\u8b66\u89c4\u5219\n  rules:\n  - alert: \u5185\u5b58\u4f7f\u7528\u7387\n    expr: (node_memory_MemTotal_bytes - (node_memory_MemFree_bytes+node_memory_Buffers_bytes+node_memory_Cached_bytes )) / node_memory_MemTotal_bytes * 100 &gt; 85\n    for: 1m\n    labels:\n      user: prometheus\n      severity: warning\n    annotations:\n      description: \"\u5185\u5b58\u4f7f\u7528\u7387\u8d85\u8fc785% (\u5f53\u524d:{{ $value }}%)\"\n</code></pre>"},{"location":"docker/Install-Prometheus/#node_disconnectedyaml","title":"node_disconnected.yaml","text":"<pre><code>groups:\n- name: \u4e3b\u673a\u544a\u8b66\u89c4\u5219\n  rules:\n  - alert: \u4e3b\u673a\u5931\u53bb\u8054\u7cfb\n    expr: up == 0\n    for: 1m\n    labels:\n      user: prometheus\n      severity: critical\n    annotations:\n      #summary: \"\u4e3b\u673a {{ $labels.instance }} \u5931\u8054\"\n      description: \"\u4e3b\u673a {{ $labels.instance }}\u5df2\u7ecf\u5931\u53bb\u8054\u7cfb\u8d85\u8fc71\u5206\u949f\"\n</code></pre>"},{"location":"docker/Install-Prometheus/#win_cpu_usageyaml","title":"win_cpu_usage.yaml","text":"<pre><code>groups:\n- name: WIN_CPU\u544a\u8b66\u89c4\u5219\n  rules:\n  - alert: WIN_CPU\u4f7f\u7528\u7387\n    expr: 100 - (avg by (instance,job)(irate(windows_cpu_time_total{mode=\"idle\"}[2m]) )) * 100 &gt; 90\n    for: 2m\n    labels:\n      user: prometheus\n      severity: warning\n    annotations:\n      description: \"\u670d\u52a1\u5668CPU\u4f7f\u7528\u7387\u8d85\u8fc790% (\u5f53\u524d:{{ $value }}%)\"\n</code></pre>"},{"location":"docker/Install-Prometheus/#win_disk_usageyaml","title":"win_disk_usage.yaml","text":"<pre><code>groups:\n- name: WIN_\u78c1\u76d8\u544a\u8b66\u89c4\u5219\n  rules:\n  - alert: WIN_\u78c1\u76d8\u4f7f\u7528\u7387\n    expr: 100 - (avg by (job,volume,instance)(windows_logical_disk_free_bytes / windows_logical_disk_size_bytes))*100 &gt; 90\n    for: 1m\n    labels:\n      user: prometheus\n      severity: warning\n    annotations:\n      description: \"\u78c1\u76d8\u5206\u533a{{ $labels.mountpoint }}\u7a7a\u95f4\u4f7f\u7528\u7387\u8d85\u8fc790% (\u5f53\u524d: {{ $value }}%)\"\n</code></pre>"},{"location":"docker/Install-Prometheus/#win_memory_usageyaml","title":"win_memory_usage.yaml","text":"<pre><code>groups:\n- name: WIN_\u5185\u5b58\u544a\u8b66\u89c4\u5219\n  rules:\n  - alert: WIN_\u5185\u5b58\u4f7f\u7528\u7387\n    expr: 100 - (windows_os_physical_memory_free_bytes/ windows_cs_physical_memory_bytes) * 100 &gt; 85\n    for: 1m\n    labels:\n      user: prometheus\n      severity: warning\n    annotations:\n      description: \"\u5185\u5b58\u4f7f\u7528\u7387\u8d85\u8fc785% (\u5f53\u524d:{{ $value }}%)\"\n</code></pre>"},{"location":"docker/Install-Prometheus/#prometheusyaml","title":"prometheus.yaml","text":"<pre><code># my global config\nglobal:\n  scrape_interval:     25s # Set the scrape interval to every 15 seconds. Default is every 1 minute.\n  evaluation_interval: 25s # Evaluate rules every 15 seconds. The default is every 1 minute.\n  # scrape_timeout is set to the global default (10s).\n  scrape_timeout: 20s \n\n# Alertmanager configuration\nalerting:\n  alertmanagers:\n  - static_configs:\n    - targets: ['10.1.1.1:9093']\n\n# Load rules once and periodically evaluate them according to the global 'evaluation_interval'.\nrule_files:\n  # - \"first_rules.yml\"\n  # - \"second_rules.yml\"\n  - \"/etc/prometheus/rules/*.yml\"\n\n# A scrape configuration containing exactly one endpoint to scrape:\n# Here it's Prometheus itself.\nscrape_configs:\n  # The job name is added as a label `job=&lt;job_name&gt;` to any timeseries scraped from this config.\n  - job_name: 'prometheus'\n\n    # metrics_path defaults to '/metrics'\n   # scheme defaults to 'http'.\n    static_configs:\n    - targets: ['localhost:9090']\n\n  # \u76d1\u63a7harbor \n  - job_name: 'harbor-exporter'\n   scrape_interval: 20s\n   static_configs:\n     - targets: ['10.1.1.1:9090']\n  - job_name: 'harbor-core'\n   scrape_interval: 20s\n   params:\n     comp: ['core']\n   static_configs:\n     - targets: ['10.1.1.1:9090']\n  - job_name: 'harbor-registry'\n   scrape_interval: 20s\n   params:\n     comp: ['registry']\n   static_configs:\n     - targets: ['10.1.1.1:9090']\n  - job_name: 'harbor-jobservice'\n   scrape_interval: 20s\n   params:\n     comp: ['jobservice']\n   static_configs:\n     - targets: ['10.1.1.1:9090']\n\n  #  \u76d1\u63a7windows\u4e3b\u673a\n  - job_name: 'Windows'\n    static_configs:\n    - targets:\n      # dev\n      - \"10.1.1.1:9182\"\n\n  # \u76d1\u63a7linux\u4e3b\u673a\n  - job_name: 'Linux'\n    scrape_interval: 126s\n    scrape_timeout: 120s\n    static_configs:   \n    - targets:\n      # test \n      - \"10.1.1.1:9100\"\n\n\n  # \u76d1\u63a7pgsql     \n  - job_name: 'Postgresql'\n    static_configs:\n    - targets:\n      # test\n      - \"10.1.1.1:9187\"\n\n  # \u76d1\u63a7docker\u5bb9\u5668\n  - job_name: 'Docker'\n    static_configs:\n    - targets:\n      # dev\n      - \"10.1.1.1:19104\"\n\n  # \u76d1\u63a7JVM\n  - job_name: 'Java JVM'\n   static_configs:\n   - targets:\n     - \"10.1.1.1:8080\"\n\n  # \u76d1\u63a7redis\n  - job_name: 'Redis'\n   static_configs:\n   - targets: ['10.1.1.1:9121']\n\n  # \u76d1\u63a7Oracle\n  - job_name: 'Oracle'\n   static_configs:\n   - targets: ['10.1.1.1:9161']\n\n  # \u76d1\u63a7Rabbitmq\n  - job_name: 'Rabbitmq'\n    static_configs:\n    - targets: ['10.1.1.1:15692']\n\n  # \u76d1\u63a7Minio\n  - job_name: 'Minio'\n   bearer_token: eyJhbGciOiJIUzUxMiIsInR5cCI6IkpXVCJ9.eyJleHAiOjQ4MTUwMjAwMDMsImlzcyI6InByb21ldGhldXMiLCJzdWIiOiJhZG1pbiJ9.Wv6DHwCq-SNGX861Gd14sYPRSc3CJRHMI3aSxdCUslDFtJbHRF0QxXODAjEASu4YEul55nBYbSGqfMqf8jnvTA\n   metrics_path: /minio/v2/metrics/cluster\n   scheme: http\n   static_configs:\n   - targets: ['10.1.1.1:9000']\n\n  # \u76d1\u63a7apisix\n  - job_name: \"apisix\"\n   scrape_interval: 5s\n   metrics_path: \"/apisix/prometheus/metrics\"\n   static_configs:\n     - targets: [\"10.1.1.1:9091\"]\n</code></pre>"},{"location":"docker/Install-Prometheus/#dingtalk-configyaml","title":"dingtalk-config.yaml","text":"<pre><code>## Request timeout\n# timeout: 5s\n\n## Uncomment following line in order to write template from scratch (be careful!)\n#no_builtin_template: true\n\n## Customizable templates path\n#templates:\n#  - contrib/templates/legacy/template.tmpl\n\n## You can also override default template using \n## The following example to use the 'legacy' template from v0.3.0\n#default_message:\n#  title: '{{ template \"legacy.title\" . }}'\n#  text: '{{ template \"legacy.content\" . }}'\n\n## Targets, previously was known as \"profiles\"\ntargets:\n  webhook1:\n    url: https://oapi.dingtalk.com/robot/send?access_token=be0e92f1278b3759dcbd98eecf5d93d797b4f82576cac0184a7cae0929bcd5pl\n    # secret for signature\n    #secret: SEC8eb3fee1f3cc699b7058a9896c893004afa1d4e7ef0bdf87d87f8e48512aa976\n    secret: SEC6eb89ced3853d7232d3d34ea22d5f8bad2d7dfa790cf7d01e4cd0434b9452258\n  #webhook2:\n  #  url: https://oapi.dingtalk.com/robot/send?access_token=xxxxxxxxxxxx\n  #webhook_legacy:\n  #  url: https://oapi.dingtalk.com/robot/send?access_token=xxxxxxxxxxxx\n  #  # Customize template content\n  #  message:\n  #    # Use legacy template\n  #    title: '{{ template \"legacy.title\" . }}'\n  #    text: '{{ template \"legacy.content\" . }}'\n  #webhook_mention_all:\n  #  url: https://oapi.dingtalk.com/robot/send?access_token=be0e92f1278b3759dcbd98eecf5d93d797b4f82576cac0184a7cae0929bcd5pl\n  #  mention:\n  #    all: true\n  #webhook_mention_users:\n  #  url: https://oapi.dingtalk.com/robot/send?access_token=be0e92f1278b3759dcbd98eecf5d93d797b4f82576cac0184a7cae0929bcd5pl\n  #  mention:\n  #    #mobiles: ['+86-123456789244']\n  #    mobiles: ['123456789244']\n</code></pre>"},{"location":"docker/Install-Prometheus/#alertmanageryaml","title":"alertmanager.yaml","text":"<pre><code># \u5168\u5c40\u914d\u7f6e\n# \u5b9a\u4e49\u4e00\u4e9b\u5168\u5c40\u7684\u516c\u5171\u53c2\u6570\uff0c\u5982\u5168\u5c40\u7684SMTP\u914d\u7f6e\uff0cSlack\u914d\u7f6e\u7b49\u5185\u5bb9\nglobal:\n  # \u5b9a\u4e49\u4e86\u5f53Alertmanager\u6301\u7eed\u591a\u957f\u65f6\u95f4\u672a\u63a5\u6536\u5230\u544a\u8b66\u540e\u6807\u8bb0\u544a\u8b66\u72b6\u6001\u4e3aresolved\uff08\u5df2\u89e3\u51b3\uff09\u3002\u8be5\u53c2\u6570\u7684\u5b9a\u4e49\u53ef\u80fd\u4f1a\u5f71\u54cd\u5230\u544a\u8b66\u6062\u590d\u901a\u77e5\u7684\u63a5\u6536\u65f6\u95f4\uff0c\u9ed8\u8ba45min\n  # \u6bcf\u4e00\u5206\u949f\u68c0\u67e5\u4e00\u6b21\u662f\u5426\u6062\u590d\n  resolve_timeout: 1m\n  # \u53d1\u4ef6\u670d\u52a1\u5668\n  # smtp\u5730\u5740\u9700\u8981\u52a0\u7aef\u53e3\n  smtp_smarthost: 'smtp.163.com:465'\n  smtp_from: 'xxxxxx@163.com'\n  # \u53d1\u4ef6\u4eba\u90ae\u7bb1\u8d26\u53f7\n  smtp_auth_username: 'xxxxxxx@163.com'\n  # \u8d26\u53f7\u5bf9\u5e94\u7684\u6388\u6743\u7801\uff08\u4e0d\u662f\u5bc6\u7801\uff09\uff0cQQ\u90ae\u7bb1\u6388\u6743\u7801\u53ef\u4ee5\u5728\u201c\u8bbe\u7f6e-\u8d26\u6237-POP3/SMTP\u670d\u52a1\u201d\u91cc\u9762\u627e\u5230\u70b9\u51fb\u5f00\u542f\n  smtp_auth_password: 'xxxxxxx'\n  smtp_require_tls: false\n\n# \u6a21\u677f\n# \u5b9a\u4e49\u544a\u8b66\u901a\u77e5\u65f6\u7684\u6a21\u677f\uff0c\u5982HTML\u6a21\u677f\uff0c\u90ae\u4ef6\u6a21\u677f\u7b49\n#templates:\n#  [ - &lt;filepath&gt; ... ]\n\n# \u8def\u7531\n# \u6839\u636e\u6807\u7b7e\u5339\u914d\uff0c\u786e\u5b9a\u5f53\u524d\u544a\u8b66\u5e94\u8be5\u5982\u4f55\u5904\u7406\n# \u9876\u7ea7\u8def\u7531\nroute:\n  # \u91c7\u7528\u54ea\u4e2a\u6807\u7b7e\u6765\u4f5c\u4e3a\u5206\u7ec4\u4f9d\u636e\n  # \u57fa\u4e8e\u544a\u8b66\u4e2d\u5305\u542b\u7684\u6807\u7b7e\uff0c\u5982\u679c\u6ee1\u8db3group_by\u4e2d\u5b9a\u4e49\u6807\u7b7e\u540d\u79f0\uff0c\u90a3\u4e48\u8fd9\u4e9b\u544a\u8b66\u5c06\u4f1a\u5408\u5e76\u4e3a\u4e00\u4e2a\u901a\u77e5\u53d1\u9001\u7ed9\u63a5\u6536\u5668\n  group_by: ['alertname']\n  # \u9ed8\u8ba4\u544a\u8b66\u63a5\u6536\u4eba \n  receiver: 'default-receiver'\n  # \u7ec4\u544a\u8b66\u7b49\u5f85\u65f6\u95f4\n  # \u4e5f\u5c31\u662f\u544a\u8b66\u4ea7\u751f\u540e\u7b49\u5f8510s\uff0c\u5982\u679c\u6709\u540c\u7ec4\u544a\u8b66\u4e00\u8d77\u53d1\u51fa\n  group_wait: 30s\n  # \u4e24\u7ec4\u544a\u8b66\u7684\u95f4\u9694\u65f6\u95f4\n  group_interval: 10s\n  # \u91cd\u590d\u544a\u8b66\u7684\u95f4\u9694\u65f6\u95f4\uff0c\u51cf\u5c11\u76f8\u540c\u544a\u8b66\u7684\u53d1\u9001\u9891\u7387\n  repeat_interval: 1h\n\n  # \u8def\u7531\u6811\n  # \u6839\u636e\u8def\u7531\u89c4\u5219\u5c06\u544a\u8b66\u4fe1\u606f\u53d1\u9001\u7ed9\u76f8\u5e94\u7684\u63a5\u6536\u5668\n  routes:\n    # \u6309\u7167\u89d2\u8272(\u6bd4\u5982\u7cfb\u7edf\u8fd0\u7ef4\uff0c\u6570\u636e\u5e93\u7ba1\u7406\u5458, SER, Devops)\u6765\u5212\u5206\u591a\u4e2a\u63a5\u6536\u5668\n    - receiver: 'default-receiver'  #\u544a\u8b66\u63a5\u6536\u4eba\n      group_wait: 10s\n      continue: true\n      match_re:\n        #severity: warning\n        alertname: \u5185\u5b58\u4f7f\u7528\u7387|CPU\u4f7f\u7528\u7387|\u78c1\u76d8\u4f7f\u7528\u7387|\u4e3b\u673a\u5931\u53bb\u8054\u7cfb\n\n    - receiver: 'Devops'  #\u544a\u8b66\u63a5\u6536\u4eba\n      group_wait: 10s\n      match_re:\n        #service: mysql|cassandra\n        #severity: warning\n        #group_by: [product, environment]\n        alertname: \u5185\u5b58\u4f7f\u7528\u7387|CPU\u4f7f\u7528\u7387|\u78c1\u76d8\u4f7f\u7528\u7387|\u4e3b\u673a\u5931\u53bb\u8054\u7cfb\n\n\n# \u63a5\u6536\u4eba\n# \u63a5\u6536\u4eba\u662f\u4e00\u4e2a\u62bd\u8c61\u7684\u6982\u5ff5\uff0c\u5b83\u53ef\u4ee5\u662f\u4e00\u4e2a\u90ae\u7bb1\u4e5f\u53ef\u4ee5\u662f\u5fae\u4fe1\uff0cSlack\u6216\u8005Webhook\u7b49\uff0c\u63a5\u6536\u4eba\u4e00\u822c\u914d\u5408\u544a\u8b66\u8def\u7531\u4f7f\u7528\nreceivers:\n  # \u63a5\u6536\u5668\u53ef\u4ee5\u5173\u8054\u90ae\u4ef6\uff0cSlack\u4ee5\u53ca\u5176\u5b83\u65b9\u5f0f\u63a5\u6536\u544a\u8b66\u4fe1\u606f\u3002\n  - name: 'Devops'\n    webhook_configs:\n    - url: 'http://xxxxxxxxxxxx:8060/dingtalk/webhook1/send'\n      # \u8b66\u62a5\u88ab\u89e3\u51b3\u4e4b\u540e\u662f\u5426\u901a\u77e5\n      send_resolved: true\n\n  - name: 'default-receiver'\n    email_configs:\n    - to: 'xxxxxxx@163.com'\n      send_resolved: true\n\n\n# \u6291\u5236\u89c4\u5219\n# \u5408\u7406\u8bbe\u7f6e\u6291\u5236\u89c4\u5219\u53ef\u4ee5\u51cf\u5c11\u5783\u573e\u544a\u8b66\u7684\u4ea7\u751f\n# \u5f53\u4e0e\u53e6\u4e00\u7ec4\u5339\u914d\u5668\u7684\u89c4\u5219\u5339\u914d\u65f6\uff0c\u4ec5\u5176\u4e2d\u4e00\u7ec4\u5931\u6548\uff0c\u524d\u63d0\u662f\u4e24\u4e2a\u544a\u8b66\u7ec4\u5fc5\u987b\u6709\u76f8\u540c\u7684\u6807\u7b7e\ninhibit_rules:\n  # \u544a\u8b66\u7684\u6839\u672c\u539f\u56e0\n  - source_match:\n      severity: 'critical'\n    # \u65b0\u751f\u544a\u8b66\u7684\u89e6\u53d1\u6761\u4ef6\n    target_match:\n      severity: 'warning'\n    equal: ['alertname', 'dev', 'instance']\n</code></pre>"},{"location":"docker/Install-Rabbitmq/","title":"Install Rabbitmq","text":""},{"location":"docker/Install-Rabbitmq/#compose-file","title":"Compose file","text":"<pre><code>version: '3'\nservices:\n  rabbitmq:\n    image: harbor.dockerregistry.com/app/rabbitmq:3.8.26-management-alpine\n    container_name: \"rabbitmq\"\n    hostname: \"rabbitmq\"\n    ports:\n      - 5672:5672    #amqp\n      - 15672:15672  #http\n      #- 15692:15692  #prometheus\n    environment:\n      TZ: Asia/Shanghai\n      RABBITMQ_DEFAULT_USER: \"admin\"\n      RABBITMQ_DEFAULT_PASS: \"admin@123\"\n    healthcheck:\n      test: [ \"CMD\", \"rabbitmqctl\", \"status\"]\n      interval: 5s\n      timeout: 20s\n      retries: 10\n    volumes:\n      - /etc/localtime:/etc/localtime:ro\n      - /data/middleware/rabbitmq/data/:/var/lib/rabbitmq/\n</code></pre>"},{"location":"docker/Install-Rabbitmq/#create_queuespy","title":"create_queues.py","text":"<pre><code>#!/usr/bin/env python\n# -*- coding: utf-8 -*-\n\nimport pika\n\ndef create_queue(queue_name):\n    credentials = pika.PlainCredentials('admin', 'admin@123')\n    parameters = pika.ConnectionParameters('127.0.0.1', 5672, '/', credentials)\n    connection = pika.BlockingConnection(parameters)\n    channel = connection.channel()\n\n    channel.queue_declare(queue=queue_name, durable=True)\n\n    print(\"\u961f\u5217 {} \u521b\u5efa\u6210\u529f\".format(queue_name))\n\n\n    connection.close()\n\ndef main():\n    queue_names = [\n        'applyUpdateMessageInformQueue',\n        'dataLibQueue',\n        'dataServiceUpdateHasApplyQueue',\n        'serviceApplyinsertUseServiceQueue',\n        'serviceAuthAddQueue',\n        'serviceAuthEditQueue',\n        'serviceAuthQueue'\n    ]  # \u8981\u521b\u5efa\u7684\u961f\u5217\u540d\u79f0\u5217\u8868\n\n    for queue_name in queue_names:\n        create_queue(queue_name)\n\nif __name__ == '__main__':\n    main()\n</code></pre>"},{"location":"docker/Install-Rabbitmq/#delete_queuespy","title":"delete_queues.py","text":"<pre><code>#!/usr/bin/env python\n# -*- coding: utf-8 -*-\n\nimport pika\n\ndef delete_queue(queue_name):\n    credentials = pika.PlainCredentials('admin', 'admin@123')\n    parameters = pika.ConnectionParameters('127.0.0.1', 5672, '/', credentials)\n    connection = pika.BlockingConnection(parameters)\n    channel = connection.channel()\n\n    channel.queue_delete(queue=queue_name)\n\n    print(\"\u961f\u5217 {} \u5220\u9664\u6210\u529f\".format(queue_name))\n\n    connection.close()\n\ndef main():\n    queue_names = [\n        'applyUpdateMessageInformQueue',\n        'dataLibQueue',\n        'dataServiceUpdateHasApplyQueue',\n        'serviceApplyinsertUseServiceQueue',\n        'serviceAuthAddQueue',\n        'serviceAuthEditQueue',\n        'serviceAuthQueue'\n    ]  # \u8981\u5220\u9664\u7684\u961f\u5217\u540d\u79f0\u5217\u8868\n\n    for queue_name in queue_names:\n        delete_queue(queue_name)\n\nif __name__ == '__main__':\n    main()\n</code></pre>"},{"location":"docker/Install-Redis-Cluster/","title":"Install Redis Cluster","text":""},{"location":"docker/Install-Redis-Cluster/#redis","title":"\u90e8\u7f72Redis \u96c6\u7fa4","text":"<p> \u8fd9\u91cc\u90e8\u7f72\u548c\u7ef4\u62a4\u90fd\u662f\u5728/root \u76ee\u5f55\u4e0b\uff0c\u64cd\u4f5c\u90fd\u662f\u4f7f\u7528<code>root</code>\u7528\u6237\uff0c\u8bf7\u7559\u610f\u3002</p> <p> \u5982\u679c\u6761\u4ef6\u5141\u8bb8\uff0c\u5efa\u8bae\u5404\u4e2a\u96c6\u7fa4\u90fd\u80fd\u72ec\u81ea\u4f7f\u7528\u81ea\u5df1\u7684\u670d\u52a1\u5668\u8d44\u6e90\uff0c\u800c\u975e\u4e0e\u5176\u4ed6\u96c6\u7fa4\u5171\u4eab\uff0c\u4ee5\u514d\u9ad8\u8d1f\u8f7d\u65f6\u5b58\u5728\u8d44\u6e90\u4e89\u62a2\u5bfc\u81f4\u6545\u969c\u7684\u95ee\u9898\u3002</p> <p>\u96c6\u7fa4\u6a21\u5f0f\uff1a\u4e00\u4e3b\u4e09\u4ece\u4e09\u54e8\u5175</p> <p>\u8fd9\u79cd<code>Redis</code>\u96c6\u7fa4\u67b6\u6784\u5b9e\u9645\u4e0a\u5c31\u662f\u628a\u4e3b\u4ece\u590d\u5236\u548c\u54e8\u5175\u6a21\u5f0f\u7ed3\u5408\u4f7f\u7528\u7684\u4e00\u4e2a\u96c6\u7fa4\u65b9\u6848\u3002\u66f4\u51c6\u786e\u5730\u8bf4,\u5b83\u662f\u4e00\u4e2a:</p> <p>\u4e3b\u4ece\u590d\u5236\u96c6\u7fa4 + \u54e8\u5175\u6a21\u5f0f\u96c6\u7fa4</p> <p>\u4e3b\u4ece\u590d\u5236\u96c6\u7fa4\u90e8\u5206:</p> <ul> <li>1\u4e2a\u4e3b\u8282\u70b9\u7528\u4e8e\u5199</li> <li>3\u4e2a\u4ece\u8282\u70b9\u4e0e\u4e3b\u8282\u70b9\u4e3b\u4ece\u540c\u6b65\u5b9e\u73b0\u5907\u4efd</li> </ul> <p>\u54e8\u5175\u6a21\u5f0f\u96c6\u7fa4\u90e8\u5206: </p> <ul> <li>3\u4e2a\u54e8\u5175\u8282\u70b9\u76d1\u63a7\u4e3b\u4ece\u72b6\u6001</li> <li>\u5982\u679c\u4e3b\u8282\u70b9\u6545\u969c,\u4f1a\u81ea\u52a8\u9009\u4e3e\u4ece\u8282\u70b9\u66ff\u6362\u4e3a\u65b0\u7684\u4e3b\u8282\u70b9</li> </ul> <p>\u6240\u4ee5\u8fd9\u4e2a\u96c6\u7fa4\u540c\u65f6\u5b9e\u73b0\u4e86:</p> <ul> <li>\u6570\u636e\u4e3b\u4ece\u5907\u4efd</li> <li>\u81ea\u52a8\u6545\u969c\u8f6c\u79fb</li> <li>\u8bfb\u5199\u5206\u79bb</li> <li>\u9ad8\u53ef\u7528</li> </ul> <p>\u901a\u8fc7\u7ed3\u5408\u4e3b\u4ece\u590d\u5236\u548c\u54e8\u5175\u6a21\u5f0f\u7684\u4f18\u70b9,\u5f62\u6210\u4e00\u4e2a\u5b8c\u6574\u7684<code>Redis</code>\u9ad8\u53ef\u7528\u96c6\u7fa4\u67b6\u6784\u3002</p>"},{"location":"docker/Install-Redis-Cluster/#11","title":"1.1 \u4f7f\u7528\u65b9\u5f0f","text":"<pre><code># \u4e0a\u4f20\u9644\u4ef6\u76ee\u5f55\uff1aredis-cluster \u5230/root\n\n# \u67e5\u770b\u6587\u4ef6\nroot@deepin-1:~# cd redis-cluster\nroot@deepin-1:~/redis-cluster# ls -lha\ntotal 11M\ndrwxr-xr-x 3 root root 4.0K Jan 18 18:27 .\ndrwx------ 5 root root 4.0K Jan 18 18:23 ..\ndrwxr-xr-x 2 root root 4.0K Jan 18 11:17 conf\n-rw-r--r-- 1 root root 3.8K Jan 18 10:40 docker-compose.yml\n-rw-r--r-- 1 root root  441 Jan 18 09:35 .env.example\n-rw-r--r-- 1 root root  11M Jan 18 18:27 redis.tar.gz\n\n\ndocker load -i redis.tar.gz \ncp .env.example .env\nvim .env # \u8bf7\u7ed3\u5408\u81ea\u5df1\u7684\u60c5\u51b5\u4fee\u6539\u914d\u7f6e\u540e\u518d\u542f\u52a8\ndocker-compose up -d\n</code></pre> <p>\u542f\u52a8\u5b8c\u6210</p> <pre><code>root@deepin-1:~/redis-cluster# docker-compose ps -a \nNAME                      IMAGE              COMMAND                  SERVICE                   CREATED          STATUS          PORTS\nredis-server-master       redis:6.2-alpine   \"docker-entrypoint.s\u2026\"   redis-server-master       23 seconds ago   Up 21 seconds   0.0.0.0:6379-&gt;6379/tcp\nredis-server-sentinel-1   redis:6.2-alpine   \"docker-entrypoint.s\u2026\"   redis-server-sentinel-1   23 seconds ago   Up 17 seconds   6379/tcp, 0.0.0.0:6383-&gt;26379/tcp\nredis-server-sentinel-2   redis:6.2-alpine   \"docker-entrypoint.s\u2026\"   redis-server-sentinel-2   23 seconds ago   Up 16 seconds   6379/tcp, 0.0.0.0:6384-&gt;26379/tcp\nredis-server-sentinel-3   redis:6.2-alpine   \"docker-entrypoint.s\u2026\"   redis-server-sentinel-3   23 seconds ago   Up 18 seconds   6379/tcp, 0.0.0.0:6385-&gt;26379/tcp\nredis-server-slave-1      redis:6.2-alpine   \"docker-entrypoint.s\u2026\"   redis-server-slave-1      23 seconds ago   Up 15 seconds   0.0.0.0:6380-&gt;6379/tcp\nredis-server-slave-2      redis:6.2-alpine   \"docker-entrypoint.s\u2026\"   redis-server-slave-2      23 seconds ago   Up 19 seconds   0.0.0.0:6381-&gt;6379/tcp\nredis-server-slave-3      redis:6.2-alpine   \"docker-entrypoint.s\u2026\"   redis-server-slave-3      23 seconds ago   Up 19 seconds   0.0.0.0:6382-&gt;6379/tcp\n</code></pre>"},{"location":"docker/Install-Redis-Cluster/#12","title":"1.2 \u9a8c\u8bc1\u65b9\u5f0f","text":""},{"location":"docker/Install-Redis-Cluster/#121","title":"1.2.1 \u6d4b\u8bd5\u4e3b\u8282\u70b9\u72b6\u6001","text":"<pre><code>root@deepin-1:~/redis-cluster# docker exec -it redis-server-master redis-cli\n127.0.0.1:6379&gt; auth redis\n\n127.0.0.1:6379&gt; auth redis\nOK\n127.0.0.1:6379&gt; ping\nPONG\n127.0.0.1:6379&gt; info replication\n# Replication\nrole:master\nconnected_slaves:3\nslave0:ip=10.10.10.3,port=6379,state=online,offset=15129,lag=0\nslave1:ip=10.10.10.4,port=6379,state=online,offset=14994,lag=1\nslave2:ip=10.10.10.2,port=6379,state=online,offset=14994,lag=1\nmaster_failover_state:no-failover\nmaster_replid:b5b020eda1ee0141e7066d6f2f59cd154c0fa145\nmaster_replid2:0000000000000000000000000000000000000000\nmaster_repl_offset:15278\nsecond_repl_offset:-1\nrepl_backlog_active:1\nrepl_backlog_size:1048576\nrepl_backlog_first_byte_offset:1\nrepl_backlog_histlen:15278\n</code></pre>"},{"location":"docker/Install-Redis-Cluster/#122","title":"1.2.2 \u6d4b\u8bd5\u4ece\u8282\u70b9\u72b6\u6001","text":"<pre><code>root@deepin-1:~/redis-cluster# docker exec -it redis-server-slave-1 redis-cli\n127.0.0.1:6379&gt; auth redis\nOK\n127.0.0.1:6379&gt; ping\nPONG\n127.0.0.1:6379&gt; info replication\n# Replication\nrole:slave\nmaster_host:redis-server-master\nmaster_port:6379\nmaster_link_status:up\nmaster_last_io_seconds_ago:0\nmaster_sync_in_progress:0\nslave_read_repl_offset:26013\nslave_repl_offset:26013\nslave_priority:100\nslave_read_only:1\nreplica_announced:1\nconnected_slaves:0\nmaster_failover_state:no-failover\nmaster_replid:b5b020eda1ee0141e7066d6f2f59cd154c0fa145\nmaster_replid2:0000000000000000000000000000000000000000\nmaster_repl_offset:26013\nsecond_repl_offset:-1\nrepl_backlog_active:1\nrepl_backlog_size:1048576\nrepl_backlog_first_byte_offset:159\nrepl_backlog_histlen:25855\n</code></pre>"},{"location":"docker/Install-Redis-Cluster/#123","title":"1.2.3 \u6d4b\u8bd5\u54e8\u5175\u8282\u70b9\u72b6\u6001","text":"<pre><code>docker exec -it redis-server-sentinel-1 /bin/sh\n/data # \n/data # redis-cli -p 26379 -h 10.10.10.5\n10.10.10.5:26379&gt; \n10.10.10.5:26379&gt; \n10.10.10.5:26379&gt; sentinel master mymaster\n 1) \"name\"\n 2) \"mymaster\"\n 3) \"ip\"\n 4) \"10.10.10.1\"\n 5) \"port\"\n 6) \"6379\"\n 7) \"runid\"\n 8) \"0b5c7ba11b4397c48e707ff15eb8b2f821dfd0ac\"\n 9) \"flags\"\n10) \"master\"\n11) \"link-pending-commands\"\n12) \"0\"\n13) \"link-refcount\"\n14) \"1\"\n15) \"last-ping-sent\"\n16) \"0\"\n17) \"last-ok-ping-reply\"\n18) \"240\"\n19) \"last-ping-reply\"\n20) \"240\"\n21) \"down-after-milliseconds\"\n22) \"5000\"\n23) \"info-refresh\"\n24) \"4750\"\n25) \"role-reported\"\n26) \"master\"\n27) \"role-reported-time\"\n28) \"185577\"\n29) \"config-epoch\"\n30) \"0\"\n31) \"num-slaves\"\n32) \"3\"\n33) \"num-other-sentinels\"\n34) \"2\"\n35) \"quorum\"\n36) \"2\"\n37) \"failover-timeout\"\n38) \"180000\"\n39) \"parallel-syncs\"\n40) \"1\"\n10.10.10.5:26379&gt; \n</code></pre>"},{"location":"docker/Install-Redis-Cluster/#124","title":"1.2.4 \u67e5\u770b\u6570\u636e","text":"<pre><code>root@deepin-1:~/redis-cluster# ls -lh /data/redis-*\n/data/redis-master:\ntotal 4.0K\n-rw-r--r-- 1 deepin-anything-server deepin 176 Jan 18 18:29 dump.rdb\n\n/data/redis-slave-1:\ntotal 4.0K\n-rw-r--r-- 1 deepin-anything-server deepin 176 Jan 18 18:29 dump.rdb\n\n/data/redis-slave-2:\ntotal 4.0K\n-rw-r--r-- 1 deepin-anything-server deepin 175 Jan 18 18:29 dump.rdb\n\n/data/redis-slave-3:\ntotal 4.0K\n-rw-r--r-- 1 deepin-anything-server deepin 175 Jan 18 18:29 dump.rdb\n</code></pre>"},{"location":"docker/Install-Redis/","title":"Install Redis","text":""},{"location":"docker/Install-Redis/#compose-file","title":"Compose file","text":"<pre><code>version: '3'\nservices:\n  redis:\n    image: harbor.dockerregistry.com/app/redis:6.2.6\n    container_name: redis\n    ports:\n      - 6379:6379\n    command: [ \"redis-server\", \"/usr/local/etc/redis/redis.conf\"]\n    environment:\n      REDIS_PASSWORD: admin@123\n    volumes:\n      - /etc/localtime:/etc/localtime:ro\n      - ./redis.conf:/usr/local/etc/redis/redis.conf\n      - /data/middleware/redis/data:/data\n    privileged: true\n    healthcheck:\n      test: [\"CMD-SHELL\", \"redis-cli ping\"]\n      interval: 10s\n      timeout: 5s\n      retries: 3\n    restart: always\n</code></pre>"},{"location":"docker/Install-Redis/#redisconfv6","title":"redis.conf(v6)","text":"<pre><code>dir /data\nport 6379\nrequirepass admin@123\npidfile /data/redis-6379.pid\n#logfile /data/redis.log\nbind 0.0.0.0\nprotected-mode yes\ntcp-backlog 1024\ntimeout 0\ntcp-keepalive 300\ndaemonize no\nloglevel notice\ndatabases 16\nalways-show-logo no\nset-proc-title yes\nproc-title-template \"{title} {listen-addr} {server-mode}\"\nstop-writes-on-bgsave-error yes\nrdbcompression yes\nrdbchecksum yes\ndbfilename dump.rdb\nrdb-del-sync-files no\nreplica-serve-stale-data yes\nreplica-read-only yes\nrepl-diskless-sync no\nrepl-diskless-sync-delay 5\nrepl-diskless-load disabled\nrepl-disable-tcp-nodelay no\nreplica-priority 100\nacllog-max-len 128\nlazyfree-lazy-eviction no\nlazyfree-lazy-expire no\nlazyfree-lazy-server-del no\nreplica-lazy-flush no\nlazyfree-lazy-user-del no\nlazyfree-lazy-user-flush no\noom-score-adj no\noom-score-adj-values 0 200 800\ndisable-thp yes\nappendonly yes\nappendfilename \"appendonly.aof\"\nappendfsync everysec\nno-appendfsync-on-rewrite yes\nauto-aof-rewrite-percentage 100\nauto-aof-rewrite-min-size 64mb\naof-load-truncated yes\naof-use-rdb-preamble yes\nlua-time-limit 5000\nslowlog-log-slower-than 10000\nslowlog-max-len 128\nlatency-monitor-threshold 0\nnotify-keyspace-events \"\"\nhash-max-ziplist-entries 512\nhash-max-ziplist-value 64\nlist-max-ziplist-size -2\nlist-compress-depth 0\nset-max-intset-entries 512\nzset-max-ziplist-entries 128\nzset-max-ziplist-value 64\nhll-sparse-max-bytes 3000\nstream-node-max-bytes 4096\nstream-node-max-entries 100\nactiverehashing yes\nclient-output-buffer-limit normal 0 0 0\nclient-output-buffer-limit replica 256mb 64mb 60\nclient-output-buffer-limit pubsub 32mb 8mb 60\nhz 10\ndynamic-hz yes\naof-rewrite-incremental-fsync yes\nrdb-save-incremental-fsync yes\njemalloc-bg-thread yes\n</code></pre>"},{"location":"docker/Install-Redis/#redisconfv7","title":"redis.conf(v7)","text":"<pre><code>dir /data\nport 6379\nrequirepass Admin@123.com\npidfile /data/redis-6379.pid\n#logfile /data/redis.log\nbind 0.0.0.0\nprotected-mode yes\ntcp-backlog 1024\ntimeout 0\ntcp-keepalive 300\ndaemonize no\nloglevel notice\ndatabases 16\nalways-show-logo no\nset-proc-title yes\nproc-title-template \"{title} {listen-addr} {server-mode}\"\nstop-writes-on-bgsave-error yes\nrdbcompression yes\nrdbchecksum yes\ndbfilename dump.rdb\nrdb-del-sync-files no\nreplica-serve-stale-data yes\nreplica-read-only yes\nrepl-diskless-sync no\nrepl-diskless-sync-delay 5\nreplica-priority 100\nacllog-max-len 128\nlazyfree-lazy-eviction no\nlazyfree-lazy-expire no\nlazyfree-lazy-server-del no\nreplica-lazy-flush no\nlazyfree-lazy-user-del no\nlazyfree-lazy-user-flush no\noom-score-adj no\noom-score-adj-values 0 200 800\ndisable-thp yes\nappendonly yes\nappendfilename \"appendonly.aof\"\nappendfsync everysec\nno-appendfsync-on-rewrite yes\nauto-aof-rewrite-percentage 100\nauto-aof-rewrite-min-size 64mb\naof-load-truncated yes\nlua-time-limit 5000\nslowlog-log-slower-than 10000\nslowlog-max-len 128\nlatency-monitor-threshold 0\nnotify-keyspace-events \"\"\nactiverehashing yes\nclient-output-buffer-limit normal 0 0 0\nclient-output-buffer-limit replica 256mb 64mb 60\nclient-output-buffer-limit pubsub 32mb 8mb 60\nhz 10\ndynamic-hz yes\naof-rewrite-incremental-fsync yes\nrdb-save-incremental-fsync yes\njemalloc-bg-thread yes\n</code></pre>"},{"location":"docker/Install-Runner/","title":"Install Runner","text":""},{"location":"docker/Install-Runner/#1-compose-file","title":"1 Compose File","text":"<pre><code>version: '3'\nservices:\n  gitlab-runner:\n    image: gitlab/gitlab-runner:latest\n    container_name: gitlab-runner\n    privileged: true\n    restart: always\n    volumes:\n      - ./gitlab-runner/:/etc/gitlab-runner      \n      - ~/.docker:/root/.docker\n      - /var/run/docker.sock:/var/run/docker.sock\n      #- ./cache:/cache\n</code></pre>"},{"location":"docker/Install-Runner/#2-register-runner","title":"2 Register Runner","text":"<pre><code>root@DEVOPS:~/gitlab-runner-npm# cat auto-register-runner.sh \n#!/bin/bash\n\nREGISTRATION_TOKEN=\"GR13489413zMeyMkh3zq7nNsvaPZe\"\nRUNNER_NAME=\"gitlab-runner-npm-group\"\n\ndocker exec -it \"${RUNNER_NAME}\" gitlab-runner register \\\n  --non-interactive \\\n  --url \"http://172.31.94.6/\" \\\n  --registration-token \"${REGISTRATION_TOKEN}\" \\\n  --executor \"docker\" \\\n  --docker-image \"docker:19.03.12\" \\\n  --description \"Docker Runner\" \\\n  --tag-list \"docker-npm\" \\\n  --locked=true \\\n  --docker-privileged=true \\\n  --run-untagged=false \\\n  --docker-tlsverify=false \\\n  --docker-disable-entrypoint-overwrite=false \\\n  --docker-oom-kill-disable=false \\\n  --docker-disable-cache=false \\\n  --docker-shm-size=0 \\\n  --cache-type=\"s3\" \\\n  --cache-path=\"runner\" \\\n  --cache-shared=true \\\n  --cache-s3-server-address=\"192.1.2.100:9000\" \\\n  --cache-s3-access-key=\"08JbSVlKWEYc1fc8xFwf\" \\\n  --cache-s3-secret-key=\"JICzCcjqXTa5DVk6ZIIOFWBafZv32HFYV4arNUD4\" \\\n  --cache-s3-bucket-name=\"runner-cache-papd\" \\\n  --cache-s3-insecure=true\n</code></pre>"},{"location":"docker/Install-Runner/#3-runner-config","title":"3 Runner Config","text":"<pre><code>root@DEVOPS:~/gitlab-runner-npm# cat gitlab-runner/config.toml \nconcurrent = 1\ncheck_interval = 0\n\n[session_server]\n  session_timeout = 1800\n\n[[runners]]\n  name = \"Docker Runner\"\n  url = \"http://172.31.94.6/\"\n  token = \"y_L4CRYByzvxbTxiryFJ\"\n  executor = \"docker\"\n  [runners.custom_build_dir]\n  #[runners.cache]\n  #  Type = \"local\"\n  #  Path = \"/cache\"\n  #  Shared = true\n  [runners.cache]\n    Type = \"s3\"\n    Path = \"runner\"\n    Shared = true\n    [runners.cache.s3]\n      ServerAddress = \"192.1.2.100:9000\"\n      AccessKey = \"08JbSVlKWEYc1fc8xFwf\"\n      SecretKey = \"JICzCcjqXTa5DVk6ZIIOFWBafZv32HFYV4arNUD4\"\n      BucketName = \"runner-cache-papd\"\n      Insecure = true\n    [runners.cache.gcs]\n    [runners.cache.azure]\n  [runners.docker]\n    tls_verify = false\n    image = \"docker:19.03.12\"\n    privileged = true\n    disable_entrypoint_overwrite = false\n    oom_kill_disable = false\n    disable_cache = false\n    volumes = [\"/cache\"]\n    shm_size = 536870912\n    memory = \"24000m\"\n    memory_swap = \"26g\"\n    #memory_reservation = \"8000m\"\n    cpus = \"12\"\n    allowed_images = [\n      \"harbor.dockerregistry.com/kubernetes/maven:3.6.3-openjdk-8-slim\",\n      \"harbor.dockerregistry.com/kubernetes/kaniko-project/executor:v1.14.0-debug\",\n      \"harbor.dockerregistry.com/kubernetes/argocli-git:v2.7.14\",\n      \"harbor.dockerregistry.com/kubernetes/nodejs:*\"\n    ]\n</code></pre>"},{"location":"docker/Install-Skywalking/","title":"Install Skywalking","text":""},{"location":"docker/Install-Skywalking/#compose-file","title":"Compose file","text":"<pre><code>version: '3.8'\nservices:\n  elasticsearch:\n    image: harbor.dockerregistry.com/app/elasticsearch:7.17.1\n    container_name: elasticsearch4\n    ports:\n      - \"9200:9200\"\n    deploy:\n      resources:\n        limits:\n          cpus: '0.80'\n          memory: 1000M\n    healthcheck:\n      test: [ \"CMD-SHELL\", \"curl --silent --fail localhost:9200/_cluster/health || exit 1\" ]\n      interval: 30s\n      timeout: 10s\n      retries: 3\n      start_period: 10s\n    environment:\n      - discovery.type=single-node\n      - bootstrap.memory_lock=true\n      - \"ES_JAVA_OPTS=-Xms512m -Xmx512m\"\n    ulimits:\n      memlock:\n        soft: -1\n        hard: -1\n    volumes:\n      - /data/es:/usr/share/elasticsearch/data\n    restart: always\n\n  oap:\n    image: harbor.dockerregistry.com/app/skywalking-oap-server:8.9.0 \n    container_name: oap\n    deploy:\n      resources:\n        limits:\n          cpus: '0.80'\n          memory: 2000M\n    depends_on:\n      elasticsearch:\n       condition: service_healthy\n    links:\n      - elasticsearch\n    ports:\n      - \"11800:11800\"\n      - \"12800:12800\"\n    healthcheck:\n      test: [ \"CMD-SHELL\", \"/skywalking/bin/swctl ch\" ]\n      interval: 30s\n      timeout: 10s\n      retries: 3\n      start_period: 10s\n    environment:\n      SW_STORAGE: elasticsearch\n      SW_STORAGE_ES_CLUSTER_NODES: elasticsearch:9200\n      SW_HEALTH_CHECKER: default\n      SW_TELEMETRY: prometheus\n      JAVA_OPTS: \"-Xms2048m -Xmx2048m\"\n    restart: always\n\n  ui:\n    image: harbor.dockerregistry.com/app/skywalking-ui:8.9.0\n    container_name: ui\n    deploy:\n      resources:\n        limits:\n          cpus: '0.90'\n          memory: 2000M\n    depends_on:\n      oap:\n        condition: service_healthy\n    links:\n      - oap\n    ports:\n      - \"8080:8080\"\n    environment:\n      SW_OAP_ADDRESS: http://oap:12800\n    restart: always\n</code></pre>"},{"location":"docker/Install-kkFileview/","title":"Install kkFileview","text":""},{"location":"docker/Install-kkFileview/#compose-file","title":"Compose file","text":"<pre><code>version: '3'\nservices:\n  kkfileview:\n   image: harbor.dockerregistry.com/app/kkfileview:379a272\n   container_name: kkfileview\n   ports:\n     - 8012:8012\n   volumes:\n     - /etc/localtime:/etc/localtime:ro\n     - ./application.properties:/opt/kkFileView-4.1.0-RELEASE/config/application.properties\n   restart: always\n</code></pre>"},{"location":"docker/Install-kkFileview/#applicationproperties","title":"application.properties","text":"<pre><code>server.port = ${KK_SERVER_PORT:8012}\nserver.servlet.context-path= ${KK_CONTEXT_PATH:/}\nserver.servlet.encoding.charset = utf-8\nspring.servlet.multipart.max-file-size=500MB\nspring.servlet.multipart.max-request-size=500MB\nspring.freemarker.template-loader-path = classpath:/web/\nspring.freemarker.cache = false\nspring.freemarker.charset = UTF-8\nspring.freemarker.check-template-location = true\nspring.freemarker.content-type = text/html\nspring.freemarker.expose-request-attributes = true\nspring.freemarker.expose-session-attributes = true\nspring.freemarker.request-context-attribute = request\nspring.freemarker.suffix = .ftl\noffice.plugin.server.ports = 2001,2002\noffice.plugin.task.timeout = 5m\nfile.dir = ${KK_FILE_DIR:default}\noffice.home = ${KK_OFFICE_HOME:default}\ncache.type =  ${KK_CACHE_TYPE:redis}\nspring.redisson.address = ${KK_SPRING_REDISSON_ADDRESS:127.0.0.1:6379}\nspring.redisson.password = ${KK_SPRING_REDISSON_PASSWORD:admin@123}\ncache.clean.enabled = ${KK_CACHE_CLEAN_ENABLED:true}\ncache.clean.cron = ${KK_CACHE_CLEAN_CRON:0 0 3 * * ?}\nbase.url = ${KK_BASE_URL:default}\ntrust.host = ${KK_TRUST_HOST:default}\ncache.enabled = ${KK_CACHE_ENABLED:true}\nsimText = ${KK_SIMTEXT:txt,html,htm,asp,jsp,xml,json,properties,md,gitignore,log,java,py,c,cpp,sql,sh,bat,m,bas,prg,cmd}\nmedia = ${KK_MEDIA:mp3,wav,mp4,flv}\nmedia.convert.disable = ${KK_MEDIA_CONVERT_DISABLE:false}\nconvertMedias = ${KK_CONVERTMEDIAS:avi,mov,wmv,mkv,3gp,rm}\noffice.preview.type = ${KK_OFFICE_PREVIEW_TYPE:image}\noffice.preview.switch.disabled = ${KK_OFFICE_PREVIEW_SWITCH_DISABLED:false}\npdf.download.disable = ${KK_PDF_DOWNLOAD_DISABLE:true}\nftp.username = ${KK_FTP_USERNAME:ftpuser}\nftp.password = ${KK_FTP_PASSWORD:123456}\nftp.control.encoding = ${KK_FTP_CONTROL_ENCODING:UTF-8}\nwatermark.txt = ${WATERMARK_TXT:}\nwatermark.x.space = ${WATERMARK_X_SPACE:10}\nwatermark.y.space = ${WATERMARK_Y_SPACE:10}\nwatermark.font = ${WATERMARK_FONT:\u5fae\u8f6f\u96c5\u9ed1}\nwatermark.fontsize = ${WATERMARK_FONTSIZE:18px}\nwatermark.color = ${WATERMARK_COLOR:black}\nwatermark.alpha = ${WATERMARK_ALPHA:0.2}\nwatermark.width = ${WATERMARK_WIDTH:180}\nwatermark.height = ${WATERMARK_HEIGHT:80}\nwatermark.angle = ${WATERMARK_ANGLE:10}\n</code></pre>"},{"location":"helm/Install-Consul/","title":"Install Consul","text":""},{"location":"helm/Install-Consul/#1","title":"1 \u7248\u672c\u9002\u914d","text":"<p>\u5b98\u65b9\u6587\u6863</p> <p>docker \u7248\u672c\u53ef\u80fd\u4e5f\u9700\u8981\u8003\u8651\uff0c\u6682\u672a\u9047\u5230</p> <p>\u5df2\u6210\u529f\u90e8\u7f72 <code>v1.0.6 \u3001v1.1.1</code>\uff0c\u5176\u4ed6\u53ef\u80fd\u6709\u5751</p> <code>helmRepo</code> <code>chartVersion</code> <code>appVersion</code> <code>kubeVersion</code> <code>hashicorp/consul</code> 1.1.1 1.15.1 &gt;=1.22.0-0 <code>hashicorp/consul</code> 1.1.0 1.15.0 &gt;=1.22.0-0 <code>hashicorp/consul</code> 1.0.6 1.14.5 &gt;=1.21.0-0 <code>hashicorp/consul</code> 1.0.5 1.14.5 &gt;=1.21.0-0 <code>hashicorp/consul</code> 1.0.4 1.14.4 &gt;=1.21.0-0 <code>hashicorp/consul</code> 1.0.3 1.14.4 &gt;=1.21.0-0 <code>hashicorp/consul</code> 1.0.2 1.14.2 &gt;=1.21.0-0 <code>hashicorp/consul</code> 1.0.1 1.14.1 &gt;=1.21.0-0 <code>hashicorp/consul</code> 1.0.0 1.14.0 &gt;=1.21.0-0 <code>hashicorp/consul</code> 0.49.5 1.13.7 &gt;=1.21.0-0 <code>hashicorp/consul</code> 0.49.4 1.13.6 &gt;=1.21.0-0 <code>hashicorp/consul</code> 0.49.3 1.13.6 &gt;=1.21.0-0 <code>hashicorp/consul</code> 0.49.2 1.13.4 &gt;=1.21.0-0 <code>hashicorp/consul</code> 0.49.1 1.13.3 &gt;=1.21.0-0 <code>hashicorp/consul</code> 0.49.0 1.13.2 &gt;=1.21.0-0 <code>hashicorp/consul</code> 0.48.0 1.13.1 &gt;=1.21.0-0 <code>hashicorp/consul</code> 0.47.1 1.13.1 &gt;=1.19.0-0 <code>hashicorp/consul</code> 0.47.0 1.13.1 &gt;=1.19.0-0 <code>hashicorp/consul</code> 0.46.1 1.12.3 &gt;=1.19.0-0 <code>hashicorp/consul</code> 0.46.0 1.12.3 &gt;=1.19.0-0 <code>hashicorp/consul</code> 0.45.0 1.12.2 &gt;=1.19.0-0 <code>hashicorp/consul</code> 0.44.0 1.12.0 &gt;=1.19.0-0 <code>hashicorp/consul</code> 0.43.0 1.12.0 &gt;=1.19.0-0 <code>hashicorp/consul</code> 0.42.0 1.11.4 &gt;=1.19.0-0 <code>hashicorp/consul</code> 0.41.1 1.11.3 &gt;=1.18.0-0 <code>hashicorp/consul</code> 0.41.0 1.11.3 &gt;=1.18.0-0"},{"location":"helm/Install-Consul/#2-helm","title":"2 Helm\u90e8\u7f72","text":"<pre><code># \u6dfb\u52a0helm\u4ed3\u5e93\nhelm repo add hashicorp https://helm.releases.hashicorp.com\nhelm repo update\n\n# \u5728\u7ebf\u90e8\u7f72\nvim config.yaml\n</code></pre> <p><code>imageConsulDataplane</code>  \u5728\u4f4e\u7248\u672c\u4e2d\u53ef\u80fd\u4e0d\u5b58\u5728\uff0c\u9700\u8981\u5c06\u8fd9\u884c\u6ce8\u89e3\u6389\uff0c\u5426\u5219\u53ef\u80fd\u65e0\u6cd5\u90e8\u7f72\u6210\u529f</p> <pre><code>global:\n  name: consul\n  image: \"harbor.dockerregistry.com/gitops/hashicorp/consul:1.14.5\"\n  imageK8S: harbor.dockerregistry.com/gitops/hashicorp/consul-k8s-control-plane:1.0.6\n  gossipEncryption:\n    # Automatically generate a gossip encryption key and save it to a Kubernetes or Vault secret.\n    autoGenerate: true\n  tls:\n    # If true, the Helm chart will enable TLS for Consul\n    # servers and clients and all consul-k8s-control-plane components, as well as generate certificate\n    # authority (optional) and server and client certificates.\n    # This setting is required for [Cluster Peering](https://developer.hashicorp.com/consul/docs/connect/cluster-peering/k8s).\n    enabled: true\n  acls:\n\n    # If true, the Helm chart will automatically manage ACL tokens and policies\n    # for all Consul and consul-k8s-control-plane components.\n    # This requires Consul &gt;= 1.4.\n    manageSystemACLs: true\n  # The name (and tag) of the consul-dataplane Docker image used for the\n  # connect-injected sidecar proxies and mesh, terminating, and ingress gateways.\n  # @default: hashicorp/consul-dataplane:&lt;latest supported version&gt;\n  imageConsulDataplane: \"harbor.dockerregistry.com/gitops/hashicorp/consul-dataplane:1.1.0\"\n\n\nserver:\n  # The number of server agents to run. This determines the fault tolerance of\n  # the cluster. Please refer to the [deployment table](https://developer.hashicorp.com/consul/docs/architecture/consensus#deployment-table)\n  # for more information.\n  replicas: 3\n  # The StorageClass to use for the servers' StatefulSet storage. It must be\n  # able to be dynamically provisioned if you want the storage\n  # to be automatically created. For example, to use\n  # local(https://kubernetes.io/docs/concepts/storage/storage-classes/#local)\n  # storage classes, the PersistentVolumeClaims would need to be manually created.\n  # A `null` value will use the Kubernetes cluster's default StorageClass. If a default\n  # StorageClass does not exist, you will need to create one.\n  # Refer to the [Read/Write Tuning](https://developer.hashicorp.com/consul/docs/install/performance#read-write-tuning)\n  # section of the Server Performance Requirements documentation for considerations\n  # around choosing a performant storage class.\n  #\n  # ~&gt; **Note:** The [Reference Architecture](https://developer.hashicorp.com/consul/tutorials/production-deploy/reference-architecture#hardware-sizing-for-consul-servers)\n  # contains best practices and recommendations for selecting suitable\n  # hardware sizes for your Consul servers.\n  # @type: string\n  storageClass: local\n\n# Values that configure running a Consul client on Kubernetes nodes.\nclient:\n  extraConfig: |\n    {\"advertise_reconnect_timeout\": \"15m\"}\n\n# Values that configure the Consul UI.\nui:\n  # If true, the UI will be enabled. This will\n  # only _enable_ the UI, it doesn't automatically register any service for external\n  # access. The UI will only be enabled on server agents. If `server.enabled` is\n  # false, then this setting has no effect. To expose the UI in some way, you must\n  # configure `ui.service`.\n  # @default: global.enabled\n  # @type: boolean\n  enabled: true\n  # Configure the service for the Consul UI.\n  service:\n    # The service type to register.\n    # @type: string\n    type: LoadBalancer\n\n# Configures the automatic Connect sidecar injector.\nconnectInject:\n  # True if you want to enable connect injection. Set to \"-\" to inherit from\n  # global.enabled.\n  enabled: false\n</code></pre> <pre><code>helm install consul hashicorp/consul --values config.yaml --create-namespace --namespace consul --version \"1.0.6\"\n\n# \u79bb\u7ebf\u90e8\u7f72\nhelm pull hashicorp/consul --version \"1.0.6\"\ntar xf consul-1.0.6.tgz\n\nvim consul/values.yaml ## \u4fee\u6539\u914d\u7f6e\uff0c\u5177\u4f53\u4e5f\u662f\u4fee\u6539\u4e0a\u9762config.yaml \u7684\u5404\u5904\u914d\u7f6e\uff0c\u53e6\u5916\u9700\u8981\u5c06\u955c\u50cf\u5730\u5740\u6539\u4e3a\u672c\u5730\u7684\uff0c\u5982\uff1a\n  image: \"harbor.dockerregistry.com/gitops/hashicorp/consul:1.14.5\"\n  imageK8S: harbor.dockerregistry.com/gitops/hashicorp/consul-k8s-control-plane:1.0.6\n  imageConsulDataplane: \"harbor.dockerregistry.com/gitops/hashicorp/consul-dataplane:1.1.0\"\n\nhelm install consul ./consul --create-namespace --namespace consul\n\n# \u53c2\u8003\u8fd9\u4e2a\u914d\u7f6e\nglobal:\n  name: consul\n  image: \"harbor.dockerregistry.com/gitops/hashicorp/consul:1.13.1\"\n  imageK8S: harbor.dockerregistry.com/gitops/hashicorp/consul-k8s-control-plane:0.47.1\n  gossipEncryption:\n    autoGenerate: true\n  tls:\n    enabled: true\n  acls:\n    manageSystemACLs: true\nserver:\n  replicas: 3\n  storageClass: local\nclient:\n  extraConfig: |\n    {\"advertise_reconnect_timeout\": \"15m\"}\nui:\n  enabled: true\nconnectInject:\n  enabled: false\n\n# \u62f7\u8d1d\u539f\u914d\u7f6e\u540e\u4fee\u6539\ncp consul/values.yaml .\nvim consul/values.yaml\n\n# \u79bb\u7ebf\u90e8\u7f72\nhelm install consul ./consul --values values.yaml  --create-namespace --namespace consul\n\n# \u79bb\u7ebf\u66f4\u65b0\u914d\u7f6e\nhelm upgrade consul ./consul --values values.yaml -n consul\n\n# \uff01\uff01 \u9700\u8981\u6ce8\u610f\uff0c\u524d\u9762consul \u5f00\u542f\u4e86\u5168\u5c40\u5168\u5c40tls \uff0c\u5728\u670d\u52a1\u66b4\u9732\u540e\u9700\u8981\u4f7f\u7528https \u8bbf\u95ee\u624d\u884c\n\n# \u9a8c\u8bc1\nkubectl exec --stdin --tty consul-server-0 --namespace consul -- /bin/sh\n$ consul members\n$ exit\n</code></pre>"},{"location":"helm/Install-Consul/#3","title":"3 \u7269\u7406\u90e8\u7f72","text":"<pre><code>### \u5b89\u88c5\n#  \u4e09\u53f0\u673a\u5668\u5747\u6267\u884c\nyum install -y yum-utils\nyum-config-manager --add-repo https://rpm.releases.hashicorp.com/RHEL/hashicorp.repo\nyum -y install consul\nconsul -v\nmkdir -p /data/consul-data\n\n\n# node1 \u6267\u884c\nnohup consul agent -server -ui  -bootstrap-expect=1 -node=node1 -bind 10.0.1.1 -client=0.0.0.0 -data-dir=/data/consul-data/    &gt; /data/consul-data/consul.log 2&gt;&amp;1 &amp; \ntail -1000f /data/consul-data/consul.log\n\n# node2 \u6267\u884c\nnohup consul agent -node=node2 -bind 10.0.1.1 -client=0.0.0.0 -data-dir=/data/consul-data/ -join=10.0.1.2 &gt; /data/consul-data/consul.log 2&gt;&amp;1 &amp;\ntail -1000f /data/consul-data/consul.log\n\n# node4 \u6267\u884c\nnohup consul agent -node=node4 -bind 10.0.1.1 -client=0.0.0.0 -data-dir=/data/consul-data/ -join=10.0.1.4 &gt; /data/consul-data/consul.log 2&gt;&amp;1 &amp;\ntail -1000f /data/consul-data/consul.log\n\n\n### \u5378\u8f7d\n# node \u8282\u70b9\uff0c\u6740\u6b7b\u8fdb\u7a0b\nps -ef | grep consul\nkill -9 PID\n\n# leader\nconsul force-leave  -prune  node4\nconsul force-leave  -prune  node2\n</code></pre>"},{"location":"helm/Install-Dashboard/","title":"Install Dashboard","text":""},{"location":"helm/Install-Dashboard/#dashboard-adminuseryaml","title":"dashboard-adminuser.yaml","text":"<pre><code>apiVersion: v1\nkind: ServiceAccount\nmetadata:\n  name: admin-user\n  namespace: kubernetes-dashboard\n---\napiVersion: rbac.authorization.k8s.io/v1\nkind: ClusterRoleBinding\nmetadata:\n  name: admin-user\nroleRef:\n  apiGroup: rbac.authorization.k8s.io\n  kind: ClusterRole\n  name: cluster-admin\nsubjects:\n- kind: ServiceAccount\n  name: admin-user\n  namespace: kubernetes-dashboard\n</code></pre>"},{"location":"helm/Install-Dashboard/#recommendedyaml","title":"recommended.yaml","text":"<pre><code># Copyright 2017 The Kubernetes Authors.\n#\n# Licensed under the Apache License, Version 2.0 (the \"License\");\n# you may not use this file except in compliance with the License.\n# You may obtain a copy of the License at\n#\n#     http://www.apache.org/licenses/LICENSE-2.0\n#\n# Unless required by applicable law or agreed to in writing, software\n# distributed under the License is distributed on an \"AS IS\" BASIS,\n# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n# See the License for the specific language governing permissions and\n# limitations under the License.\n\napiVersion: v1\nkind: Namespace\nmetadata:\n  name: kubernetes-dashboard\n\n---\n\napiVersion: v1\nkind: ServiceAccount\nmetadata:\n  labels:\n    k8s-app: kubernetes-dashboard\n  name: kubernetes-dashboard\n  namespace: kubernetes-dashboard\n\n---\n\nkind: Service\napiVersion: v1\nmetadata:\n  labels:\n    k8s-app: kubernetes-dashboard\n  name: kubernetes-dashboard\n  namespace: kubernetes-dashboard\nspec:\n  type: NodePort\n  ports:\n    - port: 443\n      targetPort: 8443\n      nodePort: 31260\n  selector:\n    k8s-app: kubernetes-dashboard\n\n---\n\napiVersion: v1\nkind: Secret\nmetadata:\n  labels:\n    k8s-app: kubernetes-dashboard\n  name: kubernetes-dashboard-certs\n  namespace: kubernetes-dashboard\ntype: Opaque\n\n---\n\napiVersion: v1\nkind: Secret\nmetadata:\n  labels:\n    k8s-app: kubernetes-dashboard\n  name: kubernetes-dashboard-csrf\n  namespace: kubernetes-dashboard\ntype: Opaque\ndata:\n  csrf: \"\"\n\n---\n\napiVersion: v1\nkind: Secret\nmetadata:\n  labels:\n    k8s-app: kubernetes-dashboard\n  name: kubernetes-dashboard-key-holder\n  namespace: kubernetes-dashboard\ntype: Opaque\n\n---\n\nkind: ConfigMap\napiVersion: v1\nmetadata:\n  labels:\n    k8s-app: kubernetes-dashboard\n  name: kubernetes-dashboard-settings\n  namespace: kubernetes-dashboard\n\n---\n\nkind: Role\napiVersion: rbac.authorization.k8s.io/v1\nmetadata:\n  labels:\n    k8s-app: kubernetes-dashboard\n  name: kubernetes-dashboard\n  namespace: kubernetes-dashboard\nrules:\n  # Allow Dashboard to get, update and delete Dashboard exclusive secrets.\n  - apiGroups: [\"\"]\n    resources: [\"secrets\"]\n    resourceNames: [\"kubernetes-dashboard-key-holder\", \"kubernetes-dashboard-certs\", \"kubernetes-dashboard-csrf\"]\n    verbs: [\"get\", \"update\", \"delete\"]\n    # Allow Dashboard to get and update 'kubernetes-dashboard-settings' config map.\n  - apiGroups: [\"\"]\n    resources: [\"configmaps\"]\n    resourceNames: [\"kubernetes-dashboard-settings\"]\n    verbs: [\"get\", \"update\"]\n    # Allow Dashboard to get metrics.\n  - apiGroups: [\"\"]\n    resources: [\"services\"]\n    resourceNames: [\"heapster\", \"dashboard-metrics-scraper\"]\n    verbs: [\"proxy\"]\n  - apiGroups: [\"\"]\n    resources: [\"services/proxy\"]\n    resourceNames: [\"heapster\", \"http:heapster:\", \"https:heapster:\", \"dashboard-metrics-scraper\", \"http:dashboard-metrics-scraper\"]\n    verbs: [\"get\"]\n\n---\n\nkind: ClusterRole\napiVersion: rbac.authorization.k8s.io/v1\nmetadata:\n  labels:\n    k8s-app: kubernetes-dashboard\n  name: kubernetes-dashboard\nrules:\n  # Allow Metrics Scraper to get metrics from the Metrics server\n  - apiGroups: [\"metrics.k8s.io\"]\n    resources: [\"pods\", \"nodes\"]\n    verbs: [\"get\", \"list\", \"watch\"]\n\n---\n\napiVersion: rbac.authorization.k8s.io/v1\nkind: RoleBinding\nmetadata:\n  labels:\n    k8s-app: kubernetes-dashboard\n  name: kubernetes-dashboard\n  namespace: kubernetes-dashboard\nroleRef:\n  apiGroup: rbac.authorization.k8s.io\n  kind: Role\n  name: kubernetes-dashboard\nsubjects:\n  - kind: ServiceAccount\n    name: kubernetes-dashboard\n    namespace: kubernetes-dashboard\n\n---\n\napiVersion: rbac.authorization.k8s.io/v1\nkind: ClusterRoleBinding\nmetadata:\n  name: kubernetes-dashboard\nroleRef:\n  apiGroup: rbac.authorization.k8s.io\n  kind: ClusterRole\n  name: kubernetes-dashboard\nsubjects:\n  - kind: ServiceAccount\n    name: kubernetes-dashboard\n    namespace: kubernetes-dashboard\n\n---\n\nkind: Deployment\napiVersion: apps/v1\nmetadata:\n  labels:\n    k8s-app: kubernetes-dashboard\n  name: kubernetes-dashboard\n  namespace: kubernetes-dashboard\nspec:\n  replicas: 1\n  revisionHistoryLimit: 10\n  selector:\n    matchLabels:\n      k8s-app: kubernetes-dashboard\n  template:\n    metadata:\n      labels:\n        k8s-app: kubernetes-dashboard\n    spec:\n      securityContext:\n        seccompProfile:\n          type: RuntimeDefault\n      containers:\n        - name: kubernetes-dashboard\n          image: harbor.dockerregistry.com/gitops/kubernetesui/dashboard:v2.7.0\n          imagePullPolicy: Always\n          ports:\n            - containerPort: 8443\n              protocol: TCP\n          args:\n            - --auto-generate-certificates\n            - --namespace=kubernetes-dashboard\n            # Uncomment the following line to manually specify Kubernetes API server Host\n            # If not specified, Dashboard will attempt to auto discover the API server and connect\n            # to it. Uncomment only if the default does not work.\n            # - --apiserver-host=http://my-address:port\n          volumeMounts:\n            - name: kubernetes-dashboard-certs\n              mountPath: /certs\n              # Create on-disk volume to store exec logs\n            - mountPath: /tmp\n              name: tmp-volume\n          livenessProbe:\n            httpGet:\n              scheme: HTTPS\n              path: /\n              port: 8443\n            initialDelaySeconds: 30\n            timeoutSeconds: 30\n          securityContext:\n            allowPrivilegeEscalation: false\n            readOnlyRootFilesystem: true\n            runAsUser: 1001\n            runAsGroup: 2001\n      volumes:\n        - name: kubernetes-dashboard-certs\n          secret:\n            secretName: kubernetes-dashboard-certs\n        - name: tmp-volume\n          emptyDir: {}\n      serviceAccountName: kubernetes-dashboard\n      nodeSelector:\n        \"kubernetes.io/os\": linux\n      # Comment the following tolerations if Dashboard must not be deployed on master\n      tolerations:\n        - key: node-role.kubernetes.io/master\n          effect: NoSchedule\n\n---\n\nkind: Service\napiVersion: v1\nmetadata:\n  labels:\n    k8s-app: dashboard-metrics-scraper\n  name: dashboard-metrics-scraper\n  namespace: kubernetes-dashboard\nspec:\n  ports:\n    - port: 8000\n      targetPort: 8000\n  selector:\n    k8s-app: dashboard-metrics-scraper\n\n---\n\nkind: Deployment\napiVersion: apps/v1\nmetadata:\n  labels:\n    k8s-app: dashboard-metrics-scraper\n  name: dashboard-metrics-scraper\n  namespace: kubernetes-dashboard\nspec:\n  replicas: 1\n  revisionHistoryLimit: 10\n  selector:\n    matchLabels:\n      k8s-app: dashboard-metrics-scraper\n  template:\n    metadata:\n      labels:\n        k8s-app: dashboard-metrics-scraper\n    spec:\n      securityContext:\n        seccompProfile:\n          type: RuntimeDefault\n      containers:\n        - name: dashboard-metrics-scraper\n          image: harbor.dockerregistry.com/gitops/kubernetesui/metrics-scraper:v1.0.8\n          ports:\n            - containerPort: 8000\n              protocol: TCP\n          livenessProbe:\n            httpGet:\n              scheme: HTTP\n              path: /\n              port: 8000\n            initialDelaySeconds: 30\n            timeoutSeconds: 30\n          volumeMounts:\n          - mountPath: /tmp\n            name: tmp-volume\n          securityContext:\n            allowPrivilegeEscalation: false\n            readOnlyRootFilesystem: true\n            runAsUser: 1001\n            runAsGroup: 2001\n      serviceAccountName: kubernetes-dashboard\n      nodeSelector:\n        \"kubernetes.io/os\": linux\n      # Comment the following tolerations if Dashboard must not be deployed on master\n      tolerations:\n        - key: node-role.kubernetes.io/master\n          effect: NoSchedule\n      volumes:\n        - name: tmp-volume\n          emptyDir: {}\n</code></pre>"},{"location":"helm/Install-Grafana/","title":"Install Grafana","text":""},{"location":"helm/Install-Grafana/#1-download-helm-chart","title":"1 Download Helm Chart","text":"<pre><code>mkdir -p grafana \ncd grafana\nhelm repo add grafana https://grafana.github.io/helm-charts\nhelm repo update\nhelm search repo grafana/grafana -l\nhelm search repo grafana/grafana --versions\n\n#helm pull grafana/grafana --version 7.2.3 \ntar xf grafana-7.2.3.tgz\ncp -rvf grafana/values.yaml{,.bak}\n</code></pre>"},{"location":"helm/Install-Grafana/#2-create-own-valuesyaml","title":"2 Create Own Values.yaml","text":"<p>\u53c2\u8003\uff1ahttps://github.com/grafana/helm-charts/blob/main/charts/grafana/README.md</p> <pre><code>vim grafana/values.yaml\n\nimage:\n  registry: docker.io\n  repository: grafana/grafana\n  tag: \"10.2.3\"  # 1 \u4fee\u6539\u955c\u50cf\u6807\u7b7e\u4e3a\u56fa\u5b9a\u7248\u672c\n\n\n\ningress:\n  enabled: true  \n  hosts:\n    - grafana.k8scluster.com \n\ningress:\n  enabled: true # 2 \u542f\u7528ingress\n  annotations:  # 2.1 \u6dfb\u52a0\u6ce8\u91ca\n    kubernetes.io/ingress.class: \"nginx\"\n    nginx.ingress.kubernetes.io/rewrite-target: /$1\n    nginx.ingress.kubernetes.io/use-regex: \"true\"\n  labels: {}\n  path: /grafana/?(.*) # 2.2 \u6dfb\u52a0\u8bbf\u95ee\u540e\u7f00\n  pathType: Prefix\n  hosts:\n    - grafana.k8scluster.com # 3 \u4f7f\u7528\u672c\u5730\u57df\u540d\n\npersistence:\n  type: pvc \n  enabled: true # 4 \u542f\u7528pvc\n  storageClassName: default # 5 \u4f7f\u7528sc \u540d\u79f0\n  accessModes:\n    - ReadWriteOnce\n  size: 1Gi  # 6 \u6307\u5b9apvc \u5927\u5c0f\n  # annotations: {}\n\n\nextraVolumeMounts:  # 7 \u6307\u5b9a\u6302\u8f7d\u6620\u5c04\n  - name: grafana-data\n    mountPath: /var/lib/grafana/plugins\n    subPath: plugins\n    readOnly: false\n  - name: grafana-data\n    mountPath: /var/lib/grafana/dashboards\n    subPath: dashboards\n    readOnly: false\n  - name: grafana-data\n    mountPath: /etc/grafana/provisioning\n    subPath: provisioning\n    readOnly: false\n\nextraVolumes:\n  - name: grafana-data\n    persistentVolumeClaim:\n      claimName: grafana-data-pvc   # 8 \u6307\u5b9apvc \u540d\u79f0\n</code></pre>"},{"location":"helm/Install-Grafana/#3-helm-install-grafana","title":"3 Helm Install Grafana","text":"<pre><code># helm install grafana -f grafana/values.yaml ./grafana --namespace grafana --create-namespace\n\nroot@master2:~/grafana# helm install grafana -f grafana/values.yaml ./grafana --namespace grafana --create-namespace\nNAME: grafana\nLAST DEPLOYED: Tue Jan 23 17:00:55 2024\nNAMESPACE: grafana\nSTATUS: deployed\nREVISION: 1\nNOTES:\n1. Get your 'admin' user password by running:\n\n   kubectl get secret --namespace grafana grafana -o jsonpath=\"{.data.admin-password}\" | base64 --decode ; echo\n\n\n2. The Grafana server can be accessed via port 80 on the following DNS name from within your cluster:\n\n   grafana.grafana.svc.cluster.local\n\n   If you bind grafana to 80, please update values in values.yaml and reinstall:\n     securityContext:\n     runAsUser: 0\n     runAsGroup: 0\n     fsGroup: 0\n\n   command:\n\n   - \"setcap\"\n   - \"'cap_net_bind_service=+ep'\"\n   - \"/usr/sbin/grafana-server &amp;&amp;\"\n   - \"sh\"\n   - \"/run.sh\"\nDetails refer to https://grafana.com/docs/installation/configuration/#http-port.\n   Or grafana would always crash.\n\n   From outside the cluster, the server URL(s) are:\n     http://grafana.k8scluster.com\n\n3. Login with the password from step 1 and the username: admin\nroot@master2:~/grafana# kubectl get secret --namespace grafana grafana -o jsonpath=\"{.data.admin-password}\" | base64 --decode ; echo\naL1Br7XMhp0DqTC8bNZ8eqwW15xnyR6YfAoTJyQn\n</code></pre>"},{"location":"helm/Install-Grafana/#4-helm-update-grafana","title":"4 Helm Update Grafana","text":"<pre><code># helm upgrade grafana -f grafana/values.yaml ./grafana --namespace grafana\n\nroot@master2:~/grafana# helm upgrade grafana -f grafana/values.yaml ./grafana --namespace grafana\nW0123 17:10:35.217199 3106878 warnings.go:70] path /grafana/?(.*) cannot be used with pathType Prefix\nRelease \"grafana\" has been upgraded. Happy Helming!\nNAME: grafana\nLAST DEPLOYED: Tue Jan 23 17:10:33 2024\nNAMESPACE: grafana\nSTATUS: deployed\nREVISION: 2\nNOTES:\n1. Get your 'admin' user password by running:\n\n   kubectl get secret --namespace grafana grafana -o jsonpath=\"{.data.admin-password}\" | base64 --decode ; echo\n\n\n2. The Grafana server can be accessed via port 80 on the following DNS name from within your cluster:\n\n   grafana.grafana.svc.cluster.local\n\n   If you bind grafana to 80, please update values in values.yaml and reinstall:\n    securityContext:\n     runAsUser: 0\n     runAsGroup: 0\n     fsGroup: 0\n\n   command:\n\n   - \"setcap\"\n   - \"'cap_net_bind_service=+ep'\"\n   - \"/usr/sbin/grafana-server &amp;&amp;\"\n   - \"sh\"\n   - \"/run.sh\"\n   Details refer to https://grafana.com/docs/installation/configuration/#http-port.\n   Or grafana would always crash.\n\n   From outside the cluster, the server URL(s) are:\n     http://grafana.k8scluster.com\n\n3. Login with the password from step 1 and the username: admin\n</code></pre>"},{"location":"helm/Install-Grafana/#5-login-dashboard","title":"5 Login Dashboard","text":"<pre><code>http://grafana.k8scluster.com:30886/grafana\n</code></pre>"},{"location":"helm/Install-Grafana/#6-export-prometheus-and-alertmanager","title":"6 Export Prometheus And Alertmanager","text":"<p>\u53c2\u8003\uff1ahttps://github.com/prometheus-operator/prometheus-operator/blob/main/Documentation/user-guides/exposing-prometheus-and-alertmanager.md</p> <ol> <li>create <code>ingress</code> </li> </ol> <pre><code>kind: Ingress\napiVersion: networking.k8s.io/v1\nmetadata:\n  name: prometheus-ingress\n  namespace: kubesphere-monitoring-system\n  annotations:\n    nginx.ingress.kubernetes.io/auth-realm: Authentication Required\n    nginx.ingress.kubernetes.io/auth-secret: prometheus-basic-auth\n    nginx.ingress.kubernetes.io/auth-type: basic\n    nginx.ingress.kubernetes.io/proxy-body-size: 2048m\n    nginx.ingress.kubernetes.io/proxy-connect-timeout: '1800'\n    nginx.ingress.kubernetes.io/proxy-read-timeout: '1800'\n    nginx.ingress.kubernetes.io/proxy-send-timeout: '1800'\n    nginx.org/client-max-body-size: 2048m\n    nginx.org/keepalive: 75s\n    nginx.org/proxy-buffering: 'false'\n    nginx.org/proxy-connect-timeout: 1800s\n    nginx.org/proxy-read-timeout: 1800s\n    nginx.org/proxy-send-timeout: 1800s\nspec:\n  ingressClassName: nginx\n  rules:\n    - host: prometheus.k8scluster.com\n      http:\n        paths:\n          - path: /\n            pathType: Prefix\n            backend:\n              service:\n                name: prometheus-k8s\n                port:\n                  name: web\n    - host: alertmanager.k8scluster.com\n      http:\n        paths:\n          - path: /\n            pathType: Prefix\n            backend:\n              service:\n                name: alertmanager-main\n                port:\n                  name: web\n</code></pre> <ol> <li>create <code>http auth</code></li> </ol> <pre><code>htpasswd -c auth admin # \u8f93\u5165\u5bc6\u7801\n</code></pre> <ol> <li>create <code>secret</code></li> </ol> <pre><code>kubectl create secret generic prometheus-basic-auth --from-file=auth -n monitoring\n</code></pre>"},{"location":"helm/Install-Grafana/#7-physical-deployment","title":"7 Physical deployment","text":""},{"location":"helm/Install-Grafana/#71","title":"7.1 \u91cd\u7f6e\u5bc6\u7801","text":"<p>https://erdong.site/Grafana/grafana-admin-password-reset.html https://grafana.com/docs/grafana/latest/cli/#reset-admin-password</p> <pre><code>grafana-cli admin reset-admin-password &lt;new password&gt;\n</code></pre>"},{"location":"helm/Install-Grafana/#72-rpm","title":"7.2 rpm\u5305\u7f16\u8bd1\u6784\u5efa","text":"<p>https://github.com/grafana/grafana/issues/30963</p> <p>https://github.com/goreleaser/nfpm</p> <p>https://goreleaser.com/install</p> <p>https://nfpm.goreleaser.com/install/</p> <pre><code>############################ \u51c6\u5907\u7f16\u8bd1\u73af\u5883\n# 0\u3001\u5b89\u88c5\u5e38\u89c4\u5de5\u5177\nyum -y install git  \n# 1\u3001\u5b89\u88c5go\u73af\u5883\uff0c\u914d\u7f6e\u73af\u5883\u53d8\u91cf\uff0c\u4e0d\u518d\u6f14\u793a\uff0c\u8bf7\u81ea\u884c\u767e\u5ea6\n[root@demo BUILDSCRIPTS_CTREMEL]# cat /etc/profile|grep GO\nexport GOROOT=/usr/local/go\nexport GOPATH=/root/gocode\nexport PATH=$GOPATH/bin:$GOROOT/bin:$PATH\nexport GOPROXY=https://goproxy.io,direct\n# 2\u3001\u5b89\u88c5\u6700\u65b0\u7684nodejs\uff0c\u914d\u7f6e\u73af\u5883\u53d8\u91cf\n# \u5b89\u88c5\u6700\u65b0\u7684nodejs\uff0c\u8fc7\u7a0b\u7565\n# \u5b89\u88c5cnpm,yarn,vue\nnpm root -g\nnpm install express -g\nnpm install -g cnpm --registry=https://registry.npm.taobao.org\nnpm install -g yarn\nnpm config set registry https://registry.npm.taobao.org\nnpm install -g @vue/cli\ncnpm install -g @vue/cli\nyarn -v\ncnpm -v\n# \u914d\u7f6e\u73af\u5883\u53d8\u91cf\n[root@demo BUILDSCRIPTS_CTREMEL]# tail -5 /etc/profile\n#set nodejs npm yarn environment\nexport NODE_HOME=/usr/local/nodejs\nexport PATH=$NODE_HOME/bin:$PATH\n\n#################################### \u5236\u4f5c\u7f16\u8bd1rpm\u5305\u7684\u914d\u7f6e\u6587\u4ef6\n[root@demo ~]# mkdir -p gocode\n[root@demo ~]# cd gocode/\n[root@demo gocode]# ll\ntotal 0\ndrwxr-xr-x 2 root root 58 Aug 17 09:52 bin\ndrwxr-xr-x 4 root root 30 Aug 16 16:38 BUILDSCRIPTS_CTREMEL\ndrwxr-xr-x 4 root root 30 Aug 16 16:57 pkg\ndrwxr-xr-x 5 root root 61 Aug 16 16:37 src\n[root@demo gocode]# mkdir -p BUILDSCRIPTS_CTREMEL/{conf,dist}\n[root@demo gocode]# ll BUILDSCRIPTS_CTREMEL/\ntotal 0\ndrwxr-xr-x 2 root root 31 Aug 17 10:27 conf\ndrwxr-xr-x 2 root root 40 Aug 17 09:59 dist\n[root@demo gocode]# cd BUILDSCRIPTS_CTREMEL/\n[root@demo BUILDSCRIPTS_CTREMEL]# ll\ntotal 0\ndrwxr-xr-x 2 root root 31 Aug 17 10:27 conf\ndrwxr-xr-x 2 root root 40 Aug 17 09:59 dist\n[root@demo BUILDSCRIPTS_CTREMEL]#\n[root@demo BUILDSCRIPTS_CTREMEL]# pwd\n/root/gocode/BUILDSCRIPTS_CTREMEL\n[root@demo BUILDSCRIPTS_CTREMEL]# vim conf/grafana_nfpm.yaml\n[root@demo BUILDSCRIPTS_CTREMEL]# cat conf/grafana_nfpm.yaml\n</code></pre> <pre><code>\u53ef\u80fd\u9700\u8981\u66f4\u6539\u76844\u4e2a\u5730\u65b9\uff1a\n\n1. version: \"${GRAFANA_VERSION}\" \u00a0 \u00a0 // grafana\u7248\u672c\n\n2. arch: \"x86_64\" \u00a0 \u00a0//CPU\u67b6\u6784\n\n3. release: 1 // rpm\u5305\u7684\u53d1\u884c\u7248\u672c\uff0c\u7b2c1\u6b21\u6253rpm\u5305\n\n4. ./bin/linux-amd64 \u00a0 //\u5f53\u524d\u7f16\u8bd1\u6253\u5305\u7684\u7cfb\u7edf\u73af\u5883\u7c7b\u578b\u662flinux-amd64\n</code></pre> <pre><code>name: \"grafana\"\narch: \"x86_64\"\nplatform: \"linux\"\nversion: \"${GRAFANA_VERSION}\"\nsection: \"default\"\npriority: \"extra\"\nrelease: 1\nreplaces:\n- grafana\nprovides:\n- grafana-server\n- grafana-cli\ndepends:\n- coreutils\n- shadow-utils\nmaintainer: \"&lt;contact@grafana.com&gt;\"\ndescription: |\n  Grafana\nvendor: \"Grafana\"\nhomepage: \"https://grafana.com\"\nlicense: \"Apache 2\"\ncontents:\n        - src: ./bin/linux-amd64/grafana-server\n          dst: /usr/sbin/grafana-server\n        - src: ./bin/linux-amd64/grafana-cli\n          dst: /usr/sbin/grafana-cli\n        - src: ./packaging/rpm/init.d/grafana-server\n          dst: /etc/init.d/grafana-server\n        - src: ./packaging/rpm/sysconfig/grafana-server\n          dst: /etc/sysconfig/grafana-server\n          type: config|noreplace\n        - src: ./packaging/rpm/systemd/grafana-server.service\n          dst: /usr/lib/systemd/system/grafana-server.service\n        - src: ./public/\n          dst: /usr/share/grafana/public\n        - src: ./conf/\n          dst: /usr/share/grafana/conf\nempty_folders:\n  - /etc/grafana\nscripts:\n    postinstall: ./packaging/rpm/control/postinst\nrpm:\n    scripts:\n        posttrans: ./packaging/rpm/control/posttrans\n</code></pre> <pre><code>############################################################# \u5f00\u59cb\u7f16\u8bd1\n# 1\u3001\u62c9\u53d6\u5b98\u65b9\u4ee3\u7801\u5e76\u5207\u6362\u81f3v8.0.6\u7684tag\u4ee3\u7801\nmkdir -p ${GOPATH}/src/github.com/grafana\ncd ${GOPATH}/src/github.com/grafana\n# \u8fd9\u91cc\u539f\u672c\u662f\u6211\u672c\u5730gitlab\u4e0agrafana\u7248\u672c\u7684\u4ee3\u7801\u62c9\u53d6\n#rm -rf gd-grafana\n#git clone -b dev git@10.1.1.1:dept-base/product/land-space/source3.1/yq-grafana.git\n#cd yq-grafana\nrm grafana  -rf \ngit clone https://github.com/grafana/grafana.git\ncd grafana\ngit checkout v8.0.6\ngit branch\n# 2\u3001\u5220\u9664\u672c\u5730grafana\u5e76\u79fb\u9664\u914d\u7f6e\u3001\u65e5\u5fd7\u7b49\n# \u8fd9\u4e48\u505a\u662f\u4e3a\u4e86\u65b9\u4fbf\u540e\u9762\u53cd\u590d\u8c03\u8bd5\u7528\uff0c\u9700\u8981\u6e05\u7406\u5e72\u51c0\u73af\u5883\nyum -y remove grafana  &gt;/dev/null 2&gt;&amp;1\nsystemctl stop grafana-server\nsudo /bin/systemctl daemon-reload\nrm -rf /usr/sbin/grafana-server /usr/sbin/grafana-cli /etc/init.d/grafana-server \\\n/usr/share/grafana /etc/grafana /var/lib/grafana /var/log/grafana /etc/sysconfig/grafana-server \\\n/usr/lib/systemd/system/grafana-server.service /usr/share/grafana/public /usr/share/grafana/conf\n# 3\u3001\u8bbe\u7f6ego\u4ee3\u7406\nexport GOPROXY=https://goproxy.io,direct\n# 4\u3001\u5173\u95ed\u5b89\u5168git\ngit config --global http.sslVerify \"false\"\n# 5\u3001\u5b89\u88c5goreleaser\u3001nfpm\u7f16\u8bd1\u5de5\u5177\u5305\ngo install github.com/goreleaser/goreleaser@latest\ngo install github.com/goreleaser/nfpm/v2/cmd/nfpm@latest\n# 6\u3001\u5f00\u59cb\u521d\u59cb\u5316\u3001\u6784\u5efa\u540e\u7aef\u5de5\u7a0b\ngo run build.go setup\ngo run build.go build\n# 7\u3001\u4e0b\u8f7d\u524d\u7aef\u4f9d\u8d56\u3001\u6784\u5efa\u524d\u7aef\nyarn install --pure-lockfile\nyarn build\n# 8\u3001\u8bbe\u7f6eGrafana\u7248\u672c\u53f7\nexport GRAFANA_VERSION=\"v8.0.6\"\n# 9\u3001\u4f7f\u7528\u63d0\u524d\u6539\u597d\u7684rpm\u6253\u5305\u914d\u7f6e\u6587\u4ef6+nfpm\u6253\u5305\u5de5\u5177\u6765\u5236\u4f5crpm\u5305\n${GOPATH}/bin/nfpm pkg --packager rpm --config /root/gocode/BUILDSCRIPTS_CTREMEL/conf/grafana_nfpm.yaml --target /root/gocode/BUILDSCRIPTS_CTREMEL/dist\n# 10\u3001\u5f00\u59cb\u5b89\u88c5Grafana\nyum -y install /root/gocode/BUILDSCRIPTS_CTREMEL/dist/grafana-0.0.0~rc0-1.x86_64.rpm\n# 11\u3001\u8bbe\u7f6e\u5237\u65b0\u7cfb\u7edf\u670d\u52a1\u3001\u5f00\u673a\u81ea\u542f\u3001\u542f\u52a8\nsudo /bin/systemctl daemon-reload\nsudo /bin/systemctl enable grafana-server.service\nsudo /bin/systemctl start grafana-server.service\n</code></pre>"},{"location":"helm/Install-Grafana/#73","title":"7.3 \u6570\u636e\u6301\u4e45\u5316","text":"<pre><code># 0\n# \u627e\u4e00\u53f0\u73b0\u6210\u7684PG\uff0c\u5efa\u5e93\u5efa\u7528\u6237\u8d4b\u6743\ncreate user grafana with password 'grafana';\ncreate database grafana owner=grafana encoding='UTF8';\ngrant all on database grafana to grafana;\n\n# 1\n# rpm/yum/\u811a\u672c \u91cd\u88c5grafana\n\n# 2\n# \u66ff\u6362\u914d\u7f6e\u6587\u4ef6\nmkdir -p grafana_bakup\ncp  -rvf /etc/grafana/grafana.ini grafana_bakup\n# \u4fee\u6539ini\u6587\u4ef6\u4e2d\u7684\u914d\u7f6e\n[database]\ntype = postgres         # \u6570\u636e\u5e93\u7c7b\u578b\nhost = 10.0.1.1:5432  # \u6570\u636e\u5e93\u5730\u5740\u3001\u7aef\u53e3\nname = grafana      # \u6570\u636e\u5e93\u5e93\u540d\nuser = grafana      # \u6570\u636e\u5e93\u7528\u6237\u540d\npassword = grafana  # \u6570\u636e\u5e93\u5bc6\u7801\nssl_mode = disable  # \u6253\u5f00\u6ce8\u91ca\npath = grafana.db   # \u6253\u5f00\u6ce8\u91ca \n\n\nrm /etc/grafana/grafana.ini\ncp  -rvf grafana_bakup/grafana.ini /etc/grafana/grafana.ini\n\n# 3\n# \u4fee\u6539\u6587\u4ef6\u6743\u9650\nchown root.grafana /etc/grafana/grafana.ini\n\n# 4\n# \u91cd\u542f\u670d\u52a1\nsystemctl restart grafana-server.service\n\n# 5 \n# Web \u754c\u9762\u64cd\u4f5c\n# \u91cd\u65b0\u6dfb\u52a0\u6570\u636e\u6e90\n# \u91cd\u65b0\u5bfc\u5165\u6a21\u677f\n# \u8fd9\u6837\u540e\u9762\u66f4\u65b0\u90e8\u7f72\u5c31\u4e0d\u518d\u9700\u8981\u91cd\u65b0\u6dfb\u52a0\u6570\u636e\u6e90\u548c\u5bfc\u5165\u6a21\u677f\u4e86\n</code></pre>"},{"location":"helm/Install-Grafana/#74","title":"7.4 \u67e5\u770b\u7248\u672c","text":"<pre><code>rpm -qa grafana\ngrafana-server -v\n</code></pre>"},{"location":"helm/Install-Grafana/#75","title":"7.5 \u5347\u7ea7\u7248\u672c","text":"<pre><code>#\u5347\u7ea7\nrpm -Uvh grafana-6.4.0-1.x86_64.rpm \n#\u91cd\u542f\u670d\u52a1\nsystemctl  restart grafana-server\n</code></pre>"},{"location":"helm/Install-Grafana/#76-windows","title":"7.6 Windows \u670d\u52a1\u6ce8\u518c","text":"<pre><code>nssm install prometheus C:\\soft\\prometheus-2.49.0-rc.2.windows-amd64\\prometheus.exe\nnssm set prometheus AppDirectory C:\\soft\\prometheus-2.49.0-rc.2.windows-amd64\nnssm set prometheus AppParameters \"--config.file=C:\\soft\\prometheus-2.49.0-rc.2.windows-amd64\\prometheus.yml\"\nnssm set prometheus Start SERVICE_AUTO_START\n\nnssm install grafana C:\\soft\\grafana-v10.2.3\\bin\\grafana-server.exe\nnssm set grafana AppDirectory  C:\\soft\\grafana-v10.2.3\nnssm set grafana Start SERVICE_AUTO_START\n</code></pre>"},{"location":"helm/Install-INGRESS-NGINX/","title":"Install INGRESS NGINX","text":""},{"location":"helm/Install-INGRESS-NGINX/#1-pull-package","title":"1 pull package","text":"<pre><code># https://kubernetes.github.io/ingress-nginx/deploy/\n# https://blog.thecloudside.com/deploying-public-private-nginx-ingress-controllers-with-http-s-loadbalancer-in-gke-dcf894197fb7\n\nroot@master1:~# helm repo add ingress-nginx https://kubernetes.github.io/ingress-nginx\n\"ingress-nginx\" has been added to your repositories\nroot@master1:~# helm repo update\nHang tight while we grab the latest from your chart repositories...\n...Successfully got an update from the \"projectcalico\" chart repository\n...Successfully got an update from the \"gitlab\" chart repository\n...Successfully got an update from the \"ingress-nginx\" chart repository\nUpdate Complete. \u2388Happy Helming!\u2388\n\nroot@master1:~# helm search repo ingress-nginx/ingress-nginx -l\nNAME                            CHART VERSION   APP VERSION     DESCRIPTION                                       \ningress-nginx/ingress-nginx     4.9.0           1.9.5           Ingress controller for Kubernetes using NGINX a...\ningress-nginx/ingress-nginx     4.8.3           1.9.4           Ingress controller for Kubernetes using NGINX a...\ningress-nginx/ingress-nginx     4.8.2           1.9.3           Ingress controller for Kubernetes using NGINX a...\n...\ningress-nginx/ingress-nginx     2.0.1           0.31.1          Ingress controller for Kubernetes using NGINX a...\ningress-nginx/ingress-nginx     2.0.0           0.31.0          An nginx Ingress controller that uses ConfigMap...\nroot@master1:~# \nroot@master1:~# helm pull ingress-nginx/ingress-nginx --version 4.8.3\nroot@master1:~# mkdir -p ingress-nginx \nroot@master1:~# cd ingress-nginx\nroot@master1:~/ingress-nginx# mv ../ingress-nginx-4.8.3.tgz .\nroot@master1:~/ingress-nginx# ll\ntotal 48\n-rw-r--r-- 1 root root 47117 Dec 23 10:00 ingress-nginx-4.8.3.tgz\nroot@master1:~/ingress-nginx# tar xf ingress-nginx-4.8.3.tgz \nroot@master1:~/ingress-nginx# ll \ntotal 52\ndrwxr-xr-x 5 root root  4096 Dec 23 10:02 ingress-nginx\n-rw-r--r-- 1 root root 47117 Dec 23 10:00 ingress-nginx-4.8.3.tgz\nroot@master1:~/ingress-nginx# cp ingress-nginx/values.yaml{,.bak}\n</code></pre>"},{"location":"helm/Install-INGRESS-NGINX/#2-change-valuesyaml","title":"2 change values.yaml","text":"<pre><code>root@master1:~/ingress-nginx# vim ingress-nginx/values.yaml # \u66b4\u9732NodePort\n\n  service:\n    enabled: true\n    #type: LoadBalancer\n    ### type: NodePort\n    ### nodePorts:\n    ###   http: 32080\n    ###   https: 32443\n    ###   tcp:\n    ###     8080: 32808\n    #nodePorts:\n    #  http: \"\"\n    #  https: \"\"\n    #  tcp: {}\n    #  udp: {}\n    type: NodePort  \n    nodePorts:\n      http: \"30886\"  \n      https: \"30887\"  \n      tcp: {}\n      udp: {}\n</code></pre>"},{"location":"helm/Install-INGRESS-NGINX/#3-install-ingress","title":"3 install ingress","text":"<pre><code># helm upgrade --install ingress-nginx ingress-nginx \\\n#   --repo https://kubernetes.github.io/ingress-nginx \\\n#   --namespace ingress-nginx --create-namespace\n\nroot@master1:~/ingress-nginx# helm upgrade --install ingress-nginx ./ingress-nginx   --namespace ingress-nginx --create-namespace\n\nRelease \"ingress-nginx\" does not exist. Installing it now.\nNAME: ingress-nginx\nLAST DEPLOYED: Sat Dec 23 11:00:59 2023\nNAMESPACE: ingress-nginx\nSTATUS: deployed\nREVISION: 1\nTEST SUITE: None\nNOTES:\nThe ingress-nginx controller has been installed.\nGet the application URL by running these commands:\n  export HTTP_NODE_PORT=30886\n  export HTTPS_NODE_PORT=30887\n  export NODE_IP=$(kubectl --namespace ingress-nginx get nodes -o jsonpath=\"{.items[0].status.addresses[1].address}\")\n\n  echo \"Visit http://$NODE_IP:$HTTP_NODE_PORT to access your application via HTTP.\"\n  echo \"Visit https://$NODE_IP:$HTTPS_NODE_PORT to access your application via HTTPS.\"\n\nAn example Ingress that makes use of the controller:\n  apiVersion: networking.k8s.io/v1\n  kind: Ingress\n  metadata:\n    name: example\n    namespace: foo\n  spec:\n    ingressClassName: nginx\n    rules:\n      - host: www.example.com\n        http:\n          paths:\n            - pathType: Prefix\n              backend:\n                service:\n                  name: exampleService\n                  port:\n                    number: 80\n              path: /\n    # This section is only required if TLS is to be enabled for the Ingress\n    tls:\n      - hosts:\n        - www.example.com\n        secretName: example-tls\n\nIf TLS is enabled for the Ingress, a Secret containing the certificate and key must also be provided:\n\n  apiVersion: v1\n  kind: Secret\n  metadata:\n    name: example-tls\n    namespace: foo\n  data:\n    tls.crt: &lt;base64 encoded cert&gt;\n    tls.key: &lt;base64 encoded key&gt;\n  type: kubernetes.io/tls\n</code></pre>"},{"location":"helm/Install-INGRESS-NGINX/#4-test-ingress","title":"4 test ingress","text":"<pre><code>root@master1:~/ingress-nginx# kubectl create deployment demo --image=httpd --port=80\nkubectl expose deployment demo\ndeployment.apps/demo created\nservice/demo exposed\nroot@master1:~/ingress-nginx# kubectl create ingress demo-localhost --class=nginx \\\n  --rule=\"demo.localdev.me/*=demo:80\"\ningress.networking.k8s.io/demo-localhost created\nroot@master1:~/ingress-nginx# kubectl port-forward --namespace=ingress-nginx service/ingress-nginx-controller 8080:80\nForwarding from 127.0.0.1:8080 -&gt; 80\nForwarding from [::1]:8080 -&gt; 80\n\nHandling connection for 8080\nHandling connection for 8080\n\n\nroot@master1:~/ingress-nginx# \nroot@master1:~/ingress-nginx# curl --resolve demo.localdev.me:8080:127.0.0.1 http://demo.localdev.me:8080\n&lt;html&gt;&lt;body&gt;&lt;h1&gt;It works!&lt;/h1&gt;&lt;/body&gt;&lt;/html&gt;\n\n\n\nroot@master1:~/ingress-nginx# kubectl get service ingress-nginx-controller --namespace=ingress-nginx\nNAME                       TYPE       CLUSTER-IP      EXTERNAL-IP   PORT(S)                      AGE\ningress-nginx-controller   NodePort   10.100.61.186   &lt;none&gt;        80:30886/TCP,443:30887/TCP   13m\nroot@master1:~/ingress-nginx# kubectl create ingress demo --class=nginx \\\n  --rule=\"www.demo.io/*=demo:80\"\ningress.networking.k8s.io/demo created\n\n# \u6dfb\u52a0\u672c\u5730hosts \n192.168.1.120 www.demo.io \n\n# \u6d4f\u89c8\u5668\u8bbf\u95ee\nhttp://www.demo.io:30886/\n</code></pre>"},{"location":"helm/Install-KubeSphere/","title":"Install KubeSphere","text":""},{"location":"helm/Install-KubeSphere/#1-install-kubesphere","title":"1 Install kubesphere","text":"<pre><code># https://github.com/kubesphere/kubesphere\n# https://kubesphere.io/zh/docs/v3.4/quick-start/minimal-kubesphere-on-k8s/\n\n# on all k8s nodes.\n# kubectl apply -f https://github.com/kubesphere/ks-installer/releases/download/v3.4.1/kubesphere-installer.yaml\n# kubectl apply -f https://github.com/kubesphere/ks-installer/releases/download/v3.4.1/cluster-configuration.yaml\n\n# add zone\nexport KKZONE=cn\necho \"export KKZONE=cn\" &gt;&gt;/etc/profile\nsource /etc/profile\n\n\n# upload files.\nroot@master1:~# mkdir -p kubesphere  &amp;&amp; cd kubesphere/\nroot@master1:~/kubesphere# ls -lh \ntotal 1.1G\n-rw-r--r-- 1 root root  11K Dec  5 10:40 cluster-configuration.yaml\n-rw-r--r-- 1 root root 1.1G Nov 24 17:44 images-dir.tar.gz\n-rw-r--r-- 1 root root 4.6K Dec  5 10:39 kubesphere-installer.yaml\n\n# unpack images file.\nroot@master1:~/kubesphere# tar xf images-dir.tar.gz \nroot@master1:~/kubesphere# for img in $(ls images-dir/*.tar); do docker load -i $img; done\nunpacking docker.io/prom/alertmanager:v0.23.0 (sha256:323cbba39f5a4df7c750ead201eed8d1f96cfd04606984059eb90b7702a12d42)...\nLoaded image: prom/alertmanager:v0.23.0\nunpacking registry.cn-beijing.aliyuncs.com/kubesphereio/cni:v3.26.1 (sha256:dbdd8749b4d394abf14b528fbc5a41d654953c7e4d08f1a2133e9300affe0e98)...\nLoaded image: registry.cn-beijing.aliyuncs.com/kubesphereio/cni:v3.26.1\nunpacking registry.cn-beijing.aliyuncs.com/kubesphereio/coredns:1.8.6 (sha256:7aba92733295a77c554e143d7a625c5cad620944b5bce174faeb512f9c61c277)...\nLoaded image: registry.cn-beijing.aliyuncs.com/kubesphereio/coredns:1.8.6\nunpacking docker.io/mirrorgooglecontainers/defaultbackend-amd64:1.4 (sha256:df51dfa3712efbbc6c3f05352c5c2be2e8e1a0bfe3eae5b915101a5a1ea67242)...\nLoaded image: mirrorgooglecontainers/defaultbackend-amd64:1.4\n...\n\n\n# on master1.\n# install kubesphere\nroot@master1:~/kubesphere# kubectl create -f kubesphere-installer.yaml\ncustomresourcedefinition.apiextensions.k8s.io/clusterconfigurations.installer.kubesphere.io created\nnamespace/kubesphere-system created\nserviceaccount/ks-installer created\nclusterrole.rbac.authorization.k8s.io/ks-installer created\nclusterrolebinding.rbac.authorization.k8s.io/ks-installer created\ndeployment.apps/ks-installer created\n\nroot@master1:~/kubesphere# kubectl create -f cluster-configuration.yaml\nclusterconfiguration.installer.kubesphere.io/ks-installer created\n\n\n\n# view logs\nkubectl logs -n kubesphere-system $(kubectl get pod -n kubesphere-system -l 'app in (ks-install, ks-installer)' -o jsonpath='{.items[0].metadata.name}') -f  # \u5982\u679c\u67e5\u770b\u4e0d\u5230\u5c31\u770bPOD\n\nkubectl get po -A # \u67e5\u770bpod \u72b6\u6001\n\n\n\n\n# chrome open it .\nConsole: http://192.168.0.2:30880 # ip \u6362\u6210\u81ea\u5df1\u7684\nAccount: admin\nPassword: P@88w0rd\n</code></pre>"},{"location":"helm/Install-KubeSphere/#2-uninstall-kubesphere","title":"2 Uninstall kubesphere","text":"<p>\u9ad8\u5371\u64cd\u4f5c</p> <pre><code># https://kubesphere.io/zh/docs/v3.3/installing-on-kubernetes/uninstall-kubesphere-from-k8s/\n# https://blog.csdn.net/o0haidee0o/article/details/116745171\n# https://github.com/kubesphere/ks-installer/blob/v3.4.1/scripts/kubesphere-delete.sh\nchmod +x kubesphere-delete.sh \n./kubesphere-delete.sh  # \u6267\u884c\u7ed3\u675f\u540e\uff0c\u4f1a\u5361\u5728\u5220\u9664\u547d\u540d\u7a7a\u95f4\u90a3\u91cc\n\n\n# \u901a\u8fc7\u547d\u4ee4\u6e05\u7406\nkubectl get namespace kubesphere-controls-system -o json &gt; kubesphere-controls-system-temp.json\nvim kubesphere-controls-system-temp.json \n...\n  \"spec\": {   \n    \"finalizers\": [xxx] # \u5c06\u8fd9\u91cc\u5168\u90e8\u5220\u9664\uff0c\u5305\u62ec\uff1a\"finalizers\":\n  },   \n...\n\nkubectl replace --raw \"/api/v1/namespaces/kubesphere-controls-system/finalize\" -f ./kubesphere-controls-system-temp.json\n\n\nkubectl get namespace kubesphere-system -o json &gt; kubesphere-system-temp.json\nvim kubesphere-system-temp.json \nvim kubesphere-controls-system-temp.json \n...\n  \"spec\": {   \n    \"finalizers\": [xxx] # \u5c06\u8fd9\u91cc\u5168\u90e8\u5220\u9664\uff0c\u5305\u62ec\uff1a\"finalizers\":\n  },   \n...\n\nkubectl replace --raw \"/api/v1/namespaces/kubesphere-system/finalize\" -f ./kubesphere-system-temp.json\n</code></pre>"},{"location":"helm/Install-Nebula/","title":"Install Nebula","text":""},{"location":"helm/Install-Nebula/#1-operator","title":"1 <code>operator</code> \u90e8\u7f72","text":"<p><code>Github Chart</code> \u4ed3\u5e93\u5730\u5740</p> <p>\u5b98\u65b9\u6587\u6863</p> <pre><code># \u6dfb\u52a0\u4ed3\u5e93\u5e76\u67e5\u627e\nhelm repo add nebula-operator https://vesoft-inc.github.io/nebula-operator/charts\nhelm repo update\nhelm search repo -l nebula-operator\n\n# \u62c9\u53d6chart\u5305\u5230\u672c\u5730\nhelm pull nebula-operator/nebula-operator --version=1.4.2\ntar xf nebula-operator-1.4.2.tgz \n\n# \u5b89\u88c5\n# \u6620\u5c04\u73af\u5883\u4fe1\u606f\nexport NEBULA_CLUSTER_NAME=nebula         # NebulaGraph \u96c6\u7fa4\u7684\u540d\u5b57\u3002\nexport NEBULA_CLUSTER_NAMESPACE=nebula    # NebulaGraph \u96c6\u7fa4\u6240\u5904\u7684\u547d\u540d\u7a7a\u95f4\u7684\u540d\u5b57\u3002\nexport STORAGE_CLASS_NAME=nfs             # NebulaGraph \u96c6\u7fa4\u7684 StorageClass\u3002\n# \u5199\u5165\u7cfb\u7edf\u73af\u5883\u53d8\u91cf\uff0c\u8fc7\u7a0b\u7565\n\n# \u521b\u5efa\u547d\u540d\u7a7a\u95f4\nkubectl create namespace \"${NEBULA_CLUSTER_NAMESPACE}\"\n\n# helm \u90e8\u7f72operator\nhelm install \"${NEBULA_CLUSTER_NAME}\"-\"operator\" ./nebula-operator \\\n    --namespace=\"${NEBULA_CLUSTER_NAMESPACE}\" \\\n    --set nameOverride=\"${NEBULA_CLUSTER_NAME}\" \\\n    --set nebula.storageClassName=\"${STORAGE_CLASS_NAME}\" \\\n    --set nebula.storaged.replicas=3\n\n# helm \u5378\u8f7doperator\nhelm uninstall \"${NEBULA_CLUSTER_NAME}\" --namespace=\"${NEBULA_CLUSTER_NAMESPACE}\"\n\n# \u6e05\u7406crd\nkubectl delete crd nebulaclusters.apps.nebula-graph.io\n</code></pre>"},{"location":"helm/Install-Nebula/#2-nebula","title":"2 <code>nebula</code> \u96c6\u7fa4\u90e8\u7f72","text":"<pre><code># \u6dfb\u52a0\u4ed3\u5e93\u5e76\u67e5\u627e\nhelm repo add nebula-operator https://vesoft-inc.github.io/nebula-operator/charts\nhelm repo update\nhelm search repo -l nebula-cluster\n\n# \u62c9\u53d6chart\u5305\u5230\u672c\u5730\nhelm pull nebula-operator/nebula-cluster --version=1.4.2\ntar xf nebula-cluster-1.4.2.tgz \n\n# helm \u90e8\u7f72\u96c6\u7fa4\nhelm install \"${NEBULA_CLUSTER_NAME}\"-\"cluster\" ./nebula-cluster \\\n    --namespace=\"${NEBULA_CLUSTER_NAMESPACE}\" \\\n    --set nameOverride=${NEBULA_CLUSTER_NAME} \\\n    --set nebula.storageClassName=\"${STORAGE_CLASS_NAME}\"\n\n# helm \u5378\u8f7d\u96c6\u7fa4\nhelm uninstall \"${NEBULA_CLUSTER_NAME}\"-\"cluster\" --namespace=\"${NEBULA_CLUSTER_NAMESPACE}\"\n\n# \u67e5\u770bpod\nkubectl -n \"${NEBULA_CLUSTER_NAMESPACE}\" get pod -l \"app.kubernetes.io/cluster=${NEBULA_CLUSTER_NAME}\"\n\n# \u67e5\u770bsvc\nkubectl get service -n \"${NEBULA_CLUSTER_NAMESPACE}\"\n\n\n# \u4fee\u6539\u914d\u7f6e\nkubectl edit nebulaclusters.apps.nebula-graph.io ${NEBULA_CLUSTER_NAMESPACE} -n \"${NEBULA_CLUSTER_NAMESPACE}\"\n\n# \u6dfb\u52a0enable_authorize\u548cauth_type\uff0cGraph \u670d\u52a1\u5bf9\u5e94\u7684 ConfigMap\uff08nebula-graphd\uff09\u4e2d\u7684\u914d\u7f6e\u5c06\u88ab\u8986\u76d6\n...\n    config: //\u4e3a Graph \u670d\u52a1\u81ea\u5b9a\u4e49\u53c2\u6570\u3002\n      \"enable_authorize\": \"true\"\n      \"auth_type\": \"password\"\n# \u4fee\u6539pv\u81ea\u52a8\u56de\u6536\uff0c\u5b9a\u4e49\u5728\u5220\u9664\u96c6\u7fa4\u540e\u81ea\u52a8\u5220\u9664 PVC \u4ee5\u91ca\u653e\u6570\u636e\n...\nspec:\n  enablePVReclaim: true  //\u8bbe\u7f6e\u5176\u503c\u4e3a true\n# \u6dfb\u52a0enableAutoBalance\u5e76\u8bbe\u7f6e\u5176\u503c\u4e3atrue\uff0c\u6269\u5bb9\u540e\u81ea\u52a8\u5747\u8861 Storage \u6570\u636e\n...\n  schedulerName: default-scheduler\n  storaged:\n    enableAutoBalance: true   //\u5c06\u5176\u503c\u8bbe\u7f6e\u4e3a true \u65f6\u8868\u793a\u6269\u5bb9\u540e\u81ea\u52a8\u5747\u8861 Storage \u6570\u636e\n# \u4fee\u6539\u96c6\u7fa4\u7684\u6eda\u52a8\u66f4\u65b0\u7b56\u7565\n...\n  storaged:\n    enableForceUpdate: false // \u8bbe\u7f6e\u4e3a false \u65f6\uff0c\u8868\u793a\u8fc1\u79fb\u5206\u7247 Leader \u526f\u672c\uff0c\u4ee5\u4fdd\u8bc1\u96c6\u7fa4\u7684\u8bfb\u5199\u53ef\u7528\u6027\uff0c\u9ed8\u8ba4\u503c\u4e3afalse\u3002\n</code></pre>"},{"location":"helm/Install-Nebula/#3-studio","title":"3 <code>Studio</code> \u56fe\u5f62\u754c\u9762\u90e8\u7f72","text":"<p>\u5b98\u65b9\u6587\u6863-Helm\u90e8\u7f72<code>Studio</code></p> <p>\u5b98\u65b9\u6587\u6863</p> <p><code>NebulaGraph Studio\uff08\u7b80\u79f0 Studio\uff09</code>\u662f\u4e00\u6b3e\u53ef\u4ee5\u901a\u8fc7 <code>Web</code> \u8bbf\u95ee\u7684\u5f00\u6e90\u56fe\u6570\u636e\u5e93\u53ef\u89c6\u5316\u5de5\u5177\uff0c\u642d\u914d <code>NebulaGraph</code> \u5185\u6838\u4f7f\u7528\uff0c\u63d0\u4f9b\u6784\u56fe\u3001\u6570\u636e\u5bfc\u5165\u3001\u7f16\u5199 <code>nGQL</code> \u67e5\u8be2\u7b49\u4e00\u7ad9\u5f0f\u670d\u52a1\u3002\u7528\u6237\u53ef\u4ee5\u5728 <code>NebulaGraph GitHub</code> \u4ed3\u5e93\u4e2d\u67e5\u770b\u6700\u65b0\u6e90\u7801\u3002</p> <pre><code># \u5b89\u88c5\nhelm install \"${NEBULA_CLUSTER_NAME}\"-\"studio\" ./nebula-studio \\\n    --namespace=\"${NEBULA_CLUSTER_NAMESPACE}\" \\\n    --set nameOverride=${NEBULA_CLUSTER_NAME} \\\n    --set nebula.storageClassName=\"${STORAGE_CLASS_NAME}\" \\\n    --set service.type=\"NodePort\" \n\n# \u5378\u8f7d\nhelm uninstall \"${NEBULA_CLUSTER_NAME}\"-\"studio\" --namespace=\"${NEBULA_CLUSTER_NAMESPACE}\"\n</code></pre>"},{"location":"helm/Install-Nebula/#4","title":"4 \u5ba2\u6237\u7aef\u8fde\u63a5","text":"<p><code>NebulaGraph Console</code>\uff1a\u539f\u751f <code>CLI</code> \u5ba2\u6237\u7aef <code>Nebula Console</code> \u662f <code>NebulaGraph</code> \u7684\u539f\u751f\u547d\u4ee4\u884c\u5ba2\u6237\u7aef\uff0c\u7528\u4e8e\u8fde\u63a5 <code>NebulaGraph</code> \u96c6\u7fa4\u5e76\u6267\u884c\u67e5\u8be2\uff0c\u540c\u65f6\u652f\u6301\u7ba1\u7406\u53c2\u6570\u3001\u5bfc\u51fa\u547d\u4ee4\u7684\u6267\u884c\u7ed3\u679c\u3001\u5bfc\u5165\u6d4b\u8bd5\u6570\u636e\u96c6\u7b49\u529f\u80fd\u3002</p> <p><code>GitHub \u53d1\u5e03\u9875</code> \u5b98\u65b9\u6587\u6863</p> <pre><code># \u5ba2\u6237\u7aef\u8fde\u63a5\n# \u670d\u52a1\u7aef\u5df2\u542f\u7528\u8eab\u4efd\u8ba4\u8bc1\uff0c\u9ed8\u8ba4root/nebula\n/usr/bin/nebula-console -addr 10.0.1.12 -port 30741 -u root -p nebula\n\nWelcome to Nebula Graph!\n\n(root@nebula) [(none)]&gt;\n</code></pre>"},{"location":"helm/Install-Openelb/","title":"Install Openelb","text":""},{"location":"helm/Install-Openelb/#1-openelb","title":"1 \u90e8\u7f72<code>openelb</code>","text":"<p>\u5b98\u65b9\u6587\u6863</p> <pre><code>wget https://raw.githubusercontent.com/openelb/openelb/master/deploy/openelb.yaml\n# \u4fee\u6539\u955c\u50cf\u4e3a\u672c\u5730\u6216\u56fd\u5185\u7684\uff0c\u5426\u5219\u4f1a\u62a5\u9519\n$ cat openelb.yaml| grep image:\n        image: harbor.dockerregistry.com/gitops/kubesphere/openelb:v0.5.1\n        image: registry.cn-hangzhou.aliyuncs.com/google_containers/kube-webhook-certgen:v1.1.1\n        image: registry.cn-hangzhou.aliyuncs.com/google_containers/kube-webhook-certgen:v1.1.1\n\n$ kubectl apply -f openelb.yaml\n\n# \u82e5\u672c\u5730443\u7aef\u53e3\u5df2\u4f7f\u7528\u5bfc\u81f4\u62a5\u9519\uff0c\u8bf7\u4fee\u6539deployment \u91cc\u7684\u7aef\u53e3443 \u4e3a\u5176\u4ed6\u7684\uff0c\u59827443\n\n# \u82e5DaemonSets \u7684\u955c\u50cf\u62c9\u53d6\u8d85\u65f6\uff0c\u53ef\u4ee5\u6362\u6210\u672c\u5730\u7684\n          image: 'harbor.dockerregistry.com/gitops/kubesphere/kube-keepalived-vip:0.35'\n</code></pre>"},{"location":"helm/Install-Openelb/#2-lay2-eip","title":"2  \u90e8\u7f72<code>lay2-eip</code>","text":"<p>\u5b98\u65b9\u6587\u6863</p> <pre><code>$ vim layer2-eip.yaml\napiVersion: network.kubesphere.io/v1alpha2\nkind: Eip\nmetadata:\n    name: layer2-eip\n    annotations:\n      eip.openelb.kubesphere.io/is-default-eip: \"true\"\nspec:\n    address: 10.1.1.10-10.1.1.20\n    protocol: layer2\n    interface: ens192\n    disable: false\n\nkubectl apply -f layer2-eip.yaml\n\n\n## \u4e3a kube-proxy \u542f\u7528 strictARP\n$ kubectl edit configmap kube-proxy -n kube-system\n## \u4fee\u6539false \u4e3atrue\nipvs:\n  strictARP: true\n$ kubectl rollout restart daemonset kube-proxy -n kube-system\n\n\n## svc elb \u914d\u7f6e\u65f6\u6dfb\u52a0\u6ce8\u91ca\uff1a\n  annotations:\n    lb.kubesphere.io/v1alpha1: openelb\n    protocol.openelb.kubesphere.io/v1alpha1: layer2\n    eip.openelb.kubesphere.io/v1alpha2: layer2-eip\n</code></pre>"},{"location":"helm/Install-Openelb/#3","title":"3 \u90e8\u7f72\u5e94\u7528","text":"<p>\u5b98\u65b9\u6587\u6863</p> <pre><code>$ vi layer2-svc.yaml\nkind: Service\napiVersion: v1\nmetadata:\n  name: layer2-svc\n  annotations:\n    lb.kubesphere.io/v1alpha1: openelb\n    protocol.openelb.kubesphere.io/v1alpha1: layer2\n    eip.openelb.kubesphere.io/v1alpha2: layer2-eip\nspec:\n  selector:\n    app: layer2-openelb\n  type: LoadBalancer\n  ports:\n    - name: http\n      port: 80\n      targetPort: 8080\n  externalTrafficPolicy: Cluster\n\n$ kubectl apply -f layer2-svc.yaml\n\n\n\n\n\n$ vi layer2-openelb-deploy.yaml\napiVersion: apps/v1\nkind: Deployment\nmetadata:\n  name: layer2-openelb\nspec:\n  replicas: 2\n  selector:\n    matchLabels:\n      app: layer2-openelb\n  template:\n    metadata:\n      labels:\n        app: layer2-openelb\n    spec:\n      containers:\n        - image: harbor.dockerregistry.com/gitops/luksa/kubia\n          name: kubia\n          ports:\n            - containerPort: 8080\n\n$ kubectl apply -f layer2-openelb-deploy.yaml\n\n\n\n$ kubectl get svc\n\n$ curl `kubectl get svc | grep layer| awk '{print $4}'`\n</code></pre>"},{"location":"helm/Install-Prometheus/","title":"Install Prometheus","text":""},{"location":"helm/Install-Prometheus/#1-prometheus-online","title":"1 Prometheus-online","text":""},{"location":"helm/Install-Prometheus/#11-prometheus-operator","title":"1.1 Prometheus Operator","text":"<p>Prometheus Operator \u5b98\u65b9\u6587\u6863</p>"},{"location":"helm/Install-Prometheus/#111-k8s","title":"1.1.1 \u51c6\u5907k8s\u73af\u5883","text":"<pre><code>## \u51c6\u5907k8s v1.23.10 \u73af\u5883\n\n## 1. docker\u73af\u5883\u521d\u59cb\u5316\n## \u4e0a\u4f20\u9644\u4ef6init-docker \u76ee\u5f55\u811a\u672c\uff0c\u4fee\u6539\u81ea\u5b9a\u4e49\u5185\u5bb9\u540e\u6267\u884c\n./init-docker\n\n\n\n## 2. kubekey\u5de5\u5177\u5b89\u88c5\nmkdir -p kube\nexport KKZONE=cn\n# curl -sfL https://get-kk.kubesphere.io | sh -\n# https://github.com/kubesphere/kubekey/releases/download/v3.0.7/kubekey-v3.0.7-linux-amd64.tar.gz\n# \u4e0a\u4f20kk\u9644\u4ef6\ntar xf kubekey-v3.0.7-linux-amd64.tar.gz -C /usr/bin/\nchmod +x /usr/bin/kk\nkk version\n\n\n## 3. k8s\u73af\u5883\u51c6\u5907\n# kk create config\necho -e \"export KKZONE=cn\\n\" &gt;&gt;/etc/profile\nsource  /etc/profile\n\nkk create cluster --with-kubernetes v1.25.3 --container-manager containerd\n\nkubectl get pod -A\n\n## 4. \u81ea\u52a8\u8865\u5168\nsudo yum -y install bash-completion\nsource /usr/share/bash-completion/bash_completion\nsource &lt;(kubectl completion bash)\n\n\n## 5 containerd \u914d\u7f6e\u66f4\u65b0\uff0c\u5e76\u91cd\u542f\u670d\u52a1\n$ vim /etc/containerd/config.toml\n...\n    [plugins.\"io.containerd.grpc.v1.cri\".registry]\n      [plugins.\"io.containerd.grpc.v1.cri\".registry.mirrors]\n        [plugins.\"io.containerd.grpc.v1.cri\".registry.mirrors.\"docker.io\"]\n          endpoint = [\"https://registry-1.docker.io\"]\n        [plugins.\"io.containerd.grpc.v1.cri\".registry.mirrors.\"registry.k8s.io\"]   ## \u65b0\u589e\n          endpoint = [\"https://registry.k8s.io\"]  ## \u65b0\u589e\n\n$ systemctl restart containerd\n\n## 6 \u5bfc\u5165\u955c\u50cf\uff0c\u8fd9\u91cc\u6309\u5b9e\u9645\u9700\u8981\u5bfc\u5165\u5373\u53ef\uff0c\u6ce8\u610f\u5bfc\u5165\u5230\u6307\u5b9a\u547d\u540d\u7a7a\u95f4\u4e0b\uff0c\u5426\u5219\u627e\u4e0d\u5230\nctr -n k8s.io i import adap.tar\n</code></pre>"},{"location":"helm/Install-Prometheus/#112-kube-prometheus","title":"1.1.2 \u90e8\u7f72kube-prometheus","text":"<pre><code>## 1. kube-prometheus\u90e8\u7f72\u6587\u4ef6\u51c6\u5907\n# git clone https://github.com/prometheus-operator/kube-prometheus.git\n## \u4e0a\u4f20kube-prometheus\u90e8\u7f72\u6587\u4ef6\n\n## 2. kube-prometheus\u90e8\u7f72\n# Create the namespace and CRDs, and then wait for them to be availble before creating the remaining resources \nmkdir -p monitoring\n## \u4e0a\u4f20\u9644\u4ef6\u5230\u4e0a\u9762\u76ee\u5f55\ncd monitoring/kube-prometheus\nkubectl apply --server-side -f manifests/setup\n# Wait until the \"servicemonitors\" CRD is created. The message \"No resources found\" means success in this context. \nuntil kubectl get servicemonitors --all-namespaces ; do date; sleep 1; echo \"\"; done \nkubectl create -f manifests/\n</code></pre>"},{"location":"helm/Install-Prometheus/#113-kube-prometheus","title":"1.1.3 \u8bbf\u95eekube-prometheus","text":"<pre><code>## https://k8slens.dev/\n## \u501f\u52a9Lens \u5de5\u5177\uff0c\u505a\u670d\u52a1\u7aef\u53e3\u66b4\u9732\u540e\u67e5\u770b\uff0c\u8fc7\u7a0b\u7565\n</code></pre>"},{"location":"helm/Install-Prometheus/#114-kube-prometheus","title":"1.1.4 \u79fb\u9664kube-prometheus","text":"<pre><code>kubectl delete --ignore-not-found=true -f manifests/ -f manifests/setup\n</code></pre>"},{"location":"helm/Install-Prometheus/#12-operator","title":"1.2 \u5b89\u88c5Operator","text":""},{"location":"helm/Install-Prometheus/#121-operator","title":"1.2.1 \u90e8\u7f72Operator","text":"<pre><code># \u4ee5\u5b89\u88c5 CRD \u5e76\u5c06 Operator \u90e8\u7f72\u5230`default`\u547d\u540d\u7a7a\u95f4\u4e2d\n# yum -y install jq\n# LATEST=$(curl -s https://api.github.com/repos/prometheus-operator/prometheus-operator/releases/latest | jq -cr .tag_name) \n# curl -sL https://github.com/prometheus-operator/prometheus-operator/releases/download/${LATEST}/bundle.yaml | kubectl create -f -\n\ncd monitoring/\nmkdir -p operator\n\n# \u4e0a\u9762\u7684\u65b9\u5f0f\u53ef\u80fd\u65e0\u6cd5\u6b63\u5e38\u6267\u884c\uff0c\u9700\u8981\u79bb\u7ebf\u4e0b\u8f7d\u540e\u4e0a\u4f20\u9644\u4ef6\uff1abundle.yaml\n# https://github.com/prometheus-operator/prometheus-operator/releases/download/v0.65.1/bundle.yaml\n\n\ncd monitoring/operator\nkubectl apply --server-side -f bundle.yaml --force-conflicts  ## --server-side  \u89e3\u51b3\u5b98\u65b9\u4ee3\u7801BUG\n\n# \u53ef\u4ee5\u4f7f\u7528\u4ee5\u4e0b\u547d\u4ee4\u68c0\u67e5\u662f\u5426\u5b8c\u6210\nkubectl wait --for=condition=Ready pods -l app.kubernetes.io/name=prometheus-operator -n default\n</code></pre>"},{"location":"helm/Install-Prometheus/#122-demo","title":"1.2.2 \u90e8\u7f72demo","text":"<pre><code># \u521b\u5efa\u5de5\u4f5c\u8d1f\u8f7d\nmkdir -p demo\ncat &gt; deploy.yaml &lt;&lt; EOF\napiVersion: apps/v1\nkind: Deployment\nmetadata:\n  name: example-app\nspec:\n  replicas: 3\n  selector:\n    matchLabels:\n      app: example-app\n  template:\n    metadata:\n      labels:\n        app: example-app\n    spec:\n      containers:\n      - name: example-app\n        image: fabxc/instrumented_app\n        ports:\n        - name: web\n          containerPort: 8080\nEOF\n\n# \u521b\u5efa\u670d\u52a1\ncat &gt; svc.yaml&lt;&lt;EOF\nkind: Service\napiVersion: v1\nmetadata:\n  name: example-app\n  labels:\n    app: example-app\nspec:\n  selector:\n    app: example-app\n  ports:\n  - name: web\n    port: 8080\nEOF\n\n# \u521b\u5efa\u76d1\u63a7\u53d1\u73b0\ncat &gt; demo/service-monitor.yaml &lt;&lt;EOF\napiVersion: monitoring.coreos.com/v1\nkind: ServiceMonitor\nmetadata:\n  name: example-app\n  labels:\n    team: frontend\nspec:\n  selector:\n    matchLabels:\n      app: example-app\n  endpoints:\n  - port: web\nEOF\n\n# \u6267\u884c\u6574\u4e2a\u76ee\u5f55\nkubectl apply -f demo\n</code></pre>"},{"location":"helm/Install-Prometheus/#123","title":"1.2.3 \u90e8\u7f72\u670d\u52a1\u8d26\u6237\u7b49","text":"<pre><code>mkdir -p sa\nvim sa/sa.yaml\nvim sa/cr.yaml\nvim sa/crb.yaml\nvim sa/prome.yaml\n\nkubectl apply -f sa\nkubectl get -n default prometheus prometheus -w\n</code></pre> <pre><code>apiVersion: v1\nkind: ServiceAccount\nmetadata:\n  name: prometheus\n</code></pre> <pre><code>apiVersion: rbac.authorization.k8s.io/v1\nkind: ClusterRole\nmetadata:\n  name: prometheus\nrules:\n- apiGroups: [\"\"]\n  resources:\n  - nodes\n  - nodes/metrics\n  - services\n  - endpoints\n  - pods\n  verbs: [\"get\", \"list\", \"watch\"]\n- apiGroups: [\"\"]\n  resources:\n  - configmaps\n  verbs: [\"get\"]\n- apiGroups:\n  - networking.k8s.io\n  resources:\n  - ingresses\n  verbs: [\"get\", \"list\", \"watch\"]\n- nonResourceURLs: [\"/metrics\"]\n  verbs: [\"get\"]\n</code></pre> <pre><code>apiVersion: rbac.authorization.k8s.io/v1\nkind: ClusterRoleBinding\nmetadata:\n  name: prometheus\nroleRef:\n  apiGroup: rbac.authorization.k8s.io\n  kind: ClusterRole\n  name: prometheus\nsubjects:\n- kind: ServiceAccount\n  name: prometheus\n  namespace: default\n</code></pre> <pre><code>apiVersion: monitoring.coreos.com/v1\nkind: Prometheus\nmetadata:\n  name: prometheus\nspec:\n  serviceAccountName: prometheus\n  serviceMonitorSelector:\n    matchLabels:\n      team: frontend\n  resources:\n    requests:\n      memory: 400Mi\n  enableAdminAPI: false\n</code></pre>"},{"location":"helm/Install-Prometheus/#124-api","title":"1.2.4 \u542f\u7528\u7ba1\u7406 API","text":"<pre><code>apiVersion: monitoring.coreos.com/v1\nkind: Prometheus\nmetadata:\n  name: prometheus\nspec:\n  serviceAccountName: prometheus\n  serviceMonitorSelector:\n    matchLabels:\n      team: frontend\n  resources:\n    requests:\n      memory: 400Mi\n      # \u5c06\u8fd9\u91cc\u7684false \u6539\u4e3atrue\n  enableAdminAPI: true\n</code></pre>"},{"location":"helm/Install-Prometheus/#3-prometheus-offline","title":"3 Prometheus-offline","text":""},{"location":"helm/Install-Prometheus/#21-install-kube-prometheus","title":"2.1 Install Kube-prometheus","text":"<p>\u26a0\ufe0f Warning:!! \u6ce8\u610f\u517c\u5bb9\u6027\uff0c\u5b98\u65b9\u6587\u6863</p> <pre><code># https://prometheus-operator.dev/docs/prologue/quick-start/#deploy-kube-prometheus\nmkdir -p kube-prometheus  # upload files.\ncd kube-prometheus/\n\n# uploaded files.\nroot@master1:~/kube-prometheus# ll \ntotal 4\ndrwxr-xr-x 3 root root 4096 Jan 12 10:09 manifests\n\n\nkubectl get crd | grep 'monitoring.coreos.com' # \u67e5\u8be2crd\uff0c\u786e\u8ba4\u5e76\u65e0\u65e7\u73af\u5883\u518d\u90e8\u7f72\n\n# \u5b89\u88c5crd\n# Create the namespace and CRDs, and then wait for them to be availble before creating the remaining resources\nkubectl create -f manifests/setup\n\n# Wait until the \"servicemonitors\" CRD is created. The message \"No resources found\" means success in this context.\nuntil kubectl get servicemonitors --all-namespaces ; do date; sleep 1; echo \"\"; done  # like : \"No resources found\"\n\n# \u67e5\u770bcrd\nroot@master1:~/kube-prometheus# kubectl get crd | grep 'monitoring.coreos.com'\nalertmanagerconfigs.monitoring.coreos.com             2024-01-12T02:23:09Z\nalertmanagers.monitoring.coreos.com                   2024-01-12T02:23:10Z\npodmonitors.monitoring.coreos.com                     2024-01-12T02:23:10Z\nprobes.monitoring.coreos.com                          2024-01-12T02:23:10Z\nprometheusagents.monitoring.coreos.com                2024-01-12T02:23:11Z\nprometheuses.monitoring.coreos.com                    2024-01-12T02:23:10Z\nprometheusrules.monitoring.coreos.com                 2024-01-12T02:23:11Z\nscrapeconfigs.monitoring.coreos.com                   2024-01-12T02:23:11Z\nservicemonitors.monitoring.coreos.com                 2024-01-12T02:23:11Z\nthanosrulers.monitoring.coreos.com                    2024-01-12T02:23:11Z\n\n# \u90e8\u7f72kube-prometheus\nkubectl create -f manifests/\n\n\n# \u5378\u8f7dkube-prometheus\n#kubectl delete --ignore-not-found=true -f manifests/ -f manifests/setup\n</code></pre> <p>\u5b98\u65b9\u6587\u6863\uff1ahttps://prometheus-operator.dev/docs/operator/storage/</p> <p>\u56e0\u4e3a\u9ed8\u8ba4\u662f<code>kube-prometheus</code> \u4f7f\u7528\u7684\u5b58\u50a8\u662f\u672a\u505a\u6301\u4e45\u5316\u7684\uff0c\u6240\u4ee5\u8fd9\u91cc\u9700\u8981\u8d70\u672c\u5730<code>NFS</code>\u6765\u505a\u6301\u4e45\u5316\u3002</p> <pre><code>root@master1:~/kube-prometheus# kubectl delete --ignore-not-found=true -f manifests/ -f manifests/setup ## \u5378\u8f7d\u6e05\u7406\u73af\u5883\n\nroot@master1:~/kube-prometheus# cp  manifests/prometheus-prometheus.yaml{,.bak}  # \u5907\u4efd\u539f\u914d\u7f6e\nroot@master1:~/kube-prometheus# ll manifests/prometheus-prometheus.yaml*\n-rw-r--r-- 1 root root 1301 Jan 12 10:06 manifests/prometheus-prometheus.yaml\n-rw-r--r-- 1 root root 1301 Jan 15 15:45 manifests/prometheus-prometheus.yaml.bak\nroot@master1:~/kube-prometheus# vim manifests/prometheus-prometheus.yaml # \u672b\u5c3e\u7c98\u8d34\u81ea\u5df1\u7684PVC\u5185\u5bb9\nroot@master1:~/kube-prometheus# tail manifests/prometheus-prometheus.yaml\n  storage:\n    volumeClaimTemplate:\n      spec:\n        storageClassName: default\n        resources:\n          requests:\n            storage: 50Gi\n\n\nkubectl create -f manifests/setup  # \u518d\u6b21\u90e8\u7f72\nuntil kubectl get servicemonitors --all-namespaces ; do date; sleep 1; echo \"\"; done  # it's ready like : \"No resources found\"\nkubectl get crd | grep 'monitoring.coreos.com'\nkubectl create -f manifests/\n\n\n# \u67e5\u770bpvc \nroot@master1:~/kube-prometheus# kubectl get pvc -n monitoring \nNAME                                 STATUS   VOLUME                                     CAPACITY   ACCESS MODES   STORAGECLASS   AGE\nprometheus-k8s-db-prometheus-k8s-0   Bound    pvc-80cb9be7-e70a-4241-8375-efa5bcf6cd0b   50Gi       RWO            default        62s\nprometheus-k8s-db-prometheus-k8s-1   Bound    pvc-5d17e9a8-f7e9-4916-9b6f-4302306656c3   50Gi       RWO            default        61s\n</code></pre> <p>\u26a0\ufe0f Warning:!! \u8bf7\u52a1\u5fc5\u786e\u4fdd\u6240\u6709\u8282\u70b9\u5b89\u88c5<code>NFS \u5ba2\u6237\u7aef</code>, \u5426\u5219PVC \u53ef\u80fd\u65e0\u6cd5\u6b63\u5e38\u521b\u5efa\u6210\u529f\u6216\u8005PV \u65e0\u6cd5\u6b63\u5e38\u6302\u8f7d</p> <pre><code>apt-get install nfs-common -y\n</code></pre>"},{"location":"helm/Install-Prometheus/#22-create-ingress","title":"2.2 Create ingress","text":"<ol> <li>create <code>ingress</code> for prometheus</li> </ol> <pre><code>kind: Ingress\napiVersion: networking.k8s.io/v1\nmetadata:\n  name: prometheus-ingress\n  namespace: monitoring\n  annotations:\n    nginx.ingress.kubernetes.io/rewrite-target: /$2\n    nginx.ingress.kubernetes.io/auth-realm: Authentication Required\n    nginx.ingress.kubernetes.io/auth-secret: prometheus-basic-auth\n    nginx.ingress.kubernetes.io/auth-type: basic\n    nginx.ingress.kubernetes.io/proxy-body-size: 2048m\n    nginx.ingress.kubernetes.io/proxy-connect-timeout: '1800'\n    nginx.ingress.kubernetes.io/proxy-read-timeout: '1800'\n    nginx.ingress.kubernetes.io/proxy-send-timeout: '1800'\n    nginx.org/client-max-body-size: 2048m\n    nginx.org/keepalive: 75s\n    nginx.org/proxy-buffering: 'false'\n    nginx.org/proxy-connect-timeout: 1800s\n    nginx.org/proxy-read-timeout: 1800s\n    nginx.org/proxy-send-timeout: 1800s\nspec:\n  ingressClassName: nginx\n  rules:\n    - host: prometheus.k8scluster.com\n      http:\n        paths:\n          - path: /prometheus(/|$)(.*)\n            pathType: Prefix\n            backend:\n              service:\n                name: prometheus-k8s\n                port:\n                  name: web\n    - host: alertmanager.k8scluster.com\n      http:\n        paths:\n          - path: /alertmanager(/|$)(.*)\n            pathType: Prefix\n            backend:\n              service:\n                name: alertmanager-main\n                port:\n                  name: web\n</code></pre> <ol> <li>create <code>http auth</code></li> </ol> <pre><code>htpasswd -c auth admin # \u8f93\u5165\u5bc6\u7801\n</code></pre> <ol> <li>create <code>secret</code></li> </ol> <pre><code>kubectl create secret generic prometheus-basic-auth --from-file=auth -n monitoring\n</code></pre>"},{"location":"helm/Install-Prometheus/#4-uninstall-kubesphere-prometheus","title":"4 Uninstall kubesphere prometheus","text":"<p>\u53c2\u8003\u5b98\u65b9\u6587\u6863\uff1a https://www.kubesphere.io/zh/docs/v3.4/faq/observability/byop/</p> <pre><code>kubectl -n kubesphere-system exec $(kubectl get pod -n kubesphere-system -l app=ks-installer -o jsonpath='{.items[0].metadata.name}') -- kubectl delete -f /kubesphere/kubesphere/prometheus/alertmanager/ 2&gt;/dev/null\n\nkubectl -n kubesphere-system exec $(kubectl get pod -n kubesphere-system -l app=ks-installer -o jsonpath='{.items[0].metadata.name}') -- kubectl delete -f /kubesphere/kubesphere/prometheus/devops/ 2&gt;/dev/null\n\nkubectl -n kubesphere-system exec $(kubectl get pod -n kubesphere-system -l app=ks-installer -o jsonpath='{.items[0].metadata.name}') -- kubectl delete -f /kubesphere/kubesphere/prometheus/etcd/ 2&gt;/dev/null\n\nkubectl -n kubesphere-system exec $(kubectl get pod -n kubesphere-system -l app=ks-installer -o jsonpath='{.items[0].metadata.name}') -- kubectl delete -f /kubesphere/kubesphere/prometheus/grafana/ 2&gt;/dev/null\n\nkubectl -n kubesphere-system exec $(kubectl get pod -n kubesphere-system -l app=ks-installer -o jsonpath='{.items[0].metadata.name}') -- kubectl delete -f /kubesphere/kubesphere/prometheus/kube-state-metrics/ 2&gt;/dev/null\n\nkubectl -n kubesphere-system exec $(kubectl get pod -n kubesphere-system -l app=ks-installer -o jsonpath='{.items[0].metadata.name}') -- kubectl delete -f /kubesphere/kubesphere/prometheus/node-exporter/ 2&gt;/dev/null\n\nkubectl -n kubesphere-system exec $(kubectl get pod -n kubesphere-system -l app=ks-installer -o jsonpath='{.items[0].metadata.name}') -- kubectl delete -f /kubesphere/kubesphere/prometheus/upgrade/ 2&gt;/dev/null\n\nkubectl -n kubesphere-system exec $(kubectl get pod -n kubesphere-system -l app=ks-installer -o jsonpath='{.items[0].metadata.name}') -- kubectl delete -f /kubesphere/kubesphere/prometheus/prometheus-rules-v1.16\\+.yaml 2&gt;/dev/null\n\nkubectl -n kubesphere-system exec $(kubectl get pod -n kubesphere-system -l app=ks-installer -o jsonpath='{.items[0].metadata.name}') -- kubectl delete -f /kubesphere/kubesphere/prometheus/prometheus-rules.yaml 2&gt;/dev/null\n\nkubectl -n kubesphere-system exec $(kubectl get pod -n kubesphere-system -l app=ks-installer -o jsonpath='{.items[0].metadata.name}') -- kubectl delete -f /kubesphere/kubesphere/prometheus/prometheus 2&gt;/dev/null\n\n# Uncomment this line if you don't have Prometheus managed by Prometheus Operator in other namespaces.\n\nkubectl -n kubesphere-system exec $(kubectl get pod -n kubesphere-system -l app=ks-installer -o jsonpath='{.items[0].metadata.name}') -- kubectl delete -f /kubesphere/kubesphere/prometheus/init/ 2&gt;/dev/null\n</code></pre> <pre><code>kubectl -n kubesphere-monitoring-system delete pvc `kubectl -n kubesphere-monitoring-system get pvc | grep -v VOLUME | awk '{print $1}' |  tr '\\n' ' '`\n</code></pre> <p>\u9ed8\u8ba4\u7684\u547d\u4ee4\u65e0\u6cd5\u6e05\u7406\u5f7b\u5e95\uff0c\u8fd9\u91cc\u662f\u8865\u5145\u547d\u4ee4\uff1a</p> <pre><code>kubectl -n kubesphere-monitoring-system delete deployment notification-manager-deployment notification-manager-operator prometheus-operator  ## \u591a\u6267\u884c\u4e24\u904d\n\n\nkubectl -n kubesphere-monitoring-system delete svc notification-manager-controller-metrics notification-manager-svc notification-manager-webhook prometheus-operator\n\n\nkubectl get all -n kubesphere-monitoring-system\n\n\nkubectl get crd | grep 'monitoring.coreos.com' # \u67e5\u8be2crd\n\n# \u5220\u9664crd\nkubectl delete crd prometheusagents.monitoring.coreos.com\nkubectl delete crd alertmanagerconfigs.monitoring.coreos.com\nkubectl delete crd alertmanagers.monitoring.coreos.com\nkubectl delete crd podmonitors.monitoring.coreos.com\nkubectl delete crd probes.monitoring.coreos.com\nkubectl delete crd prometheuses.monitoring.coreos.com\nkubectl delete crd prometheusrules.monitoring.coreos.com\nkubectl delete crd servicemonitors.monitoring.coreos.com\nkubectl delete crd thanosrulers.monitoring.coreos.com\n#kubectl delete crd scrapeconfigs.monitoring.coreos.com  # \u8fd9\u4e2a\u53ef\u80fd\u5e76\u4e0d\u5b58\u5728\n\n\n# \u5220\u9664clusterrole \u3001 clusterrolebinding\nkubectl delete clusterrolebinding kubesphere-prometheus-operator\nkubectl delete clusterrole kubesphere-prometheus-operator\n</code></pre>"},{"location":"helm/Install-Rabbitmq-Cluster/","title":"Install Rabbitmq Cluster","text":""},{"location":"helm/Install-Rabbitmq-Cluster/#kubectl-command","title":"Kubectl Command","text":"<pre><code>kubectl apply -f rabbitmq-cluster-operator.yml\nkubectl apply -f rabbitmq-cluster.yaml\nkubectl apply -f rabbitmq-cluster-external.yaml\n</code></pre>"},{"location":"helm/Install-Rabbitmq-Cluster/#rabbitmq-cluster-operatoryml","title":"rabbitmq-cluster-operator.yml","text":"<pre><code>apiVersion: v1\nkind: Namespace\nmetadata:\n  labels:\n    app.kubernetes.io/component: rabbitmq-operator\n    app.kubernetes.io/name: rabbitmq-system\n    app.kubernetes.io/part-of: rabbitmq\n  name: rabbitmq-system\n---\napiVersion: apiextensions.k8s.io/v1\nkind: CustomResourceDefinition\nmetadata:\n  annotations:\n    controller-gen.kubebuilder.io/version: v0.11.3\n  labels:\n    app.kubernetes.io/component: rabbitmq-operator\n    app.kubernetes.io/name: rabbitmq-cluster-operator\n    app.kubernetes.io/part-of: rabbitmq\n    servicebinding.io/provisioned-service: \"true\"\n  name: rabbitmqclusters.rabbitmq.com\nspec:\n  group: rabbitmq.com\n  names:\n    categories:\n    - all\n    - rabbitmq\n    kind: RabbitmqCluster\n    listKind: RabbitmqClusterList\n    plural: rabbitmqclusters\n    shortNames:\n    - rmq\n    singular: rabbitmqcluster\n  scope: Namespaced\n  versions:\n  - additionalPrinterColumns:\n    - jsonPath: .status.conditions[?(@.type == 'AllReplicasReady')].status\n      name: AllReplicasReady\n      type: string\n    - jsonPath: .status.conditions[?(@.type == 'ReconcileSuccess')].status\n      name: ReconcileSuccess\n      type: string\n    - jsonPath: .metadata.creationTimestamp\n      name: Age\n      type: date\n    name: v1beta1\n    schema:\n      openAPIV3Schema:\n        description: RabbitmqCluster is the Schema for the RabbitmqCluster API. Each\n          instance of this object corresponds to a single RabbitMQ cluster.\n        properties:\n          apiVersion:\n            description: 'APIVersion defines the versioned schema of this representation\n              of an object. Servers should convert recognized schemas to the latest\n              internal value, and may reject unrecognized values. More info: https://git.k8s.io/community/contributors/devel/sig-architecture/api-conventions.md#resources'\n            type: string\n          kind:\n            description: 'Kind is a string value representing the REST resource this\n              object represents. Servers may infer this from the endpoint the client\n              submits requests to. Cannot be updated. In CamelCase. More info: https://git.k8s.io/community/contributors/devel/sig-architecture/api-conventions.md#types-kinds'\n            type: string\n          metadata:\n            type: object\n          spec:\n            description: Spec is the desired state of the RabbitmqCluster Custom Resource.\n            properties:\n              affinity:\n                description: Affinity scheduling rules to be applied on created Pods.\n                properties:\n                  nodeAffinity:\n                    description: Describes node affinity scheduling rules for the\n                      pod.\n                    properties:\n                      preferredDuringSchedulingIgnoredDuringExecution:\n                        description: The scheduler will prefer to schedule pods to\n                          nodes that satisfy the affinity expressions specified by\n                          this field, but it may choose a node that violates one or\n                          more of the expressions. The node that is most preferred\n                          is the one with the greatest sum of weights, i.e. for each\n                          node that meets all of the scheduling requirements (resource\n                          request, requiredDuringScheduling affinity expressions,\n                          etc.), compute a sum by iterating through the elements of\n                          this field and adding \"weight\" to the sum if the node matches\n                          the corresponding matchExpressions; the node(s) with the\n                          highest sum are the most preferred.\n                        items:\n                          description: An empty preferred scheduling term matches\n                            all objects with implicit weight 0 (i.e. it's a no-op).\n                            A null preferred scheduling term matches no objects (i.e.\n                            is also a no-op).\n                          properties:\n                            preference:\n                              description: A node selector term, associated with the\n                                corresponding weight.\n                              properties:\n                                matchExpressions:\n                                  description: A list of node selector requirements\n                                    by node's labels.\n                                  items:\n                                    description: A node selector requirement is a\n                                      selector that contains values, a key, and an\n                                      operator that relates the key and values.\n                                    properties:\n                                      key:\n                                        description: The label key that the selector\n                                          applies to.\n                                        type: string\n                                      operator:\n                                        description: Represents a key's relationship\n                                          to a set of values. Valid operators are\n                                          In, NotIn, Exists, DoesNotExist. Gt, and\n                                          Lt.\n                                        type: string\n                                      values:\n                                        description: An array of string values. If\n                                          the operator is In or NotIn, the values\n                                          array must be non-empty. If the operator\n                                          is Exists or DoesNotExist, the values array\n                                          must be empty. If the operator is Gt or\n                                          Lt, the values array must have a single\n                                          element, which will be interpreted as an\n                                          integer. This array is replaced during a\n                                          strategic merge patch.\n                                        items:\n                                          type: string\n                                        type: array\n                                    required:\n                                    - key\n                                    - operator\n                                    type: object\n                                  type: array\n                                matchFields:\n                                  description: A list of node selector requirements\n                                    by node's fields.\n                                  items:\n                                    description: A node selector requirement is a\n                                      selector that contains values, a key, and an\n                                      operator that relates the key and values.\n                                    properties:\n                                      key:\n                                        description: The label key that the selector\n                                          applies to.\n                                        type: string\n                                      operator:\n                                        description: Represents a key's relationship\n                                          to a set of values. Valid operators are\n                                          In, NotIn, Exists, DoesNotExist. Gt, and\n                                          Lt.\n                                        type: string\n                                      values:\n                                        description: An array of string values. If\n                                          the operator is In or NotIn, the values\n                                          array must be non-empty. If the operator\n                                          is Exists or DoesNotExist, the values array\n                                          must be empty. If the operator is Gt or\n                                          Lt, the values array must have a single\n                                          element, which will be interpreted as an\n                                          integer. This array is replaced during a\n                                          strategic merge patch.\n                                        items:\n                                          type: string\n                                        type: array\n                                    required:\n                                    - key\n                                    - operator\n                                    type: object\n                                  type: array\n                              type: object\n                              x-kubernetes-map-type: atomic\n                            weight:\n                              description: Weight associated with matching the corresponding\n                                nodeSelectorTerm, in the range 1-100.\n                              format: int32\n                              type: integer\n                          required:\n                          - preference\n                          - weight\n                          type: object\n                        type: array\n                      requiredDuringSchedulingIgnoredDuringExecution:\n                        description: If the affinity requirements specified by this\n                          field are not met at scheduling time, the pod will not be\n                          scheduled onto the node. If the affinity requirements specified\n                          by this field cease to be met at some point during pod execution\n                          (e.g. due to an update), the system may or may not try to\n                          eventually evict the pod from its node.\n                        properties:\n                          nodeSelectorTerms:\n                            description: Required. A list of node selector terms.\n                              The terms are ORed.\n                            items:\n                              description: A null or empty node selector term matches\n                                no objects. The requirements of them are ANDed. The\n                                TopologySelectorTerm type implements a subset of the\n                                NodeSelectorTerm.\n                              properties:\n                                matchExpressions:\n                                  description: A list of node selector requirements\n                                    by node's labels.\n                                  items:\n                                    description: A node selector requirement is a\n                                      selector that contains values, a key, and an\n                                      operator that relates the key and values.\n                                    properties:\n                                      key:\n                                        description: The label key that the selector\n                                          applies to.\n                                        type: string\n                                      operator:\n                                        description: Represents a key's relationship\n                                          to a set of values. Valid operators are\n                                          In, NotIn, Exists, DoesNotExist. Gt, and\n                                          Lt.\n                                        type: string\n                                      values:\n                                        description: An array of string values. If\n                                          the operator is In or NotIn, the values\n                                          array must be non-empty. If the operator\n                                          is Exists or DoesNotExist, the values array\n                                          must be empty. If the operator is Gt or\n                                          Lt, the values array must have a single\n                                          element, which will be interpreted as an\n                                          integer. This array is replaced during a\n                                          strategic merge patch.\n                                        items:\n                                          type: string\n                                        type: array\n                                    required:\n                                    - key\n                                    - operator\n                                    type: object\n                                  type: array\n                                matchFields:\n                                  description: A list of node selector requirements\n                                    by node's fields.\n                                  items:\n                                    description: A node selector requirement is a\n                                      selector that contains values, a key, and an\n                                      operator that relates the key and values.\n                                    properties:\n                                      key:\n                                        description: The label key that the selector\n                                          applies to.\n                                        type: string\n                                      operator:\n                                        description: Represents a key's relationship\n                                          to a set of values. Valid operators are\n                                          In, NotIn, Exists, DoesNotExist. Gt, and\n                                          Lt.\n                                        type: string\n                                      values:\n                                        description: An array of string values. If\n                                          the operator is In or NotIn, the values\n                                          array must be non-empty. If the operator\n                                          is Exists or DoesNotExist, the values array\n                                          must be empty. If the operator is Gt or\n                                          Lt, the values array must have a single\n                                          element, which will be interpreted as an\n                                          integer. This array is replaced during a\n                                          strategic merge patch.\n                                        items:\n                                          type: string\n                                        type: array\n                                    required:\n                                    - key\n                                    - operator\n                                    type: object\n                                  type: array\n                              type: object\n                              x-kubernetes-map-type: atomic\n                            type: array\n                        required:\n                        - nodeSelectorTerms\n                        type: object\n                        x-kubernetes-map-type: atomic\n                    type: object\n                  podAffinity:\n                    description: Describes pod affinity scheduling rules (e.g. co-locate\n                      this pod in the same node, zone, etc. as some other pod(s)).\n                    properties:\n                      preferredDuringSchedulingIgnoredDuringExecution:\n                        description: The scheduler will prefer to schedule pods to\n                          nodes that satisfy the affinity expressions specified by\n                          this field, but it may choose a node that violates one or\n                          more of the expressions. The node that is most preferred\n                          is the one with the greatest sum of weights, i.e. for each\n                          node that meets all of the scheduling requirements (resource\n                          request, requiredDuringScheduling affinity expressions,\n                          etc.), compute a sum by iterating through the elements of\n                          this field and adding \"weight\" to the sum if the node has\n                          pods which matches the corresponding podAffinityTerm; the\n                          node(s) with the highest sum are the most preferred.\n                        items:\n                          description: The weights of all of the matched WeightedPodAffinityTerm\n                            fields are added per-node to find the most preferred node(s)\n                          properties:\n                            podAffinityTerm:\n                              description: Required. A pod affinity term, associated\n                                with the corresponding weight.\n                              properties:\n                                labelSelector:\n                                  description: A label query over a set of resources,\n                                    in this case pods.\n                                  properties:\n                                    matchExpressions:\n                                      description: matchExpressions is a list of label\n                                        selector requirements. The requirements are\n                                        ANDed.\n                                      items:\n                                        description: A label selector requirement\n                                          is a selector that contains values, a key,\n                                          and an operator that relates the key and\n                                          values.\n                                        properties:\n                                          key:\n                                            description: key is the label key that\n                                              the selector applies to.\n                                            type: string\n                                          operator:\n                                            description: operator represents a key's\n                                              relationship to a set of values. Valid\n                                              operators are In, NotIn, Exists and\n                                              DoesNotExist.\n                                            type: string\n                                          values:\n                                            description: values is an array of string\n                                              values. If the operator is In or NotIn,\n                                              the values array must be non-empty.\n                                              If the operator is Exists or DoesNotExist,\n                                              the values array must be empty. This\n                                              array is replaced during a strategic\n                                              merge patch.\n                                            items:\n                                              type: string\n                                            type: array\n                                        required:\n                                        - key\n                                        - operator\n                                        type: object\n                                      type: array\n                                    matchLabels:\n                                      additionalProperties:\n                                        type: string\n                                      description: matchLabels is a map of {key,value}\n                                        pairs. A single {key,value} in the matchLabels\n                                        map is equivalent to an element of matchExpressions,\n                                        whose key field is \"key\", the operator is\n                                        \"In\", and the values array contains only \"value\".\n                                        The requirements are ANDed.\n                                      type: object\n                                  type: object\n                                  x-kubernetes-map-type: atomic\n                                namespaceSelector:\n                                  description: A label query over the set of namespaces\n                                    that the term applies to. The term is applied\n                                    to the union of the namespaces selected by this\n                                    field and the ones listed in the namespaces field.\n                                    null selector and null or empty namespaces list\n                                    means \"this pod's namespace\". An empty selector\n                                    ({}) matches all namespaces.\n                                  properties:\n                                    matchExpressions:\n                                      description: matchExpressions is a list of label\n                                        selector requirements. The requirements are\n                                        ANDed.\n                                      items:\n                                        description: A label selector requirement\n                                          is a selector that contains values, a key,\n                                          and an operator that relates the key and\n                                          values.\n                                        properties:\n                                          key:\n                                            description: key is the label key that\n                                              the selector applies to.\n                                            type: string\n                                          operator:\n                                            description: operator represents a key's\n                                              relationship to a set of values. Valid\n                                              operators are In, NotIn, Exists and\n                                              DoesNotExist.\n                                            type: string\n                                          values:\n                                            description: values is an array of string\n                                              values. If the operator is In or NotIn,\n                                              the values array must be non-empty.\n                                              If the operator is Exists or DoesNotExist,\n                                              the values array must be empty. This\n                                              array is replaced during a strategic\n                                              merge patch.\n                                            items:\n                                              type: string\n                                            type: array\n                                        required:\n                                        - key\n                                        - operator\n                                        type: object\n                                      type: array\n                                    matchLabels:\n                                      additionalProperties:\n                                        type: string\n                                      description: matchLabels is a map of {key,value}\n                                        pairs. A single {key,value} in the matchLabels\n                                        map is equivalent to an element of matchExpressions,\n                                        whose key field is \"key\", the operator is\n                                        \"In\", and the values array contains only \"value\".\n                                        The requirements are ANDed.\n                                      type: object\n                                  type: object\n                                  x-kubernetes-map-type: atomic\n                                namespaces:\n                                  description: namespaces specifies a static list\n                                    of namespace names that the term applies to. The\n                                    term is applied to the union of the namespaces\n                                    listed in this field and the ones selected by\n                                    namespaceSelector. null or empty namespaces list\n                                    and null namespaceSelector means \"this pod's namespace\".\n                                  items:\n                                    type: string\n                                  type: array\n                                topologyKey:\n                                  description: This pod should be co-located (affinity)\n                                    or not co-located (anti-affinity) with the pods\n                                    matching the labelSelector in the specified namespaces,\n                                    where co-located is defined as running on a node\n                                    whose value of the label with key topologyKey\n                                    matches that of any node on which any of the selected\n                                    pods is running. Empty topologyKey is not allowed.\n                                  type: string\n                              required:\n                              - topologyKey\n                              type: object\n                            weight:\n                              description: weight associated with matching the corresponding\n                                podAffinityTerm, in the range 1-100.\n                              format: int32\n                              type: integer\n                          required:\n                          - podAffinityTerm\n                          - weight\n                          type: object\n                        type: array\n                      requiredDuringSchedulingIgnoredDuringExecution:\n                        description: If the affinity requirements specified by this\n                          field are not met at scheduling time, the pod will not be\n                          scheduled onto the node. If the affinity requirements specified\n                          by this field cease to be met at some point during pod execution\n                          (e.g. due to a pod label update), the system may or may\n                          not try to eventually evict the pod from its node. When\n                          there are multiple elements, the lists of nodes corresponding\n                          to each podAffinityTerm are intersected, i.e. all terms\n                          must be satisfied.\n                        items:\n                          description: Defines a set of pods (namely those matching\n                            the labelSelector relative to the given namespace(s))\n                            that this pod should be co-located (affinity) or not co-located\n                            (anti-affinity) with, where co-located is defined as running\n                            on a node whose value of the label with key &lt;topologyKey&gt;\n                            matches that of any node on which a pod of the set of\n                            pods is running\n                          properties:\n                            labelSelector:\n                              description: A label query over a set of resources,\n                                in this case pods.\n                              properties:\n                                matchExpressions:\n                                  description: matchExpressions is a list of label\n                                    selector requirements. The requirements are ANDed.\n                                  items:\n                                    description: A label selector requirement is a\n                                      selector that contains values, a key, and an\n                                      operator that relates the key and values.\n                                    properties:\n                                      key:\n                                        description: key is the label key that the\n                                          selector applies to.\n                                        type: string\n                                      operator:\n                                        description: operator represents a key's relationship\n                                          to a set of values. Valid operators are\n                                          In, NotIn, Exists and DoesNotExist.\n                                        type: string\n                                      values:\n                                        description: values is an array of string\n                                          values. If the operator is In or NotIn,\n                                          the values array must be non-empty. If the\n                                          operator is Exists or DoesNotExist, the\n                                          values array must be empty. This array is\n                                          replaced during a strategic merge patch.\n                                        items:\n                                          type: string\n                                        type: array\n                                    required:\n                                    - key\n                                    - operator\n                                    type: object\n                                  type: array\n                                matchLabels:\n                                  additionalProperties:\n                                    type: string\n                                  description: matchLabels is a map of {key,value}\n                                    pairs. A single {key,value} in the matchLabels\n                                    map is equivalent to an element of matchExpressions,\n                                    whose key field is \"key\", the operator is \"In\",\n                                    and the values array contains only \"value\". The\n                                    requirements are ANDed.\n                                  type: object\n                              type: object\n                              x-kubernetes-map-type: atomic\n                            namespaceSelector:\n                              description: A label query over the set of namespaces\n                                that the term applies to. The term is applied to the\n                                union of the namespaces selected by this field and\n                                the ones listed in the namespaces field. null selector\n                                and null or empty namespaces list means \"this pod's\n                                namespace\". An empty selector ({}) matches all namespaces.\n                              properties:\n                                matchExpressions:\n                                  description: matchExpressions is a list of label\n                                    selector requirements. The requirements are ANDed.\n                                  items:\n                                    description: A label selector requirement is a\n                                      selector that contains values, a key, and an\n                                      operator that relates the key and values.\n                                    properties:\n                                      key:\n                                        description: key is the label key that the\n                                          selector applies to.\n                                        type: string\n                                      operator:\n                                        description: operator represents a key's relationship\n                                          to a set of values. Valid operators are\n                                          In, NotIn, Exists and DoesNotExist.\n                                        type: string\n                                      values:\n                                        description: values is an array of string\n                                          values. If the operator is In or NotIn,\n                                          the values array must be non-empty. If the\n                                          operator is Exists or DoesNotExist, the\n                                          values array must be empty. This array is\n                                          replaced during a strategic merge patch.\n                                        items:\n                                          type: string\n                                        type: array\n                                    required:\n                                    - key\n                                    - operator\n                                    type: object\n                                  type: array\n                                matchLabels:\n                                  additionalProperties:\n                                    type: string\n                                  description: matchLabels is a map of {key,value}\n                                    pairs. A single {key,value} in the matchLabels\n                                    map is equivalent to an element of matchExpressions,\n                                    whose key field is \"key\", the operator is \"In\",\n                                    and the values array contains only \"value\". The\n                                    requirements are ANDed.\n                                  type: object\n                              type: object\n                              x-kubernetes-map-type: atomic\n                            namespaces:\n                              description: namespaces specifies a static list of namespace\n                                names that the term applies to. The term is applied\n                                to the union of the namespaces listed in this field\n                                and the ones selected by namespaceSelector. null or\n                                empty namespaces list and null namespaceSelector means\n                                \"this pod's namespace\".\n                              items:\n                                type: string\n                              type: array\n                            topologyKey:\n                              description: This pod should be co-located (affinity)\n                                or not co-located (anti-affinity) with the pods matching\n                                the labelSelector in the specified namespaces, where\n                                co-located is defined as running on a node whose value\n                                of the label with key topologyKey matches that of\n                                any node on which any of the selected pods is running.\n                                Empty topologyKey is not allowed.\n                              type: string\n                          required:\n                          - topologyKey\n                          type: object\n                        type: array\n                    type: object\n                  podAntiAffinity:\n                    description: Describes pod anti-affinity scheduling rules (e.g.\n                      avoid putting this pod in the same node, zone, etc. as some\n                      other pod(s)).\n                    properties:\n                      preferredDuringSchedulingIgnoredDuringExecution:\n                        description: The scheduler will prefer to schedule pods to\n                          nodes that satisfy the anti-affinity expressions specified\n                          by this field, but it may choose a node that violates one\n                          or more of the expressions. The node that is most preferred\n                          is the one with the greatest sum of weights, i.e. for each\n                          node that meets all of the scheduling requirements (resource\n                          request, requiredDuringScheduling anti-affinity expressions,\n                          etc.), compute a sum by iterating through the elements of\n                          this field and adding \"weight\" to the sum if the node has\n                          pods which matches the corresponding podAffinityTerm; the\n                          node(s) with the highest sum are the most preferred.\n                        items:\n                          description: The weights of all of the matched WeightedPodAffinityTerm\n                            fields are added per-node to find the most preferred node(s)\n                          properties:\n                            podAffinityTerm:\n                              description: Required. A pod affinity term, associated\n                                with the corresponding weight.\n                              properties:\n                                labelSelector:\n                                  description: A label query over a set of resources,\n                                    in this case pods.\n                                  properties:\n                                    matchExpressions:\n                                      description: matchExpressions is a list of label\n                                        selector requirements. The requirements are\n                                        ANDed.\n                                      items:\n                                        description: A label selector requirement\n                                          is a selector that contains values, a key,\n                                          and an operator that relates the key and\n                                          values.\n                                        properties:\n                                          key:\n                                            description: key is the label key that\n                                              the selector applies to.\n                                            type: string\n                                          operator:\n                                            description: operator represents a key's\n                                              relationship to a set of values. Valid\n                                              operators are In, NotIn, Exists and\n                                              DoesNotExist.\n                                            type: string\n                                          values:\n                                            description: values is an array of string\n                                              values. If the operator is In or NotIn,\n                                              the values array must be non-empty.\n                                              If the operator is Exists or DoesNotExist,\n                                              the values array must be empty. This\n                                              array is replaced during a strategic\n                                              merge patch.\n                                            items:\n                                              type: string\n                                            type: array\n                                        required:\n                                        - key\n                                        - operator\n                                        type: object\n                                      type: array\n                                    matchLabels:\n                                      additionalProperties:\n                                        type: string\n                                      description: matchLabels is a map of {key,value}\n                                        pairs. A single {key,value} in the matchLabels\n                                        map is equivalent to an element of matchExpressions,\n                                        whose key field is \"key\", the operator is\n                                        \"In\", and the values array contains only \"value\".\n                                        The requirements are ANDed.\n                                      type: object\n                                  type: object\n                                  x-kubernetes-map-type: atomic\n                                namespaceSelector:\n                                  description: A label query over the set of namespaces\n                                    that the term applies to. The term is applied\n                                    to the union of the namespaces selected by this\n                                    field and the ones listed in the namespaces field.\n                                    null selector and null or empty namespaces list\n                                    means \"this pod's namespace\". An empty selector\n                                    ({}) matches all namespaces.\n                                  properties:\n                                    matchExpressions:\n                                      description: matchExpressions is a list of label\n                                        selector requirements. The requirements are\n                                        ANDed.\n                                      items:\n                                        description: A label selector requirement\n                                          is a selector that contains values, a key,\n                                          and an operator that relates the key and\n                                          values.\n                                        properties:\n                                          key:\n                                            description: key is the label key that\n                                              the selector applies to.\n                                            type: string\n                                          operator:\n                                            description: operator represents a key's\n                                              relationship to a set of values. Valid\n                                              operators are In, NotIn, Exists and\n                                              DoesNotExist.\n                                            type: string\n                                          values:\n                                            description: values is an array of string\n                                              values. If the operator is In or NotIn,\n                                              the values array must be non-empty.\n                                              If the operator is Exists or DoesNotExist,\n                                              the values array must be empty. This\n                                              array is replaced during a strategic\n                                              merge patch.\n                                            items:\n                                              type: string\n                                            type: array\n                                        required:\n                                        - key\n                                        - operator\n                                        type: object\n                                      type: array\n                                    matchLabels:\n                                      additionalProperties:\n                                        type: string\n                                      description: matchLabels is a map of {key,value}\n                                        pairs. A single {key,value} in the matchLabels\n                                        map is equivalent to an element of matchExpressions,\n                                        whose key field is \"key\", the operator is\n                                        \"In\", and the values array contains only \"value\".\n                                        The requirements are ANDed.\n                                      type: object\n                                  type: object\n                                  x-kubernetes-map-type: atomic\n                                namespaces:\n                                  description: namespaces specifies a static list\n                                    of namespace names that the term applies to. The\n                                    term is applied to the union of the namespaces\n                                    listed in this field and the ones selected by\n                                    namespaceSelector. null or empty namespaces list\n                                    and null namespaceSelector means \"this pod's namespace\".\n                                  items:\n                                    type: string\n                                  type: array\n                                topologyKey:\n                                  description: This pod should be co-located (affinity)\n                                    or not co-located (anti-affinity) with the pods\n                                    matching the labelSelector in the specified namespaces,\n                                    where co-located is defined as running on a node\n                                    whose value of the label with key topologyKey\n                                    matches that of any node on which any of the selected\n                                    pods is running. Empty topologyKey is not allowed.\n                                  type: string\n                              required:\n                              - topologyKey\n                              type: object\n                            weight:\n                              description: weight associated with matching the corresponding\n                                podAffinityTerm, in the range 1-100.\n                              format: int32\n                              type: integer\n                          required:\n                          - podAffinityTerm\n                          - weight\n                          type: object\n                        type: array\n                      requiredDuringSchedulingIgnoredDuringExecution:\n                        description: If the anti-affinity requirements specified by\n                          this field are not met at scheduling time, the pod will\n                          not be scheduled onto the node. If the anti-affinity requirements\n                          specified by this field cease to be met at some point during\n                          pod execution (e.g. due to a pod label update), the system\n                          may or may not try to eventually evict the pod from its\n                          node. When there are multiple elements, the lists of nodes\n                          corresponding to each podAffinityTerm are intersected, i.e.\n                          all terms must be satisfied.\n                        items:\n                          description: Defines a set of pods (namely those matching\n                            the labelSelector relative to the given namespace(s))\n                            that this pod should be co-located (affinity) or not co-located\n                            (anti-affinity) with, where co-located is defined as running\n                            on a node whose value of the label with key &lt;topologyKey&gt;\n                            matches that of any node on which a pod of the set of\n                            pods is running\n                          properties:\n                            labelSelector:\n                              description: A label query over a set of resources,\n                                in this case pods.\n                              properties:\n                                matchExpressions:\n                                  description: matchExpressions is a list of label\n                                    selector requirements. The requirements are ANDed.\n                                  items:\n                                    description: A label selector requirement is a\n                                      selector that contains values, a key, and an\n                                      operator that relates the key and values.\n                                    properties:\n                                      key:\n                                        description: key is the label key that the\n                                          selector applies to.\n                                        type: string\n                                      operator:\n                                        description: operator represents a key's relationship\n                                          to a set of values. Valid operators are\n                                          In, NotIn, Exists and DoesNotExist.\n                                        type: string\n                                      values:\n                                        description: values is an array of string\n                                          values. If the operator is In or NotIn,\n                                          the values array must be non-empty. If the\n                                          operator is Exists or DoesNotExist, the\n                                          values array must be empty. This array is\n                                          replaced during a strategic merge patch.\n                                        items:\n                                          type: string\n                                        type: array\n                                    required:\n                                    - key\n                                    - operator\n                                    type: object\n                                  type: array\n                                matchLabels:\n                                  additionalProperties:\n                                    type: string\n                                  description: matchLabels is a map of {key,value}\n                                    pairs. A single {key,value} in the matchLabels\n                                    map is equivalent to an element of matchExpressions,\n                                    whose key field is \"key\", the operator is \"In\",\n                                    and the values array contains only \"value\". The\n                                    requirements are ANDed.\n                                  type: object\n                              type: object\n                              x-kubernetes-map-type: atomic\n                            namespaceSelector:\n                              description: A label query over the set of namespaces\n                                that the term applies to. The term is applied to the\n                                union of the namespaces selected by this field and\n                                the ones listed in the namespaces field. null selector\n                                and null or empty namespaces list means \"this pod's\n                                namespace\". An empty selector ({}) matches all namespaces.\n                              properties:\n                                matchExpressions:\n                                  description: matchExpressions is a list of label\n                                    selector requirements. The requirements are ANDed.\n                                  items:\n                                    description: A label selector requirement is a\n                                      selector that contains values, a key, and an\n                                      operator that relates the key and values.\n                                    properties:\n                                      key:\n                                        description: key is the label key that the\n                                          selector applies to.\n                                        type: string\n                                      operator:\n                                        description: operator represents a key's relationship\n                                          to a set of values. Valid operators are\n                                          In, NotIn, Exists and DoesNotExist.\n                                        type: string\n                                      values:\n                                        description: values is an array of string\n                                          values. If the operator is In or NotIn,\n                                          the values array must be non-empty. If the\n                                          operator is Exists or DoesNotExist, the\n                                          values array must be empty. This array is\n                                          replaced during a strategic merge patch.\n                                        items:\n                                          type: string\n                                        type: array\n                                    required:\n                                    - key\n                                    - operator\n                                    type: object\n                                  type: array\n                                matchLabels:\n                                  additionalProperties:\n                                    type: string\n                                  description: matchLabels is a map of {key,value}\n                                    pairs. A single {key,value} in the matchLabels\n                                    map is equivalent to an element of matchExpressions,\n                                    whose key field is \"key\", the operator is \"In\",\n                                    and the values array contains only \"value\". The\n                                    requirements are ANDed.\n                                  type: object\n                              type: object\n                              x-kubernetes-map-type: atomic\n                            namespaces:\n                              description: namespaces specifies a static list of namespace\n                                names that the term applies to. The term is applied\n                                to the union of the namespaces listed in this field\n                                and the ones selected by namespaceSelector. null or\n                                empty namespaces list and null namespaceSelector means\n                                \"this pod's namespace\".\n                              items:\n                                type: string\n                              type: array\n                            topologyKey:\n                              description: This pod should be co-located (affinity)\n                                or not co-located (anti-affinity) with the pods matching\n                                the labelSelector in the specified namespaces, where\n                                co-located is defined as running on a node whose value\n                                of the label with key topologyKey matches that of\n                                any node on which any of the selected pods is running.\n                                Empty topologyKey is not allowed.\n                              type: string\n                          required:\n                          - topologyKey\n                          type: object\n                        type: array\n                    type: object\n                type: object\n              delayStartSeconds:\n                default: 30\n                description: DelayStartSeconds is the time the init container (`setup-container`)\n                  will sleep before terminating. This effectively delays the time\n                  between starting the Pod and starting the `rabbitmq` container.\n                  RabbitMQ relies on up-to-date DNS entries early during peer discovery.\n                  The purpose of this artificial delay is to ensure that DNS entries\n                  are up-to-date when booting RabbitMQ. For more information, see\n                  https://github.com/kubernetes/kubernetes/issues/92559 If your Kubernetes\n                  DNS backend is configured with a low DNS cache value or publishes\n                  not ready addresses promptly, you can decrase this value or set\n                  it to 0.\n                format: int32\n                minimum: 0\n                type: integer\n              image:\n                description: Image is the name of the RabbitMQ docker image to use\n                  for RabbitMQ nodes in the RabbitmqCluster. Must be provided together\n                  with ImagePullSecrets in order to use an image in a private registry.\n                type: string\n              imagePullSecrets:\n                description: List of Secret resource containing access credentials\n                  to the registry for the RabbitMQ image. Required if the docker registry\n                  is private.\n                items:\n                  description: LocalObjectReference contains enough information to\n                    let you locate the referenced object inside the same namespace.\n                  properties:\n                    name:\n                      description: 'Name of the referent. More info: https://kubernetes.io/docs/concepts/overview/working-with-objects/names/#names\n                        TODO: Add other useful fields. apiVersion, kind, uid?'\n                      type: string\n                  type: object\n                  x-kubernetes-map-type: atomic\n                type: array\n              override:\n                properties:\n                  service:\n                    properties:\n                      metadata:\n                        properties:\n                          annotations:\n                            additionalProperties:\n                              type: string\n                            type: object\n                          labels:\n                            additionalProperties:\n                              type: string\n                            type: object\n                        type: object\n                      spec:\n                        properties:\n                          allocateLoadBalancerNodePorts:\n                            type: boolean\n                          clusterIP:\n                            type: string\n                          clusterIPs:\n                            items:\n                              type: string\n                            type: array\n                            x-kubernetes-list-type: atomic\n                          externalIPs:\n                            items:\n                              type: string\n                            type: array\n                          externalName:\n                            type: string\n                          externalTrafficPolicy:\n                            type: string\n                          healthCheckNodePort:\n                            format: int32\n                            type: integer\n                          internalTrafficPolicy:\n                            type: string\n                          ipFamilies:\n                            items:\n                              type: string\n                            type: array\n                            x-kubernetes-list-type: atomic\n                          ipFamilyPolicy:\n                            type: string\n                          loadBalancerClass:\n                            type: string\n                          loadBalancerIP:\n                            type: string\n                          loadBalancerSourceRanges:\n                            items:\n                              type: string\n                            type: array\n                          ports:\n                            items:\n                              properties:\n                                appProtocol:\n                                  type: string\n                                name:\n                                  type: string\n                                nodePort:\n                                  format: int32\n                                  type: integer\n                                port:\n                                  format: int32\n                                  type: integer\n                                protocol:\n                                  default: TCP\n                                  type: string\n                                targetPort:\n                                  anyOf:\n                                  - type: integer\n                                  - type: string\n                                  x-kubernetes-int-or-string: true\n                              required:\n                              - port\n                              type: object\n                            type: array\n                            x-kubernetes-list-map-keys:\n                            - port\n                            - protocol\n                            x-kubernetes-list-type: map\n                          publishNotReadyAddresses:\n                            type: boolean\n                          selector:\n                            additionalProperties:\n                              type: string\n                            type: object\n                            x-kubernetes-map-type: atomic\n                          sessionAffinity:\n                            type: string\n                          sessionAffinityConfig:\n                            properties:\n                              clientIP:\n                                properties:\n                                  timeoutSeconds:\n                                    format: int32\n                                    type: integer\n                                type: object\n                            type: object\n                          type:\n                            type: string\n                        type: object\n                    type: object\n                  statefulSet:\n                    properties:\n                      metadata:\n                        properties:\n                          annotations:\n                            additionalProperties:\n                              type: string\n                            type: object\n                          labels:\n                            additionalProperties:\n                              type: string\n                            type: object\n                        type: object\n                      spec:\n                        properties:\n                          minReadySeconds:\n                            format: int32\n                            type: integer\n                          persistentVolumeClaimRetentionPolicy:\n                            properties:\n                              whenDeleted:\n                                type: string\n                              whenScaled:\n                                type: string\n                            type: object\n                          podManagementPolicy:\n                            type: string\n                          replicas:\n                            format: int32\n                            type: integer\n                          selector:\n                            properties:\n                              matchExpressions:\n                                items:\n                                  properties:\n                                    key:\n                                      type: string\n                                    operator:\n                                      type: string\n                                    values:\n                                      items:\n                                        type: string\n                                      type: array\n                                  required:\n                                  - key\n                                  - operator\n                                  type: object\n                                type: array\n                              matchLabels:\n                                additionalProperties:\n                                  type: string\n                                type: object\n                            type: object\n                            x-kubernetes-map-type: atomic\n                          serviceName:\n                            type: string\n                          template:\n                            properties:\n                              metadata:\n                                properties:\n                                  annotations:\n                                    additionalProperties:\n                                      type: string\n                                    type: object\n                                  labels:\n                                    additionalProperties:\n                                      type: string\n                                    type: object\n                                  name:\n                                    type: string\n                                  namespace:\n                                    type: string\n                                type: object\n                              spec:\n                                properties:\n                                  activeDeadlineSeconds:\n                                    format: int64\n                                    type: integer\n                                  affinity:\n                                    properties:\n                                      nodeAffinity:\n                                        properties:\n                                          preferredDuringSchedulingIgnoredDuringExecution:\n                                            items:\n                                              properties:\n                                                preference:\n                                                  properties:\n                                                    matchExpressions:\n                                                      items:\n                                                        properties:\n                                                          key:\n                                                            type: string\n                                                          operator:\n                                                            type: string\n                                                          values:\n                                                            items:\n                                                              type: string\n                                                            type: array\n                                                        required:\n                                                        - key\n                                                        - operator\n                                                        type: object\n                                                      type: array\n                                                    matchFields:\n                                                      items:\n                                                        properties:\n                                                          key:\n                                                            type: string\n                                                          operator:\n                                                            type: string\n                                                          values:\n                                                            items:\n                                                              type: string\n                                                            type: array\n                                                        required:\n                                                        - key\n                                                        - operator\n                                                        type: object\n                                                      type: array\n                                                  type: object\n                                                  x-kubernetes-map-type: atomic\n                                                weight:\n                                                  format: int32\n                                                  type: integer\n                                              required:\n                                              - preference\n                                              - weight\n                                              type: object\n                                            type: array\n                                          requiredDuringSchedulingIgnoredDuringExecution:\n                                            properties:\n                                              nodeSelectorTerms:\n                                                items:\n                                                  properties:\n                                                    matchExpressions:\n                                                      items:\n                                                        properties:\n                                                          key:\n                                                            type: string\n                                                          operator:\n                                                            type: string\n                                                          values:\n                                                            items:\n                                                              type: string\n                                                            type: array\n                                                        required:\n                                                        - key\n                                                        - operator\n                                                        type: object\n                                                      type: array\n                                                    matchFields:\n                                                      items:\n                                                        properties:\n                                                          key:\n                                                            type: string\n                                                          operator:\n                                                            type: string\n                                                          values:\n                                                            items:\n                                                              type: string\n                                                            type: array\n                                                        required:\n                                                        - key\n                                                        - operator\n                                                        type: object\n                                                      type: array\n                                                  type: object\n                                                  x-kubernetes-map-type: atomic\n                                                type: array\n                                            required:\n                                            - nodeSelectorTerms\n                                            type: object\n                                            x-kubernetes-map-type: atomic\n                                        type: object\n                                      podAffinity:\n                                        properties:\n                                          preferredDuringSchedulingIgnoredDuringExecution:\n                                            items:\n                                              properties:\n                                                podAffinityTerm:\n                                                  properties:\n                                                    labelSelector:\n                                                      properties:\n                                                        matchExpressions:\n                                                          items:\n                                                            properties:\n                                                              key:\n                                                                type: string\n                                                              operator:\n                                                                type: string\n                                                              values:\n                                                                items:\n                                                                  type: string\n                                                                type: array\n                                                            required:\n                                                            - key\n                                                            - operator\n                                                            type: object\n                                                          type: array\n                                                        matchLabels:\n                                                          additionalProperties:\n                                                            type: string\n                                                          type: object\n                                                      type: object\n                                                      x-kubernetes-map-type: atomic\n                                                    namespaceSelector:\n                                                      properties:\n                                                        matchExpressions:\n                                                          items:\n                                                            properties:\n                                                              key:\n                                                                type: string\n                                                              operator:\n                                                                type: string\n                                                              values:\n                                                                items:\n                                                                  type: string\n                                                                type: array\n                                                            required:\n                                                            - key\n                                                            - operator\n                                                            type: object\n                                                          type: array\n                                                        matchLabels:\n                                                          additionalProperties:\n                                                            type: string\n                                                          type: object\n                                                      type: object\n                                                      x-kubernetes-map-type: atomic\n                                                    namespaces:\n                                                      items:\n                                                        type: string\n                                                      type: array\n                                                    topologyKey:\n                                                      type: string\n                                                  required:\n                                                  - topologyKey\n                                                  type: object\n                                                weight:\n                                                  format: int32\n                                                  type: integer\n                                              required:\n                                              - podAffinityTerm\n                                              - weight\n                                              type: object\n                                            type: array\n                                          requiredDuringSchedulingIgnoredDuringExecution:\n                                            items:\n                                              properties:\n                                                labelSelector:\n                                                  properties:\n                                                    matchExpressions:\n                                                      items:\n                                                        properties:\n                                                          key:\n                                                            type: string\n                                                          operator:\n                                                            type: string\n                                                          values:\n                                                            items:\n                                                              type: string\n                                                            type: array\n                                                        required:\n                                                        - key\n                                                        - operator\n                                                        type: object\n                                                      type: array\n                                                    matchLabels:\n                                                      additionalProperties:\n                                                        type: string\n                                                      type: object\n                                                  type: object\n                                                  x-kubernetes-map-type: atomic\n                                                namespaceSelector:\n                                                  properties:\n                                                    matchExpressions:\n                                                      items:\n                                                        properties:\n                                                          key:\n                                                            type: string\n                                                          operator:\n                                                            type: string\n                                                          values:\n                                                            items:\n                                                              type: string\n                                                            type: array\n                                                        required:\n                                                        - key\n                                                        - operator\n                                                        type: object\n                                                      type: array\n                                                    matchLabels:\n                                                      additionalProperties:\n                                                        type: string\n                                                      type: object\n                                                  type: object\n                                                  x-kubernetes-map-type: atomic\n                                                namespaces:\n                                                  items:\n                                                    type: string\n                                                  type: array\n                                                topologyKey:\n                                                  type: string\n                                              required:\n                                              - topologyKey\n                                              type: object\n                                            type: array\n                                        type: object\n                                      podAntiAffinity:\n                                        properties:\n                                          preferredDuringSchedulingIgnoredDuringExecution:\n                                            items:\n                                              properties:\n                                                podAffinityTerm:\n                                                  properties:\n                                                    labelSelector:\n                                                      properties:\n                                                        matchExpressions:\n                                                          items:\n                                                            properties:\n                                                              key:\n                                                                type: string\n                                                              operator:\n                                                                type: string\n                                                              values:\n                                                                items:\n                                                                  type: string\n                                                                type: array\n                                                            required:\n                                                            - key\n                                                            - operator\n                                                            type: object\n                                                          type: array\n                                                        matchLabels:\n                                                          additionalProperties:\n                                                            type: string\n                                                          type: object\n                                                      type: object\n                                                      x-kubernetes-map-type: atomic\n                                                    namespaceSelector:\n                                                      properties:\n                                                        matchExpressions:\n                                                          items:\n                                                            properties:\n                                                              key:\n                                                                type: string\n                                                              operator:\n                                                                type: string\n                                                              values:\n                                                                items:\n                                                                  type: string\n                                                                type: array\n                                                            required:\n                                                            - key\n                                                            - operator\n                                                            type: object\n                                                          type: array\n                                                        matchLabels:\n                                                          additionalProperties:\n                                                            type: string\n                                                          type: object\n                                                      type: object\n                                                      x-kubernetes-map-type: atomic\n                                                    namespaces:\n                                                      items:\n                                                        type: string\n                                                      type: array\n                                                    topologyKey:\n                                                      type: string\n                                                  required:\n                                                  - topologyKey\n                                                  type: object\n                                                weight:\n                                                  format: int32\n                                                  type: integer\n                                              required:\n                                              - podAffinityTerm\n                                              - weight\n                                              type: object\n                                            type: array\n                                          requiredDuringSchedulingIgnoredDuringExecution:\n                                            items:\n                                              properties:\n                                                labelSelector:\n                                                  properties:\n                                                    matchExpressions:\n                                                      items:\n                                                        properties:\n                                                          key:\n                                                            type: string\n                                                          operator:\n                                                            type: string\n                                                          values:\n                                                            items:\n                                                              type: string\n                                                            type: array\n                                                        required:\n                                                        - key\n                                                        - operator\n                                                        type: object\n                                                      type: array\n                                                    matchLabels:\n                                                      additionalProperties:\n                                                        type: string\n                                                      type: object\n                                                  type: object\n                                                  x-kubernetes-map-type: atomic\n                                                namespaceSelector:\n                                                  properties:\n                                                    matchExpressions:\n                                                      items:\n                                                        properties:\n                                                          key:\n                                                            type: string\n                                                          operator:\n                                                            type: string\n                                                          values:\n                                                            items:\n                                                              type: string\n                                                            type: array\n                                                        required:\n                                                        - key\n                                                        - operator\n                                                        type: object\n                                                      type: array\n                                                    matchLabels:\n                                                      additionalProperties:\n                                                        type: string\n                                                      type: object\n                                                  type: object\n                                                  x-kubernetes-map-type: atomic\n                                                namespaces:\n                                                  items:\n                                                    type: string\n                                                  type: array\n                                                topologyKey:\n                                                  type: string\n                                              required:\n                                              - topologyKey\n                                              type: object\n                                            type: array\n                                        type: object\n                                    type: object\n                                  automountServiceAccountToken:\n                                    type: boolean\n                                  containers:\n                                    items:\n                                      properties:\n                                        args:\n                                          items:\n                                            type: string\n                                          type: array\n                                        command:\n                                          items:\n                                            type: string\n                                          type: array\n                                        env:\n                                          items:\n                                            properties:\n                                              name:\n                                                type: string\n                                              value:\n                                                type: string\n                                              valueFrom:\n                                                properties:\n                                                  configMapKeyRef:\n                                                    properties:\n                                                      key:\n                                                        type: string\n                                                      name:\n                                                        type: string\n                                                      optional:\n                                                        type: boolean\n                                                    required:\n                                                    - key\n                                                    type: object\n                                                    x-kubernetes-map-type: atomic\n                                                  fieldRef:\n                                                    properties:\n                                                      apiVersion:\n                                                        type: string\n                                                      fieldPath:\n                                                        type: string\n                                                    required:\n                                                    - fieldPath\n                                                    type: object\n                                                    x-kubernetes-map-type: atomic\n                                                  resourceFieldRef:\n                                                    properties:\n                                                      containerName:\n                                                        type: string\n                                                      divisor:\n                                                        anyOf:\n                                                        - type: integer\n                                                        - type: string\n                                                        pattern: ^(\\+|-)?(([0-9]+(\\.[0-9]*)?)|(\\.[0-9]+))(([KMGTPE]i)|[numkMGTPE]|([eE](\\+|-)?(([0-9]+(\\.[0-9]*)?)|(\\.[0-9]+))))?$\n                                                        x-kubernetes-int-or-string: true\n                                                      resource:\n                                                        type: string\n                                                    required:\n                                                    - resource\n                                                    type: object\n                                                    x-kubernetes-map-type: atomic\n                                                  secretKeyRef:\n                                                    properties:\n                                                      key:\n                                                        type: string\n                                                      name:\n                                                        type: string\n                                                      optional:\n                                                        type: boolean\n                                                    required:\n                                                    - key\n                                                    type: object\n                                                    x-kubernetes-map-type: atomic\n                                                type: object\n                                            required:\n                                            - name\n                                            type: object\n                                          type: array\n                                        envFrom:\n                                          items:\n                                            properties:\n                                              configMapRef:\n                                                properties:\n                                                  name:\n                                                    type: string\n                                                  optional:\n                                                    type: boolean\n                                                type: object\n                                                x-kubernetes-map-type: atomic\n                                              prefix:\n                                                type: string\n                                              secretRef:\n                                                properties:\n                                                  name:\n                                                    type: string\n                                                  optional:\n                                                    type: boolean\n                                                type: object\n                                                x-kubernetes-map-type: atomic\n                                            type: object\n                                          type: array\n                                        image:\n                                          type: string\n                                        imagePullPolicy:\n                                          type: string\n                                        lifecycle:\n                                          properties:\n                                            postStart:\n                                              properties:\n                                                exec:\n                                                  properties:\n                                                    command:\n                                                      items:\n                                                        type: string\n                                                      type: array\n                                                  type: object\n                                                httpGet:\n                                                  properties:\n                                                    host:\n                                                      type: string\n                                                    httpHeaders:\n                                                      items:\n                                                        properties:\n                                                          name:\n                                                            type: string\n                                                          value:\n                                                            type: string\n                                                        required:\n                                                        - name\n                                                        - value\n                                                        type: object\n                                                      type: array\n                                                    path:\n                                                      type: string\n                                                    port:\n                                                      anyOf:\n                                                      - type: integer\n                                                      - type: string\n                                                      x-kubernetes-int-or-string: true\n                                                    scheme:\n                                                      type: string\n                                                  required:\n                                                  - port\n                                                  type: object\n                                                tcpSocket:\n                                                  properties:\n                                                    host:\n                                                      type: string\n                                                    port:\n                                                      anyOf:\n                                                      - type: integer\n                                                      - type: string\n                                                      x-kubernetes-int-or-string: true\n                                                  required:\n                                                  - port\n                                                  type: object\n                                              type: object\n                                            preStop:\n                                              properties:\n                                                exec:\n                                                  properties:\n                                                    command:\n                                                      items:\n                                                        type: string\n                                                      type: array\n                                                  type: object\n                                                httpGet:\n                                                  properties:\n                                                    host:\n                                                      type: string\n                                                    httpHeaders:\n                                                      items:\n                                                        properties:\n                                                          name:\n                                                            type: string\n                                                          value:\n                                                            type: string\n                                                        required:\n                                                        - name\n                                                        - value\n                                                        type: object\n                                                      type: array\n                                                    path:\n                                                      type: string\n                                                    port:\n                                                      anyOf:\n                                                      - type: integer\n                                                      - type: string\n                                                      x-kubernetes-int-or-string: true\n                                                    scheme:\n                                                      type: string\n                                                  required:\n                                                  - port\n                                                  type: object\n                                                tcpSocket:\n                                                  properties:\n                                                    host:\n                                                      type: string\n                                                    port:\n                                                      anyOf:\n                                                      - type: integer\n                                                      - type: string\n                                                      x-kubernetes-int-or-string: true\n                                                  required:\n                                                  - port\n                                                  type: object\n                                              type: object\n                                          type: object\n                                        livenessProbe:\n                                          properties:\n                                            exec:\n                                              properties:\n                                                command:\n                                                  items:\n                                                    type: string\n                                                  type: array\n                                              type: object\n                                            failureThreshold:\n                                              format: int32\n                                              type: integer\n                                            grpc:\n                                              properties:\n                                                port:\n                                                  format: int32\n                                                  type: integer\n                                                service:\n                                                  type: string\n                                              required:\n                                              - port\n                                              type: object\n                                            httpGet:\n                                              properties:\n                                                host:\n                                                  type: string\n                                                httpHeaders:\n                                                  items:\n                                                    properties:\n                                                      name:\n                                                        type: string\n                                                      value:\n                                                        type: string\n                                                    required:\n                                                    - name\n                                                    - value\n                                                    type: object\n                                                  type: array\n                                                path:\n                                                  type: string\n                                                port:\n                                                  anyOf:\n                                                  - type: integer\n                                                  - type: string\n                                                  x-kubernetes-int-or-string: true\n                                                scheme:\n                                                  type: string\n                                              required:\n                                              - port\n                                              type: object\n                                            initialDelaySeconds:\n                                              format: int32\n                                              type: integer\n                                            periodSeconds:\n                                              format: int32\n                                              type: integer\n                                            successThreshold:\n                                              format: int32\n                                              type: integer\n                                            tcpSocket:\n                                              properties:\n                                                host:\n                                                  type: string\n                                                port:\n                                                  anyOf:\n                                                  - type: integer\n                                                  - type: string\n                                                  x-kubernetes-int-or-string: true\n                                              required:\n                                              - port\n                                              type: object\n                                            terminationGracePeriodSeconds:\n                                              format: int64\n                                              type: integer\n                                            timeoutSeconds:\n                                              format: int32\n                                              type: integer\n                                          type: object\n                                        name:\n                                          type: string\n                                        ports:\n                                          items:\n                                            properties:\n                                              containerPort:\n                                                format: int32\n                                                type: integer\n                                              hostIP:\n                                                type: string\n                                              hostPort:\n                                                format: int32\n                                                type: integer\n                                              name:\n                                                type: string\n                                              protocol:\n                                                default: TCP\n                                                type: string\n                                            required:\n                                            - containerPort\n                                            type: object\n                                          type: array\n                                          x-kubernetes-list-map-keys:\n                                          - containerPort\n                                          - protocol\n                                          x-kubernetes-list-type: map\n                                        readinessProbe:\n                                          properties:\n                                            exec:\n                                              properties:\n                                                command:\n                                                  items:\n                                                    type: string\n                                                  type: array\n                                              type: object\n                                            failureThreshold:\n                                              format: int32\n                                              type: integer\n                                            grpc:\n                                              properties:\n                                                port:\n                                                  format: int32\n                                                  type: integer\n                                                service:\n                                                  type: string\n                                              required:\n                                              - port\n                                              type: object\n                                            httpGet:\n                                              properties:\n                                                host:\n                                                  type: string\n                                                httpHeaders:\n                                                  items:\n                                                    properties:\n                                                      name:\n                                                        type: string\n                                                      value:\n                                                        type: string\n                                                    required:\n                                                    - name\n                                                    - value\n                                                    type: object\n                                                  type: array\n                                                path:\n                                                  type: string\n                                                port:\n                                                  anyOf:\n                                                  - type: integer\n                                                  - type: string\n                                                  x-kubernetes-int-or-string: true\n                                                scheme:\n                                                  type: string\n                                              required:\n                                              - port\n                                              type: object\n                                            initialDelaySeconds:\n                                              format: int32\n                                              type: integer\n                                            periodSeconds:\n                                              format: int32\n                                              type: integer\n                                            successThreshold:\n                                              format: int32\n                                              type: integer\n                                            tcpSocket:\n                                              properties:\n                                                host:\n                                                  type: string\n                                                port:\n                                                  anyOf:\n                                                  - type: integer\n                                                  - type: string\n                                                  x-kubernetes-int-or-string: true\n                                              required:\n                                              - port\n                                              type: object\n                                            terminationGracePeriodSeconds:\n                                              format: int64\n                                              type: integer\n                                            timeoutSeconds:\n                                              format: int32\n                                              type: integer\n                                          type: object\n                                        resources:\n                                          properties:\n                                            claims:\n                                              items:\n                                                properties:\n                                                  name:\n                                                    type: string\n                                                required:\n                                                - name\n                                                type: object\n                                              type: array\n                                              x-kubernetes-list-map-keys:\n                                              - name\n                                              x-kubernetes-list-type: map\n                                            limits:\n                                              additionalProperties:\n                                                anyOf:\n                                                - type: integer\n                                                - type: string\n                                                pattern: ^(\\+|-)?(([0-9]+(\\.[0-9]*)?)|(\\.[0-9]+))(([KMGTPE]i)|[numkMGTPE]|([eE](\\+|-)?(([0-9]+(\\.[0-9]*)?)|(\\.[0-9]+))))?$\n                                                x-kubernetes-int-or-string: true\n                                              type: object\n                                            requests:\n                                              additionalProperties:\n                                                anyOf:\n                                                - type: integer\n                                                - type: string\n                                                pattern: ^(\\+|-)?(([0-9]+(\\.[0-9]*)?)|(\\.[0-9]+))(([KMGTPE]i)|[numkMGTPE]|([eE](\\+|-)?(([0-9]+(\\.[0-9]*)?)|(\\.[0-9]+))))?$\n                                                x-kubernetes-int-or-string: true\n                                              type: object\n                                          type: object\n                                        securityContext:\n                                          properties:\n                                            allowPrivilegeEscalation:\n                                              type: boolean\n                                            capabilities:\n                                              properties:\n                                                add:\n                                                  items:\n                                                    type: string\n                                                  type: array\n                                                drop:\n                                                  items:\n                                                    type: string\n                                                  type: array\n                                              type: object\n                                            privileged:\n                                              type: boolean\n                                            procMount:\n                                              type: string\n                                            readOnlyRootFilesystem:\n                                              type: boolean\n                                            runAsGroup:\n                                              format: int64\n                                              type: integer\n                                            runAsNonRoot:\n                                              type: boolean\n                                            runAsUser:\n                                              format: int64\n                                              type: integer\n                                            seLinuxOptions:\n                                              properties:\n                                                level:\n                                                  type: string\n                                                role:\n                                                  type: string\n                                                type:\n                                                  type: string\n                                                user:\n                                                  type: string\n                                              type: object\n                                            seccompProfile:\n                                              properties:\n                                                localhostProfile:\n                                                  type: string\n                                                type:\n                                                  type: string\n                                              required:\n                                              - type\n                                              type: object\n                                            windowsOptions:\n                                              properties:\n                                                gmsaCredentialSpec:\n                                                  type: string\n                                                gmsaCredentialSpecName:\n                                                  type: string\n                                                hostProcess:\n                                                  type: boolean\n                                                runAsUserName:\n                                                  type: string\n                                              type: object\n                                          type: object\n                                        startupProbe:\n                                          properties:\n                                            exec:\n                                              properties:\n                                                command:\n                                                  items:\n                                                    type: string\n                                                  type: array\n                                              type: object\n                                            failureThreshold:\n                                              format: int32\n                                              type: integer\n                                            grpc:\n                                              properties:\n                                                port:\n                                                  format: int32\n                                                  type: integer\n                                                service:\n                                                  type: string\n                                              required:\n                                              - port\n                                              type: object\n                                            httpGet:\n                                              properties:\n                                                host:\n                                                  type: string\n                                                httpHeaders:\n                                                  items:\n                                                    properties:\n                                                      name:\n                                                        type: string\n                                                      value:\n                                                        type: string\n                                                    required:\n                                                    - name\n                                                    - value\n                                                    type: object\n                                                  type: array\n                                                path:\n                                                  type: string\n                                                port:\n                                                  anyOf:\n                                                  - type: integer\n                                                  - type: string\n                                                  x-kubernetes-int-or-string: true\n                                                scheme:\n                                                  type: string\n                                              required:\n                                              - port\n                                              type: object\n                                            initialDelaySeconds:\n                                              format: int32\n                                              type: integer\n                                            periodSeconds:\n                                              format: int32\n                                              type: integer\n                                            successThreshold:\n                                              format: int32\n                                              type: integer\n                                            tcpSocket:\n                                              properties:\n                                                host:\n                                                  type: string\n                                                port:\n                                                  anyOf:\n                                                  - type: integer\n                                                  - type: string\n                                                  x-kubernetes-int-or-string: true\n                                              required:\n                                              - port\n                                              type: object\n                                            terminationGracePeriodSeconds:\n                                              format: int64\n                                              type: integer\n                                            timeoutSeconds:\n                                              format: int32\n                                              type: integer\n                                          type: object\n                                        stdin:\n                                          type: boolean\n                                        stdinOnce:\n                                          type: boolean\n                                        terminationMessagePath:\n                                          type: string\n                                        terminationMessagePolicy:\n                                          type: string\n                                        tty:\n                                          type: boolean\n                                        volumeDevices:\n                                          items:\n                                            properties:\n                                              devicePath:\n                                                type: string\n                                              name:\n                                                type: string\n                                            required:\n                                            - devicePath\n                                            - name\n                                            type: object\n                                          type: array\n                                        volumeMounts:\n                                          items:\n                                            properties:\n                                              mountPath:\n                                                type: string\n                                              mountPropagation:\n                                                type: string\n                                              name:\n                                                type: string\n                                              readOnly:\n                                                type: boolean\n                                              subPath:\n                                                type: string\n                                              subPathExpr:\n                                                type: string\n                                            required:\n                                            - mountPath\n                                            - name\n                                            type: object\n                                          type: array\n                                        workingDir:\n                                          type: string\n                                      required:\n                                      - name\n                                      type: object\n                                    type: array\n                                  dnsConfig:\n                                    properties:\n                                      nameservers:\n                                        items:\n                                          type: string\n                                        type: array\n                                      options:\n                                        items:\n                                          properties:\n                                            name:\n                                              type: string\n                                            value:\n                                              type: string\n                                          type: object\n                                        type: array\n                                      searches:\n                                        items:\n                                          type: string\n                                        type: array\n                                    type: object\n                                  dnsPolicy:\n                                    type: string\n                                  enableServiceLinks:\n                                    type: boolean\n                                  ephemeralContainers:\n                                    items:\n                                      properties:\n                                        args:\n                                          items:\n                                            type: string\n                                          type: array\n                                        command:\n                                          items:\n                                            type: string\n                                          type: array\n                                        env:\n                                          items:\n                                            properties:\n                                              name:\n                                                type: string\n                                              value:\n                                                type: string\n                                              valueFrom:\n                                                properties:\n                                                  configMapKeyRef:\n                                                    properties:\n                                                      key:\n                                                        type: string\n                                                      name:\n                                                        type: string\n                                                      optional:\n                                                        type: boolean\n                                                    required:\n                                                    - key\n                                                    type: object\n                                                    x-kubernetes-map-type: atomic\n                                                  fieldRef:\n                                                    properties:\n                                                      apiVersion:\n                                                        type: string\n                                                      fieldPath:\n                                                        type: string\n                                                    required:\n                                                    - fieldPath\n                                                    type: object\n                                                    x-kubernetes-map-type: atomic\n                                                  resourceFieldRef:\n                                                    properties:\n                                                      containerName:\n                                                        type: string\n                                                      divisor:\n                                                        anyOf:\n                                                        - type: integer\n                                                        - type: string\n                                                        pattern: ^(\\+|-)?(([0-9]+(\\.[0-9]*)?)|(\\.[0-9]+))(([KMGTPE]i)|[numkMGTPE]|([eE](\\+|-)?(([0-9]+(\\.[0-9]*)?)|(\\.[0-9]+))))?$\n                                                        x-kubernetes-int-or-string: true\n                                                      resource:\n                                                        type: string\n                                                    required:\n                                                    - resource\n                                                    type: object\n                                                    x-kubernetes-map-type: atomic\n                                                  secretKeyRef:\n                                                    properties:\n                                                      key:\n                                                        type: string\n                                                      name:\n                                                        type: string\n                                                      optional:\n                                                        type: boolean\n                                                    required:\n                                                    - key\n                                                    type: object\n                                                    x-kubernetes-map-type: atomic\n                                                type: object\n                                            required:\n                                            - name\n                                            type: object\n                                          type: array\n                                        envFrom:\n                                          items:\n                                            properties:\n                                              configMapRef:\n                                                properties:\n                                                  name:\n                                                    type: string\n                                                  optional:\n                                                    type: boolean\n                                                type: object\n                                                x-kubernetes-map-type: atomic\n                                              prefix:\n                                                type: string\n                                              secretRef:\n                                                properties:\n                                                  name:\n                                                    type: string\n                                                  optional:\n                                                    type: boolean\n                                                type: object\n                                                x-kubernetes-map-type: atomic\n                                            type: object\n                                          type: array\n                                        image:\n                                          type: string\n                                        imagePullPolicy:\n                                          type: string\n                                        lifecycle:\n                                          properties:\n                                            postStart:\n                                              properties:\n                                                exec:\n                                                  properties:\n                                                    command:\n                                                      items:\n                                                        type: string\n                                                      type: array\n                                                  type: object\n                                                httpGet:\n                                                  properties:\n                                                    host:\n                                                      type: string\n                                                    httpHeaders:\n                                                      items:\n                                                        properties:\n                                                          name:\n                                                            type: string\n                                                          value:\n                                                            type: string\n                                                        required:\n                                                        - name\n                                                        - value\n                                                        type: object\n                                                      type: array\n                                                    path:\n                                                      type: string\n                                                    port:\n                                                      anyOf:\n                                                      - type: integer\n                                                      - type: string\n                                                      x-kubernetes-int-or-string: true\n                                                    scheme:\n                                                      type: string\n                                                  required:\n                                                  - port\n                                                  type: object\n                                                tcpSocket:\n                                                  properties:\n                                                    host:\n                                                      type: string\n                                                    port:\n                                                      anyOf:\n                                                      - type: integer\n                                                      - type: string\n                                                      x-kubernetes-int-or-string: true\n                                                  required:\n                                                  - port\n                                                  type: object\n                                              type: object\n                                            preStop:\n                                              properties:\n                                                exec:\n                                                  properties:\n                                                    command:\n                                                      items:\n                                                        type: string\n                                                      type: array\n                                                  type: object\n                                                httpGet:\n                                                  properties:\n                                                    host:\n                                                      type: string\n                                                    httpHeaders:\n                                                      items:\n                                                        properties:\n                                                          name:\n                                                            type: string\n                                                          value:\n                                                            type: string\n                                                        required:\n                                                        - name\n                                                        - value\n                                                        type: object\n                                                      type: array\n                                                    path:\n                                                      type: string\n                                                    port:\n                                                      anyOf:\n                                                      - type: integer\n                                                      - type: string\n                                                      x-kubernetes-int-or-string: true\n                                                    scheme:\n                                                      type: string\n                                                  required:\n                                                  - port\n                                                  type: object\n                                                tcpSocket:\n                                                  properties:\n                                                    host:\n                                                      type: string\n                                                    port:\n                                                      anyOf:\n                                                      - type: integer\n                                                      - type: string\n                                                      x-kubernetes-int-or-string: true\n                                                  required:\n                                                  - port\n                                                  type: object\n                                              type: object\n                                          type: object\n                                        livenessProbe:\n                                          properties:\n                                            exec:\n                                              properties:\n                                                command:\n                                                  items:\n                                                    type: string\n                                                  type: array\n                                              type: object\n                                            failureThreshold:\n                                              format: int32\n                                              type: integer\n                                            grpc:\n                                              properties:\n                                                port:\n                                                  format: int32\n                                                  type: integer\n                                                service:\n                                                  type: string\n                                              required:\n                                              - port\n                                              type: object\n                                            httpGet:\n                                              properties:\n                                                host:\n                                                  type: string\n                                                httpHeaders:\n                                                  items:\n                                                    properties:\n                                                      name:\n                                                        type: string\n                                                      value:\n                                                        type: string\n                                                    required:\n                                                    - name\n                                                    - value\n                                                    type: object\n                                                  type: array\n                                                path:\n                                                  type: string\n                                                port:\n                                                  anyOf:\n                                                  - type: integer\n                                                  - type: string\n                                                  x-kubernetes-int-or-string: true\n                                                scheme:\n                                                  type: string\n                                              required:\n                                              - port\n                                              type: object\n                                            initialDelaySeconds:\n                                              format: int32\n                                              type: integer\n                                            periodSeconds:\n                                              format: int32\n                                              type: integer\n                                            successThreshold:\n                                              format: int32\n                                              type: integer\n                                            tcpSocket:\n                                              properties:\n                                                host:\n                                                  type: string\n                                                port:\n                                                  anyOf:\n                                                  - type: integer\n                                                  - type: string\n                                                  x-kubernetes-int-or-string: true\n                                              required:\n                                              - port\n                                              type: object\n                                            terminationGracePeriodSeconds:\n                                              format: int64\n                                              type: integer\n                                            timeoutSeconds:\n                                              format: int32\n                                              type: integer\n                                          type: object\n                                        name:\n                                          type: string\n                                        ports:\n                                          items:\n                                            properties:\n                                              containerPort:\n                                                format: int32\n                                                type: integer\n                                              hostIP:\n                                                type: string\n                                              hostPort:\n                                                format: int32\n                                                type: integer\n                                              name:\n                                                type: string\n                                              protocol:\n                                                default: TCP\n                                                type: string\n                                            required:\n                                            - containerPort\n                                            type: object\n                                          type: array\n                                          x-kubernetes-list-map-keys:\n                                          - containerPort\n                                          - protocol\n                                          x-kubernetes-list-type: map\n                                        readinessProbe:\n                                          properties:\n                                            exec:\n                                              properties:\n                                                command:\n                                                  items:\n                                                    type: string\n                                                  type: array\n                                              type: object\n                                            failureThreshold:\n                                              format: int32\n                                              type: integer\n                                            grpc:\n                                              properties:\n                                                port:\n                                                  format: int32\n                                                  type: integer\n                                                service:\n                                                  type: string\n                                              required:\n                                              - port\n                                              type: object\n                                            httpGet:\n                                              properties:\n                                                host:\n                                                  type: string\n                                                httpHeaders:\n                                                  items:\n                                                    properties:\n                                                      name:\n                                                        type: string\n                                                      value:\n                                                        type: string\n                                                    required:\n                                                    - name\n                                                    - value\n                                                    type: object\n                                                  type: array\n                                                path:\n                                                  type: string\n                                                port:\n                                                  anyOf:\n                                                  - type: integer\n                                                  - type: string\n                                                  x-kubernetes-int-or-string: true\n                                                scheme:\n                                                  type: string\n                                              required:\n                                              - port\n                                              type: object\n                                            initialDelaySeconds:\n                                              format: int32\n                                              type: integer\n                                            periodSeconds:\n                                              format: int32\n                                              type: integer\n                                            successThreshold:\n                                              format: int32\n                                              type: integer\n                                            tcpSocket:\n                                              properties:\n                                                host:\n                                                  type: string\n                                                port:\n                                                  anyOf:\n                                                  - type: integer\n                                                  - type: string\n                                                  x-kubernetes-int-or-string: true\n                                              required:\n                                              - port\n                                              type: object\n                                            terminationGracePeriodSeconds:\n                                              format: int64\n                                              type: integer\n                                            timeoutSeconds:\n                                              format: int32\n                                              type: integer\n                                          type: object\n                                        resources:\n                                          properties:\n                                            claims:\n                                              items:\n                                                properties:\n                                                  name:\n                                                    type: string\n                                                required:\n                                                - name\n                                                type: object\n                                              type: array\n                                              x-kubernetes-list-map-keys:\n                                              - name\n                                              x-kubernetes-list-type: map\n                                            limits:\n                                              additionalProperties:\n                                                anyOf:\n                                                - type: integer\n                                                - type: string\n                                                pattern: ^(\\+|-)?(([0-9]+(\\.[0-9]*)?)|(\\.[0-9]+))(([KMGTPE]i)|[numkMGTPE]|([eE](\\+|-)?(([0-9]+(\\.[0-9]*)?)|(\\.[0-9]+))))?$\n                                                x-kubernetes-int-or-string: true\n                                              type: object\n                                            requests:\n                                              additionalProperties:\n                                                anyOf:\n                                                - type: integer\n                                                - type: string\n                                                pattern: ^(\\+|-)?(([0-9]+(\\.[0-9]*)?)|(\\.[0-9]+))(([KMGTPE]i)|[numkMGTPE]|([eE](\\+|-)?(([0-9]+(\\.[0-9]*)?)|(\\.[0-9]+))))?$\n                                                x-kubernetes-int-or-string: true\n                                              type: object\n                                          type: object\n                                        securityContext:\n                                          properties:\n                                            allowPrivilegeEscalation:\n                                              type: boolean\n                                            capabilities:\n                                              properties:\n                                                add:\n                                                  items:\n                                                    type: string\n                                                  type: array\n                                                drop:\n                                                  items:\n                                                    type: string\n                                                  type: array\n                                              type: object\n                                            privileged:\n                                              type: boolean\n                                            procMount:\n                                              type: string\n                                            readOnlyRootFilesystem:\n                                              type: boolean\n                                            runAsGroup:\n                                              format: int64\n                                              type: integer\n                                            runAsNonRoot:\n                                              type: boolean\n                                            runAsUser:\n                                              format: int64\n                                              type: integer\n                                            seLinuxOptions:\n                                              properties:\n                                                level:\n                                                  type: string\n                                                role:\n                                                  type: string\n                                                type:\n                                                  type: string\n                                                user:\n                                                  type: string\n                                              type: object\n                                            seccompProfile:\n                                              properties:\n                                                localhostProfile:\n                                                  type: string\n                                                type:\n                                                  type: string\n                                              required:\n                                              - type\n                                              type: object\n                                            windowsOptions:\n                                              properties:\n                                                gmsaCredentialSpec:\n                                                  type: string\n                                                gmsaCredentialSpecName:\n                                                  type: string\n                                                hostProcess:\n                                                  type: boolean\n                                                runAsUserName:\n                                                  type: string\n                                              type: object\n                                          type: object\n                                        startupProbe:\n                                          properties:\n                                            exec:\n                                              properties:\n                                                command:\n                                                  items:\n                                                    type: string\n                                                  type: array\n                                              type: object\n                                            failureThreshold:\n                                              format: int32\n                                              type: integer\n                                            grpc:\n                                              properties:\n                                                port:\n                                                  format: int32\n                                                  type: integer\n                                                service:\n                                                  type: string\n                                              required:\n                                              - port\n                                              type: object\n                                            httpGet:\n                                              properties:\n                                                host:\n                                                  type: string\n                                                httpHeaders:\n                                                  items:\n                                                    properties:\n                                                      name:\n                                                        type: string\n                                                      value:\n                                                        type: string\n                                                    required:\n                                                    - name\n                                                    - value\n                                                    type: object\n                                                  type: array\n                                                path:\n                                                  type: string\n                                                port:\n                                                  anyOf:\n                                                  - type: integer\n                                                  - type: string\n                                                  x-kubernetes-int-or-string: true\n                                                scheme:\n                                                  type: string\n                                              required:\n                                              - port\n                                              type: object\n                                            initialDelaySeconds:\n                                              format: int32\n                                              type: integer\n                                            periodSeconds:\n                                              format: int32\n                                              type: integer\n                                            successThreshold:\n                                              format: int32\n                                              type: integer\n                                            tcpSocket:\n                                              properties:\n                                                host:\n                                                  type: string\n                                                port:\n                                                  anyOf:\n                                                  - type: integer\n                                                  - type: string\n                                                  x-kubernetes-int-or-string: true\n                                              required:\n                                              - port\n                                              type: object\n                                            terminationGracePeriodSeconds:\n                                              format: int64\n                                              type: integer\n                                            timeoutSeconds:\n                                              format: int32\n                                              type: integer\n                                          type: object\n                                        stdin:\n                                          type: boolean\n                                        stdinOnce:\n                                          type: boolean\n                                        targetContainerName:\n                                          type: string\n                                        terminationMessagePath:\n                                          type: string\n                                        terminationMessagePolicy:\n                                          type: string\n                                        tty:\n                                          type: boolean\n                                        volumeDevices:\n                                          items:\n                                            properties:\n                                              devicePath:\n                                                type: string\n                                              name:\n                                                type: string\n                                            required:\n                                            - devicePath\n                                            - name\n                                            type: object\n                                          type: array\n                                        volumeMounts:\n                                          items:\n                                            properties:\n                                              mountPath:\n                                                type: string\n                                              mountPropagation:\n                                                type: string\n                                              name:\n                                                type: string\n                                              readOnly:\n                                                type: boolean\n                                              subPath:\n                                                type: string\n                                              subPathExpr:\n                                                type: string\n                                            required:\n                                            - mountPath\n                                            - name\n                                            type: object\n                                          type: array\n                                        workingDir:\n                                          type: string\n                                      required:\n                                      - name\n                                      type: object\n                                    type: array\n                                  hostAliases:\n                                    items:\n                                      properties:\n                                        hostnames:\n                                          items:\n                                            type: string\n                                          type: array\n                                        ip:\n                                          type: string\n                                      type: object\n                                    type: array\n                                  hostIPC:\n                                    type: boolean\n                                  hostNetwork:\n                                    type: boolean\n                                  hostPID:\n                                    type: boolean\n                                  hostUsers:\n                                    type: boolean\n                                  hostname:\n                                    type: string\n                                  imagePullSecrets:\n                                    items:\n                                      properties:\n                                        name:\n                                          type: string\n                                      type: object\n                                      x-kubernetes-map-type: atomic\n                                    type: array\n                                  initContainers:\n                                    items:\n                                      properties:\n                                        args:\n                                          items:\n                                            type: string\n                                          type: array\n                                        command:\n                                          items:\n                                            type: string\n                                          type: array\n                                        env:\n                                          items:\n                                            properties:\n                                              name:\n                                                type: string\n                                              value:\n                                                type: string\n                                              valueFrom:\n                                                properties:\n                                                  configMapKeyRef:\n                                                    properties:\n                                                      key:\n                                                        type: string\n                                                      name:\n                                                        type: string\n                                                      optional:\n                                                        type: boolean\n                                                    required:\n                                                    - key\n                                                    type: object\n                                                    x-kubernetes-map-type: atomic\n                                                  fieldRef:\n                                                    properties:\n                                                      apiVersion:\n                                                        type: string\n                                                      fieldPath:\n                                                        type: string\n                                                    required:\n                                                    - fieldPath\n                                                    type: object\n                                                    x-kubernetes-map-type: atomic\n                                                  resourceFieldRef:\n                                                    properties:\n                                                      containerName:\n                                                        type: string\n                                                      divisor:\n                                                        anyOf:\n                                                        - type: integer\n                                                        - type: string\n                                                        pattern: ^(\\+|-)?(([0-9]+(\\.[0-9]*)?)|(\\.[0-9]+))(([KMGTPE]i)|[numkMGTPE]|([eE](\\+|-)?(([0-9]+(\\.[0-9]*)?)|(\\.[0-9]+))))?$\n                                                        x-kubernetes-int-or-string: true\n                                                      resource:\n                                                        type: string\n                                                    required:\n                                                    - resource\n                                                    type: object\n                                                    x-kubernetes-map-type: atomic\n                                                  secretKeyRef:\n                                                    properties:\n                                                      key:\n                                                        type: string\n                                                      name:\n                                                        type: string\n                                                      optional:\n                                                        type: boolean\n                                                    required:\n                                                    - key\n                                                    type: object\n                                                    x-kubernetes-map-type: atomic\n                                                type: object\n                                            required:\n                                            - name\n                                            type: object\n                                          type: array\n                                        envFrom:\n                                          items:\n                                            properties:\n                                              configMapRef:\n                                                properties:\n                                                  name:\n                                                    type: string\n                                                  optional:\n                                                    type: boolean\n                                                type: object\n                                                x-kubernetes-map-type: atomic\n                                              prefix:\n                                                type: string\n                                              secretRef:\n                                                properties:\n                                                  name:\n                                                    type: string\n                                                  optional:\n                                                    type: boolean\n                                                type: object\n                                                x-kubernetes-map-type: atomic\n                                            type: object\n                                          type: array\n                                        image:\n                                          type: string\n                                        imagePullPolicy:\n                                          type: string\n                                        lifecycle:\n                                          properties:\n                                            postStart:\n                                              properties:\n                                                exec:\n                                                  properties:\n                                                    command:\n                                                      items:\n                                                        type: string\n                                                      type: array\n                                                  type: object\n                                                httpGet:\n                                                  properties:\n                                                    host:\n                                                      type: string\n                                                    httpHeaders:\n                                                      items:\n                                                        properties:\n                                                          name:\n                                                            type: string\n                                                          value:\n                                                            type: string\n                                                        required:\n                                                        - name\n                                                        - value\n                                                        type: object\n                                                      type: array\n                                                    path:\n                                                      type: string\n                                                    port:\n                                                      anyOf:\n                                                      - type: integer\n                                                      - type: string\n                                                      x-kubernetes-int-or-string: true\n                                                    scheme:\n                                                      type: string\n                                                  required:\n                                                  - port\n                                                  type: object\n                                                tcpSocket:\n                                                  properties:\n                                                    host:\n                                                      type: string\n                                                    port:\n                                                      anyOf:\n                                                      - type: integer\n                                                      - type: string\n                                                      x-kubernetes-int-or-string: true\n                                                  required:\n                                                  - port\n                                                  type: object\n                                              type: object\n                                            preStop:\n                                              properties:\n                                                exec:\n                                                  properties:\n                                                    command:\n                                                      items:\n                                                        type: string\n                                                      type: array\n                                                  type: object\n                                                httpGet:\n                                                  properties:\n                                                    host:\n                                                      type: string\n                                                    httpHeaders:\n                                                      items:\n                                                        properties:\n                                                          name:\n                                                            type: string\n                                                          value:\n                                                            type: string\n                                                        required:\n                                                        - name\n                                                        - value\n                                                        type: object\n                                                      type: array\n                                                    path:\n                                                      type: string\n                                                    port:\n                                                      anyOf:\n                                                      - type: integer\n                                                      - type: string\n                                                      x-kubernetes-int-or-string: true\n                                                    scheme:\n                                                      type: string\n                                                  required:\n                                                  - port\n                                                  type: object\n                                                tcpSocket:\n                                                  properties:\n                                                    host:\n                                                      type: string\n                                                    port:\n                                                      anyOf:\n                                                      - type: integer\n                                                      - type: string\n                                                      x-kubernetes-int-or-string: true\n                                                  required:\n                                                  - port\n                                                  type: object\n                                              type: object\n                                          type: object\n                                        livenessProbe:\n                                          properties:\n                                            exec:\n                                              properties:\n                                                command:\n                                                  items:\n                                                    type: string\n                                                  type: array\n                                              type: object\n                                            failureThreshold:\n                                              format: int32\n                                              type: integer\n                                            grpc:\n                                              properties:\n                                                port:\n                                                  format: int32\n                                                  type: integer\n                                                service:\n                                                  type: string\n                                              required:\n                                              - port\n                                              type: object\n                                            httpGet:\n                                              properties:\n                                                host:\n                                                  type: string\n                                                httpHeaders:\n                                                  items:\n                                                    properties:\n                                                      name:\n                                                        type: string\n                                                      value:\n                                                        type: string\n                                                    required:\n                                                    - name\n                                                    - value\n                                                    type: object\n                                                  type: array\n                                                path:\n                                                  type: string\n                                                port:\n                                                  anyOf:\n                                                  - type: integer\n                                                  - type: string\n                                                  x-kubernetes-int-or-string: true\n                                                scheme:\n                                                  type: string\n                                              required:\n                                              - port\n                                              type: object\n                                            initialDelaySeconds:\n                                              format: int32\n                                              type: integer\n                                            periodSeconds:\n                                              format: int32\n                                              type: integer\n                                            successThreshold:\n                                              format: int32\n                                              type: integer\n                                            tcpSocket:\n                                              properties:\n                                                host:\n                                                  type: string\n                                                port:\n                                                  anyOf:\n                                                  - type: integer\n                                                  - type: string\n                                                  x-kubernetes-int-or-string: true\n                                              required:\n                                              - port\n                                              type: object\n                                            terminationGracePeriodSeconds:\n                                              format: int64\n                                              type: integer\n                                            timeoutSeconds:\n                                              format: int32\n                                              type: integer\n                                          type: object\n                                        name:\n                                          type: string\n                                        ports:\n                                          items:\n                                            properties:\n                                              containerPort:\n                                                format: int32\n                                                type: integer\n                                              hostIP:\n                                                type: string\n                                              hostPort:\n                                                format: int32\n                                                type: integer\n                                              name:\n                                                type: string\n                                              protocol:\n                                                default: TCP\n                                                type: string\n                                            required:\n                                            - containerPort\n                                            type: object\n                                          type: array\n                                          x-kubernetes-list-map-keys:\n                                          - containerPort\n                                          - protocol\n                                          x-kubernetes-list-type: map\n                                        readinessProbe:\n                                          properties:\n                                            exec:\n                                              properties:\n                                                command:\n                                                  items:\n                                                    type: string\n                                                  type: array\n                                              type: object\n                                            failureThreshold:\n                                              format: int32\n                                              type: integer\n                                            grpc:\n                                              properties:\n                                                port:\n                                                  format: int32\n                                                  type: integer\n                                                service:\n                                                  type: string\n                                              required:\n                                              - port\n                                              type: object\n                                            httpGet:\n                                              properties:\n                                                host:\n                                                  type: string\n                                                httpHeaders:\n                                                  items:\n                                                    properties:\n                                                      name:\n                                                        type: string\n                                                      value:\n                                                        type: string\n                                                    required:\n                                                    - name\n                                                    - value\n                                                    type: object\n                                                  type: array\n                                                path:\n                                                  type: string\n                                                port:\n                                                  anyOf:\n                                                  - type: integer\n                                                  - type: string\n                                                  x-kubernetes-int-or-string: true\n                                                scheme:\n                                                  type: string\n                                              required:\n                                              - port\n                                              type: object\n                                            initialDelaySeconds:\n                                              format: int32\n                                              type: integer\n                                            periodSeconds:\n                                              format: int32\n                                              type: integer\n                                            successThreshold:\n                                              format: int32\n                                              type: integer\n                                            tcpSocket:\n                                              properties:\n                                                host:\n                                                  type: string\n                                                port:\n                                                  anyOf:\n                                                  - type: integer\n                                                  - type: string\n                                                  x-kubernetes-int-or-string: true\n                                              required:\n                                              - port\n                                              type: object\n                                            terminationGracePeriodSeconds:\n                                              format: int64\n                                              type: integer\n                                            timeoutSeconds:\n                                              format: int32\n                                              type: integer\n                                          type: object\n                                        resources:\n                                          properties:\n                                            claims:\n                                              items:\n                                                properties:\n                                                  name:\n                                                    type: string\n                                                required:\n                                                - name\n                                                type: object\n                                              type: array\n                                              x-kubernetes-list-map-keys:\n                                              - name\n                                              x-kubernetes-list-type: map\n                                            limits:\n                                              additionalProperties:\n                                                anyOf:\n                                                - type: integer\n                                                - type: string\n                                                pattern: ^(\\+|-)?(([0-9]+(\\.[0-9]*)?)|(\\.[0-9]+))(([KMGTPE]i)|[numkMGTPE]|([eE](\\+|-)?(([0-9]+(\\.[0-9]*)?)|(\\.[0-9]+))))?$\n                                                x-kubernetes-int-or-string: true\n                                              type: object\n                                            requests:\n                                              additionalProperties:\n                                                anyOf:\n                                                - type: integer\n                                                - type: string\n                                                pattern: ^(\\+|-)?(([0-9]+(\\.[0-9]*)?)|(\\.[0-9]+))(([KMGTPE]i)|[numkMGTPE]|([eE](\\+|-)?(([0-9]+(\\.[0-9]*)?)|(\\.[0-9]+))))?$\n                                                x-kubernetes-int-or-string: true\n                                              type: object\n                                          type: object\n                                        securityContext:\n                                          properties:\n                                            allowPrivilegeEscalation:\n                                              type: boolean\n                                            capabilities:\n                                              properties:\n                                                add:\n                                                  items:\n                                                    type: string\n                                                  type: array\n                                                drop:\n                                                  items:\n                                                    type: string\n                                                  type: array\n                                              type: object\n                                            privileged:\n                                              type: boolean\n                                            procMount:\n                                              type: string\n                                            readOnlyRootFilesystem:\n                                              type: boolean\n                                            runAsGroup:\n                                              format: int64\n                                              type: integer\n                                            runAsNonRoot:\n                                              type: boolean\n                                            runAsUser:\n                                              format: int64\n                                              type: integer\n                                            seLinuxOptions:\n                                              properties:\n                                                level:\n                                                  type: string\n                                                role:\n                                                  type: string\n                                                type:\n                                                  type: string\n                                                user:\n                                                  type: string\n                                              type: object\n                                            seccompProfile:\n                                              properties:\n                                                localhostProfile:\n                                                  type: string\n                                                type:\n                                                  type: string\n                                              required:\n                                              - type\n                                              type: object\n                                            windowsOptions:\n                                              properties:\n                                                gmsaCredentialSpec:\n                                                  type: string\n                                                gmsaCredentialSpecName:\n                                                  type: string\n                                                hostProcess:\n                                                  type: boolean\n                                                runAsUserName:\n                                                  type: string\n                                              type: object\n                                          type: object\n                                        startupProbe:\n                                          properties:\n                                            exec:\n                                              properties:\n                                                command:\n                                                  items:\n                                                    type: string\n                                                  type: array\n                                              type: object\n                                            failureThreshold:\n                                              format: int32\n                                              type: integer\n                                            grpc:\n                                              properties:\n                                                port:\n                                                  format: int32\n                                                  type: integer\n                                                service:\n                                                  type: string\n                                              required:\n                                              - port\n                                              type: object\n                                            httpGet:\n                                              properties:\n                                                host:\n                                                  type: string\n                                                httpHeaders:\n                                                  items:\n                                                    properties:\n                                                      name:\n                                                        type: string\n                                                      value:\n                                                        type: string\n                                                    required:\n                                                    - name\n                                                    - value\n                                                    type: object\n                                                  type: array\n                                                path:\n                                                  type: string\n                                                port:\n                                                  anyOf:\n                                                  - type: integer\n                                                  - type: string\n                                                  x-kubernetes-int-or-string: true\n                                                scheme:\n                                                  type: string\n                                              required:\n                                              - port\n                                              type: object\n                                            initialDelaySeconds:\n                                              format: int32\n                                              type: integer\n                                            periodSeconds:\n                                              format: int32\n                                              type: integer\n                                            successThreshold:\n                                              format: int32\n                                              type: integer\n                                            tcpSocket:\n                                              properties:\n                                                host:\n                                                  type: string\n                                                port:\n                                                  anyOf:\n                                                  - type: integer\n                                                  - type: string\n                                                  x-kubernetes-int-or-string: true\n                                              required:\n                                              - port\n                                              type: object\n                                            terminationGracePeriodSeconds:\n                                              format: int64\n                                              type: integer\n                                            timeoutSeconds:\n                                              format: int32\n                                              type: integer\n                                          type: object\n                                        stdin:\n                                          type: boolean\n                                        stdinOnce:\n                                          type: boolean\n                                        terminationMessagePath:\n                                          type: string\n                                        terminationMessagePolicy:\n                                          type: string\n                                        tty:\n                                          type: boolean\n                                        volumeDevices:\n                                          items:\n                                            properties:\n                                              devicePath:\n                                                type: string\n                                              name:\n                                                type: string\n                                            required:\n                                            - devicePath\n                                            - name\n                                            type: object\n                                          type: array\n                                        volumeMounts:\n                                          items:\n                                            properties:\n                                              mountPath:\n                                                type: string\n                                              mountPropagation:\n                                                type: string\n                                              name:\n                                                type: string\n                                              readOnly:\n                                                type: boolean\n                                              subPath:\n                                                type: string\n                                              subPathExpr:\n                                                type: string\n                                            required:\n                                            - mountPath\n                                            - name\n                                            type: object\n                                          type: array\n                                        workingDir:\n                                          type: string\n                                      required:\n                                      - name\n                                      type: object\n                                    type: array\n                                  nodeName:\n                                    type: string\n                                  nodeSelector:\n                                    additionalProperties:\n                                      type: string\n                                    type: object\n                                    x-kubernetes-map-type: atomic\n                                  os:\n                                    properties:\n                                      name:\n                                        type: string\n                                    required:\n                                    - name\n                                    type: object\n                                  overhead:\n                                    additionalProperties:\n                                      anyOf:\n                                      - type: integer\n                                      - type: string\n                                      pattern: ^(\\+|-)?(([0-9]+(\\.[0-9]*)?)|(\\.[0-9]+))(([KMGTPE]i)|[numkMGTPE]|([eE](\\+|-)?(([0-9]+(\\.[0-9]*)?)|(\\.[0-9]+))))?$\n                                      x-kubernetes-int-or-string: true\n                                    type: object\n                                  preemptionPolicy:\n                                    type: string\n                                  priority:\n                                    format: int32\n                                    type: integer\n                                  priorityClassName:\n                                    type: string\n                                  readinessGates:\n                                    items:\n                                      properties:\n                                        conditionType:\n                                          type: string\n                                      required:\n                                      - conditionType\n                                      type: object\n                                    type: array\n                                  resourceClaims:\n                                    items:\n                                      properties:\n                                        name:\n                                          type: string\n                                        source:\n                                          properties:\n                                            resourceClaimName:\n                                              type: string\n                                            resourceClaimTemplateName:\n                                              type: string\n                                          type: object\n                                      required:\n                                      - name\n                                      type: object\n                                    type: array\n                                    x-kubernetes-list-map-keys:\n                                    - name\n                                    x-kubernetes-list-type: map\n                                  restartPolicy:\n                                    type: string\n                                  runtimeClassName:\n                                    type: string\n                                  schedulerName:\n                                    type: string\n                                  schedulingGates:\n                                    items:\n                                      properties:\n                                        name:\n                                          type: string\n                                      required:\n                                      - name\n                                      type: object\n                                    type: array\n                                    x-kubernetes-list-map-keys:\n                                    - name\n                                    x-kubernetes-list-type: map\n                                  securityContext:\n                                    properties:\n                                      fsGroup:\n                                        format: int64\n                                        type: integer\n                                      fsGroupChangePolicy:\n                                        type: string\n                                      runAsGroup:\n                                        format: int64\n                                        type: integer\n                                      runAsNonRoot:\n                                        type: boolean\n                                      runAsUser:\n                                        format: int64\n                                        type: integer\n                                      seLinuxOptions:\n                                        properties:\n                                          level:\n                                            type: string\n                                          role:\n                                            type: string\n                                          type:\n                                            type: string\n                                          user:\n                                            type: string\n                                        type: object\n                                      seccompProfile:\n                                        properties:\n                                          localhostProfile:\n                                            type: string\n                                          type:\n                                            type: string\n                                        required:\n                                        - type\n                                        type: object\n                                      supplementalGroups:\n                                        items:\n                                          format: int64\n                                          type: integer\n                                        type: array\n                                      sysctls:\n                                        items:\n                                          properties:\n                                            name:\n                                              type: string\n                                            value:\n                                              type: string\n                                          required:\n                                          - name\n                                          - value\n                                          type: object\n                                        type: array\n                                      windowsOptions:\n                                        properties:\n                                          gmsaCredentialSpec:\n                                            type: string\n                                          gmsaCredentialSpecName:\n                                            type: string\n                                          hostProcess:\n                                            type: boolean\n                                          runAsUserName:\n                                            type: string\n                                        type: object\n                                    type: object\n                                  serviceAccount:\n                                    type: string\n                                  serviceAccountName:\n                                    type: string\n                                  setHostnameAsFQDN:\n                                    type: boolean\n                                  shareProcessNamespace:\n                                    type: boolean\n                                  subdomain:\n                                    type: string\n                                  terminationGracePeriodSeconds:\n                                    format: int64\n                                    type: integer\n                                  tolerations:\n                                    items:\n                                      properties:\n                                        effect:\n                                          type: string\n                                        key:\n                                          type: string\n                                        operator:\n                                          type: string\n                                        tolerationSeconds:\n                                          format: int64\n                                          type: integer\n                                        value:\n                                          type: string\n                                      type: object\n                                    type: array\n                                  topologySpreadConstraints:\n                                    items:\n                                      properties:\n                                        labelSelector:\n                                          properties:\n                                            matchExpressions:\n                                              items:\n                                                properties:\n                                                  key:\n                                                    type: string\n                                                  operator:\n                                                    type: string\n                                                  values:\n                                                    items:\n                                                      type: string\n                                                    type: array\n                                                required:\n                                                - key\n                                                - operator\n                                                type: object\n                                              type: array\n                                            matchLabels:\n                                              additionalProperties:\n                                                type: string\n                                              type: object\n                                          type: object\n                                          x-kubernetes-map-type: atomic\n                                        matchLabelKeys:\n                                          items:\n                                            type: string\n                                          type: array\n                                          x-kubernetes-list-type: atomic\n                                        maxSkew:\n                                          format: int32\n                                          type: integer\n                                        minDomains:\n                                          format: int32\n                                          type: integer\n                                        nodeAffinityPolicy:\n                                          type: string\n                                        nodeTaintsPolicy:\n                                          type: string\n                                        topologyKey:\n                                          type: string\n                                        whenUnsatisfiable:\n                                          type: string\n                                      required:\n                                      - maxSkew\n                                      - topologyKey\n                                      - whenUnsatisfiable\n                                      type: object\n                                    type: array\n                                    x-kubernetes-list-map-keys:\n                                    - topologyKey\n                                    - whenUnsatisfiable\n                                    x-kubernetes-list-type: map\n                                  volumes:\n                                    items:\n                                      properties:\n                                        awsElasticBlockStore:\n                                          properties:\n                                            fsType:\n                                              type: string\n                                            partition:\n                                              format: int32\n                                              type: integer\n                                            readOnly:\n                                              type: boolean\n                                            volumeID:\n                                              type: string\n                                          required:\n                                          - volumeID\n                                          type: object\n                                        azureDisk:\n                                          properties:\n                                            cachingMode:\n                                              type: string\n                                            diskName:\n                                              type: string\n                                            diskURI:\n                                              type: string\n                                            fsType:\n                                              type: string\n                                            kind:\n                                              type: string\n                                            readOnly:\n                                              type: boolean\n                                          required:\n                                          - diskName\n                                          - diskURI\n                                          type: object\n                                        azureFile:\n                                          properties:\n                                            readOnly:\n                                              type: boolean\n                                            secretName:\n                                              type: string\n                                            shareName:\n                                              type: string\n                                          required:\n                                          - secretName\n                                          - shareName\n                                          type: object\n                                        cephfs:\n                                          properties:\n                                            monitors:\n                                              items:\n                                                type: string\n                                              type: array\n                                            path:\n                                              type: string\n                                            readOnly:\n                                              type: boolean\n                                            secretFile:\n                                              type: string\n                                            secretRef:\n                                              properties:\n                                                name:\n                                                  type: string\n                                              type: object\n                                              x-kubernetes-map-type: atomic\n                                            user:\n                                              type: string\n                                          required:\n                                          - monitors\n                                          type: object\n                                        cinder:\n                                          properties:\n                                            fsType:\n                                              type: string\n                                            readOnly:\n                                              type: boolean\n                                            secretRef:\n                                              properties:\n                                                name:\n                                                  type: string\n                                              type: object\n                                              x-kubernetes-map-type: atomic\n                                            volumeID:\n                                              type: string\n                                          required:\n                                          - volumeID\n                                          type: object\n                                        configMap:\n                                          properties:\n                                            defaultMode:\n                                              format: int32\n                                              type: integer\n                                            items:\n                                              items:\n                                                properties:\n                                                  key:\n                                                    type: string\n                                                  mode:\n                                                    format: int32\n                                                    type: integer\n                                                  path:\n                                                    type: string\n                                                required:\n                                                - key\n                                                - path\n                                                type: object\n                                              type: array\n                                            name:\n                                              type: string\n                                            optional:\n                                              type: boolean\n                                          type: object\n                                          x-kubernetes-map-type: atomic\n                                        csi:\n                                          properties:\n                                            driver:\n                                              type: string\n                                            fsType:\n                                              type: string\n                                            nodePublishSecretRef:\n                                              properties:\n                                                name:\n                                                  type: string\n                                              type: object\n                                              x-kubernetes-map-type: atomic\n                                            readOnly:\n                                              type: boolean\n                                            volumeAttributes:\n                                              additionalProperties:\n                                                type: string\n                                              type: object\n                                          required:\n                                          - driver\n                                          type: object\n                                        downwardAPI:\n                                          properties:\n                                            defaultMode:\n                                              format: int32\n                                              type: integer\n                                            items:\n                                              items:\n                                                properties:\n                                                  fieldRef:\n                                                    properties:\n                                                      apiVersion:\n                                                        type: string\n                                                      fieldPath:\n                                                        type: string\n                                                    required:\n                                                    - fieldPath\n                                                    type: object\n                                                    x-kubernetes-map-type: atomic\n                                                  mode:\n                                                    format: int32\n                                                    type: integer\n                                                  path:\n                                                    type: string\n                                                  resourceFieldRef:\n                                                    properties:\n                                                      containerName:\n                                                        type: string\n                                                      divisor:\n                                                        anyOf:\n                                                        - type: integer\n                                                        - type: string\n                                                        pattern: ^(\\+|-)?(([0-9]+(\\.[0-9]*)?)|(\\.[0-9]+))(([KMGTPE]i)|[numkMGTPE]|([eE](\\+|-)?(([0-9]+(\\.[0-9]*)?)|(\\.[0-9]+))))?$\n                                                        x-kubernetes-int-or-string: true\n                                                      resource:\n                                                        type: string\n                                                    required:\n                                                    - resource\n                                                    type: object\n                                                    x-kubernetes-map-type: atomic\n                                                required:\n                                                - path\n                                                type: object\n                                              type: array\n                                          type: object\n                                        emptyDir:\n                                          properties:\n                                            medium:\n                                              type: string\n                                            sizeLimit:\n                                              anyOf:\n                                              - type: integer\n                                              - type: string\n                                              pattern: ^(\\+|-)?(([0-9]+(\\.[0-9]*)?)|(\\.[0-9]+))(([KMGTPE]i)|[numkMGTPE]|([eE](\\+|-)?(([0-9]+(\\.[0-9]*)?)|(\\.[0-9]+))))?$\n                                              x-kubernetes-int-or-string: true\n                                          type: object\n                                        ephemeral:\n                                          properties:\n                                            volumeClaimTemplate:\n                                              properties:\n                                                metadata:\n                                                  type: object\n                                                spec:\n                                                  properties:\n                                                    accessModes:\n                                                      items:\n                                                        type: string\n                                                      type: array\n                                                    dataSource:\n                                                      properties:\n                                                        apiGroup:\n                                                          type: string\n                                                        kind:\n                                                          type: string\n                                                        name:\n                                                          type: string\n                                                      required:\n                                                      - kind\n                                                      - name\n                                                      type: object\n                                                      x-kubernetes-map-type: atomic\n                                                    dataSourceRef:\n                                                      properties:\n                                                        apiGroup:\n                                                          type: string\n                                                        kind:\n                                                          type: string\n                                                        name:\n                                                          type: string\n                                                        namespace:\n                                                          type: string\n                                                      required:\n                                                      - kind\n                                                      - name\n                                                      type: object\n                                                    resources:\n                                                      properties:\n                                                        claims:\n                                                          items:\n                                                            properties:\n                                                              name:\n                                                                type: string\n                                                            required:\n                                                            - name\n                                                            type: object\n                                                          type: array\n                                                          x-kubernetes-list-map-keys:\n                                                          - name\n                                                          x-kubernetes-list-type: map\n                                                        limits:\n                                                          additionalProperties:\n                                                            anyOf:\n                                                            - type: integer\n                                                            - type: string\n                                                            pattern: ^(\\+|-)?(([0-9]+(\\.[0-9]*)?)|(\\.[0-9]+))(([KMGTPE]i)|[numkMGTPE]|([eE](\\+|-)?(([0-9]+(\\.[0-9]*)?)|(\\.[0-9]+))))?$\n                                                            x-kubernetes-int-or-string: true\n                                                          type: object\n                                                        requests:\n                                                          additionalProperties:\n                                                            anyOf:\n                                                            - type: integer\n                                                            - type: string\n                                                            pattern: ^(\\+|-)?(([0-9]+(\\.[0-9]*)?)|(\\.[0-9]+))(([KMGTPE]i)|[numkMGTPE]|([eE](\\+|-)?(([0-9]+(\\.[0-9]*)?)|(\\.[0-9]+))))?$\n                                                            x-kubernetes-int-or-string: true\n                                                          type: object\n                                                      type: object\n                                                    selector:\n                                                      properties:\n                                                        matchExpressions:\n                                                          items:\n                                                            properties:\n                                                              key:\n                                                                type: string\n                                                              operator:\n                                                                type: string\n                                                              values:\n                                                                items:\n                                                                  type: string\n                                                                type: array\n                                                            required:\n                                                            - key\n                                                            - operator\n                                                            type: object\n                                                          type: array\n                                                        matchLabels:\n                                                          additionalProperties:\n                                                            type: string\n                                                          type: object\n                                                      type: object\n                                                      x-kubernetes-map-type: atomic\n                                                    storageClassName:\n                                                      type: string\n                                                    volumeMode:\n                                                      type: string\n                                                    volumeName:\n                                                      type: string\n                                                  type: object\n                                              required:\n                                              - spec\n                                              type: object\n                                          type: object\n                                        fc:\n                                          properties:\n                                            fsType:\n                                              type: string\n                                            lun:\n                                              format: int32\n                                              type: integer\n                                            readOnly:\n                                              type: boolean\n                                            targetWWNs:\n                                              items:\n                                                type: string\n                                              type: array\n                                            wwids:\n                                              items:\n                                                type: string\n                                              type: array\n                                          type: object\n                                        flexVolume:\n                                          properties:\n                                            driver:\n                                              type: string\n                                            fsType:\n                                              type: string\n                                            options:\n                                              additionalProperties:\n                                                type: string\n                                              type: object\n                                            readOnly:\n                                              type: boolean\n                                            secretRef:\n                                              properties:\n                                                name:\n                                                  type: string\n                                              type: object\n                                              x-kubernetes-map-type: atomic\n                                          required:\n                                          - driver\n                                          type: object\n                                        flocker:\n                                          properties:\n                                            datasetName:\n                                              type: string\n                                            datasetUUID:\n                                              type: string\n                                          type: object\n                                        gcePersistentDisk:\n                                          properties:\n                                            fsType:\n                                              type: string\n                                            partition:\n                                              format: int32\n                                              type: integer\n                                            pdName:\n                                              type: string\n                                            readOnly:\n                                              type: boolean\n                                          required:\n                                          - pdName\n                                          type: object\n                                        gitRepo:\n                                          properties:\n                                            directory:\n                                              type: string\n                                            repository:\n                                              type: string\n                                            revision:\n                                              type: string\n                                          required:\n                                          - repository\n                                          type: object\n                                        glusterfs:\n                                          properties:\n                                            endpoints:\n                                              type: string\n                                            path:\n                                              type: string\n                                            readOnly:\n                                              type: boolean\n                                          required:\n                                          - endpoints\n                                          - path\n                                          type: object\n                                        hostPath:\n                                          properties:\n                                            path:\n                                              type: string\n                                            type:\n                                              type: string\n                                          required:\n                                          - path\n                                          type: object\n                                        iscsi:\n                                          properties:\n                                            chapAuthDiscovery:\n                                              type: boolean\n                                            chapAuthSession:\n                                              type: boolean\n                                            fsType:\n                                              type: string\n                                            initiatorName:\n                                              type: string\n                                            iqn:\n                                              type: string\n                                            iscsiInterface:\n                                              type: string\n                                            lun:\n                                              format: int32\n                                              type: integer\n                                            portals:\n                                              items:\n                                                type: string\n                                              type: array\n                                            readOnly:\n                                              type: boolean\n                                            secretRef:\n                                              properties:\n                                                name:\n                                                  type: string\n                                              type: object\n                                              x-kubernetes-map-type: atomic\n                                            targetPortal:\n                                              type: string\n                                          required:\n                                          - iqn\n                                          - lun\n                                          - targetPortal\n                                          type: object\n                                        name:\n                                          type: string\n                                        nfs:\n                                          properties:\n                                            path:\n                                              type: string\n                                            readOnly:\n                                              type: boolean\n                                            server:\n                                              type: string\n                                          required:\n                                          - path\n                                          - server\n                                          type: object\n                                        persistentVolumeClaim:\n                                          properties:\n                                            claimName:\n                                              type: string\n                                            readOnly:\n                                              type: boolean\n                                          required:\n                                          - claimName\n                                          type: object\n                                        photonPersistentDisk:\n                                          properties:\n                                            fsType:\n                                              type: string\n                                            pdID:\n                                              type: string\n                                          required:\n                                          - pdID\n                                          type: object\n                                        portworxVolume:\n                                          properties:\n                                            fsType:\n                                              type: string\n                                            readOnly:\n                                              type: boolean\n                                            volumeID:\n                                              type: string\n                                          required:\n                                          - volumeID\n                                          type: object\n                                        projected:\n                                          properties:\n                                            defaultMode:\n                                              format: int32\n                                              type: integer\n                                            sources:\n                                              items:\n                                                properties:\n                                                  configMap:\n                                                    properties:\n                                                      items:\n                                                        items:\n                                                          properties:\n                                                            key:\n                                                              type: string\n                                                            mode:\n                                                              format: int32\n                                                              type: integer\n                                                            path:\n                                                              type: string\n                                                          required:\n                                                          - key\n                                                          - path\n                                                          type: object\n                                                        type: array\n                                                      name:\n                                                        type: string\n                                                      optional:\n                                                        type: boolean\n                                                    type: object\n                                                    x-kubernetes-map-type: atomic\n                                                  downwardAPI:\n                                                    properties:\n                                                      items:\n                                                        items:\n                                                          properties:\n                                                            fieldRef:\n                                                              properties:\n                                                                apiVersion:\n                                                                  type: string\n                                                                fieldPath:\n                                                                  type: string\n                                                              required:\n                                                              - fieldPath\n                                                              type: object\n                                                              x-kubernetes-map-type: atomic\n                                                            mode:\n                                                              format: int32\n                                                              type: integer\n                                                            path:\n                                                              type: string\n                                                            resourceFieldRef:\n                                                              properties:\n                                                                containerName:\n                                                                  type: string\n                                                                divisor:\n                                                                  anyOf:\n                                                                  - type: integer\n                                                                  - type: string\n                                                                  pattern: ^(\\+|-)?(([0-9]+(\\.[0-9]*)?)|(\\.[0-9]+))(([KMGTPE]i)|[numkMGTPE]|([eE](\\+|-)?(([0-9]+(\\.[0-9]*)?)|(\\.[0-9]+))))?$\n                                                                  x-kubernetes-int-or-string: true\n                                                                resource:\n                                                                  type: string\n                                                              required:\n                                                              - resource\n                                                              type: object\n                                                              x-kubernetes-map-type: atomic\n                                                          required:\n                                                          - path\n                                                          type: object\n                                                        type: array\n                                                    type: object\n                                                  secret:\n                                                    properties:\n                                                      items:\n                                                        items:\n                                                          properties:\n                                                            key:\n                                                              type: string\n                                                            mode:\n                                                              format: int32\n                                                              type: integer\n                                                            path:\n                                                              type: string\n                                                          required:\n                                                          - key\n                                                          - path\n                                                          type: object\n                                                        type: array\n                                                      name:\n                                                        type: string\n                                                      optional:\n                                                        type: boolean\n                                                    type: object\n                                                    x-kubernetes-map-type: atomic\n                                                  serviceAccountToken:\n                                                    properties:\n                                                      audience:\n                                                        type: string\n                                                      expirationSeconds:\n                                                        format: int64\n                                                        type: integer\n                                                      path:\n                                                        type: string\n                                                    required:\n                                                    - path\n                                                    type: object\n                                                type: object\n                                              type: array\n                                          type: object\n                                        quobyte:\n                                          properties:\n                                            group:\n                                              type: string\n                                            readOnly:\n                                              type: boolean\n                                            registry:\n                                              type: string\n                                            tenant:\n                                              type: string\n                                            user:\n                                              type: string\n                                            volume:\n                                              type: string\n                                          required:\n                                          - registry\n                                          - volume\n                                          type: object\n                                        rbd:\n                                          properties:\n                                            fsType:\n                                              type: string\n                                            image:\n                                              type: string\n                                            keyring:\n                                              type: string\n                                            monitors:\n                                              items:\n                                                type: string\n                                              type: array\n                                            pool:\n                                              type: string\n                                            readOnly:\n                                              type: boolean\n                                            secretRef:\n                                              properties:\n                                                name:\n                                                  type: string\n                                              type: object\n                                              x-kubernetes-map-type: atomic\n                                            user:\n                                              type: string\n                                          required:\n                                          - image\n                                          - monitors\n                                          type: object\n                                        scaleIO:\n                                          properties:\n                                            fsType:\n                                              type: string\n                                            gateway:\n                                              type: string\n                                            protectionDomain:\n                                              type: string\n                                            readOnly:\n                                              type: boolean\n                                            secretRef:\n                                              properties:\n                                                name:\n                                                  type: string\n                                              type: object\n                                              x-kubernetes-map-type: atomic\n                                            sslEnabled:\n                                              type: boolean\n                                            storageMode:\n                                              type: string\n                                            storagePool:\n                                              type: string\n                                            system:\n                                              type: string\n                                            volumeName:\n                                              type: string\n                                          required:\n                                          - gateway\n                                          - secretRef\n                                          - system\n                                          type: object\n                                        secret:\n                                          properties:\n                                            defaultMode:\n                                              format: int32\n                                              type: integer\n                                            items:\n                                              items:\n                                                properties:\n                                                  key:\n                                                    type: string\n                                                  mode:\n                                                    format: int32\n                                                    type: integer\n                                                  path:\n                                                    type: string\n                                                required:\n                                                - key\n                                                - path\n                                                type: object\n                                              type: array\n                                            optional:\n                                              type: boolean\n                                            secretName:\n                                              type: string\n                                          type: object\n                                        storageos:\n                                          properties:\n                                            fsType:\n                                              type: string\n                                            readOnly:\n                                              type: boolean\n                                            secretRef:\n                                              properties:\n                                                name:\n                                                  type: string\n                                              type: object\n                                              x-kubernetes-map-type: atomic\n                                            volumeName:\n                                              type: string\n                                            volumeNamespace:\n                                              type: string\n                                          type: object\n                                        vsphereVolume:\n                                          properties:\n                                            fsType:\n                                              type: string\n                                            storagePolicyID:\n                                              type: string\n                                            storagePolicyName:\n                                              type: string\n                                            volumePath:\n                                              type: string\n                                          required:\n                                          - volumePath\n                                          type: object\n                                      required:\n                                      - name\n                                      type: object\n                                    type: array\n                                required:\n                                - containers\n                                type: object\n                            type: object\n                          updateStrategy:\n                            properties:\n                              rollingUpdate:\n                                properties:\n                                  maxUnavailable:\n                                    anyOf:\n                                    - type: integer\n                                    - type: string\n                                    x-kubernetes-int-or-string: true\n                                  partition:\n                                    format: int32\n                                    type: integer\n                                type: object\n                              type:\n                                type: string\n                            type: object\n                          volumeClaimTemplates:\n                            items:\n                              properties:\n                                apiVersion:\n                                  type: string\n                                kind:\n                                  type: string\n                                metadata:\n                                  properties:\n                                    annotations:\n                                      additionalProperties:\n                                        type: string\n                                      type: object\n                                    labels:\n                                      additionalProperties:\n                                        type: string\n                                      type: object\n                                    name:\n                                      type: string\n                                    namespace:\n                                      type: string\n                                  type: object\n                                spec:\n                                  properties:\n                                    accessModes:\n                                      items:\n                                        type: string\n                                      type: array\n                                    dataSource:\n                                      properties:\n                                        apiGroup:\n                                          type: string\n                                        kind:\n                                          type: string\n                                        name:\n                                          type: string\n                                      required:\n                                      - kind\n                                      - name\n                                      type: object\n                                      x-kubernetes-map-type: atomic\n                                    dataSourceRef:\n                                      properties:\n                                        apiGroup:\n                                          type: string\n                                        kind:\n                                          type: string\n                                        name:\n                                          type: string\n                                        namespace:\n                                          type: string\n                                      required:\n                                      - kind\n                                      - name\n                                      type: object\n                                    resources:\n                                      properties:\n                                        claims:\n                                          items:\n                                            properties:\n                                              name:\n                                                type: string\n                                            required:\n                                            - name\n                                            type: object\n                                          type: array\n                                          x-kubernetes-list-map-keys:\n                                          - name\n                                          x-kubernetes-list-type: map\n                                        limits:\n                                          additionalProperties:\n                                            anyOf:\n                                            - type: integer\n                                            - type: string\n                                            pattern: ^(\\+|-)?(([0-9]+(\\.[0-9]*)?)|(\\.[0-9]+))(([KMGTPE]i)|[numkMGTPE]|([eE](\\+|-)?(([0-9]+(\\.[0-9]*)?)|(\\.[0-9]+))))?$\n                                            x-kubernetes-int-or-string: true\n                                          type: object\n                                        requests:\n                                          additionalProperties:\n                                            anyOf:\n                                            - type: integer\n                                            - type: string\n                                            pattern: ^(\\+|-)?(([0-9]+(\\.[0-9]*)?)|(\\.[0-9]+))(([KMGTPE]i)|[numkMGTPE]|([eE](\\+|-)?(([0-9]+(\\.[0-9]*)?)|(\\.[0-9]+))))?$\n                                            x-kubernetes-int-or-string: true\n                                          type: object\n                                      type: object\n                                    selector:\n                                      properties:\n                                        matchExpressions:\n                                          items:\n                                            properties:\n                                              key:\n                                                type: string\n                                              operator:\n                                                type: string\n                                              values:\n                                                items:\n                                                  type: string\n                                                type: array\n                                            required:\n                                            - key\n                                            - operator\n                                            type: object\n                                          type: array\n                                        matchLabels:\n                                          additionalProperties:\n                                            type: string\n                                          type: object\n                                      type: object\n                                      x-kubernetes-map-type: atomic\n                                    storageClassName:\n                                      type: string\n                                    volumeMode:\n                                      type: string\n                                    volumeName:\n                                      type: string\n                                  type: object\n                              type: object\n                            type: array\n                        type: object\n                    type: object\n                type: object\n              persistence:\n                default:\n                  storage: 10Gi\n                description: The desired persistent storage configuration for each\n                  Pod in the cluster.\n                properties:\n                  storage:\n                    anyOf:\n                    - type: integer\n                    - type: string\n                    default: 10Gi\n                    description: The requested size of the persistent volume attached\n                      to each Pod in the RabbitmqCluster. The format of this field\n                      matches that defined by kubernetes/apimachinery. See https://pkg.go.dev/k8s.io/apimachinery/pkg/api/resource#Quantity\n                      for more info on the format of this field.\n                    pattern: ^(\\+|-)?(([0-9]+(\\.[0-9]*)?)|(\\.[0-9]+))(([KMGTPE]i)|[numkMGTPE]|([eE](\\+|-)?(([0-9]+(\\.[0-9]*)?)|(\\.[0-9]+))))?$\n                    x-kubernetes-int-or-string: true\n                  storageClassName:\n                    description: The name of the StorageClass to claim a PersistentVolume\n                      from.\n                    type: string\n                type: object\n              rabbitmq:\n                description: Configuration options for RabbitMQ Pods created in the\n                  cluster.\n                properties:\n                  additionalConfig:\n                    description: Modify to add to the rabbitmq.conf file in addition\n                      to default configurations set by the operator. Modifying this\n                      property on an existing RabbitmqCluster will trigger a StatefulSet\n                      rolling restart and will cause rabbitmq downtime. For more information\n                      on this config, see https://www.rabbitmq.com/configure.html#config-file\n                    maxLength: 2000\n                    type: string\n                  additionalPlugins:\n                    description: 'List of plugins to enable in addition to essential\n                      plugins: rabbitmq_management, rabbitmq_prometheus, and rabbitmq_peer_discovery_k8s.'\n                    items:\n                      description: A Plugin to enable on the RabbitmqCluster.\n                      maxLength: 100\n                      pattern: ^\\w+$\n                      type: string\n                    maxItems: 100\n                    type: array\n                  advancedConfig:\n                    description: Specify any rabbitmq advanced.config configurations\n                      to apply to the cluster. For more information on advanced config,\n                      see https://www.rabbitmq.com/configure.html#advanced-config-file\n                    maxLength: 100000\n                    type: string\n                  envConfig:\n                    description: Modify to add to the rabbitmq-env.conf file. Modifying\n                      this property on an existing RabbitmqCluster will trigger a\n                      StatefulSet rolling restart and will cause rabbitmq downtime.\n                      For more information on env config, see https://www.rabbitmq.com/man/rabbitmq-env.conf.5.html\n                    maxLength: 100000\n                    type: string\n                type: object\n              replicas:\n                default: 1\n                description: Replicas is the number of nodes in the RabbitMQ cluster.\n                  Each node is deployed as a Replica in a StatefulSet. Only 1, 3,\n                  5 replicas clusters are tested. This value should be an odd number\n                  to ensure the resultant cluster can establish exactly one quorum\n                  of nodes in the event of a fragmenting network partition.\n                format: int32\n                minimum: 0\n                type: integer\n              resources:\n                default:\n                  limits:\n                    cpu: 2000m\n                    memory: 2Gi\n                  requests:\n                    cpu: 1000m\n                    memory: 2Gi\n                description: The desired compute resource requirements of Pods in\n                  the cluster.\n                properties:\n                  claims:\n                    description: \"Claims lists the names of resources, defined in\n                      spec.resourceClaims, that are used by this container. \\n This\n                      is an alpha field and requires enabling the DynamicResourceAllocation\n                      feature gate. \\n This field is immutable.\"\n                    items:\n                      description: ResourceClaim references one entry in PodSpec.ResourceClaims.\n                      properties:\n                        name:\n                          description: Name must match the name of one entry in pod.spec.resourceClaims\n                            of the Pod where this field is used. It makes that resource\n                            available inside a container.\n                          type: string\n                      required:\n                      - name\n                      type: object\n                    type: array\n                    x-kubernetes-list-map-keys:\n                    - name\n                    x-kubernetes-list-type: map\n                  limits:\n                    additionalProperties:\n                      anyOf:\n                      - type: integer\n                      - type: string\n                      pattern: ^(\\+|-)?(([0-9]+(\\.[0-9]*)?)|(\\.[0-9]+))(([KMGTPE]i)|[numkMGTPE]|([eE](\\+|-)?(([0-9]+(\\.[0-9]*)?)|(\\.[0-9]+))))?$\n                      x-kubernetes-int-or-string: true\n                    description: 'Limits describes the maximum amount of compute resources\n                      allowed. More info: https://kubernetes.io/docs/concepts/configuration/manage-resources-containers/'\n                    type: object\n                  requests:\n                    additionalProperties:\n                      anyOf:\n                      - type: integer\n                      - type: string\n                      pattern: ^(\\+|-)?(([0-9]+(\\.[0-9]*)?)|(\\.[0-9]+))(([KMGTPE]i)|[numkMGTPE]|([eE](\\+|-)?(([0-9]+(\\.[0-9]*)?)|(\\.[0-9]+))))?$\n                      x-kubernetes-int-or-string: true\n                    description: 'Requests describes the minimum amount of compute\n                      resources required. If Requests is omitted for a container,\n                      it defaults to Limits if that is explicitly specified, otherwise\n                      to an implementation-defined value. More info: https://kubernetes.io/docs/concepts/configuration/manage-resources-containers/'\n                    type: object\n                type: object\n              secretBackend:\n                description: Secret backend configuration for the RabbitmqCluster.\n                  Enables to fetch default user credentials and certificates from\n                  K8s external secret stores.\n                properties:\n                  externalSecret:\n                    description: LocalObjectReference contains enough information\n                      to let you locate the referenced object inside the same namespace.\n                    properties:\n                      name:\n                        description: 'Name of the referent. More info: https://kubernetes.io/docs/concepts/overview/working-with-objects/names/#names\n                          TODO: Add other useful fields. apiVersion, kind, uid?'\n                        type: string\n                    type: object\n                    x-kubernetes-map-type: atomic\n                  vault:\n                    description: VaultSpec will add Vault annotations (see https://www.vaultproject.io/docs/platform/k8s/injector/annotations)\n                      to RabbitMQ Pods. It requires a Vault Agent Sidecar Injector\n                      (https://www.vaultproject.io/docs/platform/k8s/injector) to\n                      be installed in the K8s cluster. The injector is a K8s Mutation\n                      Webhook Controller that alters RabbitMQ Pod specifications (based\n                      on the added Vault annotations) to include Vault Agent containers\n                      that render Vault secrets to the volume.\n                    properties:\n                      annotations:\n                        additionalProperties:\n                          type: string\n                        description: Vault annotations that override the Vault annotations\n                          set by the cluster-operator. For a list of valid Vault annotations,\n                          see https://www.vaultproject.io/docs/platform/k8s/injector/annotations\n                        type: object\n                      defaultUserPath:\n                        description: Path in Vault to access a KV (Key-Value) secret\n                          with the fields username and password for the default user.\n                          For example \"secret/data/rabbitmq/config\".\n                        type: string\n                      defaultUserUpdaterImage:\n                        description: Sidecar container that updates the default user's\n                          password in RabbitMQ when it changes in Vault. Additionally,\n                          it updates /var/lib/rabbitmq/.rabbitmqadmin.conf (used by\n                          rabbitmqadmin CLI). Set to empty string to disable the sidecar\n                          container.\n                        type: string\n                      role:\n                        description: Role in Vault. If vault.defaultUserPath is set,\n                          this role must have capability to read the pre-created default\n                          user credential in Vault. If vault.tls is set, this role\n                          must have capability to create and update certificates in\n                          the Vault PKI engine for the domains \"&lt;namespace&gt;\" and \"&lt;namespace&gt;.svc\".\n                        type: string\n                      tls:\n                        properties:\n                          altNames:\n                            description: 'Specifies the requested Subject Alternative\n                              Names (SANs), in a comma-delimited list. These will\n                              be appended to the SANs added by the cluster-operator.\n                              The cluster-operator will add SANs: \"&lt;RabbitmqCluster\n                              name&gt;-server-&lt;index&gt;.&lt;RabbitmqCluster name&gt;-nodes.&lt;namespace&gt;\"\n                              for each pod, e.g. \"myrabbit-server-0.myrabbit-nodes.default\".'\n                            type: string\n                          commonName:\n                            description: Specifies the requested certificate Common\n                              Name (CN). Defaults to &lt;serviceName&gt;.&lt;namespace&gt;.svc\n                              if not provided.\n                            type: string\n                          ipSans:\n                            description: Specifies the requested IP Subject Alternative\n                              Names, in a comma-delimited list.\n                            type: string\n                          pkiIssuerPath:\n                            description: Path in Vault PKI engine. For example \"pki/issue/hashicorp-com\".\n                              required\n                            type: string\n                        type: object\n                    type: object\n                type: object\n              service:\n                default:\n                  type: ClusterIP\n                description: The desired state of the Kubernetes Service to create\n                  for the cluster.\n                properties:\n                  annotations:\n                    additionalProperties:\n                      type: string\n                    description: Annotations to add to the Service.\n                    type: object\n                  type:\n                    default: ClusterIP\n                    description: 'Type of Service to create for the cluster. Must\n                      be one of: ClusterIP, LoadBalancer, NodePort. For more info\n                      see https://pkg.go.dev/k8s.io/api/core/v1#ServiceType'\n                    enum:\n                    - ClusterIP\n                    - LoadBalancer\n                    - NodePort\n                    type: string\n                type: object\n              skipPostDeploySteps:\n                description: If unset, or set to false, the cluster will run `rabbitmq-queues\n                  rebalance all` whenever the cluster is updated. Set to true to prevent\n                  the operator rebalancing queue leaders after a cluster update. Has\n                  no effect if the cluster only consists of one node. For more information,\n                  see https://www.rabbitmq.com/rabbitmq-queues.8.html#rebalance\n                type: boolean\n              terminationGracePeriodSeconds:\n                default: 604800\n                description: 'TerminationGracePeriodSeconds is the timeout that each\n                  rabbitmqcluster pod will have to terminate gracefully. It defaults\n                  to 604800 seconds ( a week long) to ensure that the container preStop\n                  lifecycle hook can finish running. For more information, see: https://github.com/rabbitmq/cluster-operator/blob/main/docs/design/20200520-graceful-pod-termination.md'\n                format: int64\n                minimum: 0\n                type: integer\n              tls:\n                description: TLS-related configuration for the RabbitMQ cluster.\n                properties:\n                  caSecretName:\n                    description: Name of a Secret in the same Namespace as the RabbitmqCluster,\n                      containing the Certificate Authority's public certificate for\n                      TLS. The Secret must store this as ca.crt. This Secret can be\n                      created by running `kubectl create secret generic ca-secret\n                      --from-file=ca.crt=path/to/ca.cert` Used for mTLS, and TLS for\n                      rabbitmq_web_stomp and rabbitmq_web_mqtt.\n                    type: string\n                  disableNonTLSListeners:\n                    description: 'When set to true, the RabbitmqCluster disables non-TLS\n                      listeners for RabbitMQ, management plugin and for any enabled\n                      plugins in the following list: stomp, mqtt, web_stomp, web_mqtt.\n                      Only TLS-enabled clients will be able to connect.'\n                    type: boolean\n                  secretName:\n                    description: Name of a Secret in the same Namespace as the RabbitmqCluster,\n                      containing the server's private key &amp; public certificate for\n                      TLS. The Secret must store these as tls.key and tls.crt, respectively.\n                      This Secret can be created by running `kubectl create secret\n                      tls tls-secret --cert=path/to/tls.cert --key=path/to/tls.key`\n                    type: string\n                type: object\n              tolerations:\n                description: Tolerations is the list of Toleration resources attached\n                  to each Pod in the RabbitmqCluster.\n                items:\n                  description: The pod this Toleration is attached to tolerates any\n                    taint that matches the triple &lt;key,value,effect&gt; using the matching\n                    operator &lt;operator&gt;.\n                  properties:\n                    effect:\n                      description: Effect indicates the taint effect to match. Empty\n                        means match all taint effects. When specified, allowed values\n                        are NoSchedule, PreferNoSchedule and NoExecute.\n                      type: string\n                    key:\n                      description: Key is the taint key that the toleration applies\n                        to. Empty means match all taint keys. If the key is empty,\n                        operator must be Exists; this combination means to match all\n                        values and all keys.\n                      type: string\n                    operator:\n                      description: Operator represents a key's relationship to the\n                        value. Valid operators are Exists and Equal. Defaults to Equal.\n                        Exists is equivalent to wildcard for value, so that a pod\n                        can tolerate all taints of a particular category.\n                      type: string\n                    tolerationSeconds:\n                      description: TolerationSeconds represents the period of time\n                        the toleration (which must be of effect NoExecute, otherwise\n                        this field is ignored) tolerates the taint. By default, it\n                        is not set, which means tolerate the taint forever (do not\n                        evict). Zero and negative values will be treated as 0 (evict\n                        immediately) by the system.\n                      format: int64\n                      type: integer\n                    value:\n                      description: Value is the taint value the toleration matches\n                        to. If the operator is Exists, the value should be empty,\n                        otherwise just a regular string.\n                      type: string\n                  type: object\n                type: array\n            type: object\n          status:\n            description: Status presents the observed state of RabbitmqCluster\n            properties:\n              binding:\n                description: 'Binding exposes a secret containing the binding information\n                  for this RabbitmqCluster. It implements the service binding Provisioned\n                  Service duck type. See: https://github.com/servicebinding/spec#provisioned-service'\n                properties:\n                  name:\n                    description: 'Name of the referent. More info: https://kubernetes.io/docs/concepts/overview/working-with-objects/names/#names\n                      TODO: Add other useful fields. apiVersion, kind, uid?'\n                    type: string\n                type: object\n                x-kubernetes-map-type: atomic\n              conditions:\n                description: Set of Conditions describing the current state of the\n                  RabbitmqCluster\n                items:\n                  properties:\n                    lastTransitionTime:\n                      description: The last time this Condition type changed.\n                      format: date-time\n                      type: string\n                    message:\n                      description: Full text reason for current status of the condition.\n                      type: string\n                    reason:\n                      description: One word, camel-case reason for current status\n                        of the condition.\n                      type: string\n                    status:\n                      description: True, False, or Unknown\n                      type: string\n                    type:\n                      description: Type indicates the scope of RabbitmqCluster status\n                        addressed by the condition.\n                      type: string\n                  required:\n                  - status\n                  - type\n                  type: object\n                type: array\n              defaultUser:\n                description: Identifying information on internal resources\n                properties:\n                  secretReference:\n                    description: Reference to the Kubernetes Secret containing the\n                      credentials of the default user.\n                    properties:\n                      keys:\n                        additionalProperties:\n                          type: string\n                        description: Key-value pairs in the Secret corresponding to\n                          `username`, `password`, `host`, and `port`\n                        type: object\n                      name:\n                        description: Name of the Secret containing the default user\n                          credentials\n                        type: string\n                      namespace:\n                        description: Namespace of the Secret containing the default\n                          user credentials\n                        type: string\n                    required:\n                    - keys\n                    - name\n                    - namespace\n                    type: object\n                  serviceReference:\n                    description: Reference to the Kubernetes Service serving the cluster.\n                    properties:\n                      name:\n                        description: Name of the Service serving the cluster\n                        type: string\n                      namespace:\n                        description: Namespace of the Service serving the cluster\n                        type: string\n                    required:\n                    - name\n                    - namespace\n                    type: object\n                type: object\n              observedGeneration:\n                description: observedGeneration is the most recent successful generation\n                  observed for this RabbitmqCluster. It corresponds to the RabbitmqCluster's\n                  generation, which is updated on mutation by the API Server.\n                format: int64\n                type: integer\n            required:\n            - conditions\n            type: object\n        type: object\n    served: true\n    storage: true\n    subresources:\n      status: {}\n---\napiVersion: v1\nkind: ServiceAccount\nmetadata:\n  name: rabbitmq-cluster-operator\n  namespace: rabbitmq-system\n---\napiVersion: rbac.authorization.k8s.io/v1\nkind: Role\nmetadata:\n  labels:\n    app.kubernetes.io/component: rabbitmq-operator\n    app.kubernetes.io/name: rabbitmq-cluster-operator\n    app.kubernetes.io/part-of: rabbitmq\n  name: rabbitmq-cluster-leader-election-role\n  namespace: rabbitmq-system\nrules:\n- apiGroups:\n  - coordination.k8s.io\n  resources:\n  - leases\n  verbs:\n  - get\n  - list\n  - watch\n  - create\n  - update\n  - patch\n  - delete\n- apiGroups:\n  - \"\"\n  resources:\n  - events\n  verbs:\n  - create\n---\napiVersion: rbac.authorization.k8s.io/v1\nkind: ClusterRole\nmetadata:\n  labels:\n    app.kubernetes.io/component: rabbitmq-operator\n    app.kubernetes.io/name: rabbitmq-cluster-operator\n    app.kubernetes.io/part-of: rabbitmq\n  name: rabbitmq-cluster-operator-role\nrules:\n- apiGroups:\n  - \"\"\n  resources:\n  - configmaps\n  verbs:\n  - create\n  - get\n  - list\n  - update\n  - watch\n- apiGroups:\n  - \"\"\n  resources:\n  - endpoints\n  verbs:\n  - get\n  - list\n  - watch\n- apiGroups:\n  - \"\"\n  resources:\n  - events\n  verbs:\n  - create\n  - get\n  - patch\n- apiGroups:\n  - \"\"\n  resources:\n  - persistentvolumeclaims\n  verbs:\n  - create\n  - get\n  - list\n  - update\n  - watch\n- apiGroups:\n  - \"\"\n  resources:\n  - pods\n  verbs:\n  - get\n  - list\n  - update\n  - watch\n- apiGroups:\n  - \"\"\n  resources:\n  - pods/exec\n  verbs:\n  - create\n- apiGroups:\n  - \"\"\n  resources:\n  - secrets\n  verbs:\n  - create\n  - get\n  - list\n  - update\n  - watch\n- apiGroups:\n  - \"\"\n  resources:\n  - serviceaccounts\n  verbs:\n  - create\n  - get\n  - list\n  - update\n  - watch\n- apiGroups:\n  - \"\"\n  resources:\n  - services\n  verbs:\n  - create\n  - get\n  - list\n  - update\n  - watch\n- apiGroups:\n  - apps\n  resources:\n  - statefulsets\n  verbs:\n  - create\n  - delete\n  - get\n  - list\n  - update\n  - watch\n- apiGroups:\n  - rabbitmq.com\n  resources:\n  - rabbitmqclusters\n  verbs:\n  - create\n  - get\n  - list\n  - update\n  - watch\n- apiGroups:\n  - rabbitmq.com\n  resources:\n  - rabbitmqclusters/finalizers\n  verbs:\n  - update\n- apiGroups:\n  - rabbitmq.com\n  resources:\n  - rabbitmqclusters/status\n  verbs:\n  - get\n  - update\n- apiGroups:\n  - rbac.authorization.k8s.io\n  resources:\n  - rolebindings\n  verbs:\n  - create\n  - get\n  - list\n  - update\n  - watch\n- apiGroups:\n  - rbac.authorization.k8s.io\n  resources:\n  - roles\n  verbs:\n  - create\n  - get\n  - list\n  - update\n  - watch\n---\napiVersion: rbac.authorization.k8s.io/v1\nkind: ClusterRole\nmetadata:\n  labels:\n    app.kubernetes.io/component: rabbitmq-operator\n    app.kubernetes.io/name: rabbitmq-cluster-operator\n    app.kubernetes.io/part-of: rabbitmq\n    servicebinding.io/controller: \"true\"\n  name: rabbitmq-cluster-service-binding-role\nrules:\n- apiGroups:\n  - rabbitmq.com\n  resources:\n  - rabbitmqclusters\n  verbs:\n  - get\n  - list\n  - watch\n---\napiVersion: rbac.authorization.k8s.io/v1\nkind: RoleBinding\nmetadata:\n  labels:\n    app.kubernetes.io/component: rabbitmq-operator\n    app.kubernetes.io/name: rabbitmq-cluster-operator\n    app.kubernetes.io/part-of: rabbitmq\n  name: rabbitmq-cluster-leader-election-rolebinding\n  namespace: rabbitmq-system\nroleRef:\n  apiGroup: rbac.authorization.k8s.io\n  kind: Role\n  name: rabbitmq-cluster-leader-election-role\nsubjects:\n- kind: ServiceAccount\n  name: rabbitmq-cluster-operator\n  namespace: rabbitmq-system\n---\napiVersion: rbac.authorization.k8s.io/v1\nkind: ClusterRoleBinding\nmetadata:\n  labels:\n    app.kubernetes.io/component: rabbitmq-operator\n    app.kubernetes.io/name: rabbitmq-cluster-operator\n    app.kubernetes.io/part-of: rabbitmq\n  name: rabbitmq-cluster-operator-rolebinding\nroleRef:\n  apiGroup: rbac.authorization.k8s.io\n  kind: ClusterRole\n  name: rabbitmq-cluster-operator-role\nsubjects:\n- kind: ServiceAccount\n  name: rabbitmq-cluster-operator\n  namespace: rabbitmq-system\n---\napiVersion: apps/v1\nkind: Deployment\nmetadata:\n  labels:\n    app.kubernetes.io/component: rabbitmq-operator\n    app.kubernetes.io/name: rabbitmq-cluster-operator\n    app.kubernetes.io/part-of: rabbitmq\n  name: rabbitmq-cluster-operator\n  namespace: rabbitmq-system\nspec:\n  replicas: 1\n  selector:\n    matchLabels:\n      app.kubernetes.io/name: rabbitmq-cluster-operator\n  template:\n    metadata:\n      labels:\n        app.kubernetes.io/component: rabbitmq-operator\n        app.kubernetes.io/name: rabbitmq-cluster-operator\n        app.kubernetes.io/part-of: rabbitmq\n    spec:\n      containers:\n      - command:\n        - /manager\n        env:\n        - name: OPERATOR_NAMESPACE\n          valueFrom:\n            fieldRef:\n              fieldPath: metadata.namespace\n        image: harbor.dockerregistry.com/gitops/rabbitmqoperator/cluster-operator:2.2.0\n        name: operator\n        ports:\n        - containerPort: 9782\n          name: metrics\n          protocol: TCP\n        resources:\n          limits:\n            cpu: 200m\n            memory: 500Mi\n          requests:\n            cpu: 200m\n            memory: 500Mi\n      serviceAccountName: rabbitmq-cluster-operator\n      terminationGracePeriodSeconds: 10\n</code></pre>"},{"location":"helm/Install-Rabbitmq-Cluster/#rabbitmq-clusteryaml","title":"rabbitmq-cluster.yaml","text":"<pre><code>apiVersion: rabbitmq.com/v1beta1\nkind: RabbitmqCluster\nmetadata:\n  namespace: rabbitmq-system\n  name: rabbitmq-cluster\n  labels:\n    app: rabbitmq-cluster\nspec:\n  replicas: 3\n  image: harbor.dockerregistry.com/gitops/rabbitmq:3.9.29-management\n  resources:\n    limits:\n      cpu: 2\n      memory: 4Gi\n    requests:\n      cpu: 100m\n      memory: 500Mi\n  rabbitmq:\n    additionalConfig: |\n      default_user=admin\n      default_pass=admin@123\n</code></pre>"},{"location":"helm/Install-Rabbitmq-Cluster/#rabbitmq-cluster-externalyaml","title":"rabbitmq-cluster-external.yaml","text":"<pre><code>---\nkind: Service\napiVersion: v1\nmetadata:\n  name: rabbitmq-cluster-external\n  namespace: rabbitmq-system\n  labels:\n    app: rabbitmq-cluster-external\nspec:\n  ports:\n    - name: management\n      protocol: TCP\n      port: 15672\n      targetPort: 15672\n      nodePort: 31672\n    - name: client\n      protocol: TCP\n      port: 5672\n      targetPort: 5672\n      nodePort: 30672\n  selector:\n    app.kubernetes.io/name: rabbitmq-cluster\n  type: NodePort\n</code></pre>"},{"location":"helm/Install-Runner-IN-Kubernetes/","title":"Install Runner IN Kubernetes","text":""},{"location":"helm/Install-Runner-IN-Kubernetes/#1-pull-runner","title":"1 Pull runner","text":"<pre><code>helm repo add gitlab https://charts.gitlab.io\nhelm repo update gitlab\nhelm search repo -l gitlab/gitlab-runner | grep 15.11\n\n\ncd ~\nmkdir -p gitlab-runner &amp;&amp; cd gitlab-runner\nhelm pull gitlab/gitlab-runner --version v0.52.1\ntar xf gitlab-runner-0.52.1.tgz \ncp gitlab-runner/values.yaml{,.bak} \n\n\nroot@master1:~/gitlab-runner# ll \ntotal 28\ndrwxr-xr-x 4 root root  4096 Dec  7 10:01 gitlab-runner\n-rw-r--r-- 1 root root 23737 Dec  7 10:01 gitlab-runner-0.52.1.tgz\nroot@master1:~/gitlab-runner# ll gitlab-runner\ntotal 100\n-rw-r--r-- 1 root root 14127 Jun  2  2023 CHANGELOG.md\n-rw-r--r-- 1 root root   411 Jun  2  2023 Chart.yaml\n-rw-r--r-- 1 root root   796 Jun  2  2023 CONTRIBUTING.md\n-rw-r--r-- 1 root root  1084 Jun  2  2023 LICENSE\n-rw-r--r-- 1 root root   917 Jun  2  2023 Makefile\n-rw-r--r-- 1 root root  1305 Jun  2  2023 NOTICE\n-rw-r--r-- 1 root root   219 Jun  2  2023 README.md\ndrwxr-xr-x 2 root root  4096 Dec  7 10:01 templates\n-rw-r--r-- 1 root root 26508 Jun  2  2023 values.yaml\n-rw-r--r-- 1 root root 26508 Dec  7 10:01 values.yaml.bak\n</code></pre>"},{"location":"helm/Install-Runner-IN-Kubernetes/#2-edit-config","title":"2 Edit config","text":"<pre><code># \u7f16\u8f91\u914d\u7f6e\nvim gitlab-runner/values.yaml\n### \nimage:\n  registry: docker.io\n  image: gitlab/gitlab-runner\n  tag: alpine-v15.11.1\n\nimagePullSecrets:\n  - name: \"harbor-credentials\"\n\nreplicas: 1\n\ngitlabUrl: http://10.0.1.1/ ## gitlab http\n#certsSecretName: runner-tls-chain   ## gitlab https need.\n\nconcurrent: 10\n\nlogLevel: info\n\nrbac:\n  create: true\n\nmetrics:\n  enabled: true\n  portName: metrics\n  port: 9252\n  serviceMonitor:\n    enabled: false\n\nrunners:\n  config: |\n    [[runners]]\n      [runners.kubernetes]\n        namespace = \"{{.Release.Namespace}}\"\n        image = \"ubuntu:16.04\"\n      [runners.custom_build_dir]\n        enabled = true\n      [runners.cache]\n        Type = \"s3\"\n        Path = \"runner\"\n        Shared = true\n        [runners.cache.s3]\n          ServerAddress = \"192.168.1.120:9000\"\n          BucketName = \"runner-cache-papd\"\n          AccessKey = \"4IABo3LtOGfc8QbW5eEY\"\n          SecretKey = \"7mc1JtsWRjuD6Mk1pxvAXMRSdwunT7Jq7UURAFmY\"\n          #BucketLocation = \"\"\n          Insecure = true\n          #AuthenticationType = \"access-key\"  \n\n  executor: kubernetes\n  privileged: true\n\n  tags: \"kubernetes\"\n\n  secret: gitlab-runner\n\n  builds: \n    cpuLimit: 2010m\n    cpuLimitOverwriteMaxAllowed: 2010m\n    memoryLimit: 2060Mi\n    memoryLimitOverwriteMaxAllowed: 2060Mi\n    cpuRequests: 100m\n    cpuRequestsOverwriteMaxAllowed: 100m\n    memoryRequests: 128Mi\n    memoryRequestsOverwriteMaxAllowed: 128Mi\n\n  services: \n    cpuLimit: 200m\n    memoryLimit: 256Mi\n    cpuRequests: 100m\n    memoryRequests: 128Mi\n\n  helpers:\n    cpuLimit: 200m\n    memoryLimit: 256Mi\n    cpuRequests: 100m\n    memoryRequests: 128Mi\n    # image: \"registry.gitlab.com/gitlab-org/gitlab-runner/gitlab-runner-helper:x86_64-${CI_RUNNER_REVISION}\"\n    image: \"harbor.dockerregistry.com/kubernetes/gitlab/gitlab-runner-helper:x86_64-v15.11.1\"\n\n\n  resources: \n    limits:\n      memory: 256Mi\n      cpu: 200m\n    requests:\n      memory: 128Mi\n      cpu: 100m\n</code></pre>"},{"location":"helm/Install-Runner-IN-Kubernetes/#3-create-secret","title":"3 Create secret","text":"<pre><code># \u521b\u5efa\u547d\u540d\u7a7a\u95f4\nkubectl create ns gitlab-runner-papd\n\n# \u521b\u5efa\u5bc6\u94a5\n# \u521b\u5efa\u62c9\u53d6\u955c\u50cf\u7684\u8ba4\u8bc1\u79d8\u94a5\n# \u8fd9\u91cc\u4f7f\u7528\u7684\u662fRobot \u8d26\u6237\nkubectl create secret docker-registry harbor-credentials \\\n    --docker-server=harbor.dockerregistry.com \\\n    --docker-username=robot\\$5m2wwklm4tet \\\n    --docker-password=Lf1Gpxz9zfVavMJk2xPFzBdRYE2TIxGG \\\n    -n gitlab-runner-papd \n\n# \u521b\u5efa\u8fde\u63a5Gitlab\u7684\u8ba4\u8bc1\u79d8\u94a5  ## gitlab https\n# kubectl create secret generic mygitlab-mydomain-com-crt   --namespace gitlab-runner-papd   --from-file=mygitlab.mydomain.com.crt=mygitlab.mydomain.com.crt\n\n\n# \u4f7f\u7528Gitlab \u9879\u76ee\u6216\u9879\u76ee\u7ec4\u7684Token\uff0c\u6765\u521b\u5efaRunner\u6ce8\u518c\u5230Gitlab\u7684\u79d8\u94a5\nkubectl create secret generic gitlab-runner \\\n  --from-literal=runner-registration-token=GR1348941Bdbk4zQ3TxSpCNKzysSe \\\n  --from-literal=runner-token=\"\" \\\n  --type=Opaque \\\n  -n gitlab-runner-papd\n</code></pre>"},{"location":"helm/Install-Runner-IN-Kubernetes/#4-install-runner","title":"4 Install Runner","text":"<pre><code># \u5b89\u88c5\n\n\n# helm install --namespace &lt;NAMESPACE&gt; gitlab-runner -f &lt;CONFIG_VALUES_FILE&gt; gitlab/gitlab-runner --version &lt;RUNNER_HELM_CHART_VERSION&gt;\n# helm search repo -l gitlab/gitlab-runner | grep 15.11\n# helm install gitlab-runner-papd -f gitlab-runner/values.yaml gitlab/gitlab-runner  --namespace gitlab-runner-papd --create-namespace\n\nhelm install gitlab-runner-papd ./gitlab-runner -f gitlab-runner/values.yaml   --namespace gitlab-runner-papd --create-namespace\n</code></pre>"},{"location":"helm/Install-Runner-IN-Kubernetes/#5-update-runner","title":"5 Update Runner","text":"<pre><code># \u66f4\u65b0\u914d\u7f6e\uff0c\u66f4\u65b0\u670d\u52a1\nhelm upgrade gitlab-runner-papd  ./gitlab-runner -f gitlab-runner/values.yaml   --namespace gitlab-runner-papd\n\n# \u5b8c\u5168\u5378\u8f7d\nhelm -n gitlab-runner-papd uninstall gitlab-runner\n</code></pre>"},{"location":"helm/Install-Runner-IN-Kubernetes/#6-add-network-support","title":"6 ADD Network Support","text":"<pre><code>## 1 \u4fee\u6539\u4e3b\u914d\u7f6e\u5e76\u91cd\u542f\u670d\u52a1\uff1a\n\n# \u4e3b\u914d\u7f6e\u4fee\u6539\n$ vim /etc/gitlab/gitlab.rb\ngitlab_rails['outbound_local_requests'] = { \"allow\" =&gt; true }\n\n# \u91cd\u542f\u670d\u52a1\ngitlab-ctl restart\n\n\n## 2 \u9875\u9762\u914d\u7f6e\u4fee\u6539\uff0c\u5e76\u6dfb\u52a0\u767d\u540d\u5355\uff1a\n\n# \u4fee\u6539\u5165\u53e3\uff1a\nhttp(s)://&lt;gitlab-server.addr&gt;:&lt;server-port&gt;/admin/application_settings/network\n# \u52fe\u9009\u4e0a\uff1a\n- [x] Allow requests to the local network from webhooks and integrations\n- [x] Allow requests to the local network from system hooks\n# \u6dfb\u52a0\u767d\u540d\u5355\uff1a\n## \u6dfb\u52a0\u81ea\u5df1\u8981\u8bbf\u95ee\u7684\u5185\u7f51\u57df\u540d\u6216IP\u5730\u5740\n** Local IP addresses and domain names that hooks and integrations can access ** \nharbor.dockerregistry.com\nminio.objectstorage.com\ntraefik.k8scluster.com\nargocd.k8scluster.com\ngrpc.argocd.k8scluster.com\n192.168.1.120\n</code></pre>"},{"location":"helm/Install-Runner-IN-Kubernetes/#7-add-harbor-support","title":"7 ADD Harbor Support","text":"<pre><code># \u9875\u9762\u4e0a\u914d\u7f6eHarbor \u96c6\u6210\nhttp(s)://&lt;gitlab-server.addr&gt;:&lt;server-port&gt;/groups/cicd/-/settings/integrations\n\n## \u627e\u5230Harbor\n\n- [x] Enable integration\n\n**Harbor URL**\nhttps://harbor.dockerregistry.com\n\n**Harbor project name**\npapd ## \u5199\u81ea\u5df1\u9879\u76ee\u955c\u50cf\u7684 Harbor \u9879\u76ee\u540d\n\n**Harbor username**\nrobot$5m2wwklm4tet\n\n**Enter new Harbor password**\nLf1Gpxz9zfVavMJk2xPFzBdRYE2TIxGG  ## \u5199\u81ea\u5df1Harbor \u90a3\u8fb9\u673a\u5668\u4eba\u8d26\u6237\u3001\u5bc6\u7801\n</code></pre>"},{"location":"helm/Install-Runner-IN-Kubernetes/#8-copy-harbor-ca","title":"8 Copy Harbor ca","text":"<pre><code># Harbor \u955c\u50cf\u62c9\u53d6\u65f6\u8bc1\u4e66\u8ba4\u8bc1\u62a5\u9519\uff1a\n# Running with gitlab-runner 15.11.1 (0d8a024e)\n#   on gitlab-runner-papd-f64fd85f5-zh599 E5CnU17q, system ID: r_3yoDCGyFCkI7\n# Preparing the \"kubernetes\" executor\n# 00:00\n# Using Kubernetes namespace: gitlab-runner-papd\n# Using Kubernetes executor with image harbor.dockerregistry.com/kubernetes/node:16.20.2 ...\n# Using attach strategy to execute scripts...\n# Preparing environment\n# 00:03\n# Waiting for pod gitlab-runner-papd/runner-e5cnu17q-project-3013-concurrent-0j8wls to be running, status is Pending\n# WARNING: Failed to pull image with policy \"\": image pull failed: rpc error: code = Unknown desc = failed to pull and unpack image \\\n# \"harbor.dockerregistry.com/kubernetes/node:16.20.2\": failed to resolve reference \"harbor.dockerregistry.com/kubernetes/node:16.20.2\": \\\n# failed to do request: Head \"https://harbor.dockerregistry.com/v2/kubernetes/node/manifests/16.20.2\": tls: failed to verify certificate: x509: certificate signed by unknown authority\n# ERROR: Job failed: prepare environment: waiting for pod running: pulling image \"harbor.dockerregistry.com/kubernetes/node:16.20.2\": image pull failed: rpc error: \\\n# code = Unknown desc = failed to pull and unpack image \"harbor.dockerregistry.com/kubernetes/node:16.20.2\": failed to resolve reference \"harbor.dockerregistry.com/kubernetes/node:16.20.2\":\\\n# failed to do request: Head \"https://harbor.dockerregistry.com/v2/kubernetes/node/manifests/16.20.2\": \\\n# tls: failed to verify certificate: x509: certificate signed by unknown authority. Check https://docs.gitlab.com/runner/shells/index.html#shell-profile-loading for more information\n\n\n# on worker nodes.\n\n\\cp -rvf /etc/tls/harbor/harbor.dockerregistry.com/ca.crt /etc/ssl/certs/\n\\cp -rvf /etc/tls/harbor/harbor.dockerregistry.com/harbor.dockerregistry.com.cert /etc/ssl/certs/\n\n# \u66f4\u65b0\u8bc1\u4e66\u5b58\u50a8\nupdate-ca-certificates\n\n# \u91cd\u542f \u8fd0\u884c\u65f6 \u670d\u52a1\nsystemctl restart containerd\n</code></pre>"},{"location":"helm/Install-Runner-IN-Kubernetes/#9-test-limit","title":"9 Test Limit","text":"<p>\u6570\u636e\u5df2\u8131\u654f\u3002</p> <p>\u53ef\u4ee5\u770b\u5230\u76f8\u5173pod \u73af\u5883\u5747\u6309\u5f00\u59cb<code>values.yaml</code> \u8d44\u6e90\u9650\u5236\u6765\u542f\u52a8\u7684</p> <pre><code>root@master2:~/gitlab-runner# kubectl get pod -n gitlab-runner-papd runner-xdnsadt3-project-2806-concurrent-0rg4lh   -o yaml\napiVersion: v1\nkind: Pod\nmetadata:\n  annotations:\n    cni.projectcalico.org/containerID: xxxxx\n    cni.projectcalico.org/podIP: xxxxx\n    cni.projectcalico.org/podIPs: xxxxx\n    job.runner.gitlab.com/before_sha: xxxxx\n    job.runner.gitlab.com/id: \"xxxxx\"\n    job.runner.gitlab.com/name: package\n    job.runner.gitlab.com/ref: test\n    job.runner.gitlab.com/sha: xxxxx\n    job.runner.gitlab.com/url: http://xxxxx/frame-ui/-/jobs/16326\n    project.runner.gitlab.com/id: \"xxxx\"\n  creationTimestamp: \"2024-01-24T08:05:45Z\"\n  generateName: runner-xdnsadt3-project-2806-concurrent-0\n  labels:\n    pod: runner-xdnsadt3-project-2806-concurrent-0\n  name: runner-xdnsadt3-project-2806-concurrent-0rg4lh\n  namespace: gitlab-runner-papd\n  resourceVersion: \"3582460\"\n  uid: 8b8299ff-1758-4e68-9fb5-4a6d81827f08\nspec:\n  affinity: {}\n  containers:\n  - command:\n    - sh\n    - -c\n    - \"if [ -x /usr/local/bin/bash ]; then\\n\\texec /usr/local/bin/bash \\nelif [ -x\n      /usr/bin/bash ]; then\\n\\texec /usr/bin/bash \\nelif [ -x /bin/bash ]; then\\n\\texec\n      /bin/bash \\nelif [ -x /usr/local/bin/sh ]; then\\n\\texec /usr/local/bin/sh \\nelif\n      [ -x /usr/bin/sh ]; then\\n\\texec /usr/bin/sh \\nelif [ -x /bin/sh ]; then\\n\\texec\n      /bin/sh \\nelif [ -x /busybox/sh ]; then\\n\\texec /busybox/sh \\nelse\\n\\techo shell\n      not found\\n\\texit 1\\nfi\\n\\n\"\n    env:\n    - name: FF_CMD_DISABLE_DELAYED_ERROR_LEVEL_EXPANSION\n      value: \"false\"\n    - name: FF_NETWORK_PER_BUILD\n      value: \"false\"\n    - name: FF_USE_LEGACY_KUBERNETES_EXECUTION_STRATEGY\n      value: \"false\"\n    - name: FF_USE_DIRECT_DOWNLOAD\n      value: \"true\"\n    - name: FF_SKIP_NOOP_BUILD_STAGES\n      value: \"true\"\n    - name: FF_USE_FASTZIP\n      value: \"false\"\n    - name: FF_DISABLE_UMASK_FOR_DOCKER_EXECUTOR\n      value: \"false\"\n    - name: FF_ENABLE_BASH_EXIT_CODE_CHECK\n      value: \"false\"\n    - name: FF_USE_WINDOWS_LEGACY_PROCESS_STRATEGY\n      value: \"true\"\n    - name: FF_USE_NEW_BASH_EVAL_STRATEGY\n      value: \"false\"\n    - name: FF_USE_POWERSHELL_PATH_RESOLVER\n      value: \"false\"\n    - name: FF_USE_DYNAMIC_TRACE_FORCE_SEND_INTERVAL\n      value: \"false\"\n    - name: FF_SCRIPT_SECTIONS\n      value: \"false\"\n    - name: FF_USE_NEW_SHELL_ESCAPE\n      value: \"false\"\n    - name: FF_ENABLE_JOB_CLEANUP\n      value: \"false\"\n    - name: FF_KUBERNETES_HONOR_ENTRYPOINT\n      value: \"false\"\n    - name: FF_POSIXLY_CORRECT_ESCAPES\n      value: \"false\"\n    - name: FF_USE_IMPROVED_URL_MASKING\n      value: \"false\"\n    - name: FF_RESOLVE_FULL_TLS_CHAIN\n      value: \"true\"\n    - name: FF_DISABLE_POWERSHELL_STDIN\n      value: \"false\"\n    - name: FF_USE_POD_ACTIVE_DEADLINE_SECONDS\n      value: \"false\"\n    - name: FF_USE_ADVANCED_POD_SPEC_CONFIGURATION\n      value: \"false\"\n    - name: FF_SET_PERMISSIONS_BEFORE_CLEANUP\n      value: \"true\"\n    - name: CI_JOB_IMAGE\n      value: xxxxxxxxxxxxxxx/kubernetes/nodejs:v4\n    - name: CI_RUNNER_SHORT_TOKEN\n      value: xDnSadT3\n    - name: CI_BUILDS_DIR\n      value: /builds\n    - name: CI_PROJECT_DIR\n      value: /builds/rdcenter/apply/product/productivity/operation/source/frame-ui\n    - name: CI_CONCURRENT_ID\n      value: \"0\"\n    - name: CI_CONCURRENT_PROJECT_ID\n      value: \"0\"\n    - name: CI_SERVER\n      value: \"yes\"\n    - name: CI_JOB_STATUS\n      value: running\n    - name: CI_JOB_TIMEOUT\n      value: \"3600\"\n    - name: CI_PIPELINE_ID\n      value: \"4944\"\n    - name: CI_PIPELINE_URL\n      value: http://xxxxxxxxxxxxxx/frame-ui/-/pipelines/4944\n    - name: CI_JOB_ID\n      value: \"16326\"\n    - name: CI_JOB_URL\n      value: http://xxxxxxxxxxxxxx/frame-ui/-/jobs/16326\n    - name: CI_JOB_STARTED_AT\n      value: \"2024-01-24T08:05:45Z\"\n    - name: CI_BUILD_ID\n      value: \"16326\"\n    - name: CI_REGISTRY_USER\n      value: gitlab-ci-token\n    - name: HARBOR_URL\n      value: https://xxxxxxxxxxxxxxx\n    - name: HARBOR_HOST\n      value: xxxxxxxxxxxxxxx\n    - name: HARBOR_OCI\n      value: oci://xxxxxxxxxxxxxxx\n    - name: HARBOR_PROJECT\n      value: papd\n    - name: HARBOR_USERNAME\n      value: robot$5m2wwklm4tet\n    - name: CI_DEPENDENCY_PROXY_USER\n      value: gitlab-ci-token\n    - name: CI_JOB_NAME\n      value: package\n    - name: CI_JOB_NAME_SLUG\n      value: package\n    - name: CI_JOB_STAGE\n      value: package\n    - name: CI_JOB_MANUAL\n      value: \"true\"\n    - name: CI_NODE_TOTAL\n      value: \"1\"\n    - name: CI_BUILD_NAME\n      value: package\n    - name: CI_BUILD_STAGE\n      value: package\n    - name: CI_BUILD_MANUAL\n      value: \"true\"\n    - name: CI\n      value: \"true\"\n    - name: GITLAB_CI\n      value: \"true\"\n    - name: CI_SERVER_URL\n      value: http://xxxxxxxxxxxxxxxxxxxx\n    - name: CI_SERVER_HOST\n      value: xxxxxxxxxxx\n    - name: CI_SERVER_PORT\n      value: \"xxxxx\"\n    - name: CI_SERVER_PROTOCOL\n      value: http\n    - name: CI_SERVER_SHELL_SSH_HOST\n      value: xxxxxxxxxxx\n    - name: CI_SERVER_SHELL_SSH_PORT\n      value: \"22\"\n    - name: CI_SERVER_NAME\n      value: GitLab\n    - name: CI_SERVER_VERSION\n      value: 15.11.13\n    - name: CI_SERVER_VERSION_MAJOR\n      value: \"15\"\n    - name: CI_SERVER_VERSION_MINOR\n      value: \"11\"\n    - name: CI_SERVER_VERSION_PATCH\n      value: \"13\"\n    - name: CI_SERVER_REVISION\n      value: cc3748fcd2d\n    - name: GITLAB_FEATURES\n    - name: CI_PROJECT_ID\n      value: \"2806\"\n    - name: CI_PROJECT_NAME\n      value: frame-ui\n    - name: CI_PROJECT_TITLE\n      value: frame-ui\n    - name: CI_PROJECT_DESCRIPTION\n      value: xxxxxx\n    - name: CI_PROJECT_PATH\n      value: rdcenter/apply/product/productivity/operation/source/frame-ui\n    - name: CI_PROJECT_PATH_SLUG\n      value: rdcenter-apply-product-productivity-operation-source-frame-ui\n    - name: CI_PROJECT_NAMESPACE\n      value: rdcenter/apply/product/productivity/operation/source\n    - name: CI_PROJECT_NAMESPACE_ID\n      value: \"1996\"\n    - name: CI_PROJECT_ROOT_NAMESPACE\n      value: rdcenter\n    - name: CI_PROJECT_URL\n      value: http://xxxxxxxxxxxxxx/frame-ui\n    - name: CI_PROJECT_VISIBILITY\n      value: private\n    - name: CI_PROJECT_REPOSITORY_LANGUAGES\n      value: html,javascript,css,typescript,vue\n    - name: CI_PROJECT_CLASSIFICATION_LABEL\n    - name: CI_DEFAULT_BRANCH\n      value: xxxxxx\n    - name: CI_CONFIG_PATH\n      value: .gitlab-ci.yml\n    - name: CI_PAGES_DOMAIN\n      value: xxxxxxx\n    - name: CI_PAGES_URL\n      value: http://xxxxxx/frame-ui\n    - name: CI_DEPENDENCY_PROXY_SERVER\n      value: xxxxxxxxxxxxxxxxxxxx\n    - name: CI_DEPENDENCY_PROXY_GROUP_IMAGE_PREFIX\n      value: xxxxxxxxxxxxxxxxxxxx/rdcenter/dependency_proxy/containers\n    - name: CI_DEPENDENCY_PROXY_DIRECT_GROUP_IMAGE_PREFIX\n      value: xxxxxxxxxxxxxx/dependency_proxy/containers\n    - name: CI_API_V4_URL\n      value: http://xxxxxxxxxxxxxxxxxxxx/api/v4\n    - name: CI_API_GRAPHQL_URL\n      value: http://xxxxxxxxxxxxxxxxxxxx/api/graphql\n    - name: CI_TEMPLATE_REGISTRY_HOST\n      value: registry.gitlab.com\n    - name: CI_PIPELINE_IID\n      value: \"182\"\n    - name: CI_PIPELINE_SOURCE\n      value: push\n    - name: CI_PIPELINE_CREATED_AT\n      value: \"2024-01-17T07:46:52Z\"\n    - name: CI_COMMIT_SHA\n      value: 96e25221890613845bc2a6a14de49add95090248\n    - name: CI_COMMIT_SHORT_SHA\n      value: 96e25221\n    - name: CI_COMMIT_BEFORE_SHA\n      value: a71843f930b1a993cc56dca99d1de51418ca3600\n    - name: CI_COMMIT_REF_NAME\n      value: test\n    - name: CI_COMMIT_REF_SLUG\n      value: test\n    - name: CI_COMMIT_BRANCH\n      value: test\n    - name: CI_COMMIT_MESSAGE\n      value: |\n        ci: update template\n    - name: CI_COMMIT_TITLE\n      value: 'ci: update template'\n    - name: CI_COMMIT_DESCRIPTION\n    - name: CI_COMMIT_REF_PROTECTED\n      value: \"false\"\n    - name: CI_COMMIT_TIMESTAMP\n      value: \"2024-01-17T15:46:34+08:00\"\n    - name: CI_COMMIT_AUTHOR\n      value: xxxxxxxxx &lt;xxxxxxxxx&gt;\n    - name: CI_BUILD_REF\n      value: 96e25221890613845bc2a6a14de49add95090xxxx\n    - name: CI_BUILD_BEFORE_SHA\n      value: a71843f930b1a993cc56dca99d1de51418ca3600\n    - name: CI_BUILD_REF_NAME\n      value: test\n    - name: CI_BUILD_REF_SLUG\n      value: test\n    - name: CI_RUNNER_ID\n      value: \"43\"\n    - name: CI_RUNNER_DESCRIPTION\n      value: gitlab-runner-papd-89cd578d4-cqxc7\n    - name: CI_RUNNER_TAGS\n      value: '[\"kubernetes\"]'\n    - name: DEPLOY_ONLY\n      value: \"false\"\n    - name: REPO_URL\n      value: http://gitlab-ci-token:xxxxxx@xxxxxxxxxxxxxx/frame-ui.git\n    - name: DEST_ENVIRONMENT\n      value: prod\n    - name: CI_PROJECT_NAME\n      value: frame-ui\n    - name: HARBOR_PROJECT\n      value: papd-bom\n    - name: GITLAB_USER_ID\n      value: \"175\"\n    - name: GITLAB_USER_EMAIL\n      value: xxxxxx\n    - name: GITLAB_USER_LOGIN\n      value: xxxxxxxxxx\n    - name: GITLAB_USER_NAME\n      value: xxxxxx\n    - name: CI_DISPOSABLE_ENVIRONMENT\n      value: \"true\"\n    - name: CI_RUNNER_VERSION\n      value: 15.11.1\n    - name: CI_RUNNER_REVISION\n      value: 0d8a024e\n    - name: CI_RUNNER_EXECUTABLE_ARCH\n      value: linux/amd64\n    - name: RUNNER_TEMP_PROJECT_DIR\n      value: /builds/rdcenter/apply/product/productivity/operation/source/frame-ui.tmp\n    image: xxxxxxxxxxxxxxx/kubernetes/nodejs:v4\n    imagePullPolicy: IfNotPresent\n    name: build\n    resources:\n      limits:\n        cpu: 2010m\n        memory: 2060Mi\n      requests:\n        cpu: 100m\n        memory: 128Mi\n    securityContext:\n      capabilities:\n        drop:\n        - NET_RAW\n      privileged: true\n    stdin: true\n    terminationMessagePath: /dev/termination-log\n    terminationMessagePolicy: File\n    volumeMounts:\n    - mountPath: /scripts-2806-16326\n      name: scripts\n    - mountPath: /logs-2806-16326\n      name: logs\n    - mountPath: /builds\n      name: repo\n    - mountPath: /var/run/secrets/kubernetes.io/serviceaccount\n      name: kube-api-access-4xzsk\n      readOnly: true\n  - command:\n    - sh\n    - -c\n    - \"if [ -x /usr/local/bin/bash ]; then\\n\\texec /usr/local/bin/bash \\nelif [ -x\n      /usr/bin/bash ]; then\\n\\texec /usr/bin/bash \\nelif [ -x /bin/bash ]; then\\n\\texec\n      /bin/bash \\nelif [ -x /usr/local/bin/sh ]; then\\n\\texec /usr/local/bin/sh \\nelif\n      [ -x /usr/bin/sh ]; then\\n\\texec /usr/bin/sh \\nelif [ -x /bin/sh ]; then\\n\\texec\n      /bin/sh \\nelif [ -x /busybox/sh ]; then\\n\\texec /busybox/sh \\nelse\\n\\techo shell\n      not found\\n\\texit 1\\nfi\\n\\n\"\n    image: xxxxxxxxxxxxxxx/kubernetes/gitlab/gitlab-runner-helper:x86_64-v15.11.1\n    imagePullPolicy: IfNotPresent\n    name: helper\n    resources:\n      limits:\n        cpu: 200m\n        memory: 256Mi\n      requests:\n        cpu: 100m\n        memory: 128Mi\n    securityContext:\n      capabilities:\n        drop:\n        - NET_RAW\n      privileged: true\n    stdin: true\n    terminationMessagePath: /dev/termination-log\n    terminationMessagePolicy: File\n    volumeMounts:\n    - mountPath: /scripts-2806-16326\n      name: scripts\n    - mountPath: /logs-2806-16326\n      name: logs\n    - mountPath: /builds\n      name: repo\n    - mountPath: /var/run/secrets/kubernetes.io/serviceaccount\n      name: kube-api-access-4xzsk\n      readOnly: true\n  dnsPolicy: ClusterFirst\n  enableServiceLinks: true\n  imagePullSecrets:\n  - name: runner-xdnsadt3-project-2806-concurrent-0mqh6n\n  initContainers:\n  - command:\n    - sh\n    - -c\n    - touch /logs-2806-16326/output.log &amp;&amp; (chmod 777 /logs-2806-16326/output.log\n      || exit 0)\n    image: xxxxxxxxxxxxxxx/kubernetes/gitlab/gitlab-runner-helper:x86_64-v15.11.1\n    imagePullPolicy: IfNotPresent\n    name: init-permissions\n    resources:\n      limits:\n        cpu: 200m\n        memory: 256Mi\n      requests:\n        cpu: 100m\n        memory: 128Mi\n    securityContext:\n      capabilities:\n        drop:\n        - NET_RAW\n      privileged: true\n    terminationMessagePath: /dev/termination-log\n    terminationMessagePolicy: File\n    volumeMounts:\n    - mountPath: /scripts-2806-16326\n      name: scripts\n    - mountPath: /logs-2806-16326\n      name: logs\n    - mountPath: /builds\n      name: repo\n    - mountPath: /var/run/secrets/kubernetes.io/serviceaccount\n      name: kube-api-access-4xzsk\n      readOnly: true\n  nodeName: worker1.k8scluster.com\n  preemptionPolicy: PreemptLowerPriority\n  priority: 0\n  restartPolicy: Never\n  schedulerName: default-scheduler\n  securityContext: {}\n  serviceAccount: default\n  serviceAccountName: default\n  terminationGracePeriodSeconds: 0\n  tolerations:\n  - effect: NoExecute\n    key: node.kubernetes.io/not-ready\n    operator: Exists\n    tolerationSeconds: 300\n  - effect: NoExecute\n    key: node.kubernetes.io/unreachable\n    operator: Exists\n    tolerationSeconds: 300\n  volumes:\n  - emptyDir: {}\n    name: repo\n  - emptyDir: {}\n    name: scripts\n  - emptyDir: {}\n    name: logs\n  - name: kube-api-access-4xzsk\n    projected:\n      defaultMode: 420\n      sources:\n      - serviceAccountToken:\n          expirationSeconds: 3607\n          path: token\n      - configMap:\n          items:\n          - key: ca.crt\n            path: ca.crt\n          name: kube-root-ca.crt\n      - downwardAPI:\n          items:\n          - fieldRef:\n              apiVersion: v1\n              fieldPath: metadata.namespace\n            path: namespace\nstatus:\n  conditions:\n  - lastProbeTime: null\n    lastTransitionTime: \"2024-01-24T08:05:46Z\"\n    status: \"True\"\n    type: Initialized\n  - lastProbeTime: null\n    lastTransitionTime: \"2024-01-24T08:05:48Z\"\n    status: \"True\"\n    type: Ready\n  - lastProbeTime: null\n    lastTransitionTime: \"2024-01-24T08:05:48Z\"\n    status: \"True\"\n    type: ContainersReady\n  - lastProbeTime: null\n    lastTransitionTime: \"2024-01-24T08:05:45Z\"\n    status: \"True\"\n    type: PodScheduled\n  containerStatuses:\n  - containerID: containerd://bb6ca8456a54c2ee8c72bb384f9e7c3c896763a0406e07be6adc11064ec7e8fc\n    image: xxxxxxxxxxxxxxx/kubernetes/nodejs:v4\n    imageID: sha256:3b30b0ab418c68619187e9c61a30afa8309cb81145def1ab4e08c7962497ffba\n    lastState: {}\n    name: build\n    ready: true\n    restartCount: 0\n    started: true\n    state:\n      running:\n        startedAt: \"2024-01-24T08:05:47Z\"\n  - containerID: containerd://bda6ee9607dae7303fe15dd05e6e0d357477484020dce00d4c8e240c0aac9fda\n    image: xxxxxxxxxxxxxxx/kubernetes/gitlab/gitlab-runner-helper:x86_64-v15.11.1\n    imageID: sha256:61a243bb78908ae5daf5570de71c972ef2a5706fda848c137f41b7534082654f\n    lastState: {}\n    name: helper\n    ready: true\n    restartCount: 0\n    started: true\n    state:\n      running:\n        startedAt: \"2024-01-24T08:05:47Z\"\n  hostIP: xxxxxxx\n  initContainerStatuses:\n  - containerID: containerd://9170fc749cc1383cf142b3c6371bf1e889aeef95d2f3cca0ea4327bf02e65eb4\n    image: xxxxxxxxxxxxxxx/kubernetes/gitlab/gitlab-runner-helper:x86_64-v15.11.1\n    imageID: sha256:61a243bb78908ae5daf5570de71c972ef2a5706fda848c137f41b7534082654f\n    lastState: {}\n    name: init-permissions\n    ready: true\n    restartCount: 0\n    state:\n      terminated:\n        containerID: containerd://9170fc749cc1383cf142b3c6371bf1e889aeef95d2f3cca0ea4327bf02e65eb4\n        exitCode: 0\n        finishedAt: \"2024-01-24T08:05:46Z\"\n        reason: Completed\n        startedAt: \"2024-01-24T08:05:46Z\"\n  phase: Running\n  podIP: \n  podIPs:\n  - ip: \n  qosClass: Burstable\n  startTime: \"2024-01-24T08:05:45Z\"\n</code></pre>"},{"location":"helm/Install-TLS-ArgoCD/","title":"Install TLS ArgoCD","text":""},{"location":"helm/Install-TLS-ArgoCD/#1-prerequisites","title":"1 Prerequisites","text":"<pre><code># need three worker nodes. \n</code></pre>"},{"location":"helm/Install-TLS-ArgoCD/#2-install-client","title":"2 Install Client","text":"<pre><code># \u7248\u672c\u517c\u5bb9\u6027\u8bf4\u660e\uff0c\u8bf7\u67e5\u770b\u5b98\u65b9\u6587\u6863\n# https://argo-cd.readthedocs.io/en/stable/operator-manual/installation/#tested-versions\n\n# git clone -b v2.9.2 https://github.com/argoproj/argo-cd.git\n\nmkdir -p argoCD &amp;&amp; cd argoCD\n\n# on maste1.\n# upload files.\n\n# view files.\nroot@master2:~/argoCD# ll\ntotal 149856\ndrwxr-xr-x 24 root root      4096 Jan 16 20:57 argo-cd\n-rw-r--r--  1 root root 153442642 Dec  7 17:31 argocd-linux-amd64\ndrwxr-xr-x  2 root root      4096 Jan 16 20:57 images\n\n\n# mv file.\n\\cp -rvf argocd-linux-amd64 /usr/bin/argocd\nchmod +x /usr/bin/argocd\n\n# check it.\nroot@master1:~# argocd version \nargocd: v2.9.2+c5ea5c4\n  BuildDate: 2023-11-20T17:37:53Z\n  GitCommit: c5ea5c4df52943a6fff6c0be181fde5358970304\n  GitTreeState: clean\n  GoVersion: go1.21.4\n  Compiler: gc\n  Platform: linux/amd64\nFATA[0000] Argo CD server address unspecified\n\n\n# scp files.\nscp -r  argocd-linux-amd64 master2:~/\nscp -r  argocd-linux-amd64 master3:~/\nscp -r  argocd-linux-amd64 worker1:~/\nssh master2 \"\\cp -rvf argocd-linux-amd64 /usr/bin/argocd &amp;&amp; chmod +x /usr/bin/argocd\" \nssh master3 \"\\cp -rvf argocd-linux-amd64 /usr/bin/argocd &amp;&amp; chmod +x /usr/bin/argocd\" \nssh worker1 \"\\cp -rvf argocd-linux-amd64 /usr/bin/argocd &amp;&amp; chmod +x /usr/bin/argocd\" \n</code></pre>"},{"location":"helm/Install-TLS-ArgoCD/#3-pull-files","title":"3 Pull files.","text":"<pre><code># on worker1 \n# upload files.\n\n# view files.\nroot@worker1:~# ls -lh *.tar \n-rw-r--r-- 1 root root 414M Dec  7 17:46 argocd.tar\n-rw-r--r-- 1 root root  93M Dec  7 17:46 dex.tar\n-rw-r--r-- 1 root root  23M Dec  7 17:47 haproxy.tar\n-rw-r--r-- 1 root root  30M Dec  7 17:46 redis.tar\n\n# load images.\ndocker load -i xx.tar \n</code></pre>"},{"location":"helm/Install-TLS-ArgoCD/#4-install-server","title":"4 Install Server","text":"<pre><code># on master1 \n\n# egrep -v '^#|^$' ha/namespace-install.yaml | grep -A 1 image\n# docker pull ghcr.io/dexidp/dex:v2.37.0\n# docker pull haproxy:2.6.14-alpine\n# docker pull quay.io/argoproj/argocd:v2.9.2\n# docker pull redis:7.0.11-alpine\n\n# on worker nodes\ndocker load -i adapter.tar \ndocker load -i argocd.tar \ndocker load -i dex.tar \ndocker load -i haproxy.tar\n\nroot@master2:~/argoCD# ll argo-cd/manifests/\ntotal 2456\ndrwxr-xr-x  2 root root    4096 Jan 16 20:57 addons\ndrwxr-xr-x 11 root root    4096 Jan 16 20:57 base\ndrwxr-xr-x  2 root root    4096 Jan 16 20:57 cluster-install\ndrwxr-xr-x  4 root root    4096 Jan 16 20:57 cluster-rbac\ndrwxr-xr-x  2 root root    4096 Jan 16 20:57 core-install\n-rw-r--r--  1 root root 1194391 Dec  7 17:26 core-install.yaml\ndrwxr-xr-x  2 root root    4096 Jan 16 20:57 crds\ndrwxr-xr-x  5 root root    4096 Jan 16 20:57 ha\n-rw-r--r--  1 root root 1217616 Dec  7 17:26 install.yaml\ndrwxr-xr-x  2 root root    4096 Jan 16 20:57 namespace-install\n-rw-r--r--  1 root root   59885 Dec  7 17:26 namespace-install.yaml\n-rw-r--r--  1 root root    1775 Dec  7 17:26 README.md\n\ncd argo-cd/manifests/\nkubectl create namespace argocd\nkubectl create -n argocd -f ha/install.yaml\n\n\n\n\n\nroot@master1:~/argocd/manifests# kubectl -n argocd get po \nNAME                                                READY   STATUS    RESTARTS   AGE\nargocd-application-controller-0                     1/1     Running   0          3m8s\nargocd-applicationset-controller-6f9d6cfd58-lg26b   1/1     Running   0          3m8s\nargocd-dex-server-6df5d4f8c4-w7fkc                  1/1     Running   0          3m8s\nargocd-notifications-controller-589b479947-wwz7r    1/1     Running   0          3m8s\nargocd-redis-ha-haproxy-f66786cb6-nz7qg             1/1     Running   0          3m8s\nargocd-redis-ha-haproxy-f66786cb6-snzwb             1/1     Running   0          3m8s\nargocd-redis-ha-haproxy-f66786cb6-tjdcr             1/1     Running   0          3m8s\nargocd-redis-ha-server-0                            3/3     Running   0          3m8s\nargocd-redis-ha-server-1                            3/3     Running   0          111s\nargocd-redis-ha-server-2                            1/3     Running   0          51s\nargocd-repo-server-5b5df8f959-824rg                 1/1     Running   0          3m8s\nargocd-repo-server-5b5df8f959-x4552                 1/1     Running   0          3m8s\nargocd-server-5dcfd5ddd5-bgz4w                      1/1     Running   0          3m8s\nargocd-server-5dcfd5ddd5-cz5tk                      1/1     Running   0          3m8s\n\n\nroot@master1:~/argocd/manifests# kubectl get svc -n argocd\nNAME                                      TYPE        CLUSTER-IP       EXTERNAL-IP   PORT(S)                      AGE\nargocd-applicationset-controller          ClusterIP   10.105.46.153    &lt;none&gt;        7000/TCP,8080/TCP            3m31s\nargocd-dex-server                         ClusterIP   10.99.148.154    &lt;none&gt;        5556/TCP,5557/TCP,5558/TCP   3m31s\nargocd-metrics                            ClusterIP   10.98.209.89     &lt;none&gt;        8082/TCP                     3m31s\nargocd-notifications-controller-metrics   ClusterIP   10.109.180.82    &lt;none&gt;        9001/TCP                     3m31s\nargocd-redis-ha                           ClusterIP   None             &lt;none&gt;        6379/TCP,26379/TCP           3m30s\nargocd-redis-ha-announce-0                ClusterIP   10.111.42.215    &lt;none&gt;        6379/TCP,26379/TCP           3m30s\nargocd-redis-ha-announce-1                ClusterIP   10.98.233.90     &lt;none&gt;        6379/TCP,26379/TCP           3m30s\nargocd-redis-ha-announce-2                ClusterIP   10.108.127.116   &lt;none&gt;        6379/TCP,26379/TCP           3m30s\nargocd-redis-ha-haproxy                   ClusterIP   10.96.102.173    &lt;none&gt;        6379/TCP,9101/TCP            3m30s\nargocd-repo-server                        ClusterIP   10.111.212.152   &lt;none&gt;        8081/TCP,8084/TCP            3m30s\nargocd-server                             ClusterIP   10.102.152.4     &lt;none&gt;        80/TCP,443/TCP               3m30s\nargocd-server-metrics                     ClusterIP   10.108.52.180    &lt;none&gt;        8083/TCP                     3m30s\n</code></pre>"},{"location":"helm/Install-TLS-ArgoCD/#5-expose-svc","title":"5 Expose SVC","text":"<pre><code># \u4f7f\u7528NodePort \u65b9\u5f0f\u66b4\u9732\n# 80  \u5bf9\u5e94 30884\n# 443 \u5bf9\u5e94 30885\nkubectl patch svc argocd-server -n argocd -p '{\"spec\": {\"type\": \"NodePort\", \"ports\": [{\"nodePort\": 30884, \"port\": 80}, {\"nodePort\": 30885, \"port\": 443}]}}'\n\nroot@master1:~/argocd/manifests# kubectl get svc -n argocd\nNAME                                      TYPE        CLUSTER-IP       EXTERNAL-IP   PORT(S)                      AGE\nargocd-applicationset-controller          ClusterIP   10.105.46.153    &lt;none&gt;        7000/TCP,8080/TCP            5m18s\nargocd-dex-server                         ClusterIP   10.99.148.154    &lt;none&gt;        5556/TCP,5557/TCP,5558/TCP   5m18s\nargocd-metrics                            ClusterIP   10.98.209.89     &lt;none&gt;        8082/TCP                     5m18s\nargocd-notifications-controller-metrics   ClusterIP   10.109.180.82    &lt;none&gt;        9001/TCP                     5m18s\nargocd-redis-ha                           ClusterIP   None             &lt;none&gt;        6379/TCP,26379/TCP           5m17s\nargocd-redis-ha-announce-0                ClusterIP   10.111.42.215    &lt;none&gt;        6379/TCP,26379/TCP           5m17s\nargocd-redis-ha-announce-1                ClusterIP   10.98.233.90     &lt;none&gt;        6379/TCP,26379/TCP           5m17s\nargocd-redis-ha-announce-2                ClusterIP   10.108.127.116   &lt;none&gt;        6379/TCP,26379/TCP           5m17s\nargocd-redis-ha-haproxy                   ClusterIP   10.96.102.173    &lt;none&gt;        6379/TCP,9101/TCP            5m17s\nargocd-repo-server                        ClusterIP   10.111.212.152   &lt;none&gt;        8081/TCP,8084/TCP            5m17s\nargocd-server                             NodePort    10.102.152.4     &lt;none&gt;        80:30884/TCP,443:30885/TCP   5m17s\nargocd-server-metrics                     ClusterIP   10.108.52.180    &lt;none&gt;        8083/TCP                     5m17s\n</code></pre>"},{"location":"helm/Install-TLS-ArgoCD/#6-change-default-passwd","title":"6 Change default passwd","text":"<pre><code># \u83b7\u53d6\u9ed8\u8ba4\u5bc6\u7801\nroot@master1:~/argocd/manifests# kubectl -n argocd get secret argocd-initial-admin-secret -o jsonpath=\"{.data.password}\" | base64 -d &amp;&amp; echo\neBQwQdv60T9okZTl\n\n\n# \u6216\u8005\u7528\u547d\u4ee4\u884c\u5de5\u5177\u83b7\u53d6\nroot@master1:~/argocd/manifests# argocd admin initial-password -n argocd\neBQwQdv60T9okZTl\n\n This password must be only used for first time login. We strongly recommend you update the password using `argocd account update-password`.\n\n# \u547d\u4ee4\u884c\u5de5\u5177\u767b\u9646\nroot@master1:~/argocd/manifests# argocd login 192.168.1.120:30884\n# WARNING: server certificate had error: tls: failed to verify certificate: x509: cannot validate certificate for 192.168.1.120 because it doesn't contain any IP SANs. Proceed insecurely (y/n)? y\n# Username: admin\n# Password: \n# 'admin:login' logged in successfully\n# Context '192.168.1.120:30884' updated\n\n\nroot@master1:~/argocd/manifests# argocd account update-password\n# *** Enter password of currently logged in user (admin):     # &lt;-- \u5199\u5165\u524d\u9762\u83b7\u53d6\u7684\u9ed8\u8ba4\u5bc6\u7801\n# *** Enter new password for user admin:                      # &lt;-- \u5199\u5165\u8981\u4fee\u6539\u7684\u65b0\u5bc6\u7801\n# *** Confirm new password for user admin:                    # &lt;-- \u518d\u6b21\uff0c\u5199\u5165\u8981\u4fee\u6539\u7684\u65b0\u5bc6\u7801\n# Password updated\n# Context '192.168.1.120:30884' updated\n\n\n# \u83b7\u53d6\u96c6\u7fa4\u4e0a\u4e0b\u6587\nroot@master1:~/argocd/manifests# kubectl config get-contexts -o name\nkubernetes-admin@kubernetes\n\n# \u83b7\u53d6\u96c6\u7fa4\u5217\u8868\nroot@master1:~/argocd/manifests# argocd cluster list\nSERVER                          NAME        VERSION  STATUS   MESSAGE                                                  PROJECT\nhttps://kubernetes.default.svc  in-cluster           Unknown  Cluster has no applications and is not being monitored.  \n\n# \u9000\u51fa\u767b\u9646\uff08\u82e5\u9700\u8981\uff09\nargocd logout 192.168.1.120:30884\n</code></pre>"},{"location":"helm/Install-TLS-ArgoCD/#7-change-rolebinding","title":"7 Change rolebinding","text":"<pre><code># \u8865\u5145\u89d2\u8272\u6743\u9650\n$ kubectl  edit role/argocd-application-controller -n argocd\n...\nrules:\n- apiGroups:\n  - \"\"\n  resources:\n  - secrets\n  - configmaps\n  - namespaces # &lt;--- \u5728\u8fd9\u91cc\n\n# \u786e\u8ba4\u89d2\u8272\u7ed1\u5b9a\n$ kubectl get rolebinding -n argocd -o yaml\n\n# \u5220\u9664pod\n$ kubectl delete pod -n argocd -l app.kubernetes.io/name=argocd-application-controller\n</code></pre>"},{"location":"helm/Install-TLS-ArgoCD/#8-install-operator-lifecycle-manager","title":"8 Install operator-lifecycle-manager","text":"<pre><code># https://github.com/operator-framework/operator-lifecycle-manager/releases\n# https://operatorhub.io/operator/argocd-operator\n\ncd \nmkdir -p operator-lifecycle-manager &amp;&amp; cd operator-lifecycle-manager\n\n# upload files. \n\nroot@master2:~/operator-lifecycle-manager# ls -lh \ntotal 413M\n-rw-r--r-- 1 root root  222 Dec 12 17:50 argocd-operator.yaml\n-rw-r--r-- 1 root root 159M Jan 16 21:27 catalog.tar\n-rw-r--r-- 1 root root 807K Dec 12 17:25 crds.yaml\n-rw-r--r-- 1 root root 1.9K Dec 12 17:25 install.sh\n-rw-r--r-- 1 root root 127M Jan 16 21:28 olm.tar\n-rw-r--r-- 1 root root  11K Jan 16 21:18 olm.yaml\n-rw-r--r-- 1 root root  11K Jan 16 21:17 olm.yaml.bak\n-rw-r--r-- 1 root root 127M Dec 12 17:26 operator-lifecycle-manager_0.26.0_linux_amd64.tar.gz\n\n\n\n# edit config\ncp  olm.yaml{,.bak}\nvim olm.yaml\n# \u66ff\u6362\u955c\u50cf\u4e3a\u672c\u5730\u4ed3\u5e93\u7684\nroot@master1:~/operator-lifecycle-manager# grep image: olm.yaml\n          image: harbor.dockerregistry.com/kubernetes/operator-framework/olm:v0.26 \n          image: harbor.dockerregistry.com/kubernetes/operator-framework/olm:v0.26 \n                image: harbor.dockerregistry.com/kubernetes/operator-framework/olm:v0.26 \n  image: harbor.dockerregistry.com/kubernetes/operatorhubio/catalog:latest\n\n# install \nkubectl create -f crds.yaml \nkubectl create -f olm.yaml \n\n\n#  \u5982\u679c\u4e0d\u884c\uff0c\u5c31\u4f7f\u7528\u79bb\u7ebf\u955c\u50cf\nkubectl delete -f olm.yaml \nkubectl get namespace olm -o json &gt; olm-temp.json\nkubectl get namespace operators -o json &gt; operators-temp.json\nvim olm-temp.json \nvim operators-temp.json\nkubectl replace --raw \"/api/v1/namespaces/olm/finalize\" -f ./olm-temp.json\nkubectl replace --raw \"/api/v1/namespaces/operators/finalize\" -f ./operators-temp.json\n\ndocker load -i catalog.tar\ndocker load -i olm.tar\nrm olm.yaml -f \nmv olm.yaml.bak olm.yaml\n\n\n\n# \u518d\u6b21 install \nkubectl create -f olm.yaml \n</code></pre>"},{"location":"helm/Install-TLS-ArgoCD/#9-install-operator","title":"9 Install operator","text":"<pre><code># install operator\nroot@master1:~/operator-lifecycle-manager# kubectl create -f argocd-operator.yaml \nsubscription.operators.coreos.com/my-argocd-operator created\n\n# view csv\nroot@master1:~/operator-lifecycle-manager# kubectl get csv -n operators\nNAME                     DISPLAY   VERSION   REPLACES                 PHASE\nargocd-operator.v0.8.0   Argo CD   0.8.0     argocd-operator.v0.7.0   Installing\n\n# \u7b49\u5f852min\nroot@master1:~/operator-lifecycle-manager# kubectl get csv -n operators\nNAME                     DISPLAY   VERSION   REPLACES                 PHASE\nargocd-operator.v0.8.0   Argo CD   0.8.0     argocd-operator.v0.7.0   Succeeded\n\n# view pod\nroot@master1:~/operator-lifecycle-manager# kubectl get pod -n operators \nNAME                                                  READY   STATUS    RESTARTS      AGE\nargocd-operator-controller-manager-58876c86fd-z4b8d   1/1     Running   1 (55s ago)   95s\n\n\n# set default # \u4e0d\u592a\u5efa\u8bae\n# kubectl config set-context --current --namespace=default\n</code></pre>"},{"location":"helm/Install-TLS-ArgoCD/#10-add-dns","title":"10 ADD DNS","text":"<pre><code>root@master1:~/operator-lifecycle-manager# kubectl -n kube-system edit cm coredns\napiVersion: v1\ndata:\n  Corefile: |\n    .:53 {\n        errors\n        health {\n           lameduck 5s\n        }\n        hosts {\n          10.1.1.110  harbor.dockerregistry.com\n          10.1.1.117  argocd.k8scluster.com     ### \u52a0\u4e00\u6761\n          fallthrough\n        }\n...\n\n# \u91cd\u542fdns\nroot@master1:~/operator-lifecycle-manager# kubectl delete -n kube-system pod `kubectl get pod -A|grep dns|awk '{print $2}'`\n</code></pre>"},{"location":"helm/Install-TLS-ArgoCD/#11-add-local-user","title":"11 ADD LOCAL USER","text":"<pre><code># https://argo-cd.readthedocs.io/en/stable/operator-manual/rbac/#tying-it-all-together\n# https://blog.csdn.net/sD7O95O/article/details/125966677\n\nroot@master2:~/gitlab-runner# kubectl edit -n argocd cm argocd-rbac-cm\nconfigmap/argocd-rbac-cm edited\n\nroot@master2:~/gitlab-runner# kubectl edit -n argocd cm argocd-cm\nconfigmap/argocd-cm edited\nroot@master2:~/gitlab-runner# echo y | argocd login 10.1.1.117:31812 --password 'T9zMQf5sME1buMJCM68W0Nx3R' --username admin\nWARNING: server certificate had error: tls: failed to verify certificate: x509: cannot validate certificate for 10.1.1.117 because it doesn't contain any IP SANs. Proceed insecurely (y/n)? 'admin:login' logged in successfully\nContext '10.1.1.117:31812' updated\nroot@master2:~/gitlab-runner# argocd account update-password \\\n --account db-admins \\\n --current-password 'T9zMQf5sMm16GbU7E1buMJCM68W0Nx3R' \\\n --new-password '870TJ6OVGNcLtMEE0p3SAvekRj9pnbiS'\nPassword updated\nroot@master2:~/gitlab-runner# echo y | argocd login 10.1.1.117:31812 --password '870TJ6OVGNcAvekRj9pnbiS' --username db-admins\nWARNING: server certificate had error: tls: failed to verify certificate: x509: cannot validate certificate for 10.1.1.117 because it doesn't contain any IP SANs. Proceed insecurely (y/n)? 'db-admins:login' logged in successfully\nContext '10.1.1.117:31812' updated\nroot@master2:~/gitlab-runner# argocd account list\nNAME       ENABLED  CAPABILITIES\nadmin      true     login\ndb-admins  true     apiKey, login \nroot@master2:~/gitlab-runner# argocd app list\nNAME             CLUSTER                         NAMESPACE  PROJECT  STATUS  HEALTH   SYNCPOLICY  CONDITIONS  REPO                                           PATH               TARGET\nargocd/frame-ui  https://kubernetes.default.svc             default  Synced  Healthy  &lt;none&gt;      &lt;none&gt;      http://10.1.1.11:5010/rdcenter/frame-ui.git    k8s/overlays/prod  test\n</code></pre> <p>\u89d2\u8272\u6743\u9650\u90e8\u5206\uff0c\u8fd9\u91cc\u7684<code>default</code> \u5bf9\u5e94Argo \u4e2d\u7684\u9879\u76ee\u6982\u5ff5\uff0c\u5373\u9ed8\u8ba4\u9879\u76ee\u3002</p> <pre><code>root@master2:~/gitlab-runner# kubectl get -n argocd cm argocd-rbac-cm -oyaml\napiVersion: v1\ndata:  # &lt;- \u6574\u4e2adata \u8bed\u6cd5\u5757\u4ee3\u7801\n  policy.csv: |\n    p, role:staging-db-admin, applications, create, default/*, allow\n    p, role:staging-db-admin, applications, delete, default/*, allow\n    p, role:staging-db-admin, applications, get, default/*, allow\n    p, role:staging-db-admin, applications, override, default/*, allow\n    p, role:staging-db-admin, applications, sync, default/*, allow\n    p, role:staging-db-admin, applications, update, default/*, allow\n    p, role:staging-db-admin, logs, get, default/*, allow\n    p, role:staging-db-admin, exec, create, default/*, allow\n    p, role:staging-db-admin, projects, get, default, allow\n    g, db-admins, role:staging-db-admin\n  policy.default: role:readonly\nkind: ConfigMap\nmetadata:\n  creationTimestamp: \"2024-01-16T13:06:31Z\"\n  labels:\n    app.kubernetes.io/name: argocd-rbac-cm\n    app.kubernetes.io/part-of: argocd\n  name: argocd-rbac-cm\n  namespace: argocd\n  resourceVersion: \"303385\"\n  uid: c7cf48bf-ad22-4dfd-b3a8-17b17719566f\n\n#################################################################################### \u5173\u952e\u90e8\u5206\ndata:  \n  policy.csv: |\n    p, role:staging-db-admin, applications, create, default/*, allow\n    p, role:staging-db-admin, applications, delete, default/*, allow\n    p, role:staging-db-admin, applications, get, default/*, allow\n    p, role:staging-db-admin, applications, override, default/*, allow\n    p, role:staging-db-admin, applications, sync, default/*, allow\n    p, role:staging-db-admin, applications, update, default/*, allow\n    p, role:staging-db-admin, logs, get, default/*, allow\n    p, role:staging-db-admin, exec, create, default/*, allow\n    p, role:staging-db-admin, projects, get, default, allow\n    g, db-admins, role:staging-db-admin\n  policy.default: role:readonly\n\n################################################################################################################################\n# \u4e0d\u540c\u7528\u6237\u7ec4\u7ba1\u7406\u81ea\u5df1\u7684\u9879\u76ee\nroot@master2:~/gitlab-runner# kubectl get -n argocd cm argocd-rbac-cm -oyaml\napiVersion: v1\ndata:\n  policy.csv: |\n    p, role:staging-db-admin, applications, create, default/*, allow\n    p, role:staging-db-admin, applications, delete, default/*, allow\n    p, role:staging-db-admin, applications, get, default/*, allow\n    p, role:staging-db-admin, applications, override, default/*, allow\n    p, role:staging-db-admin, applications, sync, default/*, allow\n    p, role:staging-db-admin, applications, update, default/*, allow\n    p, role:staging-db-admin, logs, get, default/*, allow\n    p, role:staging-db-admin, exec, create, default/*, allow\n    p, role:staging-db-admin, projects, get, default, allow\n    g, db-admins, role:staging-db-admin\n    p, role:papd-bom-admin, applications, create, papd-bom/*, allow  ## \u7ee7\u7eed\u65b0\u589e\u5373\u53ef\n    p, role:papd-bom-admin, applications, delete, papd-bom/*, allow\n    p, role:papd-bom-admin, applications, get, papd-bom/*, allow\n    p, role:papd-bom-admin, applications, override, papd-bom/*, allow\n    p, role:papd-bom-admin, applications, sync, papd-bom/*, allow\n    p, role:papd-bom-admin, applications, update, papd-bom/*, allow\n    p, role:papd-bom-admin, logs, get, papd-bom/*, allow\n    p, role:papd-bom-admin, exec, create, papd-bom/*, allow\n    p, role:papd-bom-admin, projects, get, papd-bom, allow\n    g, papd-bom, role:papd-bom-admin\n  policy.default: role:readonly\nkind: ConfigMap\nmetadata:\n  creationTimestamp: \"2024-01-16T13:06:31Z\"\n  labels:\n    app.kubernetes.io/name: argocd-rbac-cm\n    app.kubernetes.io/part-of: argocd\n  name: argocd-rbac-cm\n  namespace: argocd\n  resourceVersion: \"336161\"\n  uid: c7cf48bf-ad22-4dfd-b3a8-17b17719566f\n</code></pre> <p>\u7528\u6237\u90e8\u5206</p> <pre><code>root@master2:~/gitlab-runner# kubectl get -n argocd cm argocd-cm -oyaml\napiVersion: v1\ndata:   # &lt;- \u6574\u4e2adata \u8bed\u6cd5\u5757\u4ee3\u7801\n  accounts.db-admins: apiKey,login\nkind: ConfigMap\nmetadata:\n  creationTimestamp: \"2024-01-16T13:06:30Z\"\n  labels:\n    app.kubernetes.io/name: argocd-cm\n    app.kubernetes.io/part-of: argocd\n  name: argocd-cm\n  namespace: argocd\n  resourceVersion: \"304731\"\n  uid: 22f2f02d-a813-495a-98f1-53dab33214c3\n\n #################################################################################### \u5173\u952e\u90e8\u5206\n data:\n  accounts.db-admins: apiKey,login\n</code></pre>"},{"location":"helm/Install-TLS-Traefik/","title":"Install TLS Traefik","text":""},{"location":"helm/Install-TLS-Traefik/#1-premise","title":"1 Premise","text":"<pre><code># helm \u8981\u6c42\uff1ahelm &gt; 3.9 \n\nroot@master1:~# helm version \nversion.BuildInfo{Version:\"v3.12.3\", GitCommit:\"3a31588ad33fe3b89af5a2a54ee1d25bfe6eaa5e\", GitTreeState:\"clean\", GoVersion:\"go1.20.7\"}\n</code></pre>"},{"location":"helm/Install-TLS-Traefik/#2-upload-files","title":"2 Upload files","text":"<pre><code># \u6dfb\u52a0helm\u4ed3\u5e93\n# helm repo add traefik https://traefik.github.io/charts\n# helm repo update\n# helm search repo traefik/traefik -l # \u7f57\u5217\u7248\u672c\n# helm pull traefik/traefik --version 25.0.0 \n\n# git clone -b v25.0.0 https://github.com/traefik/traefik-helm-chart.git\n\n# upload files\nmkdir -p traefik &amp;&amp; cd  traefik\nroot@master1:~/traefik# ls -lh \ntotal 4.0K\ndrwxr-xr-x 4 root root 4.0K Dec  6 16:39 traefik-helm-chart\nroot@master1:~/traefik# cd traefik-helm-chart/\nroot@master1:~/traefik/traefik-helm-chart# ls -lh \ntotal 56K\n-rw-r--r-- 1 root root  886 Dec  6 16:36 CONTRIBUTING.md\n-rw-r--r-- 1 root root  14K Dec  6 16:36 EXAMPLES.md\ndrwxr-xr-x 2 root root 4.0K Dec  6 16:39 hack\n-rw-r--r-- 1 root root  12K Dec  6 16:36 LICENSE\n-rw-r--r-- 1 root root 1.1K Dec  6 16:36 Makefile\n-rw-r--r-- 1 root root 6.6K Dec  6 16:36 README.md\n-rw-r--r-- 1 root root 2.2K Dec  6 16:36 TESTING.md\ndrwxr-xr-x 5 root root 4.0K Dec  6 16:39 traefik\nroot@master1:~/traefik/traefik-helm-chart# ls -lh traefik/\ntotal 336K\n-rw-r--r-- 1 root root 257K Dec  6 16:36 Changelog.md\n-rw-r--r-- 1 root root 1.7K Dec  6 16:36 Chart.yaml\ndrwxr-xr-x 2 root root 4.0K Dec  6 16:39 crds\n-rw-r--r-- 1 root root 3.0K Dec  6 16:36 Guidelines.md\ndrwxr-xr-x 3 root root 4.0K Dec  6 16:39 templates\ndrwxr-xr-x 3 root root 4.0K Dec  6 16:39 tests\n-rw-r--r-- 1 root root  17K Dec  6 16:36 VALUES.md\n-rw-r--r-- 1 root root  34K Dec  6 16:36 values.yaml\n</code></pre>"},{"location":"helm/Install-TLS-Traefik/#3-edit-config","title":"3 Edit Config","text":"<pre><code>cp traefik/values.yaml{,.bak}\n\nvim traefik/values.yaml ## \u5173\u952e\u7684\u914d\u7f6e\u89c1\u4e0b\u9762\u5185\u5bb9\n`\ningressRoute:\n  dashboard:\n    enabled: true\n\ningressClass:\n  enabled: true\n  isDefaultClass: false\n\nproviders:\n  kubernetesCRD:\n    enabled: true\n    allowCrossNamespace: true\n    allowExternalNameServices: true\n\n\n  kubernetesIngress:\n    enabled: true\n    allowExternalNameServices: true\n\nlogs:\n  general:\n    level: DEBUG\n  access:\n    enabled: true\n\nservice:\n  enabled: true\n  single: true\n  type: ClusterIP\n\nadditionalArguments:\n  - \"--log.level=DEBUG\"\n\n`\n</code></pre>"},{"location":"helm/Install-TLS-Traefik/#4-install-traefik","title":"4 Install traefik","text":"<pre><code># \u90e8\u7f72\nroot@master1:~/traefik/traefik-helm-chart# pwd \n/root/traefik/traefik-helm-chart\n\n# docker pull docker.io/traefik:v2.10.5\n# docker pull harbor.dockerregistry.com/kubernetes/traefik:v2.10.5 &amp;&amp; docker tag harbor.dockerregistry.com/kubernetes/traefik:v2.10.5 docker.io/traefik:v2.10.5 \n\n# helm install traefik --namespace=traefik-v2  traefik/traefik --version 24.0.0 --values=./traefik/values.yaml\nhelm install traefik --namespace=traefik-v2 --create-namespace ./traefik --values=./traefik/values.yaml\n\n# \u5378\u8f7d\uff08\u82e5\u9700\u8981\uff09\nhelm uninstall traefik -n traefik-v2\n</code></pre>"},{"location":"helm/Install-TLS-Traefik/#5-update-traefik","title":"5 Update traefik","text":"<pre><code># \u66f4\u65b0\nhelm upgrade traefik --namespace=traefik-v2  ./traefik --values=./traefik/values.yaml \n</code></pre>"},{"location":"helm/Install-TLS-Traefik/#6-view-ingressclass","title":"6 View ingressclass","text":"<pre><code># \u67e5\u770b\u8def\u7531\u7c7b\nroot@master1:~/traefik/traefik-helm-chart# kubectl get ingressclass\nNAME      CONTROLLER                      PARAMETERS   AGE\ntraefik   traefik.io/ingress-controller   &lt;none&gt;       7m33s\n</code></pre>"},{"location":"helm/Install-TLS-Traefik/#7-create-ca","title":"7 Create ca","text":"<pre><code>root@master1:~# cd ~/traefik/\nroot@master1:~/traefik# mkdir -p tls\nroot@master1:~/traefik# cd tls/\n\n# rsa\u7b97\u6cd5\uff0c\u521b\u5efa\u8bc1\u4e66\n# \u521b\u5efa\u8bc1\u4e66\u914d\u7f6e\n\ntee openssl-ca.cnf &lt;&lt;-EOF\n[req]\ndistinguished_name = req_distinguished_name\nx509_extensions = v3_ca\ndefault_days = 3650\ndefault_md = sha256\nprompt = no\n\n[req_distinguished_name]\nCN = My Root CA\n\n[v3_ca]\nsubjectKeyIdentifier=hash\nauthorityKeyIdentifier=keyid:always,issuer\nbasicConstraints = critical, CA:true \nEOF\n\ntee openssl-server.cnf &lt;&lt;-EOF\n[req]\ndistinguished_name = req_distinguished_name\nx509_extensions = v3_req\nprompt = no\ndefault_days = 3650\ndefault_md = sha256\n\n[req_distinguished_name]\nCN = traefik.k8scluster.com\n\n[v3_req]\nkeyUsage = digitalSignature, keyEncipherment\nextendedKeyUsage = serverAuth\nsubjectAltName = @alt_names\n\n[alt_names]\nDNS.1 = traefik.k8scluster.com\nEOF\n\n# \u5236\u4f5c\u8bc1\u4e66\nopenssl genrsa -out rootCA.key 2048 # \u521b\u5efaCA\u7684\u79c1\u94a5\nopenssl req -x509 -new -nodes -key rootCA.key -sha256 -days 3650 -out rootCA.crt -config openssl-ca.cnf # \u521b\u5efa\u5e76\u81ea\u7b7e\u540d\u6839\u8bc1\u4e66(CA)\n\nopenssl genrsa -out server.key 2048 # \u521b\u5efa\u670d\u52a1\u5668\u7684\u79c1\u94a5\nopenssl req -new -key server.key -out server.csr -config openssl-server.cnf # \u521b\u5efa\u670d\u52a1\u5668\u8bc1\u4e66\u7b7e\u540d\u8bf7\u6c42(CSR)\nopenssl x509 -req -in server.csr -CA rootCA.crt -CAkey rootCA.key -CAcreateserial -out server.crt -days 3650 -sha256 -extensions v3_req -extfile openssl-server.cnf # \u4f7f\u7528CA\u7b7e\u7f72\u670d\u52a1\u5668\u8bc1\u4e66\n</code></pre>"},{"location":"helm/Install-TLS-Traefik/#8-create-secret","title":"8 Create secret","text":"<pre><code># \u521b\u5efa\u5bc6\u94a5\nkubectl create secret tls traefik-ingress-dashboard --namespace traefik-v2 --key ./server.key --cert ./server.crt\n# \u67e5\u770b\u786e\u8ba4\nkubectl -n traefik-v2 get secret traefik-ingress-dashboard -o jsonpath=\"{.data.tls\\.crt}\" | base64 --decode | openssl x509 -inform pem -text -noout\n</code></pre>"},{"location":"helm/Install-TLS-Traefik/#9-create-basic-auth","title":"9 Create basic-auth","text":"<pre><code>apt install apache2-utils -y\n\n# htpasswd \u547d\u4ee4\u751f\u6210\u4e00\u4e2a\u6709\u6548\u7684 htpasswd \u5b57\u7b26\u4e32\nroot@master1:~/traefik/tls# htpasswd -nb admin Vg8NP15x60xcz3dffRS51038Lh3iHD8K\nadmin:$apr1$4UM4pVNl$VnlS3XyhpHGIhc2KQ5XRc1\n\n# \u521b\u5efa\u5bc6\u94a5\n#!!! \u6ce8\u610f: \u8fd9\u91cc\u5fc5\u987b\u4f7f\u7528\u5355\u5f15\u53f7\uff0c\u5426\u5219\u91cc\u9762\u7279\u6b8a\u7b26\u53f7\u5c31\u6709\u5176\u4ed6\u610f\u4e49\u4e86\uff0c\u4f1a\u5bfc\u81f4\u751f\u6210\u7684\u5bc6\u94a5\u5f02\u5e38\n\nkubectl create secret generic basic-auth --namespace=traefik-v2 --from-literal=auth='admin:$apr1$4UM4pVNl$VnlS3XyhpHGIhc2KQ5XRc1'  \n</code></pre>"},{"location":"helm/Install-TLS-Traefik/#10-create-ingressroute","title":"10 Create IngressRoute","text":"<pre><code>root@master1:~/traefik/tls# cd ~/traefik/\n\n\n\ntee traefik-websecure-dashboard.yaml &lt;&lt;-eof\napiVersion: traefik.containo.us/v1alpha1\nkind: IngressRoute\nmetadata:\n  name: websecure-dashboard\n  namespace: traefik-v2\nspec:\n  entryPoints:\n    - websecure\n  routes:\n    - match: Host(\\`traefik.k8scluster.com\\`) &amp;&amp; (PathPrefix(\\`/dashboard\\`) || PathPrefix(\\`/api\\`))\n      kind: Rule\n      services:\n        - name: api@internal\n          kind: TraefikService\n      middlewares:\n        - name: basic-auth\n          namespace: traefik-v2\n  tls:\n    secretName: traefik-ingress-dashboard\neof\n\nkubectl create -f traefik-websecure-dashboard.yaml\n</code></pre>"},{"location":"helm/Install-TLS-Traefik/#11-create-middleware","title":"11 Create Middleware","text":"<pre><code>tee traefik-middleware.yaml &lt;&lt;-eof\napiVersion: traefik.containo.us/v1alpha1\nkind: Middleware\nmetadata:\n  name: basic-auth\n  namespace: traefik-v2\nspec:\n  basicAuth:\n    secret: basic-auth\neof\n\nkubectl create -f traefik-middleware.yaml\n</code></pre>"},{"location":"helm/Install-TLS-Traefik/#12-expose-svc","title":"12 Expose svc","text":"<pre><code># \u66b4\u9732traefik \u670d\u52a1\nkubectl patch svc traefik -n traefik-v2 -p '{\"spec\": {\"type\": \"NodePort\", \"ports\": [{\"name\":\"web\", \"port\": 80, \"targetPort\": \"web\", \"nodePort\": 30882}, {\"name\":\"websecure\", \"port\": 443, \"targetPort\": \"websecure\", \"nodePort\": 30883}]}}'\n\n# \u67e5\u770b\u786e\u8ba4\nroot@master1:~/traefik# kubectl get service -n traefik-v2\nNAME      TYPE       CLUSTER-IP       EXTERNAL-IP   PORT(S)                      AGE\ntraefik   NodePort   10.109.232.131   &lt;none&gt;        80:30882/TCP,443:30883/TCP   23m\n</code></pre>"},{"location":"helm/Install-TLS-Traefik/#13-add-proxy","title":"13 Add proxy","text":"<pre><code># openssl req -x509 -newkey rsa:2048 -sha256 -nodes \\\n#     -keyout traefik.k8scluster.com.key \\\n#     -days 3650 \\\n#     -subj \"/C=CN/ST=Guangdong/L=Guangzhou/O=My Organization/OU=My Unit/CN=traefik.k8scluster.com\" \\\n#     -out traefik.k8scluster.com.crt \\\n#     -extensions SAN \\\n#     -config &lt;(echo \"[req]\"; \n#               echo distinguished_name=req; \n#               echo \"[SAN]\"; \n#               echo subjectAltName=DNS:traefik.k8scluster.com)\n\n# upload files.\nroot@harbor:/data/nginx/web# tree .\n.\n\u251c\u2500\u2500 docker-compose.yaml\n\u2514\u2500\u2500 nginx\n    \u251c\u2500\u2500 conf.d\n    \u2502   \u251c\u2500\u2500 ks-console.conf\n    \u2502   \u251c\u2500\u2500 minio.conf\n    \u2502   \u2514\u2500\u2500 traefik.conf\n    \u251c\u2500\u2500 nginx.conf\n    \u2514\u2500\u2500 ssl\n        \u251c\u2500\u2500 ks-console\n        \u2502   \u251c\u2500\u2500 kubesphere.k8scluster.com.crt\n        \u2502   \u2514\u2500\u2500 kubesphere.k8scluster.com.key\n        \u251c\u2500\u2500 minio\n        \u2502   \u251c\u2500\u2500 minio.objectstorage.com.crt\n        \u2502   \u2514\u2500\u2500 minio.objectstorage.com.key\n        \u2514\u2500\u2500 traefik\n            \u251c\u2500\u2500 traefik.k8scluster.com.crt\n            \u2514\u2500\u2500 traefik.k8scluster.com.key\n\n\n# start svc\ndocker-compose up -d \n</code></pre>"},{"location":"helm/Install-Velero/","title":"Install Velero","text":"<p>Velero\u5b98\u65b9\u6587\u6863</p>"},{"location":"helm/Install-Velero/#1","title":"1  \u5b89\u88c5\u5ba2\u6237\u7aef","text":"<p>\u5ba2\u6237\u7aef\u4e0b\u8f7d\u5730\u5740</p> <pre><code># \u4e0b\u8f7d\nwget https://github.com/vmware-tanzu/velero/releases/download/v1.10.2/velero-v1.10.2-linux-amd64.tar.gz\n\n# \u5b89\u88c5\u5ba2\u6237\u7aef\ntar xf velero-v1.10.2-linux-amd64.tar.gz\ncp velero-v1.10.2-linux-amd64/velero /usr/bin/\n\n# \u67e5\u770b\u7248\u672c\nvelero version\n</code></pre>"},{"location":"helm/Install-Velero/#2","title":"2 \u5b89\u88c5\u670d\u52a1\u7aef","text":"<p>\u8fd9\u91cc\u9009\u7528\u672c\u5730<code>Minio</code> \u4f5c\u4e3a\u5907\u4efd\u5b58\u50a8</p>"},{"location":"helm/Install-Velero/#21","title":"2.1 \u63d2\u4ef6\u517c\u5bb9\u6027","text":"<p><code>s3</code> \u63d2\u4ef6\u4e0e<code>velero</code> \u7248\u672c\u517c\u5bb9\u6027\u7684\u5b98\u65b9\u8bf4\u660e</p> Plugin Version Velero Version v1.6.x v1.10.x v1.5.x v1.9.x v1.4.x v1.8.x v1.3.x v1.7.x v1.2.x v1.6.x v1.1.x v1.5.x v1.1.x v1.4.x v1.0.x v1.3.x v1.0.x v1.2.0"},{"location":"helm/Install-Velero/#22","title":"2.2 \u90e8\u7f72\u670d\u52a1\u7aef","text":"<p>\u5b98\u65b9\u64cd\u4f5c\u8bf4\u660e</p> <pre><code># \u521b\u5efaminio \u6876\uff0c\u8fc7\u7a0b\u7565\nfish-velero\n\n\n# \u521b\u5efaminio \u8ba4\u8bc1\u6587\u4ef6\n$ cd velero-v1.10.2-linux-amd64\n\n\"\ncat &lt;&lt;EOF | sudo tee credentials-velero\n[default]\naws_access_key_id = \"admin\"\naws_secret_access_key = \"admin@123\"\nEOF\n\"\n\n# \u4f7f\u7528\u5ba2\u6237\u7aef\u5b89\u88c5\u670d\u52a1\u7aef\n# \u524d\u63d0\uff1a \u5f53\u524d\u8282\u70b9\u80fd\u6709\u96c6\u7fa4\u8ba4\u8bc1\u6743\u9650\uff0c\u53ef\u4ee5\u901a\u8fc7kubectl \u8fdb\u884c\u90e8\u7f72\n# \u81ea\u5b9a\u4e49minio \u6876\u540d\uff1afish-velero\n# \u672c\u5730minio \u670d\u52a1\u5668\u5730\u5740: http://10.3.1.250:9000\n# plugins \u5bf9\u5e94\u63d2\u4ef6\u955c\u50cf\u540d\uff0c\u8fd9\u91cc\u7528\u7684\u662f\u672c\u5730\u955c\u50cf\n$ velero install \\\n    --provider aws \\\n    --plugins harbor.dockerregistry.com/gitops/velero/velero-plugin-for-aws:v1.6.0 \\\n    --bucket fish-velero \\\n    --secret-file ./credentials-velero \\\n    --use-volume-snapshots=false \\\n    --backup-location-config region=minio,s3ForcePathStyle=\"true\",s3Url=http://10.1.1.1:9000\n\n\n# \u90e8\u7f72\u793a\u4f8b\u5e94\u7528\n$ kubectl apply -f examples/nginx-app/base.yaml\n\n# \u68c0\u67e5\u662f\u5426\u5df2\u6210\u529f\u521b\u5efa Velero \u548c nginx \u90e8\u7f72\n$ kubectl get deployments -l component=velero --namespace=velero\n$ kubectl get deployments --namespace=nginx-example\n</code></pre>"},{"location":"helm/Install-Velero/#23","title":"2.3 \u521b\u5efa\u5907\u4efd","text":"<p>\u5b98\u65b9\u6587\u6863</p> <pre><code># \u4e3a\u4e0e\u6807\u7b7e\u9009\u62e9\u5668\u5339\u914d\u7684\u4efb\u4f55\u5bf9\u8c61\u521b\u5efa\u5907\u4efdapp=nginx\n$ velero backup create nginx-backup --selector app=nginx\n\n\n# \u5220\u9664\u8d44\u6e90\nkubectl delete namespace nginx-example\n# \u68c0\u67e5\u8d44\u6e90\nkubectl get deployments --namespace=nginx-example\nkubectl get services --namespace=nginx-example\nkubectl get namespace/nginx-example\n</code></pre>"},{"location":"helm/Install-Velero/#24","title":"2.4 \u67e5\u770b\u5907\u4efd","text":"<pre><code>$ velero backup get\n</code></pre>"},{"location":"helm/Install-Velero/#25","title":"2.5 \u5907\u4efd\u6062\u590d","text":"<p>\u5b98\u65b9\u6587\u6863</p> <pre><code># \u4f7f\u7528\u5907\u4efd\u8fdb\u884c\u6062\u590d\n$ velero restore create --from-backup nginx-backup\n\n# \u67e5\u770b\u6062\u590d\u8bb0\u5f55\n$ velero restore get\n# \u67e5\u770b\u6062\u590d\u8be6\u7ec6\u4fe1\u606f\n$ velero restore describe $RESTORE_NAME\n</code></pre>"},{"location":"helm/Install-Velero/#26","title":"2.6 \u6e05\u7406\u5907\u4efd","text":"<pre><code>#Examples:\n  # Delete a backup named \"backup-1\".\n  velero backup delete backup-1\n\n  # Delete a backup named \"backup-1\" without prompting for confirmation.\n  velero backup delete backup-1 --confirm\n\n  # Delete backups named \"backup-1\" and \"backup-2\".\n  velero backup delete backup-1 backup-2\n\n  # Delete all backups triggered by schedule \"schedule-1\".\n  velero backup delete --selector velero.io/schedule-name=schedule-1\n\n  # Delete all backups.\n  velero backup delete --all\n</code></pre> <p>\u5b98\u65b9\u6587\u6863</p> <pre><code># \u6e05\u7406\u5907\u4efd\nvelero backup delete $BACKUP_NAME\n\n# \u67e5\u770b\u5907\u4efd\nvelero backup get $BACKUP_NAME\n</code></pre>"},{"location":"helm/Install-Velero/#27","title":"2.7 \u5b8c\u5168\u5378\u8f7d","text":"<p>\u5b98\u65b9\u6587\u6863</p> <pre><code># \u6e05\u7406velero \u670d\u52a1\u7aef\nkubectl delete namespace/velero clusterrolebinding/velero\nkubectl delete crds -l component=velero\n\n# \u6e05\u7406\u793a\u4f8b\u5e94\u7528\nkubectl delete -f examples/nginx-app/base.yaml\n</code></pre>"},{"location":"helm/Install-Velero/#3","title":"3 \u5907\u4efd\u539f\u7406","text":"<p>\u5b98\u65b9\u6587\u6863</p>"},{"location":"helm/Install-Velero/#31","title":"3.1 \u5bf9\u8c61\u5b58\u50a8\u540c\u6b65","text":"<p>\u5982\u679c\u5b58\u50a8\u6876\u4e2d\u6709\u683c\u5f0f\u6b63\u786e\u7684\u5907\u4efd\u6587\u4ef6\uff0c\u4f46 <code>Kubernetes API</code> \u4e2d\u6ca1\u6709\u5bf9\u5e94\u7684\u5907\u4efd\u8d44\u6e90\uff0c<code>Velero</code> \u4f1a\u5c06\u5bf9\u8c61\u5b58\u50a8\u7684\u4fe1\u606f\u540c\u6b65\u5230 <code>Kubernetes</code>\u3002\u8fd9\u5141\u8bb8\u8fd8\u539f\u529f\u80fd\u5728\u96c6\u7fa4\u8fc1\u79fb\u573a\u666f\u4e2d\u5de5\u4f5c\uff0c\u5176\u4e2d\u539f\u59cb\u5907\u4efd\u5bf9\u8c61\u4e0d\u5b58\u5728\u4e8e\u65b0\u96c6\u7fa4\u4e2d\u3002</p> <p>\u5982\u679c<code>Completed</code>\u5907\u4efd\u5bf9\u8c61\u5b58\u5728\u4e8e <code>Kubernetes</code> \u4f46\u4e0d\u5728\u5bf9\u8c61\u5b58\u50a8\u4e2d\uff0c\u5b83\u5c06\u4ece <code>Kubernetes</code> \u4e2d\u5220\u9664\uff0c\u56e0\u4e3a\u5907\u4efd <code>tarball</code> \u4e0d\u518d\u5b58\u5728\u3002 <code>Failed</code>\u6216<code>PartiallyFailed</code>\u5907\u4efd\u4e0d\u4f1a\u88ab\u5bf9\u8c61\u5b58\u50a8\u540c\u6b65\u5220\u9664\u3002</p>"},{"location":"helm/Install-Velero/#32","title":"3.2 \u8bbe\u7f6e\u5907\u4efd\u8fc7\u671f","text":"<p>\u521b\u5efa\u5907\u4efd\u65f6\uff0c\u53ef\u4ee5\u901a\u8fc7\u6dfb\u52a0\u6807\u5fd7\u6765\u6307\u5b9a <code>TTL</code>\uff08\u751f\u5b58\u65f6\u95f4\uff09<code>--ttl &lt;DURATION&gt;</code>\u3002\u5982\u679c <code>Velero</code> \u53d1\u73b0\u73b0\u6709\u5907\u4efd\u8d44\u6e90\u5df2\u8fc7\u671f\uff0c\u5b83\u4f1a\u5220\u9664:</p> <ul> <li>\u5907\u4efd\u8d44\u6e90</li> <li>\u6765\u81ea\u4e91\u5bf9\u8c61\u5b58\u50a8\u7684\u5907\u4efd\u6587\u4ef6</li> <li>\u6240\u6709 <code>PersistentVolume</code> \u5feb\u7167</li> <li>\u6240\u6709\u5173\u8054\u7684\u6062\u590d</li> </ul> <p><code>TTL</code> \u6807\u5fd7\u5141\u8bb8\u7528\u6237\u4ee5\u5c0f\u65f6\u3001\u5206\u949f\u548c\u79d2\u7684\u5f62\u5f0f\u6307\u5b9a\u5907\u4efd\u4fdd\u7559\u671f<code>--ttl 24h0m0s</code>\u3002\u5982\u679c\u672a\u6307\u5b9a\uff0c\u5c06\u5e94\u7528\u9ed8\u8ba4\u7684 <code>TTL</code> \u503c <code>30</code> \u5929\u3002</p> <p>\u5982\u679c\u5907\u4efd\u5220\u9664\u5931\u8d25\uff0c<code>velero.io/gc-failure=&lt;Reason&gt;</code>\u5219\u4f1a\u5728\u5907\u4efd\u81ea\u5b9a\u4e49\u8d44\u6e90\u4e0a\u6dfb\u52a0\u6807\u7b7e\u3002 \u60a8\u53ef\u4ee5\u4f7f\u7528\u6b64\u6807\u7b7e\u6765\u7b5b\u9009\u548c\u9009\u62e9\u672a\u80fd\u5220\u9664\u7684\u5907\u4efd\u3002\u5931\u8d25\u53ef\u80fd\u7684\u539f\u56e0\u662f\uff1a</p> <ul> <li><code>BSLNotFound</code>\uff1a\u627e\u4e0d\u5230\u5907\u4efd\u5b58\u50a8\u4f4d\u7f6e</li> <li><code>BSLCannotGet</code>\uff1a\u7531\u4e8e\u672a\u627e\u5230\u4ee5\u5916\u7684\u539f\u56e0\uff0c\u65e0\u6cd5\u4ece API \u670d\u52a1\u5668\u68c0\u7d22\u5907\u4efd\u5b58\u50a8\u4f4d\u7f6e</li> <li><code>BSLReadOnly</code>\uff1a\u5907\u4efd\u5b58\u50a8\u4f4d\u7f6e\u662f\u53ea\u8bfb\u7684</li> </ul>"},{"location":"helm/Install-Velero/#33-api","title":"3.3 \u96c6\u7fa4<code>API</code>\u7248\u672c","text":"<p><code>Velero</code> \u4f7f\u7528 <code>the Kubernetes API server\u2019s preferred version</code> \u4e3a\u6bcf\u4e2a\u7ec4/\u8d44\u6e90\u5907\u4efd\u8d44\u6e90\u3002 <code>When restoring a resource, this same API group/version must exist in the target cluster in order for the restore to be successful.</code>  \u7b80\u8a00\u4e4b\uff0c\u5f53\u521d\u5efa\u7acb\u5907\u4efd\u7684 <code>k8s</code> \u96c6\u7fa4\u7248\u672c\u4e0e\u8981\u8fd8\u539f\u5230\u7684 <code>k8s</code>\u96c6\u7fa4\u7248\u672c\u9700\u8981\u5c3d\u53ef\u80fd\u4e00\u81f4\uff0c\u5426\u5219\u4f1a\u56e0\u4e3a <code>API</code>\u7248\u672c\u5dee\u5f02\u5bfc\u81f4\u6062\u590d\u5f02\u5e38\u3002</p>"},{"location":"helm/Install-Velero/#34","title":"3.4 \u6062\u590d\u5de5\u4f5c\u6d41\u7a0b","text":"<p>When you run <code>velero restore create</code>  :</p> <ul> <li> <p><code>The Velero client makes a call to the Kubernetes API server to create a Restore object.</code>     \u5ba2\u6237\u7aef\u4f1a\u8bf7\u6c42<code>k8s api</code> \u53bb\u521b\u5efa\u6062\u590d\u7684\u8d44\u6e90\u5bf9\u8c61</p> </li> <li> <p><code>The RestoreController notices the new Restore object and performs validation.</code>     \u6062\u590d\u63a7\u5236\u5668\u4f1a\u901a\u77e5\u5907\u4efd\u670d\u52a1\u7aef\u5c06\u9700\u8981\u521b\u5efa\u4e00\u4e2a\u6062\u590d\u5bf9\u8c61\uff0c\u7136\u540e\u51c6\u5907\u5f00\u59cb\u6267\u884c\u9a8c\u8bc1</p> </li> <li> <p><code>The RestoreController fetches the backup information from the object storage service. It then runs some preprocessing on the backed up resources to make sure the resources will work on the new cluster. For example, using the backed-up API versions to verify that the restore resource will work on the target cluster</code>.       \u6062\u590d\u63a7\u5236\u5668\u4f1a\u83b7\u53d6\u5907\u4efd\u8d44\u6e90\u5bf9\u8c61\uff0c\u8fdb\u884c\u9884\u5904\u7406\u6765\u786e\u4fdd\u8981\u6062\u590d\u7684\u8d44\u6e90\u5c06\u53ef\u4ee5\u5728\u65b0\u7684\u6062\u590d\u4f4d\u7f6e\u4e0a\u53ef\u4ee5\u8fdb\u884c\u6b63\u5e38\u6062\u590d\u3002</p> </li> <li> <p><code>The RestoreController starts the restore process, restoring each eligible resource one at a time.</code>     \u6062\u590d\u63a7\u5236\u5668\u4f1a\u6267\u884c\u6062\u590d\u5de5\u4f5c\uff0c\u4e00\u6b21\u6027\u6267\u884c\u53ef\u4ee5\u7528\u6765\u6062\u590d\u7684\u5408\u683c\u8d44\u6e90\u8fdb\u884c\u6062\u590d\u3002</p> </li> </ul>"},{"location":"helm/Install-Velero/#35","title":"3.5 \u5907\u4efd\u5de5\u4f5c\u6d41\u7a0b","text":"<p>When you run <code>velero backup create test-backup</code> :</p> <ol> <li> <p><code>The Velero client makes a call to the Kubernetes API server to create a Backup object.</code></p> </li> <li> <p><code>The BackupController notices the new Backup object and performs validation.</code></p> </li> <li> <p><code>The BackupController begins the backup process. It collects the data to back up by querying the API server for resources.</code></p> </li> <li> <p><code>The BackupController makes a call to the object storage service \u2013 for example, AWS S3 \u2013 to upload the backup file.</code></p> </li> </ol> <p><code>By default, velero backup create makes disk snapshots of any persistent volumes. You can adjust the snapshots by specifying additional flags. Run velero backup create --help to see available flags. Snapshots can be disabled with the option --snapshot-volumes=false.</code></p> <p>![[Pasted image 20230330144306.png]]</p>"},{"location":"helm/Install-Velero/#4","title":"4 \u5907\u4efd\u65b9\u5f0f","text":"<p>\u5b98\u65b9\u6587\u6863</p>"},{"location":"helm/Install-Velero/#41","title":"4.1 \u6309\u9700\u5907\u4efd","text":""},{"location":"helm/Install-Velero/#411","title":"4.1.1 \u6307\u5b9a\u7279\u5b9a\u79cd\u7c7b\u8d44\u6e90\u7684\u5907\u4efd\u987a\u5e8f","text":"<p>\u8981\u4ee5\u7279\u5b9a\u987a\u5e8f\u5907\u4efd\u7279\u5b9a <code>Kind</code> \u7684\u8d44\u6e90\uff0c\u8bf7\u4f7f\u7528\u9009\u9879 <code>--ordered-resources</code> \u6307\u5b9a\u6620\u5c04 <code>Kinds</code> \u5230\u8be5 <code>Kind</code> \u7279\u5b9a\u8d44\u6e90\u7684\u6709\u5e8f\u5217\u8868\u3002\u8d44\u6e90\u540d\u79f0\u4ee5\u9017\u53f7\u5206\u9694\uff0c\u5176\u540d\u79f0\u683c\u5f0f\u4e3a\u201c\u540d\u79f0\u7a7a\u95f4/\u8d44\u6e90\u540d\u79f0\u201d\u3002\u5bf9\u4e8e\u96c6\u7fa4\u8303\u56f4\u8d44\u6e90\uff0c\u53ea\u9700\u4f7f\u7528\u8d44\u6e90\u540d\u79f0\u3002\u6620\u5c04\u4e2d\u7684\u952e\u503c\u5bf9\u4ee5\u5206\u53f7\u5206\u9694\u3002\u79cd\u7c7b\u540d\u79f0\u662f\u590d\u6570\u5f62\u5f0f\u3002</p> <pre><code># --include-cluster-resources=true  \u9ed8\u8ba4\u5c31\u662f\u5907\u4efd\u6574\u4e2a\u96c6\u7fa4\u8d44\u6e90\n# --ordered-resources \u5907\u4efd\u987a\u5e8f\u5217\u8868\u6e05\u5355\n# --include-namespaces \u6307\u5b9a\u547d\u540d\u7a7a\u95f4\n# pod/sts \u662f\u547d\u540d\u7a7a\u95f4\u7ea7\u522b\u8d44\u6e90\n# pv \u662f\u96c6\u7fa4\u7ea7\u8d44\u6e90\nvelero backup create backupName --include-cluster-resources=true --ordered-resources 'pods=ns1/pod1,ns1/pod2;persistentvolumes=pv4,pv8' --include-namespaces=ns1\nvelero backup create backupName --ordered-resources 'statefulsets=ns1/sts1,ns1/sts0' --include-namespaces=ns1\n</code></pre>"},{"location":"helm/Install-Velero/#412","title":"4.1.2 \u4ece\u5907\u4efd\u4e2d\u6392\u9664\u7279\u5b9a\u9879\u76ee","text":"<pre><code># velero.io/exclude-from-backup=true \u5c31\u662f\u7ed9\u8d44\u6e90\u6253\u7684\u6807\u7b7e\nkubectl label -n &lt;ITEM_NAMESPACE&gt; &lt;RESOURCE&gt;/&lt;NAME&gt; velero.io/exclude-from-backup=true\n</code></pre>"},{"location":"helm/Install-Velero/#42","title":"4.2 \u8ba1\u5212\u5907\u4efd","text":"<p>\u65f6\u95f4\u95f4\u9694\u7531 <code>Cron</code> \u8868\u8fbe\u5f0f \u6307\u5b9a\uff0c<code>Velero</code> \u4f7f\u7528\u540d\u79f0\u4fdd\u5b58\u6839\u636e\u8ba1\u5212\u521b\u5efa\u7684\u5907\u4efd<code>&lt;SCHEDULE NAME&gt;-&lt;TIMESTAMP&gt;</code>\uff0c\u5176\u4e2d<code>&lt;TIMESTAMP&gt;</code>\u683c\u5f0f\u4e3a<code>YYYYMMDDhhmmss</code></p> <p><code>Cron</code> \u8ba1\u5212\u4f7f\u7528\u4ee5\u4e0b\u683c\u5f0f\uff1a</p> <pre><code># \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500 minute (0 - 59)\n# \u2502 \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500 hour (0 - 23)\n# \u2502 \u2502 \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500 day of the month (1 - 31)\n# \u2502 \u2502 \u2502 \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500 month (1 - 12)\n# \u2502 \u2502 \u2502 \u2502 \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500 day of the week (0 - 6) (Sunday to Saturday;\n# \u2502 \u2502 \u2502 \u2502 \u2502                                   7 is also Sunday on some systems)\n# \u2502 \u2502 \u2502 \u2502 \u2502\n# \u2502 \u2502 \u2502 \u2502 \u2502\n# * * * * *\n</code></pre> <p>\u8bed\u6cd5\u683c\u5f0f\uff1a <pre><code># \u521b\u5efa\u5907\u4efd\u8ba1\u5212\nvelero schedule create ${BACKUP-SCHEDULE-NAME} --schedule=\"* * * * *\" [flags]\n\n# \u6e05\u7406\u5907\u4efd\u8ba1\u5212\nvelero schedule delete ${BACKUP-SCHEDULE-NAME}\n\n# \u7acb\u5373\u89e6\u53d1\u5907\u4efd\u8ba1\u5212\nvelero backup create --from-schedule ${BACKUP-SCHEDULE-NAME}\n</code></pre></p> <p>\u793a\u4f8b1\uff0c\u6bcf\u5929\u51cc\u66683\u70b9\u5f00\u59cb\u5907\u4efd\uff1a</p> <pre><code># \u5907\u4efd\u8ba1\u5212\u4e2d\u6307\u5b9a\u5907\u4efd\u5468\u671f\uff0c\u5907\u4efd\u5bf9\u8c61\nvelero schedule create example-schedule --schedule=\"0 3 * * *\"  --selector app=nginx --include-namespaces nginx-example\n# \u5907\u4efd\u8ba1\u5212\u4e2d\u6307\u5b9a\u547d\u540d\u7a7a\u95f4\uff0c\u9ed8\u8ba4\u5907\u4efd\u6240\u6709\u547d\u540d\u7a7a\u95f4\nvelero schedule create example-schedule2 --schedule=\"0 3 * * *\" --include-namespaces nginx-example \n# \u5907\u4efd\u8ba1\u5212\u4e2d\uff0c\u8bbe\u7f6e\u5907\u4efd\u8fc7\u671f\u65f6\u95f4\nvelero schedule create example-schedule3 --schedule=\"40 9 * * *\" --include-namespaces=\"nginx-example\" --ttl=\"72h\"\n\n# \u7acb\u5373\u89e6\u53d1\nvelero backup create --from-schedule example-schedule3\n\n# \u67e5\u770b\u5907\u4efd\n$ velero backup get\nNAME                               STATUS      ERRORS   WARNINGS   CREATED                         EXPIRES   STORAGE LOCATION   SELECTOR\nexample-schedule3-20230330083511   Completed   0        0          2023-03-30 16:35:11 +0800 CST   2d        default            &lt;none&gt;\nnginx-backup                       Completed   0        0          2023-03-30 10:29:56 +0800 CST   29d       default            app=nginx\n</code></pre>"},{"location":"helm/Install-Velero/#5","title":"5 \u67e5\u770b\u65e5\u5fd7","text":"<pre><code># \u67e5\u770bdeploy \u65e5\u5fd7\n$ kubectl logs -f --tail 1000  deployment/velero -n velero\n\n\n# \u68c0\u67e5\u5907\u4efd\u5b58\u50a8\u4f4d\u7f6e\u7684\u72b6\u6001\uff0c\u663e\u793a\u5907\u4efd\u5b58\u50a8\u4f4d\u7f6e\u7684\u5f53\u524d\u72b6\u6001\u4ee5\u53ca\u53ef\u80fd\u5b58\u5728\u7684\u4efb\u4f55\u9519\u8bef\n$ velero backup-location get -n velero\n</code></pre>"},{"location":"helm/Install-Velero/#6","title":"6 \u8c03\u4f18","text":""},{"location":"helm/Install-Velero/#61","title":"6.1 \u4fee\u6539\u65e5\u5fd7\u7ea7\u522b","text":"<p>\u9ed8\u8ba4<code>info</code></p> <pre><code>...\n      containers:\n        - name: velero\n          image: 'harbor.dockerregistry.com/gitops/velero/velero:v1.10.2'\n          command:\n            - /velero\n          args:\n            - server\n            - '--features='\n            - '--uploader-type=restic'\n            - '--log-level=debug'  ## \u52a0\u5728\u8fd9\u91cc\n</code></pre>"},{"location":"helm/Install-Velero/#62","title":"6.2 \u547d\u4ee4\u81ea\u52a8\u8865\u5168","text":"<p>\u5148\u5b9e\u73b0 <code>kubectl</code> \u547d\u4ee4\u81ea\u52a8\u8865\u5168</p> <pre><code>yum install -y bash-completion\nsource /usr/share/bash-completion/bash_completion\nsource &lt;(kubectl completion bash)\necho \"source &lt;(kubectl completion bash)\" &gt;&gt; ~/.bashrc\nsource ~/.bashrc\n</code></pre> <p>\u518d\u5b9e\u73b0<code>velero</code> \u547d\u4ee4\u81ea\u52a8\u8865\u5168</p> <pre><code>source /usr/share/bash-completion/bash_completion\necho 'source &lt;(velero completion bash)' &gt;&gt;~/.bashrc\nvelero completion bash &gt;/etc/bash_completion.d/velero\necho 'alias v=velero' &gt;&gt;~/.bashrc\necho 'complete -F __start_velero v' &gt;&gt;~/.bashrc\nsource ~/.bashrc\n</code></pre>"},{"location":"helm/Install-Velero/#63","title":"6.3 \u65f6\u533a\u95ee\u9898\u8c03\u6574","text":"<p>\u9ed8\u8ba4\u4f7f\u7528\u7684\u662f<code>UTC</code> \u65f6\u95f4</p> <pre><code>kind: Deployment\napiVersion: apps/v1\nmetadata:\n  name: velero\n  namespace: velero\n  labels:\n    component: velero\n  annotations:\n    deployment.kubernetes.io/revision: '6'\nspec:\n  replicas: 1\n  selector:\n    matchLabels:\n      deploy: velero\n  template:\n    metadata:\n      creationTimestamp: null\n      labels:\n        component: velero\n        deploy: velero\n      annotations:\n        prometheus.io/path: /metrics\n        prometheus.io/port: '8085'\n        prometheus.io/scrape: 'true'\n    spec:\n      volumes:\n        - name: plugins\n          emptyDir: {}\n        - name: scratch\n          emptyDir: {}\n        - name: cloud-credentials\n          secret:\n            secretName: cloud-credentials\n            defaultMode: 420\n        - name: host-time             ######################### \u8fd9\u91cc\uff0c\u540c\u6b65\u4e3b\u673a\u65f6\u95f4\n          hostPath:\n            path: /etc/localtime\n            type: ''\n      initContainers:\n        - name: gitops-velero-velero-plugin-for-aws\n          image: 'harbor.dockerregistry.com/gitops/velero/velero-plugin-for-aws:v1.6.0'\n          resources: {}\n          volumeMounts:\n            - name: plugins\n              mountPath: /target\n          terminationMessagePath: /dev/termination-log\n          terminationMessagePolicy: File\n          imagePullPolicy: IfNotPresent\n      containers:\n        - name: velero\n          image: 'harbor.dockerregistry.com/gitops/velero/velero:v1.10.2'\n          command:\n            - /velero\n          args:\n            - server\n            - '--features='\n            - '--uploader-type=restic'\n            - '--log-level=debug'\n          ports:\n            - name: metrics\n              containerPort: 8085\n              protocol: TCP\n          env:\n            - name: VELERO_SCRATCH_DIR\n              value: /scratch\n            - name: VELERO_NAMESPACE\n              valueFrom:\n                fieldRef:\n                  apiVersion: v1\n                  fieldPath: metadata.namespace\n            - name: LD_LIBRARY_PATH\n              value: /plugins\n            - name: GOOGLE_APPLICATION_CREDENTIALS\n              value: /credentials/cloud\n            - name: AWS_SHARED_CREDENTIALS_FILE\n              value: /credentials/cloud\n            - name: AZURE_CREDENTIALS_FILE\n              value: /credentials/cloud\n            - name: ALIBABA_CLOUD_CREDENTIALS_FILE\n              value: /credentials/cloud\n          resources:\n            limits:\n              cpu: '1'\n              memory: 512Mi\n            requests:\n              cpu: 500m\n              memory: 128Mi\n          volumeMounts:\n            - name: plugins\n              mountPath: /plugins\n            - name: scratch\n              mountPath: /scratch\n            - name: cloud-credentials\n              mountPath: /credentials\n            - name: host-time               ######################### \u8fd9\u91cc\uff0c\u540c\u6b65\u4e3b\u673a\u65f6\u95f4\n              readOnly: true\n              mountPath: /etc/localtime\n          terminationMessagePath: /dev/termination-log\n          terminationMessagePolicy: File\n          imagePullPolicy: IfNotPresent\n      restartPolicy: Always\n      terminationGracePeriodSeconds: 30\n      dnsPolicy: ClusterFirst\n      serviceAccountName: velero\n      serviceAccount: velero\n      securityContext: {}\n      schedulerName: default-scheduler\n  strategy:\n    type: RollingUpdate\n    rollingUpdate:\n      maxUnavailable: 25%\n      maxSurge: 25%\n  revisionHistoryLimit: 10\n  progressDeadlineSeconds: 600\n</code></pre>"},{"location":"helm/Install-Velero/#7","title":"7 \u5b89\u88c5\u9009\u9879","text":"<p>[\u5b98\u65b9\u6587\u6863](https://velero.io/docs/main/customize-installation/#plugins</p> <pre><code># minio \u505a\u5916\u90e8\u5907\u4efd\u5b58\u50a8\u7684\u5907\u4efd\u670d\u52a1\u7aef\u5b89\u88c5\u65b9\u5f0f\n$ velero install \\\n    --provider aws \\\n    --plugins harbor.dockerregistry.com/gitops/velero/velero-plugin-for-aws:v1.6.0 \\\n    --bucket fish-velero \\\n    --secret-file ./credentials-velero \\\n    --use-volume-snapshots=false \\\n    --backup-location-config region=minio,s3ForcePathStyle=\"true\",s3Url=http://10.1.1.1:9000\n</code></pre>"},{"location":"helm/Install-Velero/#71","title":"7.1 \u6307\u5b9a\u547d\u540d\u7a7a\u95f4","text":"<p>\u9ed8\u8ba4\u670d\u52a1\u7aef\u548c\u5ba2\u6237\u7aef\u90fd\u662f\u627e\u7684\u547d\u540d\u7a7a\u95f4 <code>velero</code></p> <pre><code>## \u90e8\u7f72\u670d\u52a1\u7aef\u65f6\u6307\u5b9a\n# velero install [flags]\nvelero install \\\n--namespace xxx\n\n## \u5ba2\u6237\u7aef\u9700\u8981\u914d\u7f6e\u4e3a\u4e00\u81f4\n# velero client config set KEY=VALUE [KEY=VALUE]... [flags]\nvelero client config set namespace=$NAMESPACE_VALUE\n</code></pre>"},{"location":"helm/Install-Velero/#8","title":"8 \u5907\u4efd\u9009\u9879","text":""},{"location":"helm/Install-Velero/#81","title":"8.1 \u542f\u7528\u6587\u4ef6\u7cfb\u7edf\u5907\u4efd","text":"<pre><code>## \u90e8\u7f72\u670d\u52a1\u7aef\u65f6\u6307\u5b9a\n# velero install [flags]\nvelero install \\\n--use-node-agent\n</code></pre>"},{"location":"helm/Install-Velero/#82","title":"8.2 \u5f00\u6e90\u5907\u4efd\u5de5\u5177\u5c40\u9650\u6027","text":"<p>\u7efc\u5408\u8bc4\u4f30\uff0c\u5efa\u8bae\u5728\u4f7f\u7528\u5f00\u6e90\u5907\u4efd\u5de5\u5177 <code>restic</code> \u3001 <code>kopia</code> \u65f6\uff0c\u4f7f\u7528\u72ec\u7acb\u6216\u66f4\u9ad8\u914d\u7f6e\u7684\u670d\u52a1\u5668\u505a\u4e3a\u5ba2\u6237\u7aef\uff0c\u5efa\u8bae\u81f3\u5c11\u53ef\u7528\u914d\u7f6e\u5728<code>4C\u30014G</code> \uff0c\u65b9\u4fbf\u5ba2\u6237\u7aef\u518d\u6267\u884c\u5907\u4efd\u5de5\u4f5c\u65f6\u6709\u7684\u8d44\u6e90\u53ef\u7528\uff0c\u540c\u65f6\uff0c<code>kopia</code> \u76f8\u8f83\u6765\u8bf4\u66f4\u6ee1\u8db3\u5927\u90e8\u5206\u573a\u666f\u9700\u6c42\u3002\u8fd9\u91cc\u662f\u5b98\u65b9\u6d4b\u8bc4\u62a5\u544a</p>"},{"location":"kubernetes/Init-LB/","title":"Install LB","text":""},{"location":"kubernetes/Init-LB/#1-keepalived","title":"1 \u5b89\u88c5 <code>Keepalived</code>","text":"<pre><code>## \u4e3b\u670d\u52a1\u5668\u914d\u7f6e\napt-get update\napt-get install psmisc\napt install -y keepalived\n\nroot@debian:~# cat /etc/keepalived/check_apiserver.sh \n#!/bin/bash\n\nAPI_URL=\"https://192.168.1.110:6443/healthz\"\n\nif curl -k -s $API_URL | grep -q \"ok\"\nthen\n    exit 0\nelse\n    exit 1\nfi\n\n\ncat &lt;&lt;EOF | tee /etc/keepalived/keepalived.conf\n! Configuration File for keepalived\nglobal_defs {\n    router_id LVS_DEVEL\n}\nvrrp_script check_haproxy {\n    script \"/usr/bin/killall -0 haproxy\" \n    interval 2 \n    weight 2 \n}\nvrrp_script check_apiserver {\n  script \"/etc/keepalived/check_apiserver.sh\"\n  interval 3\n  weight -2\n  fall 10\n  rise 2\n}\n\nvrrp_instance VI_1 {\n    state MASTER\n    interface ens192\n    virtual_router_id 51\n    priority 101\n    authentication {\n        auth_type PASS\n        auth_pass 1111\n    }\n    virtual_ipaddress {\n        192.168.1.110\n    }\n    unicast_src_ip 192.168.1.111  # This haproxy node\n    unicast_peer {\n        192.168.1.112             # Other haproxy nodes\n    }\n    track_script {\n        check_apiserver\n        check_haproxy\n    }\n}\nEOF\n\nkeepalived -t -f /etc/keepalived/keepalived.conf\nsystemctl start keepalived\nsystemctl enable keepalived\nsystemctl status keepalived\n\n\n## \u5907\u670d\u52a1\u5668\u914d\u7f6e\napt-get update\napt-get install psmisc\napt install -y keepalived\n\nroot@debian:~# cat /etc/keepalived/check_apiserver.sh \n#!/bin/bash\n\nAPI_URL=\"https://192.168.1.110:6443/healthz\"\n\nif curl -k -s $API_URL | grep -q \"ok\"\nthen\n    exit 0\nelse\n    exit 1\nfi\n\ncat &lt;&lt;EOF | tee /etc/keepalived/keepalived.conf\n! Configuration File for keepalived\nglobal_defs {\n    router_id LVS_DEVEL\n}\nvrrp_script check_haproxy {\n    script \"/usr/bin/killall -0 haproxy\" \n    interval 2 \n    weight 2 \n}\nvrrp_script check_apiserver {\n  script \"/etc/keepalived/check_apiserver.sh\"\n  interval 3\n  weight -2\n  fall 10\n  rise 2\n}\n\nvrrp_instance VI_1 {\n    state BACKUP\n    interface ens192\n    virtual_router_id 51\n    priority 100\n    authentication {\n        auth_type PASS\n        auth_pass 1111\n    }\n    virtual_ipaddress {\n        192.168.1.110\n    }\n    unicast_src_ip 192.168.1.112  # This haproxy node\n    unicast_peer {\n        192.168.1.111             # Other haproxy nodes\n    }\n    track_script {\n        check_apiserver\n        check_haproxy\n    }\n}\nEOF\n\nkeepalived -t -f /etc/keepalived/keepalived.conf\n\nsystemctl start keepalived\nsystemctl enable keepalived\nsystemctl status keepalived\n</code></pre>"},{"location":"kubernetes/Init-LB/#2-haproxy","title":"2 \u5b89\u88c5 <code>Haproxy</code>","text":"<pre><code>## deploy haproxy in both vm.\napt install -y haproxy\ncat &lt;&lt;EOF | tee /etc/haproxy/haproxy.cfg  \n# /etc/haproxy/haproxy.cfg\n#---------------------------------------------------------------------\n# Global settings\n#---------------------------------------------------------------------\nglobal\n    log /dev/log local0\n    log /dev/log local1 notice\n    daemon\n\n#---------------------------------------------------------------------\n# common defaults that all the 'listen' and 'backend' sections will\n# use if not designated in their block\n#---------------------------------------------------------------------\ndefaults\n    mode                    http\n    log                     global\n    option                  httplog\n    option                  dontlognull\n    option http-server-close\n    option forwardfor       except 127.0.0.0/8\n    option                  redispatch\n    retries                 1\n    timeout http-request    10s\n    timeout queue           20s\n    timeout connect         5s\n    timeout client          20s\n    timeout server          20s\n    timeout http-keep-alive 10s\n    timeout check           10s\n\n#---------------------------------------------------------------------\n# apiserver frontend which proxys to the control plane nodes\n#---------------------------------------------------------------------\nfrontend apiserver\n    bind *:6443\n    mode tcp\n    option tcplog\n    default_backend apiserver\n\n#---------------------------------------------------------------------\n# round robin balancing for apiserver\n#---------------------------------------------------------------------\nbackend apiserver\n    option httpchk GET /healthz\n    http-check expect status 200\n    mode tcp\n    option ssl-hello-chk\n    balance     roundrobin\n        server master1 192.168.171.136:6443 check\n        server master2 192.168.171.137:6443 check\n        server master3 192.168.171.138:6443 check\n\nEOF\nsystemctl start  haproxy\nsystemctl enable haproxy\nsystemctl status haproxy\n</code></pre>"},{"location":"kubernetes/Init-Node/","title":"Init Node","text":""},{"location":"kubernetes/Init-Node/#1-refresh-disk-optional","title":"1 Refresh disk (optional)","text":"<pre><code># mount \n# /media/cdrom/\napt-cdrom add \n</code></pre>"},{"location":"kubernetes/Init-Node/#2-add-software-source","title":"2 Add software source","text":"<pre><code># add internet repo\n# \u5220\u9664\u6ce8\u91ca\u884c\uff08\u4ee5#\u5f00\u5934\u7684\u884c\u6216\u8005\u7a7a\u884c\uff09\nsed -i '/^#/d; /^$/d' /etc/apt/sources.list\n# \u6ce8\u91ca\u6389\u539f\u59cb\u884c\nsed -i 's/^deb cdrom:\\[Debian GNU\\/Linux.*$/#&amp;/' /etc/apt/sources.list\n# \u5220\u9664\u5b89\u5168\u884c\nsed -i '/^deb http:\\/\\/security.debian.org\\/debian-security/d' /etc/apt/sources.list\nsed -i '/^deb-src http:\\/\\/security.debian.org\\/debian-security/d' /etc/apt/sources.list\n# \u6dfb\u52a0\u65b0\u7684\u884c\nsh -c 'echo \"deb http://mirrors.tuna.tsinghua.edu.cn/debian/ bullseye main contrib non-free\" &gt;&gt; /etc/apt/sources.list'\nsh -c 'echo \"deb http://mirrors.tuna.tsinghua.edu.cn/debian/ bullseye-updates main contrib non-free\" &gt;&gt; /etc/apt/sources.list'\nsh -c 'echo \"deb http://mirrors.tuna.tsinghua.edu.cn/debian/ bullseye-backports main contrib non-free\" &gt;&gt; /etc/apt/sources.list'\nsh -c 'echo \"deb http://mirrors.tuna.tsinghua.edu.cn/debian-security bullseye-security main contrib non-free\" &gt;&gt; /etc/apt/sources.list'\n</code></pre>"},{"location":"kubernetes/Init-Node/#3-update-software","title":"3 Update software","text":"<pre><code># update soft\napt update \napt upgrade -y \n</code></pre>"},{"location":"kubernetes/Init-Node/#4-installation-tools","title":"4 Installation tools","text":"<pre><code># use local repo to install pkg\napt update\napt install -y  \\\napt-transport-https ca-certificates vim net-tools sudo telnet ufw iotop rsync unzip  \\\niputils-ping  gawk sed  cron gnupg locales curl wget  nfs-common  sshpass tree software-properties-common\n\napt-get install nfs-common -y\n</code></pre>"},{"location":"kubernetes/Init-Node/#5-confirm-system-language","title":"5 Confirm system language","text":"<pre><code># change to en\nlocale-gen en_US.UTF-8\nsed -i 's/LANG=\"zh_CN.UTF-8\"/LANG=\"en_US.UTF-8\"/' /etc/default/locale\nsed -i 's/LANGUAGE=\"zh_CN:zh\"/LANGUAGE=\"en_US:en\"/' /etc/default/locale\nsed -i 's/^zh_CN.UTF-8 UTF-8/#zh_CN.UTF-8 UTF-8/' /etc/locale.gen\nsed -i 's/#en_US.UTF-8 UTF-8/en_US.UTF-8 UTF-8/' /etc/locale.gen\n\ncat &lt;&lt;-EOF | tee  /etc/default/locale\nLC_ALL=en_US.utf8\nLANG=en_US.utf8\nLANGUAGE=en_US.utf8\nEOF\n\nlocale-gen\n# dpkg-reconfigure locales # \u53ea\u9009\u62e9 en_US.UTF-8\uff0c\u53bb\u6389 zh_CN.UTF-8 (\u82e5\u5b58\u5728)\n\n\necho \"export LANG=en_US.utf8\" &gt;&gt; /etc/profile\necho \"export LANGUAGE=en_US.utf8\" &gt;&gt; /etc/profile\nsource /etc/profile\n</code></pre>"},{"location":"kubernetes/Init-Node/#6-open-remote","title":"6 open remote","text":"<pre><code># export root ssh\nsed -ri 's/#PermitRootLogin prohibit-password/PermitRootLogin yes/' /etc/ssh/sshd_config\nservice ssh restart\negrep '^PermitRootLogin' /etc/ssh/sshd_config\n</code></pre>"},{"location":"kubernetes/Init-Node/#7-modify-display","title":"7 Modify display","text":"<pre><code># .bashrc\n\nsed -i '/^# export LS_OPTIONS/s/^# //' ~/.bashrc\nsed -i '/^# eval \"\\$(dircolors)\"/s/^# //' ~/.bashrc\nsed -i '/^# alias ls=/s/^# //' ~/.bashrc\nsed -i '/^# alias ll=/s/^# //' ~/.bashrc\nsed -i '/^# alias l=/s/^# //' ~/.bashrc\n\nsource ~/.bashrc\n</code></pre>"},{"location":"kubernetes/Init-Node/#8-modify-static-ip-optional","title":"8 Modify static IP (optional)","text":"<p>\u82e5\u5df2\u914d\u7f6e\u8bf7\u5ffd\u7565</p> <pre><code># static ip \nvim /etc/network/interfaces\n\n$ cat  /etc/network/interfaces\n# This file describes the network interfaces available on your system\n# and how to activate them. For more information, see interfaces(5).\n\nsource /etc/network/interfaces.d/*\n\n# The loopback network interface\nauto lo\niface lo inet loopback\n\n# The primary network interface\n#allow-hotplug ens32\n#iface ens32 inet dhcp\nauto ens32\niface ens32 inet static\n    address 192.168.171.136\n    netmask 255.255.255.0\n    gateway 192.168.171.2\n</code></pre>"},{"location":"kubernetes/Init-Node/#9-close-swap","title":"9 Close <code>swap</code>","text":"<pre><code># swapoff (if exited)\nswapoff -a\nsed -i '/swap/d' /etc/fstab\nmount -a\n</code></pre>"},{"location":"kubernetes/Init-Node/#10-remove-service","title":"10 Remove service","text":"<pre><code>systemctl stop rpcbind\nsystemctl disable rpcbind\napt autoremove rpcbind -y\n</code></pre>"},{"location":"kubernetes/Init-Node/#11-restart-the-machine","title":"11 Restart the machine","text":"<pre><code># reboot\nsync;reboot\n</code></pre>"},{"location":"kubernetes/Init-k8s-Cluster-Env/","title":"Init k8s Cluster Env","text":""},{"location":"kubernetes/Init-k8s-Cluster-Env/#1-office-others-doc","title":"1 Office &amp; others doc","text":"<pre><code># https://blog.csdn.net/m0_51510236/article/details/134142834#_kubeadmkubectlkubelet_500\n# https://www.bilibili.com/video/BV1HN4y167fQ?p=6\n# https://blog.csdn.net/lswzw/article/details/109027255\n# https://gist.github.com/islishude/231659cec0305ace090b933ce851994a\n# https://v1-27.docs.kubernetes.io/docs/reference/setup-tools/kubeadm/kubeadm-init/#config-file\n# https://v1-27.docs.kubernetes.io/docs/setup/production-environment/tools/kubeadm/create-cluster-kubeadm/#pod-network\n# https://v1-27.docs.kubernetes.io/docs/setup/production-environment/tools/kubeadm/create-cluster-kubeadm/\n</code></pre>"},{"location":"kubernetes/Init-k8s-Cluster-Env/#2-change-dns","title":"2 Change dns","text":"<pre><code># on master nodes.\nhostnamectl set-hostname master1.k8sCluster.com\nhostnamectl set-hostname master2.k8sCluster.com\nhostnamectl set-hostname master3.k8sCluster.com\n\n# on worker nodes.\nhostnamectl set-hostname worker1.k8sCluster.com\n\n\n# on master1 node.\n# add dns \necho -e \"\\n192.168.171.136  etcd1\"      &gt;&gt; /etc/hosts\necho -e \"192.168.171.50  harbor   harbor.dockerregistry.com\"  &gt;&gt; /etc/hosts\necho -e \"192.168.171.136  master1  master1.k8sCluster.com\"  &gt;&gt; /etc/hosts\necho -e \"192.168.171.137  master2  master1.k8sCluster.com\"  &gt;&gt; /etc/hosts\necho -e \"192.168.171.138  master3  master1.k8sCluster.com\"  &gt;&gt; /etc/hosts\necho -e \"192.168.171.139  worker1  worker1.k8sCluster.com\"  &gt;&gt; /etc/hosts\n# push public-key\n# ssh-keygen -t rsa -N \"\" -f ~/.ssh/id_rsa\nsshpass -p 'a' ssh-copy-id -o StrictHostKeyChecking=no -i ~/.ssh/id_rsa.pub \"root@harbor\"\nsshpass -p 'a' ssh-copy-id -o StrictHostKeyChecking=no -i ~/.ssh/id_rsa.pub \"root@etcd1\"\nsshpass -p 'a' ssh-copy-id -o StrictHostKeyChecking=no -i ~/.ssh/id_rsa.pub \"root@master1\"\nsshpass -p 'a' ssh-copy-id -o StrictHostKeyChecking=no -i ~/.ssh/id_rsa.pub \"root@master2\"\nsshpass -p 'a' ssh-copy-id -o StrictHostKeyChecking=no -i ~/.ssh/id_rsa.pub \"root@worker1\"\n# scp files to others nodes.\nscp -r /etc/hosts master2:/etc/\nscp -r /etc/hosts master3:/etc/\nscp -r /etc/hosts worker1:/etc/\n# off swap\nswapoff -a\nsed -i '/swap/d' /etc/fstab\nmount -a\nssh master2 \"swapoff -a &amp;&amp; sed -i '/swap/d' /etc/fstab &amp;&amp; mount -a\"\nssh master3 \"swapoff -a &amp;&amp; sed -i '/swap/d' /etc/fstab &amp;&amp; mount -a\"\nssh worker1 \"swapoff -a &amp;&amp; sed -i '/swap/d' /etc/fstab &amp;&amp; mount -a\"\n</code></pre>"},{"location":"kubernetes/Init-k8s-Cluster-Env/#3-upload-files","title":"3 Upload files","text":"<pre><code># on master1 \n\n# upload files to /root\nroot@master1:~# ls -lh \ntotal 350M\n-rw-r--r-- 1 root root  39M Oct 16 17:21 cni-plugins-linux-amd64-v1.2.0.tgz\n-rw-r--r-- 1 root root  45M Oct 16 16:59 containerd-1.7.6-linux-amd64.tar.gz\n-rw-r--r-- 1 root root 1.3K Oct 16 17:06 containerd.service\n-rw-r--r-- 1 root root  16M Nov 17 10:44 helm-v3.12.3-linux-amd64.tar.gz\n-rwxr-xr-x 1 root root 2.2K Dec  1 09:37 init-os-debian.sh\n-rw-r--r-- 1 root root 241M Oct 16 17:52 nerdctl-full-1.6.2-linux-amd64.tar.gz\n-rw-r--r-- 1 root root  11M Oct 16 17:16 runc.amd64\n\n\n# add harbor &amp; etcd ca files.\n\nmkdir -p /etc/tls/harbor/     /etc/kubernetes/pki/etcd/\n# upload ca file to localhost.\nscp -r harbor:/etc/docker/certs.d/harbor.dockerregistry.com  /etc/tls/harbor/\nscp -r etcd1:/etc/etcd/ssl/etcd-ca.pem    /etc/kubernetes/pki/etcd/\nscp -r etcd1:/etc/etcd/ssl/client.pem     /etc/kubernetes/pki/apiserver-etcd-client.pem\nscp -r etcd1:/etc/etcd/ssl/client-key.pem /etc/kubernetes/pki/apiserver-etcd-client-key.pem\n\nroot@master1:~# tree /etc/tls/harbor/\n/etc/tls/harbor/\n\u2514\u2500\u2500 harbor.dockerregistry.com\n    \u251c\u2500\u2500 ca.crt\n    \u251c\u2500\u2500 harbor.dockerregistry.com.cert\n    \u2514\u2500\u2500 harbor.dockerregistry.com.key\n\n1 directory, 3 files\n\nroot@master1:~# tree /etc/kubernetes/pki/\n/etc/kubernetes/pki/\n\u251c\u2500\u2500 apiserver-etcd-client-key.pem\n\u251c\u2500\u2500 apiserver-etcd-client.pem\n\u2514\u2500\u2500 etcd\n    \u2514\u2500\u2500 etcd-ca.pem\n\n1 directory, 3 files\n\n\n# scp to others nodes.\nscp -r ./* master2:/root/\nscp -r ./* master3:/root/\nscp -r ./* worker1:/root/\n\nssh master2 \"mkdir -p /etc/tls/harbor/ /etc/kubernetes/pki/etcd/\"\nssh master3 \"mkdir -p /etc/tls/harbor/ /etc/kubernetes/pki/etcd/\"\nssh worker1 \"mkdir -p /etc/tls/harbor/ /etc/kubernetes/pki/etcd/\"\n\nscp -r  /etc/tls/harbor/* master2:/etc/tls/harbor/\nscp -r  /etc/tls/harbor/* master3:/etc/tls/harbor/\nscp -r  /etc/tls/harbor/* worker1:/etc/tls/harbor/\n\nscp -r  /etc/kubernetes/pki/* master2:/etc/kubernetes/pki/\nscp -r  /etc/kubernetes/pki/* master3:/etc/kubernetes/pki/\nscp -r  /etc/kubernetes/pki/* worker1:/etc/kubernetes/pki/\n\n# all nodes.\n\\cp -rvf /etc/tls/harbor/harbor.dockerregistry.com/ca.crt /usr/local/share/ca-certificates/\n\\cp -rvf /etc/tls/harbor/harbor.dockerregistry.com/harbor.dockerregistry.com.cert /usr/local/share/ca-certificates/\n\n# \u66f4\u65b0\u8bc1\u4e66\u5b58\u50a8\nupdate-ca-certificates\n\n# \u91cd\u542f \u8fd0\u884c\u65f6 \u670d\u52a1\nsystemctl restart containerd\n</code></pre>"},{"location":"kubernetes/Init-k8s-Cluster-Env/#4-install-containerd","title":"4 Install containerd","text":"<pre><code># on all nodes.\n\n# https://github.com/containerd/containerd/blob/main/docs/getting-started.md\n# https://github.com/containerd/containerd/releases\ntar Cxzvf /usr/local containerd-1.7.6-linux-amd64.tar.gz\n\n# https://raw.githubusercontent.com/containerd/containerd/main/containerd.service\nmkdir -p /usr/local/lib/systemd/system/\n\\cp -rvf containerd.service  /usr/local/lib/systemd/system/containerd.service \nsystemctl daemon-reload\nsystemctl enable --now containerd\n\n# product config\nmkdir -p /etc/containerd\ncontainerd config default &gt; /etc/containerd/config.toml\n\nmkdir -p /data/containerd\n\nvim /etc/containerd/config.toml\n...\nrequired_plugins = []\n# change dir to /data\nroot = \"/data/containerd\"\nstate = \"/run/containerd\"\n...\n\n    sandbox_image = \"registry.aliyuncs.com/google_containers/pause:3.9\"\n...\n    [plugins.\"io.containerd.grpc.v1.cri\".registry]\n      config_path = \"\"\n      # right here to add \n      # public images repo\n      [plugins.\"io.containerd.grpc.v1.cri\".registry.mirrors.\"docker.io\"]\n        endpoint = [\"https://docker.mirrors.ustc.edu.cn\",\"http://hub-mirror.c.163.com\",\"https://ustc-edu-cn.mirror.aliyuncs.com\"]\n      [plugins.\"io.containerd.grpc.v1.cri\".registry.mirrors.\"gcr.io\"]\n        endpoint = [\"https://gcr.mirrors.ustc.edu.cn\"]\n      [plugins.\"io.containerd.grpc.v1.cri\".registry.mirrors.\"k8s.gcr.io\"]\n        endpoint = [\"https://gcr.mirrors.ustc.edu.cn/google-containers/\"]\n      [plugins.\"io.containerd.grpc.v1.cri\".registry.mirrors.\"quay.io\"]\n        endpoint = [\"https://quay.mirrors.ustc.edu.cn\"]\n\n      # local images repo\n      [plugins.\"io.containerd.grpc.v1.cri\".registry.mirrors.\"harbor.dockerregistry.com\"]\n        endpoint = [\"https://harbor.dockerregistry.com\"]\n        username = \"robot$5m2wwklmotet\"\n        password = \"zHQi7muaaqM2t3Cb4rcYnCYlJMddxA3b\"\n        [plugins.\"io.containerd.grpc.v1.cri\".registry.tls]\n          #insecure_skip_verify = false\n          ca_file = \"/etc/tls/harbor/harbor.dockerregistry.com/ca.crt\"\n          cert_file = \"/etc/tls/harbor/harbor.dockerregistry.com/harbor.dockerregistry.com.cert\"\n          key_file = \"/etc/tls/harbor/harbor.dockerregistry.com/harbor.dockerregistry.com.key\"\n...\n          [plugins.\"io.containerd.grpc.v1.cri\".containerd.runtimes.runc.options]\n            SystemdCgroup = true\n\n# on master1 \nscp -r /etc/containerd/config.toml master2:/etc/containerd/\nscp -r /etc/containerd/config.toml master3:/etc/containerd/\nscp -r /etc/containerd/config.toml worker1:/etc/containerd/\n\n\n# restart service\nsystemctl daemon-reload \nsystemctl restart containerd\nsystemctl status  containerd\n</code></pre>"},{"location":"kubernetes/Init-k8s-Cluster-Env/#5-install-runc","title":"5 Install runc","text":"<pre><code># on all nodes.\n\n# https://github.com/opencontainers/runc/releases\ninstall -m 755 runc.amd64 /usr/local/sbin/runc\n</code></pre>"},{"location":"kubernetes/Init-k8s-Cluster-Env/#6-install-cni","title":"6 Install cni","text":"<pre><code># on all nodes.\n\n# https://github.com/containernetworking/plugins/releases\n#tar Cxzvf /usr/local/bin cni-plugins-linux-amd64-v1.2.0.tgz\n\nmkdir -p /opt/cni/bin\n\ntar Cxzvf /opt/cni/bin cni-plugins-linux-amd64-v1.2.0.tgz\n\nll /opt/cni/bin/dhcp\n</code></pre>"},{"location":"kubernetes/Init-k8s-Cluster-Env/#7-install-nerdctl","title":"7 Install nerdctl","text":"<pre><code># on all nodes.\n\n# https://github.com/containerd/nerdctl#install\ntar Cxzvf /usr/local nerdctl-full-1.6.2-linux-amd64.tar.gz\n\n# alias to docker\necho \"alias docker='nerdctl --namespace k8s.io'\"  &gt;&gt; /etc/profile\necho \"alias docker-compose='nerdctl compose'\"  &gt;&gt; /etc/profile\necho \"alias crictl='crictl --runtime-endpoint unix:///var/run/containerd/containerd.sock'\" &gt;&gt; /etc/profile\necho \"export ETCDETC_API=3\"  &gt;&gt; /etc/profile\nsource  /etc/profile\n\n\n# add config\nmkdir -p /etc/nerdctl/\ncat &gt; /etc/nerdctl/nerdctl.toml &lt;&lt; 'EOF'\nnamespace      = \"k8s.io\"\ninsecure_registry = true\ncni_path = \"/opt/cni/bin/\"\nEOF\n\n\n# login harbor\nroot@master1:~# docker login harbor.dockerregistry.com -u robot\\$5m2wwklmotet -p zHQi7muaaqM2t3Cb4rcYnCYlJMddxA3b\nWARN[0000] WARNING! Using --password via the CLI is insecure. Use --password-stdin. \nWARN[0000] skipping verifying HTTPS certs for \"harbor.dockerregistry.com\" \nWARNING: Your password will be stored unencrypted in /root/.docker/config.json.\nConfigure a credential helper to remove this warning. See\nhttps://docs.docker.com/engine/reference/commandline/login/#credentials-store\n\nLogin Succeeded\n\n# add buildkit\n\\cp -rvf /usr/local/lib/systemd/system/buildkit.service /lib/systemd/system/\nsystemctl enable buildkit.service --now\nsystemctl start buildkit.service --now\nsystemctl status buildkit.service --now\n</code></pre>"},{"location":"kubernetes/Init-k8s-Cluster-Env/#8-open-ipvs","title":"8 open ipvs","text":"<pre><code># Forwarding IPv4 and letting iptables see bridged traffic \n# https://v1-27.docs.kubernetes.io/docs/setup/production-environment/container-runtimes/#forwarding-ipv4-and-letting-iptables-see-bridged-traffic\n\n\n# on all nodes.\n\n\n# ipvs \ntee -a /etc/modules-load.d/ipvs.conf &lt;&lt; EOF\nip_vs\nip_vs_rr\nip_vs_wrr\nip_vs_sh\nnf_conntrack\nEOF\n\n# containerd\ncat &lt;&lt; EOF &gt; /etc/modules-load.d/containerd.conf\noverlay\nbr_netfilter\nEOF\n\n\nmodprobe overlay\nmodprobe br_netfilter\nmodprobe ip_vs\nmodprobe ip_vs_rr\nmodprobe ip_vs_wrr\nmodprobe ip_vs_sh\nmodprobe nf_conntrack\n\nupdate-initramfs -u\n\n\n\n# sysctl params required by setup, params persist across reboots\ncat &lt;&lt;EOF | tee /etc/sysctl.d/k8s.conf\nnet.bridge.bridge-nf-call-iptables  = 1\nnet.bridge.bridge-nf-call-ip6tables = 1\nnet.ipv4.ip_forward                 = 1\nvm.swappiness=0\nuser.max_user_namespaces=28633\nEOF\n\nsysctl -p \n\n# Apply sysctl params without reboot\nsysctl --system\n\n# Verify that the br_netfilter\nlsmod | grep br_netfilter\nlsmod | grep overlay\nlsmod | grep ip_vs\nlsmod | grep ip_vs_rr\nlsmod | grep ip_vs_wrr\nlsmod | grep ip_vs_sh\nlsmod | grep nf_conntrack\n\n# Verify that the net.bridge.bridge-nf-call-iptables, net.bridge.bridge-nf-call-ip6tables, and net.ipv4.ip_forward\nsysctl net.bridge.bridge-nf-call-iptables net.bridge.bridge-nf-call-ip6tables net.ipv4.ip_forward\n</code></pre>"},{"location":"kubernetes/Init-k8s-Cluster-Env/#9-install-net-tools","title":"9 Install net-tools","text":"<pre><code># on all nodes.\n\n\n# net-tools (optional)\napt install ipset ipvsadm -y\n</code></pre>"},{"location":"kubernetes/Init-k8s-Cluster-Env/#10-install-helm","title":"10 Install helm","text":"<pre><code># https://github.com/helm/helm/releases/tag/v3.12.3\n# https://get.helm.sh/helm-v3.12.3-linux-amd64.tar.gz\n\n# on all nodes.\n\n\ntar xf helm-v3.12.3-linux-amd64.tar.gz \nmv linux-amd64/helm /usr/local/bin/\nhelm version \n</code></pre>"},{"location":"kubernetes/Init-k8s-Cluster-Env/#11-add-soft-repo","title":"11 Add soft repo","text":"<pre><code># on all nodes.\n\n# add aliyun repo\ncurl https://mirrors.aliyun.com/kubernetes/apt/doc/apt-key.gpg | apt-key add -\nadd-apt-repository \"deb https://mirrors.aliyun.com/kubernetes/apt/ kubernetes-xenial main\"\n#curl -s https://packages.cloud.google.com/apt/doc/apt-key.gpg | sudo apt-key add -\n#echo \"deb https://apt.kubernetes.io/ kubernetes-xenial main\" | sudo tee -a /etc/apt/sources.list.d/kubernetes.list\napt update\n</code></pre>"},{"location":"kubernetes/Init-k8s-Cluster-Env/#12-stop-apparmor","title":"12 Stop apparmor","text":"<pre><code># https://stackoverflow.com/questions/49112336/container-runtime-network-not-ready-cni-config-uninitialized\n\n\n# on all nodes.\n\nsystemctl stop apparmor\nsystemctl disable apparmor \nsystemctl restart containerd.service\n</code></pre>"},{"location":"kubernetes/Init-k8s-Cluster-Env/#13-install-client","title":"13 Install client","text":"<pre><code># on all nodes.\n\n# install kubelet/kubeadm/kubectl\n# search version\napt list --all-versions kubelet | grep '1.27\\..*'\napt list --all-versions kubeadm | grep '1.27\\..*'\napt list --all-versions kubectl | grep '1.27\\..*'\n\n# install specified version \napt  install -y kubectl=1.27.6-00\napt  install -y kubelet=1.27.6-00\napt  install -y kubeadm=1.27.6-00\n\n# scan pkg version \napt list --installed | grep kubectl \napt list --installed | grep kubelet \napt list --installed | grep kubeadm \n\n# scan version \nkubectl   version\nkubelet --version\nkubeadm   version\n\n# enable for all hosts\nsystemctl enable kubelet\n\n\n# add completion\nsource &lt;(kubectl completion bash)\nsource &lt;(kubeadm completion bash)\n\n# hold version without update forever\napt-mark hold kubelet kubeadm kubectl\n\n\n# !!!note\uff1a update version if need.\napt-mark unhold kubelet kubeadm kubectl\napt-get install -y kubelet=1.27.8-00 kubeadm=1.27.8-00 kubectl=1.27.8-00  # apt source.list must update to be latest.\napt-mark hold kubelet kubeadm kubectl\n\n# !!!note\uff1a uninstall if need.\napt  autoremove -y kubectl\napt  autoremove -y kubelet\napt  autoremove -y kubeadm\n</code></pre>"},{"location":"kubernetes/Init-k8s-Cluster-Env/#14-add-auto-completion","title":"14 Add auto-completion","text":"<pre><code># on all nodes.\n\n# command auto-completion\napt update\napt install bash-completion\necho 'source &lt;(kubectl completion bash)' &gt;&gt; ~/.bashrc\nsource ~/.bashrc\n</code></pre>"},{"location":"kubernetes/Init-k8s-Cluster-Env/#15-pull-images","title":"15 Pull images","text":"<pre><code># on all nodes.\n\n# list &amp; pull images\nkubeadm config images list --kubernetes-version=v1.27.6\n# kubeadm config images pull \nkubeadm config images pull --kubernetes-version=v1.27.6 --image-repository='registry.aliyuncs.com/google_containers'\n</code></pre>"},{"location":"kubernetes/Init-k8s-Cluster-Env/#16-reboot","title":"16 Reboot","text":"<pre><code># on all nodes\nsync;reboot\n</code></pre>"},{"location":"kubernetes/Install-ETCD-Cluster/","title":"Install Etcd Cluster","text":""},{"location":"kubernetes/Install-ETCD-Cluster/#1-change-hostname","title":"1 change hostname","text":"<pre><code># on etcd1\nhostnamectl set-hostname etcd1\n# on etcd2\nhostnamectl set-hostname etcd2\n# on etcd3\nhostnamectl set-hostname etcd3\n</code></pre>"},{"location":"kubernetes/Install-ETCD-Cluster/#2-no-passwd-to-login","title":"2 no passwd to login","text":"<pre><code># On etcd1\ncd ~\nvim /etc/hosts\n# add dns\n192.168.171.136 etcd1\n192.168.171.137 etcd2\n192.168.171.138 etcd3\n\n# ssh-keygen -t rsa -N \"\" -f ~/.ssh/id_rsa\nsshpass -p '3qjQTv4ytU' ssh-copy-id -o StrictHostKeyChecking=no -i ~/.ssh/id_rsa.pub \"root@etcd1\"\nsshpass -p 'kplDP86PdP' ssh-copy-id -o StrictHostKeyChecking=no -i ~/.ssh/id_rsa.pub \"root@etcd2\"\nsshpass -p 'iWmtmQWWR0' ssh-copy-id -o StrictHostKeyChecking=no -i ~/.ssh/id_rsa.pub \"root@etcd3\"\n</code></pre>"},{"location":"kubernetes/Install-ETCD-Cluster/#3-add-api-version","title":"3 add api version","text":"<pre><code># On aLL etcd nodes\necho 'export ETCDETC_API=3' | tee -a /etc/profile\nsource /etc/profile\ngrep ETCDETC_API /etc/profile\n</code></pre>"},{"location":"kubernetes/Install-ETCD-Cluster/#4-install-cfssl","title":"4 install cfssl","text":"<pre><code># On aLL etcd nodes\n# install cfssl\n# https://github.com/cloudflare/cfssl/releases\n\\cp -rvf cfssl_1.6.3_linux_amd64     /usr/local/bin/cfssl \n\\cp -rvf cfssljson_1.6.3_linux_amd64 /usr/local/bin/cfssljson\nchmod +x /usr/local/bin/cfssl\nchmod +x /usr/local/bin/cfssljson\ncfssl version\ncfssljson -version \n</code></pre>"},{"location":"kubernetes/Install-ETCD-Cluster/#5-install-etcd","title":"5 install etcd","text":"<pre><code># On aLL etcd nodes\n# install etcd for three hosts.\n\ntar Cxzvf /tmp etcd-v3.5.8-linux-amd64.tar.gz \n\\cp -rvf /tmp/etcd-v3.5.8-linux-amd64/etcd* /usr/local/bin/\n\netcd --version\netcdctl version\n</code></pre>"},{"location":"kubernetes/Install-ETCD-Cluster/#6-create-tls-ca","title":"6 create tls ca","text":"<pre><code># On etcd1\n# create tls ca\nmkdir -p /etc/etcd/ssl\ncd /etc/etcd/ssl\n\ncat &lt;&lt;EOF | tee ca-config.json\n{\n    \"signing\": {\n        \"default\": {\n            \"expiry\": \"876000h\"\n        },\n        \"profiles\": {\n            \"server\": {\n                \"expiry\": \"876000h\",\n                \"usages\": [\n                    \"signing\",\n                    \"key encipherment\",\n                    \"server auth\",\n                    \"client auth\"\n                ]\n            },\n            \"client\": {\n                \"expiry\": \"876000h\",\n                \"usages\": [\n                    \"signing\",\n                    \"key encipherment\",\n                    \"client auth\"\n                ]\n            },\n            \"peer\": {\n                \"expiry\": \"876000h\",\n                \"usages\": [\n                    \"signing\",\n                    \"key encipherment\",\n                    \"server auth\",\n                    \"client auth\"\n                ]\n            }\n        }\n    }\n}\nEOF\n\n\ncat &lt;&lt;EOF | tee etcd-ca-csr.json\n{\n    \"key\": {\n        \"algo\": \"rsa\",\n        \"size\": 4096\n    },\n    \"names\": [\n        {\n            \"C\": \"CN\",\n            \"L\": \"Beijing\",\n            \"ST\": \"Beijing\",\n            \"O\": \"k8s\",\n            \"OU\": \"System\"\n        }\n    ]\n}\nEOF\n\n\n\n\ncat &lt;&lt;EOF | tee client-csr.json\n{\n    \"CN\": \"client\",\n    \"key\": {\n        \"algo\": \"rsa\",\n        \"size\": 2048\n    }\n}\nEOF\n\n\n# ! notes: Use your own etcd node IP address\ncat &lt;&lt;EOF | tee etcd-server-csr.json\n{\n    \"CN\": \"etcd-server\",\n    \"hosts\": [\n        \"192.168.171.136\",\n        \"192.168.171.137\",\n        \"192.168.171.138\",\n        \"127.0.0.1\"\n    ],\n    \"key\": {\n        \"algo\": \"rsa\",\n        \"size\": 2048\n    },\n    \"names\": [\n        {\n            \"C\": \"CN\",\n            \"L\": \"Beijing\",\n            \"O\": \"etcd-cluster\",\n            \"OU\": \"System\",\n            \"ST\": \"Beijing\"\n        }\n    ]\n}\nEOF\n\n# ! notes: Use your own etcd node IP address\ncat &lt;&lt;EOF | tee etcd-peer-csr.json\n{\n    \"CN\": \"etcd-peer\",\n    \"hosts\": [\n        \"192.168.171.136\",\n        \"192.168.171.137\",\n        \"192.168.171.138\",\n        \"127.0.0.1\"\n    ],\n    \"key\": {\n        \"algo\": \"rsa\",\n        \"size\": 2048\n    },\n    \"names\": [\n        {\n            \"C\": \"CN\",\n            \"L\": \"Beijing\",\n            \"O\": \"etcd-cluster\",\n            \"OU\": \"System\",\n            \"ST\": \"Beijing\"\n        }\n    ]\n}\nEOF\n\n\n## \u751f\u6210CA\u8bc1\u4e66\u548c\u79c1\u94a5\ncfssl gencert -initca etcd-ca-csr.json | cfssljson -bare etcd-ca - \n## \u751f\u6210\u5ba2\u6237\u7aef\u8bc1\u4e66\ncfssl gencert -ca=etcd-ca.pem -ca-key=etcd-ca-key.pem -config=ca-config.json -profile=client client-csr.json      | cfssljson -bare client - \n### \u53ef\u5ffd\u7565hosts \u672a\u914d\u7f6e\u8b66\u544a\uff1a\n### [WARNING] This certificate lacks a \"hosts\" field. This makes it unsuitable for websites. \n### For more information see the Baseline Requirements for the Issuance and Management of Publicly-Trusted Certificates, v.1.1.6, \n### from the CA/Browser Forum (https://cabforum.org); specifically, section 10.2.3 (\"Information Requirements\").'\n\n## \u751f\u6210server\uff0cpeer\u8bc1\u4e66\ncfssl gencert -ca=etcd-ca.pem -ca-key=etcd-ca-key.pem -config=ca-config.json -profile=server etcd-server-csr.json | cfssljson -bare etcd-server \ncfssl gencert -ca=etcd-ca.pem -ca-key=etcd-ca-key.pem -config=ca-config.json -profile=peer   etcd-peer-csr.json   | cfssljson -bare etcd-peer\n\n\n# all files\n$ tree /etc/etcd/ssl/\n/etc/etcd/ssl/\n\u251c\u2500\u2500 ca-config.json\n\u251c\u2500\u2500 client.csr\n\u251c\u2500\u2500 client-csr.json\n\u251c\u2500\u2500 client-key.pem\n\u251c\u2500\u2500 client.pem\n\u251c\u2500\u2500 etcd-ca.csr\n\u251c\u2500\u2500 etcd-ca-csr.json\n\u251c\u2500\u2500 etcd-ca-key.pem\n\u251c\u2500\u2500 etcd-ca.pem\n\u251c\u2500\u2500 etcd-peer.csr\n\u251c\u2500\u2500 etcd-peer-csr.json\n\u251c\u2500\u2500 etcd-peer-key.pem\n\u251c\u2500\u2500 etcd-peer.pem\n\u251c\u2500\u2500 etcd-server.csr\n\u251c\u2500\u2500 etcd-server-csr.json\n\u251c\u2500\u2500 etcd-server-key.pem\n\u2514\u2500\u2500 etcd-server.pem\n\n0 directories, 17 files\n\n$ tree /etc/etcd/ssl/ | grep pem\n\u251c\u2500\u2500 client-key.pem\n\u251c\u2500\u2500 client.pem\n\u251c\u2500\u2500 etcd-ca-key.pem\n\u251c\u2500\u2500 etcd-ca.pem\n\u251c\u2500\u2500 etcd-peer-key.pem\n\u251c\u2500\u2500 etcd-peer.pem\n\u251c\u2500\u2500 etcd-server-key.pem\n\u2514\u2500\u2500 etcd-server.pem\n</code></pre>"},{"location":"kubernetes/Install-ETCD-Cluster/#7-scp-ca-files","title":"7 scp ca files","text":"<pre><code># on etcd1 \n# scp files\n\nscp -r /etc/etcd  etcd2:/etc/\nscp -r /etc/etcd  etcd3:/etc/\n</code></pre>"},{"location":"kubernetes/Install-ETCD-Cluster/#8-create-service-config","title":"8 create service config","text":"<pre><code># create service config\n### rhel: /usr/lib/systemd/system/etcd.service \n### debian:  /lib/systemd/system/etcd.service\n\n# etcd and apiserver are in same host. \n# use \"Before=kube-apiserver.service\" \n\n\n## on etcd1 \n# ! notes: Use your own etcd node &amp; cluster IP address\n$ mkdir -p /data/etcd/ &amp;&amp; vim /lib/systemd/system/etcd.service\n\n[Unit]\nDescription=Etcd Server\nAfter=network.target\nAfter=network-online.target\nWants=network-online.target\nBefore=kube-apiserver.service\nDocumentation=https://github.com/coreos\n\n[Service]\nType=notify\nWorkingDirectory=/data/etcd/\nExecStart=/usr/local/bin/etcd \\\n --name=etcd1 \\\n --cert-file=/etc/etcd/ssl/etcd-server.pem \\\n --key-file=/etc/etcd/ssl/etcd-server-key.pem \\\n --peer-cert-file=/etc/etcd/ssl/etcd-peer.pem \\\n --peer-key-file=/etc/etcd/ssl/etcd-peer-key.pem \\\n --trusted-ca-file=/etc/etcd/ssl/etcd-ca.pem \\\n --peer-trusted-ca-file=/etc/etcd/ssl/etcd-ca.pem \\\n --initial-advertise-peer-urls=https://192.168.171.136:2380 \\\n --listen-peer-urls=https://192.168.171.136:2380 \\\n --listen-client-urls=https://192.168.171.136:2379 \\\n --advertise-client-urls=https://192.168.171.136:2379 \\\n --initial-cluster-token=etcd-cluster-0 \\\n --initial-cluster=etcd1=https://192.168.171.136:2380,etcd2=https://192.168.171.137:2380,etcd3=https://192.168.171.138:2380 \\\n --initial-cluster-state=new \\\n --data-dir=/data/etcd \\\n --snapshot-count=50000 \\\n --auto-compaction-retention=1 \\\n --max-request-bytes=10485760 \\\n --quota-backend-bytes=8589934592\nRestart=always\nRestartSec=15\nLimitNOFILE=65536\nOOMScoreAdjust=-999\n\n[Install]\nWantedBy=multi-user.target\n\n\n\n## on etcd2\n# ! notes: Use your own etcd node &amp; cluster IP address\n$ mkdir -p /data/etcd/ &amp;&amp; vim /lib/systemd/system/etcd.service\n\n[Unit]\nDescription=Etcd Server\nAfter=network.target\nAfter=network-online.target\nWants=network-online.target\nBefore=kube-apiserver.service\nDocumentation=https://github.com/coreos\n\n[Service]\nType=notify\nWorkingDirectory=/data/etcd/\nExecStart=/usr/local/bin/etcd \\\n  --name=etcd2 \\\n  --cert-file=/etc/etcd/ssl/etcd-server.pem \\\n  --key-file=/etc/etcd/ssl/etcd-server-key.pem \\\n  --peer-cert-file=/etc/etcd/ssl/etcd-peer.pem \\\n  --peer-key-file=/etc/etcd/ssl/etcd-peer-key.pem \\\n  --trusted-ca-file=/etc/etcd/ssl/etcd-ca.pem \\\n  --peer-trusted-ca-file=/etc/etcd/ssl/etcd-ca.pem \\\n  --initial-advertise-peer-urls=https://192.168.171.137:2380 \\\n  --listen-peer-urls=https://192.168.171.137:2380 \\\n  --listen-client-urls=https://192.168.171.137:2379 \\\n  --advertise-client-urls=https://192.168.171.137:2379 \\\n  --initial-cluster-token=etcd-cluster-0 \\\n  --initial-cluster=etcd1=https://192.168.171.136:2380,etcd2=https://192.168.171.137:2380,etcd3=https://192.168.171.138:2380 \\\n  --initial-cluster-state=new \\\n  --data-dir=/data/etcd \\\n  --snapshot-count=50000 \\\n  --auto-compaction-retention=1 \\\n  --max-request-bytes=10485760 \\\n  --quota-backend-bytes=8589934592\nRestart=always\nRestartSec=15\nLimitNOFILE=65536\nOOMScoreAdjust=-999\n\n[Install]\nWantedBy=multi-user.target\n\n\n\n\n\n\n## on  etcd3 \n# ! notes: Use your own etcd node &amp; cluster IP address\n$ mkdir -p /data/etcd/ &amp;&amp; vim /lib/systemd/system/etcd.service\n\n[Unit]\nDescription=Etcd Server\nAfter=network.target\nAfter=network-online.target\nWants=network-online.target\nBefore=kube-apiserver.service\nDocumentation=https://github.com/coreos\n\n[Service]\nType=notify\nWorkingDirectory=/data/etcd/\nExecStart=/usr/local/bin/etcd \\\n  --name=etcd3 \\\n  --cert-file=/etc/etcd/ssl/etcd-server.pem \\\n  --key-file=/etc/etcd/ssl/etcd-server-key.pem \\\n  --peer-cert-file=/etc/etcd/ssl/etcd-peer.pem \\\n  --peer-key-file=/etc/etcd/ssl/etcd-peer-key.pem \\\n  --trusted-ca-file=/etc/etcd/ssl/etcd-ca.pem \\\n  --peer-trusted-ca-file=/etc/etcd/ssl/etcd-ca.pem \\\n  --initial-advertise-peer-urls=https://192.168.171.138:2380 \\\n  --listen-peer-urls=https://192.168.171.138:2380 \\\n  --listen-client-urls=https://192.168.171.138:2379 \\\n  --advertise-client-urls=https://192.168.171.138:2379 \\\n  --initial-cluster-token=etcd-cluster-0 \\\n  --initial-cluster=etcd1=https://192.168.171.136:2380,etcd2=https://192.168.171.137:2380,etcd3=https://192.168.171.138:2380 \\\n  --initial-cluster-state=new \\\n  --data-dir=/data/etcd \\\n  --snapshot-count=50000 \\\n  --auto-compaction-retention=1 \\\n  --max-request-bytes=10485760 \\\n  --quota-backend-bytes=8589934592\nRestart=always\nRestartSec=15\nLimitNOFILE=65536\nOOMScoreAdjust=-999\n\n[Install]\nWantedBy=multi-user.target\n</code></pre>"},{"location":"kubernetes/Install-ETCD-Cluster/#9-start-service","title":"9 start service","text":"<pre><code># on all etcd nodes\n\n# start service \nsystemctl daemon-reload\nsystemctl enable etcd\nsystemctl start etcd \nsystemctl status etcd -l \n</code></pre>"},{"location":"kubernetes/Install-ETCD-Cluster/#10-view-logs","title":"10 view logs","text":"<pre><code># on all etcd nodes\n\n# other terminal query logs\njournalctl -xeu etcd -f\n</code></pre>"},{"location":"kubernetes/Install-ETCD-Cluster/#11-add-alias","title":"11 add alias","text":"<pre><code># on etcd1 \n# add alias\nvim ~/.bashrc\n# add alias \n# ! notes: Use your own etcd cluster IP address\nalias etcdctl='etcdctl \\\n        --endpoints=192.168.171.136:2379,192.168.171.137:2379,192.168.171.138:2379 \\\n        --cacert=/etc/etcd/ssl/etcd-ca.pem \\\n        --cert=/etc/etcd/ssl/etcd-server.pem   \\\n        --key=/etc/etcd/ssl/etcd-server-key.pem '\n\nsource ~/.bashrc\n\n\n# scp to other nodes.\nscp -r ~/.bashrc etcd2:~/\nscp -r ~/.bashrc etcd3:~/\n\nssh etcd2 \"source ~/.bashrc\"\nssh etcd3 \"source ~/.bashrc\"\n</code></pre>"},{"location":"kubernetes/Install-ETCD-Cluster/#12-endpoint-status-health","title":"12 endpoint status &amp; health","text":"<pre><code># on all etcd node.\n\n# \u67e5\u770b\u9009\u4e3b\n$ etcdctl endpoint status -w table\n+----------------------+------------------+---------+---------+-----------+------------+-----------+------------+--------------------+--------+\n|       ENDPOINT       |        ID        | VERSION | DB SIZE | IS LEADER | IS LEARNER | RAFT TERM | RAFT INDEX | RAFT APPLIED INDEX | ERRORS |\n+----------------------+------------------+---------+---------+-----------+------------+-----------+------------+--------------------+--------+\n| 192.168.171.136:2379 | 63a24950535b517e |   3.5.8 |   20 kB |      true |      false |         2 |          9 |                  9 |        |\n| 192.168.171.137:2379 | 6419b1a69bbf5747 |   3.5.8 |   20 kB |     false |      false |         2 |          9 |                  9 |        |\n| 192.168.171.138:2379 | b14454725168d230 |   3.5.8 |   20 kB |     false |      false |         2 |          9 |                  9 |        |\n+----------------------+------------------+---------+---------+-----------+------------+-----------+------------+--------------------+--------+\n\n# \u5065\u5eb7\u68c0\u67e5\n$ etcdctl endpoint health -w table\n+----------------------+--------+-------------+-------+\n|       ENDPOINT       | HEALTH |    TOOK     | ERROR |\n+----------------------+--------+-------------+-------+\n| 192.168.171.136:2379 |   true |  9.455597ms |       |\n| 192.168.171.137:2379 |   true |  9.162171ms |       |\n| 192.168.171.138:2379 |   true | 12.529629ms |       |\n+----------------------+--------+-------------+-------+\n</code></pre>"},{"location":"kubernetes/Install-ETCD-Cluster/#13-input-test","title":"13 input test","text":"<pre><code># on any etcd nodes.\n\n# \u5199\u5165\u6d4b\u8bd5\n$ etcdctl put lxs \"test\"\nOK\n\n# \u67e5\u770b\u6570\u636e\n$ etcdctl get lxs\nlxs\ntest\n\n# \u5220\u9664\u6d4b\u8bd5\n$ etcdctl del lxs\n1\n$ etcdctl get lxs\n\n\n# \u67e5\u770bkey\n$ etcdctl  --prefix --keys-only=true get /\n</code></pre>"},{"location":"kubernetes/Install-ETCD-Cluster/#13-add-backup-rules","title":"13 Add Backup Rules","text":"<pre><code># on etcd3 \nmkdir -p /data/etcd-backups/ &amp;&amp; cd /data/etcd-backups/\n\n\n# add script \n# change here ip in yourself\ntee etcd-backups.sh &lt;&lt;-EOF\n#!/bin/bash\n\n# ETCD backup directory\nBACKUP_DIR=/data/etcd-backups\n\n# Current date and time\nDATE=$(date +%Y%m%d%H%M%S)\n\n# Log file\nLOG_FILE=${BACKUP_DIR}/backup-${DATE}.log\n\n# ETCDCTL command\nETCDCTL_CMD=\"/usr/local/bin/etcdctl \\\n    --endpoints=192.168.1.120:2379 \\\n    --cacert=/etc/etcd/ssl/etcd-ca.pem \\\n    --cert=/etc/etcd/ssl/etcd-server.pem \\\n    --key=/etc/etcd/ssl/etcd-server-key.pem\"\n\n# ETCDCTL API version\nexport ETCDCTL_API=3\n\n# ETCD backup command\necho \"Starting backup at ${DATE}\" &gt; ${LOG_FILE}\n${ETCDCTL_CMD} snapshot save ${BACKUP_DIR}/backup-${DATE}.db &gt;&gt; ${LOG_FILE} 2&gt;&amp;1\n\n# Check if the backup was successful\nif [ $? -eq 0 ]; then\n    echo \"Backup successful\" &gt;&gt; ${LOG_FILE}\nelse\n    echo \"Backup failed\" &gt;&gt; ${LOG_FILE}\nfi\n\n# Remove backups older than 7 days\nfind ${BACKUP_DIR} -name \"backup-*.db\" -mtime +7 -exec rm {} \\; &gt;&gt; ${LOG_FILE} 2&gt;&amp;1\n\n# Remove logs older than 7 days\nfind ${BACKUP_DIR} -name \"backup-*.log\" -mtime +7 -exec rm {} \\; &gt;&gt; ${LOG_FILE} 2&gt;&amp;1\nEOF\n\n\n# chmod\nchmod +x etcd-backups.sh\n\n# test \n./etcd-backups.sh\n\n\n# add cron\nroot@etcd1:/data/etcd-backups# crontab -e\ncrontab: installing new crontab\n\nroot@etcd1:/data/etcd-backups# crontab -l \n0 2 * * * /data/etcd-backups/etcd-backups.sh\n</code></pre>"},{"location":"kubernetes/Install-NFS-StorageClass/","title":"Install NFS StorageClass","text":""},{"location":"kubernetes/Install-NFS-StorageClass/#1-install-nfs-server","title":"1 Install nfs server","text":"<pre><code># https://jimmysong.io/kubernetes-handbook/practice/using-nfs-for-persistent-storage.html\n# https://github.com/kubernetes-retired/external-storage/tree/master/nfs-client/deploy\n\n# intall package\napt-get update\napt-get install nfs-kernel-server -y\n\n# mkdir &amp; chown\nmkdir -p /data/ifs/kubernetes\nchown -R nobody:nogroup /data/ifs/kubernetes\n\n# limit client ip \necho \"/data/ifs/kubernetes 10.1.1.0/32(no_root_squash,rw,sync,no_subtree_check)\" | tee -a /etc/exports\n\n# start svc\nsystemctl start nfs-kernel-server\nsystemctl enable nfs-kernel-server\n# ufw allow from 10.1.1.0/32 to any port nfs\n</code></pre>"},{"location":"kubernetes/Install-NFS-StorageClass/#2-install-nfs-client","title":"2 Install nfs client","text":"<pre><code># on all k8s nodes.\napt-get update\napt-get install nfs-common -y\n\n# on master1\necho -e \"\\n10.1.1.12 nfs-server.k8sCluster.com\" &gt;&gt; /etc/hosts\n\n# scp file.\nscp -r /etc/hosts master2:/etc/\nscp -r /etc/hosts master3:/etc/\nscp -r /etc/hosts worker1:/etc/\n\n# on all k8s nodes.\n# test\nroot@master1:~/kubesphere# showmount -e nfs-server.k8sCluster.com\nExport list for nfs-server.k8sCluster.com:\n/data/ifs/kubernetes 10.1.1.0/32\n</code></pre>"},{"location":"kubernetes/Install-NFS-StorageClass/#3-install-nfs-sc","title":"3 Install nfs sc","text":"<pre><code># https://v1-27.docs.kubernetes.io/zh-cn/docs/concepts/storage/storage-classes/#nfs\n# https://github.com/kubernetes-sigs/nfs-subdir-external-provisioner/tree/master/deploy\n\n# on master1\nmkdir -p StorageClass &amp;&amp; cd StorageClass\n# upload file.\nroot@master1:~/StorageClass# ll \ntotal 24\n-rw-r--r-- 1 root root  246 Dec  5 16:14 class.yaml\n-rw-r--r-- 1 root root 1094 Dec  5 16:26 deployment.yaml\n-rw-r--r-- 1 root root   64 Dec  5 16:14 kustomization.yaml\n-rw-r--r-- 1 root root 1900 Dec  5 16:15 rbac.yaml\n-rw-r--r-- 1 root root  190 Dec  5 16:15 test-claim.yaml\n-rw-r--r-- 1 root root  401 Dec  5 16:15 test-pod.yaml\n\n# install sc\nroot@master1:~/StorageClass# kubectl create -f class.yaml \nstorageclass.storage.k8s.io/nfs-client created\n\nroot@master1:~/StorageClass# kubectl create -f rbac.yaml \nserviceaccount/nfs-client-provisioner created\nclusterrole.rbac.authorization.k8s.io/nfs-client-provisioner-runner created\nclusterrolebinding.rbac.authorization.k8s.io/run-nfs-client-provisioner created\nrole.rbac.authorization.k8s.io/leader-locking-nfs-client-provisioner created\nrolebinding.rbac.authorization.k8s.io/leader-locking-nfs-client-provisioner created\n\nroot@master1:~/StorageClass# kubectl create -f deployment.yaml ### \u4fee\u6539\u91cc\u9762\u670d\u52a1\u5668IP\uff0c\u4ee5\u53ca\u5171\u4eab\u8def\u5f84\ndeployment.apps/nfs-client-provisioner created\n\n# test sc\nroot@master1:~/StorageClass# kubectl create -f test-claim.yaml \npersistentvolumeclaim/test-claim created\nroot@master1:~/StorageClass# kubectl create -f test-pod.yaml \npod/test-pod created\nroot@master1:~/StorageClass# kubectl get po \nNAME                                      READY   STATUS      RESTARTS      AGE\nnfs-client-provisioner-7fddb5f6fd-ljmq9   1/1     Running     1 (82s ago)   3m24s\ntest-pod                                  0/1     Completed   0             4s\nroot@master1:~/StorageClass# kubectl get po \nNAME                                      READY   STATUS      RESTARTS      AGE\nnfs-client-provisioner-7fddb5f6fd-ljmq9   1/1     Running     1 (84s ago)   3m26s\ntest-pod                                  0/1     Completed   0             6s\nroot@master1:~/StorageClass# kubectl get pvc \nNAME         STATUS   VOLUME                                     CAPACITY   ACCESS MODES   STORAGECLASS   AGE\ntest-claim   Bound    pvc-d52e62c4-9c2d-415a-8404-61a812fa139e   1Mi        RWX            nfs-client     15s\n\n# set default\nroot@master1:~/StorageClass# kubectl patch storageclass nfs-client -p '{\"metadata\": {\"annotations\":{\"storageclass.kubernetes.io/is-default-class\":\"true\"}}}'\nstorageclass.storage.k8s.io/nfs-client patched\nroot@master1:~/StorageClass# kubectl get sc\nNAME                   PROVISIONER                                   RECLAIMPOLICY   VOLUMEBINDINGMODE   ALLOWVOLUMEEXPANSION   AGE\nnfs-client (default)   k8s-sigs.io/nfs-subdir-external-provisioner   Delete          Immediate           false                  5m39s\n\n\n# on nfs server .\n\nroot@harbor:~# ll /data/ifs/kubernetes/\ntotal 12\ndrwxrwxrwx 2 root root 4096 Dec  5 16:33 default-test-claim-pvc-d52e62c4-9c2d-415a-8404-61a812fa139e\ndrwxrwxrwx 3 root root 4096 Dec  5 16:35 kubesphere-monitoring-system-prometheus-k8s-db-prometheus-k8s-0-pvc-bac1980f-5fe0-44a3-a5ae-c21d3e28f98c\ndrwxrwxrwx 3 root root 4096 Dec  5 16:35 kubesphere-monitoring-system-prometheus-k8s-db-prometheus-k8s-1-pvc-b7b004c6-d0cf-4126-ae63-49af5844cd0c\n</code></pre>"},{"location":"kubernetes/Install-TLS-Harbor/","title":"Install TLS Harbor","text":""},{"location":"kubernetes/Install-TLS-Harbor/#1-change-dns","title":"1 Change DNS","text":"<pre><code># in windows &amp; clash proxy &amp; add dns\nhosts:\n  'harbor.dockerregistry.com': '192.168.171.50' # here\n\n# in windows &amp; hosts\n192.168.171.50 harbor.dockerregistry.com\n\n\n# harbor node.\nhostnamectl set-hostname harbor.dockerregistry.com\n\necho -e \"\\n192.168.171.50 harbor.dockerregistry.com\" &gt;&gt; /etc/hosts\n</code></pre>"},{"location":"kubernetes/Install-TLS-Harbor/#2-create-lvm","title":"2 Create lvm","text":"<pre><code># \u5b89\u88c5\u5305\nsudo apt-get update\nsudo apt-get install lvm2\n\n# \u521b\u5efa\u7269\u7406\u5377\n# \u4f7f\u7528pvcreate\u547d\u4ee4\u5728sdb\u78c1\u76d8\u4e0a\u521b\u5efa\u4e00\u4e2a\u7269\u7406\u5377\uff1a\npvcreate /dev/sdb1\n\n# \u521b\u5efa\u5377\u7ec4\n# \u4f7f\u7528vgcreate\u547d\u4ee4\u5728\u521a\u521a\u521b\u5efa\u7684\u7269\u7406\u5377\u4e0a\u521b\u5efa\u4e00\u4e2a\u5377\u7ec4\u3002\u5728\u8fd9\u4e2a\u4f8b\u5b50\u4e2d\uff0c\u6211\u4eec\u5c06\u5377\u7ec4\u547d\u540d\u4e3adata_vg\uff1a\nvgcreate data_vg /dev/sdb1\n\n# \u521b\u5efa\u903b\u8f91\u5377\n# \u73b0\u5728\uff0c\u4f60\u53ef\u4ee5\u5728\u5377\u7ec4data_vg\u4e0a\u521b\u5efa\u903b\u8f91\u5377\u3002\u5728\u8fd9\u4e2a\u4f8b\u5b50\u4e2d\uff0c\u6211\u4eec\u5c06\u903b\u8f91\u5377\u547d\u540d\u4e3adata_lv\uff0c\u5e76\u5206\u914d\u6240\u6709\u53ef\u7528\u7684\u7a7a\u95f4\uff1a\nlvcreate -l +100%FREE -n data_lv data_vg\n\n# \u683c\u5f0f\u5316\u903b\u8f91\u5377\n# \u5728\u903b\u8f91\u5377\u4e0a\u521b\u5efa\u4e00\u4e2a\u6587\u4ef6\u7cfb\u7edf\u3002\u8fd9\u91cc\u6211\u4eec\u4f7f\u7528ext4\u6587\u4ef6\u7cfb\u7edf\uff0c\u4f60\u4e5f\u53ef\u4ee5\u6839\u636e\u9700\u8981\u9009\u62e9\u5176\u5b83\u7684\u6587\u4ef6\u7cfb\u7edf\uff1a\nmkfs.ext4 /dev/data_vg/data_lv\n\n# \u6e05\u7406\u4e4b\u524d\u7684\u65e7\u914d\u7f6e\nsed -i '/\\/data/d' /etc/fstab\n\n# \u91cd\u542f\u670d\u52a1\u5668\nsync;reboot\n\n# \u6302\u8f7d\u903b\u8f91\u5377\n# \u6700\u540e\uff0c\u4f60\u53ef\u4ee5\u5c06\u65b0\u7684\u903b\u8f91\u5377\u6302\u8f7d\u5230/data\u76ee\u5f55\uff1a\nmount /dev/data_vg/data_lv /data\n\n# \u66f4\u65b0/etc/fstab\u6587\u4ef6\n# \u4e3a\u4e86\u5728\u7cfb\u7edf\u91cd\u542f\u540e\u4fdd\u6301\u8fd9\u4e2a\u6302\u8f7d\uff0c\u4f60\u9700\u8981\u5c06\u65b0\u914d\u7f6e\u6dfb\u52a0\u5230/etc/fstab\u6587\u4ef6\u4e2d\uff1a\necho \"/dev/data_vg/data_lv /data ext4 defaults 0 0\" &gt;&gt; /etc/fstab\n\n# \u5237\u65b0\u6302\u8f7d\nmount -a\n</code></pre>"},{"location":"kubernetes/Install-TLS-Harbor/#3-install-docker","title":"3 Install Docker","text":"<pre><code># \u66f4\u65b0\u73b0\u6709\u7684\u5305\u5217\u8868\nsudo apt-get update\n# \u5b89\u88c5\u6240\u9700\u7684\u5305\u4ee5\u8ba9apt\u652f\u6301HTTPS\nsudo apt-get install apt-transport-https ca-certificates curl gnupg lsb-release\n# \u6dfb\u52a0Docker\u7684\u5b98\u65b9GPG\u5bc6\u94a5\ncurl -fsSL https://download.docker.com/linux/debian/gpg | sudo gpg --dearmor -o /usr/share/keyrings/docker-archive-keyring.gpg\n# \u4f7f\u7528\u4e0b\u9762\u7684\u547d\u4ee4\u8bbe\u7f6e\u7a33\u5b9a\u7248\u7684\u4ed3\u5e93\necho \"deb [arch=amd64 signed-by=/usr/share/keyrings/docker-archive-keyring.gpg] https://download.docker.com/linux/debian $(lsb_release -cs) stable\" | sudo tee /etc/apt/sources.list.d/docker.list &gt; /dev/null\n# \u518d\u6b21\u66f4\u65b0apt\u5305\u7d22\u5f15\nsudo apt-get update \n# \u5b89\u88c5\u6700\u65b0\u7248\u672c\u7684Docker Engine\u548ccontainerd\nsudo apt-get install docker-ce docker-ce-cli containerd.io\n\n# \u6dfb\u52a0\u914d\u7f6e\ncat &gt; /etc/docker/daemon.json &lt;&lt; 'EOF'\n{\n  \"registry-mirrors\": [\"https://ustc-edu-cn.mirror.aliyuncs.com\"],\n  \"debug\": false,\n  \"ip-forward\": true,\n  \"ipv6\": false,\n  \"live-restore\": true,\n  \"log-driver\": \"json-file\",\n  \"log-level\": \"warn\",\n  \"log-opts\": {\n    \"max-size\": \"100m\",\n    \"max-file\": \"2\"\n  },\n  \"selinux-enabled\": false,\n  \"experimental\" : true,\n  \"storage-driver\": \"overlay2\",\n  \"metrics-addr\" : \"0.0.0.0:9323\",\n  \"data-root\": \"/data/docker\",\n  \"default-ulimits\": {\n    \"nofile\": {\n      \"Name\": \"nofile\",\n      \"Hard\": 65536,\n      \"Soft\": 65536\n    }\n  },\n  \"exec-opts\": [\"native.cgroupdriver=systemd\"]\n}\nEOF\n\n# \u91cd\u542f\u670d\u52a1\nsystemctl restart docker \n\n\n# \u5b89\u88c5compose\ncp docker-compose-linux-x86_64 /usr/bin/docker-compose\nchmod +x /usr/bin/docker-compose\ndocker-compose version \n</code></pre>"},{"location":"kubernetes/Install-TLS-Harbor/#4-unpack-harbor","title":"4 Unpack Harbor","text":"<pre><code># \u91ca\u653e\u5b89\u88c5\u5305\ntar xzvf harbor-offline-installer-v2.8.4.tgz -C /data\n\n# \u6dfb\u52a0\u914d\u7f6e\n\\cp -rvf /data/harbor/harbor.yml.tmpl /data/harbor/harbor.yml\n\n# \u4fee\u6539\u914d\u7f6e\nvim /data/harbor/harbor.yml\n# \u4e3b\u8981\u4fee\u6539\u8fd96 \u884c\u914d\u7f6e\nhostname: harbor.dockerregistry.com\n  certificate: /data/harbor/ssl/harbor.dockerregistry.com.crt\n  private_key: /data/harbor/ssl/harbor.dockerregistry.com.key\nharbor_admin_password: Harbor123#@!\ndata_volume: /data/harbor/harbor-data\n    location: /data/harbor/harbor-logs\n</code></pre>"},{"location":"kubernetes/Install-TLS-Harbor/#5-create-ca-files","title":"5 Create ca files","text":"<pre><code># \u8bc1\u4e66\u5236\u4f5c\nmkdir -p  /data/harbor/ssl &amp;&amp; cd /data/harbor/ssl\nopenssl genrsa -out ca.key 4096\nopenssl req -x509 -new -nodes -sha512 -days 3650 \\\n -subj \"/C=CN/ST=Beijing/L=Beijing/O=example/OU=Personal/CN=harbor.dockerregistry.com\" \\\n -key ca.key \\\n -out ca.crt\n\nopenssl genrsa -out harbor.dockerregistry.com.key 4096\nopenssl req -sha512 -new \\\n    -subj \"/C=CN/ST=Beijing/L=Beijing/O=example/OU=Personal/CN=harbor.dockerregistry.com\" \\\n    -key harbor.dockerregistry.com.key \\\n    -out harbor.dockerregistry.com.csr\n\ncat &gt; v3.ext &lt;&lt;-EOF\nauthorityKeyIdentifier=keyid,issuer\nbasicConstraints=CA:FALSE\nkeyUsage = digitalSignature, nonRepudiation, keyEncipherment, dataEncipherment\nextendedKeyUsage = serverAuth\nsubjectAltName = @alt_names\n\n[alt_names]\nDNS.1=harbor.dockerregistry.com\nEOF\n\n\n\nopenssl x509 -req -sha512 -days 3650 \\\n    -extfile v3.ext \\\n    -CA ca.crt -CAkey ca.key -CAcreateserial \\\n    -in harbor.dockerregistry.com.csr \\\n    -out harbor.dockerregistry.com.crt\n\nopenssl x509 -inform PEM -in harbor.dockerregistry.com.crt -out harbor.dockerregistry.com.cert\n\n# \u8bc1\u4e66\u62f7\u8d1d\nmkdir -p /etc/docker/certs.d/harbor.dockerregistry.com/\ncp ca.crt /etc/docker/certs.d/harbor.dockerregistry.com/\ncp harbor.dockerregistry.com.cert  /etc/docker/certs.d/harbor.dockerregistry.com/\ncp harbor.dockerregistry.com.key   /etc/docker/certs.d/harbor.dockerregistry.com/\n\n\n# \u8bc1\u4e66\u53d1\u9001\u5230\u5ba2\u6237\u7aef(\u82e5\u6709\u5ba2\u6237\u7aef\u9700\u8981\u8d70HTTPS \u8bbf\u95eeHarbor\u7684\u8bdd\uff0c\u5219\u9700\u8981\u53d1\u9001)\nscp -r /etc/docker/certs.d 192.168.171.130:/etc/docker\n</code></pre>"},{"location":"kubernetes/Install-TLS-Harbor/#6-install-harbor","title":"6 Install Harbor","text":"<pre><code>cd /data/harbor/\n\n# \u5bfc\u5165\u79bb\u7ebf\u955c\u50cf\u5305\ndocker load -i harbor.v2.8.4.tar.gz \n# \u73af\u5883\u68c0\u67e5\n./prepare --with-trivy\n# \u5b89\u88c5\n./install.sh --with-trivy \n\n# \u505c\u6b62\u670d\u52a1\uff08\u82e5\u9700\u8981\uff09\ndocker-compose down\n\n\n# \u767b\u9646\u6d4b\u8bd5\ndocker login -u admin -p Harbor123#@! harbor.dockerregistry.com\n</code></pre>"},{"location":"kubernetes/Install-TLS-Harbor/#7-update-client","title":"7 Update Client","text":"<pre><code># Docker \u914d\u7f6e\n# \u901a\u8fc7HTTP \u767b\u9646Harbor \u914d\u7f6e\ncat &gt; /etc/docker/daemon.json &lt;&lt; 'EOF'\n{\n  \"registry-mirrors\": [\"https://ustc-edu-cn.mirror.aliyuncs.com\"],\n  \"debug\": false,\n  \"insecure-registries\": [\n    \"0.0.0.0/0\"\n  ],\n  \"ip-forward\": true,\n  \"ipv6\": false,\n  \"live-restore\": true,\n  \"log-driver\": \"json-file\",\n  \"log-level\": \"warn\",\n  \"log-opts\": {\n    \"max-size\": \"100m\",\n    \"max-file\": \"2\"\n  },\n  \"selinux-enabled\": false,\n  \"experimental\" : true,\n  \"storage-driver\": \"overlay2\",\n  \"metrics-addr\" : \"0.0.0.0:9323\",\n  \"data-root\": \"/data/docker\",\n  \"default-ulimits\": {\n    \"nofile\": {\n      \"Name\": \"nofile\",\n      \"Hard\": 65536,\n      \"Soft\": 65536\n    }\n  },\n  \"exec-opts\": [\"native.cgroupdriver=systemd\"]\n}\nEOF\n\n# \u901a\u8fc7HTTPS \u767b\u9646Harbor \u914d\u7f6e\n# \u9700\u8981\u63d0\u524d\u5728\u670d\u52a1\u5668\u4e0a\u9762\u653eHarbor \u7684\u8bc1\u4e66\u624d\u884c\uff0c\u4e0e\u524d\u9762Harbor \u8bc1\u4e66\u53d1\u9001\u5230\u5ba2\u6237\u7aef\u540c\u7406\ncat &gt; /etc/docker/daemon.json &lt;&lt; 'EOF'\n{\n  \"registry-mirrors\": [\"https://ustc-edu-cn.mirror.aliyuncs.com\"],\n  \"debug\": false,\n  \"ip-forward\": true,\n  \"ipv6\": false,\n  \"live-restore\": true,\n  \"log-driver\": \"json-file\",\n  \"log-level\": \"warn\",\n  \"log-opts\": {\n    \"max-size\": \"100m\",\n    \"max-file\": \"2\"\n  },\n  \"selinux-enabled\": false,\n  \"experimental\" : true,\n  \"storage-driver\": \"overlay2\",\n  \"metrics-addr\" : \"0.0.0.0:9323\",\n  \"data-root\": \"/data/docker\",\n  \"default-ulimits\": {\n    \"nofile\": {\n      \"Name\": \"nofile\",\n      \"Hard\": 65536,\n      \"Soft\": 65536\n    }\n  },\n  \"exec-opts\": [\"native.cgroupdriver=systemd\"]\n}\nEOF\n\n# \u91cd\u542fdocker\nsystemctl restart docker\n\n# \u767b\u5f55\u8ba4\u8bc1\n$ docker login -u admin -p Harbor123#@! harbor.dockerregistry.com\nWARNING! Using --password via the CLI is insecure. Use --password-stdin.\nWARNING! Your password will be stored unencrypted in /root/.docker/config.json.\nConfigure a credential helper to remove this warning. See\nhttps://docs.docker.com/engine/reference/commandline/login/#credentials-store\n\nLogin Succeeded\n</code></pre>"},{"location":"kubernetes/Install-k8s-Cluster/","title":"Install k8s Cluster","text":""},{"location":"kubernetes/Install-k8s-Cluster/#1-create-config","title":"1 Create Config","text":"<pre><code># on master1 \n\n# https://kubernetes.io/zh-cn/docs/reference/config-api/kubeadm-config.v1beta3/\n# print default config\n$ kubeadm config print init-defaults &gt; kubeadm-init.yaml\n\n# edit it(ipaddr) for your own needs.\ncat &lt;&lt;EOF | tee  kubeadm-init.yaml\napiVersion: kubeadm.k8s.io/v1beta3\nkind: InitConfiguration\nlocalAPIEndpoint:\n  advertiseAddress: 192.168.171.136\n  bindPort: 6443\nnodeRegistration:\n  criSocket: unix:///var/run/containerd/containerd.sock\n  taints:\n    - effect: NoSchedule\n      key: node-role.kubernetes.io/control-plane\n---\napiVersion: kubeadm.k8s.io/v1beta3\nkind: ClusterConfiguration\ncertificatesDir: /etc/kubernetes/pki\nclusterName: kubernetes\ncontrollerManager: {}\ndns:\n  type: CoreDNS\netcd:\n  external:\n    endpoints:\n      - https://192.168.171.136:2379\n      - https://192.168.171.137:2379\n      - https://192.168.171.138:2379\n    caFile: /etc/kubernetes/pki/etcd/etcd-ca.pem\n    certFile: /etc/kubernetes/pki/apiserver-etcd-client.pem\n    keyFile: /etc/kubernetes/pki/apiserver-etcd-client-key.pem\nkubernetesVersion: 1.27.6\nimageRepository: registry.aliyuncs.com/google_containers\n#controlPlaneEndpoint: 192.168.171.135:6443\nnetworking:\n  serviceSubnet: 10.96.0.0/12\n  podSubnet: 10.244.0.0/16\n---\napiVersion: kubeproxy.config.k8s.io/v1alpha1\nkind: KubeProxyConfiguration\nmode: ipvs\nEOF\n</code></pre>"},{"location":"kubernetes/Install-k8s-Cluster/#2-install-k8s","title":"2 Install k8s","text":"<pre><code># on master1\n\n# begin to init k8s cluster\n$ kubeadm init --config=kubeadm-init.yaml --upload-certs\n...\n\n# on lb1 and lb2 \nsystemctl restart haproxy.service \n\n\n\n# $ kubeadm init --config=kubeadm-init.yaml --upload-certs\n[addons] Applied essential addon: CoreDNS\n[addons] Applied essential addon: kube-proxy\n\nYour Kubernetes control-plane has initialized successfully!\n\nTo start using your cluster, you need to run the following as a regular user:\n\n  mkdir -p $HOME/.kube\n  sudo cp -i /etc/kubernetes/admin.conf $HOME/.kube/config\n  sudo chown $(id -u):$(id -g) $HOME/.kube/config\n\nAlternatively, if you are the root user, you can run:\n\n  export KUBECONFIG=/etc/kubernetes/admin.conf\n\nYou should now deploy a pod network to the cluster.\nRun \"kubectl apply -f [podnetwork].yaml\" with one of the options listed at:\n  https://kubernetes.io/docs/concepts/cluster-administration/addons/\n\nYou can now join any number of the control-plane node running the following command on each as root:\n\n  kubeadm join 192.168.171.136:6443 --token 64i2i5.vtdkoz3he8cttwoe \\\n        --discovery-token-ca-cert-hash sha256:9df932af344252c2b25cba8e2a1096c95041f64ec0f99c57c5f87be489639584 \\\n        --control-plane --certificate-key 195651292db2a759a52199cd0c9f22f0665864cfe92672ddf9391b5e4503e7e7\n\nPlease note that the certificate-key gives access to cluster sensitive data, keep it secret!\nAs a safeguard, uploaded-certs will be deleted in two hours; If necessary, you can use\n\"kubeadm init phase upload-certs --upload-certs\" to reload certs afterward.\n\nThen you can join any number of worker nodes by running the following on each as root:\n\nkubeadm join 192.168.171.136:6443 --token 64i2i5.vtdkoz3he8cttwoe \\\n        --discovery-token-ca-cert-hash sha256:9df932af344252c2b25cba8e2a1096c95041f64ec0f99c57c5f87be489639584 \n</code></pre>"},{"location":"kubernetes/Install-k8s-Cluster/#3-reset-node","title":"3 Reset node","text":"<pre><code># !!!Note: reset node if need\nkubeadm reset\n\n# !!!Note: clean dir if need\nrm -rf /etc/cni/net.d\niptables -F &amp;&amp; iptables -t nat -F &amp;&amp; iptables -t mangle -F &amp;&amp; iptables -X\nipvsadm --clear\nrm -rf $HOME/.kube\n\n\n# scp ca again \nmkdir -p /etc/kubernetes/pki/etcd/\nscp -r /etc/etcd/ssl/etcd-ca.pem    master1:/etc/kubernetes/pki/etcd/\nscp -r /etc/etcd/ssl/client.pem     master1:/etc/kubernetes/pki/apiserver-etcd-client.pem\nscp -r /etc/etcd/ssl/client-key.pem master1:/etc/kubernetes/pki/apiserver-etcd-client-key.pem\n\n# clean etcd data\n# on all etcd nodes.\nsystemctl stop etcd\n\n# on all etcd nodes.\nrm /data/etcd/* -rf\n\n## after all node data clean !!!!\n# on all etcd nodes.\nsystemctl start etcd\n\n# check healthy\netcdctl endpoint health -w table\n</code></pre>"},{"location":"kubernetes/Install-k8s-Cluster/#4-add-node","title":"4 Add  node","text":"<pre><code># add master node\n\n  kubeadm join 192.168.171.136:6443 --token 64i2i5.vtdkoz3he8cttwoe \\\n        --discovery-token-ca-cert-hash sha256:9df932af344252c2b25cba8e2a1096c95041f64ec0f99c57c5f87be489639584 \\\n        --control-plane --certificate-key 195651292db2a759a52199cd0c9f22f0665864cfe92672ddf9391b5e4503e7e7 \\\n        --cri-socket=unix:///var/run/containerd/containerd.sock\n\necho \"export KUBECONFIG=/etc/kubernetes/admin.conf\" &gt;&gt; /etc/profile\nsource  /etc/profile\n\n# add worker node\nkubeadm join 192.168.171.136:6443 --token 64i2i5.vtdkoz3he8cttwoe \\\n        --discovery-token-ca-cert-hash sha256:9df932af344252c2b25cba8e2a1096c95041f64ec0f99c57c5f87be489639584 \\\n        --cri-socket=unix:///var/run/containerd/containerd.sock\n\necho \"export KUBECONFIG=/etc/kubernetes/admin.conf\" &gt;&gt; /etc/profile\nsource  /etc/profile\n\n\n# \u91cd\u65b0\u4e0a\u4f20\u8bc1\u4e66\n# https://kubernetes.io/zh-cn/docs/reference/setup-tools/kubeadm/kubeadm-init/#uploading-control-plane-certificates-to-the-cluster\nkubeadm init phase upload-certs --upload-certs --config=/root/kubeadm-init.yaml \n# \u91cd\u65b0\u751f\u6210token\nkubeadm token create --print-join-command\n# \u6e05\u7a7a\u8282\u70b9\u8bc1\u4e66\u76ee\u5f55\nrm /etc/kubernetes/pki/* -rf \n# \u52a0\u5165\u4e3b\u8282\u70b9\nkubeadm join 10.1.1.110:6443 --token 5zshml.7fppf46erf1jju9j --discovery-token-ca-cert-hash sha256:7cdaf0a19f5f02268eed7b39ebdf6c19a3ad163f093ae1183076014d55457be2 --control-plane --certificate-key 88f5cb76ca1e69207583ce39114bbf9f6b768dba456239c83d44126c7d0c2f50 --cri-socket=unix:///var/run/containerd/containerd.sock\n</code></pre>"},{"location":"kubernetes/Install-k8s-Cluster/#5-add-label","title":"5 Add label","text":"<pre><code># add worker label\n kubectl label nodes worker1.k8scluster.com node-role.kubernetes.io/worker=\n</code></pre>"},{"location":"kubernetes/Install-k8s-Cluster/#6-debug-node","title":"6 Debug node","text":"<pre><code># dry-run\nkubeadm init --config=kubeadm-init.yaml --dry-run\n\n\n# And run init step again.\nkubeadm init --config=kubeadm-init.yaml\n\njournalctl -xeu kubelet -f \n\n# local test used , be careful.\nkubectl taint nodes --all node-role.kubernetes.io/control-plane-\n\n\n# test cluster\nkubectl get pods -A\nkubectl get cs\nkubectl cluster-info\nkubectl get nodes  # NoteReady is normal.\nkubectl get nodes -o custom-columns=NAME:.metadata.name,TAINTS:.spec.taints\nkubectl get componentstatuses\n\n# add taint if not exited.\nkubectl taint nodes master1.k8scluster.com node-role.kubernetes.io/control-plane=:NoSchedule\n# del taint if exited.\nkubectl taint nodes master1.k8scluster.com node-role.kubernetes.io/master-\n</code></pre>"},{"location":"kubernetes/Install-k8s-Cluster/#7-helm-install-calico","title":"7 Helm install calico","text":"<pre><code>systemctl stop apparmor\nsystemctl disable apparmor \nsystemctl restart containerd.service kubelet \n\n################################################################################################\n# install used helm .\n# https://github.com/projectcalico/calico/releases\n# https://docs.tigera.io/calico/latest/getting-started/kubernetes/helm\n# https://docs.tigera.io/calico/latest/getting-started/kubernetes/helm#install-calico\n\nhelm repo add projectcalico https://docs.tigera.io/calico/charts\n\nhelm search repo projectcalico/tigera-operator -l \n\nmkdir -p calico &amp;&amp; cd calico\n# helm pull projectcalico/tigera-operator --version v3.26.3\n# upload tgz file.\n\ntar xf tigera-operator-v3.26.3.tgz \ncp tigera-operator/values.yaml{,.bak}\n\n\n# on all nodes.\n# upload offline-images dir.\nfor image in offline-images/*.tar; do   docker load -i $image; done\n\n# modify config\nvim  tigera-operator/values.yaml\nimagePullSecrets: {}\n\ninstallation:\n  enabled: true\n  kubernetesProvider: \"\"\n  calicoNetwork: ## here \n    ipPools:\n    - blockSize: 26\n      cidr: 10.244.0.0/16\n      encapsulation: IPIP\n      natOutgoing: Enabled\n      nodeSelector: all()\n\n\n\nkubectl create namespace tigera-operator\n# helm install calico projectcalico/tigera-operator --version v3.24.6 -f values.yaml --namespace tigera-operator\n\n\nhelm install calico ./tigera-operator --namespace tigera-operator -f tigera-operator/values.yaml\n\n\n# view pod and nodes status\nroot@master1:~/calico# kubectl get po -A -owide \nNAMESPACE          NAME                                             READY   STATUS    RESTARTS        AGE   IP             NODE                     NOMINATED NODE   READINESS GATES\ncalico-apiserver   calico-apiserver-577cb78868-b628k                1/1     Running   0               18s   10.244.113.2   master2.k8scluster.com   &lt;none&gt;           &lt;none&gt;\ncalico-apiserver   calico-apiserver-577cb78868-ljlt6                1/1     Running   0               11m   10.244.46.2    master3.k8scluster.com   &lt;none&gt;           &lt;none&gt;\ncalico-system      calico-kube-controllers-dcf6df9f9-sgrsm          1/1     Running   0               36m   10.244.208.2   master1.k8scluster.com   &lt;none&gt;           &lt;none&gt;\ncalico-system      calico-node-cxz7j                                1/1     Running   0               12m   192.168.1.128      master3.k8scluster.com   &lt;none&gt;           &lt;none&gt;\ncalico-system      calico-node-kgxvl                                1/1     Running   0               12m   192.168.1.127      master2.k8scluster.com   &lt;none&gt;           &lt;none&gt;\ncalico-system      calico-node-mm8mv                                1/1     Running   0               12m   192.168.1.129      worker1.k8scluster.com   &lt;none&gt;           &lt;none&gt;\ncalico-system      calico-node-zx84b                                1/1     Running   0               13m   192.168.1.126      master1.k8scluster.com   &lt;none&gt;           &lt;none&gt;\ncalico-system      calico-typha-6674977c9-gmbbv                     1/1     Running   0               28m   192.168.1.127      master2.k8scluster.com   &lt;none&gt;           &lt;none&gt;\ncalico-system      calico-typha-6674977c9-vqm5p                     1/1     Running   0               36m   192.168.1.128      master3.k8scluster.com   &lt;none&gt;           &lt;none&gt;\ncalico-system      csi-node-driver-bxjp9                            2/2     Running   0               36m   10.244.208.3   master1.k8scluster.com   &lt;none&gt;           &lt;none&gt;\ncalico-system      csi-node-driver-kbh6d                            2/2     Running   0               36m   10.244.85.65   worker1.k8scluster.com   &lt;none&gt;           &lt;none&gt;\ncalico-system      csi-node-driver-phhjj                            2/2     Running   0               36m   10.244.46.1    master3.k8scluster.com   &lt;none&gt;           &lt;none&gt;\ncalico-system      csi-node-driver-v4dkb                            2/2     Running   0               36m   10.244.113.1   master2.k8scluster.com   &lt;none&gt;           &lt;none&gt;\nkube-system        coredns-7bdc4cb885-htf8t                         1/1     Running   0               59m   10.244.208.4   master1.k8scluster.com   &lt;none&gt;           &lt;none&gt;\nkube-system        coredns-7bdc4cb885-s4b9j                         1/1     Running   0               59m   10.244.208.1   master1.k8scluster.com   &lt;none&gt;           &lt;none&gt;\nkube-system        kube-apiserver-master1.k8scluster.com            1/1     Running   0               80m   192.168.1.126      master1.k8scluster.com   &lt;none&gt;           &lt;none&gt;\nkube-system        kube-apiserver-master2.k8scluster.com            1/1     Running   0               65m   192.168.1.127      master2.k8scluster.com   &lt;none&gt;           &lt;none&gt;\nkube-system        kube-apiserver-master3.k8scluster.com            1/1     Running   0               65m   192.168.1.128      master3.k8scluster.com   &lt;none&gt;           &lt;none&gt;\nkube-system        kube-controller-manager-master1.k8scluster.com   1/1     Running   3 (49m ago)     80m   192.168.1.126      master1.k8scluster.com   &lt;none&gt;           &lt;none&gt;\nkube-system        kube-controller-manager-master2.k8scluster.com   1/1     Running   1 (25m ago)     65m   192.168.1.127      master2.k8scluster.com   &lt;none&gt;           &lt;none&gt;\nkube-system        kube-controller-manager-master3.k8scluster.com   1/1     Running   1 (2m48s ago)   65m   192.168.1.128      master3.k8scluster.com   &lt;none&gt;           &lt;none&gt;\nkube-system        kube-proxy-95f92                                 1/1     Running   0               66m   192.168.1.127      master2.k8scluster.com   &lt;none&gt;           &lt;none&gt;\nkube-system        kube-proxy-cf7rl                                 1/1     Running   0               65m   192.168.1.128      master3.k8scluster.com   &lt;none&gt;           &lt;none&gt;\nkube-system        kube-proxy-jv5vb                                 1/1     Running   0               65m   192.168.1.129      worker1.k8scluster.com   &lt;none&gt;           &lt;none&gt;\nkube-system        kube-proxy-tj82v                                 1/1     Running   0               80m   192.168.1.126      master1.k8scluster.com   &lt;none&gt;           &lt;none&gt;\nkube-system        kube-scheduler-master1.k8scluster.com            1/1     Running   3 (49m ago)     80m   192.168.1.126      master1.k8scluster.com   &lt;none&gt;           &lt;none&gt;\nkube-system        kube-scheduler-master2.k8scluster.com            1/1     Running   0               65m   192.168.1.127      master2.k8scluster.com   &lt;none&gt;           &lt;none&gt;\nkube-system        kube-scheduler-master3.k8scluster.com            1/1     Running   2 (2m43s ago)   65m   192.168.1.128      master3.k8scluster.com   &lt;none&gt;           &lt;none&gt;\ntigera-operator    tigera-operator-f6bb878c4-zrt8n                  1/1     Running   2 (2m49s ago)   36m   192.168.1.129      worker1.k8scluster.com   &lt;none&gt;           &lt;none&gt;\nroot@master1:~/calico# kubectl get nodes \nNAME                     STATUS   ROLES           AGE   VERSION\nmaster1.k8scluster.com   Ready    control-plane   80m   v1.27.6\nmaster2.k8scluster.com   Ready    control-plane   66m   v1.27.6\nmaster3.k8scluster.com   Ready    control-plane   65m   v1.27.6\nworker1.k8scluster.com   Ready    worker          65m   v1.27.6\n\n\n# clean env \ndocker system prune -af\n\n\n\n##################################################################################################### \n# or install uesd yaml file. ## \u4f46\u4e0d\u592a\u5efa\u8bae\n# https://docs.tigera.io/calico/latest/getting-started/kubernetes/quickstart#install-calico\n#kubectl create -f https://raw.githubusercontent.com/projectcalico/calico/v3.26.4/manifests/tigera-operator.yaml\nkubectl create -f tigera-operator.yaml\nkubectl get all -o wide -n tigera-operator\n\n#kubectl create -f https://raw.githubusercontent.com/projectcalico/calico/v3.26.4/manifests/custom-resources.yaml\nsed -i 's/cidr: 192.168.0.0/cidr: 10.244.0.0/g' custom-resources.yaml\nsed -i 's/encapsulation: VXLANCrossSubnet/encapsulation: IPIP/g' custom-resources.yaml\nkubectl create -f custom-resources.yaml\nkubectl taint nodes --all node-role.kubernetes.io/control-plane-\nkubectl taint nodes --all node-role.kubernetes.io/master-\n\n\n#####################################################################################################\n# !!! Note: uninstall calico if need.\n# helm uninstall calico -n tigera-operator\n</code></pre>"},{"location":"kubernetes/Install-k8s-Cluster/#8-add-harbor-dns","title":"8 Add Harbor dns","text":"<pre><code>root@master1:~/StorageClass# kubectl -n kube-system edit cm coredns\nconfigmap/coredns edited\n\n\nroot@master1:~/StorageClass# kubectl -n kube-system get cm coredns -oyaml\napiVersion: v1\ndata:\n  Corefile: |\n    .:53 {\n        errors\n        health {\n           lameduck 5s\n        }\n        hosts {\n          10.1.1.2  harbor.dockerregistry.com\n          fallthrough\n        }\n        ready\n        kubernetes cluster.local in-addr.arpa ip6.arpa {\n           pods insecure\n           fallthrough in-addr.arpa ip6.arpa\n           ttl 30\n        }\n        prometheus :9153\n        forward . /etc/resolv.conf {\n           max_concurrent 1000\n        }\n        cache 30\n        loop\n        reload\n        loadbalance\n    }\nkind: ConfigMap\nmetadata:\n  creationTimestamp: \"2023-12-04T08:00:44Z\"\n  name: coredns\n  namespace: kube-system\n  resourceVersion: \"216930\"\n  uid: 767269af-1974-41d6-8cd3-c0b28d92b97c\n\nroot@master1:~/StorageClass# kubectl delete -n kube-system pod `kubectl get pod -A|grep dns|awk '{print $2}'`\npod \"coredns-7bdc4cb885-htf8t\" deleted\npod \"coredns-7bdc4cb885-s4b9j\" deleted\n</code></pre>"},{"location":"kubernetes/Install-k8s-Cluster/#9-add-taint","title":"9 Add taint","text":"<pre><code># \u5f00\u542f\u4e3b\u8282\u70b9\u7684\u6c61\u70b9\uff0c\u4e0d\u8ba9\u4e1a\u52a1\u5bb9\u5668\u8dd1\u8fc7\u6765\n\n# \u5b89\u88c5jq\napt-get update\napt-get install jq\n\n# \u67e5\u770b\u6c61\u70b9\nroot@master1:~/gitlab-runner# kubectl get nodes -o json | jq -r '.items[] | {name: .metadata.name, taints: .spec.taints}'\n{\n  \"name\": \"master1.k8scluster.com\",\n  \"taints\": null\n}\n{\n  \"name\": \"master2.k8scluster.com\",\n  \"taints\": null\n}\n{\n  \"name\": \"master3.k8scluster.com\",\n  \"taints\": null\n}\n{\n  \"name\": \"worker1.k8scluster.com\",\n  \"taints\": null\n}\n\n# \u6dfb\u52a0\u6c61\u70b9\n# kubectl taint nodes &lt;node-name&gt; key=value:NoSchedule\nkubectl taint nodes master1.k8scluster.com node-role.kubernetes.io/master=:NoSchedule\nkubectl taint nodes master2.k8scluster.com node-role.kubernetes.io/master=:NoSchedule\nkubectl taint nodes master3.k8scluster.com node-role.kubernetes.io/master=:NoSchedule\n\n# \u79fb\u9664\u6c61\u70b9\uff08\u82e5\u9700\u8981\uff09\n# kubectl taint nodes &lt;node-name&gt; key=value:NoSchedule-\n\n\n# \u67e5\u770b\u6c61\u70b9\nroot@master1:~/gitlab-runner# kubectl get nodes -o json | jq -r '.items[] | {name: .metadata.name, taints: .spec.taints}'\n{\n  \"name\": \"master1.k8scluster.com\",\n  \"taints\": [\n    {\n      \"effect\": \"NoSchedule\",\n      \"key\": \"node-role.kubernetes.io/master\"\n    }\n  ]\n}\n{\n  \"name\": \"master2.k8scluster.com\",\n  \"taints\": [\n    {\n      \"effect\": \"NoSchedule\",\n      \"key\": \"node-role.kubernetes.io/master\"\n    }\n  ]\n}\n{\n  \"name\": \"master3.k8scluster.com\",\n  \"taints\": [\n    {\n      \"effect\": \"NoSchedule\",\n      \"key\": \"node-role.kubernetes.io/master\"\n    }\n  ]\n}\n{\n  \"name\": \"worker1.k8scluster.com\",\n  \"taints\": null\n}\n</code></pre>"},{"location":"kubernetes/Install-k8s-Cluster/#10-expose-service-port","title":"10 Expose Service Port","text":"<pre><code># all master nodes\n\nroot@master1:~# vim /etc/kubernetes/manifests/kube-scheduler.yaml\nroot@master1:~# grep \"0.0.0.0\" /etc/kubernetes/manifests/kube-scheduler.yaml\n    - --bind-address=0.0.0.0  # here\n\n\n\nroot@master1:~# vim /etc/kubernetes/manifests/kube-controller-manager.yaml\nroot@master1:~# grep \"0.0.0.0\" /etc/kubernetes/manifests/kube-controller-manager.yaml\n    - --bind-address=0.0.0.0 # here\n</code></pre>"},{"location":"kubernetes/Install-k8s-Cluster/#11-uninstall-calico","title":"11 Uninstall Calico","text":"<p>\u9ad8\u5371\u64cd\u4f5c</p> <pre><code># \u5982\u679c\u6709\u5fc5\u8981\u7684\u8bdd\nkubectl delete daemonset calico-node -n calico-system\nkubectl delete deployment calico-kube-controllers -n calico-system\nkubectl delete deployment calico-typha -n calico-system\nkubectl delete service -l k8s-app=calico -n calico-system\nkubectl delete configmap -l k8s-app=calico -n calico-system\nkubectl delete serviceaccount -l k8s-app=calico -n calico-system\nkubectl delete clusterrole,clusterrolebinding -l k8s-app=calico\nkubectl delete crd -l k8s-app=calico\nkubectl delete namespace calico-system\n\nkubectl delete pod calico-kube-controllers-dcf6df9f9-sgrsm -n calico-system --force --grace-period=0\nkubectl delete pod csi-node-driver-8xw8r -n calico-system --force --grace-period=0\nkubectl delete pod csi-node-driver-k28g4 -n calico-system --force --grace-period=0\nkubectl delete pod csi-node-driver-kbh6d -n calico-system --force --grace-period=0\nkubectl delete pod csi-node-driver-qvl6h -n calico-system --force --grace-period=0\nkubectl delete pod csi-node-driver-sm6q5 -n calico-system --force --grace-period=0\nkubectl delete pod csi-node-driver-zpqxh -n calico-system --force --grace-period=0\n\n\n\nkubectl get namespace calico-apiserver -o json &gt; calico-apiserver-temp.json\nkubectl get namespace calico-system -o json &gt; calico-system-temp.json\nvim calico-apiserver-temp.json \nvim calico-system-temp.json\nkubectl replace --raw \"/api/v1/namespaces/calico-apiserver/finalize\" -f ./calico-apiserver-temp.json\nkubectl replace --raw \"/api/v1/namespaces/calico-system/finalize\" -f ./calico-system-temp.json\n\nmodprobe -r ipip\nrm /etc/cni/net.d/* -rf \nrm /var/lib/cni/ -rf\nsystemctl restart kubelet containerd\nkubectl delete -n kube-system pod `kubectl get pod -A|grep dns|awk '{print $2}'`\nsync;reboot\n</code></pre>"},{"location":"kubernetes/Install-k8s-Cluster/#12-reset-cluster","title":"12 Reset Cluster","text":"<pre><code>kubeadm reset\n\niptables -F\niptables -X\niptables -t nat -F\niptables -t nat -X\niptables -t mangle -F\niptables -t mangle -X\niptables -P FORWARD ACCEPT\n\nipvsadm --clear\nip link delete kube-ipvs0\n\n\nrm -rf /etc/kubernetes/\nrm -rf /var/lib/kubelet/\nrm -rf /var/lib/etcd/\nrm -rf /var/lib/cni/\nrm -f $HOME/.kube/config\n\n\nifconfig cni0 down\nip link delete cni0\nifconfig flannel.1 down\nip link delete flannel.1\nmodprobe -r ipip\nrm /etc/cni/net.d/* -rf \nrm /var/lib/cni/ -rf\n\nrm -rf /etc/cni/net.d/\n\nsystemctl stop apparmor\nsystemctl disable apparmor \nsystemctl restart containerd.service\n\nsystemctl stop etcd\nrm /data/etcd/* -rf \nrm /data/etcd-backups/backup-202401*.db -rf \nrm /data/etcd-backups/backup-202401*.log -rf \nsystemctl start etcd\n</code></pre>"},{"location":"linux/Debian-offline-package/","title":"Debian offline package","text":"<p>\u79bb\u7ebf\u5b89\u88c5\u5728Linux\u7cfb\u7edf\u4e2d\u662f\u4e00\u4e2a\u5e38\u89c1\u7684\u9700\u6c42\u3002\u4ee5\u4e0b\u662f\u5728Debian\u7cfb\u5217\u64cd\u4f5c\u7cfb\u7edf\uff08\u5982Debian, Ubuntu\uff09\u4e0a\u521b\u5efa\u548c\u4f7f\u7528\u79bb\u7ebf\u5b89\u88c5\u5305\u7684\u5b8c\u6574\u6b65\u9aa4\u3002</p>"},{"location":"linux/Debian-offline-package/#_1","title":"\u5728\u8054\u7f51\u7684\u73af\u5883\u4e0b","text":""},{"location":"linux/Debian-offline-package/#1","title":"1. \u4e0b\u8f7d\u8f6f\u4ef6\u5305\u53ca\u5176\u4f9d\u8d56","text":"<p>\u9996\u5148\uff0c\u786e\u5b9a\u4f60\u9700\u8981\u7684\u8f6f\u4ef6\u5305\u548c\u7248\u672c\u3002\u4f7f\u7528APT\u7684\u4e0b\u8f7d\u529f\u80fd\u6765\u83b7\u53d6\u8f6f\u4ef6\u5305\u548c\u5b83\u7684\u6240\u6709\u4f9d\u8d56\uff0c\u4f46\u4e0d\u5b89\u88c5\u5b83\u4eec\u3002</p> <pre><code>sudo apt-get install --download-only &lt;package-name&gt;\n</code></pre> <p>\u8fd9\u4f1a\u5c06\u8f6f\u4ef6\u5305\u53ca\u5176\u4f9d\u8d56\u4e0b\u8f7d\u5230 <code>/var/cache/apt/archives/</code> \u76ee\u5f55\u3002</p>"},{"location":"linux/Debian-offline-package/#2","title":"2. \u590d\u5236\u4e0b\u8f7d\u7684\u5305","text":"<p>\u5c06\u4e0b\u8f7d\u7684 <code>.deb</code> \u5305\u590d\u5236\u5230\u4e00\u4e2a\u79fb\u52a8\u5b58\u50a8\u8bbe\u5907\u4e0a\u3002</p> <pre><code>cp /var/cache/apt/archives/*.deb /path/to/your/usb-drive/debian-offline-packages\n</code></pre>"},{"location":"linux/Debian-offline-package/#3-apt","title":"3. \u521b\u5efa\u672c\u5730APT\u4ed3\u5e93","text":"<p>\u5728\u79fb\u52a8\u5b58\u50a8\u8bbe\u5907\u7684\u76f8\u540c\u76ee\u5f55\u4e0b\uff0c\u4f7f\u7528 <code>dpkg-scanpackages</code> \u5de5\u5177\u6765\u521b\u5efa <code>Packages.gz</code> \u7d22\u5f15\u6587\u4ef6\u3002\u5982\u679c\u6ca1\u6709\u5b89\u88c5 <code>dpkg-dev</code>\uff0c\u9700\u8981\u5148\u5b89\u88c5\u5b83\u3002</p> <pre><code>sudo apt-get install dpkg-dev\ncd /path/to/your/usb-drive/debian-offline-packages\ndpkg-scanpackages . /dev/null | gzip -9c &gt; Packages.gz\n</code></pre>"},{"location":"linux/Debian-offline-package/#_2","title":"\u5728\u79bb\u7ebf\u7684\u73af\u5883\u4e0b","text":""},{"location":"linux/Debian-offline-package/#4-apt","title":"4. \u51c6\u5907\u672c\u5730APT\u4ed3\u5e93","text":"<p>\u5c06\u79fb\u52a8\u5b58\u50a8\u8bbe\u5907\u8fde\u63a5\u5230\u79bb\u7ebf\u7684Debian\u7cfb\u7edf\u3002\u590d\u5236 <code>.deb</code> \u5305\u5230\u672c\u5730\u6587\u4ef6\u7cfb\u7edf\uff0c\u5e76\u4fdd\u7559\u76ee\u5f55\u7ed3\u6784\u3002</p> <pre><code>mkdir -p /path/to/local/repo\ncp /path/to/your/usb-drive/debian-offline-packages/* /path/to/local/repo\n</code></pre>"},{"location":"linux/Debian-offline-package/#5-apt","title":"5. \u6dfb\u52a0\u672c\u5730\u4ed3\u5e93\u5230APT\u6e90","text":"<p>\u521b\u5efa\u4e00\u4e2aAPT\u6e90\u5217\u8868\u6587\u4ef6\uff0c\u4ee5\u4fbfAPT\u53ef\u4ee5\u4f7f\u7528\u672c\u5730\u4ed3\u5e93\u3002</p> <pre><code>echo 'deb [trusted=yes] file:///path/to/local/repo ./' | sudo tee /etc/apt/sources.list.d/local-offline-repo.list\n</code></pre>"},{"location":"linux/Debian-offline-package/#6","title":"6. \u66f4\u65b0\u8f6f\u4ef6\u5305\u5217\u8868","text":"<p>\u66f4\u65b0\u672c\u5730\u5305\u6570\u636e\u5e93\uff0c\u4f7fAPT\u80fd\u591f\u8bc6\u522b\u65b0\u7684\u672c\u5730\u4ed3\u5e93\u3002</p> <pre><code>sudo apt-get update\n</code></pre>"},{"location":"linux/Debian-offline-package/#7","title":"7. \u5b89\u88c5\u8f6f\u4ef6","text":"<p>\u73b0\u5728\uff0c\u4f7f\u7528 <code>apt-get install</code> \u547d\u4ee4\u5b89\u88c5\u8f6f\u4ef6\u5305\uff0cAPT\u5c06\u89e3\u51b3\u6240\u6709\u672c\u5730\u4f9d\u8d56\u3002</p> <pre><code>sudo apt-get install &lt;package-name&gt;\n</code></pre>"},{"location":"linux/Debian-offline-package/#_3","title":"\u6ce8\u610f\u4e8b\u9879","text":"<ul> <li>\u8fd9\u4e2a\u8fc7\u7a0b\u5047\u5b9a\u4f60\u5df2\u7ecf\u6709\u4e86\u79fb\u52a8\u5b58\u50a8\u8bbe\u5907\uff0c\u5982USB\u9a71\u52a8\u5668\uff0c\u5e76\u4e14\u5b83\u5df2\u7ecf\u88ab\u6302\u8f7d\u5230\u4e86\u4f60\u7684\u7cfb\u7edf\u4e0a\u3002</li> <li><code>&lt;package-name&gt;</code> \u662f\u4f60\u60f3\u8981\u4e0b\u8f7d\u5e76\u5b89\u88c5\u7684\u8f6f\u4ef6\u5305\u540d\u79f0\u3002</li> <li><code>/path/to/your/usb-drive</code> \u662f\u4f60USB\u9a71\u52a8\u5668\u7684\u6302\u8f7d\u70b9\u3002</li> <li><code>/path/to/local/repo</code> \u662f\u4f60\u5728\u79bb\u7ebf\u673a\u5668\u4e0a\u521b\u5efa\u7684\u672c\u5730\u4ed3\u5e93\u76ee\u5f55\u7684\u8def\u5f84\u3002</li> </ul> <p>\u6309\u7167\u8fd9\u4e9b\u6b65\u9aa4\uff0c\u4f60\u5e94\u8be5\u80fd\u591f\u5728Debian\u7cfb\u5217\u7cfb\u7edf\u4e0a\u8fdb\u884c\u79bb\u7ebf\u8f6f\u4ef6\u5b89\u88c5\u3002</p>"},{"location":"linux/Debian/","title":"Debian","text":""},{"location":"linux/Debian/#_1","title":"\u7cfb\u7edf\u521d\u59cb\u5316","text":"<pre><code>############################# \u5237\u65b0\u78c1\u76d8\uff08\u53ef\u9009\uff09\n# mount \n# /media/cdrom/\napt-cdrom add \n\n\n############################# \u6dfb\u52a0\u8f6f\u4ef6\u6e90\n# add internet repo\n# \u5220\u9664\u6ce8\u91ca\u884c\uff08\u4ee5#\u5f00\u5934\u7684\u884c\u6216\u8005\u7a7a\u884c\uff09\nsed -i '/^#/d; /^$/d' /etc/apt/sources.list\n# \u6ce8\u91ca\u6389\u539f\u59cb\u884c\nsed -i 's/^deb cdrom:\\[Debian GNU\\/Linux.*$/#&amp;/' /etc/apt/sources.list\n# \u5220\u9664\u5b89\u5168\u884c\nsed -i '/^deb http:\\/\\/security.debian.org\\/debian-security/d' /etc/apt/sources.list\nsed -i '/^deb-src http:\\/\\/security.debian.org\\/debian-security/d' /etc/apt/sources.list\n# \u6dfb\u52a0\u65b0\u7684\u884c\nsh -c 'echo \"deb http://mirrors.tuna.tsinghua.edu.cn/debian/ bullseye main contrib non-free\" &gt;&gt; /etc/apt/sources.list'\nsh -c 'echo \"deb http://mirrors.tuna.tsinghua.edu.cn/debian/ bullseye-updates main contrib non-free\" &gt;&gt; /etc/apt/sources.list'\nsh -c 'echo \"deb http://mirrors.tuna.tsinghua.edu.cn/debian/ bullseye-backports main contrib non-free\" &gt;&gt; /etc/apt/sources.list'\nsh -c 'echo \"deb http://mirrors.tuna.tsinghua.edu.cn/debian-security bullseye-security main contrib non-free\" &gt;&gt; /etc/apt/sources.list'\n\n\n\n############################# \u66f4\u65b0\u8f6f\u4ef6\n# update soft\napt update \napt upgrade -y \n\n\n############################# \u5b89\u88c5\u5de5\u5177\n# use local repo to install pkg\napt update\napt install -y  \\\napt-transport-https ca-certificates vim net-tools sudo telnet ufw iotop rsync unzip  \\\niputils-ping  gawk sed  cron gnupg locales curl wget  nfs-common  sshpass tree software-properties-common\n\n############################# \u786e\u8ba4\u7cfb\u7edf\u8bed\u8a00\n# change to en\nlocale-gen en_US.UTF-8\nsed -i 's/LANG=\"zh_CN.UTF-8\"/LANG=\"en_US.UTF-8\"/' /etc/default/locale\nsed -i 's/LANGUAGE=\"zh_CN:zh\"/LANGUAGE=\"en_US:en\"/' /etc/default/locale\nsed -i 's/^zh_CN.UTF-8 UTF-8/#zh_CN.UTF-8 UTF-8/' /etc/locale.gen\nsed -i 's/#en_US.UTF-8 UTF-8/en_US.UTF-8 UTF-8/' /etc/locale.gen\n\ncat &lt;&lt;-EOF | tee  /etc/default/locale\nLC_ALL=en_US.utf8\nLANG=en_US.utf8\nLANGUAGE=en_US.utf8\nEOF\n\nlocale-gen\n# dpkg-reconfigure locales # \u53ea\u9009\u62e9 en_US.UTF-8\uff0c\u53bb\u6389 zh_CN.UTF-8 (\u82e5\u5b58\u5728)\n\n\necho \"export LANG=en_US.utf8\" &gt;&gt; /etc/profile\necho \"export LANGUAGE=en_US.utf8\" &gt;&gt; /etc/profile\nsource /etc/profile\n\n\n\n\n\n\n############################# \u6253\u5f00\u8fdc\u7a0b\n# export root ssh\nsed -ri 's/#PermitRootLogin prohibit-password/PermitRootLogin yes/' /etc/ssh/sshd_config\nservice ssh restart\negrep '^PermitRootLogin' /etc/ssh/sshd_config\n\n############################# \u4fee\u6539\u663e\u793a\n# .bashrc\n\nsed -i '/^# export LS_OPTIONS/s/^# //' ~/.bashrc\nsed -i '/^# eval \"\\$(dircolors)\"/s/^# //' ~/.bashrc\nsed -i '/^# alias ls=/s/^# //' ~/.bashrc\nsed -i '/^# alias ll=/s/^# //' ~/.bashrc\nsed -i '/^# alias l=/s/^# //' ~/.bashrc\n\nsource ~/.bashrc\n\n\n\n############################# \u4fee\u6539\u9759\u6001IP\uff08\u53ef\u9009\uff0c\u82e5\u5df2\u7ecf\u914d\u7f6e\u8bf7\u5ffd\u7565\uff09\n# static ip \nvim /etc/network/interfaces\n\n$ cat  /etc/network/interfaces\n# This file describes the network interfaces available on your system\n# and how to activate them. For more information, see interfaces(5).\n\nsource /etc/network/interfaces.d/*\n\n# The loopback network interface\nauto lo\niface lo inet loopback\n\n# The primary network interface\n#allow-hotplug ens32\n#iface ens32 inet dhcp\nauto ens32\niface ens32 inet static\n    address 192.168.171.136\n    netmask 255.255.255.0\n    gateway 192.168.171.2\n\n############################# \u5173\u95ed\u865a\u62df\u5185\u5b58\n# swapoff (if exited)\nswapoff -a\nsed -i '/swap/d' /etc/fstab\nmount -a\n\n\n############################# \u79fb\u9664\u591a\u4f59\u670d\u52a1\u548c\u5305\nsystemctl stop rpcbind\nsystemctl disable rpcbind\napt autoremove rpcbind -y\n\n############################# \u91cd\u542f\u673a\u5668\n# reboot\nsync;reboot\n</code></pre>"},{"location":"linux/Deepin/","title":"Deepin","text":"<p>\u56e0\u4e3aDeepin \u662f\u57fa\u4e8edebian \u7cfb\u5217\u505a\u5206\u652f\u5f00\u53d1\u7684\uff0c\u6240\u4ee5\u4f7f\u7528\u547d\u4ee4\u4e5f\u662f\u4e0edebian \u7c7b\u4f3c\u3002</p>"},{"location":"linux/Deepin/#_1","title":"\u521b\u5efa\u666e\u901a\u7528\u6237","text":"<p>\u8fd9\u4e2a\u662f\u5728\u5b89\u88c5\u7cfb\u7edf\u65f6\uff0c\u7531\u5b89\u88c5\u4eba\u5458\u6307\u5b9a\u7684\uff0c\u5982\u679c\u540e\u671f\u4f7f\u7528\u8fc7\u7a0b\u4e2d\u53d1\u73b0\u7528\u6237\u4e0e\u6211\u4eec\u540e\u9762\u6587\u6863\u4e2d\u6240\u9700\u8981 <code>deepin</code>\u7684\u4e0d\u4e00\u81f4\uff0c\u8bf7\u81ea\u5df1\u624b\u52a8\u65b0\u5efa\u4e2a\u7528\u6237\u3002</p> <pre><code># \u521b\u5efa\u7528\u6237\n# \u8fd9\u91cc `-m` \u9009\u9879\u544a\u8bc9 `useradd` \u4e3a\u65b0\u7528\u6237\u521b\u5efa\u4e00\u4e2a\u5bb6\u76ee\u5f55\u3002\nsudo useradd -m deepin\n\n# \u8bbe\u7f6e\u5bc6\u7801\n# \u5c06 `deepin` \u66ff\u6362\u4e3a\u65b0\u7528\u6237\u540d\uff0c\u5c06 `password` \u66ff\u6362\u4e3a\u4f60\u60f3\u8981\u7684\u5bc6\u7801\necho 'deepin:password' | sudo chpasswd\n\n\n# \u6216\u8005\nsudo useradd -m deepin &amp;&amp; echo 'deepin:password' | sudo chpasswd\n</code></pre>"},{"location":"linux/Deepin/#root","title":"\u4fee\u6539root\u5bc6\u7801","text":"<pre><code># \u9ed8\u8ba4root \u6ca1\u6709\u5bc6\u7801\uff0c\u9700\u8981\u81ea\u5df1\u6307\u5b9a\u4e2a\nsudo passwd root\n</code></pre>"},{"location":"linux/Deepin/#sudo","title":"sudo \u514d\u5bc6\u7801","text":"<pre><code># \u5207\u5230root\n$ su -\n# \u4fee\u6539\u6743\u9650\n$ chmod 740 /etc/sudoers\n$ vi /etc/sudoers\n#%sudo  ALL=(ALL:ALL) ALL # \u5c06\u539f\u6709\u8fd9\u884c\u6ce8\u91ca\u4e86\uff0c\u6539\u6210\u4e0b\u9762\u8fd9\u79cd\n%sudo   ALL=(ALL:ALL) NOPASSWD:ALL\n# \u6743\u9650\u6539\u56de\u53bb\n$ chmod 0440 /etc/sudoers \n</code></pre>"},{"location":"linux/Deepin/#_2","title":"\u4fee\u6539\u7aef\u53e3\u8303\u56f4","text":"<pre><code>[root@localhost ~]# cat /proc/sys/net/ipv4/ip_local_port_range\n32768   61000\n[root@localhost ~]# echo 1024 65535 &gt; /proc/sys/net/ipv4/ip_local_port_range\n</code></pre>"},{"location":"linux/Deepin/#_3","title":"\u79bb\u7ebf\u5b89\u88c5\u5e38\u7528\u5de5\u5177","text":"<p> **\u79bb\u7ebf\u5305\u5b89\u88c5\u5c40\u9650\u6027\uff1a\u53ea\u80fd\u7528\u4e8e\u76f8\u540c\u73af\u5883\u4e0b\u7684\u64cd\u4f5c\u7cfb\u7edf\u3002**\u6bd4\u5982\u64cd\u4f5c\u7cfb\u7edf\u7248\u672c\uff08\u5305\u62ec\u5c0f\u7248\u672c\uff09\uff0c\u64cd\u4f5c\u7cfb\u7edf\u5b89\u88c5\u65b9\u5f0f\u7b49\u7b49\u3002\u56e0\u4e3a\u5b89\u88c5\u65f6\u53ef\u4ee5\u9009\u62e9\u591a\u79cd\u65b9\u5f0f\u5b89\u88c5\uff0c\u4e0d\u540c\u65b9\u5f0f\u5bfc\u81f4\u7684\u73af\u5883\u4e0d\u540c\u4f1a\u5f71\u54cd\u6700\u540e\u5236\u4f5c\u79bb\u7ebf\u5305\u65f6\u4e2a\u6570\u4e0e\u79cd\u7c7b\u4e0d\u540c\u3002</p> <pre><code>## \u8fd9\u91cc\u662f\u5728\u80fd\u8054\u4e92\u8054\u7f51\u7684\u673a\u5668\u4e0a\u9762\u6267\u884c,\u5efa\u8bae\u5728root \u8d26\u53f7\u4e0b\u64cd\u4f5c\n##################################################### \u5236\u4f5c\u79bb\u7ebf\u5305 #####################################################\n# \u5148\u4f7f\u7528\u9ed8\u8ba4\u7684\u955c\u50cf\u6e90\napt update \n\n# \u4e0b\u8f7d openssh-server \u8f6f\u4ef6\u5305\n# \u8fd9\u4e2a\u547d\u4ee4\u4f1a\u5c06 `openssh-server` \u53ca\u5176\u6240\u6709\u672a\u5b89\u88c5\u7684\u4f9d\u8d56\u9879\u4e0b\u8f7d\u5230 `/var/cache/apt/archives/` \u76ee\u5f55\u3002\napt install -y  --download-only openssh-server vim ansible htop tree net-tools lsof lrzsz curl ebtables conntrack socat wget telnet chrony rsync tcpdump htop xfsprogs chkconfig\n# \u67e5\u770b\u672c\u5730\u76ee\u5f55\u4e0b\u6587\u4ef6\nroot@deepin-1:~# ls -lh /var/cache/apt/archives/*.deb\n-rw-r--r-- 1 root root 1.6M Apr 13  2017 /var/cache/apt/archives/ansible_2.2.1.0-2_all.deb\n-rw-r--r-- 1 root root 210K Aug  7  2017 /var/cache/apt/archives/chrony_3.0-4+deb9u1_amd64.deb\n-rw-r--r-- 1 root root  33K Feb 16  2017 /var/cache/apt/archives/conntrack_1%3a1.4.4+snapshot20161117-5_amd64.deb\n-rw-r--r-- 1 root root 223K Nov  2  2018 /var/cache/apt/archives/curl_7.52.1-5+deb9u8_amd64.deb\n-rw-r--r-- 1 root root  84K Mar  4  2017 /var/cache/apt/archives/ebtables_2.0.10.4-3.5+b1_amd64.deb\n-rw-r--r-- 1 root root  87K Jul 26  2016 /var/cache/apt/archives/htop_2.0.2-1_amd64.deb\n-rw-r--r-- 1 root root 930K Jun 13  2016 /var/cache/apt/archives/ieee-data_20160613.1_all.deb\n-rw-r--r-- 1 root root 285K Nov  2  2018 /var/cache/apt/archives/libcurl3_7.52.1-5+deb9u8_amd64.deb\n-rw-r--r-- 1 root root  47K Oct  1  2016 /var/cache/apt/archives/libyaml-0-2_0.1.7-2_amd64.deb\n-rw-r--r-- 1 root root 306K Sep 16  2015 /var/cache/apt/archives/lsof_4.89+dfsg-0.1_amd64.deb\n-rw-r--r-- 1 root root 459K Feb 15  2018 /var/cache/apt/archives/ncurses-term_6.0+20161126-1+deb9u2_all.deb\n-rw-r--r-- 1 root root 325K Aug 22  2018 /var/cache/apt/archives/openssh-server_1%3a7.4p1-10+deb9u4_amd64.deb\n-rw-r--r-- 1 root root  39K Aug 22  2018 /var/cache/apt/archives/openssh-sftp-server_1%3a7.4p1-10+deb9u4_amd64.deb\n-rw-r--r-- 1 root root  68K Dec 31  2016 /var/cache/apt/archives/python-cffi-backend_1.9.1-2_amd64.deb\n-rw-r--r-- 1 root root 206K May 28  2017 /var/cache/apt/archives/python-cryptography_1.7.1-3_amd64.deb\n-rw-r--r-- 1 root root  35K Jul 13  2016 /var/cache/apt/archives/python-enum34_1.1.6-1_all.deb\n-rw-r--r-- 1 root root  39K Nov 10  2016 /var/cache/apt/archives/python-httplib2_0.9.2+dfsg-1_all.deb\n-rw-r--r-- 1 root root  32K Dec 26  2016 /var/cache/apt/archives/python-idna_2.2-1_all.deb\n-rw-r--r-- 1 root root  18K Nov  1  2016 /var/cache/apt/archives/python-ipaddress_1.0.17-1_all.deb\n-rw-r--r-- 1 root root 109K Aug  1  2015 /var/cache/apt/archives/python-jinja2_2.8-1_all.deb\n-rw-r--r-- 1 root root  22K Mar  2  2016 /var/cache/apt/archives/python-kerberos_1.1.5-2+b2_amd64.deb\n-rw-r--r-- 1 root root  15K Nov  7  2016 /var/cache/apt/archives/python-markupsafe_0.23-3_amd64.deb\n-rw-r--r-- 1 root root 222K Sep 10  2016 /var/cache/apt/archives/python-netaddr_0.7.18-2_all.deb\n-rw-r--r-- 1 root root 109K Jun  9  2016 /var/cache/apt/archives/python-paramiko_2.0.0-1_all.deb\n-rw-r--r-- 1 root root  51K Sep 12  2016 /var/cache/apt/archives/python-pyasn1_0.1.9-2_all.deb\n-rw-r--r-- 1 root root 168K Sep 24  2017 /var/cache/apt/archives/python-selinux_2.6-3+b3_amd64.deb\n-rw-r--r-- 1 root root 291K Jan 20  2017 /var/cache/apt/archives/python-setuptools_33.1.1-1_all.deb\n-rw-r--r-- 1 root root  12K Sep 19  2016 /var/cache/apt/archives/python-xmltodict_0.10.2-1_all.deb\n-rw-r--r-- 1 root root 116K Sep  4  2016 /var/cache/apt/archives/python-yaml_3.12-1_amd64.deb\n-rw-r--r-- 1 root root 405K Sep 13  2017 /var/cache/apt/archives/tcpdump_4.9.2-1~deb9u1_amd64.deb\n-rw-r--r-- 1 root root  71K Nov 10  2016 /var/cache/apt/archives/telnet_0.17-41_amd64.deb\n-rw-r--r-- 1 root root  46K Jan  5  2017 /var/cache/apt/archives/tree_1.7.0-5_amd64.deb\n\n##################################################### \u5236\u4f5c\u672c\u5730\u6e90 #################################################\n# \u5148\u5728\u672c\u5730\u6d4b\u8bd5\n# \u6ce8\u91ca\u539f\u6709\u9ed8\u8ba4\u6e90\nroot@deepin-1:~# vi /etc/apt/sources.list\nroot@deepin-1:~# cat /etc/apt/sources.list\n## Generated by deepin-installer\n#deb [by-hash=force] http://packages.deepin.com/deepin lion main contrib non-free  # \u8fd9\u91cc\n#deb-src http://packages.deepin.com/deepin lion main contrib non-free\n\n# \u65b0\u5efa\u76ee\u5f55\nmkdir -p /home/deepin/debs\n# \u62f7\u8d1d\u6587\u4ef6\ncp -rvf /var/cache/apt/archives/*.deb /home/deepin/debs\n# \u751f\u6210\u672c\u5730\u6e90\u7684\u7d22\u5f15\u6587\u4ef6\ncd /home/deepin/debs\ndpkg-scanpackages . /dev/null | gzip -9c &gt; Packages.gz\n\n# \u6dfb\u52a0\u672c\u5730\u6e90\nroot@deepin-1:~# sudo sh -c 'echo \"deb [trusted=yes] file:/home/deepin/debs ./\" &gt;&gt; /etc/apt/sources.list'\nroot@deepin-1:~# cat /etc/apt/sources.list\n## Generated by deepin-installer\n#deb [by-hash=force] http://packages.deepin.com/deepin lion main contrib non-free\n#deb-src http://packages.deepin.com/deepin lion main contrib non-free\ndeb [trusted=yes] file:/home/deepin/debs ./\n\n# \u4fee\u6539\u76ee\u5f55\u6743\u9650\nchown -R deepin.deepin /home/deepin/debs\n\n# \u5207\u6362\u5230\u666e\u901a\u7528\u6237\nsu - deepin\n# \u5237\u65b0\u4ed3\u5e93\napt update \n# \u672c\u5730\u6d4b\u8bd5\u79bb\u7ebf\u5b89\u88c5\u5305\nsudo apt install -y openssh-server vim ansible htop tree net-tools lsof lrzsz curl ebtables conntrack socat wget telnet chrony rsync tcpdump htop xfsprogs chkconfig\n\n##################################################### \u5176\u4ed6\u673a\u5668\u590d\u7528 #################################################\n# \u590d\u5236\u4e0b\u8f7d\u7684 .deb \u6587\u4ef6\n# \u60a8\u53ef\u4ee5\u5c06\u6240\u6709\u4e0b\u8f7d\u7684 .deb \u6587\u4ef6\u590d\u5236\u5230\u4e00\u4e2a USB \u9a71\u52a8\u5668\u6216\u5176\u4ed6\u79fb\u52a8\u5b58\u50a8\u8bbe\u5907\u4e2d\u3002\ncp /home/deepin/debs/*.deb /path/to/your/usb-drive\n\n# \u7c7b\u4f3c\u7684\uff0c\u5230\u65b0\u7684\u673a\u5668\u4e0a\u9762\u6267\u884c\u76f8\u540c\u7684\u5236\u4f5c\u672c\u5730\u6e90\u7684\u6b65\u9aa4\n</code></pre>"},{"location":"linux/Deepin/#ip","title":"\u9759\u6001IP\u914d\u7f6e","text":"<p>\u53ef\u53c2\u8003\u535a\u5ba2\uff1a</p> <p>https://blog.csdn.net/zhuohui307317684/article/details/124882901</p> <p>https://www.cnblogs.com/javayanglei/p/13305285.html</p> <pre><code># \u4fee\u6539\u914d\u7f6e\nroot@deepin-1:~# sudo vim /etc/network/interfaces\nroot@deepin-1:~# cat /etc/network/interfaces\n# interfaces(5) file used by ifup(8) and ifdown(8)\n# Include files from /etc/network/interfaces.d:\nsource-directory /etc/network/interfaces.d\n\nauto ens33 # \u8fd9\u91cc\u5f80\u4e0b\niface ens33 inet static\n    address 192.168.171.153\n    netmask 255.255.255.0\n    gateway 192.168.171.2\n\n# \u91cd\u542f\u7f51\u7edc\nsudo systemctl restart networking\n\n# \u5efa\u8bae\u91cd\u542f\u673a\u5668\nsync;reboot\n</code></pre> <p> \u6ce8\u610f\u4e0d\u540cdebian \u7248\u672c\u7684\u5199\u6cd5\u4e0d\u540c\uff0c\u4ee5v10 \u5206\u754c\u3002</p> <pre><code>###################################### \u65e7\u7248\u672c\u5199\u6cd5\nauto eth0\niface eth0 inet static\n    address 192.168.1.100\n    netmask 255.255.255.0\n    gateway 192.168.1.1\n\n\n###################################### \u65b0\u7248\u672c\u5199\u6cd5\n[Match]\nName=eth0\n\n[Network]\nAddress=192.168.1.100/24\nGateway=192.168.1.1\nDNS=192.168.1.1\n</code></pre>"},{"location":"linux/Deepin/#root_1","title":"\u542f\u7528root\u7528\u6237","text":"<p> \u5982\u679c\u9879\u76ee\u4e0a\u6ca1\u6709\u7279\u6b8a\u8981\u6c42\uff0c\u9ed8\u8ba4\u90fd\u662f\u4f7f\u7528ROOT \u7528\u6237\u64cd\u4f5c\u7684\u3002</p> <p>\u666e\u901a\u7528\u6237\u4e5f\u53ef\u7528\uff0c\u4f46\u5bf9\u4e8e\u6570\u636e\u5e93\u7c7b\u578b\u7684\u4e2d\u95f4\u4ef6\u6216\u8005\u672c\u8eab\u5c31\u662f\u6570\u636e\u5e93\uff0c\u5efa\u8bae\u4f7f\u7528ROOT \u6216\u8005\u5bf9\u6570\u636e\u5e93\u914d\u7f6e\u505a\u76f8\u5e94\u5904\u7406\uff0c\u5426\u5219\u53ef\u80fd\u4f1a\u51fa\u73b0\u5f02\u5e38\u3002</p> <pre><code>#  root\u8fdc\u7a0b\u767b\u5f55\n$ sudo vi /etc/ssh/sshd_config\nPermitRootLogin  yes\n\n$ sudo  systemctl  restart  ssh\n</code></pre>"},{"location":"linux/Deepin/#root_2","title":"\u5237\u65b0root \u73af\u5883\u53d8\u91cf","text":"<pre><code>sed -i '/^# export LS_OPTIONS/s/^# //' ~/.bashrc\nsed -i '/^# eval \"\\$(dircolors)\"/s/^# //' ~/.bashrc\nsed -i '/^# alias ls=/s/^# //' ~/.bashrc\nsed -i '/^# alias ll=/s/^# //' ~/.bashrc\nsed -i '/^# alias l=/s/^# //' ~/.bashrc\nsource ~/.bashrc\n</code></pre>"},{"location":"linux/Deepin/#vim-tab","title":"\u5904\u7406Vim \u81ea\u52a8Tab","text":"<p> \u975e\u5fc5\u987b\uff0c\u53ea\u662f\u6709\u4e9b\u65f6\u5019\u9700\u8981\u590d\u5236\u7c98\u8d34\u6587\u672c\u65f6\u7cfb\u7edf\u81ea\u52a8tab \u9020\u6210\u5f88\u591a\u9ebb\u70e6\uff0c\u8fd9\u91cc\u9009\u62e9\u5173\u95ed\u3002</p> <pre><code># \u521b\u5efa\u8fd9\u6837\u4e00\u4e2a\u6587\u4ef6\u5373\u53ef\u3002\nroot@deepin-1:~# vim ~/.vimrc \nroot@deepin-1:~# cat ~/.vimrc\nsyntax on\nset noautoindent\nset nosmartindent\nset nocindent\nfiletype indent off\n</code></pre>"},{"location":"linux/Deepin/#_4","title":"\u67e5\u770b\u7cfb\u7edf\u7248\u672c","text":"<pre><code>root@deepin-1:~# lsb_release -cs\nstable\nroot@deepin-1:~# cat /etc/os-release\nPRETTY_NAME=\"Deepin 15\"\nNAME=\"Deepin\"\nVERSION_ID=\"15.11\"\nVERSION=\"15.11\"\nID=deepin\nHOME_URL=\"https://www.deepin.org/\"\nBUG_REPORT_URL=\"http://feedback.deepin.org/feedback/\"\nroot@deepin-1:~# cat /etc/debian_version\n9.0\n</code></pre>"},{"location":"linux/Kylin/","title":"Kylin","text":""},{"location":"linux/Kylin/#_1","title":"\u7cfb\u7edf\u521d\u59cb\u5316","text":""},{"location":"linux/Kylin/#_2","title":"\u547d\u4ee4\u884c\u542f\u52a8","text":"<pre><code># \u5c06\u56fe\u5f62\u542f\u52a8\u6539\u4e3a\u547d\u4ee4\u884c\u542f\u52a8\nsudo mv /etc/systemd/system/default.target /etc/systemd/system/default.target.backup\nsudo systemctl set-default multi-user.target\nsudo sync;reboot\n\n# \u5982\u679c\u60f3\u56de\u56fe\u5f62\u754c\u9762\u542f\u52a8\nsudo systemctl set-default graphical.target   \nsudo sync;reboot\n</code></pre>"},{"location":"linux/Kylin/#_3","title":"\u8fde\u63a5\u670d\u52a1\u5668","text":"<pre><code># \u6539\u7528mobaxterm \u5de5\u5177\u8fdc\u7a0b\u53ef\u6b63\u5e38\u663e\u793a\uff0cxshell \u8c8c\u4f3c\u8fde\u63a5\u540e\u663e\u793a\u6709\u95ee\u9898\uff0c\u4e0d\u6e05\u695a\u4e3a\u5565\u4f1a\u8fd9\u6837\uff0c\u8054\u7cfb\u9e92\u9e9f\u4ed6\u4eec\u8981\u6c42\u6253400\uff0c\u653e\u5f03\u3002\n# \u4f7f\u7528\u514d\u8d39\u7248\u672c mobaxterm \u5373\u53ef\uff0c\u5c3d\u91cf\u907f\u514d\u4f7f\u7528\u76d7\u7248\uff0c\u5bb9\u6613\u67d3\u6bd2\u3002\n</code></pre>"},{"location":"linux/Kylin/#_4","title":"\u6570\u636e\u76d8\u6302\u8f7d","text":"<p>\u6839\u636e\u81ea\u5df1\u7684\u5b9e\u9645\u9700\u8981\uff0c\u9009\u62e9\u9002\u5408\u81ea\u5df1\u7684\u5206\u533a\u65b9\u5f0f\u5e76\u6302\u8f7d\u78c1\u76d8\u3002</p>"},{"location":"linux/Kylin/#_5","title":"\u5206\u533a\u5e38\u8bc6","text":"<pre><code># \u9009\u62e9MBR \u5206\u533a\u539f\u5219\uff0c\u5355\u4e2a\u6302\u8f7d\u7684\u6570\u636e\u76d8\u5927\u5c0f\u57282T\u4ee5\u5185\uff0c\u5305\u62ec2T\uff1b\u8d85\u8fc72T\uff0c\u8bf7\u9009\u62e9GPT \u5206\u533a\uff0c\u4e0d\u8d70LVM.\n\n# \u9009\u62e9LVM \u903b\u8f91\u76d8\u539f\u5219\uff0c\u5355\u4e2a\u6302\u8f7d\u7684\u6570\u636e\u76d8\u5927\u5c0f\u57281T\u4ee5\u5185\uff0c\u5305\u62ec1T\u3002\n# \u78c1\u76d8\u5c0f\u4f46\u4e3a\u4e86\u65b9\u4fbf\u6269\u5bb9\u624d\u9700\u8981LVM\uff0c\u6839\u636e\u81ea\u5df1\u9700\u8981\u8003\u8651\u662f\u5426\u9700\u8981\u505a\u3002\n# LVM \u903b\u8f91\u5316\u591a\u5c11\u4f1a\u5f71\u54cd\u78c1\u76d8IO\u8bfb\u5199\u6027\u80fd\uff0c\u4e0d\u5efa\u8bae\u5728\u6570\u636e\u5e93\u7b49\u5bf9\u78c1\u76d8\u6027\u80fd\u6709\u8981\u6c42\u7b49\u670d\u52a1\u5668\u4e0a\u5f00\u542f\u3002\n</code></pre>"},{"location":"linux/Kylin/#mbrlvm","title":"MBR\u5206\u533a\uff0c\u4e0d\u505aLVM","text":"<pre><code># \u5bf9\u6570\u636e\u76d8\u8fdb\u884cMBR\u5206\u533a\uff0c\u521b\u5efa\u6587\u4ef6\u7cfb\u7edf\uff0c\u5e76\u6302\u8f7d\u5230/data\u76ee\u5f55\uff0c\u8fd9\u91cc\u4e0d\u505aLVM\n$ lsblk ## \u67e5\u770b\u81ea\u5df1\u5f53\u524d\u78c1\u76d8\nNAME          MAJ:MIN RM SIZE RO TYPE MOUNTPOINT\nsr0            11:0    1   4G  0 rom\nnvme0n1       259:0    0  20G  0 disk\n\u251c\u2500nvme0n1p1   259:1    0  19G  0 part\n\u2502 \u2514\u2500klas-root 253:0    0  19G  0 lvm  /\n\u2514\u2500nvme0n1p2   259:2    0   1G  0 part /boot\nnvme0n2       259:3    0  60G  0 disk\n\n$ fdisk /dev/nvme0n2 # \u5bf9\u5f53\u524d\u7cfb\u7edf\u4e0a\u7a7a\u95f2\u7684\u78c1\u76d8\uff0c\u5373\u5c1a\u672a\u6302\u8f7d\u7684\u78c1\u76d8\uff0c\u8fdb\u884c\u5206\u533a(\u6211\u8fd9\u91cc\u662fnvme0n2 \u7a7a\u95f2)\n\n\u6b22\u8fce\u4f7f\u7528 fdisk (util-linux 2.35.2)\u3002\n\u66f4\u6539\u5c06\u505c\u7559\u5728\u5185\u5b58\u4e2d\uff0c\u76f4\u5230\u60a8\u51b3\u5b9a\u5c06\u66f4\u6539\u5199\u5165\u78c1\u76d8\u3002\n\u4f7f\u7528\u5199\u5165\u547d\u4ee4\u524d\u8bf7\u4e09\u601d\u3002\n\n\u8bbe\u5907\u4e0d\u5305\u542b\u53ef\u8bc6\u522b\u7684\u5206\u533a\u8868\u3002\n\u521b\u5efa\u4e86\u4e00\u4e2a\u78c1\u76d8\u6807\u8bc6\u7b26\u4e3a 0x21366632 \u7684\u65b0 DOS \u78c1\u76d8\u6807\u7b7e\u3002\n\n\u547d\u4ee4(\u8f93\u5165 m \u83b7\u53d6\u5e2e\u52a9)\uff1an  # \u521b\u5efa\u5206\u533a\n\u5206\u533a\u7c7b\u578b\n   p   \u4e3b\u5206\u533a (0 primary, 0 extended, 4 free)\n   e   \u6269\u5c55\u5206\u533a (\u903b\u8f91\u5206\u533a\u5bb9\u5668)\n\u9009\u62e9 (\u9ed8\u8ba4 p)\uff1ap # \u521b\u5efa\u4e3b\u5206\u533a\n\u5206\u533a\u53f7 (1-4, \u9ed8\u8ba4  1):\n\u7b2c\u4e00\u4e2a\u6247\u533a (2048-125829119, \u9ed8\u8ba4 2048):\n\u6700\u540e\u4e00\u4e2a\u6247\u533a\uff0c+/-sectors \u6216 +size{K,M,G,T,P} (2048-125829119, \u9ed8\u8ba4 125829119):\n\n\u521b\u5efa\u4e86\u4e00\u4e2a\u65b0\u5206\u533a 1\uff0c\u7c7b\u578b\u4e3a\u201cLinux\u201d\uff0c\u5927\u5c0f\u4e3a 60 GiB\u3002\n\n\u547d\u4ee4(\u8f93\u5165 m \u83b7\u53d6\u5e2e\u52a9)\uff1at # \u4fee\u6539\u7c7b\u578b\u4e3alvm\n\u5df2\u9009\u62e9\u5206\u533a 1\nHex \u4ee3\u7801(\u8f93\u5165 L \u5217\u51fa\u6240\u6709\u4ee3\u7801)\uff1a8e\n\u5df2\u5c06\u5206\u533a\u201cLinux\u201d\u7684\u7c7b\u578b\u66f4\u6539\u4e3a\u201cLinux LVM\u201d\u3002\n\n\u547d\u4ee4(\u8f93\u5165 m \u83b7\u53d6\u5e2e\u52a9)\uff1ap # \u6253\u5370\u5f53\u524d\u5206\u533a\u7ed3\u679c\nDisk /dev/nvme0n2\uff1a60 GiB\uff0c64424509440 \u5b57\u8282\uff0c125829120 \u4e2a\u6247\u533a\n\u78c1\u76d8\u578b\u53f7\uff1aVMware Virtual NVMe Disk\n\u5355\u5143\uff1a\u6247\u533a / 1 * 512 = 512 \u5b57\u8282\n\u6247\u533a\u5927\u5c0f(\u903b\u8f91/\u7269\u7406)\uff1a512 \u5b57\u8282 / 512 \u5b57\u8282\nI/O \u5927\u5c0f(\u6700\u5c0f/\u6700\u4f73)\uff1a512 \u5b57\u8282 / 512 \u5b57\u8282\n\u78c1\u76d8\u6807\u7b7e\u7c7b\u578b\uff1ados\n\u78c1\u76d8\u6807\u8bc6\u7b26\uff1a0x21366632\n\n\u8bbe\u5907           \u542f\u52a8  \u8d77\u70b9      \u672b\u5c3e      \u6247\u533a \u5927\u5c0f Id \u7c7b\u578b\n/dev/nvme0n2p1       2048 125829119 125827072  60G 8e Linux LVM\n\n\u547d\u4ee4(\u8f93\u5165 m \u83b7\u53d6\u5e2e\u52a9)\uff1aw  # \u4fdd\u5b58\u5e76\u9000\u51fa\u5206\u533a\u64cd\u4f5c\n\u5206\u533a\u8868\u5df2\u8c03\u6574\u3002\n\u5c06\u8c03\u7528 ioctl() \u6765\u91cd\u65b0\u8bfb\u5206\u533a\u8868\u3002\n\u6b63\u5728\u540c\u6b65\u78c1\u76d8\u3002\n\n\n\n$ partprobe # \u5237\u65b0\u78c1\u76d8\u5206\u533a\nNAME          MAJ:MIN RM SIZE RO TYPE MOUNTPOINT\nsr0            11:0    1   4G  0 rom\nnvme0n1       259:0    0  20G  0 disk\n\u251c\u2500nvme0n1p1   259:1    0  19G  0 part\n\u2502 \u2514\u2500klas-root 253:0    0  19G  0 lvm  /\n\u2514\u2500nvme0n1p2   259:2    0   1G  0 part /boot\nnvme0n2       259:3    0  60G  0 disk\n\u2514\u2500nvme0n2p1   259:5    0  60G  0 part   ## \u53ef\u4ee5\u770b\u5230\u8fd9\u91cc\u5df2\u7ecf\u51fa\u6765\u4e86\n\n$ mkdir -p /data # \u521b\u5efa\u76ee\u5f55\n\n$ mkfs.xfs /dev/nvme0n2p1 # \u683c\u5f0f\u5316\u78c1\u76d8\uff0c\u521b\u5efaxfs\u6587\u4ef6\u7cfb\u7edf\nmeta-data=/dev/nvme0n2p1         isize=512    agcount=4, agsize=3932096 blks\n         =                       sectsz=512   attr=2, projid32bit=1\n         =                       crc=1        finobt=1, sparse=1, rmapbt=0\n         =                       reflink=1\ndata     =                       bsize=4096   blocks=15728384, imaxpct=25\n         =                       sunit=0      swidth=0 blks\nnaming   =version 2              bsize=4096   ascii-ci=0, ftype=1\nlog      =internal log           bsize=4096   blocks=7679, version=2\n         =                       sectsz=512   sunit=0 blks, lazy-count=1\nrealtime =none                   extsz=4096   blocks=0, rtextents=0\n\n\n$ blkid # \u67e5\u770b\u524d\u9762\u78c1\u76d8\u7684UUID\n/dev/nvme0n1p1: UUID=\"LptD0I-mVs7-bwch-PVJW-aqES-NyFz-3zQ37g\" TYPE=\"LVM2_member\" PARTUUID=\"b6332df0-01\"\n/dev/nvme0n1p2: UUID=\"c77d7864-2d1c-4aea-a2b2-0e18559761bf\" BLOCK_SIZE=\"4096\" TYPE=\"ext4\" PARTUUID=\"b6332df0-02\"\n/dev/nvme0n2p1: UUID=\"b202bb87-a859-44d5-8e98-d716ae8437cc\" BLOCK_SIZE=\"512\" TYPE=\"xfs\" PARTUUID=\"21366632-01\"\n/dev/sr0: BLOCK_SIZE=\"2048\" UUID=\"2021-08-09-17-54-20-00\" LABEL=\"Kylin-Server-10\" TYPE=\"iso9660\"\n/dev/mapper/klas-root: UUID=\"c795f9fd-6f62-4589-a859-e85bca1ea56a\" BLOCK_SIZE=\"4096\" TYPE=\"ext4\"\n\n\n$ vim /etc/fstab # \u4f7f\u7528UUID \u6216\u76ee\u5f55\u7ed9\u6302\u8f7d\u914d\u7f6e\u5199\u5165\u7cfb\u7edf\u914d\u7f6e\nUUID=b202bb87-a859-44d5-8e98-d716ae8437cc /data xfs     defaults        0 0\n\n$ mount -a # \u5237\u65b0\u6302\u8f7d\n\n$ lsblk # \u67e5\u770b\u78c1\u76d8\nNAME          MAJ:MIN RM SIZE RO TYPE MOUNTPOINT\nsr0            11:0    1   4G  0 rom\nnvme0n1       259:0    0  20G  0 disk\n\u251c\u2500nvme0n1p1   259:1    0  19G  0 part\n\u2502 \u2514\u2500klas-root 253:0    0  19G  0 lvm  /\n\u2514\u2500nvme0n1p2   259:2    0   1G  0 part /boot\nnvme0n2       259:3    0  60G  0 disk\n\u2514\u2500nvme0n2p1   259:5    0  60G  0 part /data\n\n\n$ df -Th /data # \u786e\u8ba4\u6587\u4ef6\u7cfb\u7edf\n\u6587\u4ef6\u7cfb\u7edf       \u7c7b\u578b  \u5bb9\u91cf  \u5df2\u7528  \u53ef\u7528 \u5df2\u7528% \u6302\u8f7d\u70b9\n/dev/nvme0n2p1 xfs    60G  461M   60G    1% /data\n</code></pre>"},{"location":"linux/Kylin/#mbrlvm_1","title":"MBR\u5206\u533a\uff0c\u505aLVM","text":"<pre><code># \u67e5\u770b\u78c1\u76d8\nlsblk\nNAME          MAJ:MIN RM SIZE RO TYPE MOUNTPOINT\nsr0            11:0    1   4G  0 rom\nnvme0n1       259:0    0  20G  0 disk\n\u251c\u2500nvme0n1p1   259:1    0  19G  0 part\n\u2502 \u2514\u2500klas-root 253:0    0  19G  0 lvm  /\n\u2514\u2500nvme0n1p2   259:2    0   1G  0 part /boot\nnvme0n2       259:3    0  60G  0 disk\n\u2514\u2500nvme0n2p1   259:4    0  60G  0 part /data\nnvme0n3       259:5    0  10G  0 disk     ### \u6211\u8fd9\u91cc\u6709\u4e24\u5757\u76d8\uff0c\u8ba1\u5212\u7ed93\u53f7\u30014\u53f7\u76d8\u505aMBR\u5206\u533a+LVM\uff0c\u75284\u53f7\u76d8\u901a\u8fc7LVM\u6765\u7ed93\u53f7\u76d8\u6269\u5bb9\nnvme0n4       259:6    0  10G  0 disk\n\n# \u5148\u5206\u533a\n$ fdisk /dev/nvme0n3\n\n\u6b22\u8fce\u4f7f\u7528 fdisk (util-linux 2.35.2)\u3002\n\u66f4\u6539\u5c06\u505c\u7559\u5728\u5185\u5b58\u4e2d\uff0c\u76f4\u5230\u60a8\u51b3\u5b9a\u5c06\u66f4\u6539\u5199\u5165\u78c1\u76d8\u3002\n\u4f7f\u7528\u5199\u5165\u547d\u4ee4\u524d\u8bf7\u4e09\u601d\u3002\n\n\u8bbe\u5907\u4e0d\u5305\u542b\u53ef\u8bc6\u522b\u7684\u5206\u533a\u8868\u3002\n\u521b\u5efa\u4e86\u4e00\u4e2a\u78c1\u76d8\u6807\u8bc6\u7b26\u4e3a 0xffc4fa17 \u7684\u65b0 DOS \u78c1\u76d8\u6807\u7b7e\u3002\n\n\u547d\u4ee4(\u8f93\u5165 m \u83b7\u53d6\u5e2e\u52a9)\uff1an\n\u5206\u533a\u7c7b\u578b\n   p   \u4e3b\u5206\u533a (0 primary, 0 extended, 4 free)\n   e   \u6269\u5c55\u5206\u533a (\u903b\u8f91\u5206\u533a\u5bb9\u5668)\n\u9009\u62e9 (\u9ed8\u8ba4 p)\uff1a\n\n\u5c06\u4f7f\u7528\u9ed8\u8ba4\u56de\u5e94 p\u3002\n\u5206\u533a\u53f7 (1-4, \u9ed8\u8ba4  1):\n\u7b2c\u4e00\u4e2a\u6247\u533a (2048-20971519, \u9ed8\u8ba4 2048):\n\u6700\u540e\u4e00\u4e2a\u6247\u533a\uff0c+/-sectors \u6216 +size{K,M,G,T,P} (2048-20971519, \u9ed8\u8ba4 20971519):\n\n\u521b\u5efa\u4e86\u4e00\u4e2a\u65b0\u5206\u533a 1\uff0c\u7c7b\u578b\u4e3a\u201cLinux\u201d\uff0c\u5927\u5c0f\u4e3a 10 GiB\u3002\n\n\u547d\u4ee4(\u8f93\u5165 m \u83b7\u53d6\u5e2e\u52a9)\uff1at\n\u5df2\u9009\u62e9\u5206\u533a 1\nHex \u4ee3\u7801(\u8f93\u5165 L \u5217\u51fa\u6240\u6709\u4ee3\u7801)\uff1a8e\n\u5df2\u5c06\u5206\u533a\u201cLinux\u201d\u7684\u7c7b\u578b\u66f4\u6539\u4e3a\u201cLinux LVM\u201d\u3002\n\n\u547d\u4ee4(\u8f93\u5165 m \u83b7\u53d6\u5e2e\u52a9)\uff1aw\n\u5206\u533a\u8868\u5df2\u8c03\u6574\u3002\n\u5c06\u8c03\u7528 ioctl() \u6765\u91cd\u65b0\u8bfb\u5206\u533a\u8868\u3002\n\u6b63\u5728\u540c\u6b65\u78c1\u76d8\u3002\n\n$ partprobe\nWarning: \u65e0\u6cd5\u4ee5\u8bfb\u5199\u65b9\u5f0f\u6253\u5f00 /dev/sr0 (\u53ea\u8bfb\u6587\u4ef6\u7cfb\u7edf)\u3002/dev/sr0 \u5df2\u6309\u7167\u53ea\u8bfb\u65b9\u5f0f\u6253\u5f00\u3002\n\n$ fdisk /dev/nvme0n4\n\n\u6b22\u8fce\u4f7f\u7528 fdisk (util-linux 2.35.2)\u3002\n\u66f4\u6539\u5c06\u505c\u7559\u5728\u5185\u5b58\u4e2d\uff0c\u76f4\u5230\u60a8\u51b3\u5b9a\u5c06\u66f4\u6539\u5199\u5165\u78c1\u76d8\u3002\n\u4f7f\u7528\u5199\u5165\u547d\u4ee4\u524d\u8bf7\u4e09\u601d\u3002\n\n\u8bbe\u5907\u4e0d\u5305\u542b\u53ef\u8bc6\u522b\u7684\u5206\u533a\u8868\u3002\n\u521b\u5efa\u4e86\u4e00\u4e2a\u78c1\u76d8\u6807\u8bc6\u7b26\u4e3a 0x9789bc6a \u7684\u65b0 DOS \u78c1\u76d8\u6807\u7b7e\u3002\n\n\u547d\u4ee4(\u8f93\u5165 m \u83b7\u53d6\u5e2e\u52a9)\uff1an\n\u5206\u533a\u7c7b\u578b\n   p   \u4e3b\u5206\u533a (0 primary, 0 extended, 4 free)\n   e   \u6269\u5c55\u5206\u533a (\u903b\u8f91\u5206\u533a\u5bb9\u5668)\n\u9009\u62e9 (\u9ed8\u8ba4 p)\uff1a\n\n\u5c06\u4f7f\u7528\u9ed8\u8ba4\u56de\u5e94 p\u3002\n\u5206\u533a\u53f7 (1-4, \u9ed8\u8ba4  1):\n\u7b2c\u4e00\u4e2a\u6247\u533a (2048-20971519, \u9ed8\u8ba4 2048):\n\u6700\u540e\u4e00\u4e2a\u6247\u533a\uff0c+/-sectors \u6216 +size{K,M,G,T,P} (2048-20971519, \u9ed8\u8ba4 20971519):\n\n\u521b\u5efa\u4e86\u4e00\u4e2a\u65b0\u5206\u533a 1\uff0c\u7c7b\u578b\u4e3a\u201cLinux\u201d\uff0c\u5927\u5c0f\u4e3a 10 GiB\u3002\n\n\u547d\u4ee4(\u8f93\u5165 m \u83b7\u53d6\u5e2e\u52a9)\uff1at\n\u5df2\u9009\u62e9\u5206\u533a 1\nHex \u4ee3\u7801(\u8f93\u5165 L \u5217\u51fa\u6240\u6709\u4ee3\u7801)\uff1a8e\n\u5df2\u5c06\u5206\u533a\u201cLinux\u201d\u7684\u7c7b\u578b\u66f4\u6539\u4e3a\u201cLinux LVM\u201d\u3002\n\n\u547d\u4ee4(\u8f93\u5165 m \u83b7\u53d6\u5e2e\u52a9)\uff1aw\n\u5206\u533a\u8868\u5df2\u8c03\u6574\u3002\n\u5c06\u8c03\u7528 ioctl() \u6765\u91cd\u65b0\u8bfb\u5206\u533a\u8868\u3002\n\u6b63\u5728\u540c\u6b65\u78c1\u76d8\u3002\n\n$ partprobe\nWarning: \u65e0\u6cd5\u4ee5\u8bfb\u5199\u65b9\u5f0f\u6253\u5f00 /dev/sr0 (\u53ea\u8bfb\u6587\u4ef6\u7cfb\u7edf)\u3002/dev/sr0 \u5df2\u6309\u7167\u53ea\u8bfb\u65b9\u5f0f\u6253\u5f00\u3002\n\n$ lsblk\nNAME          MAJ:MIN RM SIZE RO TYPE MOUNTPOINT\nsr0            11:0    1   4G  0 rom\nnvme0n1       259:0    0  20G  0 disk\n\u251c\u2500nvme0n1p1   259:1    0  19G  0 part\n\u2502 \u2514\u2500klas-root 253:0    0  19G  0 lvm  /\n\u2514\u2500nvme0n1p2   259:2    0   1G  0 part /boot\nnvme0n2       259:3    0  60G  0 disk\n\u2514\u2500nvme0n2p1   259:4    0  60G  0 part /data\nnvme0n3       259:5    0  10G  0 disk\n\u2514\u2500nvme0n3p1   259:8    0  10G  0 part\nnvme0n4       259:6    0  10G  0 disk\n\u2514\u2500nvme0n4p1   259:9    0  10G  0 part\n\n\n# \u5f00\u59cb\u521b\u5efaLVM \u903b\u8f91\u76d8\n$ pvcreate /dev/nvme0n3p1  # \u62ff\u524d\u9762\u5212\u51fa\u6765\u7684\u78c1\u76d8\u6765\u521b\u5efaPV\n  Physical volume \"/dev/nvme0n3p1\" successfully created.\n\n$ vgcreate vg_01 /dev/nvme0n3p1  # \u62ffPV \u6765\u521b\u5efaVG \n  Volume group \"vg_01\" successfully created\n\n\n$ lvcreate -l 100%FREE -n lv_01 vg_01 # \u62ffVG \u6765\u521b\u5efaLV, \u5e76\u5c06\u6240\u6709VG \u7a7a\u95f4\u7ed9\u5230LV\n  Logical volume \"lv_01\" created.\n\n$ mkfs.xfs /dev/vg_01/lv_01 # LV \u78c1\u76d8\u683c\u5f0f\u5316, \u5e76\u521b\u5efaxfs \u6587\u4ef6\u7cfb\u7edf\nmeta-data=/dev/vg_01/lv_01       isize=512    agcount=4, agsize=655104 blks\n         =                       sectsz=512   attr=2, projid32bit=1\n         =                       crc=1        finobt=1, sparse=1, rmapbt=0\n         =                       reflink=1\ndata     =                       bsize=4096   blocks=2620416, imaxpct=25\n         =                       sunit=0      swidth=0 blks\nnaming   =version 2              bsize=4096   ascii-ci=0, ftype=1\nlog      =internal log           bsize=4096   blocks=2560, version=2\n         =                       sectsz=512   sunit=0 blks, lazy-count=1\nrealtime =none                   extsz=4096   blocks=0, rtextents=0\n\n\n\n$ mkdir -p /data1 # \u521b\u5efa\u6302\u8f7d\u70b9\n\n$ blkid | grep \"lv_01\"  # \u67e5\u770bUUID\n/dev/mapper/vg_01-lv_01: UUID=\"e22e54f3-66f6-465f-99f2-05dab496f7db\" BLOCK_SIZE=\"512\" TYPE=\"xfs\"\n\n$ vim /etc/fstab   # \u6302\u8f7d\u914d\u7f6e\u5199\u5165\u7cfb\u7edf\u914d\u7f6e\nUUID=e22e54f3-66f6-465f-99f2-05dab496f7db /data1 xfs     defaults        0 0\n\n$ mount -a # \u5237\u65b0\u6302\u8f7d\n\n$ df -Th /data1 # \u67e5\u770b\u6587\u4ef6\u7cfb\u7edf\n\u6587\u4ef6\u7cfb\u7edf                \u7c7b\u578b  \u5bb9\u91cf  \u5df2\u7528  \u53ef\u7528 \u5df2\u7528% \u6302\u8f7d\u70b9\n/dev/mapper/vg_01-lv_01 xfs    10G  104M  9.9G    2% /data1\n\n$ lsblk  # \u67e5\u770b\u78c1\u76d8\nNAME            MAJ:MIN RM SIZE RO TYPE MOUNTPOINT\nsr0              11:0    1   4G  0 rom\nnvme0n1         259:0    0  20G  0 disk\n\u251c\u2500nvme0n1p1     259:1    0  19G  0 part\n\u2502 \u2514\u2500klas-root   253:0    0  19G  0 lvm  /\n\u2514\u2500nvme0n1p2     259:2    0   1G  0 part /boot\nnvme0n2         259:3    0  60G  0 disk\n\u2514\u2500nvme0n2p1     259:4    0  60G  0 part /data\nnvme0n3         259:5    0  10G  0 disk\n\u2514\u2500nvme0n3p1     259:8    0  10G  0 part\n  \u2514\u2500vg_01-lv_01 253:1    0  10G  0 lvm  /data1\nnvme0n4         259:6    0  10G  0 disk\n\u2514\u2500nvme0n4p1     259:9    0  10G  0 part\n\n\n\n##### \u63a5\u4e0b\u6765\u5c31\u662f\u4f7f\u7528\u53e6\u5916\u4e00\u5757\u7a7a\u95f2\u78c1\u76d8\uff0c\u5373\u524d\u9762\u76844\u53f7\u76d8\uff0c\u6765\u6269\u5bb93\u53f7LVM\u76d8\uff0c\u8fd9\u91cc\u4e0d\u662f\u5fc5\u987b\uff0c\u53ea\u662f\u6f14\u793a\u4e0b\u5728\u6709\u8fd9\u65b9\u9762\u9700\u8981\u65f6\u5e94\u8be5\u5982\u4f55\u64cd\u4f5c\n\n##### \u8fd9\u91cc\u9700\u8981\u5f3a\u8c03\u4e00\u4e0b\uff0c\u5728\u78c1\u76d8\u6269\u5bb9\u4e4b\u524d\uff0c\u5982\u679c\u4e4b\u524d\u78c1\u76d8\u4e0a\u6709\u5341\u5206\u91cd\u8981\u7684\u6570\u636e\uff0c\u8bf7\u52a1\u5fc5\u5c3d\u53ef\u80fd\u5907\u4efd\u4e0b\uff0c\u5e76\u4e0d\u80fd\u4fdd\u8bc1100% \u5b8c\u5168\u6b63\u5e38\u6269\u5bb9\u3002\n##### \u867d\u7136\u56e0\u6269\u5bb9\u800c\u5bfc\u81f4\u6570\u636e\u4e22\u5931\u7684\u53ef\u80fd\u6027\u5fae\u4e4e\u5176\u5fae\uff0c\u4f46\u4ecd\u4e0d\u662f\u6ca1\u6709\u53ef\u80fd\uff0c\u8bf7\u52a1\u5fc5\u8c28\u614e\u64cd\u4f5c\u3002\n\n$ lsblk\nNAME            MAJ:MIN RM SIZE RO TYPE MOUNTPOINT\nsr0              11:0    1   4G  0 rom\nnvme0n1         259:0    0  20G  0 disk\n\u251c\u2500nvme0n1p1     259:1    0  19G  0 part\n\u2502 \u2514\u2500klas-root   253:0    0  19G  0 lvm  /\n\u2514\u2500nvme0n1p2     259:2    0   1G  0 part /boot\nnvme0n2         259:3    0  60G  0 disk\n\u2514\u2500nvme0n2p1     259:4    0  60G  0 part /data\nnvme0n3         259:5    0  10G  0 disk\n\u2514\u2500nvme0n3p1     259:8    0  10G  0 part\n  \u2514\u2500vg_01-lv_01 253:1    0  10G  0 lvm  /data1\nnvme0n4         259:6    0  10G  0 disk\n\u2514\u2500nvme0n4p1     259:9    0  10G  0 part   ## \u53ef\u4ee5\u770b\u5230\uff0c\u8fd9\u4e2a\u662f\u524d\u9762\u5df2\u7ecf\u5212\u597d\u7684\u78c1\u76d8\n\n\n$ pvcreate /dev/nvme0n4p1 # \u540c\u6837\u521b\u5efapv\n  Physical volume \"/dev/nvme0n4p1\" successfully created.\n\n$ vgextend vg_01 /dev/nvme0n4p1 # \u62ff\u4e0a\u9762\u7684PV \u7ed9\u524d\u9762\u7684VG \u6269\u5bb9\n  Volume group \"vg_01\" successfully extended\n\n$ lvextend -l +100%FREE /dev/vg_01/lv_01   # \u8ba9VG\u7684\u6240\u6709\u7a7a\u95f2\u7a7a\u95f4\u6765\u7ed9\u524d\u9762\u7684LV \u6269\u5bb9\n  Size of logical volume vg_01/lv_01 changed from &lt;10.00 GiB (2559 extents) to 19.99 GiB (5118 extents).\n  Logical volume vg_01/lv_01 successfully resized.\n\n\n$ xfs_growfs /dev/vg_01/lv_01  # \u5237\u65b0\u6587\u4ef6\u7cfb\u7edf\nmeta-data=/dev/mapper/vg_01-lv_01 isize=512    agcount=4, agsize=655104 blks\n         =                       sectsz=512   attr=2, projid32bit=1\n         =                       crc=1        finobt=1, sparse=1, rmapbt=0\n         =                       reflink=1\ndata     =                       bsize=4096   blocks=2620416, imaxpct=25\n         =                       sunit=0      swidth=0 blks\nnaming   =version 2              bsize=4096   ascii-ci=0, ftype=1\nlog      =internal log           bsize=4096   blocks=2560, version=2\n         =                       sectsz=512   sunit=0 blks, lazy-count=1\nrealtime =none                   extsz=4096   blocks=0, rtextents=0\ndata blocks changed from 2620416 to 5240832\n\n$ df -Th /data1    # \u67e5\u770b\u6587\u4ef6\u7cfb\u7edf\uff0c\u53ef\u4ee5\u770b\u5230\u5df2\u7ecf\u6269\u5bb9\u6210\u529f\n\u6587\u4ef6\u7cfb\u7edf                \u7c7b\u578b  \u5bb9\u91cf  \u5df2\u7528  \u53ef\u7528 \u5df2\u7528% \u6302\u8f7d\u70b9\n/dev/mapper/vg_01-lv_01 xfs    20G  176M   20G    1% /data1\n\n$ lsblk  # \u67e5\u770b\u78c1\u76d8\nNAME            MAJ:MIN RM SIZE RO TYPE MOUNTPOINT\nsr0              11:0    1   4G  0 rom\nnvme0n1         259:0    0  20G  0 disk\n\u251c\u2500nvme0n1p1     259:1    0  19G  0 part\n\u2502 \u2514\u2500klas-root   253:0    0  19G  0 lvm  /\n\u2514\u2500nvme0n1p2     259:2    0   1G  0 part /boot\nnvme0n2         259:3    0  60G  0 disk\n\u2514\u2500nvme0n2p1     259:4    0  60G  0 part /data\nnvme0n3         259:5    0  10G  0 disk\n\u2514\u2500nvme0n3p1     259:8    0  10G  0 part\n  \u2514\u2500vg_01-lv_01 253:1    0  20G  0 lvm  /data1\nnvme0n4         259:6    0  10G  0 disk\n\u2514\u2500nvme0n4p1     259:9    0  10G  0 part\n  \u2514\u2500vg_01-lv_01 253:1    0  20G  0 lvm  /data1  # \u53ef\u4ee5\u770b\u5230\u90fd\u6302\u5728\u4e00\u4e2a/data1 \u76ee\u5f55\u4e0b\n</code></pre>"},{"location":"linux/Kylin/#gpt","title":"GPT\u5206\u533a","text":"<pre><code>$ lsblk   # \u67e5\u770b\u78c1\u76d8\nNAME            MAJ:MIN RM SIZE RO TYPE MOUNTPOINT\nsr0              11:0    1   4G  0 rom\nnvme0n1         259:0    0  20G  0 disk\n\u251c\u2500nvme0n1p1     259:1    0  19G  0 part\n\u2502 \u2514\u2500klas-root   253:0    0  19G  0 lvm  /\n\u2514\u2500nvme0n1p2     259:2    0   1G  0 part /boot\nnvme0n2         259:3    0  60G  0 disk\n\u2514\u2500nvme0n2p1     259:4    0  60G  0 part /data\nnvme0n3         259:5    0  10G  0 disk\n\u2514\u2500nvme0n3p1     259:8    0  10G  0 part\n  \u2514\u2500vg_01-lv_01 253:1    0  20G  0 lvm  /data1\nnvme0n4         259:6    0  10G  0 disk\n\u2514\u2500nvme0n4p1     259:9    0  10G  0 part\n  \u2514\u2500vg_01-lv_01 253:1    0  20G  0 lvm  /data1\nnvme0n5         259:7    0  20G  0 disk     ## \u62ff\u8fd9\u4e2a\u76d8\u505aGPT \u5206\u533a\n\n$ parted /dev/nvme0n5  # \u6307\u5b9a\u78c1\u76d8\u5206\u533a\nGNU Parted 3.3\n\u4f7f\u7528 /dev/nvme0n5\n\u6b22\u8fce\u4f7f\u7528 GNU Parted\uff01\u8f93\u5165 'help' \u6765\u67e5\u770b\u547d\u4ee4\u5217\u8868\u3002\n(parted) mklabel gpt  # \u5f00\u59cbGPT\u5206\u533a\n\u8b66\u544a: \u73b0\u6709 /dev/nvme0n5 \u4e0a\u7684\u78c1\u76d8\u5377\u6807\u5c06\u88ab\u9500\u6bc1\uff0c\u800c\u6240\u6709\u5728\u8fd9\u4e2a\u78c1\u76d8\u4e0a\u7684\u6570\u636e\u5c06\u4f1a\u4e22\u5931\u3002\u60a8\u8981\u7ee7\u7eed\u5417\uff1f\n\u662f/Yes/\u5426/No? yes  ## \u53ef\u80fd\u4f1a\u51fa\u73b0\u8fd9\u4e2a\uff0c\u82e5\u51fa\u73b0\u5c31\u8f93\u5165yes\n(parted) mkpart gpt-01 xfs 0% 100%   # \u7ed9\u5f53\u524d\u78c1\u76d8\u6240\u6709\u7a7a\u95f4\u5212\u7ed9\u4e00\u4e2a\u76d8\u7b26\n(parted) quit  # \u64cd\u4f5c\u5b8c\u6210\uff0c\u9000\u51fa\n\u4fe1\u606f: \u4f60\u53ef\u80fd\u9700\u8981 /etc/fstab\u3002\n\n$ partprobe  # \u5237\u65b0\u78c1\u76d8\nWarning: \u65e0\u6cd5\u4ee5\u8bfb\u5199\u65b9\u5f0f\u6253\u5f00 /dev/sr0 (\u53ea\u8bfb\u6587\u4ef6\u7cfb\u7edf)\u3002/dev/sr0 \u5df2\u6309\u7167\u53ea\u8bfb\u65b9\u5f0f\u6253\u5f00\u3002\n\n$ lsblk  # \u67e5\u770b\u78c1\u76d8\nNAME            MAJ:MIN RM SIZE RO TYPE MOUNTPOINT\nsr0              11:0    1   4G  0 rom\nnvme0n1         259:0    0  20G  0 disk\n\u251c\u2500nvme0n1p1     259:1    0  19G  0 part\n\u2502 \u2514\u2500klas-root   253:0    0  19G  0 lvm  /\n\u2514\u2500nvme0n1p2     259:2    0   1G  0 part /boot\nnvme0n2         259:3    0  60G  0 disk\n\u2514\u2500nvme0n2p1     259:4    0  60G  0 part /data\nnvme0n3         259:5    0  10G  0 disk\n\u2514\u2500nvme0n3p1     259:8    0  10G  0 part\n  \u2514\u2500vg_01-lv_01 253:1    0  20G  0 lvm  /data1\nnvme0n4         259:6    0  10G  0 disk\n\u2514\u2500nvme0n4p1     259:9    0  10G  0 part\n  \u2514\u2500vg_01-lv_01 253:1    0  20G  0 lvm  /data1\nnvme0n5         259:7    0  20G  0 disk\n\u2514\u2500nvme0n5p1     259:10   0  20G  0 part   # \u5df2\u7ecf\u51fa\u6765\u4e86\n\n\n$ mkdir -p /data2  # \u521b\u5efa\u76ee\u5f55\n\n$ mkfs.xfs /dev/nvme0n5p1  # \u683c\u5f0f\u5316\u78c1\u76d8\uff0c\u505axfs \u6587\u4ef6\u7cfb\u7edf\nmeta-data=/dev/nvme0n5p1         isize=512    agcount=4, agsize=1310592 blks\n         =                       sectsz=512   attr=2, projid32bit=1\n         =                       crc=1        finobt=1, sparse=1, rmapbt=0\n         =                       reflink=1\ndata     =                       bsize=4096   blocks=5242368, imaxpct=25\n         =                       sunit=0      swidth=0 blks\nnaming   =version 2              bsize=4096   ascii-ci=0, ftype=1\nlog      =internal log           bsize=4096   blocks=2560, version=2\n         =                       sectsz=512   sunit=0 blks, lazy-count=1\nrealtime =none                   extsz=4096   blocks=0, rtextents=0\n\n$ blkid | grep gpt  # \u67e5\u770bUUID\n/dev/nvme0n5p1: UUID=\"60d4c6f0-7fc3-4b88-b72c-65e79fe6fbfe\" BLOCK_SIZE=\"512\" TYPE=\"xfs\" PARTLABEL=\"gpt-01\" PARTUUID=\"766c0d85-f3e7-43cc-9949-eb677942a9c8\"\n\n$ vim /etc/fstab  # \u6302\u8f7d\u914d\u7f6e\u5199\u5165\u7cfb\u7edf\nUUID=60d4c6f0-7fc3-4b88-b72c-65e79fe6fbfe /data2 xfs     defaults       0 0\n\n$ mount -a  # \u5237\u65b0\u6302\u8f7d\n\n$ df -Th /data2  # \u786e\u8ba4\u6587\u4ef6\u7cfb\u7edf\n\u6587\u4ef6\u7cfb\u7edf       \u7c7b\u578b  \u5bb9\u91cf  \u5df2\u7528  \u53ef\u7528 \u5df2\u7528% \u6302\u8f7d\u70b9\n/dev/nvme0n5p1 xfs    20G  176M   20G    1% /data2\n\n$ lsblk  # \u67e5\u770b\u78c1\u76d8\nNAME            MAJ:MIN RM SIZE RO TYPE MOUNTPOINT\nsr0              11:0    1   4G  0 rom\nnvme0n1         259:0    0  20G  0 disk\n\u251c\u2500nvme0n1p1     259:1    0  19G  0 part\n\u2502 \u2514\u2500klas-root   253:0    0  19G  0 lvm  /\n\u2514\u2500nvme0n1p2     259:2    0   1G  0 part /boot\nnvme0n2         259:3    0  60G  0 disk\n\u2514\u2500nvme0n2p1     259:4    0  60G  0 part /data\nnvme0n3         259:5    0  10G  0 disk\n\u2514\u2500nvme0n3p1     259:8    0  10G  0 part\n  \u2514\u2500vg_01-lv_01 253:1    0  20G  0 lvm  /data1\nnvme0n4         259:6    0  10G  0 disk\n\u2514\u2500nvme0n4p1     259:9    0  10G  0 part\n  \u2514\u2500vg_01-lv_01 253:1    0  20G  0 lvm  /data1\nnvme0n5         259:7    0  20G  0 disk\n\u2514\u2500nvme0n5p1     259:10   0  20G  0 part /data2\n</code></pre>"},{"location":"linux/Kylin/#_6","title":"\u6e05\u7406\u5bb6\u76ee\u5f55","text":"<pre><code># \u8fd9\u91cc\u662f\u4e0d\u7528\u56fe\u5f62\u754c\u9762\u7684\u60c5\u51b5\uff0c\u5982\u679c\u6709\u9700\u8981\u7528\u5230\u56fe\u5f62\u754c\u9762\uff0c\u8fd9\u91cc\u8bf7\u5ffd\u7565\n$ ll\n\u603b\u7528\u91cf 40\ndrwxr-xr-x 2 root root 4096  5\u6708 30 13:12 \u516c\u5171\ndrwxr-xr-x 2 root root 4096  5\u6708 30 13:12 \u6a21\u677f\ndrwxr-xr-x 2 root root 4096  5\u6708 30 13:12 \u89c6\u9891\ndrwxr-xr-x 2 root root 4096  5\u6708 30 13:12 \u56fe\u7247\ndrwxr-xr-x 2 root root 4096  5\u6708 30 13:12 \u6587\u6863\ndrwxr-xr-x 2 root root 4096  5\u6708 30 13:12 \u4e0b\u8f7d\ndrwxr-xr-x 2 root root 4096  5\u6708 30 13:12 \u97f3\u4e50\ndrwxr-xr-x 2 root root 4096  5\u6708 30 13:12 \u684c\u9762\n-rw------- 1 root root 2823  5\u6708 30 13:11 anaconda-ks.cfg\n-rw-r--r-- 1 root root 3159  5\u6708 30 13:11 initial-setup-ks.cfg\n$ rm * -rf\n</code></pre>"},{"location":"linux/Kylin/#cpu","title":"\u786e\u8ba4CPU\u67b6\u6784","text":"<pre><code>[root@KylinSp3 ~]# lscpu | grep Architecture\nArchitecture:                    aarch64\n</code></pre>"},{"location":"linux/Kylin/#_7","title":"\u786e\u8ba4\u7cfb\u7edf\u7248\u672c","text":"<pre><code>[root@KylinSp3 ~]# cat /etc/.productinfo \nKylin Linux Advanced Server\nrelease V10 (SP3) /(Lance)-aarch64-Build23/20230324\n</code></pre>"},{"location":"linux/Kylin/#_8","title":"\u670d\u52a1\u5668\u521d\u59cb\u5316","text":"<pre><code># \u4fee\u6539root \u5bc6\u7801\n[root@KylinSp3 ~]# sudo passwd root\n# \u5207\u6362\u5230root\n[root@KylinSp3 ~]# su -\n# \u4fee\u6539root \u53ef\u4ee5\u76f4\u63a5\u767b\u9646\n[root@KylinSp3 ~]# sed -i 's/^#PermitRootLogin prohibit-password/PermitRootLogin yes/' /etc/ssh/sshd_config\n\n\n\n# \u4e0d\u770b\u5230\u9690\u85cf\u6587\u4ef6,\u4e0d\u8981\u52a0*\uff0c/\uff0c@\u7b49\u7b26\u53f7\n[root@KylinSp3 ~]# sed -ri \"s/alias ll='ls -alF'/alias ll='ls -l'/\" ~/.bashrc\n[root@KylinSp3 ~]# egrep \"alias ll\" ~/.bashrc\n[root@KylinSp3 ~]# source ~/.bashrc\n\n\n# \u5173\u95ed\u9632\u706b\u5899\uff0cselinux \n[root@KylinSp3 ~]# getenforce \nDisabled\n[root@KylinSp3 ~]# systemctl status firewalld.service\n\u25cf firewalld.service - firewalld - dynamic firewall daemon\n   Loaded: loaded (/usr/lib/systemd/system/firewalld.service; disabled; vendor preset: enabled)\n   Active: inactive (dead)\n     Docs: man:firewalld(1)\n\n\n\n# \u5b89\u88c5\u5e38\u7528\u5de5\u5177\uff0c\u591a\u6267\u884c\u51e0\u6b21\n[root@KylinSp3 ~]# yum install conntrack socat tree   net-tools genisoimage ntpdate jq sshpass -y \n[root@KylinSp3 ~]# yum install ansible  -y \n[root@KylinSp3 ~]# yum install python3-pip udev  python3 -y \n\n\n# \u914d\u7f6e\u9759\u6001IP\n[root@KylinSp3 ~]# ll /etc/sysconfig/network-scripts/ifcfg-enp4s0 \n-rw-r--r-- 1 root root 248 Nov 21 16:38 /etc/sysconfig/network-scripts/ifcfg-enp4s0\n[root@KylinSp3 ~]# vim /etc/sysconfig/network-scripts/ifcfg-enp4s0\n[root@KylinSp3 ~]# cat /etc/sysconfig/network-scripts/ifcfg-enp4s0\nTYPE=Ethernet\nPROXY_METHOD=none\nBROWSER_ONLY=no\nBOOTPROTO=none\nDEFROUTE=yes\nIPV4_FAILURE_FATAL=no\nIPV6INIT=no\nNAME=enp4s0\nUUID=1498733a-76a9-4a14-9565-0cd1f3bdb2c0\nDEVICE=enp4s0\nONBOOT=yes\nIPADDR=10.0.5.86\nPREFIX=24\nGATEWAY=10.0.5.1\nDNS1=223.5.5.5\n\n\n# \u4fee\u6539\u65f6\u533a\uff0c\u540c\u6b65\u65f6\u95f4\n[root@KylinSp3 ~]# timedatectl set-timezone Asia/Shanghai\n[root@KylinSp3 ~]# ntpdate -u ntp.aliyun.com\n22 Nov 10:54:10 ntpdate[8640]: adjust time server 203.107.6.88 offset +0.009250 sec\n[root@KylinSp3 ~]# echo \"*/5 * * * * /usr/sbin/ntpdate -u ntp.aliyun.com &gt;&gt; /var/log/ntpdate.log 2&gt;&amp;1\" | sudo tee /etc/cron.d/ntpdate-sync\n*/5 * * * * /usr/sbin/ntpdate -u ntp.aliyun.com &gt;&gt; /var/log/ntpdate.log 2&gt;&amp;1\n\n\n################################ \u91cd\u542f\u673a\u5668\nsync;reboot\n</code></pre>"},{"location":"linux/Kylin/#java","title":"Java\u73af\u5883","text":"<pre><code># \u4e0b\u8f7d\u5730\u5740\uff1a\n# https://www.oracle.com/java/technologies/javase/javase8u211-later-archive-downloads.html\n\n# \u4e0a\u4f20\u6587\u4ef6\u5230/root\n\n# \u89e3\u538b\u91ca\u653e\n[root@KylinSp3 ~]# tar xf jdk-8u381-linux-aarch64.tar.gz -C /opt/\n[root@KylinSp3 ~]# ll /opt/jdk1.8.0_381/\ntotal 20704\ndrwxr-xr-x 2 10143 10143     4096 Jun 14 22:09 bin\n-r--r--r-- 1 10143 10143     3244 Jun 14 22:09 COPYRIGHT\ndrwxr-xr-x 3 10143 10143      132 Jun 14 22:09 include\ndrwxr-xr-x 5 10143 10143      142 Jun 14 22:09 jre\ndrwxr-xr-x 3 10143 10143       17 Jun 14 22:09 legal\ndrwxr-xr-x 3 10143 10143      146 Jun 14 22:09 lib\n-r--r--r-- 1 10143 10143       44 Jun 14 22:09 LICENSE\ndrwxr-xr-x 4 10143 10143       47 Jun 14 22:09 man\n-r--r--r-- 1 10143 10143      159 Jun 14 22:09 README.html\n-rw-r--r-- 1 10143 10143      185 Jun 14 22:09 release\n-rw-r--r-- 1 10143 10143 21175606 Jun 14 22:09 src.zip\n-r--r--r-- 1 10143 10143      190 Jun 14 22:09 THIRDPARTYLICENSEREADME.txt\n\n# \u914d\u7f6e\u73af\u5883\u53d8\u91cf\n[root@KylinSp3 ~]# echo -e \"export JAVA_HOME=/opt/jdk1.8.0_381\" &gt;&gt; /etc/profile \n[root@KylinSp3 ~]# echo -e \"export PATH=\\$PATH:\\$JAVA_HOME/bin\" &gt;&gt; /etc/profile \n[root@KylinSp3 ~]# echo -e \"export CLASSPATH=.:\\$JAVA_HOME/lib/dt.jar:\\$JAVA_HOME/lib/tools.jar\" &gt;&gt; /etc/profile \n[root@KylinSp3 ~]# echo -e \"export JRE_HOME=\\$JAVA_HOME/jre\" &gt;&gt; /etc/profile \n# \u786e\u8ba4\u914d\u7f6e\n[root@KylinSp3 ~]# tail -4 /etc/profile\nexport JAVA_HOME=/opt/jdk1.8.0_381\nexport PATH=$PATH:$JAVA_HOME/bin\nexport CLASSPATH=.:$JAVA_HOME/lib/dt.jar:$JAVA_HOME/lib/tools.jar\nexport JRE_HOME=$JAVA_HOME/jre\n[root@KylinSp3 ~]# source  /etc/profile\n\n\n\n# \u67e5\u770b\u7248\u672c\n[root@KylinSp3 ~]# java -version \njava version \"1.8.0_381\"\nJava(TM) SE Runtime Environment (build 1.8.0_381-b09)\nJava HotSpot(TM) 64-Bit Server VM (build 25.381-b09, mixed mode)\n</code></pre>"},{"location":"linux/Kylin/#docker","title":"Docker\u73af\u5883","text":"<pre><code># \u5b98\u65b9\u6587\u6863\u5730\u5740\uff1a\n# https://docs.docker.com/engine/install/binaries/\n\n# \u4e0b\u8f7d\u5730\u5740\uff1a\n# https://download.docker.com/linux/static/stable/aarch64/\n\n# \u4e0a\u4f20\u6587\u4ef6\u5230/root/\n\n# \u89e3\u538b\u5b89\u88c5\u5305\n[root@KylinSp3 ~]# tar xzvf docker-24.0.7.tgz \ndocker/\ndocker/docker-init\ndocker/containerd-shim-runc-v2\ndocker/ctr\ndocker/docker-proxy\ndocker/dockerd\n[root@KylinSp3 ~]# ll docker\ntotal 173520\n-rwxr-xr-x 1 1000 1000 37289984 Oct 26 17:10 containerd\n-rwxr-xr-x 1 1000 1000 11862016 Oct 26 17:10 containerd-shim-runc-v2\n-rwxr-xr-x 1 1000 1000 18219008 Oct 26 17:10 ctr\n-rwxr-xr-x 1 1000 1000 33393056 Oct 26 17:10 docker\n-rwxr-xr-x 1 1000 1000 59979448 Oct 26 17:10 dockerd\n-rwxr-xr-x 1 1000 1000   535800 Oct 26 17:10 docker-init\n-rwxr-xr-x 1 1000 1000  2046447 Oct 26 17:10 docker-proxy\n-rwxr-xr-x 1 1000 1000 14350160 Oct 26 17:10 runc\n\n# \u5c06\u4e8c\u8fdb\u5236\u6587\u4ef6\u653e\u5230PATH \u76ee\u5f55\u4e0b\n[root@KylinSp3 ~]# echo $PATH\n/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/root/bin:/root/bin\n[root@KylinSp3 ~]# \\cp -rvf docker/* /usr/bin/\n'docker/containerd' -&gt; '/usr/bin/containerd'\n'docker/containerd-shim-runc-v2' -&gt; '/usr/bin/containerd-shim-runc-v2'\n'docker/ctr' -&gt; '/usr/bin/ctr'\n'docker/docker' -&gt; '/usr/bin/docker'\n'docker/dockerd' -&gt; '/usr/bin/dockerd'\n'docker/docker-init' -&gt; '/usr/bin/docker-init'\n'docker/docker-proxy' -&gt; '/usr/bin/docker-proxy'\n'docker/runc' -&gt; '/usr/bin/runc'\n\n# \u68c0\u67e5\u5404\u4e2a\u5173\u952e\u7ec4\u4ef6\u7684\u7248\u672c\n[root@KylinSp3 ~]# docker version \nClient:\n Version:           24.0.7\n API version:       1.43\n Go version:        go1.20.10\n Git commit:        afdd53b\n Built:             Thu Oct 26 09:06:50 2023\n OS/Arch:           linux/arm64\n Context:           default\nCannot connect to the Docker daemon at unix:///var/run/docker.sock. Is the docker daemon running?              \n[root@KylinSp3 ~]# runc --version \nrunc version 1.1.9\ncommit: v1.1.9-0-gccaecfc\nspec: 1.0.2-dev\ngo: go1.20.10\nlibseccomp: 2.5.1\n[root@KylinSp3 ~]# containerd --version \ncontainerd github.com/containerd/containerd v1.7.6 091922f03c2762540fd057fba91260237ff86acb\n\n\n########################################################################### \u4e8c\u8fdb\u5236\u5b89\u88c5compose\n\n# \u4e0b\u8f7d\u5730\u5740\uff1a\n# https://github.com/docker/compose/releases/tag/v2.23.0\n\n# \u4e0a\u4f20\u6587\u4ef6\u5230/root\n\n# \u5b89\u88c5compose\n[root@KylinSp3 ~]# \\cp -rvf docker-compose-linux-aarch64  /usr/bin/docker-compose \n'docker-compose-linux-aarch64' -&gt; '/usr/bin/docker-compose'\n[root@KylinSp3 ~]# chmod +x /usr/bin/docker-compose\n\n# \u67e5\u770b\u7248\u672c\n[root@KylinSp3 ~]# docker-compose version \nDocker Compose version v2.23.0\n\n\n########################################################################### \u6dfb\u52a0\u7528\u6237\n# \u5b98\u65b9\u6587\u6863\u5730\u5740\uff1a\n# https://docs.docker.com/engine/install/linux-postinstall/\n\n# docker \u76f8\u5173\u7528\u6237\u7ba1\u7406\n[root@KylinSp3 ~]# groupadd docker\n[root@KylinSp3 ~]# usermod -aG docker $USER\n[root@KylinSp3 ~]# newgrp docker\n\n\n########################################################################### \u6dfb\u52a0Containerd\u670d\u52a1\u7ba1\u7406\u914d\u7f6e\n# \u53c2\u8003\u914d\u7f6e\u5730\u5740\n# https://github.com/moby/moby/tree/master/contrib/init/systemd\n\n# \u6dfb\u52a0Containerd \u914d\u7f6e\u6587\u4ef6\ncat &lt;&lt;-EOF | tee  /usr/lib/systemd/system/containerd.service\n# Copyright The containerd Authors.\n#\n# Licensed under the Apache License, Version 2.0 (the \"License\");\n# you may not use this file except in compliance with the License.\n# You may obtain a copy of the License at\n#\n#     http://www.apache.org/licenses/LICENSE-2.0\n#\n# Unless required by applicable law or agreed to in writing, software\n# distributed under the License is distributed on an \"AS IS\" BASIS,\n# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n# See the License for the specific language governing permissions and\n# limitations under the License.\n\n[Unit]\nDescription=containerd container runtime\nDocumentation=https://containerd.io\nAfter=network.target local-fs.target\n\n[Service]\nExecStartPre=-/sbin/modprobe overlay\nExecStart=/usr/bin/containerd\n\nType=notify\nDelegate=yes\nKillMode=process\nRestart=always\nRestartSec=5\n# Having non-zero Limit*s causes performance problems due to accounting overhead\n# in the kernel. We recommend using cgroups to do container-local accounting.\nLimitNPROC=infinity\nLimitCORE=infinity\nLimitNOFILE=1048576\n# Comment TasksMax if your systemd version does not supports it.\n# Only systemd 226 and above support this version.\nTasksMax=infinity\nOOMScoreAdjust=-999\n\n[Install]\nWantedBy=multi-user.target\nEOF\n\n# \u670d\u52a1\u7ba1\u7406\n[root@KylinSp3 ~]# systemctl daemon-reload \n[root@KylinSp3 ~]# systemctl status containerd \n\u25cf containerd.service - containerd container runtime\n   Loaded: loaded (/usr/lib/systemd/system/containerd.service; disabled; vendor preset: disabled)\n   Active: inactive (dead)\n     Docs: https://containerd.io\n[root@KylinSp3 ~]# systemctl start  containerd \n[root@KylinSp3 ~]# systemctl enable  containerd \nCreated symlink /etc/systemd/system/multi-user.target.wants/containerd.service \u2192 /usr/lib/systemd/system/containerd.service.\n[root@KylinSp3 ~]# systemctl status containerd \n\u25cf containerd.service - containerd container runtime\n   Loaded: loaded (/usr/lib/systemd/system/containerd.service; enabled; vendor preset: disabled)\n   Active: active (running) since Wed 2023-11-22 15:22:31 CST; 11s ago\n     Docs: https://containerd.io\n Main PID: 10810 (containerd)\n    Tasks: 10\n   Memory: 13.0M\n   CGroup: /system.slice/containerd.service\n           \u2514\u250010810 /usr/bin/containerd\n\nNov 22 15:22:31 KylinSp3.example.com containerd[10810]: time=\"2023-11-22T15:22:31.463095454+08:00\" level=info msg=serving... address=/run/containerd/containerd.sock.ttrpc\nNov 22 15:22:31 KylinSp3.example.com containerd[10810]: time=\"2023-11-22T15:22:31.463153194+08:00\" level=info msg=serving... address=/run/containerd/containerd.sock\nNov 22 15:22:31 KylinSp3.example.com containerd[10810]: time=\"2023-11-22T15:22:31.463158344+08:00\" level=info msg=\"Start subscribing containerd event\"\nNov 22 15:22:31 KylinSp3.example.com containerd[10810]: time=\"2023-11-22T15:22:31.463275716+08:00\" level=info msg=\"Start recovering state\"\nNov 22 15:22:31 KylinSp3.example.com containerd[10810]: time=\"2023-11-22T15:22:31.463359777+08:00\" level=info msg=\"Start event monitor\"\nNov 22 15:22:31 KylinSp3.example.com containerd[10810]: time=\"2023-11-22T15:22:31.463382887+08:00\" level=info msg=\"Start snapshots syncer\"\nNov 22 15:22:31 KylinSp3.example.com containerd[10810]: time=\"2023-11-22T15:22:31.463395867+08:00\" level=info msg=\"Start cni network conf syncer for default\"\nNov 22 15:22:31 KylinSp3.example.com containerd[10810]: time=\"2023-11-22T15:22:31.463407527+08:00\" level=info msg=\"Start streaming server\"\nNov 22 15:22:31 KylinSp3.example.com containerd[10810]: time=\"2023-11-22T15:22:31.463468128+08:00\" level=info msg=\"containerd successfully booted in 0.038387s\"\nNov 22 15:22:31 KylinSp3.example.com systemd[1]: Started containerd container runtime.\n\n\n########################################################################### \u6dfb\u52a0Docker\u670d\u52a1\u7ba1\u7406\u914d\u7f6e\n# \u53c2\u8003\u914d\u7f6e\u5730\u5740\n# https://github.com/moby/moby/tree/master/contrib/init/systemd\n\n\n# \u4e0b\u8f7d\u5730\u5740\uff1a\n# https://github.com/moby/moby/blob/master/contrib/init/systemd/docker.socket\n\n\n# \u4e0a\u4f20\u6587\u4ef6\u5230/root\n\ncat &lt;&lt;-EOF | tee /usr/lib/systemd/system/docker.service\n[Unit]\nDescription=Docker Application Container Engine\nDocumentation=https://docs.docker.com\nAfter=network-online.target docker.socket firewalld.service containerd.service time-set.target\nWants=network-online.target containerd.service\nRequires=docker.socket\n\n[Service]\nType=notify\n# the default is not to use systemd for cgroups because the delegate issues still\n# exists and systemd currently does not support the cgroup feature set required\n# for containers run by docker\nExecStart=/usr/bin/dockerd -H fd:// --containerd=/run/containerd/containerd.sock\nExecReload=/bin/kill -s HUP $MAINPID\nTimeoutStartSec=0\nRestartSec=2\nRestart=always\n\n# Note that StartLimit* options were moved from \"Service\" to \"Unit\" in systemd 229.\n# Both the old, and new location are accepted by systemd 229 and up, so using the old location\n# to make them work for either version of systemd.\nStartLimitBurst=3\n\n# Note that StartLimitInterval was renamed to StartLimitIntervalSec in systemd 230.\n# Both the old, and new name are accepted by systemd 230 and up, so using the old name to make\n# this option work for either version of systemd.\nStartLimitInterval=60s\n\n# Having non-zero Limit*s causes performance problems due to accounting overhead\n# in the kernel. We recommend using cgroups to do container-local accounting.\nLimitNPROC=infinity\nLimitCORE=infinity\n\n# Comment TasksMax if your systemd version does not support it.\n# Only systemd 226 and above support this option.\nTasksMax=infinity\n\n# set delegate yes so that systemd does not reset the cgroups of docker containers\nDelegate=yes\n\n# kill only the docker process, not all processes in the cgroup\nKillMode=process\nOOMScoreAdjust=-500\n\n[Install]\nWantedBy=multi-user.target\nEOF\n\n[root@KylinSp3 ~]# systemctl daemon-reload \n\n# \u6dfb\u52a0docker \u6838\u5fc3\u914d\u7f6e\n[root@KylinSp3 ~]# mkdir -p /etc/docker/ /data/docker\n\n\ncat &lt;&lt;-EOF | tee /etc/docker/daemon.json \n{\n  \"registry-mirrors\": [\"https://ustc-edu-cn.mirror.aliyuncs.com\"],\n  \"debug\": false,\n  \"insecure-registries\": [\n    \"0.0.0.0/0\"\n  ],\n  \"ip-forward\": true,\n  \"ipv6\": false,\n  \"live-restore\": true,\n  \"log-driver\": \"json-file\",\n  \"log-level\": \"warn\",\n  \"log-opts\": {\n    \"max-size\": \"100m\",\n    \"max-file\": \"2\"\n  },\n  \"selinux-enabled\": false,\n  \"experimental\" : true,\n  \"storage-driver\": \"overlay2\",\n  \"metrics-addr\" : \"0.0.0.0:9323\",\n  \"data-root\": \"/data/docker\",\n  \"default-ulimits\": {\n    \"nofile\": {\n      \"Name\": \"nofile\",\n      \"Hard\": 65536,\n      \"Soft\": 65536\n    }\n  },\n  \"exec-opts\": [\"native.cgroupdriver=systemd\"]\n}\nEOF\n\n# Docker\u670d\u52a1\u7ba1\u7406\n[root@KylinSp3 ~]# \\cp -rvf  docker.socket /usr/lib/systemd/system/\n'docker.socket' -&gt; '/usr/lib/systemd/system/docker.socket'\n[root@KylinSp3 ~]# systemctl start docker \nWarning: The unit file, source configuration file or drop-ins of docker.service changed on disk. Run 'systemctl daemon-reload' to reload units.\n[root@KylinSp3 ~]# systemctl daemon-reload \n[root@KylinSp3 ~]# systemctl status  docker \n\u25cf docker.service - Docker Application Container Engine\n   Loaded: loaded (/usr/lib/systemd/system/docker.service; disabled; vendor preset: disabled)\n   Active: active (running) since Wed 2023-11-22 15:36:43 CST; 12s ago\n     Docs: https://docs.docker.com\n Main PID: 11251 (dockerd)\n    Tasks: 12\n   Memory: 29.1M\n   CGroup: /system.slice/docker.service\n           \u2514\u250011251 /usr/bin/dockerd -H fd:// --containerd=/run/containerd/containerd.sock\n\nNov 22 15:36:43 KylinSp3.example.com systemd[1]: Starting Docker Application Container Engine...\nNov 22 15:36:43 KylinSp3.example.com dockerd[11251]: time=\"2023-11-22T15:36:43.043012735+08:00\" level=warning msg=\"Running experimental build\"\nNov 22 15:36:43 KylinSp3.example.com systemd[1]: Started Docker Application Container Engine.\n[root@KylinSp3 ~]# systemctl enable  docker \nCreated symlink /etc/systemd/system/multi-user.target.wants/docker.service \u2192 /usr/lib/systemd/system/docker.service.\n\n# \u67e5\u770bDocker \u6570\u636e\u76ee\u5f55\n[root@KylinSp3 ~]# ll /data/docker/\ntotal 44\ndrwx--x--x 4 root root 4096 Nov 22 15:36 buildkit\ndrwx--x--- 2 root root 4096 Nov 22 15:36 containers\n-rw------- 1 root root   36 Nov 22 15:36 engine-id\ndrwx------ 3 root root 4096 Nov 22 15:36 image\ndrwxr-x--- 3 root root 4096 Nov 22 15:36 network\ndrwx--x--- 3 root root 4096 Nov 22 15:36 overlay2\ndrwx------ 4 root root 4096 Nov 22 15:36 plugins\ndrwx------ 2 root root 4096 Nov 22 15:36 runtimes\ndrwx------ 2 root root 4096 Nov 22 15:36 swarm\ndrwx------ 2 root root 4096 Nov 22 15:36 tmp\ndrwx-----x 2 root root 4096 Nov 22 15:36 volumes\n</code></pre>"},{"location":"linux/NFS/","title":"NFS","text":""},{"location":"linux/NFS/#_1","title":"\u90e8\u7f72","text":"<pre><code>#### \u670d\u52a1\u7aef\n\n# 1.\u5b89\u88c5nfs\uff08\u670d\u52a1\u7aef\u4e0e\u5ba2\u6237\u7aef\u7b49\u540c\uff09\uff08\u6240\u6709\u8282\u70b9\uff09\nyum install -y nfs-utils\n\n# 2.\u6267\u884c\u547d\u4ee4 vi /etc/exports\uff0c\u521b\u5efa exports \u6587\u4ef6\n# \u6587\u4ef6\u5185\u5bb9\u5982\u4e0b\uff1a\necho \"/data/nfs-share *(insecure,rw,sync,no_root_squash)\" &gt; /etc/exports\n# \u67e5\u770b\u914d\u7f6e\ncat /etc/exports \n\n# 3.\u6267\u884c\u4ee5\u4e0b\u547d\u4ee4\uff0c\u542f\u52a8 nfs \u670d\u52a1\n# \u521b\u5efa\u5171\u4eab\u76ee\u5f55\nmkdir -p /data/nfs-share\n\n# \u670d\u52a1\u81ea\u542f\nsystemctl enable rpcbind\nsystemctl enable nfs-server\nsystemctl start rpcbind\nsystemctl start nfs-server\n\n# nfs\u91cd\u65b0\u6302\u8f7d\nexportfs -r\n\n# \u68c0\u67e5\u914d\u7f6e\u662f\u5426\u751f\u6548\nexportfs\n\n\n# \u6548\u679c\u5982\u4e0b\u6240\u793a\u5373\u4e3aOK\n/data/nfs-share\n                                    &lt;world&gt;\n\n\n### \u5ba2\u6237\u7aef\nshowmount -e  192.168.1.1 \nmkdir  /data/share-file   # \u8fd9\u4e2a\u76ee\u5f55\u4e3b\u8981\u662f\u53bb \u5171\u4eab\u670d\u52a1\u7aef\u5206\u4eab\u7684\u90a3\u4e2a\u76ee\u5f55\uff0c\u540c\u6b65\u90a3\u4e2a\u6587\u4ef6\nmount -t nfs 192.168.1.1:/data/nfs-share /data/share-file   #\u8fd9\u4e2a\u662f\u6302\u8f7d\n</code></pre>"},{"location":"linux/NFS/#_2","title":"\u6302\u8f7d\u65f6\u9047\u5230\u4e0d\u652f\u6301","text":"<p><code>mount.nfs: Protocol not supported</code> <pre><code>systemctl restart rpcbind.service # \u91cd\u542f\u670d\u52a1\nyum reinstall  nfs-utils  # \u91cd\u88c5\u5ba2\u6237\u7aef\n</code></pre></p>"},{"location":"linux/Optimize-kernel/","title":"Optimize kernel","text":""},{"location":"linux/Optimize-kernel/#1","title":"1 \u5e38\u7528\u914d\u7f6e","text":"<pre><code>fs.file-max= 6815744\nfs.aio-max-nr= 1048576\nvm.drop_caches = 3\nvm.max_map_count = 262144\nkernel.sysrq = 0\nkernel.dmesg_restrict = 1\nkernel.shmall= 2097152\nkernel.shmmax= 4294967295\nkernel.shmmni= 4096\nkernel.sem= 250 32000 100 128\nnet.ipv4.ip_forward = 1\nnet.ipv4.conf.all.send_redirects = 0\nnet.ipv4.conf.default.send_redirects = 0\nnet.ipv4.conf.all.accept_source_route = 0\nnet.ipv4.conf.default.accept_source_route = 0\nnet.ipv4.conf.all.accept_redirects = 0\nnet.ipv4.conf.default.accept_redirects = 0\nnet.ipv4.conf.all.secure_redirects = 0\nnet.ipv4.conf.default.secure_redirects = 0\nnet.ipv4.icmp_echo_ignore_broadcasts = 1\nnet.ipv4.icmp_ignore_bogus_error_responses = 1\nnet.ipv4.conf.all.rp_filter = 1\nnet.ipv4.conf.default.rp_filter = 1\nnet.ipv4.tcp_syncookies = 1\nnet.ipv4.ip_local_port_range= 9000 65500\nnet.ipv6.conf.all.accept_redirects = 0\nnet.ipv6.conf.default.accept_redirects = 0\nnet.core.rmem_default= 262144\nnet.core.rmem_max= 4194304\nnet.core.wmem_default= 262144\nnet.core.wmem_max= 1048576\nnet.bridge.bridge-nf-call-ip6tables = 1\nnet.bridge.bridge-nf-call-arptables = 1\n</code></pre> <p>\u8fd9\u4e9b\u5185\u6838\u914d\u7f6e\u9879\u7684\u542b\u4e49\u5982\u4e0b\uff1a</p> <ul> <li><code>fs.file-max</code>: \u8bbe\u7f6e\u7cfb\u7edf\u7ea7\u522b\u7684\u6587\u4ef6\u63cf\u8ff0\u7b26\u9650\u5236\uff0c\u8868\u793a\u7cfb\u7edf\u652f\u6301\u7684\u6700\u5927\u6587\u4ef6\u63cf\u8ff0\u7b26\u6570\u91cf\u3002</li> <li><code>fs.aio-max-nr</code>: \u8bbe\u7f6e\u7cfb\u7edf\u7ea7\u522b\u7684\u5f02\u6b65 I/O\uff08AIO\uff09\u64cd\u4f5c\u7684\u6700\u5927\u6570\u91cf\u3002</li> <li><code>vm.drop_caches</code>: \u7528\u4e8e\u63a7\u5236\u5185\u6838\u662f\u5426\u4e22\u5f03\u7f13\u5b58\u7684\u9009\u9879\u3002\u8be5\u503c\u4e3a3\u8868\u793a\u4e22\u5f03\u9875\u7f13\u5b58\u548c\u76ee\u5f55\u9879\u7f13\u5b58\uff0c\u4f46\u4e0d\u4e22\u5f03\u7d22\u5f15\u8282\u70b9\u7f13\u5b58\u3002</li> <li><code>vm.max_map_count</code>: \u8bbe\u7f6e\u8fdb\u7a0b\u53ef\u62e5\u6709\u7684\u6700\u5927\u5185\u5b58\u6620\u5c04\u533a\u57df\u6570\u91cf\u3002</li> <li><code>kernel.sysrq</code>: \u7528\u4e8e\u63a7\u5236\u7cfb\u7edf\u7684 SysRq \u529f\u80fd\uff0c0\u8868\u793a\u7981\u7528\u3002</li> <li><code>kernel.dmesg_restrict</code>: \u63a7\u5236\u662f\u5426\u9650\u5236\u975e\u7279\u6743\u7528\u6237\u5bf9\u5185\u6838\u65e5\u5fd7\u7684\u8bbf\u95ee\u6743\u9650\uff0c1\u8868\u793a\u9650\u5236\u3002</li> <li><code>kernel.shmall</code>: \u6307\u5b9a\u7cfb\u7edf\u8303\u56f4\u5185\u5171\u4eab\u5185\u5b58\u6bb5\u7684\u6700\u5927\u9875\u6846\u6570\u3002</li> <li><code>kernel.shmmax</code>: \u6307\u5b9a\u7cfb\u7edf\u8303\u56f4\u5185\u5355\u4e2a\u5171\u4eab\u5185\u5b58\u6bb5\u7684\u6700\u5927\u5927\u5c0f\u3002</li> <li><code>kernel.shmmni</code>: \u6307\u5b9a\u7cfb\u7edf\u652f\u6301\u7684\u6700\u5927\u5171\u4eab\u5185\u5b58\u6bb5\u6570\u91cf\u3002</li> <li><code>kernel.sem</code>: \u8bbe\u7f6e\u7cfb\u7edf\u4e2d\u7684\u4fe1\u53f7\u91cf\u53c2\u6570\u3002</li> <li><code>net.ipv4.ip_forward</code>: \u542f\u7528 IPv4 \u6570\u636e\u5305\u8f6c\u53d1\u529f\u80fd\u3002</li> <li><code>net.ipv4.conf.all.send_redirects</code> \u548c <code>net.ipv4.conf.default.send_redirects</code>: \u63a7\u5236\u662f\u5426\u53d1\u9001 ICMP \u91cd\u5b9a\u5411\u62a5\u6587\u3002</li> <li><code>net.ipv4.conf.all.accept_source_route</code> \u548c <code>net.ipv4.conf.default.accept_source_route</code>: \u63a7\u5236\u662f\u5426\u63a5\u53d7\u6e90\u8def\u7531\u9009\u9879\u3002</li> <li><code>net.ipv4.conf.all.accept_redirects</code> \u548c <code>net.ipv4.conf.default.accept_redirects</code>: \u63a7\u5236\u662f\u5426\u63a5\u53d7 ICMP \u91cd\u5b9a\u5411\u62a5\u6587\u3002</li> <li><code>net.ipv4.conf.all.secure_redirects</code> \u548c <code>net.ipv4.conf.default.secure_redirects</code>: \u63a7\u5236\u662f\u5426\u53ea\u63a5\u53d7\u5b89\u5168\u7684 ICMP \u91cd\u5b9a\u5411\u62a5\u6587\u3002</li> <li><code>net.ipv4.icmp_echo_ignore_broadcasts</code>: \u63a7\u5236\u662f\u5426\u5ffd\u7565\u5bf9\u5e7f\u64ad\u5730\u5740\u7684 ICMP \u56de\u663e\u8bf7\u6c42\u3002</li> <li><code>net.ipv4.icmp_ignore_bogus_error_responses</code>: \u63a7\u5236\u662f\u5426\u5ffd\u7565\u65e0\u6548\u7684 ICMP \u9519\u8bef\u54cd\u5e94\u3002</li> <li><code>net.ipv4.conf.all.rp_filter</code> \u548c <code>net.ipv4.conf.default.rp_filter</code>: \u63a7\u5236\u662f\u5426\u542f\u7528\u53cd\u5411\u8def\u5f84\u8fc7\u6ee4\u3002</li> <li><code>net.ipv4.tcp_syncookies</code>: \u542f\u7528 TCP Syn Cookie \u673a\u5236\u6765\u62b5\u5fa1 SYN Flood \u653b\u51fb\u3002</li> <li><code>net.ipv4.ip_local_port_range</code>: \u8bbe\u7f6e\u672c\u5730\u7aef\u53e3\u7684\u8d77\u59cb\u548c\u7ed3\u675f\u8303\u56f4\u3002</li> <li><code>net.ipv6.conf.all.accept_redirects</code> \u548c <code>net.ipv6.conf.default.accept_redirects</code>: \u63a7\u5236\u662f\u5426\u63a5\u53d7 IPv6 \u7684 ICMP \u91cd\u5b9a\u5411\u62a5\u6587\u3002</li> <li><code>net.core.rmem_default</code> \u548c <code>net.core.rmem_max</code>: \u63a7\u5236\u63a5\u6536\u7f13\u51b2\u533a\u7684\u9ed8\u8ba4\u5927\u5c0f\u548c\u6700\u5927\u5927\u5c0f\u3002</li> <li><code>net.core.wmem_default</code> \u548c <code>net.core.wmem_max</code>: \u63a7\u5236\u53d1\u9001\u7f13\u51b2\u533a\u7684\u9ed8\u8ba4\u5927\u5c0f\u548c\u6700\u5927\u5927\u5c0f\u3002</li> <li><code>net.bridge.bridge-nf-call-ip6tables</code> \u548c <code>net.bridge.bridge-nf-call-arptables</code>: \u63a7\u5236\u662f\u5426\u5728\u7f51\u7edc\u6865\u63a5\u65f6\u8c03</li> </ul> <p>\u7528 IPv6 \u548c ARP \u7684 iptables \u89c4\u5219\u3002</p> <p>\u8fd9\u4e9b\u914d\u7f6e\u9879\u7528\u4e8e\u8c03\u6574\u7cfb\u7edf\u7684\u7f51\u7edc\u3001\u5185\u5b58\u7ba1\u7406\u548c\u5b89\u5168\u7b56\u7565\u7b49\u65b9\u9762\u7684\u884c\u4e3a\u3002\u5177\u4f53\u7684\u914d\u7f6e\u503c\u53ef\u4ee5\u6839\u636e\u5b9e\u9645\u9700\u6c42\u8fdb\u884c\u8c03\u6574\uff0c\u4f46\u5728\u4fee\u6539\u8fd9\u4e9b\u914d\u7f6e\u9879\u4e4b\u524d\uff0c\u5efa\u8bae\u5148\u4e86\u89e3\u5176\u542b\u4e49\u548c\u5f71\u54cd\uff0c\u5e76\u5728\u8fdb\u884c\u4fee\u6539\u65f6\u8c28\u614e\u64cd\u4f5c\u3002</p>"},{"location":"linux/RPM/","title":"RPM","text":""},{"location":"linux/RPM/#_1","title":"\u5305\u514d\u7b7e\u540d\u5b89\u88c5","text":"<pre><code>rpm -ivh xxx.rpm --nodigest --nofiledigest\n</code></pre>"},{"location":"linux/RPM/#_2","title":"\u67e5\u770b\u4f9d\u8d56\u5173\u7cfb","text":"<pre><code>[root@mid yum]# rpm  -qR nmap-ncat\n/bin/sh\n/bin/sh\nlibc.so.6()(64bit)\nlibc.so.6(GLIBC_2.11)(64bit)\nlibc.so.6(GLIBC_2.14)(64bit)\nlibc.so.6(GLIBC_2.15)(64bit)\nlibc.so.6(GLIBC_2.2.5)(64bit)\nlibc.so.6(GLIBC_2.3)(64bit)\nlibc.so.6(GLIBC_2.3.2)(64bit)\nlibc.so.6(GLIBC_2.3.4)(64bit)\nlibc.so.6(GLIBC_2.4)(64bit)\nlibc.so.6(GLIBC_2.7)(64bit)\nlibc.so.6(GLIBC_2.8)(64bit)\nlibcrypto.so.10()(64bit)\nlibcrypto.so.10(libcrypto.so.10)(64bit)\nlibdl.so.2()(64bit)\nlibdl.so.2(GLIBC_2.2.5)(64bit)\nlibm.so.6()(64bit)\nlibm.so.6(GLIBC_2.2.5)(64bit)\nlibpcap.so.1()(64bit)\nlibssl.so.10()(64bit)\nlibssl.so.10(libssl.so.10)(64bit)\nrpmlib(CompressedFileNames) &lt;= 3.0.4-1\nrpmlib(FileDigests) &lt;= 4.6.0-1\nrpmlib(PayloadFilesHavePrefix) &lt;= 4.0-1\nrtld(GNU_HASH)\nrpmlib(PayloadIsXz) &lt;= 5.2-1\n</code></pre>"},{"location":"linux/RPM/#_3","title":"\u5305\u5378\u8f7d","text":"<pre><code># \u67e5\u5305\nrpm -qa | grep -i \u670d\u52a1\u540d\n# \u5378\u8f7d\u5305\nrpm -e \u670d\u52a1\u540d\u5bf9\u5e94\u7684\u5305\u540d --nodeps\nrpm -e --nodeps java-1.6.0-openjdk-1.6.0.0-1.66.1.13.0.el6.i686\n</code></pre>"},{"location":"linux/RPM/#_4","title":"\u5305\u5236\u4f5c","text":"<pre><code># \u63cf\u8ff0\u9636\u6bb5\n\n[root@localhost ~]# rpm -qpi grafana-8.0.6-1.x86_64.rpm\nwarning: grafana-8.0.6-1.x86_64.rpm: Header V4 RSA/SHA256 Signature, key ID 24098cb6: NOKEY\nName        : grafana\nVersion     : 8.0.6  # \u4e0d\u80fd\u4f7f\u7528\u6a2a\u7ebf\nRelease     : 1      # \u7b2c\u51e0\u6b21\u5236\u4f5c\uff0c\u53d1\u884c\u53f7\nArchitecture: x86_64 \nInstall Date: (not installed)\nGroup       : default  # \u5bf9\u5e94\u5f53\u524drpm\u5236\u4f5c\u6240\u5728\u7684\u7cfb\u7edf\u7684\u6240\u62e5\u6709\u7684\u7ec4\u540d\nSize        : 182016648\nLicense     : \"Apache 2.0\"\nSignature   : RSA/SHA256, Thu 15 Jul 2021 06:57:12 PM CST, Key ID 8c8c34c524098cb6\nSource RPM  : grafana-8.0.6-1.src.rpm\nBuild Date  : Thu 15 Jul 2021 06:56:44 PM CST\nBuild Host  : 789e9d678c8c\nRelocations : /\nPackager    : contact@grafana.com  # \u5236\u4f5c\u8005&lt;\u5236\u4f5c\u8005\u90ae\u4ef6\u5730\u5740&gt;\nVendor      : Grafana              # \u5236\u4f5c\u8005\u6240\u5c5e\u516c\u53f8\u6216\u63d0\u4f9b\u5546\nURL         : https://grafana.com    # \u4e0b\u8f7d\u94fe\u63a5\nSummary     : Grafana\nDescription :\nGrafana\n\n# rpm \u7ec4\n\n[root@localhost ~]# cat /usr/share/doc/rpm-4.11.3/GROUPS\nAmusements/Games\nAmusements/Graphics\nApplications/Archiving\nApplications/Communications\nApplications/Databases\nApplications/Editors\nApplications/Emulators\nApplications/Engineering\nApplications/File\nApplications/Internet\nApplications/Multimedia\nApplications/Productivity\nApplications/Publishing\nApplications/System\nApplications/Text\nDevelopment/Debuggers\nDevelopment/Languages\nDevelopment/Libraries\nDevelopment/System\nDevelopment/Tools\nDocumentation\nSystem Environment/Base\nSystem Environment/Daemons\nSystem Environment/Kernel\nSystem Environment/Libraries\nSystem Environment/Shells\nUser Interface/Desktops\nUser Interface/X\nUser Interface/X Hardware Support\n\n# rpm tmp\u76ee\u5f55\n\n[root@localhost ~]# rpmbuild --showrc|grep _tmppath\n-14: _tmppath   %{_var}/tmp\n\n# \u51c6\u5907\u9636\u6bb5\n\n%prep # \u58f0\u660e\u51c6\u5907\u9636\u6bb5\n%setup # \u5b8f\u52a8\u4f5c\uff0c\u89e3\u538b\u91ca\u653e\uff0c\u51c6\u5907\u73af\u5883\u7b49\n\n# \u7f16\u8bd1\u9636\u6bb5\n\n%build\n./configure \\\n    --etcdir=\"%{_sysconfir}\"\\   # %{\u53d8\u91cf}  \u4e0d\u533a\u5206\u5927\u5c0f\u5199\n  --mandir=\"%{_mandir}\"\\\n  ...\n%{_make} %{?_smp_mflags} # \u5224\u65ad\u540e\u518dmake\n\n# \u5b89\u88c5\u9636\u6bb5\n\n%install\n%{_rm} -rf %{buildroot}\n%{_make} install DESTEDIR=\"%{buildroot}\"\n%find_lang  %{name}\n\n# \u811a\u672c\u9636\u6bb5\n\n%pre  #\u5b89\u88c5\u524d\n%post #\u5b89\u88c5\u540e\n%preun  # \u5378\u8f7d\u524d\n%postun # \u5378\u8f7d\u540e\n\n# \u6e05\u7406\u9636\u6bb5\n\n%clean\n%{_rm} -rf %{buildroot}\n\n# \u6587\u4ef6\u9636\u6bb5\n\n%file\n\n# \u65e5\u5fd7\u9636\u6bb5\n\nrpm \u6784\u5efa\u53c2\u6570\n\n-ba  \u751f\u6210rpm/tar.gz\n-bb  \u751f\u6210rpm\n-bc  \u6784\u5efa\u81f3%build\n-bp  \u6784\u5efa\u81f3%pre\n-bi  \u6784\u5efa\u81f3%install\n-bl  \u68c0\u67e5%file \u9636\u6bb5\u7684\u6587\u4ef6\u4e0e%{buildroot} \u76ee\u5f55\u4e2d\u6587\u4ef6\u7684\u4e00\u4e00\u5bf9\u5e94\u5173\u7cfb,\u6b63\u5e38\u5e94\u5b8c\u5168\u5bf9\u5e94\n-bs  \u751f\u6210src.rpm\n</code></pre>"},{"location":"linux/RPM/#rpm","title":"\u4ece\u6e90\u7801\u5236\u4f5crpm","text":"<p>https://www.cnblogs.com/michael-xiang/p/10480809.html https://blog.csdn.net/u012373815/article/details/73257754</p> <pre><code>yum -y install rpm-build rpm-devel rpmdevtools\n\n\nuseradd rpmuser\nsu - rpmuser\n# rpmdev-setuptree\nmkdir ~/rpmbuild\ncd ~/rpmbuild\nmkdir -pv {BUILD,BUILDROOT,RPMS,SOURCES,SPECS,SRPMS}\n\n\n[rpmuser@localhost rpmbuild]$ tree\n.\n\u251c\u2500\u2500 BUILD\n\u251c\u2500\u2500 RPMS\n\u251c\u2500\u2500 SOURCES\n\u251c\u2500\u2500 SPECS\n\u2514\u2500\u2500 SRPMS\n\n5 directories, 0 files\n[rpmuser@localhost rpmbuild]$\n\ncp ~/grafana-8.1.0.tar.gz /home/rpmuser/rpmbuild/SOURCES\ncd /home/rpmuser/rpmbuild/SPECS\nrpmdev-newspec -o grafana.spec\nrpmbuild -bb /home/rpmuser/rpmbuild/SPECS/grafana.spec\n\nrpmbuild  \n-ba \u65e2\u751f\u6210src.rpm\u53c8\u751f\u6210\u4e8c\u8fdb\u5236rpm \n-bs \u53ea\u751f\u6210src\u7684rpm \n-bb \u53ea\u751f\u4e8c\u8fdb\u5236\u7684rpm \n-bp \u6267\u884c\u5230pre \n-bc \u6267\u884c\u5230 build\u6bb5 \n-bi \u6267\u884cinstall\u6bb5 \n-bl \u68c0\u6d4b\u6709\u6587\u4ef6\u6ca1\u5305\u542b \n</code></pre>"},{"location":"linux/RPM/#_5","title":"\u5ffd\u7565\u4f9d\u8d56\u5b89\u88c5","text":"<pre><code># \u8fd9\u4e2a\u547d\u4ee4\u53ef\u4ee5\u4f7frpm \u5b89\u88c5\u65f6\u4e0d\u68c0\u67e5\u4f9d\u8d56\u5173\u7cfb\nrpm -i software-2.3.4.rpm --nodeps\n\n# \u8fd9\u4e2a\u547d\u4ee4\u53ef\u4ee5\u5f3a\u5236\u5b89\u88c5rpm\u5305\nrpm -ivh software-2.3.4.rpm --force\n\nrpm  -ivh --nodeps  --force\n</code></pre>"},{"location":"linux/RPM/#_6","title":"\u5305\u4e0b\u8f7d\u7f51\u7ad9","text":"<ul> <li>http://rpmfind.net</li> <li>https://pkgs.org/download/rpm</li> </ul>"},{"location":"linux/RPM/#_7","title":"\u67e5\u770b\u5df2\u5b89\u88c5\u5b8c\u6210\u7684\u5305","text":"<pre><code>rpm -qa | grep jdk\n</code></pre>"},{"location":"linux/RPM/#_8","title":"\u5347\u7ea7\u7248\u672c","text":"<pre><code>#\u5347\u7ea7\nrpm -Uvh grafana-6.4.0-1.x86_64.rpm \n</code></pre>"},{"location":"linux/Redhat-offline-package/","title":"Redhat offline package","text":"<p>\u5728\u65e0\u6cd5\u8054\u7f51\u7684\u73af\u5883\u4e2d\u5b89\u88c5\u8f6f\u4ef6\u901a\u5e38\u9700\u8981\u4e8b\u5148\u4e0b\u8f7d\u6240\u6709\u5fc5\u8981\u7684\u5b89\u88c5\u5305\u4ee5\u53ca\u5b83\u4eec\u7684\u4f9d\u8d56\u5e76\u4f20\u8f93\u5230\u76ee\u6807\u673a\u5668\u4e0a\u3002\u4ee5\u4e0b\u6b65\u9aa4\u5c06\u6307\u5bfc\u60a8\u5982\u4f55\u4e3a CentOS 7.9 \u521b\u5efa\u4e00\u4e2a\u79bb\u7ebf\u8f6f\u4ef6\u5b89\u88c5\u5305\u3002</p>"},{"location":"linux/Redhat-offline-package/#_1","title":"\u51c6\u5907\u5de5\u4f5c","text":"<p>\u5728\u5f00\u59cb\u4e4b\u524d\uff0c\u8bf7\u786e\u4fdd\u60a8\u6709\u4e00\u53f0\u53ef\u4ee5\u8054\u7f51\u7684 CentOS 7.9 \u7cfb\u7edf\uff0c\u7528\u4e8e\u4e0b\u8f7d\u8f6f\u4ef6\u53ca\u5176\u4f9d\u8d56\u3002</p>"},{"location":"linux/Redhat-offline-package/#1","title":"1. \u4e0b\u8f7d\u8f6f\u4ef6\u53ca\u5176\u4f9d\u8d56","text":"<p>\u60a8\u53ef\u4ee5\u4f7f\u7528 <code>yum</code> \u7684 <code>--downloadonly</code> \u548c <code>--downloaddir</code> \u9009\u9879\u6765\u4e0b\u8f7d\u8f6f\u4ef6\u5305\u548c\u5b83\u4eec\u7684\u6240\u6709\u4f9d\u8d56\u3002</p> <p>\u4f8b\u5982\uff0c\u5982\u679c\u60a8\u60f3\u4e0b\u8f7d <code>httpd</code>\uff08Apache Web \u670d\u52a1\u5668\uff09\u53ca\u5176\u6240\u6709\u4f9d\u8d56\uff0c\u53ef\u4ee5\u6267\u884c\u4ee5\u4e0b\u547d\u4ee4\uff1a</p> <pre><code>yum install --downloadonly --downloaddir=/path/to/download/directory httpd\n</code></pre> <p>\u5c06 <code>/path/to/download/directory</code> \u66ff\u6362\u4e3a\u60a8\u60f3\u8981\u4fdd\u5b58\u4e0b\u8f7d\u6587\u4ef6\u7684\u76ee\u5f55\u8def\u5f84\u3002</p>"},{"location":"linux/Redhat-offline-package/#2","title":"2. \u521b\u5efa\u672c\u5730\u4ed3\u5e93","text":"<p>\u4e0b\u8f7d\u6240\u6709\u5305\u540e\uff0c\u60a8\u9700\u8981\u5728\u4e0b\u8f7d\u76ee\u5f55\u4e2d\u521b\u5efa\u4e00\u4e2a\u672c\u5730\u4ed3\u5e93\uff0c\u8fd9\u6837\u5728\u79bb\u7ebf\u5b89\u88c5\u65f6 <code>yum</code> \u80fd\u591f\u8bc6\u522b\u5e76\u6b63\u786e\u5904\u7406\u4f9d\u8d56\u5173\u7cfb\u3002</p> <pre><code>cd /path/to/download/directory\ncreaterepo .\n</code></pre> <p>\u5982\u679c <code>createrepo</code> \u547d\u4ee4\u4e0d\u53ef\u7528\uff0c\u60a8\u9700\u8981\u5148\u5728\u7ebf\u5b89\u88c5 <code>createrepo</code> \u5305\uff1a</p> <pre><code>yum install createrepo\n</code></pre> <p>\u5e76\u5728\u540c\u6837\u7684\u8054\u7f51\u73af\u5883\u4e2d\u8fd0\u884c <code>createrepo</code> \u547d\u4ee4\u3002</p>"},{"location":"linux/Redhat-offline-package/#3","title":"3. \u6253\u5305\u4e0b\u8f7d\u76ee\u5f55","text":"<p>\u5c06\u5e26\u6709\u8f6f\u4ef6\u5305\u548c\u672c\u5730\u4ed3\u5e93\u5143\u6570\u636e\u7684\u4e0b\u8f7d\u76ee\u5f55\u6253\u5305\uff0c\u4ee5\u4fbf\u4e8e\u4f20\u8f93\u3002</p> <pre><code>tar -czvf offline-packages.tar.gz -C /path/to/download/directory .\n</code></pre>"},{"location":"linux/Redhat-offline-package/#4","title":"4. \u4f20\u8f93\u5230\u79bb\u7ebf\u673a\u5668","text":"<p>\u4f7f\u7528 USB \u9a71\u52a8\u5668\u3001\u5149\u76d8\u6216\u5176\u4ed6\u5a92\u4f53\u5c06 <code>offline-packages.tar.gz</code> \u6587\u4ef6\u4f20\u8f93\u5230\u79bb\u7ebf CentOS 7.9 \u673a\u5668\u4e0a\u3002</p>"},{"location":"linux/Redhat-offline-package/#5","title":"5. \u79bb\u7ebf\u5b89\u88c5\u8f6f\u4ef6","text":"<p>\u5728\u79bb\u7ebf\u673a\u5668\u4e0a\uff0c\u6267\u884c\u4ee5\u4e0b\u6b65\u9aa4\u6765\u5b89\u88c5\u8f6f\u4ef6\uff1a</p>"},{"location":"linux/Redhat-offline-package/#_2","title":"\u89e3\u538b\u8f6f\u4ef6\u5305","text":"<pre><code>tar -xzvf /path/to/offline-packages.tar.gz -C /path/to/local/repo\n</code></pre>"},{"location":"linux/Redhat-offline-package/#_3","title":"\u914d\u7f6e\u672c\u5730\u4ed3\u5e93","text":"<p>\u521b\u5efa\u4e00\u4e2a\u65b0\u7684 YUM \u4ed3\u5e93\u914d\u7f6e\u6587\u4ef6\uff1a</p> <pre><code>vi /etc/yum.repos.d/local.repo\n</code></pre> <p>\u6dfb\u52a0\u4ee5\u4e0b\u5185\u5bb9\uff1a</p> <pre><code>[local-repo]\nname=Local Repository\nbaseurl=file:///path/to/local/repo\nenabled=1\ngpgcheck=0\n</code></pre> <p>\u786e\u4fdd\u66ff\u6362 <code>/path/to/local/repo</code> \u4e3a\u60a8\u89e3\u538b\u7f29\u8f6f\u4ef6\u5305\u7684\u5b9e\u9645\u76ee\u5f55\u3002</p>"},{"location":"linux/Redhat-offline-package/#_4","title":"\u5b89\u88c5\u8f6f\u4ef6","text":"<p>\u73b0\u5728\u60a8\u53ef\u4ee5\u4f7f\u7528 <code>yum</code> \u4ece\u672c\u5730\u4ed3\u5e93\u5b89\u88c5\u8f6f\u4ef6\uff0c<code>yum</code> \u4f1a\u81ea\u52a8\u5904\u7406\u6240\u6709\u4f9d\u8d56\u5173\u7cfb\u3002</p> <pre><code>yum install --disablerepo='*' --enablerepo='local-repo' httpd\n</code></pre> <p>\u7528\u60a8\u5b9e\u9645\u4e0b\u8f7d\u7684\u8f6f\u4ef6\u5305\u540d\u66ff\u6362 <code>httpd</code>\u3002</p>"},{"location":"linux/Redhat-offline-package/#_5","title":"\u6ce8\u610f\u4e8b\u9879","text":"<ul> <li>\u8bf7\u786e\u4fdd\u5728\u53ef\u8054\u7f51\u7684\u673a\u5668\u4e0a\u4e0b\u8f7d\u8f6f\u4ef6\u5305\u65f6\u7684 CentOS \u7248\u672c\u548c\u79bb\u7ebf\u673a\u5668\u4e0a\u7684\u7248\u672c\u4e00\u81f4\uff0c\u4ee5\u514d\u56e0\u7248\u672c\u4e0d\u5339\u914d\u5bfc\u81f4\u4f9d\u8d56\u95ee\u9898\u3002</li> <li>\u5982\u679c\u60a8\u4e0b\u8f7d\u4e86\u5927\u91cf\u7684\u5305\uff0c\u5e76\u4e14\u4f9d\u8d56\u5f88\u590d\u6742\uff0c\u5efa\u8bae\u76f4\u63a5\u4e0b\u8f7d\u6574\u4e2a CentOS \u4ed3\u5e93\uff0c\u5e76\u5728\u79bb\u7ebf\u73af\u5883\u4e2d\u8bbe\u7f6e\u672c\u5730\u955c\u50cf\u3002</li> </ul> <p>\u6309\u7167\u8fd9\u4e9b\u6b65\u9aa4\uff0c\u60a8\u5e94\u8be5\u80fd\u591f\u5728\u6ca1\u6709\u7f51\u7edc\u8fde\u63a5\u7684\u60c5\u51b5\u4e0b\u5728 CentOS 7.9 \u7cfb\u7edf\u4e0a\u5b89\u88c5\u8f6f\u4ef6\u3002</p>"},{"location":"linux/Ubuntu/","title":"Ubuntu","text":""},{"location":"linux/Ubuntu/#1","title":"1 \u7cfb\u7edf\u521d\u59cb\u5316","text":""},{"location":"linux/Ubuntu/#11-root","title":"1.1 \u4fee\u6539root\u5bc6\u7801","text":"<pre><code># \u53ea\u6709\u666e\u901a\u7528\u6237\u5c5e\u4e8eadmin \u7ba1\u7406\u7ec4\u5373\u53ef\u6709\u6743\u9650\nsudo passwd root\n</code></pre>"},{"location":"linux/Ubuntu/#12-sudo","title":"1.2 sudo \u514d\u5bc6\u7801","text":"<pre><code># \u5207\u5230root\n$ su -\n# \u4fee\u6539\u6743\u9650\n$ chmod 740 /etc/sudoers\n$ vim /etc/sudoers\n#%sudo  ALL=(ALL:ALL) ALL # \u5c06\u539f\u6709\u8fd9\u884c\u6ce8\u91ca\u4e86\uff0c\u6539\u6210\u4e0b\u9762\u8fd9\u79cd\n%sudo   ALL=(ALL:ALL) NOPASSWD:ALL\n# \u6743\u9650\u6539\u56de\u53bb\n$ chmod 0440 /etc/sudoers \n</code></pre>"},{"location":"linux/Ubuntu/#13","title":"1.3 \u4fee\u6539\u7aef\u53e3\u8303\u56f4","text":"<pre><code>[root@localhost ~]# cat /proc/sys/net/ipv4/ip_local_port_range\n32768   61000\n[root@localhost ~]#  echo 1024 65535 &gt; /proc/sys/net/ipv4/ip_local_port_range\n</code></pre>"},{"location":"linux/Ubuntu/#14","title":"1.4 \u5e38\u7528\u5de5\u5177","text":"<pre><code>sudo apt -y  install ssh vim htop tree net-tools  lsof lrzsz   curl   ebtables conntrack socat wget   telnet chrony rsync tcpdump htop\nxfsprogs\n</code></pre>"},{"location":"linux/Ubuntu/#15","title":"1.5 \u5207\u6362\u6e90","text":"<pre><code># deb\u884c\u662f\u76f8\u5bf9\u4e8e\u4e8c\u8fdb\u5236\u5305\u7684\uff0c\u60a8\u53ef\u4ee5\u4f7f\u7528apt.\n# deb-src\u884c\u662f\u76f8\u5bf9\u4e8e\u6e90\u5305\uff08\u7531 \u4e0b\u8f7dapt-get source $package\uff09\u548c\u4e0b\u4e00\u6b21\u7f16\u8bd1\u7684\u3002\n# \u4ec5\u5f53\u60a8\u60f3\u81ea\u5df1\u7f16\u8bd1\u67d0\u4e2a\u5305\u6216\u68c0\u67e5\u6e90\u4ee3\u7801\u662f\u5426\u5b58\u5728\u9519\u8bef\u65f6\uff0c\u624d\u9700\u8981\u6e90\u5305\u3002\u666e\u901a\u7528\u6237\u4e0d\u9700\u8981\u5305\u542b\u8fd9\u6837\u7684\u5b58\u50a8\u5e93\u3002\n\n$ vim /etc/apt/sources.list\n\n## \u6e05\u534e\u6e90\n# 20.04 LTS\n\n# \u9ed8\u8ba4\u6ce8\u91ca\u4e86\u6e90\u7801\u955c\u50cf\u4ee5\u63d0\u9ad8 apt update \u901f\u5ea6\uff0c\u5982\u6709\u9700\u8981\u53ef\u81ea\u884c\u53d6\u6d88\u6ce8\u91ca\ndeb https://mirrors.tuna.tsinghua.edu.cn/ubuntu/ focal main restricted universe multiverse\n# deb-src https://mirrors.tuna.tsinghua.edu.cn/ubuntu/ focal main restricted universe multiverse\ndeb https://mirrors.tuna.tsinghua.edu.cn/ubuntu/ focal-updates main restricted universe multiverse\n# deb-src https://mirrors.tuna.tsinghua.edu.cn/ubuntu/ focal-updates main restricted universe multiverse\ndeb https://mirrors.tuna.tsinghua.edu.cn/ubuntu/ focal-backports main restricted universe multiverse\n# deb-src https://mirrors.tuna.tsinghua.edu.cn/ubuntu/ focal-backports main restricted universe multiverse\ndeb https://mirrors.tuna.tsinghua.edu.cn/ubuntu/ focal-security main restricted universe multiverse\n# deb-src https://mirrors.tuna.tsinghua.edu.cn/ubuntu/ focal-security main restricted universe multiverse\n\n\n### \u4e2d\u79d1\u5927\ndeb https://mirrors.ustc.edu.cn/ubuntu/ bionic main restricted universe multiverse\ndeb-src https://mirrors.ustc.edu.cn/ubuntu/ bionic main restricted universe multiverse\ndeb https://mirrors.ustc.edu.cn/ubuntu/ bionic-updates main restricted universe multiverse\ndeb-src https://mirrors.ustc.edu.cn/ubuntu/ bionic-updates main restricted universe multiverse\ndeb https://mirrors.ustc.edu.cn/ubuntu/ bionic-backports main restricted universe multiverse\ndeb-src https://mirrors.ustc.edu.cn/ubuntu/ bionic-backports main restricted universe multiverse\ndeb https://mirrors.ustc.edu.cn/ubuntu/ bionic-security main restricted universe multiverse\ndeb-src https://mirrors.ustc.edu.cn/ubuntu/ bionic-security main restricted universe multiverse\ndeb https://mirrors.ustc.edu.cn/ubuntu/ bionic-proposed main restricted universe multiverse\ndeb-src https://mirrors.ustc.edu.cn/ubuntu/ bionic-proposed main restricted universe multiverse\n\n### \u7f51\u6613\ndeb http://mirrors.163.com/ubuntu/ bionic main restricted universe multiverse\ndeb http://mirrors.163.com/ubuntu/ bionic-security main restricted universe multiverse\ndeb http://mirrors.163.com/ubuntu/ bionic-updates main restricted universe multiverse\ndeb http://mirrors.163.com/ubuntu/ bionic-proposed main restricted universe multiverse\ndeb http://mirrors.163.com/ubuntu/ bionic-backports main restricted universe multiverse\ndeb-src http://mirrors.163.com/ubuntu/ bionic main restricted universe multiverse\ndeb-src http://mirrors.163.com/ubuntu/ bionic-security main restricted universe multiverse\ndeb-src http://mirrors.163.com/ubuntu/ bionic-updates main restricted universe multiverse\ndeb-src http://mirrors.163.com/ubuntu/ bionic-proposed main restricted universe multiverse\ndeb-src http://mirrors.163.com/ubuntu/ bionic-backports main restricted universe multiverse\n\n### \u963f\u91cc\u4e91\ndeb http://mirrors.aliyun.com/ubuntu/ bionic main restricted universe multiverse\ndeb http://mirrors.aliyun.com/ubuntu/ bionic-security main restricted universe multiverse\ndeb http://mirrors.aliyun.com/ubuntu/ bionic-updates main restricted universe multiverse\ndeb http://mirrors.aliyun.com/ubuntu/ bionic-proposed main restricted universe multiverse\ndeb http://mirrors.aliyun.com/ubuntu/ bionic-backports main restricted universe multiverse\ndeb-src http://mirrors.aliyun.com/ubuntu/ bionic main restricted universe multiverse\ndeb-src http://mirrors.aliyun.com/ubuntu/ bionic-security main restricted universe multiverse\ndeb-src http://mirrors.aliyun.com/ubuntu/ bionic-updates main restricted universe multiverse\ndeb-src http://mirrors.aliyun.com/ubuntu/ bionic-proposed main restricted universe multiverse\ndeb-src http://mirrors.aliyun.com/ubuntu/ bionic-backports main restricted universe multiverse\n</code></pre> <pre><code># \u6216\u8005\n# \u5207\u6362\u8f6f\u4ef6\u6e90\nsudo cp /etc/apt/sources.list /etc/apt/sources.list.bak\nsudo mv /etc/apt/sources.list.d/original.list{,.bak}\nsudo tee /etc/apt/sources.list &lt;&lt;-'EOF'\ndeb https://mirrors.tuna.tsinghua.edu.cn/ubuntu/ jammy main restricted universe multiverse\ndeb https://mirrors.tuna.tsinghua.edu.cn/ubuntu/ jammy-updates main restricted universe multiverse\ndeb https://mirrors.tuna.tsinghua.edu.cn/ubuntu/ jammy-backports main restricted universe multiverse\ndeb http://security.ubuntu.com/ubuntu/ jammy-security main restricted universe multiverse\nEOF\n\n### arm64 ubuntu 22.04 lts\n\n# \u9ed8\u8ba4\u6ce8\u91ca\u4e86\u6e90\u7801\u955c\u50cf\u4ee5\u63d0\u9ad8 apt update \u901f\u5ea6\uff0c\u5982\u6709\u9700\u8981\u53ef\u81ea\u884c\u53d6\u6d88\u6ce8\u91ca\ndeb https://mirrors.tuna.tsinghua.edu.cn/ubuntu-ports/ focal main restricted universe multiverse\n# deb-src https://mirrors.tuna.tsinghua.edu.cn/ubuntu-ports/ focal main restricted universe multiverse\ndeb https://mirrors.tuna.tsinghua.edu.cn/ubuntu-ports/ focal-updates main restricted universe multiverse\n# deb-src https://mirrors.tuna.tsinghua.edu.cn/ubuntu-ports/ focal-updates main restricted universe multiverse\ndeb https://mirrors.tuna.tsinghua.edu.cn/ubuntu-ports/ focal-backports main restricted universe multiverse\n# deb-src https://mirrors.tuna.tsinghua.edu.cn/ubuntu-ports/ focal-backports main restricted universe multiverse\n\n# deb https://mirrors.tuna.tsinghua.edu.cn/ubuntu-ports/ focal-security main restricted universe multiverse\n# # deb-src https://mirrors.tuna.tsinghua.edu.cn/ubuntu-ports/ focal-security main restricted universe multiverse\n\ndeb http://ports.ubuntu.com/ubuntu-ports/ focal-security main restricted universe multiverse\n# deb-src http://ports.ubuntu.com/ubuntu-ports/ focal-security main restricted universe multiverse\n\n# \u9884\u53d1\u5e03\u8f6f\u4ef6\u6e90\uff0c\u4e0d\u5efa\u8bae\u542f\u7528\n# deb https://mirrors.tuna.tsinghua.edu.cn/ubuntu-ports/ focal-proposed main restricted universe multiverse\n# # deb-src https://mirrors.tuna.tsinghua.edu.cn/ubuntu-ports/ focal-proposed main restricted universe multiverse\n</code></pre>"},{"location":"linux/Ubuntu/#16-ip","title":"1.6 \u9759\u6001IP\u914d\u7f6e","text":"<p>https://ld246.com/article/1593929878472</p> <pre><code>sudo vi /etc/netplan/00-installer-config.yaml\n###################################################\nnetwork:\n  ethernets:\n    ens160:     # \u7f51\u5361\u540d\n      addresses: [10.1.6.248/19]    # \u9759\u6001ip/\u63a9\u7801\n      dhcp4: no    # \u5173\u95edDHCP\n      optional: true\n      gateway4: 10.1.0.254    # \u7f51\u5173\n      nameservers:\n         addresses: [114.114.114.114,8.8.8.8]   \n  version: 2\n###################################################\nsudo netplan apply\n\n# \u6216\u8005\u91cd\u542f\u673a\u5668\u751f\u6548\nsync;reboot\n</code></pre>"},{"location":"linux/Ubuntu/#17-arm-2204-","title":"1.7 ARM-22.04-\u6e90","text":"<pre><code>## \u9ed8\u8ba4\ncat /etc/apt/sources.list\n# See http://help.ubuntu.com/community/UpgradeNotes for how to upgrade to\n# newer versions of the distribution.\ndeb http://ports.ubuntu.com/ubuntu-ports/ focal main restricted\n# deb-src http://ports.ubuntu.com/ubuntu-ports/ focal main restricted\n\n## Major bug fix updates produced after the final release of the\n## distribution.\ndeb http://ports.ubuntu.com/ubuntu-ports/ focal-updates main restricted\n# deb-src http://ports.ubuntu.com/ubuntu-ports/ focal-updates main restricted\n\n## N.B. software from this repository is ENTIRELY UNSUPPORTED by the Ubuntu\n## team. Also, please note that software in universe WILL NOT receive any\n## review or updates from the Ubuntu security team.\ndeb http://ports.ubuntu.com/ubuntu-ports/ focal universe\n# deb-src http://ports.ubuntu.com/ubuntu-ports/ focal universe\ndeb http://ports.ubuntu.com/ubuntu-ports/ focal-updates universe\n# deb-src http://ports.ubuntu.com/ubuntu-ports/ focal-updates universe\n\n## N.B. software from this repository is ENTIRELY UNSUPPORTED by the Ubuntu\n## team, and may not be under a free licence. Please satisfy yourself as to\n## your rights to use the software. Also, please note that software in\n## multiverse WILL NOT receive any review or updates from the Ubuntu\n## security team.\ndeb http://ports.ubuntu.com/ubuntu-ports/ focal multiverse\n# deb-src http://ports.ubuntu.com/ubuntu-ports/ focal multiverse\ndeb http://ports.ubuntu.com/ubuntu-ports/ focal-updates multiverse\n# deb-src http://ports.ubuntu.com/ubuntu-ports/ focal-updates multiverse\n\n## N.B. software from this repository may not have been tested as\n## extensively as that contained in the main release, although it includes\n## newer versions of some applications which may provide useful features.\n## Also, please note that software in backports WILL NOT receive any review\n## or updates from the Ubuntu security team.\ndeb http://ports.ubuntu.com/ubuntu-ports/ focal-backports main restricted universe multiverse\n# deb-src http://ports.ubuntu.com/ubuntu-ports/ focal-backports main restricted universe multiverse\n\n## Uncomment the following two lines to add software from Canonical's\n## 'partner' repository.\n## This software is not part of Ubuntu, but is offered by Canonical and the\n## respective vendors as a service to Ubuntu users.\n# deb http://archive.canonical.com/ubuntu focal partner\n# deb-src http://archive.canonical.com/ubuntu focal partner\n\ndeb http://ports.ubuntu.com/ubuntu-ports/ focal-security main restricted\n# deb-src http://ports.ubuntu.com/ubuntu-ports/ focal-security main restricted\ndeb http://ports.ubuntu.com/ubuntu-ports/ focal-security universe\n# deb-src http://ports.ubuntu.com/ubuntu-ports/ focal-security universe\ndeb http://ports.ubuntu.com/ubuntu-ports/ focal-security multiverse\n# deb-src http://ports.ubuntu.com/ubuntu-ports/ focal-security multiverse\n\n## \u9ed8\u8ba4-\u7cbe\u7b80\ndeb http://ports.ubuntu.com/ubuntu-ports/ focal main restricted\ndeb http://ports.ubuntu.com/ubuntu-ports/ focal-updates main restricted\ndeb http://ports.ubuntu.com/ubuntu-ports/ focal universe\ndeb http://ports.ubuntu.com/ubuntu-ports/ focal-updates universe\ndeb http://ports.ubuntu.com/ubuntu-ports/ focal multiverse\ndeb http://ports.ubuntu.com/ubuntu-ports/ focal-updates multiverse\ndeb http://ports.ubuntu.com/ubuntu-ports/ focal-backports main restricted universe multiverse\ndeb http://ports.ubuntu.com/ubuntu-ports/ focal-security main restricted\ndeb http://ports.ubuntu.com/ubuntu-ports/ focal-security universe\ndeb http://ports.ubuntu.com/ubuntu-ports/ focal-security multiverse\n\n\n## \u5b89\u88c5\u5de5\u5177\napt install -y apt-transport-https ca-certificates \napt update\n\n\n## \u6e05\u534e\u6e90\ndeb https://mirrors.tuna.tsinghua.edu.cn/ubuntu-ports/ focal main restricted universe multiverse\ndeb https://mirrors.tuna.tsinghua.edu.cn/ubuntu-ports/ focal-updates main restricted universe multiverse\ndeb https://mirrors.tuna.tsinghua.edu.cn/ubuntu-ports/ focal-backports main restricted universe multiverse\ndeb https://mirrors.tuna.tsinghua.edu.cn/ubuntu-ports/ focal-security main restricted universe multiverse\n</code></pre>"},{"location":"linux/Ubuntu/#18-root","title":"1.8 \u542f\u7528root\u7528\u6237","text":"<pre><code>#  root\u8fdc\u7a0b\u767b\u5f55\n$ sudo vi /etc/ssh/sshd_config\nPermitRootLogin  yes\n# \u6216\u8005\nsed -i 's/^#PermitRootLogin prohibit-password/PermitRootLogin yes/' /etc/ssh/sshd_config\n\n$ sudo  systemctl  restart  ssh\n\n\n# \u6539\u5bc6\u7801\nsudo passwd root\n</code></pre>"},{"location":"linux/Ubuntu/#19-nfs","title":"1.9 \u4f7f\u7528nfs","text":"<pre><code>sudo  apt update  -y\nsudo  apt upgrade -y \n\nsudo apt-get install nfs-common -y  # \u7ecf\u6d4b\u8bd5\uff0c\u53ef\u7528\nsudo apt-get install nfs-utils -y # \u7ecf\u6d4b\u8bd5\uff0c\u4e0d\u53ef\u7528\n</code></pre>"},{"location":"linux/Ubuntu/#110","title":"1.10 \u4fee\u6539\u663e\u793a","text":"<pre><code># \u4e0d\u770b\u5230\u9690\u85cf\u6587\u4ef6,\u4e0d\u8981\u52a0*\uff0c/\uff0c@\u7b49\u7b26\u53f7\nsed -ri \"s/alias ll='ls -alF'/alias ll='ls -l'/\" ~/.bashrc\negrep \"alias ll\" ~/.bashrc\nsource ~/.bashrc\n</code></pre>"},{"location":"linux/Ubuntu/#111","title":"1.11 \u5173\u95ed\u9632\u706b\u5899","text":"<pre><code># \u5173\u95ed\u9632\u706b\u5899\nufw disable\nufw status\n</code></pre>"},{"location":"linux/Ubuntu/#112","title":"1.12 \u8f6f\u4ef6\u66f4\u65b0","text":"<pre><code>apt clean\napt update\napt upgrade\napt dist-upgrade\n</code></pre>"},{"location":"linux/Ubuntu/#113","title":"1.13 \u5b89\u88c5\u8f6f\u4ef6","text":"<pre><code>sudo apt -y install conntrack socat tree   net-tools genisoimage ntpdate jq sshpass \nsudo apt -y install ansible \nsudo apt -y install python3-pip udev netplan.io python3.10-venv \nsudo netplan apply\n</code></pre>"},{"location":"linux/Ubuntu/#114","title":"1.14 \u540c\u6b65\u65f6\u533a","text":"<pre><code>timedatectl set-timezone Asia/Shanghai\nntpdate -u ntp.aliyun.com\necho \"*/5 * * * * /usr/sbin/ntpdate -u ntp.aliyun.com &gt;&gt; /var/log/ntpdate.log 2&gt;&amp;1\" | sudo tee /etc/cron.d/ntpdate-sync\n</code></pre>"},{"location":"linux/Ubuntu/#115","title":"1.15 \u6839\u76ee\u5f55\u6269\u5bb9","text":"<pre><code>lvextend -l +100%FREE /dev/ubuntu-vg/ubuntu-lv\nresize2fs /dev/ubuntu-vg/ubuntu-lv\ndf -h /dev/ubuntu-vg/ubuntu-lv\n</code></pre>"},{"location":"linux/Ubuntu/#2","title":"2 \u6709\u5751","text":""},{"location":"linux/Ubuntu/#21","title":"2.1 \u9a71\u52a8","text":"<pre><code>1.\u84dd\u7259\u9a71\u52a8\u4e4b\u7c7b\u7684\u786c\u4ef6\u517c\u5bb9\u6027\u652f\u6301\u53ef\u80fd\u4e0d\u5982windows\n</code></pre>"},{"location":"linux/Ubuntu/#22","title":"2.2 \u670d\u52a1","text":"<pre><code>1. smb \u670d\u52a1\u5c3d\u91cf\u4e0d\u8981\u7528\uff0c\u8fd9\u91cc\u65f6\u4e0d\u65f6\u4f1a\u6709\u670d\u52a1\u5f02\u5e38\n2. \u5f00\u673a\u81ea\u542f\u7684rc.d \u811a\u672c\uff0c\u5f88\u591a\u65f6\u5019\u6ca1\u6709\u751f\u6548\n3. \u8f6f\u4ef6\u5305\u7684\u6e90\u592a\u5927\uff0c\u5b8c\u5168\u79bb\u7ebf\u4e0b\u6765\u4e0d\u592a\u53ef\u80fd\n</code></pre>"},{"location":"linux/Vim/","title":"Vim","text":""},{"location":"linux/Vim/#_1","title":"\u89e3\u51b3\u590d\u5236\u7c98\u8d34\u65f6\u5168\u6ce8\u91ca\u95ee\u9898","text":"<p>\u5728<code>vim</code>\u4e2d\uff0c\u5f53\u590d\u5236\u5e26\u6709#\u53f7\u5f00\u5934\u7684\u884c\u65f6\uff0c\u4f1a\u81ea\u52a8\u6ce8\u91ca\u6389\u540e\u9762\u7684\u5185\u5bb9\u3002\u5982\u679c\u60f3\u8981\u5173\u95ed\u8fd9\u4e2a\u529f\u80fd\uff0c\u53ef\u4ee5\u6267\u884c\u547d\u4ee4<code>:set nopaste</code></p> <pre><code>:set paste  ## \u8fdb\u5165\u7c98\u8d34\u6a21\u5f0f\uff0c\u4e34\u65f6\u4f7f\u7528\n</code></pre> <pre><code>$ tail -2 /etc/vimrc  ## \u76f4\u63a5\u4fee\u6539\u5168\u5c40vim \u914d\u7f6e\uff0c\u7acb\u5373\u751f\u6548\nset paste\nset number\n</code></pre>"},{"location":"linux/Vim/#vimrc","title":".vimrc","text":"<p>http://xstarcd.github.io/wiki/vim/vim_indent.html https://segmentfault.com/a/1190000021133524</p>"},{"location":"linux/Vim/#1-redhat","title":"1 Redhat","text":"<pre><code>######## v1 \nsyntax on   # \u8bed\u6cd5\u9ad8\u4eae\nset scrolloff=7 # \u8ba9\u5149\u6807\u59cb\u7ec8\u5904\u5728\u5c4f\u5e55\u4e2d\u95f4\uff0c\u6b63\u5e38\u8ddd\u79bb\u662f7\u884c\nset ai  # \u56de\u8f66\u540e\u81ea\u52a8\u7f29\u8fdb\u5230\u5408\u9002\u4f4d\u7f6e\nset ts=4  # \u6b63\u5e38\u60c5\u51b5\u4e0b\u4e00\u4e2atab\u952e\u662f4\u4e2a\u7a7a\u683c\nset et    # \u5c06\u6240\u6709tab\u952e\u7684\u5236\u8868\u7b26\u6362\u6210\u7a7a\u683c\nset encoding=utf8  # utf8 \u5b57\u7b26\u96c6\nautocmd FileType yaml setlocal sw=2 ts=2 et ai  # \u5f53\u6587\u4ef6\u662fyaml\u683c\u5f0f\u65f6\u5c06vim\u76f8\u5173\u89c4\u5219\u5b9a\u4e3a2\u7a7a\u683c\u5bf9\u9f50\u3001tab\u662f2\u7a7a\u683c\u3001tab\u81ea\u52a8\u8f6c\u7a7a\u683c\u3001\u81ea\u52a8\u7f29\u8fdb\nnnoremap &lt;C -a&gt; &lt;Home&gt;    # \u5feb\u6377\u952ecurl + a = HOME\u952e\nnnoremap &lt;C -e&gt; &lt;End&gt;     # \u5feb\u6377\u952ecurl + e = END\u952e\nnnoremap ; :              # \u6309; = \uff1a\n\n######## v2\nsyntax on\nset scrolloff=7\nset ai\nset ts=4\nset et\nset encoding=utf8\nautocmd FileType yaml setlocal sw=2 ts=2 et ai\nnnoremap &lt;C -a&gt; &lt;Home&gt;\nnnoremap &lt;C -e&gt; &lt;End&gt;\nnnoremap ; :\n\n######## v3\nsyntax on\nset ai\nset ts=2\nset sw=2\nset et\n\n########## v4 \nsyntax on\nset scrolloff=7\nset ai\nset ts=4\nset et\nset encoding=utf8\nautocmd FileType yaml setlocal sw=2 ts=2 et ai\nnnoremap &lt;C-a&gt; &lt;Home&gt;\nnnoremap &lt;C-e&gt; &lt;End&gt;\nnnoremap &lt;F2&gt; :set nu! nu?&lt;CR&gt;\nnnoremap ; :\n\n\n# \u81ea\u52a8\u7f29\u8fdb\n:set ai  # \u81ea\u52a8\u7f29\u8fdb\uff0c\u5728\u6309o\u4e4b\u540e\u4f1a\u81ea\u52a8\u7f29\u8fdb\u5e76\u4e0e\u4e0a\u4e00\u884c\u4fdd\u6301\u5bf9\u9f50\n\n############ v5\nvim ~/.vimrc\n\n-------------------------------------------------------------\n\nsyntax on\nset scrolloff=7\nset mouse=a  # \u9f20\u6807\u5b9a\u4f4d\nset ai\nset ts=4\nset et\nset encoding=utf8\nautocmd FileType yaml setlocal sw=2 ts=2 et ai\nnnoremap &lt;C-a&gt; &lt;Home&gt;\nnnoremap &lt;C-e&gt; &lt;End&gt;\nnnoremap &lt;F2&gt; :set nu! nu?&lt;CR&gt;\nnnoremap ; :\n</code></pre>"},{"location":"linux/Vim/#2-ubuntu","title":"2 Ubuntu","text":"<pre><code>set nu\nset nowrap\nset encoding=utf-8\nset fenc=utf-8\nset mouse=v\nset expandtab\nset hlsearch\nset textwidth=79\nset fileformat=unix\nset cindent                 #  \u4ee5C/C++\u7684\u6a21\u5f0f\u7f29\u8fdb\nset scrolloff=5            # \u8bbe\u5b9a\u5149\u6807\u79bb\u7a97\u53e3\u4e0a\u4e0b\u8fb9\u754c 5 \u884c\u65f6\u7a97\u53e3\u81ea\u52a8\u6eda\u52a8\nset shiftwidth=4          # \u8bbe\u5b9a &lt;&lt; \u548c &gt;&gt; \u547d\u4ee4\u79fb\u52a8\u65f6\u7684\u5bbd\u5ea6\u4e3a 4\nset softtabstop=4       # \u4f7f\u5f97\u6309\u9000\u683c\u952e\u65f6\u53ef\u4ee5\u4e00\u6b21\u5220\u6389 4 \u4e2a\u7a7a\u683c,\u4e0d\u8db3 4 \u4e2a\u65f6\u5220\u6389\u6240\u6709\u5269\u4e0b\u7684\u7a7a\u683c\uff09\nset tabstop=4            # \u8bbe\u5b9a tab \u957f\u5ea6\u4e3a 4\nsyntax on                   #  \u81ea\u52a8\u8bed\u6cd5\u9ad8\u4eae\nset autoindent # \u81ea\u52a8\u5bf9\u9f50\nset smartindent # \u667a\u80fd\u5bf9\u9f50\n</code></pre>"},{"location":"linux/Vim/#_2","title":"\u63d2\u5165\u65f6\u95f4","text":"<pre><code># \u5149\u6807\u9009\u4e2d\u8981\u63d2\u5165\u7684\u4f4d\u7f6e\n:r!date\n# \u4f1a\u53e6\u8d77\u4e00\u884c\u63d2\u5165\u5f53\u524d\u65f6\u95f4\n</code></pre>"},{"location":"linux/Vim/#_3","title":"\u540c\u65f6\u67e5\u770b\u4e24\u4e2a\u6587\u4ef6","text":"<pre><code>vim -O register{,1}.yaml\n</code></pre>"},{"location":"linux/Vim/#bash","title":"\u7f8e\u5316bash","text":"<p>https://linux.cn/article-8118-1.html</p>"},{"location":"linux/Yum/","title":"Yum","text":""},{"location":"linux/Yum/#_1","title":"\u67e5\u770b\u6240\u6709\u7248\u672c","text":"<pre><code>yum list docker-ce --showduplicate\n</code></pre>"},{"location":"linux/Yum/#htop","title":"\u5b89\u88c5htop","text":"<pre><code>dnf -y install \\\n    https://dl.fedoraproject.org/pub/epel/epel-release-latest-9.noarch.rpm \\\n    https://dl.fedoraproject.org/pub/epel/epel-next-release-latest-9.noarch.rpm\n\ndnf install htop -y\n</code></pre>"},{"location":"linux/Yum/#_2","title":"\u5217\u51fa\u6240\u6709\u7248\u672c","text":"<pre><code>yum list docker-ce --showduplicates | sort -r\nyum list java-1.10 --showduplicates | sort -r\n</code></pre>"},{"location":"linux/Yum/#_3","title":"\u5b89\u88c5\u6307\u5b9a\u7248\u672c\u5305","text":"<pre><code>yum list kubectl  --showduplicates | sort -r\nyum -y install kubectl-1.20.6\n</code></pre>"},{"location":"linux/Yum/#_4","title":"\u6574\u5408\u79bb\u7ebf\u5305","text":"<p>https://www.1024sou.com/article/404581.html</p> <pre><code>yum -y install yum-utils\nyumdownloader --resolve --destdir=/tmp docker\n</code></pre>"},{"location":"linux/Yum/#_5","title":"\u67e5\u770b\u5df2\u5b89\u88c5","text":"<pre><code>$ yum list installed|grep python3\n$ yum list installed wget\n</code></pre>"},{"location":"linux/Yum/#_6","title":"\u672c\u5730\u4ed3\u5e93\u642d\u5efa","text":"<p>https://blog.csdn.net/qq_29974229/article/details/103827369</p>"},{"location":"linux/Yum/#_7","title":"\u6dfb\u52a0\u4ed3\u5e93","text":"<pre><code># \u5b89\u88c5\u5efa\u5e93\u6240\u9700\u5de5\u5177\nyum install -y yum-utils device-mapper-persistent-data lvm2 createrepo wget  curl epel-release\n\n\n# \u4e0b\u8f7d\u4ed3\u5e93\ncurl -o /etc/yum.repos.d/CentOS-Base.repo http://mirrors.aliyun.com/repo/Centos-7.repo\ncurl -o /etc/yum.repos.d/epel-7.repo http://mirrors.aliyun.com/repo/epel-7.repo\n</code></pre>"},{"location":"linux/Yum/#_8","title":"\u624b\u52a8\u540c\u6b65","text":"<pre><code># centos 7\nreposync -r base             -p /data/yum  \nreposync -r epel             -p /data/yum\nreposync -r extras           -p /data/yum\nreposync -r updates          -p /data/yum\nreposync -r kubernetes       -p /data/yum  \nreposync -r docker-ce-stable -p /data/yum\n</code></pre>"},{"location":"linux/Yum/#_9","title":"\u521b\u5efa\u672c\u5730\u6e90","text":"<pre><code># \u521b\u5efa reopdata\u4ed3\u5e93\uff0c\u751f\u6210\u4ed3\u5e93\u4fe1\u606f\ncreaterepo -v /data/yum/epel\ncreaterepo -v /data/yum/base\ncreaterepo -v /data/yum/extras\ncreaterepo -v /data/yum/updates\ncreaterepo -v /data/yum/kubernetes\ncreaterepo -v /data/yum/docker-ce-stable\n</code></pre>"},{"location":"linux/Yum/#_10","title":"\u811a\u672c\u540c\u6b65","text":"<pre><code>#!/bin/bash\n##specify all local repositories in a single variable\nLOCAL_REPOS=\"base extras updates epel centosplus docker-ce-stable kubernetes erlang-solutions\"\n##local yum path\nDOWNLOAD_PATH=/data/yum/\n##a loop to update repos one at a time\nfor REPO in ${LOCAL_REPOS}; do\n\nif [[ $REPO = 'kubernetes' || $REPO = 'docker-ce-stable' || $REPO = 'erlang-solutions' ]];then\n    reposync -r $REPO -p $DOWNLOAD_PATH\nelse\n    reposync -g -l -d -m -n --download-metadata -r $REPO  -p $DOWNLOAD_PATH\nfi\n\nif [[ $REPO = 'base' || $REPO = 'epel' ]]; then\n    createrepo -g $DOWNLOAD_PATH/$REPO/comps.xml $DOWNLOAD_PATH/$REPO/\nelse\n    createrepo $DOWNLOAD_PATH/$REPO/\nfi\ndone\n</code></pre>"},{"location":"linux/Yum/#_11","title":"\u5185\u7f51\u5171\u4eab","text":"<pre><code>yum install nginx -y\n\ncp -rf /etc/nginx/nginx.conf /etc/nginx/nginx.conf.bak\ngrep -vE \"#|^$\" /etc/nginx/nginx.conf.bak &gt;/etc/nginx/nginx.conf.bak\n\ncat &lt;&lt;eof &gt;/etc/nginx/nginx.conf\nuser nginx;\nworker_processes auto;\nerror_log /var/log/nginx/error.log;\npid /run/nginx.pid;\ninclude /usr/share/nginx/modules/*.conf;\nevents {\n    worker_connections 1024;\n}\nhttp {\n    log_format  main  '$remote_addr - $remote_user [$time_local] \"$request\" '\n                      '$status $body_bytes_sent \"$http_referer\" '\n                      '\"$http_user_agent\" \"$http_x_forwarded_for\"';\n    access_log  /var/log/nginx/access.log  main;\n    sendfile            on;\n    tcp_nopush          on;\n    tcp_nodelay         on;\n    keepalive_timeout   65;\n    types_hash_max_size 2048;\n    include             /etc/nginx/mime.types;\n    default_type        application/octet-stream;\n    include /etc/nginx/conf.d/*.conf;\n    server {\n        autoindex on;\n        autoindex_exact_size on;\n        autoindex_localtime on;\n        listen       80 default_server;\n        listen       [::]:80 default_server;\n        server_name yum;\n        root /data/yum;\n        location / {\n        }\n        error_page 404 /404.html;\n        location = /404.html {\n        }\n        error_page 500 502 503 504 /50x.html;\n        location = /50x.html {\n        }\n    }\n}\neof\n\n\n\nsystemctl restart nginx\nsystemctl enable nginx\nss -ntulp |grep 80\n</code></pre>"},{"location":"linux/Yum/#_12","title":"\u672c\u5730\u4ed3\u5e93\u4f7f\u7528","text":"<pre><code># \u5c06\u539frepo\u6587\u4ef6\u5907\u4efd\uff0c\u66ff\u6362\u4e3a\u65b0\u7684\u5373\u53ef\ncd /etc/yum.repos.d\nmkdir -p repo.bak\nmv *.repo repo.bak/\n\n\n# \u6dfb\u52a0\u65b0\u7684repo\u6587\u4ef6\ncat &lt;&lt;eof &gt; own.repo\n[base]\nname=CentOS-$releasever - Base\nbaseurl=file:///data/yum/base\nenabled=1\ngpgcheck=0\n\n[extras]\nname=CentOS-$releasever - Base-ex\nbaseurl=file:///data/yum/extras\nenabled=1\ngpgcheck=0\n\n[updates]\nname=CentOS-$releasever - Base-updates\nbaseurl=file:///data/yum/updates\nenabled=1\ngpgcheck=0\n\n[epel]\nname=epel\nbaseurl=file:///data/yum/epel\nenabled=1\ngpgcheck=0\n\n[centosplus]\nname=centosplus\nbaseurl=file:///data/yum/centosplus\nenabled=1\ngpgcheck=0\n\n[docker]\nname=docker-ce\nbaseurl=file:///data/yum/docker-ce-stable\nenabled=1\ngpgcheck=0\n\n[k8s]\nname=kubernetes\nbaseurl=file:///data/yum/kubernetes\nenabled=1\ngpgcheck=0\neof\n</code></pre>"},{"location":"linux/Yum/#_13","title":"\u8fdc\u7a0b\u4ed3\u5e93\u4f7f\u7528","text":"<pre><code># \u5c06\u539frepo\u6587\u4ef6\u5907\u4efd\uff0c\u66ff\u6362\u4e3a\u65b0\u7684\u5373\u53ef\ncd /etc/yum.repos.d\nmkdir -p repo.bak\nmv *.repo repo.bak/\n\n\n# \u6dfb\u52a0\u65b0\u7684repo\u6587\u4ef6\ncat &lt;&lt;eof &gt; own.repo\n[base]\nname=CentOS-$releasever - Base\nbaseurl=http://10.0.1.2/base\nenabled=1\ngpgcheck=0\n\n[extras]\nname=CentOS-$releasever - Base-ex\nbaseurl=http://10.0.1.2/extras\nenabled=1\ngpgcheck=0\n\n[updates]\nname=CentOS-$releasever - Base-updates\nbaseurl=http://10.0.1.2/updates\nenabled=1\ngpgcheck=0\n\n[epel]\nname=epel\nbaseurl=http://10.0.1.2/epel\nenabled=1\ngpgcheck=0\n\n[docker]\nname=docker-ce\nbaseurl=http://10.0.1.2/docker-ce-stable\nenabled=1\ngpgcheck=0\n\n[k8s]\nname=kubernetes\nbaseurl=http://10.0.1.2/kubernetes\nenabled=1\ngpgcheck=0\neof\n</code></pre>"},{"location":"linux/Yum/#_14","title":"\u7981\u7528\u6ce8\u518c","text":"<p><code>yum \uff1a  This system is not registered with an entitlement server. You can use subscription-manager to</code></p> <pre><code>[root@Oradb1 pluginconf.d]# vim /etc/yum/pluginconf.d/subscription-manager.conf\n[main]\nenabled=0           #\u5c06\u5b83\u7981\u7528\u6389\n</code></pre>"},{"location":"linux/Yum/#_15","title":"\u8f6f\u4ef6\u5305\u5b89\u88c5\u51b2\u7a81","text":"<p>\u95ee\u9898\u73b0\u8c61\uff1a\u2192 \u5904\u7406 avahi-libs-0.6.31-13.el7.x86_64 \u4e0e avahi &gt; 0.6.31-13.el7 \u7684\u51b2\u7a81 \u2192 \u5904\u7406 avahi-ui-gtk3-0.6.31-13.el7.x86_64 \u4e0e avahi &gt; 0.6.31-13.el7 \u7684\u51b2\u7a81 \u2192 \u89e3\u51b3\u4f9d\u8d56\u5173\u7cfb\u5b8c\u6210 \u9519\u8bef\uff1a\u8f6f\u4ef6\u5305\uff1aavahi-libs-0.6.31-13.el7.x86_64 (@anaconda)           \u9700\u8981\uff1aavahi = 0.6.31-13.el7           \u6b63\u5728\u5220\u9664: avahi-0.6.31-13.el7.x86_64 (@anaconda)               avahi = 0.6.31-13.el7           \u66f4\u65b0\uff0c\u7531: avahi-0.6.31-14.el7.x86_64 (base)              avahi = 0.6.31-14.el7 \u9519\u8bef\uff1aavahi-libs conflicts with avahi-0.6.31-14.el7.x86_64 \u9519\u8bef\uff1aavahi-autoipd conflicts with avahi-0.6.31-14.el7.x86_64 \u9519\u8bef\uff1aavahi-glib conflicts with avahi-0.6.31-14.el7.x86_64 \u9519\u8bef\uff1aavahi-ui-gtk3 conflicts with avahi-0.6.31-14.el7.x86_64 \u9519\u8bef\uff1aavahi-gobject conflicts with avahi-0.6.31-14.el7.x86_64 \u60a8\u53ef\u4ee5\u5c1d\u8bd5\u6dfb\u52a0 --skip-broken \u9009\u9879\u6765\u89e3\u51b3\u8be5\u95ee\u9898 ** \u53d1\u73b0 426 \u4e2a\u5df2\u5b58\u5728\u7684 RPM \u6570\u636e\u5e93\u95ee\u9898\uff0c 'yum check' \u8f93\u51fa\u5982\u4e0b\uff1a 1:NetworkManager-1.0.0-14.git20150121.b4ea599c.el7.x86_64 \u662f 1:NetworkManager-0.9.9.1-29.git20140326.4dba720.el7_0.x86_64 \u7684\u526f\u672c 1:NetworkManager-glib-1.0.0-14.git20150121.b4ea599c.el7.x86_64 \u662f 1:NetworkManager-glib-0.9.9.1-29.git20140326.4dba720.el7_0.x86_64 \u7684\u526f\u672c 1:NetworkManager-libnm-1.0.0-14.git20150121.b4ea599c.el7.x86_64 \u6709\u5df2\u5b89\u88c5\u51b2\u7a81 NetworkManager-glib &lt; ('1', '1.0.0', '1'): 1:NetworkManager-glib-0.9.9.1-29.git20140326.4dba720.el7_0.x86_64 1:NetworkManager-tui-1.0.0-14.git20150121.b4ea599c.el7.x86_64 \u662f 1:NetworkManager-tui-0.9.9.1-29.git20140326.4dba720.el7_0.x86_64 \u7684\u526f\u672c ...</p> <pre><code>yum install yum-utils  \nyum-complete-transaction --cleanup-only  \n#\u6e05\u9664\u53ef\u80fd\u5b58\u5728\u7684\u91cd\u590d\u5305\npackage-cleanup --dupes  \n#\u6e05\u9664\u53ef\u80fd\u5b58\u5728\u7684\u635f\u574f\u5305\npackage-cleanup --problems  \n#\u6e05\u9664\u91cd\u590d\u5305\u7684\u8001\u7248\u672c\uff1a\npackage-cleanup --cleandupes**\n\n# \u6216\u8005\u76f4\u63a5 \u5ffd\u7565\u4f9d\u8d56\u5f3a\u5236\u5220\u9664\u4e0a\u9762\u63d0\u793a\"Removing\"\u7684rpm\u5305\nrpm -e --nodeps systemd-219-42.el7_4.4.x86_64\n</code></pre>"}]}